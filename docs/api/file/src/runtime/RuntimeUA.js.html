<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/runtime/RuntimeUA.js | Service Framework API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">allocation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/allocation/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Bus.js~Bus.html">Bus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">discovery</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/discovery/CoreDiscovery.js~CoreDiscovery.html">CoreDiscovery</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Crypto.js~Crypto.html">Crypto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/GuiFake.js~GuiFake.html">GuiFake</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Identity.js~Identity.html">Identity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/OpenIdLib.js~OpenIdLib.html">OpenIdLib</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/ActionsService.js~ActionsService.html">ActionsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/CombiningAlgorithm.js~CombiningAlgorithm.html">CombiningAlgorithm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Operators.js~Operators.html">Operators</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PDP.js~PDP.html">PDP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PEP.js~PEP.html">PEP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Policy.js~Policy.html">Policy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/ReThinkCtx.js~ReThinkCtx.html">ReThinkCtx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Rule.js~Rule.html">Rule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/combiningAlgorithms</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/AllowOverrides.js~AllowOverrides.html">AllowOverrides</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/BlockOverrides.js~BlockOverrides.html">BlockOverrides</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/FirstApplicable.js~FirstApplicable.html">FirstApplicable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/conditions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/AdvancedCondition.js~AdvancedCondition.html">AdvancedCondition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/Condition.js~Condition.html">Condition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/SubscriptionCondition.js~SubscriptionCondition.html">SubscriptionCondition</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/context</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/context/RuntimeCoreCtx.js~RuntimeCoreCtx.html">RuntimeCoreCtx</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/protostub/IdpProxyStub.js~IdpProxyStub.html">IdpProxyStub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/Descriptors.js~Descriptors.html">Descriptors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/Loader.js~Loader.html">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-runtimeConfiguration">runtimeConfiguration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-runtimeUtils">runtimeUtils</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SandboxType">SandboxType</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">store-objects</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/store-objects/DataObjectsStorage.js~DataObjectsStorage.html">DataObjectsStorage</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObserverObject.js~ObserverObject.html">ObserverObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ReporterObject.js~ReporterObject.html">ReporterObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/Subscription.js~Subscription.html">Subscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-schemaValidation">schemaValidation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assign">assign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildURL">buildURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkAttribute">checkAttribute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToUserURL">convertToUserURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divideEmail">divideEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateGUID">generateGUID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getConfigurationResources">getConfigurationResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserEmailFromURL">getUserEmailFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserIdentityDomain">getUserIdentityDomain</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserURLFromEmail">getUserURLFromEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isBackendServiceURL">isBackendServiceURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isDataObjectURL">isDataObjectURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isHypertyURL">isHypertyURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isLegacy">isLegacy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isURL">isURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUserURL">isUserURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseAttributes">parseAttributes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removePathFromURL">removePathFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitObjectURL">splitObjectURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tv4">tv4</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/runtime/RuntimeUA.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
* Copyright 2016 PT Inova&#xE7;&#xE3;o e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/

import &apos;babel-polyfill&apos;;

//Main dependecies
import Registry from &apos;../registry/Registry&apos;;
import IdentityModule from &apos;../identity/IdentityModule&apos;;
import PEP from &apos;../policy/PEP&apos;;
import MessageBus from &apos;../bus/MessageBus&apos;;
import { generateGUID } from &apos;../utils/utils&apos;;
import AddressAllocation from &apos;../allocation/AddressAllocation&apos;;

import Loader from &apos;./Loader&apos;;
import Descriptors from &apos;./Descriptors&apos;;

import { runtimeConfiguration } from &apos;./runtimeConfiguration&apos;;
import { runtimeUtils } from &apos;./runtimeUtils&apos;;

import GraphConnector from &apos;../graphconnector/GraphConnector&apos;;

import CoreDiscovery from &apos;../discovery/CoreDiscovery&apos;;

import DataObjectsStorage from &apos;../store-objects/DataObjectsStorage&apos;;
import SyncherManager from &apos;../syncher/SyncherManager&apos;;
import RuntimeCoreCtx from &apos;../policy/context/RuntimeCoreCtx&apos;;

/**
 * Runtime User Agent Interface will process all the dependecies of the core runtime;
 * @author Vitor Silva [vitor-t-silva@telecom.pt]
 * @version 0.4.0
 *
 * @property {runtimeFactory} runtimeFactory - Specific implementation for all environments;
 * @property {RuntimeCatalogue} runtimeCatalogue - Catalogue of components can be installed;
 * @property {runtimeURL} runtimeURL - This identify the core runtime, should be unique;
 * @property {IdentityModule} identityModule - Identity Module;
 * @property {PEP} policyEngine - Policy Engine Module;
 * @property {Registry} registry - Registry Module;
 * @property {MessageBus} messageBus - Message Bus is used like a router to redirect the messages from one component to other(s)
 * @property {GraphConnector} graphConnector - Graph Connector handling GUID and contacts
 * @property {CoreDiscovery} discovery - Discovery for discovery hyperties/dataObjects
 */
class RuntimeUA {

  /**
   * Create a new instance of Runtime User Agent
   * @param {descriptor} runtimeDescriptor - pass all the hyperty runtime descriptor
   * @param {runtimeFactory} runtimeFactory - Specific implementation for the environment where the core runtime will run;
   * @param {domain} domainURL - specify the domain base for the runtime;
   */
  constructor(runtimeDescriptor, runtimeFactory, domain) {
    if (!runtimeDescriptor) throw new Error(&apos;The runtime descriptor is a needed parameter&apos;);
    if (!runtimeFactory) throw new Error(&apos;The sandbox factory is a needed parameter&apos;);
    if (!domain) throw new Error(&apos;You need the domain of runtime&apos;);

    // Configuration object with information related with servers
    this.runtimeConfiguration = Object.assign({domain: domain}, runtimeConfiguration);
    this.runtimeFactory = runtimeFactory;
    this.runtimeCatalogue = runtimeFactory.createRuntimeCatalogue();

    if (runtimeDescriptor.p2pHandlerStub &amp;&amp; typeof runtimeDescriptor.p2pHandlerStub  === &apos;string&apos; &amp;&amp; runtimeDescriptor.p2pHandlerStub.includes(&apos;://&apos;)) {
      this.p2p = true;
    } else {
      this.p2p = false;
    }

    runtimeUtils.runtimeDescriptor = runtimeDescriptor;
    this.runtimeUtils = runtimeUtils;

    if (typeof runtimeFactory.createRuntimeCatalogue === &apos;function&apos;) {
      this.persistenceManager = runtimeFactory.createRuntimeCatalogue();
    } else {
      throw new Error(&apos;Check your Runtime Factory because it need the Runtime Catalogue implementation&apos;);
    }

    if (typeof runtimeFactory.persistenceManager === &apos;function&apos;) {
      this.persistenceManager = runtimeFactory.persistenceManager();
    } else {
      throw new Error(&apos;Check your Runtime Factory because it need the Persistence Manager implementation&apos;);
    }

    if (typeof runtimeFactory.storageManager === &apos;function&apos;) {
      this.storageManager = runtimeFactory.storageManager();
    } else {
      throw new Error(&apos;Check your Runtime Factory because it need the Storage Manager implementation&apos;);
    }

    if (typeof runtimeFactory.runtimeCapabilities === &apos;function&apos;) {
      this.runtimeCapabilities = runtimeFactory.runtimeCapabilities(this.storageManager);
    } else {
      console.info(&apos;Check your RuntimeFactory because it need the Runtime Capabilities implementation&apos;);
    }

  }

  /**
   * Intialize the installation of runtime
   *
   * @access public
   * @return {Promise&lt;Boolean, Error&gt;} this is Promise and if the installation process happened without any problems returns true otherwise the error.
   *
   * @memberOf RuntimeUA
   */
  init() {
    return new Promise((resolve, reject) =&gt; {

      this.domain = this.runtimeConfiguration.domain;

      try {
        let getCapabilities = this.runtimeCapabilities.getRuntimeCapabilities();
        let getRuntimeURL = this.storageManager.get(&apos;runtime:URL&apos;);
        let getStoredDataObjects = this.storageManager.get(&apos;syncherManager:ObjectURLs&apos;);

        Promise.all([getRuntimeURL, getCapabilities, getStoredDataObjects]).then((results) =&gt; {

          this.runtimeURL = results[0] ? results[0].runtimeURL : results[0];
          if (!this.runtimeURL) {
            this.runtimeURL = &apos;runtime://&apos; + this.domain + &apos;/&apos; + generateGUID();
            this.storageManager.set(&apos;runtime:URL&apos;, 1, {runtimeURL: this.runtimeURL});
          }

          this.capabilities = results[1];
          Object.assign(runtimeUtils.runtimeCapabilities.constraints, results[1]);

          this._dataObjectsStorage = new DataObjectsStorage(this.storageManager, results[2] || {});

          return this._loadComponents();
        }).then((status) =&gt; {

          if (this.p2p) {
            console.info(&apos;[RuntimeUA - init] load p2pHandler: &apos;, status);
            return this._loadP2PHandler();
          } else {
            console.info(&apos;[RuntimeUA - init] P2P not supported&apos;);
            return (&apos;P2P Not Supported&apos;);
          }
        })
        .then((result) =&gt; {
          console.info(&apos;[runtime ua - init] - status: &apos;, result);
          resolve(true);
        }, (reason) =&gt; {
          console.error(&apos;ERROR: &apos;, reason);
          resolve(true);
        });

      } catch (e) {
        reject(e);
      }

    });

  }

  _loadP2PHandler() {

    return new Promise((resolve) =&gt; {

      let runtimeDescriptor = runtimeUtils.runtimeDescriptor;
      let p2pStubHandler = runtimeDescriptor.p2pHandlerStub;

      let p2pConfig = {
        isHandlerStub: true,
        runtimeURL: this.runtimeURL
      };

      console.log(&apos;[RuntimeUA loadP2PHandler] P2PStubHandler: &apos;, p2pStubHandler);

      this.loader.loadStub(p2pStubHandler, p2pConfig).then((result) =&gt; {

        let runtimeUAURL = this.runtimeURL + &apos;/ua&apos;;
        let msg = {
          type: &apos;subscribe&apos;,
          from: runtimeUAURL,
          to: &apos;domain://msg-node.&apos; + this.domain + &apos;/sm&apos;,
          body: {
            subscribe: [result.url],
            source: this.runtimeURL
          }
        };

        this.messageBus.addListener(runtimeUAURL, (msg) =&gt; {
          console.log(&apos;[runtime ua - listener] - receive msg: &apos;, msg);
        });

        this.messageBus.postMessage(msg, (reply) =&gt; {
          console.log(&apos;[runtime ua - postMessage] - reply: &apos;, reply);
        });

        console.info(&apos;[runtime ua - p2p installation] - success: &apos;, result);
        resolve(true);
      }).catch((reason) =&gt; {
        console.info(&apos;[runtime ua - p2p installation] - fail: &apos;, reason);
        resolve(false);
      });

    });

  }

  /**
   *
   * @access private
   * @return {Promise&lt;Boolean, Error&gt;} this is Promise and returns true if all components are loaded with success or an error if someone fails.
   *
   * @memberOf RuntimeUA
   */
  _loadComponents() {

    return new Promise((resolve, reject) =&gt; {

      try {

        // Prepare the on instance to handle with the fallbacks and runtimeCatalogue;
        this.descriptorInstance = new Descriptors(this.runtimeURL, this.runtimeCatalogue, this.runtimeConfiguration);

        // Prepare the loader to load the hyperties, protostubs and idpproxy;
        this.loader = new Loader(this.runtimeURL, this.runtimeConfiguration, this.descriptorInstance);

        // Instantiate the identity Module
        this.identityModule = new IdentityModule(this.runtimeURL, this.runtimeCapabilities, this.storageManager, this._dataObjectsStorage);

        // Use the sandbox factory to create an AppSandbox;
        // In the future can be decided by policyEngine if we need
        // create a AppSandbox or not;
        let appSandbox = this.runtimeFactory.createAppSandbox();

        // Instantiate the Registry Module
        this.registry = new Registry(this.runtimeURL, appSandbox, this.identityModule, this.runtimeCatalogue, this.runtimeCapabilities, this.storageManager);

        // Set the loader to load Hyperties, Stubs and IdpProxies
        this.registry.loader = this.loader;

        // Instantiate the Message Bus
        this.messageBus = new MessageBus(this.registry);

        // Prepare the address allocation instance;
        this.addressAllocation = new AddressAllocation(this.runtimeURL, this.messageBus, this.registry);

        // before the merge
        //this.policyEngine = new PEP(new RuntimeCoreCtx(this.identityModule, this.registry, this.storageManager, this.runtimeCapabilities));

        // Instantiate the Policy Engine
        this.policyEngine = new PEP(new RuntimeCoreCtx(this.runtimeURL, this.identityModule, this.registry, this.storageManager, this.runtimeCapabilities));

        this.messageBus.pipeline.handlers = [

          // Policy message authorise
          (ctx) =&gt; {
            this.policyEngine.authorise(ctx.msg).then((changedMgs) =&gt; {
              ctx.msg = changedMgs;
              ctx.next();
            }).catch((reason) =&gt; {
              console.error(reason);
              ctx.fail(reason);
            });
          }
        ];

        // Instantiate the Graph Connector
        this.graphConnector = new GraphConnector(this.runtimeURL, this.messageBus, this.storageManager);

        // Instantiate Discovery
        console.log(&quot;runtimeFactory: &quot;, this.runtimeFactory);
        this.coreDiscovery = new CoreDiscovery(this.runtimeURL, this.messageBus, this.graphConnector, this.runtimeFactory, this.registry);

        // Instantiate Discovery Lib for Testing
        //_this.discovery = new Discovery(_this.runtimeURL, _this.messageBus);
        // _this.loadStub(&quot;localhost&quot;);
        // setTimeout(function(){
        //_this.discovery.discoverHyperties(&quot;user://google.com/bernardo.marquesg@gmail.com&quot;, [&quot;comasdm&quot;], [&quot;chat&quot;]);
        // }, 2000);

        // Add to App Sandbox the listener;
        appSandbox.addListener(&apos;*&apos;, (msg) =&gt; {
          this.messageBus.postMessage(msg);
        });

        // Register messageBus on Registry
        this.registry.messageBus = this.messageBus;

        // Policy Engine
        this.policyEngine.messageBus = this.messageBus;

        // Register messageBus on IDM
        this.identityModule.messageBus = this.messageBus;

        // Register registry on IdentityModule
        this.identityModule.registry = this.registry;

        // Use sandbox factory to use specific methods
        // and set the message bus to the factory
        this.runtimeFactory.messageBus = this.messageBus;

        // Instanciate the SyncherManager;
        this.syncherManager = new SyncherManager(this.runtimeURL, this.messageBus, this.registry, this.runtimeCatalogue, this.storageManager, null, this._dataObjectsStorage, this.identityModule);

        // Set into loader the needed components;
        this.loader.runtimeURL = this.runtimeURL;
        this.loader.messageBus = this.messageBus;
        this.loader.registry = this.registry;
        this.loader.runtimeCatalogue = this.runtimeCatalogue;
        this.loader.runtimeFactory = this.runtimeFactory;

        resolve(true);

      } catch (e) {
        reject(e);
      }

    });

  }

  /**
   * Deploy Hyperty from Catalogue URL
   *
   * @see https://github.com/reTHINK-project/specs/tree/master/datamodel/core/address
   *
   * @param {URL.HypertyCatalogueURL} hypertyCatalogueURL - The Catalogue URL used to identify descriptors in the Catalogue.
   * @param {boolean|URL.HypertyURL} [reuseURL=false] reuseURL - reuseURL is used to reuse the hypertyURL previously registred, by default the reuse is disabled;
   * @param {URL} appURL - the app url address; // TODO: improve this description;
   * @returns {Promise&lt;Boolean, Error&gt;} this is Promise and returns true if all components are loaded with success or an error if someone fails.
   *
   * @memberOf RuntimeUA
   */
  loadHyperty(hypertyCatalogueURL, reuseURL = false, appURL) {

    if (!hypertyCatalogueURL) throw new Error(&apos;Hyperty descriptor url parameter is needed&apos;);
    return this.loader.loadHyperty(hypertyCatalogueURL, reuseURL, appURL);

  }

  /**
  * Deploy Stub from Catalogue URL or domain url
  * @param  {URL.URL}     domain          domain
  */
  loadStub(protocolstubCatalogueURL) {

    if (!protocolstubCatalogueURL) throw new Error(&apos;ProtoStub descriptor url parameter is needed&apos;);
    return this.loader.loadStub(protocolstubCatalogueURL);

  }

  /**
  * Deploy idpProxy from Catalogue URL or domain url
  * @param  {URL.URL}     domain          domain
  */
  loadIdpProxy(ipdProxyCatalogueURL) {

    if (!ipdProxyCatalogueURL) throw new Error(&apos;The IDP Proxy URL is a needed parameter, could be a DOMAIN or a URL&apos;);
    return this.loader.loadIdpProxy(ipdProxyCatalogueURL);
  }

  /**
   * Used to close all the runtime; Unregister all hyperties;
   * @return {Promise&lt;Boolean&gt;} result of the close method, with true or false to the operation success;
   */
  close() {
    let _this = this;

    console.info(&apos;Unregister all hyperties&apos;);
    return new Promise(function(resolve, reject) {

      _this.registry.unregisterAllHyperties().then(function(result) {
        console.info(&apos;All the hyperties are unregisted with Success:&apos;, result);
        resolve(true);
      }).catch(function(reason) {
        console.error(&apos;Failed to unregister the hyperties&apos;, reason);
        reject(false);
      });

    });

  }

}

export default RuntimeUA;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
