<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/syncher/SyncherManager.js | Service Framework API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">allocation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/allocation/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Bus.js~Bus.html">Bus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">discovery</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/discovery/CoreDiscovery.js~CoreDiscovery.html">CoreDiscovery</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Crypto.js~Crypto.html">Crypto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/GuiFake.js~GuiFake.html">GuiFake</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Identity.js~Identity.html">Identity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/OpenIdLib.js~OpenIdLib.html">OpenIdLib</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/ActionsService.js~ActionsService.html">ActionsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/CombiningAlgorithm.js~CombiningAlgorithm.html">CombiningAlgorithm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Operators.js~Operators.html">Operators</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PDP.js~PDP.html">PDP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PEP.js~PEP.html">PEP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Policy.js~Policy.html">Policy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/ReThinkCtx.js~ReThinkCtx.html">ReThinkCtx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/Rule.js~Rule.html">Rule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/combiningAlgorithms</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/AllowOverrides.js~AllowOverrides.html">AllowOverrides</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/BlockOverrides.js~BlockOverrides.html">BlockOverrides</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/combiningAlgorithms/FirstApplicable.js~FirstApplicable.html">FirstApplicable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/conditions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/AdvancedCondition.js~AdvancedCondition.html">AdvancedCondition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/Condition.js~Condition.html">Condition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/conditions/SubscriptionCondition.js~SubscriptionCondition.html">SubscriptionCondition</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy/context</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/context/RuntimeCoreCtx.js~RuntimeCoreCtx.html">RuntimeCoreCtx</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/protostub/IdpProxyStub.js~IdpProxyStub.html">IdpProxyStub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/Descriptors.js~Descriptors.html">Descriptors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/Loader.js~Loader.html">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-runtimeConfiguration">runtimeConfiguration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-runtimeUtils">runtimeUtils</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SandboxType">SandboxType</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">store-objects</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/store-objects/DataObjectsStorage.js~DataObjectsStorage.html">DataObjectsStorage</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObserverObject.js~ObserverObject.html">ObserverObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ReporterObject.js~ReporterObject.html">ReporterObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/Subscription.js~Subscription.html">Subscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-schemaValidation">schemaValidation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assign">assign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildURL">buildURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkAttribute">checkAttribute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToUserURL">convertToUserURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divideEmail">divideEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateGUID">generateGUID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getConfigurationResources">getConfigurationResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserEmailFromURL">getUserEmailFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserIdentityDomain">getUserIdentityDomain</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserURLFromEmail">getUserURLFromEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isBackendServiceURL">isBackendServiceURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isDataObjectURL">isDataObjectURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isHypertyURL">isHypertyURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isLegacy">isLegacy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isURL">isURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUserURL">isUserURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseAttributes">parseAttributes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removePathFromURL">removePathFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitObjectURL">splitObjectURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tv4">tv4</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/syncher/SyncherManager.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
* Copyright 2016 PT Inova&#xE7;&#xE3;o e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/
import { divideURL, deepClone } from &apos;../utils/utils&apos;;
import { schemaValidation } from &apos;../utils/schemaValidation&apos;;

import AddressAllocation from &apos;../allocation/AddressAllocation&apos;;
import ReporterObject from &apos;./ReporterObject&apos;;
import ObserverObject from &apos;./ObserverObject&apos;;

import {MessageFactory} from &apos;service-framework/dist/MessageFactory&apos;;

/**
 * @author micaelpedrosa@gmail.com
 * Core Syncronization system.
 */
class SyncherManager {
  /* private
  _url: URL
  _bus: MiniBus
  _registry: Registry
  _allocator: AddressAllocation

  _reporters: { ObjectURL: ReporterObject }
  _observers: { ObjectURL: ObserverObject }
  */

  constructor(runtimeURL, bus, registry, catalog, storageManager, allocator, storeDataObjects, identityModule) {
    if (!runtimeURL) throw new Error(&apos;[Syncher Manager] - needs the runtimeURL parameter&apos;);
    if (!bus) throw new Error(&apos;[Syncher Manager] - needs the MessageBus instance&apos;);
    if (!registry) throw new Error(&apos;[Syncher Manager] - needs the Registry instance&apos;);
    if (!catalog) throw new Error(&apos;[Syncher Manager] - needs the RuntimeCatalogue instance&apos;);
    if (!storageManager) throw new Error(&apos;[Syncher Manager] - need the storageManager instance&apos;);

    let _this = this;

    _this._bus = bus;
    _this._registry = registry;
    _this._catalog = catalog;
    _this._storageManager = storageManager;
    _this._identityModule = identityModule;

    //TODO: these should be saved in persistence engine?
    _this.runtimeURL = runtimeURL;
    _this._url = runtimeURL + &apos;/sm&apos;;
    _this._objectURL = runtimeURL + &apos;/object-allocation&apos;;

    _this._reporters = {};
    _this._observers = {};

    _this._dataObjectsStorage = storeDataObjects;

    //TODO: this should not be hardcoded!
    _this._domain = divideURL(runtimeURL).domain;

    _this._mf = new MessageFactory(false, {});

    if (allocator) {
      _this._allocator = allocator;
    } else {
      _this._allocator = AddressAllocation.instance;
    }

    console.log(&apos;[SyncherManager - AddressAllocation] - &apos;, _this._allocator);

    bus.addListener(_this._url, (msg) =&gt; {
      console.log(&apos;[SyncherManager] RCV: &apos;, msg);
      switch (msg.type) {
        case &apos;create&apos;: _this._onCreate(msg); break;
        case &apos;delete&apos;: _this._onDelete(msg); break;
        case &apos;subscribe&apos;: _this._onLocalSubscribe(msg); break;
        case &apos;unsubscribe&apos;: _this._onLocalUnSubscribe(msg); break;
      }
    });

  }

  get url() { return this._url; }

  //FLOW-IN: message received from Syncher -&gt; create
  _onCreate(msg) {

    let from = msg.from;
    let to = msg.to;

    if (!msg.body.hasOwnProperty(&apos;resume&apos;) || (msg.body.hasOwnProperty(&apos;resume&apos;) &amp;&amp; !msg.body.resume)) {

      // If from the hyperty side, don&apos;t call the resumeReporter we will have resume = false&apos;
      // so we will create a not resumed object and always create a new object;
      console.info(&apos;[SyncherManager - Create New Object]&apos;, msg);
      this._newCreate(msg);
    } else {

      // If from the hyperty side, call the resumeReporter we will have resume = true&apos;
      // so we will create an resumed object and will try to resume the object previously saved;
      this._dataObjectsStorage.getResourcesByCriteria(msg, true).then((result) =&gt; {

        console.info(&apos;[SyncherManager - Create Resumed] - ResourcesByCriteria | Message: &apos;, msg, &apos; result: &apos;, result);

        if (result &amp;&amp; Object.keys(result).length &gt; 0) {

          let listOfReporters = [];

          Object.keys(result).forEach((objURL) =&gt; {
            listOfReporters.push(this._resumeCreate(msg, result[objURL]));
          });

          Promise.all(listOfReporters).then((resumedReporters) =&gt; {
            console.log(&apos;[SyncherManager - Create Resumed]&apos;, resumedReporters);

            // TODO: shoud send the information if some object was fail;
            let successfullyResumed = Object.values(resumedReporters).filter((reporter) =&gt; {
              return reporter !== false;
            });

            console.info(&apos;[SyncherManager.onCreate] returning resumed objects : &apos;, successfullyResumed);

            //FLOW-OUT: message response to Syncher -&gt; create resume
            this._bus.postMessage({
              id: msg.id, type: &apos;response&apos;, from: to, to: from,
              body: { code: 200, value: successfullyResumed }
            });

          });

        } else {
          //forward to hyperty:
          let reply = {};
          reply.id = msg.id;
          reply.from = msg.to;
          reply.to = msg.from;
          reply.type = &apos;response&apos;;
          reply.body = {
            code: 404,
            desc: &apos;No data objects reporters to be resumed&apos;
          };
          this._bus.postMessage(reply);
        }

      });
    }

  }

  _newCreate(msg) {
    let _this = this;

    let owner = msg.from;
    let domain = divideURL(msg.from).domain;

    // if reporter is in a Interworking Protostub the runtime domain backend services will be used
    if (_this._registry.isInterworkingProtoStub(msg.from)) {
      domain = divideURL(_this.runtimeURL).domain;
    }

    if (msg.body.resource) {
      _this._authorise(msg, msg.body.resource);
      return;
    }

    //get schema from catalogue and parse -&gt; (scheme, children)
    _this._catalog.getDataSchemaDescriptor(msg.body.schema).then((descriptor) =&gt; {

      let properties = descriptor.sourcePackage.sourceCode.properties;
      let scheme = properties.scheme ? properties.scheme.constant : &apos;resource&apos;;
      let childrens = properties.children ? properties.children.constant : [];

      // Do schema validation
      // TODO: check if is need to handle with the result of validation
      schemaValidation(scheme, descriptor, msg.body.value);

      let objectInfo = {
        name: msg.body.value.name,
        schema: msg.body.value.schema,
        reporter: msg.body.value.reporter,
        resources: msg.body.value.resources
      };

      // should resuse data object url if it passed
      let reuseDataObject = msg.body.value.resource;
      let numOfAddress = 1;

      //request address allocation of a new object from the msg-node
      _this._allocator.create(domain, numOfAddress, objectInfo, scheme, reuseDataObject).then((allocated) =&gt; {
        let objectRegistration = deepClone(msg.body.value);
        objectRegistration.url = allocated.address[0];
        objectRegistration.authorise = msg.body.authorise;
        objectRegistration.childrens = childrens;
        delete objectRegistration.data;

        console.log(&apos;[SyncherManager._newCreate] ALLOCATOR CREATE:&apos;, allocated);

        let subscriptionURL = objectRegistration.url + &apos;/subscription&apos;;

        console.log(&apos;[SyncherManager._newCreate] Subscription URL&apos;, subscriptionURL);

        //To register the dataObject in the runtimeRegistry
        console.info(&apos;[SyncherManager._newCreate] Register Object: &apos;, objectRegistration);
        //_this._registry.registerDataObject(msg.body.value.name, msg.body.value.schema, objURL, msg.body.value.reporter, msg.body.value.resources, allocated, msg.body.authorise).then((resolve) =&gt; {
        _this._registry.registerDataObject(objectRegistration).then((resolve) =&gt; {
          console.log(&apos;[SyncherManager._newCreate] DataObject successfully registered&apos;, resolve);

          //all OK -&gt; create reporter and register listeners
          let reporter;

          if (!this._reporters[objectRegistration.url]) {
            reporter = new ReporterObject(_this, owner, objectRegistration.url);
          } else {
            reporter = this._reporters[objectRegistration.url];
          }

          console.log(&apos;[SyncherManager - new Create] - &apos;, msg);

          // Store for each reporter hyperty the dataObject
          let userURL;
          let interworking = false;

          if (msg.body.hasOwnProperty(&apos;identity&apos;) &amp;&amp; msg.body.identity.userProfile.userURL) {
            userURL = msg.body.identity.userProfile.userURL;
            if (!userURL.includes(&apos;user://&apos;)) {
              interworking = true;
            }
          } else {
            interworking = true;
          }

          // should we use the msg.body.value instead?

          let metadata = deepClone(objectRegistration);
          metadata.subscriberUser = userURL;
          metadata.isReporter = true;
          delete metadata.expires;

          // Store the dataObject information

          if (!interworking) {
            _this._dataObjectsStorage.set(metadata);

            if (msg.body.hasOwnProperty(&apos;store&apos;) &amp;&amp; msg.body.store) {
              reporter.isToSaveData = true;
              _this._dataObjectsStorage.update(true, objectRegistration.url, &apos;isToSaveData&apos;, true);

              if (msg.body.value.data) { _this._dataObjectsStorage.saveData(true, objectRegistration.url, null, msg.body.value.data); }
            }
          }

          // adding listeners to forward to reporter

          reporter.forwardSubscribe([objectRegistration.url, subscriptionURL]).then(() =&gt; {
            reporter.addChildrens(childrens).then(() =&gt; {
              _this._reporters[objectRegistration.url] = reporter;

              //FLOW-OUT: message response to Syncher -&gt; create
              _this._bus.postMessage({
                id: msg.id, type: &apos;response&apos;, from: msg.to, to: owner,
                body: { code: 200, resource: objectRegistration.url, childrenResources: childrens }
              });

              //send create to all observers, responses will be deliver to the Hyperty owner?
              //schedule for next cycle needed, because the Reporter should be available.
              setTimeout(() =&gt; {
                //will invite other hyperties
                _this._authorise(msg, objectRegistration.url);
              });
            });
          });
        }, function(error) {
          console.error(error);
        });

      });
    }).catch((reason) =&gt; {
      //FLOW-OUT: error message response to Syncher -&gt; create
      let responseMsg = {
        id: msg.id, type: &apos;response&apos;, from: msg.to, to: owner,
        body: { code: 500, desc: reason }
      };

      _this._bus.postMessage(responseMsg);
    });

  }

  _resumeCreate(msg, storedObject) {

    let _this = this;

    return new Promise((resolve) =&gt; {

      let owner = msg.from;
      let schema = storedObject.schema;
      let resource = storedObject.url;
      let initialData = storedObject.data;

      console.log(&apos;[SyncherManager] - resume create&apos;, msg, storedObject);

      //get schema from catalogue and parse -&gt; (scheme, children)
      _this._catalog.getDataSchemaDescriptor(schema).then((descriptor) =&gt; {

        let properties = descriptor.sourcePackage.sourceCode.properties;
        let scheme = properties.scheme ? properties.scheme.constant : &apos;resource&apos;;
        let childrens = properties.children ? properties.children.constant : [];

        console.log(&apos;[SyncherManager] - getDataSchemaDescriptor: &apos;, descriptor, childrens);

        // Do schema validation
        // TODO: check if is need to handle with the result of validation
        schemaValidation(scheme, descriptor, initialData);

        //all OK -&gt; create reporter and register listeners
        let reporter;

        if (!this._reporters[resource]) {
          reporter = new ReporterObject(_this, owner, resource);
        } else {
          reporter = this._reporters[resource];
        }

        reporter.isToSaveData = storedObject.isToSaveData;

        reporter.forwardSubscribe([storedObject.url]).then(() =&gt; {
          reporter.addChildrens(childrens).then(() =&gt; {

            reporter.resumeSubscriptions(storedObject.subscriptions);

            _this._reporters[resource] = reporter;

            console.info(&apos;[SyncherManager - resume create] - resolved resumed: &apos;, storedObject);

            return _this._decryptChildrens(storedObject, childrens);
          }).then((decryptedObject) =&gt; {
              // console.log(&apos;result of previous promise&apos;);
            resolve(decryptedObject);
          }).catch((reason) =&gt; {
            console.error(&apos;[SyncherManager - resume create] - fail on addChildrens: &apos;, reason);
            resolve(false);
          });
        });
      //  resolve();
      }).catch((reason) =&gt; {
        console.error(&apos;[SyncherManager - resume create] - fail on getDataSchemaDescriptor: &apos;, reason);
        resolve(false);
      });
    });
  }

  // to decrypt DataChildObjects if they are encrypted

  _decryptChildrens(storedObject, childrens) {
    let _this = this;
    return new Promise((resolve, reject) =&gt; {

      if (!childrens) resolve(storedObject);
      else {

        let childrensObj = Object.keys(storedObject[&apos;childrenObjects&apos;]);

        if (childrensObj.length === 0) {
          resolve(storedObject);
        }

        childrens.forEach((children)=&gt;{

          let childObjects = storedObject[&apos;childrenObjects&apos;][children];

          console.log(&apos;[SyncherManager._decryptChildrens] dataObjectChilds to decrypt &apos;,  childObjects);

          let listOfDecryptedObjects = [];

          Object.keys(childObjects).forEach((childId)=&gt;{
            let child = childObjects[childId];
            let owner = childId.split(&apos;#&apos;)[0];

            if ( typeof child.value === &apos;string&apos;){

              console.log(&apos;[SyncherManager._decryptChildrens] createdBy &apos;,  owner, &apos; object: &apos;, child.value);

              let decrypted = _this._identityModule.decryptDataObject(JSON.parse(child.value), storedObject.data.url).then((decryptedObject) =&gt; {
                storedObject[&apos;childrenObjects&apos;][children][childId].value = decryptedObject.value;
              });

              listOfDecryptedObjects.push(decrypted);
            }
          });


          Promise.all(listOfDecryptedObjects).then((decryptedObjects) =&gt; {

            console.log(&apos;[SyncherManager._decryptChildrens] returning decrypted &apos;, decryptedObjects);

              /*Object.keys(childObjects).forEach((childId)=&gt;{
                storedObject[&apos;childrens&apos;][children][childId].value = decryptedObjects[childId].value;
                console.log(&apos;[SyncherManager._decryptChildrens] adding &apos;, decryptedObjects[childId].value);

              });

              console.info(&apos;[SyncherManager._decryptChildrens] returning decrypted objects : &apos;, storedObject);*/

            resolve(storedObject);

          }).catch((reason) =&gt; {
            console.warn(&apos;[SyncherManager._decryptChildrens] failed : &apos;, reason);
          });
        });
      }
    });
  }

  _authorise(msg, objURL) {
    let _this = this;
    let objSubscriptorURL = objURL + &apos;/subscription&apos;;

    console.log(&apos;[SyncherManager -  authorise] - &apos;, msg, objURL);

    if (msg.body.authorise) {
      msg.body.authorise.forEach((hypertyURL) =&gt; {
        //FLOW-OUT: send invites to list of remote Syncher -&gt; _onRemoteCreate -&gt; onNotification
        _this._bus.postMessage({
          type: &apos;create&apos;, from: objSubscriptorURL, to: hypertyURL,
          body: { identity: msg.body.identity, source: msg.from, value: msg.body.value, schema: msg.body.schema }
        });
      });
    }
  }

  //FLOW-IN: message received from DataObjectReporter -&gt; delete
  _onDelete(msg) {
    let _this = this;

    let objURL = msg.body.resource;

    let object = _this._reporters[objURL];
    if (object) {
      //TODO: is there any policy verification before delete?
      object.delete();

      this._dataObjectsStorage.deleteResource(objURL);

      _this._registry.unregisterDataObject(objURL);

      //TODO: unregister object?
      _this._bus.postMessage({
        id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
        body: { code: 200 }
      });
    }
  }

  //FLOW-IN: message received from local Syncher -&gt; subscribe
  _onLocalSubscribe(msg) {

    this._dataObjectsStorage.getResourcesByCriteria(msg, false).then((result) =&gt; {

      console.info(&apos;[SyncherManager - Subscribe] - ResourcesByCriteria | Message: &apos;, msg, &apos; result: &apos;, result);

      if (result &amp;&amp; Object.keys(result).length &gt; 0) {

        let listOfObservers = [];

        // TODO: should reuse the storaged information
        Object.keys(result).forEach((objURL) =&gt; {
          console.log(&apos;[SyncherManager - resume Subscribe] - reuse current object url: &apos;, result[objURL]);
          listOfObservers.push(this._resumeSubscription(msg, result[objURL]));
        });

        Promise.all(listOfObservers).then((resumedObservers) =&gt; {
          console.log(&apos;[SyncherManager - Observers Resumed]&apos;, resumedObservers);

          // TODO: shoud send the information if some object was fail;
          let successfullyResumed = Object.values(resumedObservers).filter((observer) =&gt; {
            return observer !== false;
          });

          //FLOW-OUT: message response to Syncher -&gt; create
          this._bus.postMessage({
            id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
            body: { code: 200, value: successfullyResumed }
          });

        });

      } else if (msg.body.schema &amp;&amp; msg.body.resource) {
        console.log(&apos;[SyncherManager.onLocalSubscribe - new Subscribe] - &apos;, msg.body.schema, msg.body.resource);
        this._newSubscription(msg);
      } else {
        //forward to hyperty:
        let reply = {};
        reply.id = msg.id;
        reply.from = msg.to;
        reply.to = msg.from;
        reply.type = &apos;response&apos;;
        reply.body = {
          code: 404,
          desc: &apos;No data objects observers to be resumed&apos;
        };
        this._bus.postMessage(reply);
      }

    });

  }

  _newSubscription(msg) {
    let _this = this;

    let objURL = msg.body.resource;

    let hypertyURL = msg.from;
    let domain = divideURL(objURL).domain;
    let objURLSubscription = objURL + &apos;/subscription&apos;;

    let childBaseURL = objURL + &apos;/children/&apos;;

    //get schema from catalogue and parse -&gt; (children)
    _this._catalog.getDataSchemaDescriptor(msg.body.schema).then((descriptor) =&gt; {
      let properties = descriptor.sourcePackage.sourceCode.properties;
      let childrens = properties.children ? properties.children.constant : [];

      let subscriptions = [];
      subscriptions.push(objURL + &apos;/changes&apos;);

      childrens.forEach((child) =&gt; subscriptions.push(childBaseURL + child));

      //children addresses

      //FLOW-OUT: subscribe message to the msg-node, registering listeners on the broker
      let nodeSubscribeMsg = {
        type: &apos;subscribe&apos;, from: _this._url, to: &apos;domain://msg-node.&apos; + domain + &apos;/sm&apos;,
        body: { identity: msg.body.identity, resources: subscriptions, source: hypertyURL }
      };

      //subscribe in msg-node
      _this._bus.postMessage(nodeSubscribeMsg, (reply) =&gt; {
        console.log(&apos;node-subscribe-response(observer): &apos;, reply);
        if (reply.body.code === 200) {

          //FLOW-OUT: reply with provisional response
          _this._bus.postMessage({
            id: msg.id, type: &apos;response&apos;, from: msg.to, to: hypertyURL,
            body: { code: 100, childrenResources: childrens, schema: msg.body.schema, resource: msg.body.resource }
          });

          //FLOW-OUT: subscribe message to remote ReporterObject -&gt; _onRemoteSubscribe
          let objSubscribeMsg = {
            type: &apos;subscribe&apos;, from: _this._url, to: objURLSubscription,
            body: { identity: nodeSubscribeMsg.body.identity, subscriber: hypertyURL }
          };

          //TODO: For Further Study
          if (msg.body.hasOwnProperty(&apos;mutualAuthentication&apos;)) objSubscribeMsg.body.mutualAuthentication = msg.body.mutualAuthentication;
          console.log(&apos;[SyncherManager._newSubscription]&apos;, objSubscribeMsg, msg);

          //subscribe to reporter SM
          _this._bus.postMessage(objSubscribeMsg, (reply) =&gt; {
            console.log(&apos;reporter-subscribe-response-new: &apos;, reply);
            if (reply.body.code === 200) {

              let observer = _this._observers[objURL];
              if (!observer) {
                observer = new ObserverObject(_this, objURL, childrens);
                _this._observers[objURL] = observer;
              }

              let interworking = false;

              // Store for each reporter hyperty the dataObject
              let userURL;
              if (msg.body.hasOwnProperty(&apos;identity&apos;) &amp;&amp; msg.body.identity.userProfile.userURL) {
                userURL = msg.body.identity.userProfile.userURL;
                if (!userURL.includes(&apos;user://&apos;)) {
                  interworking = true;
                }
              } else {
                interworking = true;
              }

              let metadata = deepClone(reply.body.value);
              delete metadata.data;
              metadata.childrens = childrens;
              metadata.subscriberUser = userURL;
              metadata.isReporter = false;
              metadata.subscriberHyperty = hypertyURL;

              if (!interworking) {
                //_this._dataObjectsStorage.set(objURL, false, msg.body.schema, &apos;on&apos;, reply.body.owner, hypertyURL, childrens, userURL);
                _this._dataObjectsStorage.set(metadata);
                if ((metadata.hasOwnProperty(&apos;store&apos;) &amp;&amp; metadata.store) || (metadata.hasOwnProperty(&apos;isToSaveData&apos;) &amp;&amp; metadata.isToSaveData)) {
                  observer.isToSaveData = true;
                  _this._dataObjectsStorage.update(false, objURL, &apos;isToSaveData&apos;, true);
                  _this._dataObjectsStorage.saveData(false, objURL, null, reply.body.value.data);
                }
              }

              // register new hyperty subscription
              observer.addSubscription(hypertyURL);

              // add childrens and listeners to save data if necessary
              observer.addChildrens(childrens);

              //forward to hyperty:
              reply.id = msg.id;
              reply.from = _this._url;
              reply.to = hypertyURL;
              reply.body.schema = msg.body.schema;
              reply.body.resource = msg.body.resource;

              //TODO: For Further Study
              if (msg.body.hasOwnProperty(&apos;mutualAuthentication&apos;)) reply.body.mutualAuthentication = msg.body.mutualAuthentication;
              console.log(&apos;[subscribe] - new subscription: &apos;, msg, reply, observer);

              this._bus.postMessage(reply);

            }
          });

        } else {
          //listener rejected
          _this._bus.postMessage({
            id: msg.id, type: &apos;response&apos;, from: msg.to, to: hypertyURL,
            body: reply.body
          });
        }
      });

    });

  }

  _resumeSubscription(msg, storedObject) {

    return new Promise((resolve) =&gt; {

      let objURL = storedObject.url;
      let schema = storedObject.schema;

      let hypertyURL = msg.from;

      // let objURLSubscription = objURL + &apos;/subscription&apos;;

      let childBaseURL = objURL + &apos;/children/&apos;;

      console.log(&apos;[SyncherManager - ReuseSubscription] - objURL: &apos;, objURL, &apos; - schema:&apos;, schema);

      //get schema from catalogue and parse -&gt; (children)
      // TODO: remove this since children resources should be available in the DataObjectsStorage
      this._catalog.getDataSchemaDescriptor(schema).then((descriptor) =&gt; {
        let properties = descriptor.sourcePackage.sourceCode.properties;
        let childrens = properties.children ? properties.children.constant : [];

        //children addresses
        let subscriptions = [];
        subscriptions.push(objURL + &apos;/changes&apos;);
        childrens.forEach((child) =&gt; subscriptions.push(childBaseURL + child));

        //FLOW-OUT: reply with provisional response
        this._bus.postMessage({
          id: msg.id, type: &apos;response&apos;, from: msg.to, to: hypertyURL,
          body: { code: 100, childrenResources: childrens, schema: schema, resource: objURL }
        });

        //FLOW-OUT: subscribe message to remote ReporterObject -&gt; _onRemoteSubscribe
        /*let objSubscribeMsg = {
          type: &apos;subscribe&apos;, from: this._url, to: objURLSubscription,
          body: { subscriber: hypertyURL, identity: msg.body.identity }
        };

        //subscribe to reporter SM
        this._bus.postMessage(objSubscribeMsg, (reply) =&gt; {*/

        let observer = this._observers[objURL];
        if (!observer) {
          observer = new ObserverObject(this, objURL, childrens);
          observer.isToSaveData = storedObject.isToSaveData;
          this._observers[objURL] = observer;
        }

        //register new hyperty subscription
        observer.addSubscription(hypertyURL);
        observer.addChildrens(childrens);

        // Object.assign(storedObject.data, reply.body.value.data);
        // Object.assign(storedObject.childrens, reply.body.value.childrens);

        //console.log(&apos;[subscribe] - resume subscription: &apos;, msg, reply, storedObject, observer);

        return this._decryptChildrens(storedObject, childrens);
      }).then((decryptedObject) =&gt; {
          // console.log(&apos;result of previous promise&apos;);
        resolve(decryptedObject);
      }).catch((reason) =&gt; {
        console.error(&apos;[SyncherManager - resume subscription] - fail on getDataSchemaDescriptor: &apos;, reason);
        resolve(false);
      });
    });
  }

  //FLOW-IN: message received from local DataObjectObserver -&gt; unsubscribe
  _onLocalUnSubscribe(msg) {
    let _this = this;

    let hypertyURL = msg.from;
    let objURL = msg.body.resource;

    let observer = _this._observers[objURL];
    if (observer) {
      //TODO: is there any policy verification before delete?
      observer.removeSubscription(msg);

      //TODO: destroy object in the registry?
      _this._bus.postMessage({
        id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
        body: { code: 200 }
      });

      this._dataObjectsStorage.deleteResource(objURL);

      //TODO: remove Object if no more subscription?
      //delete _this._observers[objURL];
    }
  }

}

export default SyncherManager;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
