// version: 0.18.1
// date: Wed Jul 03 2019 12:57:33 GMT+0100 (GMT+01:00)
// licence: 
/**
* Copyright 2016 PT Inovação e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/


// version: 0.18.1
// date: Wed Jul 03 2019 12:57:33 GMT+0100 (GMT+01:00)
// licence: 
/**
* Copyright 2016 PT Inovação e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/


System.register("[name]",[],function(e){return{execute:function(){e(function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(s,o,function(t){return e[t]}.bind(null,o));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=123)}([function(e,t,r){var s,o;!function(n,i){"use strict";void 0===(o="function"==typeof(s=function(){var e=function(){},t="undefined",r=["trace","debug","info","warn","error"];function s(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function o(t,s){for(var o=0;o<r.length;o++){var n=r[o];this[n]=o<t?e:this.methodFactory(n,t,s)}this.log=this.debug}function n(r,n,i){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&(void 0!==console[r]?s(console,r):void 0!==console.log?s(console,"log"):e)}(r)||function(e,r,s){return function(){typeof console!==t&&(o.call(this,r,s),this[e].apply(this,arguments))}}.apply(this,arguments)}function i(e,s,i){var a,c=this,u="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,s=r.indexOf(encodeURIComponent(u)+"=");-1!==s&&(e=/^([^;]+)/.exec(r.slice(s))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=i||n,c.getLevel=function(){return a},c.setLevel=function(s,n){if("string"==typeof s&&void 0!==c.levels[s.toUpperCase()]&&(s=c.levels[s.toUpperCase()]),!("number"==typeof s&&s>=0&&s<=c.levels.SILENT))throw"log.setLevel() called with invalid level: "+s;if(a=s,!1!==n&&function(e){var s=(r[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[u]=s)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+s+";"}catch(e){}}}(s),o.call(c,s,e),typeof console===t&&s<c.levels.SILENT)return"No console available for logging"},c.setDefaultLevel=function(e){l()||c.setLevel(e,!1)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)};var d=l();null==d&&(d=null==s?"WARN":s),c.setLevel(d,!1)}var a=new i,c={};a.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new i(e,a.getLevel(),a.methodFactory)),t};var u=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=u),a},a.getLoggers=function(){return c},a})?s.call(t,r,t,e):s)||(e.exports=o)}()},function(e,t,r){var s=r(2),o=r(8),n=r(15),i=r(12),a=r(18),c=function(e,t,r){var u,l,d,h,y=e&c.F,p=e&c.G,f=e&c.S,g=e&c.P,b=e&c.B,m=p?s:f?s[t]||(s[t]={}):(s[t]||{}).prototype,_=p?o:o[t]||(o[t]={}),v=_.prototype||(_.prototype={});for(u in p&&(r=t),r)d=((l=!y&&m&&void 0!==m[u])?m:r)[u],h=b&&l?a(d,s):g&&"function"==typeof d?a(Function.call,d):d,m&&i(m,u,d,e&c.U),_[u]!=d&&n(_,u,h),g&&v[u]!=d&&(v[u]=d)};s.core=o,c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,e.exports=c},function(e,t){var r=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,r){var s=r(5);e.exports=function(e){if(!s(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,r){var s=r(49)("wks"),o=r(30),n=r(2).Symbol,i="function"==typeof n;(e.exports=function(e){return s[e]||(s[e]=i&&n[e]||(i?n:o)("Symbol."+e))}).store=s},function(e,t,r){var s=r(20),o=Math.min;e.exports=function(e){return e>0?o(s(e),9007199254740991):0}},function(e,t){var r=e.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(e,t,r){e.exports=!r(3)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,r){var s=r(4),o=r(90),n=r(27),i=Object.defineProperty;t.f=r(9)?Object.defineProperty:function(e,t,r){if(s(e),t=n(t,!0),s(r),o)try{return i(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},function(e,t,r){var s=r(25);e.exports=function(e){return Object(s(e))}},function(e,t,r){var s=r(2),o=r(15),n=r(14),i=r(30)("src"),a=r(128),c=(""+a).split("toString");r(8).inspectSource=function(e){return a.call(e)},(e.exports=function(e,t,r,a){var u="function"==typeof r;u&&(n(r,"name")||o(r,"name",t)),e[t]!==r&&(u&&(n(r,i)||o(r,i,e[t]?""+e[t]:c.join(String(t)))),e===s?e[t]=r:a?e[t]?e[t]=r:o(e,t,r):(delete e[t],o(e,t,r)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[i]||a.call(this)})},function(e,t,r){var s=r(1),o=r(3),n=r(25),i=/"/g,a=function(e,t,r,s){var o=String(n(e)),a="<"+t;return""!==r&&(a+=" "+r+'="'+String(s).replace(i,"&quot;")+'"'),a+">"+o+"</"+t+">"};e.exports=function(e,t){var r={};r[e]=t(a),s(s.P+s.F*o(function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}),"String",r)}},function(e,t){var r={}.hasOwnProperty;e.exports=function(e,t){return r.call(e,t)}},function(e,t,r){var s=r(10),o=r(29);e.exports=r(9)?function(e,t,r){return s.f(e,t,o(1,r))}:function(e,t,r){return e[t]=r,e}},function(e,t,r){var s=r(45),o=r(25);e.exports=function(e){return s(o(e))}},function(e,t,r){"use strict";var s=r(3);e.exports=function(e,t){return!!e&&s(function(){t?e.call(null,function(){},1):e.call(null)})}},function(e,t,r){var s=r(19);e.exports=function(e,t,r){if(s(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,s){return e.call(t,r,s)};case 3:return function(r,s,o){return e.call(t,r,s,o)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){var r=Math.ceil,s=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?s:r)(e)}},function(e,t,r){var s=r(46),o=r(29),n=r(16),i=r(27),a=r(14),c=r(90),u=Object.getOwnPropertyDescriptor;t.f=r(9)?u:function(e,t){if(e=n(e),t=i(t,!0),c)try{return u(e,t)}catch(e){}if(a(e,t))return o(!s.f.call(e,t),e[t])}},function(e,t,r){var s=r(1),o=r(8),n=r(3);e.exports=function(e,t){var r=(o.Object||{})[e]||Object[e],i={};i[e]=t(r),s(s.S+s.F*n(function(){r(1)}),"Object",i)}},function(e,t,r){var s=r(18),o=r(45),n=r(11),i=r(7),a=r(106);e.exports=function(e,t){var r=1==e,c=2==e,u=3==e,l=4==e,d=6==e,h=5==e||d,y=t||a;return function(t,a,p){for(var f,g,b=n(t),m=o(b),_=s(a,p,3),v=i(m.length),w=0,R=r?y(t,v):c?y(t,0):void 0;v>w;w++)if((h||w in m)&&(g=_(f=m[w],w,b),e))if(r)R[w]=g;else if(g)switch(e){case 3:return!0;case 5:return f;case 6:return w;case 2:R.push(f)}else if(l)return!1;return d?-1:u||l?l:R}}},function(e,t){var r={}.toString;e.exports=function(e){return r.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,r){"use strict";if(r(9)){var s=r(31),o=r(2),n=r(3),i=r(1),a=r(60),c=r(85),u=r(18),l=r(43),d=r(29),h=r(15),y=r(44),p=r(20),f=r(7),g=r(117),b=r(33),m=r(27),_=r(14),v=r(47),w=r(5),R=r(11),O=r(77),S=r(34),P=r(36),L=r(35).f,M=r(79),j=r(30),U=r(6),x=r(23),C=r(50),k=r(48),I=r(81),D=r(41),A=r(53),E=r(42),T=r(80),H=r(108),N=r(10),F=r(21),B=N.f,K=F.f,G=o.RangeError,q=o.TypeError,V=o.Uint8Array,W=Array.prototype,J=c.ArrayBuffer,Y=c.DataView,z=x(0),$=x(2),Q=x(3),X=x(4),Z=x(5),ee=x(6),te=C(!0),re=C(!1),se=I.values,oe=I.keys,ne=I.entries,ie=W.lastIndexOf,ae=W.reduce,ce=W.reduceRight,ue=W.join,le=W.sort,de=W.slice,he=W.toString,ye=W.toLocaleString,pe=U("iterator"),fe=U("toStringTag"),ge=j("typed_constructor"),be=j("def_constructor"),me=a.CONSTR,_e=a.TYPED,ve=a.VIEW,we=x(1,function(e,t){return Le(k(e,e[be]),t)}),Re=n(function(){return 1===new V(new Uint16Array([1]).buffer)[0]}),Oe=!!V&&!!V.prototype.set&&n(function(){new V(1).set({})}),Se=function(e,t){var r=p(e);if(r<0||r%t)throw G("Wrong offset!");return r},Pe=function(e){if(w(e)&&_e in e)return e;throw q(e+" is not a typed array!")},Le=function(e,t){if(!(w(e)&&ge in e))throw q("It is not a typed array constructor!");return new e(t)},Me=function(e,t){return je(k(e,e[be]),t)},je=function(e,t){for(var r=0,s=t.length,o=Le(e,s);s>r;)o[r]=t[r++];return o},Ue=function(e,t,r){B(e,t,{get:function(){return this._d[r]}})},xe=function(e){var t,r,s,o,n,i,a=R(e),c=arguments.length,l=c>1?arguments[1]:void 0,d=void 0!==l,h=M(a);if(null!=h&&!O(h)){for(i=h.call(a),s=[],t=0;!(n=i.next()).done;t++)s.push(n.value);a=s}for(d&&c>2&&(l=u(l,arguments[2],2)),t=0,r=f(a.length),o=Le(this,r);r>t;t++)o[t]=d?l(a[t],t):a[t];return o},Ce=function(){for(var e=0,t=arguments.length,r=Le(this,t);t>e;)r[e]=arguments[e++];return r},ke=!!V&&n(function(){ye.call(new V(1))}),Ie=function(){return ye.apply(ke?de.call(Pe(this)):Pe(this),arguments)},De={copyWithin:function(e,t){return H.call(Pe(this),e,t,arguments.length>2?arguments[2]:void 0)},every:function(e){return X(Pe(this),e,arguments.length>1?arguments[1]:void 0)},fill:function(e){return T.apply(Pe(this),arguments)},filter:function(e){return Me(this,$(Pe(this),e,arguments.length>1?arguments[1]:void 0))},find:function(e){return Z(Pe(this),e,arguments.length>1?arguments[1]:void 0)},findIndex:function(e){return ee(Pe(this),e,arguments.length>1?arguments[1]:void 0)},forEach:function(e){z(Pe(this),e,arguments.length>1?arguments[1]:void 0)},indexOf:function(e){return re(Pe(this),e,arguments.length>1?arguments[1]:void 0)},includes:function(e){return te(Pe(this),e,arguments.length>1?arguments[1]:void 0)},join:function(e){return ue.apply(Pe(this),arguments)},lastIndexOf:function(e){return ie.apply(Pe(this),arguments)},map:function(e){return we(Pe(this),e,arguments.length>1?arguments[1]:void 0)},reduce:function(e){return ae.apply(Pe(this),arguments)},reduceRight:function(e){return ce.apply(Pe(this),arguments)},reverse:function(){for(var e,t=Pe(this).length,r=Math.floor(t/2),s=0;s<r;)e=this[s],this[s++]=this[--t],this[t]=e;return this},some:function(e){return Q(Pe(this),e,arguments.length>1?arguments[1]:void 0)},sort:function(e){return le.call(Pe(this),e)},subarray:function(e,t){var r=Pe(this),s=r.length,o=b(e,s);return new(k(r,r[be]))(r.buffer,r.byteOffset+o*r.BYTES_PER_ELEMENT,f((void 0===t?s:b(t,s))-o))}},Ae=function(e,t){return Me(this,de.call(Pe(this),e,t))},Ee=function(e){Pe(this);var t=Se(arguments[1],1),r=this.length,s=R(e),o=f(s.length),n=0;if(o+t>r)throw G("Wrong length!");for(;n<o;)this[t+n]=s[n++]},Te={entries:function(){return ne.call(Pe(this))},keys:function(){return oe.call(Pe(this))},values:function(){return se.call(Pe(this))}},He=function(e,t){return w(e)&&e[_e]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},Ne=function(e,t){return He(e,t=m(t,!0))?d(2,e[t]):K(e,t)},Fe=function(e,t,r){return!(He(e,t=m(t,!0))&&w(r)&&_(r,"value"))||_(r,"get")||_(r,"set")||r.configurable||_(r,"writable")&&!r.writable||_(r,"enumerable")&&!r.enumerable?B(e,t,r):(e[t]=r.value,e)};me||(F.f=Ne,N.f=Fe),i(i.S+i.F*!me,"Object",{getOwnPropertyDescriptor:Ne,defineProperty:Fe}),n(function(){he.call({})})&&(he=ye=function(){return ue.call(this)});var Be=y({},De);y(Be,Te),h(Be,pe,Te.values),y(Be,{slice:Ae,set:Ee,constructor:function(){},toString:he,toLocaleString:Ie}),Ue(Be,"buffer","b"),Ue(Be,"byteOffset","o"),Ue(Be,"byteLength","l"),Ue(Be,"length","e"),B(Be,fe,{get:function(){return this[_e]}}),e.exports=function(e,t,r,c){var u=e+((c=!!c)?"Clamped":"")+"Array",d="get"+e,y="set"+e,p=o[u],b=p||{},m=p&&P(p),_=!p||!a.ABV,R={},O=p&&p.prototype,M=function(e,r){B(e,r,{get:function(){return function(e,r){var s=e._d;return s.v[d](r*t+s.o,Re)}(this,r)},set:function(e){return function(e,r,s){var o=e._d;c&&(s=(s=Math.round(s))<0?0:s>255?255:255&s),o.v[y](r*t+o.o,s,Re)}(this,r,e)},enumerable:!0})};_?(p=r(function(e,r,s,o){l(e,p,u,"_d");var n,i,a,c,d=0,y=0;if(w(r)){if(!(r instanceof J||"ArrayBuffer"==(c=v(r))||"SharedArrayBuffer"==c))return _e in r?je(p,r):xe.call(p,r);n=r,y=Se(s,t);var b=r.byteLength;if(void 0===o){if(b%t)throw G("Wrong length!");if((i=b-y)<0)throw G("Wrong length!")}else if((i=f(o)*t)+y>b)throw G("Wrong length!");a=i/t}else a=g(r),n=new J(i=a*t);for(h(e,"_d",{b:n,o:y,l:i,e:a,v:new Y(n)});d<a;)M(e,d++)}),O=p.prototype=S(Be),h(O,"constructor",p)):n(function(){p(1)})&&n(function(){new p(-1)})&&A(function(e){new p,new p(null),new p(1.5),new p(e)},!0)||(p=r(function(e,r,s,o){var n;return l(e,p,u),w(r)?r instanceof J||"ArrayBuffer"==(n=v(r))||"SharedArrayBuffer"==n?void 0!==o?new b(r,Se(s,t),o):void 0!==s?new b(r,Se(s,t)):new b(r):_e in r?je(p,r):xe.call(p,r):new b(g(r))}),z(m!==Function.prototype?L(b).concat(L(m)):L(b),function(e){e in p||h(p,e,b[e])}),p.prototype=O,s||(O.constructor=p));var j=O[pe],U=!!j&&("values"==j.name||null==j.name),x=Te.values;h(p,ge,!0),h(O,_e,u),h(O,ve,!0),h(O,be,p),(c?new p(1)[fe]==u:fe in O)||B(O,fe,{get:function(){return u}}),R[u]=p,i(i.G+i.W+i.F*(p!=b),R),i(i.S,u,{BYTES_PER_ELEMENT:t}),i(i.S+i.F*n(function(){b.of.call(p,1)}),u,{from:xe,of:Ce}),"BYTES_PER_ELEMENT"in O||h(O,"BYTES_PER_ELEMENT",t),i(i.P,u,De),E(u),i(i.P+i.F*Oe,u,{set:Ee}),i(i.P+i.F*!U,u,Te),s||O.toString==he||(O.toString=he),i(i.P+i.F*n(function(){new p(1).slice()}),u,{slice:Ae}),i(i.P+i.F*(n(function(){return[1,2].toLocaleString()!=new p([1,2]).toLocaleString()})||!n(function(){O.toLocaleString.call([1,2])})),u,{toLocaleString:Ie}),D[u]=U?j:x,s||U||h(O,pe,x)}}else e.exports=function(){}},function(e,t,r){var s=r(5);e.exports=function(e,t){if(!s(e))return e;var r,o;if(t&&"function"==typeof(r=e.toString)&&!s(o=r.call(e)))return o;if("function"==typeof(r=e.valueOf)&&!s(o=r.call(e)))return o;if(!t&&"function"==typeof(r=e.toString)&&!s(o=r.call(e)))return o;throw TypeError("Can't convert object to primitive value")}},function(e,t,r){var s=r(30)("meta"),o=r(5),n=r(14),i=r(10).f,a=0,c=Object.isExtensible||function(){return!0},u=!r(3)(function(){return c(Object.preventExtensions({}))}),l=function(e){i(e,s,{value:{i:"O"+ ++a,w:{}}})},d=e.exports={KEY:s,NEED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!n(e,s)){if(!c(e))return"F";if(!t)return"E";l(e)}return e[s].i},getWeak:function(e,t){if(!n(e,s)){if(!c(e))return!0;if(!t)return!1;l(e)}return e[s].w},onFreeze:function(e){return u&&d.NEED&&c(e)&&!n(e,s)&&l(e),e}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){var r=0,s=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++r+s).toString(36))}},function(e,t){e.exports=!1},function(e,t,r){var s=r(92),o=r(64);e.exports=Object.keys||function(e){return s(e,o)}},function(e,t,r){var s=r(20),o=Math.max,n=Math.min;e.exports=function(e,t){return(e=s(e))<0?o(e+t,0):n(e,t)}},function(e,t,r){var s=r(4),o=r(93),n=r(64),i=r(63)("IE_PROTO"),a=function(){},c=function(){var e,t=r(61)("iframe"),s=n.length;for(t.style.display="none",r(65).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),c=e.F;s--;)delete c.prototype[n[s]];return c()};e.exports=Object.create||function(e,t){var r;return null!==e?(a.prototype=s(e),r=new a,a.prototype=null,r[i]=e):r=c(),void 0===t?r:o(r,t)}},function(e,t,r){var s=r(92),o=r(64).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return s(e,o)}},function(e,t,r){var s=r(14),o=r(11),n=r(63)("IE_PROTO"),i=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=o(e),s(e,n)?e[n]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?i:null}},function(e,t,r){var s=r(6)("unscopables"),o=Array.prototype;null==o[s]&&r(15)(o,s,{}),e.exports=function(e){o[s][e]=!0}},function(e,t,r){var s=r(5);e.exports=function(e,t){if(!s(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e}},function(e,t,r){var s=r(10).f,o=r(14),n=r(6)("toStringTag");e.exports=function(e,t,r){e&&!o(e=r?e:e.prototype,n)&&s(e,n,{configurable:!0,value:t})}},function(e,t,r){var s=r(1),o=r(25),n=r(3),i=r(67),a="["+i+"]",c=RegExp("^"+a+a+"*"),u=RegExp(a+a+"*$"),l=function(e,t,r){var o={},a=n(function(){return!!i[e]()||"​"!="​"[e]()}),c=o[e]=a?t(d):i[e];r&&(o[r]=c),s(s.P+s.F*a,"String",o)},d=l.trim=function(e,t){return e=String(o(e)),1&t&&(e=e.replace(c,"")),2&t&&(e=e.replace(u,"")),e};e.exports=l},function(e,t){e.exports={}},function(e,t,r){"use strict";var s=r(2),o=r(10),n=r(9),i=r(6)("species");e.exports=function(e){var t=s[e];n&&t&&!t[i]&&o.f(t,i,{configurable:!0,get:function(){return this}})}},function(e,t){e.exports=function(e,t,r,s){if(!(e instanceof t)||void 0!==s&&s in e)throw TypeError(r+": incorrect invocation!");return e}},function(e,t,r){var s=r(12);e.exports=function(e,t,r){for(var o in t)s(e,o,t[o],r);return e}},function(e,t,r){var s=r(24);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==s(e)?e.split(""):Object(e)}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,r){var s=r(24),o=r(6)("toStringTag"),n="Arguments"==s(function(){return arguments}());e.exports=function(e){var t,r,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),o))?r:n?s(t):"Object"==(i=s(t))&&"function"==typeof t.callee?"Arguments":i}},function(e,t,r){var s=r(4),o=r(19),n=r(6)("species");e.exports=function(e,t){var r,i=s(e).constructor;return void 0===i||null==(r=s(i)[n])?t:o(r)}},function(e,t,r){var s=r(8),o=r(2),n=o["__core-js_shared__"]||(o["__core-js_shared__"]={});(e.exports=function(e,t){return n[e]||(n[e]=void 0!==t?t:{})})("versions",[]).push({version:s.version,mode:r(31)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(e,t,r){var s=r(16),o=r(7),n=r(33);e.exports=function(e){return function(t,r,i){var a,c=s(t),u=o(c.length),l=n(i,u);if(e&&r!=r){for(;u>l;)if((a=c[l++])!=a)return!0}else for(;u>l;l++)if((e||l in c)&&c[l]===r)return e||l||0;return!e&&-1}}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,r){var s=r(24);e.exports=Array.isArray||function(e){return"Array"==s(e)}},function(e,t,r){var s=r(6)("iterator"),o=!1;try{var n=[7][s]();n.return=function(){o=!0},Array.from(n,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!o)return!1;var r=!1;try{var n=[7],i=n[s]();i.next=function(){return{done:r=!0}},n[s]=function(){return i},e(n)}catch(e){}return r}},function(e,t,r){"use strict";var s=r(4);e.exports=function(){var e=s(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,r){"use strict";var s=r(47),o=RegExp.prototype.exec;e.exports=function(e,t){var r=e.exec;if("function"==typeof r){var n=r.call(e,t);if("object"!=typeof n)throw new TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==s(e))throw new TypeError("RegExp#exec called on incompatible receiver");return o.call(e,t)}},function(e,t,r){"use strict";r(110);var s=r(12),o=r(15),n=r(3),i=r(25),a=r(6),c=r(82),u=a("species"),l=!n(function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}),d=function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var r="ab".split(e);return 2===r.length&&"a"===r[0]&&"b"===r[1]}();e.exports=function(e,t,r){var h=a(e),y=!n(function(){var t={};return t[h]=function(){return 7},7!=""[e](t)}),p=y?!n(function(){var t=!1,r=/a/;return r.exec=function(){return t=!0,null},"split"===e&&(r.constructor={},r.constructor[u]=function(){return r}),r[h](""),!t}):void 0;if(!y||!p||"replace"===e&&!l||"split"===e&&!d){var f=/./[h],g=r(i,h,""[e],function(e,t,r,s,o){return t.exec===c?y&&!o?{done:!0,value:f.call(t,r,s)}:{done:!0,value:e.call(r,t,s)}:{done:!1}}),b=g[0],m=g[1];s(String.prototype,e,b),o(RegExp.prototype,h,2==t?function(e,t){return m.call(e,this,t)}:function(e){return m.call(e,this)})}}},function(e,t,r){var s=r(18),o=r(105),n=r(77),i=r(4),a=r(7),c=r(79),u={},l={};(t=e.exports=function(e,t,r,d,h){var y,p,f,g,b=h?function(){return e}:c(e),m=s(r,d,t?2:1),_=0;if("function"!=typeof b)throw TypeError(e+" is not iterable!");if(n(b)){for(y=a(e.length);y>_;_++)if((g=t?m(i(p=e[_])[0],p[1]):m(e[_]))===u||g===l)return g}else for(f=b.call(e);!(p=f.next()).done;)if((g=o(f,m,p.value,t))===u||g===l)return g}).BREAK=u,t.RETURN=l},function(e,t,r){var s=r(2).navigator;e.exports=s&&s.userAgent||""},function(e,t,r){"use strict";var s=r(2),o=r(1),n=r(12),i=r(44),a=r(28),c=r(57),u=r(43),l=r(5),d=r(3),h=r(53),y=r(39),p=r(68);e.exports=function(e,t,r,f,g,b){var m=s[e],_=m,v=g?"set":"add",w=_&&_.prototype,R={},O=function(e){var t=w[e];n(w,e,"delete"==e?function(e){return!(b&&!l(e))&&t.call(this,0===e?0:e)}:"has"==e?function(e){return!(b&&!l(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return b&&!l(e)?void 0:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,r){return t.call(this,0===e?0:e,r),this})};if("function"==typeof _&&(b||w.forEach&&!d(function(){(new _).entries().next()}))){var S=new _,P=S[v](b?{}:-0,1)!=S,L=d(function(){S.has(1)}),M=h(function(e){new _(e)}),j=!b&&d(function(){for(var e=new _,t=5;t--;)e[v](t,t);return!e.has(-0)});M||((_=t(function(t,r){u(t,_,e);var s=p(new m,t,_);return null!=r&&c(r,g,s[v],s),s})).prototype=w,w.constructor=_),(L||j)&&(O("delete"),O("has"),g&&O("get")),(j||P)&&O(v),b&&w.clear&&delete w.clear}else _=f.getConstructor(t,e,g,v),i(_.prototype,r),a.NEED=!0;return y(_,e),R[e]=_,o(o.G+o.W+o.F*(_!=m),R),b||f.setStrong(_,e,g),_}},function(e,t,r){for(var s,o=r(2),n=r(15),i=r(30),a=i("typed_array"),c=i("view"),u=!(!o.ArrayBuffer||!o.DataView),l=u,d=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");d<9;)(s=o[h[d++]])?(n(s.prototype,a,!0),n(s.prototype,c,!0)):l=!1;e.exports={ABV:u,CONSTR:l,TYPED:a,VIEW:c}},function(e,t,r){var s=r(5),o=r(2).document,n=s(o)&&s(o.createElement);e.exports=function(e){return n?o.createElement(e):{}}},function(e,t,r){t.f=r(6)},function(e,t,r){var s=r(49)("keys"),o=r(30);e.exports=function(e){return s[e]||(s[e]=o(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,r){var s=r(2).document;e.exports=s&&s.documentElement},function(e,t,r){var s=r(5),o=r(4),n=function(e,t){if(o(e),!s(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,s){try{(s=r(18)(Function.call,r(21).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,r){return n(e,r),t?e.__proto__=r:s(e,r),e}}({},!1):void 0),check:n}},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,r){var s=r(5),o=r(66).set;e.exports=function(e,t,r){var n,i=t.constructor;return i!==r&&"function"==typeof i&&(n=i.prototype)!==r.prototype&&s(n)&&o&&o(e,n),e}},function(e,t,r){"use strict";var s=r(20),o=r(25);e.exports=function(e){var t=String(o(this)),r="",n=s(e);if(n<0||n==1/0)throw RangeError("Count can't be negative");for(;n>0;(n>>>=1)&&(t+=t))1&n&&(r+=t);return r}},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t){var r=Math.expm1;e.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:r},function(e,t,r){var s=r(20),o=r(25);e.exports=function(e){return function(t,r){var n,i,a=String(o(t)),c=s(r),u=a.length;return c<0||c>=u?e?"":void 0:(n=a.charCodeAt(c))<55296||n>56319||c+1===u||(i=a.charCodeAt(c+1))<56320||i>57343?e?a.charAt(c):n:e?a.slice(c,c+2):i-56320+(n-55296<<10)+65536}}},function(e,t,r){"use strict";var s=r(31),o=r(1),n=r(12),i=r(15),a=r(41),c=r(104),u=r(39),l=r(36),d=r(6)("iterator"),h=!([].keys&&"next"in[].keys()),y=function(){return this};e.exports=function(e,t,r,p,f,g,b){c(r,t,p);var m,_,v,w=function(e){if(!h&&e in P)return P[e];switch(e){case"keys":case"values":return function(){return new r(this,e)}}return function(){return new r(this,e)}},R=t+" Iterator",O="values"==f,S=!1,P=e.prototype,L=P[d]||P["@@iterator"]||f&&P[f],M=L||w(f),j=f?O?w("entries"):M:void 0,U="Array"==t&&P.entries||L;if(U&&(v=l(U.call(new e)))!==Object.prototype&&v.next&&(u(v,R,!0),s||"function"==typeof v[d]||i(v,d,y)),O&&L&&"values"!==L.name&&(S=!0,M=function(){return L.call(this)}),s&&!b||!h&&!S&&P[d]||i(P,d,M),a[t]=M,a[R]=y,f)if(m={values:O?M:w("values"),keys:g?M:w("keys"),entries:j},b)for(_ in m)_ in P||n(P,_,m[_]);else o(o.P+o.F*(h||S),t,m);return m}},function(e,t,r){var s=r(75),o=r(25);e.exports=function(e,t,r){if(s(t))throw TypeError("String#"+r+" doesn't accept regex!");return String(o(e))}},function(e,t,r){var s=r(5),o=r(24),n=r(6)("match");e.exports=function(e){var t;return s(e)&&(void 0!==(t=e[n])?!!t:"RegExp"==o(e))}},function(e,t,r){var s=r(6)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[s]=!1,!"/./"[e](t)}catch(e){}}return!0}},function(e,t,r){var s=r(41),o=r(6)("iterator"),n=Array.prototype;e.exports=function(e){return void 0!==e&&(s.Array===e||n[o]===e)}},function(e,t,r){"use strict";var s=r(10),o=r(29);e.exports=function(e,t,r){t in e?s.f(e,t,o(0,r)):e[t]=r}},function(e,t,r){var s=r(47),o=r(6)("iterator"),n=r(41);e.exports=r(8).getIteratorMethod=function(e){if(null!=e)return e[o]||e["@@iterator"]||n[s(e)]}},function(e,t,r){"use strict";var s=r(11),o=r(33),n=r(7);e.exports=function(e){for(var t=s(this),r=n(t.length),i=arguments.length,a=o(i>1?arguments[1]:void 0,r),c=i>2?arguments[2]:void 0,u=void 0===c?r:o(c,r);u>a;)t[a++]=e;return t}},function(e,t,r){"use strict";var s=r(37),o=r(109),n=r(41),i=r(16);e.exports=r(73)(Array,"Array",function(e,t){this._t=i(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=void 0,o(1)):o(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])},"values"),n.Arguments=n.Array,s("keys"),s("values"),s("entries")},function(e,t,r){"use strict";var s=r(54),o=RegExp.prototype.exec,n=String.prototype.replace,i=o,a=function(){var e=/a/,t=/b*/g;return o.call(e,"a"),o.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),c=void 0!==/()??/.exec("")[1];(a||c)&&(i=function(e){var t,r,i,u,l=this;return c&&(r=new RegExp("^"+l.source+"$(?!\\s)",s.call(l))),a&&(t=l.lastIndex),i=o.call(l,e),a&&i&&(l.lastIndex=l.global?i.index+i[0].length:t),c&&i&&i.length>1&&n.call(i[0],r,function(){for(u=1;u<arguments.length-2;u++)void 0===arguments[u]&&(i[u]=void 0)}),i}),e.exports=i},function(e,t,r){"use strict";var s=r(72)(!0);e.exports=function(e,t,r){return t+(r?s(e,t).length:1)}},function(e,t,r){var s,o,n,i=r(18),a=r(98),c=r(65),u=r(61),l=r(2),d=l.process,h=l.setImmediate,y=l.clearImmediate,p=l.MessageChannel,f=l.Dispatch,g=0,b={},m=function(){var e=+this;if(b.hasOwnProperty(e)){var t=b[e];delete b[e],t()}},_=function(e){m.call(e.data)};h&&y||(h=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return b[++g]=function(){a("function"==typeof e?e:Function(e),t)},s(g),g},y=function(e){delete b[e]},"process"==r(24)(d)?s=function(e){d.nextTick(i(m,e,1))}:f&&f.now?s=function(e){f.now(i(m,e,1))}:p?(n=(o=new p).port2,o.port1.onmessage=_,s=i(n.postMessage,n,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(s=function(e){l.postMessage(e+"","*")},l.addEventListener("message",_,!1)):s="onreadystatechange"in u("script")?function(e){c.appendChild(u("script")).onreadystatechange=function(){c.removeChild(this),m.call(e)}}:function(e){setTimeout(i(m,e,1),0)}),e.exports={set:h,clear:y}},function(e,t,r){"use strict";var s=r(2),o=r(9),n=r(31),i=r(60),a=r(15),c=r(44),u=r(3),l=r(43),d=r(20),h=r(7),y=r(117),p=r(35).f,f=r(10).f,g=r(80),b=r(39),m="prototype",_="Wrong index!",v=s.ArrayBuffer,w=s.DataView,R=s.Math,O=s.RangeError,S=s.Infinity,P=v,L=R.abs,M=R.pow,j=R.floor,U=R.log,x=R.LN2,C=o?"_b":"buffer",k=o?"_l":"byteLength",I=o?"_o":"byteOffset";function D(e,t,r){var s,o,n,i=new Array(r),a=8*r-t-1,c=(1<<a)-1,u=c>>1,l=23===t?M(2,-24)-M(2,-77):0,d=0,h=e<0||0===e&&1/e<0?1:0;for((e=L(e))!=e||e===S?(o=e!=e?1:0,s=c):(s=j(U(e)/x),e*(n=M(2,-s))<1&&(s--,n*=2),(e+=s+u>=1?l/n:l*M(2,1-u))*n>=2&&(s++,n/=2),s+u>=c?(o=0,s=c):s+u>=1?(o=(e*n-1)*M(2,t),s+=u):(o=e*M(2,u-1)*M(2,t),s=0));t>=8;i[d++]=255&o,o/=256,t-=8);for(s=s<<t|o,a+=t;a>0;i[d++]=255&s,s/=256,a-=8);return i[--d]|=128*h,i}function A(e,t,r){var s,o=8*r-t-1,n=(1<<o)-1,i=n>>1,a=o-7,c=r-1,u=e[c--],l=127&u;for(u>>=7;a>0;l=256*l+e[c],c--,a-=8);for(s=l&(1<<-a)-1,l>>=-a,a+=t;a>0;s=256*s+e[c],c--,a-=8);if(0===l)l=1-i;else{if(l===n)return s?NaN:u?-S:S;s+=M(2,t),l-=i}return(u?-1:1)*s*M(2,l-t)}function E(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]}function T(e){return[255&e]}function H(e){return[255&e,e>>8&255]}function N(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function F(e){return D(e,52,8)}function B(e){return D(e,23,4)}function K(e,t,r){f(e[m],t,{get:function(){return this[r]}})}function G(e,t,r,s){var o=y(+r);if(o+t>e[k])throw O(_);var n=e[C]._b,i=o+e[I],a=n.slice(i,i+t);return s?a:a.reverse()}function q(e,t,r,s,o,n){var i=y(+r);if(i+t>e[k])throw O(_);for(var a=e[C]._b,c=i+e[I],u=s(+o),l=0;l<t;l++)a[c+l]=u[n?l:t-l-1]}if(i.ABV){if(!u(function(){v(1)})||!u(function(){new v(-1)})||u(function(){return new v,new v(1.5),new v(NaN),"ArrayBuffer"!=v.name})){for(var V,W=(v=function(e){return l(this,v),new P(y(e))})[m]=P[m],J=p(P),Y=0;J.length>Y;)(V=J[Y++])in v||a(v,V,P[V]);n||(W.constructor=v)}var z=new w(new v(2)),$=w[m].setInt8;z.setInt8(0,2147483648),z.setInt8(1,2147483649),!z.getInt8(0)&&z.getInt8(1)||c(w[m],{setInt8:function(e,t){$.call(this,e,t<<24>>24)},setUint8:function(e,t){$.call(this,e,t<<24>>24)}},!0)}else v=function(e){l(this,v,"ArrayBuffer");var t=y(e);this._b=g.call(new Array(t),0),this[k]=t},w=function(e,t,r){l(this,w,"DataView"),l(e,v,"DataView");var s=e[k],o=d(t);if(o<0||o>s)throw O("Wrong offset!");if(o+(r=void 0===r?s-o:h(r))>s)throw O("Wrong length!");this[C]=e,this[I]=o,this[k]=r},o&&(K(v,"byteLength","_l"),K(w,"buffer","_b"),K(w,"byteLength","_l"),K(w,"byteOffset","_o")),c(w[m],{getInt8:function(e){return G(this,1,e)[0]<<24>>24},getUint8:function(e){return G(this,1,e)[0]},getInt16:function(e){var t=G(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=G(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return E(G(this,4,e,arguments[1]))},getUint32:function(e){return E(G(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return A(G(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return A(G(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){q(this,1,e,T,t)},setUint8:function(e,t){q(this,1,e,T,t)},setInt16:function(e,t){q(this,2,e,H,t,arguments[2])},setUint16:function(e,t){q(this,2,e,H,t,arguments[2])},setInt32:function(e,t){q(this,4,e,N,t,arguments[2])},setUint32:function(e,t){q(this,4,e,N,t,arguments[2])},setFloat32:function(e,t){q(this,4,e,B,t,arguments[2])},setFloat64:function(e,t){q(this,8,e,F,t,arguments[2])}});b(v,"ArrayBuffer"),b(w,"DataView"),a(w[m],i.VIEW,!0),t.ArrayBuffer=v,t.DataView=w},function(e,t){var r=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,r){e.exports=!r(122)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){!function(){"use strict";if(!Object.observe&&"function"==typeof Proxy){function e(e,t,r,s,o,n){var i,a=this;function c(e,s){if(c.delay=s,!c.pause&&a.changeset.length>0){if(!e){var o=a.changeset.filter(function(e){return!r||r.indexOf(e.type)>=0});o.length>0&&t(o)}a.changeset=[]}}return c.pause=o,c.delay=n,a.get=function(e,t){return"__observer__"===t?a:"unobserve"===t?function(){return Object.unobserve(e),e}:"deliver"===t?c:e[t]},a.target=e,a.changeset=[],a.target.__observerCallbacks__||(Object.defineProperty(e,"__observerCallbacks__",{enumerable:!1,configurable:!0,writable:!1,value:[]}),Object.defineProperty(e,"__observers__",{enumerable:!1,configurable:!0,writable:!1,value:[]})),a.target.__observerCallbacks__.push(t),a.target.__observers__.push(this),i=new Proxy(e,a),c(!1,n),i}e.prototype.deliver=function(){return this.get(null,"deliver")},e.prototype.set=function(e,t,r){var s=e[t],o=void 0===s?"add":"update";if(e[t]=r,e.__observers__.indexOf(this)>=0&&(!this.acceptlist||this.acceptlist.indexOf(o)>=0)){var n={object:e,name:t,type:o},i=0===this.changeset.length,a=this.deliver();"update"===o&&(n.oldValue=s),this.changeset.push(n),i&&a(!1,"number"==typeof a.delay?a.delay:10)}return!0},e.prototype.deleteProperty=function(e,t){var r=e[t];if(delete e[t],e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("delete")>=0){var s={object:e,name:t,type:"delete",oldValue:r},o=0===this.changeset.length,n=this.deliver();this.changeset.push(s),o&&n(!1,"number"==typeof n.delay?n.delay:10)}return!0},e.prototype.defineProperty=function(e,t,r){if(Object.defineProperty(e,t,r),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("reconfigure")>=0){var s={object:e,name:t,type:"reconfigure"},o=0===this.changeset.length,n=this.deliver();this.changeset.push(s),o&&n(!1,"number"==typeof n.delay?n.delay:10)}return!0},e.prototype.setPrototypeOf=function(e,t){var r=Object.getPrototypeOf(e);if(Object.setPrototypeOf(e,t),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("setPrototype")>=0){var s={object:e,name:"__proto__",type:"setPrototype",oldValue:r},o=0===this.changeset.length,n=this.deliver();this.changeset.push(s),o&&n(!1,"number"==typeof n.delay?n.delay:10)}return!0},e.prototype.preventExtensions=function(e){if(Object.preventExtensions(e),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("preventExtensions")>=0){var t={object:e,type:"preventExtensions"},r=0===this.changeset.length,s=this.deliver();this.changeset.push(t),r&&s(!1,"number"==typeof s.delay?s.delay:10)}return!0},Object.observe=function(t,r,s,o,n,i){return new e(t,r,s,o,n,i)},Object.unobserve=function(e,t){if(e.__observerCallbacks__){if(!t)return e.__observerCallbacks__.splice(0,e.__observerCallbacks__.length),void e.__observers__.splice(0,e.__observers__.length);e.__observerCallbacks__.forEach(function(r,s){t===r&&(e.__observerCallbacks__.splice(s,1),delete e.__observers__[s].callback,e.__observers__.splice(s,1))})}},Array.observe=function(e,t,r,s,o,n){if(!(e instanceof Array||Array.isArray(e)))throw new TypeError("First argument to Array.observer is not an Array");r=r||["add","update","delete","splice"];var i=new Proxy(e,{get:function(t,s){return"unobserve"===s?function(e){return e?Object.unobserve(t,e):t.unobserve()}:"splice"===s?function(s,o){if("number"!=typeof s||"number"!=typeof o)throw new TypeError("First two arguments to Array splice are not number, number");var n=this.slice(s,s+o),i=arguments.length>1?arguments.length-2:0,c={object:e,type:"splice",index:s,removed:n,addedCount:i};if(t.splice.apply(t,arguments),r.indexOf("splice")>=0){s=0===a.__observer__.changeset.length;var u=a.__observer__.deliver();a.__observer__.changeset.push(c),s&&u(!1,"number"==typeof u.delay?u.delay:10)}}:"push"===s?function(e){return this.splice(this.length,0,e)}:"pop"===s?function(){return this.splice(this.length-1,1)}:"unshift"===s?function(e){return this.splice(0,0,e)}:"shift"===s?function(){return this.splice(0,1)}:t[s]}}),a=Object.observe(i,function(e){var s=e.filter(function(e){return"length"!==e.name&&"add"!==e.name&&(!r||r.indexOf(e.type)>=0)});s.length>0&&t(s)},r,s,o,n);return a},Array.unobserve=function(e,t){return e.unobserve(t)}}Object.deepObserve=function(e,t,r){var s=function(e){return{}.toString.call(e).match(/\s([a-zA-Z]+)/)[1].toLowerCase()};function o(e,r){Object.keys(e).forEach(function(o){if(("object"===s(e[o])||"array"===s(e[o]))&&!e[o].hasOwnProperty("__observers__")){var n=r.slice(0);n.push(o),e[o]=Object.deepObserve(e[o],t,n)}})}return o(e,r=r||[]),Object.observe(e,function(e){var s=[];e.forEach(function(e){var t=(r.length>0?r.join(".")+".":"")+e.name;"update"!==e.type&&"add"!==e.type||o(e.object,r),s.push({name:e.name,object:e.object,type:e.type,oldValue:e.oldValue,newValue:e.object[e.name],keypath:t}),function e(t,r,o,n,i){n instanceof Object?Object.keys(n).forEach(function(a){if(!o||o[a]!==n[a]){var c=o&&void 0!==o[a]?o[a]:void 0,u=void 0===c?"add":"update",l=i+"."+a;s.push({name:t,object:r,type:u,oldValue:c,newValue:n[a],keypath:l}),e(t,r,c,n[a],l)}}):o instanceof Object&&Object.keys(o).forEach(function(a){var c=null===n?"update":"delete",u=i+"."+a;s.push({name:t,object:r,type:c,oldValue:o[a],newValue:n,keypath:u}),e(t,r,o[a],void 0,u)})}(e.name,e.object,e.oldValue,e.object[e.name],t)}),t(s)})}}()},function(e,t,r){e.exports=!r(9)&&!r(3)(function(){return 7!=Object.defineProperty(r(61)("div"),"a",{get:function(){return 7}}).a})},function(e,t,r){var s=r(2),o=r(8),n=r(31),i=r(62),a=r(10).f;e.exports=function(e){var t=o.Symbol||(o.Symbol=n?{}:s.Symbol||{});"_"==e.charAt(0)||e in t||a(t,e,{value:i.f(e)})}},function(e,t,r){var s=r(14),o=r(16),n=r(50)(!1),i=r(63)("IE_PROTO");e.exports=function(e,t){var r,a=o(e),c=0,u=[];for(r in a)r!=i&&s(a,r)&&u.push(r);for(;t.length>c;)s(a,r=t[c++])&&(~n(u,r)||u.push(r));return u}},function(e,t,r){var s=r(10),o=r(4),n=r(32);e.exports=r(9)?Object.defineProperties:function(e,t){o(e);for(var r,i=n(t),a=i.length,c=0;a>c;)s.f(e,r=i[c++],t[r]);return e}},function(e,t,r){var s=r(16),o=r(35).f,n={}.toString,i="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return i&&"[object Window]"==n.call(e)?function(e){try{return o(e)}catch(e){return i.slice()}}(e):o(s(e))}},function(e,t,r){"use strict";var s=r(9),o=r(32),n=r(51),i=r(46),a=r(11),c=r(45),u=Object.assign;e.exports=!u||r(3)(function(){var e={},t={},r=Symbol(),s="abcdefghijklmnopqrst";return e[r]=7,s.split("").forEach(function(e){t[e]=e}),7!=u({},e)[r]||Object.keys(u({},t)).join("")!=s})?function(e,t){for(var r=a(e),u=arguments.length,l=1,d=n.f,h=i.f;u>l;)for(var y,p=c(arguments[l++]),f=d?o(p).concat(d(p)):o(p),g=f.length,b=0;g>b;)y=f[b++],s&&!h.call(p,y)||(r[y]=p[y]);return r}:u},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,r){"use strict";var s=r(19),o=r(5),n=r(98),i=[].slice,a={};e.exports=Function.bind||function(e){var t=s(this),r=i.call(arguments,1),c=function(){var s=r.concat(i.call(arguments));return this instanceof c?function(e,t,r){if(!(t in a)){for(var s=[],o=0;o<t;o++)s[o]="a["+o+"]";a[t]=Function("F,a","return new F("+s.join(",")+")")}return a[t](e,r)}(t,s.length,s):n(t,s,e)};return o(t.prototype)&&(c.prototype=t.prototype),c}},function(e,t){e.exports=function(e,t,r){var s=void 0===r;switch(t.length){case 0:return s?e():e.call(r);case 1:return s?e(t[0]):e.call(r,t[0]);case 2:return s?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return s?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return s?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},function(e,t,r){var s=r(2).parseInt,o=r(40).trim,n=r(67),i=/^[-+]?0[xX]/;e.exports=8!==s(n+"08")||22!==s(n+"0x16")?function(e,t){var r=o(String(e),3);return s(r,t>>>0||(i.test(r)?16:10))}:s},function(e,t,r){var s=r(2).parseFloat,o=r(40).trim;e.exports=1/s(r(67)+"-0")!=-1/0?function(e){var t=o(String(e),3),r=s(t);return 0===r&&"-"==t.charAt(0)?-0:r}:s},function(e,t,r){var s=r(24);e.exports=function(e,t){if("number"!=typeof e&&"Number"!=s(e))throw TypeError(t);return+e}},function(e,t,r){var s=r(5),o=Math.floor;e.exports=function(e){return!s(e)&&isFinite(e)&&o(e)===e}},function(e,t){e.exports=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)}},function(e,t,r){"use strict";var s=r(34),o=r(29),n=r(39),i={};r(15)(i,r(6)("iterator"),function(){return this}),e.exports=function(e,t,r){e.prototype=s(i,{next:o(1,r)}),n(e,t+" Iterator")}},function(e,t,r){var s=r(4);e.exports=function(e,t,r,o){try{return o?t(s(r)[0],r[1]):t(r)}catch(t){var n=e.return;throw void 0!==n&&s(n.call(e)),t}}},function(e,t,r){var s=r(218);e.exports=function(e,t){return new(s(e))(t)}},function(e,t,r){var s=r(19),o=r(11),n=r(45),i=r(7);e.exports=function(e,t,r,a,c){s(t);var u=o(e),l=n(u),d=i(u.length),h=c?d-1:0,y=c?-1:1;if(r<2)for(;;){if(h in l){a=l[h],h+=y;break}if(h+=y,c?h<0:d<=h)throw TypeError("Reduce of empty array with no initial value")}for(;c?h>=0:d>h;h+=y)h in l&&(a=t(a,l[h],h,u));return a}},function(e,t,r){"use strict";var s=r(11),o=r(33),n=r(7);e.exports=[].copyWithin||function(e,t){var r=s(this),i=n(r.length),a=o(e,i),c=o(t,i),u=arguments.length>2?arguments[2]:void 0,l=Math.min((void 0===u?i:o(u,i))-c,i-a),d=1;for(c<a&&a<c+l&&(d=-1,c+=l-1,a+=l-1);l-- >0;)c in r?r[a]=r[c]:delete r[a],a+=d,c+=d;return r}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,r){"use strict";var s=r(82);r(1)({target:"RegExp",proto:!0,forced:s!==/./.exec},{exec:s})},function(e,t,r){r(9)&&"g"!=/./g.flags&&r(10).f(RegExp.prototype,"flags",{configurable:!0,get:r(54)})},function(e,t,r){"use strict";var s,o,n,i,a=r(31),c=r(2),u=r(18),l=r(47),d=r(1),h=r(5),y=r(19),p=r(43),f=r(57),g=r(48),b=r(84).set,m=r(238)(),_=r(113),v=r(239),w=r(58),R=r(114),O=c.TypeError,S=c.process,P=S&&S.versions,L=P&&P.v8||"",M=c.Promise,j="process"==l(S),U=function(){},x=o=_.f,C=!!function(){try{var e=M.resolve(1),t=(e.constructor={})[r(6)("species")]=function(e){e(U,U)};return(j||"function"==typeof PromiseRejectionEvent)&&e.then(U)instanceof t&&0!==L.indexOf("6.6")&&-1===w.indexOf("Chrome/66")}catch(e){}}(),k=function(e){var t;return!(!h(e)||"function"!=typeof(t=e.then))&&t},I=function(e,t){if(!e._n){e._n=!0;var r=e._c;m(function(){for(var s=e._v,o=1==e._s,n=0,i=function(t){var r,n,i,a=o?t.ok:t.fail,c=t.resolve,u=t.reject,l=t.domain;try{a?(o||(2==e._h&&E(e),e._h=1),!0===a?r=s:(l&&l.enter(),r=a(s),l&&(l.exit(),i=!0)),r===t.promise?u(O("Promise-chain cycle")):(n=k(r))?n.call(r,c,u):c(r)):u(s)}catch(e){l&&!i&&l.exit(),u(e)}};r.length>n;)i(r[n++]);e._c=[],e._n=!1,t&&!e._h&&D(e)})}},D=function(e){b.call(c,function(){var t,r,s,o=e._v,n=A(e);if(n&&(t=v(function(){j?S.emit("unhandledRejection",o,e):(r=c.onunhandledrejection)?r({promise:e,reason:o}):(s=c.console)&&s.error&&s.error("Unhandled promise rejection",o)}),e._h=j||A(e)?2:1),e._a=void 0,n&&t.e)throw t.v})},A=function(e){return 1!==e._h&&0===(e._a||e._c).length},E=function(e){b.call(c,function(){var t;j?S.emit("rejectionHandled",e):(t=c.onrejectionhandled)&&t({promise:e,reason:e._v})})},T=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),I(t,!0))},H=function(e){var t,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===e)throw O("Promise can't be resolved itself");(t=k(e))?m(function(){var s={_w:r,_d:!1};try{t.call(e,u(H,s,1),u(T,s,1))}catch(e){T.call(s,e)}}):(r._v=e,r._s=1,I(r,!1))}catch(e){T.call({_w:r,_d:!1},e)}}};C||(M=function(e){p(this,M,"Promise","_h"),y(e),s.call(this);try{e(u(H,this,1),u(T,this,1))}catch(e){T.call(this,e)}},(s=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=r(44)(M.prototype,{then:function(e,t){var r=x(g(this,M));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=j?S.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&I(this,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),n=function(){var e=new s;this.promise=e,this.resolve=u(H,e,1),this.reject=u(T,e,1)},_.f=x=function(e){return e===M||e===i?new n(e):o(e)}),d(d.G+d.W+d.F*!C,{Promise:M}),r(39)(M,"Promise"),r(42)("Promise"),i=r(8).Promise,d(d.S+d.F*!C,"Promise",{reject:function(e){var t=x(this);return(0,t.reject)(e),t.promise}}),d(d.S+d.F*(a||!C),"Promise",{resolve:function(e){return R(a&&this===i?M:this,e)}}),d(d.S+d.F*!(C&&r(53)(function(e){M.all(e).catch(U)})),"Promise",{all:function(e){var t=this,r=x(t),s=r.resolve,o=r.reject,n=v(function(){var r=[],n=0,i=1;f(e,!1,function(e){var a=n++,c=!1;r.push(void 0),i++,t.resolve(e).then(function(e){c||(c=!0,r[a]=e,--i||s(r))},o)}),--i||s(r)});return n.e&&o(n.v),r.promise},race:function(e){var t=this,r=x(t),s=r.reject,o=v(function(){f(e,!1,function(e){t.resolve(e).then(r.resolve,s)})});return o.e&&s(o.v),r.promise}})},function(e,t,r){"use strict";var s=r(19);e.exports.f=function(e){return new function(e){var t,r;this.promise=new e(function(e,s){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=s}),this.resolve=s(t),this.reject=s(r)}(e)}},function(e,t,r){var s=r(4),o=r(5),n=r(113);e.exports=function(e,t){if(s(e),o(t)&&t.constructor===e)return t;var r=n.f(e);return(0,r.resolve)(t),r.promise}},function(e,t,r){"use strict";var s=r(10).f,o=r(34),n=r(44),i=r(18),a=r(43),c=r(57),u=r(73),l=r(109),d=r(42),h=r(9),y=r(28).fastKey,p=r(38),f=h?"_s":"size",g=function(e,t){var r,s=y(t);if("F"!==s)return e._i[s];for(r=e._f;r;r=r.n)if(r.k==t)return r};e.exports={getConstructor:function(e,t,r,u){var l=e(function(e,s){a(e,l,t,"_i"),e._t=t,e._i=o(null),e._f=void 0,e._l=void 0,e[f]=0,null!=s&&c(s,r,e[u],e)});return n(l.prototype,{clear:function(){for(var e=p(this,t),r=e._i,s=e._f;s;s=s.n)s.r=!0,s.p&&(s.p=s.p.n=void 0),delete r[s.i];e._f=e._l=void 0,e[f]=0},delete:function(e){var r=p(this,t),s=g(r,e);if(s){var o=s.n,n=s.p;delete r._i[s.i],s.r=!0,n&&(n.n=o),o&&(o.p=n),r._f==s&&(r._f=o),r._l==s&&(r._l=n),r[f]--}return!!s},forEach:function(e){p(this,t);for(var r,s=i(e,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(s(r.v,r.k,this);r&&r.r;)r=r.p},has:function(e){return!!g(p(this,t),e)}}),h&&s(l.prototype,"size",{get:function(){return p(this,t)[f]}}),l},def:function(e,t,r){var s,o,n=g(e,t);return n?n.v=r:(e._l=n={i:o=y(t,!0),k:t,v:r,p:s=e._l,n:void 0,r:!1},e._f||(e._f=n),s&&(s.n=n),e[f]++,"F"!==o&&(e._i[o]=n)),e},getEntry:g,setStrong:function(e,t,r){u(e,t,function(e,r){this._t=p(e,t),this._k=r,this._l=void 0},function(){for(var e=this._k,t=this._l;t&&t.r;)t=t.p;return this._t&&(this._l=t=t?t.n:this._t._f)?l(0,"keys"==e?t.k:"values"==e?t.v:[t.k,t.v]):(this._t=void 0,l(1))},r?"entries":"values",!r,!0),d(t)}}},function(e,t,r){"use strict";var s=r(44),o=r(28).getWeak,n=r(4),i=r(5),a=r(43),c=r(57),u=r(23),l=r(14),d=r(38),h=u(5),y=u(6),p=0,f=function(e){return e._l||(e._l=new g)},g=function(){this.a=[]},b=function(e,t){return h(e.a,function(e){return e[0]===t})};g.prototype={get:function(e){var t=b(this,e);if(t)return t[1]},has:function(e){return!!b(this,e)},set:function(e,t){var r=b(this,e);r?r[1]=t:this.a.push([e,t])},delete:function(e){var t=y(this.a,function(t){return t[0]===e});return~t&&this.a.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,r,n){var u=e(function(e,s){a(e,u,t,"_i"),e._t=t,e._i=p++,e._l=void 0,null!=s&&c(s,r,e[n],e)});return s(u.prototype,{delete:function(e){if(!i(e))return!1;var r=o(e);return!0===r?f(d(this,t)).delete(e):r&&l(r,this._i)&&delete r[this._i]},has:function(e){if(!i(e))return!1;var r=o(e);return!0===r?f(d(this,t)).has(e):r&&l(r,this._i)}}),u},def:function(e,t,r){var s=o(n(t),!0);return!0===s?f(e).set(t,r):s[e._i]=r,e},ufstore:f}},function(e,t,r){var s=r(20),o=r(7);e.exports=function(e){if(void 0===e)return 0;var t=s(e),r=o(t);if(t!==r)throw RangeError("Wrong length!");return r}},function(e,t,r){var s=r(35),o=r(51),n=r(4),i=r(2).Reflect;e.exports=i&&i.ownKeys||function(e){var t=s.f(n(e)),r=o.f;return r?t.concat(r(e)):t}},function(e,t,r){var s=r(7),o=r(69),n=r(25);e.exports=function(e,t,r,i){var a=String(n(e)),c=a.length,u=void 0===r?" ":String(r),l=s(t);if(l<=c||""==u)return a;var d=l-c,h=o.call(u,Math.ceil(d/u.length));return h.length>d&&(h=h.slice(0,d)),i?h+a:a+h}},function(e,t,r){var s=r(9),o=r(32),n=r(16),i=r(46).f;e.exports=function(e){return function(t){for(var r,a=n(t),c=o(a),u=c.length,l=0,d=[];u>l;)r=c[l++],s&&!i.call(a,r)||d.push(e?[r,a[r]]:a[r]);return d}}},function(e,t){var r=e.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,r){r(124),e.exports=r(310)},function(e,t,r){"use strict";r(125);var s=function(e){return e&&e.__esModule?e:{default:e}}(r(297));s.default._babelPolyfill&&"undefined"!=typeof console&&console.warn&&console.warn("@babel/polyfill is loaded more than once on this page. This is probably not desirable/intended and may have consequences if different versions of the polyfills are applied sequentially. If you do need to load the polyfill more than once, use @babel/polyfill/noConflict instead to bypass the warning."),s.default._babelPolyfill=!0},function(e,t,r){"use strict";r(126),r(269),r(271),r(274),r(276),r(278),r(280),r(282),r(284),r(286),r(288),r(290),r(292),r(296)},function(e,t,r){r(127),r(130),r(131),r(132),r(133),r(134),r(135),r(136),r(137),r(138),r(139),r(140),r(141),r(142),r(143),r(144),r(145),r(146),r(147),r(148),r(149),r(150),r(151),r(152),r(153),r(154),r(155),r(156),r(157),r(158),r(159),r(160),r(161),r(162),r(163),r(164),r(165),r(166),r(167),r(168),r(169),r(170),r(171),r(173),r(174),r(175),r(176),r(177),r(178),r(179),r(180),r(181),r(182),r(183),r(184),r(185),r(186),r(187),r(188),r(189),r(190),r(191),r(192),r(193),r(194),r(195),r(196),r(197),r(198),r(199),r(200),r(201),r(202),r(203),r(204),r(205),r(206),r(208),r(209),r(211),r(212),r(213),r(214),r(215),r(216),r(217),r(219),r(220),r(221),r(222),r(223),r(224),r(225),r(226),r(227),r(228),r(229),r(230),r(231),r(81),r(232),r(110),r(233),r(111),r(234),r(235),r(236),r(237),r(112),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(256),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(266),r(267),r(268),e.exports=r(8)},function(e,t,r){"use strict";var s=r(2),o=r(14),n=r(9),i=r(1),a=r(12),c=r(28).KEY,u=r(3),l=r(49),d=r(39),h=r(30),y=r(6),p=r(62),f=r(91),g=r(129),b=r(52),m=r(4),_=r(5),v=r(11),w=r(16),R=r(27),O=r(29),S=r(34),P=r(94),L=r(21),M=r(51),j=r(10),U=r(32),x=L.f,C=j.f,k=P.f,I=s.Symbol,D=s.JSON,A=D&&D.stringify,E=y("_hidden"),T=y("toPrimitive"),H={}.propertyIsEnumerable,N=l("symbol-registry"),F=l("symbols"),B=l("op-symbols"),K=Object.prototype,G="function"==typeof I&&!!M.f,q=s.QObject,V=!q||!q.prototype||!q.prototype.findChild,W=n&&u(function(){return 7!=S(C({},"a",{get:function(){return C(this,"a",{value:7}).a}})).a})?function(e,t,r){var s=x(K,t);s&&delete K[t],C(e,t,r),s&&e!==K&&C(K,t,s)}:C,J=function(e){var t=F[e]=S(I.prototype);return t._k=e,t},Y=G&&"symbol"==typeof I.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof I},z=function(e,t,r){return e===K&&z(B,t,r),m(e),t=R(t,!0),m(r),o(F,t)?(r.enumerable?(o(e,E)&&e[E][t]&&(e[E][t]=!1),r=S(r,{enumerable:O(0,!1)})):(o(e,E)||C(e,E,O(1,{})),e[E][t]=!0),W(e,t,r)):C(e,t,r)},$=function(e,t){m(e);for(var r,s=g(t=w(t)),o=0,n=s.length;n>o;)z(e,r=s[o++],t[r]);return e},Q=function(e){var t=H.call(this,e=R(e,!0));return!(this===K&&o(F,e)&&!o(B,e))&&(!(t||!o(this,e)||!o(F,e)||o(this,E)&&this[E][e])||t)},X=function(e,t){if(e=w(e),t=R(t,!0),e!==K||!o(F,t)||o(B,t)){var r=x(e,t);return!r||!o(F,t)||o(e,E)&&e[E][t]||(r.enumerable=!0),r}},Z=function(e){for(var t,r=k(w(e)),s=[],n=0;r.length>n;)o(F,t=r[n++])||t==E||t==c||s.push(t);return s},ee=function(e){for(var t,r=e===K,s=k(r?B:w(e)),n=[],i=0;s.length>i;)!o(F,t=s[i++])||r&&!o(K,t)||n.push(F[t]);return n};G||(a((I=function(){if(this instanceof I)throw TypeError("Symbol is not a constructor!");var e=h(arguments.length>0?arguments[0]:void 0),t=function(r){this===K&&t.call(B,r),o(this,E)&&o(this[E],e)&&(this[E][e]=!1),W(this,e,O(1,r))};return n&&V&&W(K,e,{configurable:!0,set:t}),J(e)}).prototype,"toString",function(){return this._k}),L.f=X,j.f=z,r(35).f=P.f=Z,r(46).f=Q,M.f=ee,n&&!r(31)&&a(K,"propertyIsEnumerable",Q,!0),p.f=function(e){return J(y(e))}),i(i.G+i.W+i.F*!G,{Symbol:I});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),re=0;te.length>re;)y(te[re++]);for(var se=U(y.store),oe=0;se.length>oe;)f(se[oe++]);i(i.S+i.F*!G,"Symbol",{for:function(e){return o(N,e+="")?N[e]:N[e]=I(e)},keyFor:function(e){if(!Y(e))throw TypeError(e+" is not a symbol!");for(var t in N)if(N[t]===e)return t},useSetter:function(){V=!0},useSimple:function(){V=!1}}),i(i.S+i.F*!G,"Object",{create:function(e,t){return void 0===t?S(e):$(S(e),t)},defineProperty:z,defineProperties:$,getOwnPropertyDescriptor:X,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var ne=u(function(){M.f(1)});i(i.S+i.F*ne,"Object",{getOwnPropertySymbols:function(e){return M.f(v(e))}}),D&&i(i.S+i.F*(!G||u(function(){var e=I();return"[null]"!=A([e])||"{}"!=A({a:e})||"{}"!=A(Object(e))})),"JSON",{stringify:function(e){for(var t,r,s=[e],o=1;arguments.length>o;)s.push(arguments[o++]);if(r=t=s[1],(_(t)||void 0!==e)&&!Y(e))return b(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!Y(t))return t}),s[1]=t,A.apply(D,s)}}),I.prototype[T]||r(15)(I.prototype,T,I.prototype.valueOf),d(I,"Symbol"),d(Math,"Math",!0),d(s.JSON,"JSON",!0)},function(e,t,r){e.exports=r(49)("native-function-to-string",Function.toString)},function(e,t,r){var s=r(32),o=r(51),n=r(46);e.exports=function(e){var t=s(e),r=o.f;if(r)for(var i,a=r(e),c=n.f,u=0;a.length>u;)c.call(e,i=a[u++])&&t.push(i);return t}},function(e,t,r){var s=r(1);s(s.S,"Object",{create:r(34)})},function(e,t,r){var s=r(1);s(s.S+s.F*!r(9),"Object",{defineProperty:r(10).f})},function(e,t,r){var s=r(1);s(s.S+s.F*!r(9),"Object",{defineProperties:r(93)})},function(e,t,r){var s=r(16),o=r(21).f;r(22)("getOwnPropertyDescriptor",function(){return function(e,t){return o(s(e),t)}})},function(e,t,r){var s=r(11),o=r(36);r(22)("getPrototypeOf",function(){return function(e){return o(s(e))}})},function(e,t,r){var s=r(11),o=r(32);r(22)("keys",function(){return function(e){return o(s(e))}})},function(e,t,r){r(22)("getOwnPropertyNames",function(){return r(94).f})},function(e,t,r){var s=r(5),o=r(28).onFreeze;r(22)("freeze",function(e){return function(t){return e&&s(t)?e(o(t)):t}})},function(e,t,r){var s=r(5),o=r(28).onFreeze;r(22)("seal",function(e){return function(t){return e&&s(t)?e(o(t)):t}})},function(e,t,r){var s=r(5),o=r(28).onFreeze;r(22)("preventExtensions",function(e){return function(t){return e&&s(t)?e(o(t)):t}})},function(e,t,r){var s=r(5);r(22)("isFrozen",function(e){return function(t){return!s(t)||!!e&&e(t)}})},function(e,t,r){var s=r(5);r(22)("isSealed",function(e){return function(t){return!s(t)||!!e&&e(t)}})},function(e,t,r){var s=r(5);r(22)("isExtensible",function(e){return function(t){return!!s(t)&&(!e||e(t))}})},function(e,t,r){var s=r(1);s(s.S+s.F,"Object",{assign:r(95)})},function(e,t,r){var s=r(1);s(s.S,"Object",{is:r(96)})},function(e,t,r){var s=r(1);s(s.S,"Object",{setPrototypeOf:r(66).set})},function(e,t,r){"use strict";var s=r(47),o={};o[r(6)("toStringTag")]="z",o+""!="[object z]"&&r(12)(Object.prototype,"toString",function(){return"[object "+s(this)+"]"},!0)},function(e,t,r){var s=r(1);s(s.P,"Function",{bind:r(97)})},function(e,t,r){var s=r(10).f,o=Function.prototype,n=/^\s*function ([^ (]*)/;"name"in o||r(9)&&s(o,"name",{configurable:!0,get:function(){try{return(""+this).match(n)[1]}catch(e){return""}}})},function(e,t,r){"use strict";var s=r(5),o=r(36),n=r(6)("hasInstance"),i=Function.prototype;n in i||r(10).f(i,n,{value:function(e){if("function"!=typeof this||!s(e))return!1;if(!s(this.prototype))return e instanceof this;for(;e=o(e);)if(this.prototype===e)return!0;return!1}})},function(e,t,r){var s=r(1),o=r(99);s(s.G+s.F*(parseInt!=o),{parseInt:o})},function(e,t,r){var s=r(1),o=r(100);s(s.G+s.F*(parseFloat!=o),{parseFloat:o})},function(e,t,r){"use strict";var s=r(2),o=r(14),n=r(24),i=r(68),a=r(27),c=r(3),u=r(35).f,l=r(21).f,d=r(10).f,h=r(40).trim,y=s.Number,p=y,f=y.prototype,g="Number"==n(r(34)(f)),b="trim"in String.prototype,m=function(e){var t=a(e,!1);if("string"==typeof t&&t.length>2){var r,s,o,n=(t=b?t.trim():h(t,3)).charCodeAt(0);if(43===n||45===n){if(88===(r=t.charCodeAt(2))||120===r)return NaN}else if(48===n){switch(t.charCodeAt(1)){case 66:case 98:s=2,o=49;break;case 79:case 111:s=8,o=55;break;default:return+t}for(var i,c=t.slice(2),u=0,l=c.length;u<l;u++)if((i=c.charCodeAt(u))<48||i>o)return NaN;return parseInt(c,s)}}return+t};if(!y(" 0o1")||!y("0b1")||y("+0x1")){y=function(e){var t=arguments.length<1?0:e,r=this;return r instanceof y&&(g?c(function(){f.valueOf.call(r)}):"Number"!=n(r))?i(new p(m(t)),r,y):m(t)};for(var _,v=r(9)?u(p):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),w=0;v.length>w;w++)o(p,_=v[w])&&!o(y,_)&&d(y,_,l(p,_));y.prototype=f,f.constructor=y,r(12)(s,"Number",y)}},function(e,t,r){"use strict";var s=r(1),o=r(20),n=r(101),i=r(69),a=1..toFixed,c=Math.floor,u=[0,0,0,0,0,0],l="Number.toFixed: incorrect invocation!",d=function(e,t){for(var r=-1,s=t;++r<6;)s+=e*u[r],u[r]=s%1e7,s=c(s/1e7)},h=function(e){for(var t=6,r=0;--t>=0;)r+=u[t],u[t]=c(r/e),r=r%e*1e7},y=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==u[e]){var r=String(u[e]);t=""===t?r:t+i.call("0",7-r.length)+r}return t},p=function(e,t,r){return 0===t?r:t%2==1?p(e,t-1,r*e):p(e*e,t/2,r)};s(s.P+s.F*(!!a&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(3)(function(){a.call({})})),"Number",{toFixed:function(e){var t,r,s,a,c=n(this,l),u=o(e),f="",g="0";if(u<0||u>20)throw RangeError(l);if(c!=c)return"NaN";if(c<=-1e21||c>=1e21)return String(c);if(c<0&&(f="-",c=-c),c>1e-21)if(r=(t=function(e){for(var t=0,r=c*p(2,69,1);r>=4096;)t+=12,r/=4096;for(;r>=2;)t+=1,r/=2;return t}()-69)<0?c*p(2,-t,1):c/p(2,t,1),r*=4503599627370496,(t=52-t)>0){for(d(0,r),s=u;s>=7;)d(1e7,0),s-=7;for(d(p(10,s,1),0),s=t-1;s>=23;)h(1<<23),s-=23;h(1<<s),d(1,1),h(2),g=y()}else d(0,r),d(1<<-t,0),g=y()+i.call("0",u);return u>0?f+((a=g.length)<=u?"0."+i.call("0",u-a)+g:g.slice(0,a-u)+"."+g.slice(a-u)):f+g}})},function(e,t,r){"use strict";var s=r(1),o=r(3),n=r(101),i=1..toPrecision;s(s.P+s.F*(o(function(){return"1"!==i.call(1,void 0)})||!o(function(){i.call({})})),"Number",{toPrecision:function(e){var t=n(this,"Number#toPrecision: incorrect invocation!");return void 0===e?i.call(t):i.call(t,e)}})},function(e,t,r){var s=r(1);s(s.S,"Number",{EPSILON:Math.pow(2,-52)})},function(e,t,r){var s=r(1),o=r(2).isFinite;s(s.S,"Number",{isFinite:function(e){return"number"==typeof e&&o(e)}})},function(e,t,r){var s=r(1);s(s.S,"Number",{isInteger:r(102)})},function(e,t,r){var s=r(1);s(s.S,"Number",{isNaN:function(e){return e!=e}})},function(e,t,r){var s=r(1),o=r(102),n=Math.abs;s(s.S,"Number",{isSafeInteger:function(e){return o(e)&&n(e)<=9007199254740991}})},function(e,t,r){var s=r(1);s(s.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(e,t,r){var s=r(1);s(s.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(e,t,r){var s=r(1),o=r(100);s(s.S+s.F*(Number.parseFloat!=o),"Number",{parseFloat:o})},function(e,t,r){var s=r(1),o=r(99);s(s.S+s.F*(Number.parseInt!=o),"Number",{parseInt:o})},function(e,t,r){var s=r(1),o=r(103),n=Math.sqrt,i=Math.acosh;s(s.S+s.F*!(i&&710==Math.floor(i(Number.MAX_VALUE))&&i(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:o(e-1+n(e-1)*n(e+1))}})},function(e,t,r){var s=r(1),o=Math.asinh;s(s.S+s.F*!(o&&1/o(0)>0),"Math",{asinh:function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}})},function(e,t,r){var s=r(1),o=Math.atanh;s(s.S+s.F*!(o&&1/o(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}})},function(e,t,r){var s=r(1),o=r(70);s(s.S,"Math",{cbrt:function(e){return o(e=+e)*Math.pow(Math.abs(e),1/3)}})},function(e,t,r){var s=r(1);s(s.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},function(e,t,r){var s=r(1),o=Math.exp;s(s.S,"Math",{cosh:function(e){return(o(e=+e)+o(-e))/2}})},function(e,t,r){var s=r(1),o=r(71);s(s.S+s.F*(o!=Math.expm1),"Math",{expm1:o})},function(e,t,r){var s=r(1);s(s.S,"Math",{fround:r(172)})},function(e,t,r){var s=r(70),o=Math.pow,n=o(2,-52),i=o(2,-23),a=o(2,127)*(2-i),c=o(2,-126);e.exports=Math.fround||function(e){var t,r,o=Math.abs(e),u=s(e);return o<c?u*(o/c/i+1/n-1/n)*c*i:(r=(t=(1+i/n)*o)-(t-o))>a||r!=r?u*(1/0):u*r}},function(e,t,r){var s=r(1),o=Math.abs;s(s.S,"Math",{hypot:function(e,t){for(var r,s,n=0,i=0,a=arguments.length,c=0;i<a;)c<(r=o(arguments[i++]))?(n=n*(s=c/r)*s+1,c=r):n+=r>0?(s=r/c)*s:r;return c===1/0?1/0:c*Math.sqrt(n)}})},function(e,t,r){var s=r(1),o=Math.imul;s(s.S+s.F*r(3)(function(){return-5!=o(4294967295,5)||2!=o.length}),"Math",{imul:function(e,t){var r=+e,s=+t,o=65535&r,n=65535&s;return 0|o*n+((65535&r>>>16)*n+o*(65535&s>>>16)<<16>>>0)}})},function(e,t,r){var s=r(1);s(s.S,"Math",{log10:function(e){return Math.log(e)*Math.LOG10E}})},function(e,t,r){var s=r(1);s(s.S,"Math",{log1p:r(103)})},function(e,t,r){var s=r(1);s(s.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}})},function(e,t,r){var s=r(1);s(s.S,"Math",{sign:r(70)})},function(e,t,r){var s=r(1),o=r(71),n=Math.exp;s(s.S+s.F*r(3)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(o(e)-o(-e))/2:(n(e-1)-n(-e-1))*(Math.E/2)}})},function(e,t,r){var s=r(1),o=r(71),n=Math.exp;s(s.S,"Math",{tanh:function(e){var t=o(e=+e),r=o(-e);return t==1/0?1:r==1/0?-1:(t-r)/(n(e)+n(-e))}})},function(e,t,r){var s=r(1);s(s.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}})},function(e,t,r){var s=r(1),o=r(33),n=String.fromCharCode,i=String.fromCodePoint;s(s.S+s.F*(!!i&&1!=i.length),"String",{fromCodePoint:function(e){for(var t,r=[],s=arguments.length,i=0;s>i;){if(t=+arguments[i++],o(t,1114111)!==t)throw RangeError(t+" is not a valid code point");r.push(t<65536?n(t):n(55296+((t-=65536)>>10),t%1024+56320))}return r.join("")}})},function(e,t,r){var s=r(1),o=r(16),n=r(7);s(s.S,"String",{raw:function(e){for(var t=o(e.raw),r=n(t.length),s=arguments.length,i=[],a=0;r>a;)i.push(String(t[a++])),a<s&&i.push(String(arguments[a]));return i.join("")}})},function(e,t,r){"use strict";r(40)("trim",function(e){return function(){return e(this,3)}})},function(e,t,r){"use strict";var s=r(72)(!0);r(73)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,r=this._i;return r>=t.length?{value:void 0,done:!0}:(e=s(t,r),this._i+=e.length,{value:e,done:!1})})},function(e,t,r){"use strict";var s=r(1),o=r(72)(!1);s(s.P,"String",{codePointAt:function(e){return o(this,e)}})},function(e,t,r){"use strict";var s=r(1),o=r(7),n=r(74),i="".endsWith;s(s.P+s.F*r(76)("endsWith"),"String",{endsWith:function(e){var t=n(this,e,"endsWith"),r=arguments.length>1?arguments[1]:void 0,s=o(t.length),a=void 0===r?s:Math.min(o(r),s),c=String(e);return i?i.call(t,c,a):t.slice(a-c.length,a)===c}})},function(e,t,r){"use strict";var s=r(1),o=r(74);s(s.P+s.F*r(76)("includes"),"String",{includes:function(e){return!!~o(this,e,"includes").indexOf(e,arguments.length>1?arguments[1]:void 0)}})},function(e,t,r){var s=r(1);s(s.P,"String",{repeat:r(69)})},function(e,t,r){"use strict";var s=r(1),o=r(7),n=r(74),i="".startsWith;s(s.P+s.F*r(76)("startsWith"),"String",{startsWith:function(e){var t=n(this,e,"startsWith"),r=o(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),s=String(e);return i?i.call(t,s,r):t.slice(r,r+s.length)===s}})},function(e,t,r){"use strict";r(13)("anchor",function(e){return function(t){return e(this,"a","name",t)}})},function(e,t,r){"use strict";r(13)("big",function(e){return function(){return e(this,"big","","")}})},function(e,t,r){"use strict";r(13)("blink",function(e){return function(){return e(this,"blink","","")}})},function(e,t,r){"use strict";r(13)("bold",function(e){return function(){return e(this,"b","","")}})},function(e,t,r){"use strict";r(13)("fixed",function(e){return function(){return e(this,"tt","","")}})},function(e,t,r){"use strict";r(13)("fontcolor",function(e){return function(t){return e(this,"font","color",t)}})},function(e,t,r){"use strict";r(13)("fontsize",function(e){return function(t){return e(this,"font","size",t)}})},function(e,t,r){"use strict";r(13)("italics",function(e){return function(){return e(this,"i","","")}})},function(e,t,r){"use strict";r(13)("link",function(e){return function(t){return e(this,"a","href",t)}})},function(e,t,r){"use strict";r(13)("small",function(e){return function(){return e(this,"small","","")}})},function(e,t,r){"use strict";r(13)("strike",function(e){return function(){return e(this,"strike","","")}})},function(e,t,r){"use strict";r(13)("sub",function(e){return function(){return e(this,"sub","","")}})},function(e,t,r){"use strict";r(13)("sup",function(e){return function(){return e(this,"sup","","")}})},function(e,t,r){var s=r(1);s(s.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,r){"use strict";var s=r(1),o=r(11),n=r(27);s(s.P+s.F*r(3)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(e){var t=o(this),r=n(t);return"number"!=typeof r||isFinite(r)?t.toISOString():null}})},function(e,t,r){var s=r(1),o=r(207);s(s.P+s.F*(Date.prototype.toISOString!==o),"Date",{toISOString:o})},function(e,t,r){"use strict";var s=r(3),o=Date.prototype.getTime,n=Date.prototype.toISOString,i=function(e){return e>9?e:"0"+e};e.exports=s(function(){return"0385-07-25T07:06:39.999Z"!=n.call(new Date(-5e13-1))})||!s(function(){n.call(new Date(NaN))})?function(){if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),r=e.getUTCMilliseconds(),s=t<0?"-":t>9999?"+":"";return s+("00000"+Math.abs(t)).slice(s?-6:-4)+"-"+i(e.getUTCMonth()+1)+"-"+i(e.getUTCDate())+"T"+i(e.getUTCHours())+":"+i(e.getUTCMinutes())+":"+i(e.getUTCSeconds())+"."+(r>99?r:"0"+i(r))+"Z"}:n},function(e,t,r){var s=Date.prototype,o=s.toString,n=s.getTime;new Date(NaN)+""!="Invalid Date"&&r(12)(s,"toString",function(){var e=n.call(this);return e==e?o.call(this):"Invalid Date"})},function(e,t,r){var s=r(6)("toPrimitive"),o=Date.prototype;s in o||r(15)(o,s,r(210))},function(e,t,r){"use strict";var s=r(4),o=r(27);e.exports=function(e){if("string"!==e&&"number"!==e&&"default"!==e)throw TypeError("Incorrect hint");return o(s(this),"number"!=e)}},function(e,t,r){var s=r(1);s(s.S,"Array",{isArray:r(52)})},function(e,t,r){"use strict";var s=r(18),o=r(1),n=r(11),i=r(105),a=r(77),c=r(7),u=r(78),l=r(79);o(o.S+o.F*!r(53)(function(e){Array.from(e)}),"Array",{from:function(e){var t,r,o,d,h=n(e),y="function"==typeof this?this:Array,p=arguments.length,f=p>1?arguments[1]:void 0,g=void 0!==f,b=0,m=l(h);if(g&&(f=s(f,p>2?arguments[2]:void 0,2)),null==m||y==Array&&a(m))for(r=new y(t=c(h.length));t>b;b++)u(r,b,g?f(h[b],b):h[b]);else for(d=m.call(h),r=new y;!(o=d.next()).done;b++)u(r,b,g?i(d,f,[o.value,b],!0):o.value);return r.length=b,r}})},function(e,t,r){"use strict";var s=r(1),o=r(78);s(s.S+s.F*r(3)(function(){function e(){}return!(Array.of.call(e)instanceof e)}),"Array",{of:function(){for(var e=0,t=arguments.length,r=new("function"==typeof this?this:Array)(t);t>e;)o(r,e,arguments[e++]);return r.length=t,r}})},function(e,t,r){"use strict";var s=r(1),o=r(16),n=[].join;s(s.P+s.F*(r(45)!=Object||!r(17)(n)),"Array",{join:function(e){return n.call(o(this),void 0===e?",":e)}})},function(e,t,r){"use strict";var s=r(1),o=r(65),n=r(24),i=r(33),a=r(7),c=[].slice;s(s.P+s.F*r(3)(function(){o&&c.call(o)}),"Array",{slice:function(e,t){var r=a(this.length),s=n(this);if(t=void 0===t?r:t,"Array"==s)return c.call(this,e,t);for(var o=i(e,r),u=i(t,r),l=a(u-o),d=new Array(l),h=0;h<l;h++)d[h]="String"==s?this.charAt(o+h):this[o+h];return d}})},function(e,t,r){"use strict";var s=r(1),o=r(19),n=r(11),i=r(3),a=[].sort,c=[1,2,3];s(s.P+s.F*(i(function(){c.sort(void 0)})||!i(function(){c.sort(null)})||!r(17)(a)),"Array",{sort:function(e){return void 0===e?a.call(n(this)):a.call(n(this),o(e))}})},function(e,t,r){"use strict";var s=r(1),o=r(23)(0),n=r(17)([].forEach,!0);s(s.P+s.F*!n,"Array",{forEach:function(e){return o(this,e,arguments[1])}})},function(e,t,r){var s=r(5),o=r(52),n=r(6)("species");e.exports=function(e){var t;return o(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!o(t.prototype)||(t=void 0),s(t)&&null===(t=t[n])&&(t=void 0)),void 0===t?Array:t}},function(e,t,r){"use strict";var s=r(1),o=r(23)(1);s(s.P+s.F*!r(17)([].map,!0),"Array",{map:function(e){return o(this,e,arguments[1])}})},function(e,t,r){"use strict";var s=r(1),o=r(23)(2);s(s.P+s.F*!r(17)([].filter,!0),"Array",{filter:function(e){return o(this,e,arguments[1])}})},function(e,t,r){"use strict";var s=r(1),o=r(23)(3);s(s.P+s.F*!r(17)([].some,!0),"Array",{some:function(e){return o(this,e,arguments[1])}})},function(e,t,r){"use strict";var s=r(1),o=r(23)(4);s(s.P+s.F*!r(17)([].every,!0),"Array",{every:function(e){return o(this,e,arguments[1])}})},function(e,t,r){"use strict";var s=r(1),o=r(107);s(s.P+s.F*!r(17)([].reduce,!0),"Array",{reduce:function(e){return o(this,e,arguments.length,arguments[1],!1)}})},function(e,t,r){"use strict";var s=r(1),o=r(107);s(s.P+s.F*!r(17)([].reduceRight,!0),"Array",{reduceRight:function(e){return o(this,e,arguments.length,arguments[1],!0)}})},function(e,t,r){"use strict";var s=r(1),o=r(50)(!1),n=[].indexOf,i=!!n&&1/[1].indexOf(1,-0)<0;s(s.P+s.F*(i||!r(17)(n)),"Array",{indexOf:function(e){return i?n.apply(this,arguments)||0:o(this,e,arguments[1])}})},function(e,t,r){"use strict";var s=r(1),o=r(16),n=r(20),i=r(7),a=[].lastIndexOf,c=!!a&&1/[1].lastIndexOf(1,-0)<0;s(s.P+s.F*(c||!r(17)(a)),"Array",{lastIndexOf:function(e){if(c)return a.apply(this,arguments)||0;var t=o(this),r=i(t.length),s=r-1;for(arguments.length>1&&(s=Math.min(s,n(arguments[1]))),s<0&&(s=r+s);s>=0;s--)if(s in t&&t[s]===e)return s||0;return-1}})},function(e,t,r){var s=r(1);s(s.P,"Array",{copyWithin:r(108)}),r(37)("copyWithin")},function(e,t,r){var s=r(1);s(s.P,"Array",{fill:r(80)}),r(37)("fill")},function(e,t,r){"use strict";var s=r(1),o=r(23)(5),n=!0;"find"in[]&&Array(1).find(function(){n=!1}),s(s.P+s.F*n,"Array",{find:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}}),r(37)("find")},function(e,t,r){"use strict";var s=r(1),o=r(23)(6),n="findIndex",i=!0;n in[]&&Array(1)[n](function(){i=!1}),s(s.P+s.F*i,"Array",{findIndex:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}}),r(37)(n)},function(e,t,r){r(42)("Array")},function(e,t,r){var s=r(2),o=r(68),n=r(10).f,i=r(35).f,a=r(75),c=r(54),u=s.RegExp,l=u,d=u.prototype,h=/a/g,y=/a/g,p=new u(h)!==h;if(r(9)&&(!p||r(3)(function(){return y[r(6)("match")]=!1,u(h)!=h||u(y)==y||"/a/i"!=u(h,"i")}))){u=function(e,t){var r=this instanceof u,s=a(e),n=void 0===t;return!r&&s&&e.constructor===u&&n?e:o(p?new l(s&&!n?e.source:e,t):l((s=e instanceof u)?e.source:e,s&&n?c.call(e):t),r?this:d,u)};for(var f=function(e){e in u||n(u,e,{configurable:!0,get:function(){return l[e]},set:function(t){l[e]=t}})},g=i(l),b=0;g.length>b;)f(g[b++]);d.constructor=u,u.prototype=d,r(12)(s,"RegExp",u)}r(42)("RegExp")},function(e,t,r){"use strict";r(111);var s=r(4),o=r(54),n=r(9),i=/./.toString,a=function(e){r(12)(RegExp.prototype,"toString",e,!0)};r(3)(function(){return"/a/b"!=i.call({source:"a",flags:"b"})})?a(function(){var e=s(this);return"/".concat(e.source,"/","flags"in e?e.flags:!n&&e instanceof RegExp?o.call(e):void 0)}):"toString"!=i.name&&a(function(){return i.call(this)})},function(e,t,r){"use strict";var s=r(4),o=r(7),n=r(83),i=r(55);r(56)("match",1,function(e,t,r,a){return[function(r){var s=e(this),o=null==r?void 0:r[t];return void 0!==o?o.call(r,s):new RegExp(r)[t](String(s))},function(e){var t=a(r,e,this);if(t.done)return t.value;var c=s(e),u=String(this);if(!c.global)return i(c,u);var l=c.unicode;c.lastIndex=0;for(var d,h=[],y=0;null!==(d=i(c,u));){var p=String(d[0]);h[y]=p,""===p&&(c.lastIndex=n(u,o(c.lastIndex),l)),y++}return 0===y?null:h}]})},function(e,t,r){"use strict";var s=r(4),o=r(11),n=r(7),i=r(20),a=r(83),c=r(55),u=Math.max,l=Math.min,d=Math.floor,h=/\$([$&`']|\d\d?|<[^>]*>)/g,y=/\$([$&`']|\d\d?)/g,p=function(e){return void 0===e?e:String(e)};r(56)("replace",2,function(e,t,r,f){return[function(s,o){var n=e(this),i=null==s?void 0:s[t];return void 0!==i?i.call(s,n,o):r.call(String(n),s,o)},function(e,t){var o=f(r,e,this,t);if(o.done)return o.value;var d=s(e),h=String(this),y="function"==typeof t;y||(t=String(t));var b=d.global;if(b){var m=d.unicode;d.lastIndex=0}for(var _=[];;){var v=c(d,h);if(null===v)break;if(_.push(v),!b)break;""===String(v[0])&&(d.lastIndex=a(h,n(d.lastIndex),m))}for(var w="",R=0,O=0;O<_.length;O++){v=_[O];for(var S=String(v[0]),P=u(l(i(v.index),h.length),0),L=[],M=1;M<v.length;M++)L.push(p(v[M]));var j=v.groups;if(y){var U=[S].concat(L,P,h);void 0!==j&&U.push(j);var x=String(t.apply(void 0,U))}else x=g(S,h,P,L,j,t);P>=R&&(w+=h.slice(R,P)+x,R=P+S.length)}return w+h.slice(R)}];function g(e,t,s,n,i,a){var c=s+e.length,u=n.length,l=y;return void 0!==i&&(i=o(i),l=h),r.call(a,l,function(r,o){var a;switch(o.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,s);case"'":return t.slice(c);case"<":a=i[o.slice(1,-1)];break;default:var l=+o;if(0===l)return r;if(l>u){var h=d(l/10);return 0===h?r:h<=u?void 0===n[h-1]?o.charAt(1):n[h-1]+o.charAt(1):r}a=n[l-1]}return void 0===a?"":a})}})},function(e,t,r){"use strict";var s=r(4),o=r(96),n=r(55);r(56)("search",1,function(e,t,r,i){return[function(r){var s=e(this),o=null==r?void 0:r[t];return void 0!==o?o.call(r,s):new RegExp(r)[t](String(s))},function(e){var t=i(r,e,this);if(t.done)return t.value;var a=s(e),c=String(this),u=a.lastIndex;o(u,0)||(a.lastIndex=0);var l=n(a,c);return o(a.lastIndex,u)||(a.lastIndex=u),null===l?-1:l.index}]})},function(e,t,r){"use strict";var s=r(75),o=r(4),n=r(48),i=r(83),a=r(7),c=r(55),u=r(82),l=r(3),d=Math.min,h=[].push,y=!l(function(){RegExp(4294967295,"y")});r(56)("split",2,function(e,t,r,l){var p;return p="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||".".split(/()()/).length>1||"".split(/.?/).length?function(e,t){var o=String(this);if(void 0===e&&0===t)return[];if(!s(e))return r.call(o,e,t);for(var n,i,a,c=[],l=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),d=0,y=void 0===t?4294967295:t>>>0,p=new RegExp(e.source,l+"g");(n=u.call(p,o))&&!((i=p.lastIndex)>d&&(c.push(o.slice(d,n.index)),n.length>1&&n.index<o.length&&h.apply(c,n.slice(1)),a=n[0].length,d=i,c.length>=y));)p.lastIndex===n.index&&p.lastIndex++;return d===o.length?!a&&p.test("")||c.push(""):c.push(o.slice(d)),c.length>y?c.slice(0,y):c}:"0".split(void 0,0).length?function(e,t){return void 0===e&&0===t?[]:r.call(this,e,t)}:r,[function(r,s){var o=e(this),n=null==r?void 0:r[t];return void 0!==n?n.call(r,o,s):p.call(String(o),r,s)},function(e,t){var s=l(p,e,this,t,p!==r);if(s.done)return s.value;var u=o(e),h=String(this),f=n(u,RegExp),g=u.unicode,b=(u.ignoreCase?"i":"")+(u.multiline?"m":"")+(u.unicode?"u":"")+(y?"y":"g"),m=new f(y?u:"^(?:"+u.source+")",b),_=void 0===t?4294967295:t>>>0;if(0===_)return[];if(0===h.length)return null===c(m,h)?[h]:[];for(var v=0,w=0,R=[];w<h.length;){m.lastIndex=y?w:0;var O,S=c(m,y?h:h.slice(w));if(null===S||(O=d(a(m.lastIndex+(y?0:w)),h.length))===v)w=i(h,w,g);else{if(R.push(h.slice(v,w)),R.length===_)return R;for(var P=1;P<=S.length-1;P++)if(R.push(S[P]),R.length===_)return R;w=v=O}}return R.push(h.slice(v)),R}]})},function(e,t,r){var s=r(2),o=r(84).set,n=s.MutationObserver||s.WebKitMutationObserver,i=s.process,a=s.Promise,c="process"==r(24)(i);e.exports=function(){var e,t,r,u=function(){var s,o;for(c&&(s=i.domain)&&s.exit();e;){o=e.fn,e=e.next;try{o()}catch(s){throw e?r():t=void 0,s}}t=void 0,s&&s.enter()};if(c)r=function(){i.nextTick(u)};else if(!n||s.navigator&&s.navigator.standalone)if(a&&a.resolve){var l=a.resolve(void 0);r=function(){l.then(u)}}else r=function(){o.call(s,u)};else{var d=!0,h=document.createTextNode("");new n(u).observe(h,{characterData:!0}),r=function(){h.data=d=!d}}return function(s){var o={fn:s,next:void 0};t&&(t.next=o),e||(e=o,r()),t=o}}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,r){"use strict";var s=r(115),o=r(38);e.exports=r(59)("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{get:function(e){var t=s.getEntry(o(this,"Map"),e);return t&&t.v},set:function(e,t){return s.def(o(this,"Map"),0===e?0:e,t)}},s,!0)},function(e,t,r){"use strict";var s=r(115),o=r(38);e.exports=r(59)("Set",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{add:function(e){return s.def(o(this,"Set"),e=0===e?0:e,e)}},s)},function(e,t,r){"use strict";var s,o=r(2),n=r(23)(0),i=r(12),a=r(28),c=r(95),u=r(116),l=r(5),d=r(38),h=r(38),y=!o.ActiveXObject&&"ActiveXObject"in o,p=a.getWeak,f=Object.isExtensible,g=u.ufstore,b=function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},m={get:function(e){if(l(e)){var t=p(e);return!0===t?g(d(this,"WeakMap")).get(e):t?t[this._i]:void 0}},set:function(e,t){return u.def(d(this,"WeakMap"),e,t)}},_=e.exports=r(59)("WeakMap",b,m,u,!0,!0);h&&y&&(c((s=u.getConstructor(b,"WeakMap")).prototype,m),a.NEED=!0,n(["delete","has","get","set"],function(e){var t=_.prototype,r=t[e];i(t,e,function(t,o){if(l(t)&&!f(t)){this._f||(this._f=new s);var n=this._f[e](t,o);return"set"==e?this:n}return r.call(this,t,o)})}))},function(e,t,r){"use strict";var s=r(116),o=r(38);r(59)("WeakSet",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{add:function(e){return s.def(o(this,"WeakSet"),e,!0)}},s,!1,!0)},function(e,t,r){"use strict";var s=r(1),o=r(60),n=r(85),i=r(4),a=r(33),c=r(7),u=r(5),l=r(2).ArrayBuffer,d=r(48),h=n.ArrayBuffer,y=n.DataView,p=o.ABV&&l.isView,f=h.prototype.slice,g=o.VIEW;s(s.G+s.W+s.F*(l!==h),{ArrayBuffer:h}),s(s.S+s.F*!o.CONSTR,"ArrayBuffer",{isView:function(e){return p&&p(e)||u(e)&&g in e}}),s(s.P+s.U+s.F*r(3)(function(){return!new h(2).slice(1,void 0).byteLength}),"ArrayBuffer",{slice:function(e,t){if(void 0!==f&&void 0===t)return f.call(i(this),e);for(var r=i(this).byteLength,s=a(e,r),o=a(void 0===t?r:t,r),n=new(d(this,h))(c(o-s)),u=new y(this),l=new y(n),p=0;s<o;)l.setUint8(p++,u.getUint8(s++));return n}}),r(42)("ArrayBuffer")},function(e,t,r){var s=r(1);s(s.G+s.W+s.F*!r(60).ABV,{DataView:r(85).DataView})},function(e,t,r){r(26)("Int8",1,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Uint8",1,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Uint8",1,function(e){return function(t,r,s){return e(this,t,r,s)}},!0)},function(e,t,r){r(26)("Int16",2,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Uint16",2,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Int32",4,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Uint32",4,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Float32",4,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){r(26)("Float64",8,function(e){return function(t,r,s){return e(this,t,r,s)}})},function(e,t,r){var s=r(1),o=r(19),n=r(4),i=(r(2).Reflect||{}).apply,a=Function.apply;s(s.S+s.F*!r(3)(function(){i(function(){})}),"Reflect",{apply:function(e,t,r){var s=o(e),c=n(r);return i?i(s,t,c):a.call(s,t,c)}})},function(e,t,r){var s=r(1),o=r(34),n=r(19),i=r(4),a=r(5),c=r(3),u=r(97),l=(r(2).Reflect||{}).construct,d=c(function(){function e(){}return!(l(function(){},[],e)instanceof e)}),h=!c(function(){l(function(){})});s(s.S+s.F*(d||h),"Reflect",{construct:function(e,t){n(e),i(t);var r=arguments.length<3?e:n(arguments[2]);if(h&&!d)return l(e,t,r);if(e==r){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var s=[null];return s.push.apply(s,t),new(u.apply(e,s))}var c=r.prototype,y=o(a(c)?c:Object.prototype),p=Function.apply.call(e,y,t);return a(p)?p:y}})},function(e,t,r){var s=r(10),o=r(1),n=r(4),i=r(27);o(o.S+o.F*r(3)(function(){Reflect.defineProperty(s.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(e,t,r){n(e),t=i(t,!0),n(r);try{return s.f(e,t,r),!0}catch(e){return!1}}})},function(e,t,r){var s=r(1),o=r(21).f,n=r(4);s(s.S,"Reflect",{deleteProperty:function(e,t){var r=o(n(e),t);return!(r&&!r.configurable)&&delete e[t]}})},function(e,t,r){"use strict";var s=r(1),o=r(4),n=function(e){this._t=o(e),this._i=0;var t,r=this._k=[];for(t in e)r.push(t)};r(104)(n,"Object",function(){var e,t=this._k;do{if(this._i>=t.length)return{value:void 0,done:!0}}while(!((e=t[this._i++])in this._t));return{value:e,done:!1}}),s(s.S,"Reflect",{enumerate:function(e){return new n(e)}})},function(e,t,r){var s=r(21),o=r(36),n=r(14),i=r(1),a=r(5),c=r(4);i(i.S,"Reflect",{get:function e(t,r){var i,u,l=arguments.length<3?t:arguments[2];return c(t)===l?t[r]:(i=s.f(t,r))?n(i,"value")?i.value:void 0!==i.get?i.get.call(l):void 0:a(u=o(t))?e(u,r,l):void 0}})},function(e,t,r){var s=r(21),o=r(1),n=r(4);o(o.S,"Reflect",{getOwnPropertyDescriptor:function(e,t){return s.f(n(e),t)}})},function(e,t,r){var s=r(1),o=r(36),n=r(4);s(s.S,"Reflect",{getPrototypeOf:function(e){return o(n(e))}})},function(e,t,r){var s=r(1);s(s.S,"Reflect",{has:function(e,t){return t in e}})},function(e,t,r){var s=r(1),o=r(4),n=Object.isExtensible;s(s.S,"Reflect",{isExtensible:function(e){return o(e),!n||n(e)}})},function(e,t,r){var s=r(1);s(s.S,"Reflect",{ownKeys:r(118)})},function(e,t,r){var s=r(1),o=r(4),n=Object.preventExtensions;s(s.S,"Reflect",{preventExtensions:function(e){o(e);try{return n&&n(e),!0}catch(e){return!1}}})},function(e,t,r){var s=r(10),o=r(21),n=r(36),i=r(14),a=r(1),c=r(29),u=r(4),l=r(5);a(a.S,"Reflect",{set:function e(t,r,a){var d,h,y=arguments.length<4?t:arguments[3],p=o.f(u(t),r);if(!p){if(l(h=n(t)))return e(h,r,a,y);p=c(0)}if(i(p,"value")){if(!1===p.writable||!l(y))return!1;if(d=o.f(y,r)){if(d.get||d.set||!1===d.writable)return!1;d.value=a,s.f(y,r,d)}else s.f(y,r,c(0,a));return!0}return void 0!==p.set&&(p.set.call(y,a),!0)}})},function(e,t,r){var s=r(1),o=r(66);o&&s(s.S,"Reflect",{setPrototypeOf:function(e,t){o.check(e,t);try{return o.set(e,t),!0}catch(e){return!1}}})},function(e,t,r){r(270),e.exports=r(8).Array.includes},function(e,t,r){"use strict";var s=r(1),o=r(50)(!0);s(s.P,"Array",{includes:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}}),r(37)("includes")},function(e,t,r){r(272),e.exports=r(8).Array.flatMap},function(e,t,r){"use strict";var s=r(1),o=r(273),n=r(11),i=r(7),a=r(19),c=r(106);s(s.P,"Array",{flatMap:function(e){var t,r,s=n(this);return a(e),t=i(s.length),r=c(s,0),o(r,s,s,t,0,1,e,arguments[1]),r}}),r(37)("flatMap")},function(e,t,r){"use strict";var s=r(52),o=r(5),n=r(7),i=r(18),a=r(6)("isConcatSpreadable");e.exports=function e(t,r,c,u,l,d,h,y){for(var p,f,g=l,b=0,m=!!h&&i(h,y,3);b<u;){if(b in c){if(p=m?m(c[b],b,r):c[b],f=!1,o(p)&&(f=void 0!==(f=p[a])?!!f:s(p)),f&&d>0)g=e(t,r,p,n(p.length),g,d-1)-1;else{if(g>=9007199254740991)throw TypeError();t[g]=p}g++}b++}return g}},function(e,t,r){r(275),e.exports=r(8).String.padStart},function(e,t,r){"use strict";var s=r(1),o=r(119),n=r(58),i=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(n);s(s.P+s.F*i,"String",{padStart:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0,!0)}})},function(e,t,r){r(277),e.exports=r(8).String.padEnd},function(e,t,r){"use strict";var s=r(1),o=r(119),n=r(58),i=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(n);s(s.P+s.F*i,"String",{padEnd:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0,!1)}})},function(e,t,r){r(279),e.exports=r(8).String.trimLeft},function(e,t,r){"use strict";r(40)("trimLeft",function(e){return function(){return e(this,1)}},"trimStart")},function(e,t,r){r(281),e.exports=r(8).String.trimRight},function(e,t,r){"use strict";r(40)("trimRight",function(e){return function(){return e(this,2)}},"trimEnd")},function(e,t,r){r(283),e.exports=r(62).f("asyncIterator")},function(e,t,r){r(91)("asyncIterator")},function(e,t,r){r(285),e.exports=r(8).Object.getOwnPropertyDescriptors},function(e,t,r){var s=r(1),o=r(118),n=r(16),i=r(21),a=r(78);s(s.S,"Object",{getOwnPropertyDescriptors:function(e){for(var t,r,s=n(e),c=i.f,u=o(s),l={},d=0;u.length>d;)void 0!==(r=c(s,t=u[d++]))&&a(l,t,r);return l}})},function(e,t,r){r(287),e.exports=r(8).Object.values},function(e,t,r){var s=r(1),o=r(120)(!1);s(s.S,"Object",{values:function(e){return o(e)}})},function(e,t,r){r(289),e.exports=r(8).Object.entries},function(e,t,r){var s=r(1),o=r(120)(!0);s(s.S,"Object",{entries:function(e){return o(e)}})},function(e,t,r){"use strict";r(112),r(291),e.exports=r(8).Promise.finally},function(e,t,r){"use strict";var s=r(1),o=r(8),n=r(2),i=r(48),a=r(114);s(s.P+s.R,"Promise",{finally:function(e){var t=i(this,o.Promise||n.Promise),r="function"==typeof e;return this.then(r?function(r){return a(t,e()).then(function(){return r})}:e,r?function(r){return a(t,e()).then(function(){throw r})}:e)}})},function(e,t,r){r(293),r(294),r(295),e.exports=r(8)},function(e,t,r){var s=r(2),o=r(1),n=r(58),i=[].slice,a=/MSIE .\./.test(n),c=function(e){return function(t,r){var s=arguments.length>2,o=!!s&&i.call(arguments,2);return e(s?function(){("function"==typeof t?t:Function(t)).apply(this,o)}:t,r)}};o(o.G+o.B+o.F*a,{setTimeout:c(s.setTimeout),setInterval:c(s.setInterval)})},function(e,t,r){var s=r(1),o=r(84);s(s.G+s.B,{setImmediate:o.set,clearImmediate:o.clear})},function(e,t,r){for(var s=r(81),o=r(32),n=r(12),i=r(2),a=r(15),c=r(41),u=r(6),l=u("iterator"),d=u("toStringTag"),h=c.Array,y={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=o(y),f=0;f<p.length;f++){var g,b=p[f],m=y[b],_=i[b],v=_&&_.prototype;if(v&&(v[l]||a(v,l,h),v[d]||a(v,d,b),c[b]=h,m))for(g in s)v[g]||n(v,g,s[g],!0)}},function(e,t,r){var s=function(e){"use strict";var t,r=Object.prototype,s=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},n=o.iterator||"@@iterator",i=o.asyncIterator||"@@asyncIterator",a=o.toStringTag||"@@toStringTag";function c(e,t,r,s){var o=t&&t.prototype instanceof f?t:f,n=Object.create(o.prototype),i=new M(s||[]);return n._invoke=function(e,t,r){var s=l;return function(o,n){if(s===h)throw new Error("Generator is already running");if(s===y){if("throw"===o)throw n;return U()}for(r.method=o,r.arg=n;;){var i=r.delegate;if(i){var a=S(i,r);if(a){if(a===p)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(s===l)throw s=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);s=h;var c=u(e,t,r);if("normal"===c.type){if(s=r.done?y:d,c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(s=y,r.method="throw",r.arg=c.arg)}}}(e,r,i),n}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l="suspendedStart",d="suspendedYield",h="executing",y="completed",p={};function f(){}function g(){}function b(){}var m={};m[n]=function(){return this};var _=Object.getPrototypeOf,v=_&&_(_(j([])));v&&v!==r&&s.call(v,n)&&(m=v);var w=b.prototype=f.prototype=Object.create(m);function R(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function O(e){var t;this._invoke=function(r,o){function n(){return new Promise(function(t,n){!function t(r,o,n,i){var a=u(e[r],e,o);if("throw"!==a.type){var c=a.arg,l=c.value;return l&&"object"==typeof l&&s.call(l,"__await")?Promise.resolve(l.__await).then(function(e){t("next",e,n,i)},function(e){t("throw",e,n,i)}):Promise.resolve(l).then(function(e){c.value=e,n(c)},function(e){return t("throw",e,n,i)})}i(a.arg)}(r,o,t,n)})}return t=t?t.then(n,n):n()}}function S(e,r){var s=e.iterator[r.method];if(s===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method))return p;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var o=u(s,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,p;var n=o.arg;return n?n.done?(r[e.resultName]=n.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,p):n:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function M(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function j(e){if(e){var r=e[n];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(s.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}return{next:U}}function U(){return{value:t,done:!0}}return g.prototype=w.constructor=b,b.constructor=g,b[a]=g.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},R(O.prototype),O.prototype[i]=function(){return this},e.AsyncIterator=O,e.async=function(t,r,s,o){var n=new O(c(t,r,s,o));return e.isGeneratorFunction(r)?n:n.next().then(function(e){return e.done?e.value:n.next()})},R(w),w[a]="Generator",w[n]=function(){return this},w.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var s=t.pop();if(s in e)return r.value=s,r.done=!1,r}return r.done=!0,r}},e.values=j,M.prototype={constructor:M,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var r in this)"t"===r.charAt(0)&&s.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(s,o){return a.type="throw",a.arg=e,r.next=s,o&&(r.method="next",r.arg=t),!!o}for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],a=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=s.call(i,"catchLoc"),u=s.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&s.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var i=n?n.completion:{};return i.type=e,i.arg=t,n?(this.method="next",this.next=n.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),L(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var s=r.completion;if("throw"===s.type){var o=s.arg;L(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,s){return this.delegate={iterator:j(e),resultName:r,nextLoc:s},"next"===this.method&&(this.arg=t),p}},e}(e.exports);try{regeneratorRuntime=s}catch(e){Function("r","regeneratorRuntime = r")(s)}},function(e,t,r){r(298),e.exports=r(121).global},function(e,t,r){var s=r(299);s(s.G,{global:r(86)})},function(e,t,r){var s=r(86),o=r(121),n=r(300),i=r(302),a=r(309),c=function(e,t,r){var u,l,d,h=e&c.F,y=e&c.G,p=e&c.S,f=e&c.P,g=e&c.B,b=e&c.W,m=y?o:o[t]||(o[t]={}),_=m.prototype,v=y?s:p?s[t]:(s[t]||{}).prototype;for(u in y&&(r=t),r)(l=!h&&v&&void 0!==v[u])&&a(m,u)||(d=l?v[u]:r[u],m[u]=y&&"function"!=typeof v[u]?r[u]:g&&l?n(d,s):b&&v[u]==d?function(e){var t=function(t,r,s){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,s)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(d):f&&"function"==typeof d?n(Function.call,d):d,f&&((m.virtual||(m.virtual={}))[u]=d,e&c.R&&_&&!_[u]&&i(_,u,d)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,e.exports=c},function(e,t,r){var s=r(301);e.exports=function(e,t,r){if(s(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,s){return e.call(t,r,s)};case 3:return function(r,s,o){return e.call(t,r,s,o)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,r){var s=r(303),o=r(308);e.exports=r(88)?function(e,t,r){return s.f(e,t,o(1,r))}:function(e,t,r){return e[t]=r,e}},function(e,t,r){var s=r(304),o=r(305),n=r(307),i=Object.defineProperty;t.f=r(88)?Object.defineProperty:function(e,t,r){if(s(e),t=n(t,!0),s(r),o)try{return i(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},function(e,t,r){var s=r(87);e.exports=function(e){if(!s(e))throw TypeError(e+" is not an object!");return e}},function(e,t,r){e.exports=!r(88)&&!r(122)(function(){return 7!=Object.defineProperty(r(306)("div"),"a",{get:function(){return 7}}).a})},function(e,t,r){var s=r(87),o=r(86).document,n=s(o)&&s(o.createElement);e.exports=function(e){return n?o.createElement(e):{}}},function(e,t,r){var s=r(87);e.exports=function(e,t){if(!s(e))return e;var r,o;if(t&&"function"==typeof(r=e.toString)&&!s(o=r.call(e)))return o;if("function"==typeof(r=e.valueOf)&&!s(o=r.call(e)))return o;if(!t&&"function"==typeof(r=e.toString)&&!s(o=r.call(e)))return o;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){var r={}.hasOwnProperty;e.exports=function(e,t){return r.call(e,t)}},function(e,t,r){"use strict";r.r(t);var s=r(0),o=r.n(s);const n=o.a.getLogger("address-allocation"),i=o.a.getLogger("Bus"),a=o.a.getLogger("MessageBus"),c=o.a.getLogger("CoreDiscovery"),u=o.a.getLogger("StorageManager"),l=o.a.getLogger("HypertyResourcesStorage"),d=o.a.getLogger("IdentityModule"),h=o.a.getLogger("PEP"),y=o.a.getLogger("P2PConnectionResolve"),p=o.a.getLogger("Registry"),f=o.a.getLogger("RuntimeUA"),g=o.a.getLogger("Loader"),b=o.a.getLogger("Descriptors"),m=o.a.getLogger("DataObjectsStorage"),_=o.a.getLogger("Subscription"),v=o.a.getLogger("SubscriptionManager"),w=o.a.getLogger("ObserverObject"),R=o.a.getLogger("ReporterObject"),O=o.a.getLogger("SynSubscription"),S=o.a.getLogger("SyncherManager"),P=o.a.getLogger("IdentityHandler"),L=o.a.getLogger("CryptoManager"),M=o.a.getLogger("Pipeline"),j=o.a.getLogger("Syncher");n.setLevel(0),i.setLevel(3),a.setLevel(3),c.setLevel(5),u.setLevel(0),l.setLevel(3),d.setLevel(0),h.setLevel(3),y.setLevel(3),p.setLevel(0),f.setLevel(0),g.setLevel(0),b.setLevel(3),m.setLevel(0),_.setLevel(3),v.setLevel(3),w.setLevel(0),R.setLevel(0),O.setLevel(3),S.setLevel(0),P.setLevel(3),L.setLevel(0),M.setLevel(0),j.setLevel(0),j.setLevel(0);let U={runtimeDescriptor:{},runtimeCapabilities:{constraints:{}}};function x(e){function t(e){return e.replace(/([a-zA-Z-]*)(:\/\/(?:\.)?|:)([-a-zA-Z0-9@:%._+~#=]{2,256})([-a-zA-Z0-9@:%._+~#=\/]*)/gi,"$1,$3,$4").split(",")}let r=t(e);if(r[0]===e&&!r[0].includes("@")){let t={type:"",domain:e,identity:""};return console.warn("[DivideURL] DivideURL don't support url without scheme. Please review your url address",e),t}return r[0]===e&&r[0].includes("@")&&(r=t((r[0]===e?"smtp":r[0])+"://"+r[0])),r[1].includes("@")&&(r[2]=r[0]+"://"+r[1],r[1]=r[1].substr(r[1].indexOf("@")+1)),{type:r[0],domain:r[1],identity:r[2]}}function C(e){return!(Object.keys(e).length>0)}function k(){return Math.floor(Date.now()/1e3)}function I(e){if(e)return JSON.parse(JSON.stringify(e))}function D(e){let t=e.split("/");return t[0]+"//"+t[2]+"/"+t[3]}function A(e){let t=x(e);return t.identity.replace("/","")+"@"+t.domain}function E(e){let t=e.split("://")[0];return-1===["domain-idp","runtime","domain","hyperty"].indexOf(t)}function T(e){return e.split("@").length>1}function H(e){return e.split("/").length>=3}function N(e){return"hyperty"===x(e).type}function F(e,t,r){return e[t][r]}function B(e,t,r,s,o=!1){let n,i=e[t];if(!i.hasOwnProperty(r))throw Error("The configuration "+JSON.stringify(i,"",2)+" don't have the "+r+" resource you are looking for");let a=i[r];if(r){let t="idp-proxy"===r?".idp.js":".ps.js";n=a.prefix+e.domain+a.suffix+s,a.hasOwnProperty("fallback")&&o&&(n=a.fallback.indexOf("%domain%")?a.fallback.replace(/(%domain%)/g,e.domain)+s+t:a.fallback+s)}else n=a.prefix+e.domain+a.suffix;return n}function K(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function G(e){let t,r=x(e),s=r.domain.split("."),o=["registry","msg-node"];return s.length>1&&(t=s.filter(e=>-1!==o.indexOf(e))[0]),!(!t||-1===o.indexOf(t))||!!r.type&&-1!==["domain","global","domain-idp"].indexOf(r.type)}function q(e,t,r){e||(e={}),"string"==typeof t&&(t=W(t));let s=t.length-1;for(var o=0;o<s;++o){let r=t[o];r in e||(e[r]={}),e=e[r]}e[t[s]]=r}function V(e){console.info("[utils - splitObjectURL]: ",e);let t=e.split("/"),r={url:t[0]+"//"+t[2]+"/"+t[3],resource:t[5]};return console.info("[utils - splitObjectURL]: ",r),r}function W(e){let t=/([0-9a-zA-Z][-\w]*):\/\//g;if(e.includes("://")){let r=e.split(t)[0],s=r.split("."),o=e.replace(r,"");if(e.includes("identity")){let e=o.split("identity.");console.log("array2 "+e),o=e[0].slice(".",-1),e=e[1].split("."),s.push(o,"identity"),s=s.concat(e)}else s.push(o);return s.filter(Boolean)}return e.split(".")}function J(e){let t={},r=Object.keys(e);if(r)try{for(let s=0;s<r.length;s++){let o=r[s];t[o]={},t[o].sessionKey=e[o].sessionKey.toString(),t[o].isToEncrypt=e[o].isToEncrypt}}catch(e){console.error("_chatkeysToStringCloner:err",e)}return t}function Y(e){let t={},r=Object.keys(e);if(r)try{for(let s=0;s<r.length;s++){let o=r[s];t[o]={};let n=JSON.parse("["+e[o].sessionKey+"]");t[o].sessionKey=new Uint8Array(n),t[o].isToEncrypt=e[o].isToEncrypt}}catch(e){console.error("_chatkeysToArrayCloner:err",e)}return t}function z(e){let t=e.split("/");return t.length<=6?t[0]+"//"+t[2]+"/"+t[3]:t[0]+"//"+t[2]+"/"+t[3]+"/"+t[4]}function $(e,t){const r=(e/t).toFixed(2);return{quota:t,usage:e,percent:Number(r)}}function Q(e){try{let t=ee(e);return btoa(t)}catch(e){throw console.error("[Utils.encode:err] "+e),e}}function X(e){try{return JSON.parse(atob(e))}catch(e){throw console.log("[Utils.decode:err] "+e),e}}function Z(e){try{return new Uint8Array(X(e))}catch(e){throw console.error("[Utils.decodeToUint8Array:err] "+e),e}}function ee(e){try{let t;return t=e.constructor===Uint8Array?"["+e.toString()+"]":JSON.stringify(e)}catch(e){throw console.error("[Utils.stringify:err] "+e),e}}function te(e){try{return JSON.parse(e)}catch(t){throw console.error("[Utils.parse:err]"+t),console.trace(),console.error("That that cause the error:",e),t}}function re(e){try{return new Uint8Array(te(e))}catch(e){throw console.error("[Utils.parseToUint8Array:err]"+e),e}}r(89);let se="update",oe="add",ne="remove",ie="object",ae="array";var ce=class{constructor(e){this._observers=[],this._filters={},this._data=e||{},this._internalObserve(this._data)}get data(){return this._data}observe(e){this._observers.push(e)}find(e){let t=W(e);return this._findWithSplit(t)}findBefore(e){let t={},r=W(e);return t.last=r.pop(),t.obj=this._findWithSplit(r),t}_findWithSplit(e){let t=this._data;return e.forEach(e=>{t=t[e]}),t}_internalObserve(e){this._data=Object.deepObserve(e,e=>{e.every(e=>{this._onChanges(e)})})}_fireEvent(e){this._observers.forEach(t=>{t(e)})}_onChanges(e){let t,r=e.object;r.constructor===Object&&(t=ie),r.constructor===Array&&(t=ae);let s=e.keypath,o=r[e.name];"update"!==e.type||s.includes(".length")||this._fireEvent({cType:se,oType:t,field:s,data:o}),"add"===e.type&&this._fireEvent({cType:oe,oType:t,field:s,data:o}),"delete"===e.type&&this._fireEvent({cType:ne,oType:t,field:s})}};let ue=s.getLogger("DataObjectChild");var le=class{constructor(e){let t=this;function r(e){throw"[DataObjectChild] "+e+" mandatory parameter is missing"}e.parent?t._parent=e.parent:r("parent"),e.url?t._url=e.url:r("url"),e.created?t._created=e.created:r("created"),e.reporter?t._reporter=e.reporter:r("reporter"),e.runtime?t._runtime=e.runtime:r("runtime"),e.schema?t._schema=e.schema:r("schema"),e.parentObject?t._parentObject=e.parentObject:r("parentObject"),e.name&&(t._name=e.name),e.description&&(t._description=e.description),e.tags&&(t._tags=e.tags),e.resources&&(t._resources=e.resources),e.observerStorage&&(t._observerStorage=e.observerStorage),e.publicObservation&&(t._publicObservation=e.publicObservation),t._childId=e.url,e.data?t._syncObj=new ce(e.data):t._syncObj=new ce({}),ue.log("[DataObjectChild -  Constructor] - ",t._syncObj),t._bus=t._parentObject._bus,t._owner=t._parentObject._owner,t._allocateListeners(),t._metadata=e,delete t._metadata.parentObject,t._sharingStatus=!1}get shareable(){let e=this.metadata;return e.data=this.data,e}share(e){let t=this;t._sharingStatus=new Promise((r,s)=>{let o;o=e?t.metadata.parent:t.metadata.parent+"/children/";let n=t.metadata;n.data=t.data;let i={type:"create",from:t.metadata.reporter,to:o,body:{resource:n.url,value:n}};if(t.identity&&(i.body.identity=t.identity),t._parentObject.data.hasOwnProperty("mutual")&&(i.body.mutual=t._parentObject.data.mutual),t._parentObject.metadata.reporter===t.metadata.reporter)return t._bus.postMessage(I(i)),r();{let e=e=>{if(e.to===t._reporter){t._bus.removeResponseListener(i.from,e.id),ue.log("[Syncher.DataObjectChild.share] Parent reporter reply ",e);let o={code:e.body&&e.body.code?e.body.code:500,desc:e.body&&e.body.desc?e.body.desc:"Unknown"};return e.body.code<300?r(o):s(o)}},o=t._bus.postMessage(I(i),e,!1);setTimeout(()=>(t._bus.removeResponseListener(i.from,o),s({code:408,desc:"timout"})),3e3)}})}store(){let e={},t=this.metadata.children+"."+this.metadata.url;e.value=this.metadata,e.identity=this.identity;let r={from:this.metadata.reporter,to:this._parentObject._syncher._subURL,type:"create",body:{resource:this.metadata.parent,attribute:t,value:e}};ue.log("[DataObjectChild.store]:",r),this._bus.postMessage(r)}_allocateListeners(){let e=this;e._reporter===e._owner&&(e._listener=e._bus.addListener(e._reporter,t=>{"response"===t.type&&t.id===e._msgId&&(ue.log("DataObjectChild.onResponse:",t),e._onResponse(t))}))}_releaseListeners(){this._listener&&this._listener.remove()}delete(){this._releaseListeners()}get metadata(){return this._metadata}get childId(){return this._childId}get sharingStatus(){return this._sharingStatus}get data(){return this._syncObj.data}set identity(e){this._identity=e}get identity(){return this._identity}onChange(e){this._syncObj.observe(t=>{ue.log("[DataObjectChild - observer] - ",t),e(t)})}onResponse(e){this._onResponseHandler=e}_onResponse(e){let t={type:e.type,url:e.body.source,code:e.body.code};this._onResponseHandler&&this._onResponseHandler(t)}};let de=s.getLogger("HypertyResource");var he=class extends le{constructor(e,t){super(t),this.arraybufferSizeLimit=5242880,this._isSender=e,this._localStorageURL=this._parentObject._syncher._runtimeUrl+"/storage"}get resourceType(){return this.metadata.resourceType}get mimetype(){return this._metadata.type}get content(){return this._content}get contentURL(){return this._metadata.contentURL}get shareable(){let e=super.metadata;return e.resourceType=this.resourceType,e}save(){let e=this;return new Promise(function(t,r){let s={from:e._owner,to:e._localStorageURL,type:"create",body:{value:I(e._metadata)}};s.body.value.content=e._content,e._bus.postMessage(s,s=>{de.info("[HypertyResource.save] reply: ",s),e._bus.removeResponseListener(e._owner,s.id),200===s.body.code?(s.body.value&&(e._metadata.contentURL||(e._metadata.contentURL=[]),e._metadata.contentURL.push(s.body.value)),t()):r(s.body.code+" "+s.body.desc)},!1)})}read(e){let t=this;return de.info("[HypertyResource.read] ",this),new Promise(function(r,s){if(t.content)r(t);else{let o=t._getBestContentURL(t._metadata.contentURL);de.log("Storage:",o);let n={from:t._owner,to:o.url,type:"read",body:{resource:o.url+"/"+o.resource,p2p:!0}};t.metadata.p2pRequester&&t.metadata.p2pHandler&&(n.body.p2pRequester=t.metadata.p2pRequester,n.body.p2pHandler=t.metadata.p2pHandler),t._getBestResource(n,e).then(e=>{de.info("[HypertyResource] - get locally the resource:",e),r(t)}).catch(n=>{de.warn("[HypertyResource] - get locally the resource fail",n);let i={from:t._owner,to:o.remoteURL,type:"read",body:{resource:o.remoteURL+"/"+o.resource,p2p:!0}};t.metadata.p2pRequester&&t.metadata.p2pHandler&&(i.body.p2pRequester=t.metadata.p2pRequester,i.body.p2pHandler=t.metadata.p2pHandler),t._getBestResource(i,e).then(e=>{de.warn("[HypertyResource] - get remotely the resource",e),r(t)}).catch(e=>{de.warn("[HypertyResource] - get remotely the resource fail",e),s(e.body.code+" "+e.body.desc)})})}})}_getBestResource(e,t){let r=this;return new Promise((s,o)=>{let n=setTimeout(()=>(r._bus.removeResponseListener(r._owner,i),e.body.code=408,e.body.desc="Response timeout",o(e)),3e3),i=r._bus.postMessage(e,e=>{de.log("[HypertyResource.read] reply: ",e);let i=e.id;switch(clearTimeout(n),e.body.code){case 200:r._content=e.body.value.content,e.body.value.size<r.arraybufferSizeLimit&&r.save(),r._bus.removeResponseListener(r._owner,i),s(e);break;case 183:t(e.body.value);break;default:r._bus.removeResponseListener(r._owner,i),o(e)}},!1)})}delete(){let e=this;de.info("[HypertyResource.delete]",e.metadata);let t={from:e._owner,to:e._localStorageURL,type:"delete",body:{resources:e.metadata.contentURL}};return new Promise(r=>{e._bus.postMessage(t,e=>{e.body.code<300?r(!0):r(!1)})})}_getBestContentURL(e){const t=e[0],r=t.substr(t.lastIndexOf("/")+1);return{url:this._localStorageURL,resource:r,remoteURL:t.substr(0,t.lastIndexOf("/"))}}};let ye="undefined"!=typeof Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),pe=ye&&"undefined"!=typeof Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),fe="undefined"!=typeof HTMLCanvasElement&&HTMLCanvasElement.prototype.toBlob,ge=fe||"undefined"!=typeof Uint8Array&&"undefined"!=typeof ArrayBuffer&&"undefined"!=typeof atob,be="undefined"!=typeof FileReader||"undefined"!=typeof URL;class me{static resize(e,t,r){if("function"==typeof t&&(r=t,t={width:640,height:480}),t.width,t.height,!me.isSupported()||!e.type.match(/image.*/))return r(e,!1),!1;if(e.type.match(/image\/gif/))return r(e,!1),!1;let s=document.createElement("img");return s.onload=o=>{let n=s.width,i=s.height,a=!1;if(n>=i&&n>t.width?(i*=t.width/n,n=t.width,a=!0):i>t.height&&(n*=t.height/i,i=t.height,a=!0),!a)return void r(e,!1);let c=document.createElement("canvas");if(c.width=n,c.height=i,c.getContext("2d").drawImage(s,0,0,n,i),fe)c.toBlob(e=>{r(e,!0)},e.type);else{let t=me._toBlob(c,e.type);r(t,!0)}},me._loadImage(s,e),!0}static _toBlob(e,t){let r,s=e.toDataURL(t).split(",");r=s[0].indexOf("base64")>=0?atob(s[1]):decodeURIComponent(s[1]);let o=new ArrayBuffer(r.length),n=new Uint8Array(o);for(let e=0;e<r.length;e+=1)n[e]=r.charCodeAt(e);let i=s[0].split(":")[1].split(";")[0],a=null;if(ye)a=new Blob([pe?n:o],{type:i});else{let e=new BlobBuilder;e.append(o),a=e.getBlob(i)}return a}static _loadImage(e,t,r){if("undefined"==typeof URL){let s=new FileReader;s.onload=function(t){e.src=t.target.result,r&&r()},s.readAsDataURL(t)}else e.src=URL.createObjectURL(t),r&&r()}static isSupported(){return"undefined"!=typeof HTMLCanvasElement&&ge&&be}}let _e=s.getLogger("FileHypertyResource");var ve=class extends he{constructor(e,t){super(e,t),this.metadata.resourceType="file"}init(e){let t=this;if(!e)throw new Error("[FileHypertyResource.constructor] missing mandatory *file* input ");return new Promise(function(r,s){if(t._metadata.name=e.name,t._metadata.lastModified=e.lastModified,t._metadata.size=e.size,t._metadata.mimetype=e.type,_e.log("[FileHypertyResource.init] file: ",e),t._isSender)switch(e.type.split("/")[0]){case"image":t._getImagePreview(e).then(s=>{t._metadata.preview=s,t._content=e,r()});break;default:t._content=e,r()}else t._content=e.content,e.preview&&(t._metadata.preview=e.preview),r()})}_getImagePreview(e){let t=new FileReader;return new Promise((r,s)=>{me.resize(e,{width:100,height:100},function(e,s){s?(t.readAsDataURL(e),t.onload=function(e){r(e.target.result)}):(_e.warn("[FileHypertyResource._getImagePreview] unable to create image preview from original image "),r(void 0))})})}get name(){return this._metadata.name}get preview(){return this._metadata.preview}toMessage(){}};let we=s.getLogger("DataObject");var Re=class{constructor(e){let t=this;function r(e){throw"[DataObject] "+e+" mandatory parameter is missing"}e.syncher?t._syncher=e.syncher:r("syncher"),e.url?t._url=e.url:r("url"),e.created?t._created=e.created:r("created"),e.reporter?t._reporter=e.reporter:r("reporter"),e.runtime?t._runtime=e.runtime:r("runtime"),e.schema?t._schema=e.schema:r("schema"),e.name?t._name=e.name:r("name"),t._status=e.status,e.data?t._syncObj=new ce(e.data):t._syncObj=new ce({}),t._childrens=e.childrens,t._mutual=e.mutual,t._version=0,t._childId=1,t._childrenListener,t._onAddChildrenHandler,t._resumed=e.resume,e.resume&&(t._version=e.version),t._owner=e.syncher._owner,t._bus=e.syncher._bus,e.description&&(t._description=e.description),e.tags&&(t._tags=e.tags),e.resources&&(t._resources=e.resources),e.observerStorage&&(t._observerStorage=e.observerStorage),e.publicObservation&&(t._publicObservation=e.publicObservation),t._metadata=Object.assign(e),(!e.hasOwnProperty("resume")||e.hasOwnProperty("resume")&&!e.resume)&&(t._metadata.lastModified=t._metadata.created),delete t._metadata.data,delete t._metadata.syncher,delete t._metadata.authorise,t._hypertyResourceFactory=new class{constructor(){}createHypertyResource(e,t,r){let s;switch(t){case"file":s=new ve(e,r);break;default:throw new Error("[HypertyResourceFactory.createHypertyResource] not supported type: ",t)}return s}createHypertyResourceWithContent(e,t,r,s){let o;return new Promise(n=>{switch(t){case"file":o=new ve(e,s);break;default:reject()}o.init(r).then(()=>o.save()).then(()=>{n(o)})})}},t._childrenObjects={},t._sharedChilds=[]}_getLastChildId(){let e=this,t=e._owner+"#0";return Object.keys(e._childrens).filter(r=>{e._childrens[r].childId>t&&(t=e._childrens[r].childId)}),Number(t.split("#")[1])}_allocateListeners(){let e=this,t=e._url+"/children/";if(we.log("[Data Object - AllocateListeners] - ",e._childrens),e._childrens){let r=t,s=e._bus.addListener(r,t=>{if(t.from!==this._owner)switch(console.log("DataObject-Children-RCV: ",t),t.type){case"create":e._onChildCreate(t);break;case"event":e._onEvent(t);break;case"delete":we.log(t);break;default:e._changeChildren(t)}e._childrenListener=s})}}_releaseListeners(){let e=this;e._childrenListener&&(e._childrenListener.remove(),Object.keys(e._childrenObjects).forEach(t=>{e._childrenObjects[t]._releaseListeners()}))}sync(){let e=this;return we.info("[DataObject.sync] synchronising "),new Promise((t,r)=>{e._syncher.read(e._metadata.url,{}).then(r=>{console.log("[DataObject.sync] value to sync: ",r),Object.assign(e.data,I(r.data)),e._version=r.version,e._metadata.lastModified=r.lastModified,r.childrenObjects?(e.resumeChildrens(r.childrenObjects),t(!0)):t(!0)}).catch(e=>{we.info("[DataObject.sync] sync failed: ",e),t(!1)})})}resumeChildrens(e){let t=this,r=this._owner.split("/")[3]+"#"+this._childId,s=e;Object.keys(s).forEach(e=>{let o=!1;"heartbeat"===e||(s[e].hasOwnProperty("value")&&s[e].value.resourceType&&!t._childrenObjects.hasOwnProperty(e)?(t._childrenObjects[e]=t._resumeHypertyResource(s[e]),o=!0):t._childrenObjects.hasOwnProperty(e)||(t._childrenObjects[e]=t._resumeChild(s[e]),we.log("[DataObject.resumeChildrens] new DataObjectChild: ",t._childrenObjects[e]),o=!0)),o&&e>r&&(r=e,we.log("[DataObjectReporter.resumeChildrens] - resuming: ",this._childrenObjects[e]))}),this._childId=Number(r.split("#")[1])}_resumeChild(e){let t=e.value;t.parentObject=this,t.parent=this._url;let r=new le(t);r.identity=e.identity;let s={type:"create",from:r.reporter,url:r.parent,value:r.data,childId:r.url,identity:r.identity,child:r};return r.resourceType&&(s.resource=r),this._onAddChildrenHandler&&this._onAddChildrenHandler(s),r}_resumeHypertyResource(e){let t=e.value;t.parentObject=this,t.parent=this._url;let r=this._hypertyResourceFactory.createHypertyResource(!1,t.resourceType,t);r.identity=e.identity;let s={type:"create",from:r.reporter,url:r.parent,value:r.data,childId:r.url,identity:r.identity,child:r};return r.resourceType&&(s.resource=r),this._onAddChildrenHandler&&this._onAddChildrenHandler(s),r}get metadata(){return this._metadata}get url(){return this._url}get schema(){return this._schema}get status(){return this._status}get data(){return this._syncObj.data}get childrens(){return this._childrenObjects}pause(){throw"Not implemented"}resume(){throw"Not implemented"}stop(){throw"Not implemented"}addChild(e,t,r){let s,o=this;return new Promise(n=>{let i=o._url+"/children/",a=o._getChildInput(r);a.data=e,s=new le(a),t&&(s.identity=t),s.share(),console.log("[DataObject.addChild] added ",s),s.onChange(e=>{o._onChange(e,{path:i,childId:a.url})}),o._childrenObjects[a.url]=s,n(s)})}_deleteChildrens(){let e=this,t=[];return new Promise(r=>{if(e.childrens){let s;for(s in we.log("[DataObject.deleteChildrens]",e.childrens),e.childrens){let r=e.childrens[s];we.log("[DataObject._deleteChildrens] child",r),r.metadata.hasOwnProperty("resourceType")&&t.push(e.childrens[s].delete())}we.log("[DataObject._deleteChildrens] promises ",t),t.length>0?Promise.all(t).then(()=>{r("[DataObject._deleteChildrens] done")}):r("[DataObject._deleteChildrens] nothing to delete")}})}_getChildInput(e){let t=Object.assign({},e);this._childId++;let r=Math.floor(Date.now());return console.log("[DataObject._getChildInput] start ",r),t.url=r+"-"+this._owner.split("/")[3]+"#"+this._childId,t.parentObject=this,t.reporter=this._owner,t.created=(new Date).toISOString(),t.runtime=this._syncher._runtimeUrl,t.p2pHandler=this._syncher._p2pHandler,t.p2pRequester=this._syncher._p2pRequester,t.schema=this._schema,t.parent=this.url,t.mutual=this.metadata.mutual,t}addHypertyResource(e,t,r,s){let o=this;return new Promise(n=>{let i,a=o._url+"/children/",c=o._getChildInput(s);o._hypertyResourceFactory.createHypertyResourceWithContent(!0,e,t,c).then(e=>{i=e,r&&(i.identity=r),i.share(),we.log("[DataObject.addHypertyResource] added ",i),i.onChange(e=>{o._onChange(e,{path:a,childId:i.childId})}),o._childrenObjects[i.childId]=i,n(i)})})}onAddChild(e){this._onAddChildrenHandler=e}onEvent(e){this._onEventHandler=e}sendEvent(e){let t={from:this._owner,to:this._url+"/children/",type:"event",body:{value:e}};this._bus.postMessage(t)}_onEvent(e){let t={from:e.from,value:e.body.value,identity:e.body.identity};this._onEventHandler&&this._onEventHandler(t)}_onChildCreate(e){let t=this;if("heartbeat"===e.body.resource);else{console.log("[DataObject._onChildCreate] new child receivedBy "+t._owner+" : ",e);let r={from:e.to,to:e.from,type:"response",id:e.id,body:{code:100}};t._bus.postMessage(r),e.body.value.resourceType?t._onHypertyResourceAdded(e):t._onChildAdded(e)}}_onChildAdded(e){let t=I(e.body.value);t.parentObject=this;let r=new le(t);r.identity=e.body.identity,this._childrenObjects[t.url]=r,e.to===this.metadata.url&&r.store(),this._hypertyEvt(e,r)}_onHypertyResourceAdded(e){let t,r=e.body.value;r.parentObject=this,(t=this._hypertyResourceFactory.createHypertyResource(!1,r.resourceType,r)).identity=e.body.identity,this._childrenObjects[t.childId]=t,this._hypertyEvt(e,t),e.to===this.metadata.url&&t.store()}_hypertyEvt(e,t){let r={type:e.type,from:e.from,url:e.to,value:t.data,childId:t.url,identity:e.body.identity,child:t};t.resourceType&&(r.resource=t),this._onAddChildrenHandler&&this._onAddChildrenHandler(r)}_onChange(e,t){let r=this;if(r._metadata.lastModified=(new Date).toISOString(),r._version++,"live"===r._status){let s={type:"update",from:r._url,to:r._url+"/changes",body:{version:r._version,source:r._owner,attribute:e.field,lastModified:r._metadata.lastModified}};we.log("[DataObject - _onChange] - ",e,t,s),e.oType===ie?e.cType!==ne&&(s.body.value=I(e.data)):(s.body.attributeType=e.oType,s.body.value=e.data,e.cType!==se&&(s.body.operation=e.cType)),t&&(s.to=t.path,s.body.resource=t.childId),r.data._mutual||(s.body.mutual=r._mutual),r._bus.postMessage(s)}}_changeObject(e,t){let r=this;if(r._version+1<=t.body.version){r._version=t.body.version;let s,o=t.body.attribute;s="object"==typeof t.body.value?I(t.body.value):t.body.value;let n=e.findBefore(o);if(t.body.lastModified?r._metadata.lastModified=t.body.lastModified:r._metadata.lastModified=(new Date).toISOString(),t.body.attributeType===ae)if(t.body.operation===oe){let e=n.obj,t=n.last;Array.prototype.splice.apply(e,[t,0].concat(s))}else if(t.body.operation===ne){let e=n.obj,t=n.last;e.splice(t,s)}else n.obj[n.last]=s;else t.body.hasOwnProperty("value")?n.obj[n.last]=s:delete n.obj[n.last]}else we.log("UNSYNCHRONIZED VERSION: (data => "+r._version+", msg => "+t.body.version+")")}_changeChildren(e){let t=this;x(e.to).identity;let r=e.body.resource,s=t._childrenObjects[r];we.log("Change children: ",t._owner,e,resource),s?t._changeObject(s._syncObj,e):we.warn("No children found for: ",r)}};let Oe=s.getLogger("DataObjectReporter");var Se=class extends Re{constructor(e){super(e);let t=this;t._subscriptions={},t._syncObj.observe(e=>{Oe.log("[Syncher.DataObjectReporter] "+t.url+" publish change: ",e),t._onChange(e)}),t._allocateListeners(),t.invitations=[],t._childrenSizeThreshold=5e4}_allocateListeners(){super._allocateListeners();let e=this;e._objectListener=e._bus.addListener(e._url,t=>{switch(Oe.log("[Syncher.DataObjectReporter] listener "+e._url+" Received: ",t),t.type){case"response":e._onResponse(t);break;case"read":e._onRead(t);break;case"execute":e._onExecute(t);break;case"create":e._onChildCreate(t)}}),e._runtimeStatusListener=e._bus.addListener(e._syncher._runtimeUrl+"/status",e=>{console.log("[Syncher.DataObjectReporter] runtime status event received "+e)})}_releaseListeners(){super._releaseListeners(),this._objectListener.remove()}inviteObservers(e,t){let r=this,s=e;s.length>0&&(Oe.log("[Syncher.DataObjectReporter] InviteObservers ",s,r._metadata),s.forEach(e=>{let s=new Promise((s,o)=>{let n={type:"create",from:r._syncher._owner,to:r._syncher._subURL,body:{resume:!1,resource:r._url,schema:r._schema,value:r._metadata,authorise:[e]}};t&&(n.body.p2p=t),r.data.mutual||(n.body.mutual=r.data.mutual),r._bus.postMessage(n,t=>{Oe.log("[Syncher.DataObjectReporter] Invitation reply ",t);let r={invited:e,code:t.body&&t.body.code?t.body.code:500,desc:t.body&&t.body.desc?t.body.desc:"Unknown"};r.code<300?s(r):o(r)})});r.invitations.push(s)}))}delete(){let e=this;e._heartBeat&&e._heartBeat.stop(),e._deleteChildrens().then(t=>{Oe.log(t);let r={type:"delete",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(r,t=>{Oe.log("DataObjectReporter-DELETE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._reporters[e._url],e._syncObj={})})})}get subscriptions(){return this._subscriptions}onSubscription(e){this._onSubscriptionHandler=e}onResponse(e){this._onResponseHandler=e}onRead(e){this._onReadHandler=e}onExecute(e){this._onExecuteHandler=e}_onForward(e){let t=this;switch(Oe.log("DataObjectReporter-RCV: ",e),e.body.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnSubscribe(e)}}_onSubscribe(e){let t=this,r=e.body.from,s=x(r),o=s.domain,n=!0;e.body.hasOwnProperty("mutual")&&!e.body.mutual&&(n=!1),console.log("[DataObjectReporter._onSubscribe]",e,o,s);let i={type:e.body.type,url:r,domain:o,identity:e.body.identity,nutual:n,accept:()=>{let s={url:r,status:"live"};t._subscriptions[r]=s,t.metadata.subscriptions&&t.metadata.subscriptions.push(s.url);let o=I(t._metadata);o.data=I(t.data),o.version=t._version;let n={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,schema:t._schema,value:o}};return e.body.hasOwnProperty("mutual")&&!e.body.mutual&&(n.body.mutual=e.body.mutual,t.data.mutual=!1),t._heartBeat&&(n.body.value.childrenObjects={},n.body.value.childrenObjects.heartbeat=t._heartBeat.heartbeat),console.log("[DataObjectReporter._onSubscribe.accept] sending response: ",n),t._bus.postMessage(n),s},reject:r=>{t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:403,desc:r}})}};t._onSubscriptionHandler&&(Oe.log("SUBSCRIPTION-EVENT: ",i),t._onSubscriptionHandler(i))}_onUnSubscribe(e){let t=this,r=e.body.from,s=x(r),o=s.domain;Oe.log("[DataObjectReporter._onUnSubscribe]",e,o,s),delete t._subscriptions[r],delete t.invitations[r];let n={type:e.body.type,url:r,domain:o,identity:e.body.identity};t._onSubscriptionHandler&&(Oe.log("UN-SUBSCRIPTION-EVENT: ",n),t._onSubscriptionHandler(n))}_onResponse(e){let t={type:e.type,url:e.from,code:e.body.code};this._onResponseHandler&&(Oe.log("RESPONSE-EVENT: ",t),this._onResponseHandler(t))}_onRead(e){let t=this,r=JSON.stringify(t.childrensJSON).length>t._childrenSizeThreshold,s={type:e.type,url:e.from,accept:()=>{r?t._syncReplyForLargeData(e):t._syncReply(e)},reject:r=>{t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:401,desc:r}})}},o=[];t.metadata.subscriptions?o=t.metadata.subscriptions:t._subscriptions&&(o=Object.keys(t._subscriptions).map(function(e){return t._subscriptions[e].url})),-1!=o.indexOf(e.from)?r?t._syncReplyForLargeData(e):t._syncReply(e):t._onReadHandler&&(Oe.log("READ-EVENT: ",s),t._onReadHandler(s))}get childrensJSON(){let e,t=this,r={};for(e in t._childrenObjects)r[e]={},r[e].value=t._childrenObjects[e].metadata,r[e].identity=t._childrenObjects[e].identity;return r}_syncReply(e){let t=I(this.metadata);t.data=I(this.data),t.childrenObjects=I(this.childrensJSON),t.version=this._version;let r={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:t}};this._bus.postMessage(r)}_syncReplyForLargeData(e){let t=this,r=I(t.metadata);r.data=I(t.data),r.version=t._version,delete r.childrenObjects;let s=[],o={};for(child in t._childrenObjects)o[child]={},JSON.stringify(o).length>t._childrenSizeThreshold&&s.push(o),o[child]={},o[child].value=t._childrenObjects[child].metadata,o[child].identity=t._childrenObjects[child].identity;s.push(o),r.responses=s.length+1;let n={id:e.id,type:"response",from:e.to,to:e.from,body:{code:100,value:r}};t._bus.postMessage(n),s.forEach(e=>{let s=I(n);s.body.value=e,s.body.value.responses=r.responses,setTimeout(()=>{t._bus.postMessage(s)},50)})}_onExecute(e){let t=this;if(!e.body.method)throw e;let r={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}},s={type:e.type,url:e.from,method:e.body.method,params:e.body.params,accept:()=>{t._bus.postMessage(r)},reject:r=>{t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:401,desc:r}})}};t._onExecuteHandler&&(Oe.log("[DataObjectReporter] EXECUTE-EVENT: ",s),t._onExecuteHandler(s))}};let Pe=s.getLogger("DataObjectObserver"),Le="any",Me="start",je="exact";var Ue=class extends Re{constructor(e){super(e);let t=this;t._version=e.version,t._filters={},t._syncObj.observe(e=>{t._onFilter(e)}),t._allocateListeners()}sync(){let e=this;return Pe.info("[DataObjectObserver_sync] synchronising "),new Promise((t,r)=>{e._syncher.read(e._metadata.url,{}).then(r=>{Pe.info("[DataObjectObserver_sync] value to sync: ",r),Object.assign(e.data,I(r.data)),e._version=r.version,e._metadata.lastModified=r.lastModified,r.childrenObjects?(e.resumeChildrens(r.childrenObjects),e._storeChildrens(),t(!0)):t(!0)}).catch(e=>{Pe.info("[DataObjectObserver_sync] sync failed: ",e),t(!1)})})}_storeChildrens(){let e=this,t={};Object.keys(e._childrenObjects).forEach(r=>{let s=e._childrenObjects;t[r]={},t[r].value=s[r].metadata,t[r].identity=s[r].identity});let r={from:e._owner,to:e._syncher._subURL,type:"create",body:{resource:e._url,attribute:"childrenObjects",value:t}};e._bus.postMessage(r)}_allocateListeners(){super._allocateListeners();let e=this;e._changeListener=e._bus.addListener(e._url+"/changes",t=>{"update"===t.type&&(Pe.log("DataObjectObserver-"+e._url+"-RCV: ",t),e._changeObject(e._syncObj,t))})}_releaseListeners(){super._releaseListeners(),this._changeListener.remove()}delete(){let e=this;e._heartBeat&&e._heartBeat.stop(),e._deleteChildrens().then(()=>{e.unsubscribe(),e._releaseListeners(),delete e._syncher._observers[e._url]})}unsubscribe(){let e=this,t={type:"unsubscribe",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(t,t=>{Pe.log("DataObjectObserver-UNSUBSCRIBE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._observers[e._url])})}onChange(e,t){let r=e,s={type:je,callback:t},o=e.indexOf("*");o===e.length-1&&(0===o?s.type=Le:(s.type=Me,r=e.substr(0,e.length-1))),this._filters[r]=s}_onFilter(e){let t=this;Object.keys(t._filters).forEach(r=>{let s=t._filters[r];s.type===Le?s.callback(e):s.type===Me?0===e.field.indexOf(r)&&s.callback(e):s.type===je&&e.field===r&&s.callback(e)})}onDisconnected(e){return new Promise((t,r)=>{this._subscribeRegistration().then(()=>{this._onDisconnected=e,t()}).catch(e=>r(e))})}_subscribeRegistration(){const e={type:"subscribe",from:this._owner,to:this._syncher._runtimeUrl+"/subscriptions",body:{resources:[this._url+"/registration"]}};return new Promise((t,r)=>{this._bus.postMessage(e,e=>{Pe.log(`[DataObjectObserver._subscribeRegistration] ${this._url} rcved reply `,e),200===e.body.code?(this._generateListener(this._url+"/registration"),t()):(Pe.error("Error subscribing registration status for ",this._url),r("Error subscribing registration status for "+this._url))})})}_generateListener(e){let t=this;t._bus.addListener(e,e=>{Pe.log(`[DataObjectObserver.registrationNotification] ${t._url}: `,e),e.body.value&&"disconnected"===e.body.value&&t._onDisconnected&&(Pe.log(`[DataObjectObserver] ${t._url}: was disconnected `,e),t._onDisconnected())})}execute(e,t){let r=this;return new Promise((s,o)=>{const n={type:"execute",from:this._owner,to:r._url,body:{method:e,params:t}};r._bus.postMessage(n,t=>{Pe.log(`[DataObjectObserver.execute] ${r._url} rcved reply `,t),200===t.body.code?s():(Pe.warn(`[DataObjectObserver.execute] execution of method ${e} was reject by reporter`),o(`[DataObjectObserver.execute] execution of method ${e} was reject by reporter`))})})}};let xe=s.getLogger("DataProvisional");var Ce=class{constructor(e,t,r,s){this._owner=e,this._url=t,this._bus=r,this._children=s,this._changes=[],this._allocateListeners()}_allocateListeners(){let e=this;e._listener=e._bus.addListener(e._url,t=>{xe.log("DataProvisional-"+e._url+"-RCV: ",t),e._changes.push(t)})}_releaseListeners(){this._listener.remove()}get children(){return this._children}apply(e){this._changes.forEach(t=>{e._changeObject(e._syncObj,t)})}};let ke=s.getLogger("Syncher");let Ie=s.getLogger("RegistrationStatus");var De=class{constructor(e,t,r,s){this._registryObjectURL=e,this._runtimeURL=t,this._domain=x(t).domain,this._discoveredObjectURL=r,this._messageBus=s,this._subscriptionSet=!1,this._subscribers={live:{},disconnected:{}}}onLive(e,t){return new Promise((r,s)=>{this._subscriptionSet?(this._subscribers.live[e]=t,r()):this._subscribe().then(()=>{this._subscribers.live[e]=t,r()}).catch(e=>s(e))})}onDisconnected(e,t){return new Promise((r,s)=>{this._subscriptionSet?(this._subscribers.disconnected[e]=t,r()):this._subscribe().then(()=>{this._subscribers.disconnected[e]=t,r()}).catch(e=>s(e))})}_subscribe(){const e={type:"subscribe",from:this._discoveredObjectURL,to:this._runtimeURL+"/subscriptions",body:{resources:[this._registryObjectURL+"/registration"]}};return new Promise((t,r)=>{this._messageBus.postMessage(e,e=>{Ie.log(`[DiscoveredObject.subscribe] ${this._registryObjectURL} rcved reply `,e),200===e.body.code?(this._generateListener(this._registryObjectURL+"/registration"),this._subscriptionSet=!0,t()):(Ie.error("Error subscribing ",this._registryObjectURL),r("Error subscribing "+this._registryObjectURL))})})}_generateListener(e){this._messageBus.addListener(e,e=>{Ie.log(`[DiscoveredObject.notification] ${this._registryObjectURL}: `,e),this._processNotification(e)})}_processNotification(e){const t=e.body.value;setTimeout(()=>{Object.keys(this._subscribers[t]).forEach(e=>this._subscribers[t][e]())},5e3)}_unsubscribe(){const e={type:"unsubscribe",from:this._discoveredObjectURL,to:this._runtimeURL+"/subscriptions",body:{resource:this._registryObjectURL+"/registration"}};return new Promise((t,r)=>{this._messageBus.postMessage(e,e=>{Ie.log(`[DiscoveredObject.unsubscribe] ${this._registryObjectURL} rcved reply `,e),200===e.body.code?t():(Ie.error("Error unsubscribing ",this._registryObjectURL),r("Error unsubscribing "+this._registryObjectURL))})})}unsubscribeLive(e){return new Promise((t,r)=>{e in this._subscribers.live&&delete this._subscribers.live[e],this._areSubscriptionsEmpty()?this._unsubscribe().then(()=>t()).catch(e=>r(e)):t()})}unsubscribeDisconnected(e){return new Promise((t,r)=>{e in this._subscribers.disconnected?(delete this._subscribers.disconnected[e],this._areSubscriptionsEmpty()?this._unsubscribe().then(()=>t()).catch(e=>r(e)):t()):r(`${e} doesn't subscribe onDisconnected for ${this._registryObjectURL}`)})}_areSubscriptionsEmpty(){return 0===Object.keys(this._subscribers.live).length&&0===Object.keys(this._subscribers.disconnected).length}},Ae=class extends De{get data(){return this._data}constructor(e,t,r,s,o){super(e.hypertyID||e.url,t,r,s),this._data=e,this._discovery=o}check(){let e=this,t={body:{}};e._discoveredObjectURL.startsWith("hyperty://")?e._discovery.discoverHypertyPerURL(e._discoveredObjectURL).then(r=>{t.body.status=r.status,e._processNotification(t)}):e._discovery.discoverDataObjectsPerURL(e._discoveredObjectURL).then(r=>{t.body.status=r.status,e._processNotification(t)})}};let Ee=s.getLogger("Discovery");var Te=class{addEventListener(e,t){this[e]=t}trigger(e,t){this[e]&&this[e](t)}},He=class extends Te{constructor(e,t,r,s,o,n){if(!e)throw new Error("The hypertyURL is a needed parameter");if(!t)throw new Error("The MiniBus is a needed parameter");if(!r)throw new Error("The configuration is a needed parameter ");if(!o)throw new Error("The factory is a needed parameter ");super(),this._contextResourceTypes=s,this._url=e,this._discoverUsersPromises={},this._observePromises={},console.log("[ContextObserver] started with hypertyURL->",e),this._domain=o.divideURL(r.runtimeURL).domain,this._objectDescURL="hyperty-catalogue://catalogue."+this._domain+"/.well-known/dataschema/Context",this._users2observe=[],this._observers={},this._syncher=n||o.createSyncher(e,t,r);let i=o.createDiscovery(e,r.runtimeURL,t);this._discovery=i,this._discoveries={},window.discovery=this._discovery}start(e,t){let r=this;return console.log("[ContextObserver.start] "),new Promise((s,o)=>{r._syncher.resumeObservers({store:!0}).then(o=>{let n=Object.keys(o);n.length>0?(console.log("[ContextObserver.start] resuming: ",o),r._observers=o,s(o),n.forEach(r=>{let s=o[r];e&&(context.data.values=e),s.sync(),t&&s.onDisconnected(t)})):s(!1)}).catch(e=>{console.info("[ContextObserver] Resume Observer failed | ",e),s(!1)})}).catch(e=>{reject("[ContextObserver] Start failed | ",e)})}resumeDiscoveries(){let e=this;return new Promise((t,r)=>{e._discovery.resumeDiscoveries().then(r=>{console.log("[ContextObserver._resumeDiscoveries] found: ",r),r.forEach(r=>{r.data.resources&&r.data.resources[0]===e._contextResourceTypes[0]&&(console.log("[ContextObserver._resumeDiscoveries] resuming: ",r),"live"===r.data.status?(t([r.data]),r.unsubscribeLive(e._url)):r.onLive(e._url,()=>{console.log("[ContextObserver._resumeDiscoveries] disconnected Hyperty is back to live",r),t([r.data]),r.unsubscribeLive(e._url)}))})})}).catch(e=>{reject("[ContextObserver] resumeDiscoveries failed | ",e)})}onResumeObserver(e){this._onResumeObserver=e}discoverUsers(e,t){let r=this,s=e+"@"+t;return r._discoverUsersPromises[s]||(r._discoverUsersPromises[s]=new Promise(function(s,o){r._discovery.discoverHypertiesDO(e,["context"],r._contextResourceTypes,t).then(e=>{console.log("[ContextObserver.discoverUsers] discovery result->",e);let t=[],o=[];e.forEach(e=>{r._discoveries[e.data.hypertyID]=e,"live"===e.data.status?t.push(e.data):o.push(e)}),t.length>0?(console.log("[ContextObserver.discoverUsers] returning discovered hyperties data->",t),s(t)):o.length>0&&(console.log("[ContextObserver.discoverUsers] disconnected Hyperties ",o),o[0].onLive(r._url,()=>{console.log("[ContextObserver.discoverUsers] disconnected Hyperty is back to live",o[0]),t.push(o[0].data),s(t),o[0].unsubscribeLive(r._url)}))})})),r._discoverUsersPromises[s]}observe(e,t=!0){let r=this;return r._observePromises[e.hypertyID]||(r._observePromises[e.hypertyID]=new Promise(function(s,o){r._users2observe.forEach(t=>{if(t._reporter===e.hypertyID)return s(t)}),r._discovery.discoverDataObjectsPerReporter(e.hypertyID,["context"],r._contextResourceTypes,r._domain).then(function(n){console.log("[ContextObserver.discoverAvailability] discovered context objects ",n);let i,a=0;n.forEach(e=>{e.hasOwnProperty("lastModified")&&e.hasOwnProperty("url")&&Date.parse(e.lastModified)>a&&(a=e.lastModified,i=e.url)}),0!=a&&i?s(r._subscribeContext(e,i,t)):o("[ContextObserver.observe] discovered DataObjecs are invalid",n)})})),r._observePromises[e.hypertyID]}_subscribeContext(e,t,r=!0){let s=this;return new Promise(function(e,o){s._users2observe.forEach(r=>{if(r.url===t)return e(r)});let n={schema:s._objectDescURL,resource:t,store:null,p2p:null,mutual:null,domain_subscription:r};s._syncher.subscribe(n).then(t=>{console.log("[ContextObserver._subscribeContext] observer object",t),s._users2observe.push(t),t.onDisconnected(()=>{console.log("[ContextObserver.onDisconnected]: ",t),t.data.values[0].value="unavailable",t.sync()}),e(t)})})}_discoverAndSubscribeLegacyUsers(e){let t=this;return new Promise(function(r,s){t._discovery.discoverDataObjectsPerName(e).then(function(e){console.log("[ContextObserver._discoverAndSubscribeLegacyUsers] All DataObjects Result",e),e.forEach(function(e){"live"===e.status&&(console.log("Live obj",e),e.hypertyID||(e.hypertyID=e.reporter),t._subscribeContext(e.schema,e.url).then(function(e){return console.log("[ContextObserver._discoverAndSubscribeLegacyUsers] _subscribeContext",e),r(e)}))})}).catch(function(e){console.log("error ",e)})})}unobserve(e){let t=this;t._users2observe.forEach((r,s)=>{r.url===e&&(r.unsubscribe(),t._users2observe.splice(s,1))})}},Ne=class extends Te{constructor(e,t,r,s,o){if(!e)throw new Error("The hypertyURL is a needed parameter");if(!t)throw new Error("The MiniBus is a needed parameter");if(!r)throw new Error("The configuration is a needed parameter");super(e,t,r),console.info("[ContextReporter] started with url: ",e),this.syncher=o||s.createSyncher(e,t,r),this.domain=s.divideURL(r.runtimeURL).domain,this.contexts={},this.contextDescURL="hyperty-catalogue://catalogue."+this.domain+"/.well-known/dataschema/Context",this.syncher.onNotification(e=>{this.onNotification(e)}),this.syncher.onClose(e=>{console.log("[ContextReporter.onClose]"),this.setStatus(e.id,"unavailable"),e.ack()})}start(){let e=this;return new Promise((t,r)=>{this.syncher.resumeReporters({store:!0}).then(r=>{let s=Object.keys(r);s.length>0?(console.log("[ContextReporter.start] resuming ",r[s[0]]),e.contexts=r,s.forEach(t=>{e._onSubscription(e.contexts[t])}),t(e.contexts)):(console.log("[ContextReporter.start] nothing to resume ",r),t(!1))}).catch(e=>{console.error("[ContextReporter] Resume failed | ",e)})}).catch(e=>{reject("[ContextReporter] Start failed | ",e)})}processNotification(e){console.log("[ContextReporter.processNotification: ",e),e.ack()}create(e,t,r,s="myContext",o=null,n=null){let i,a=this;return new Promise((c,u)=>{i=o||n?o&&!n?{resources:r,expires:30,reporter:o}:!o&&n?{resources:r,expires:30,reuseURL:n}:{resources:r,expires:30,reuseURL:n,reporter:o}:{resources:r,expires:30},console.info("[ContextReporter.create] lets create a new User availability Context Object ",i),a.syncher.create(a.contextDescURL,[],t,!0,!1,s,null,i).then(t=>{a.contexts[e]=t,a._onSubscription(t),c(t)}).catch(function(e){u(e)})})}_onSubscription(e){e.onSubscription(e=>{console.info("[ContextReporter._onSubscription] accepting: ",e),e.accept()})}setContext(e,t){console.log("THIS [ContextReporter.setContext] before change :",this.contexts[e]),console.log("[ContextReporter.setContext] before change :",this.contexts[e].data),this.contexts[e].data.values=t,console.debug("[ContextReporter.setContext] after change :",this.contexts[e].data),this.trigger(e+"-context-update",t)}};const Fe="open";let Be={startingTime:"",status:"",participants:{}},Ke={parent:"communication",listener:"resources",type:"HypertyResource"};var Ge=class{constructor(e,t,r,s,o,n){if(!e)throw Error("Syncher is a necessary dependecy");if(!t)throw Error("Discover is a necessary dependecy");if(!r)throw Error("Domain is a necessary dependecy");if(!s)throw Error("Search is a necessary dependecy");this._syncher=e,this.discovery=t,this.search=s,this.myIdentity=o,this.controllerMode="reporter",this.child_cseq=0,this.domain=r,this._manager=n;const i=e.owner;this._objectDescURL="hyperty-catalogue://catalogue."+r+"/.well-known/dataschema/Communication",this._invitationsHandler=new class{constructor(e){if(!e)throw Error("hypertyURL is a necessary dependecy");this._hypertyURL=e,this._pending={}}set invitationResponse(e){this._invitationsResponse=e}inviteDisconnectedHyperties(e,t){let r=this;console.log("[GroupChatManager.InvitationsHandler.inviteDisconnectedHyperties] lets invite ",e),e.forEach(e=>{r._pending[t]||(r._pending[t]={}),r._pending[t][e.data.hypertyID]=e,e.onLive(r._hypertyURL,()=>{console.log("[GroupChatManager.create] disconnected Hyperty is back to live",e),t.inviteObservers([e.data.hypertyID]),e.unsubscribeLive(r._hypertyURL),delete r._pending[t][e.data.hypertyID]})})}processInvitations(e,t){let r=this,s=t.invitations||[];console.log("[GroupChatManager.InvitationsHandler.processInvitations] waiting for replies ",s,this._invitationsResponse),s.forEach(s=>{s.then(e=>{console.log("[GroupChatManager.InvitationsHandler.processInvitations] - OK: ",e,this._invitationsResponse),this._invitationsResponse&&this._invitationsResponse(e)}).catch(s=>{console.log("[GroupChatManager.InvitationsHandler.processInvitations] - NOT OK: ",s,this._invitationsResponse),this._invitationsResponse&&this._invitationsResponse(s),r.inviteDisconnectedHyperties([e[s.invited]],t)})})}resumeDiscoveries(e,t){let r=this;return new Promise((s,o)=>{let n={},i=[],a=[],c=[];e.resumeDiscoveries().then(e=>{console.log("[GroupChatManager.InvitationsHandler.resumeDiscoveries] found: ",e),e.forEach(e=>{e.data.resources&&"chat"===e.data.resources[0]&&(console.log("[GroupChatManager.InvitationsHandler.resumeDiscoveries] resuming: ",e),"live"===e.data.status?(n[e.data.hypertyID]=e,i.push(e.data.hypertyID),c.push(e.unsubscribeLive(r._hypertyURL))):a.push(e))}),a.length>0&&r.inviteDisconnectedHyperties(a,t),Object.keys(n).length>0?(t.inviteObservers(i),t.invitations.length>0&&r.processInvitations(n,t),Promise.all(c).then(()=>{s()})):s()})}).catch(e=>{reject("[GroupChatManager.InvitationsHandler.resumeDiscoveries] failed | ",e)})}cleanInvitations(e){let t=this,r=t._pending[e];return console.log("[GroupChatManager.InvitationsHandler.cleanInvitations] ",r),r?new Promise((e,s)=>{let o=Object.keys(r),n=[];o.forEach(e=>{n.push(r[e].unsubscribeLive(t._hypertyURL))}),Promise.all(o).then(()=>{e()})}):Promise.resolve()}}(i)}get invitationsHandler(){return this._invitationsHandler}get url(){return"reporter"===this.controllerMode?this.dataObjectReporter.url:this.dataObjectObserver.url}set dataObjectReporter(e){if(!e)throw new Error("[ChatController] The data object reporter is necessary parameter ");let t=this;t.controllerMode="reporter",e.onSubscription(function(e){switch(e.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnsubscribe(e)}}),t._setOnAddChildListener(e),e.onRead(e=>{e.accept()}),e.onExecute(e=>{switch(e.method){case"addUser":t.addUser(e.params[0]).then(()=>{e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;case"removeUser":t.removeUser(e.params).then(()=>{e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;default:e.reject("[ChatController.onExecute] Chat method execution not accepted by Reporter")}}),t._dataObjectReporter=e}get dataObjectReporter(){return this._dataObjectReporter}get messages(){return"reporter"===this.controllerMode?this._dataObjectReporter._childrenObjects:this._dataObjectObserver._childrenObjects}set dataObjectObserver(e){let t=this;t.controllerMode="observer",t._dataObjectObserver=e,e.onChange("*",function(e){if(console.info("[ChatManager.ChatController]Observer - onChange",e),e.field.includes("participants"))switch(e.cType){case"add":t._onUserAdded&&t._onUserAdded(e);break;case"remove":t._onUserRemoved&&t._onUserRemoved(e)}t._onChange&&t._onChange(e)}),t._setOnAddChildListener(e)}get dataObjectObserver(){return this._dataObjectObserver}_setOnAddChildListener(e){let t=this;e.onAddChild(function(e){t.child_cseq+=1,console.info("[ChatManager.ChatController._setOnAddChildListener] new Child received: ",e),t._onMessage&&t._onMessage(e)})}get dataObject(){return"reporter"===this.controllerMode?this.dataObjectReporter:this.dataObjectObserver}set closeEvent(e){this._closeEvent=e,this._onClose&&this._onClose(e)}get closeEvent(){return this._closeEvent}_onSubscribe(e){let t=this._dataObjectReporter;e.accept(),console.log("[ChatManager.ChatController.onSubscribe] event",e,t.url),console.log("[ChatManager.ChatController.onSubscribe] New user has subscribe this object: ",t.data,e.identity);let r=JSON.parse(JSON.stringify(e.identity));r.hasOwnProperty("assertion")&&delete r.assertion;let s={hypertyURL:e.url,domain:e.domain,identity:r},o=e.identity.userProfile.guid;console.log("[ChatManager.ChatController.onSubscribe]  new participant",s),e.identity.legacy&&(s.legacy=e.identity.legacy),t.data.participants[o]=s,console.log("[ChatManager.ChatController.onSubscribe] communicationObject OBJ chatcontroller",t.data.participants),console.log("[ChatManager.ChatController.onSubscribe - onSubscription] ",s),this._onUserAdded&&this._onUserAdded(s)}_onUnsubscribe(e){let t=this._dataObjectReporter;console.log("[ChatManager.ChatController.onUnsubscribe] event",e,t.url);let r=e.identity.userProfile;console.log("[ChatManager.ChatController.onUnsubscribe]  participant left",r),e.identity.legacy&&(r.legacy=e.identity.legacy),delete t.data.participants[r.userURL],console.log("[ChatManager.ChatController.onUnsubscribe - this._onUserRemoved] ",this.onUserRemoved),this._onUserRemoved&&this._onUserRemoved(r)}sendFile(e){let t=this,r="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;return new Promise(function(s,o){let n={userProfile:t.myIdentity};r.addHypertyResource("resources","file",e,n).then(function(e){let o={value:e,identity:{userProfile:t.myIdentity},resource:e},n=new De(r.url,t._manager._runtimeURL,t._manager._hypertyURL,t._manager._bus),i=function(e,t,r,o){let n=o;e.sharingStatus.then(s(r)).catch(s=>{console.log("[ChatManager.ChatController.sendFile] share failed: ",s),n.onLive(t,()=>{n.unsubscribeLive(t),e.share(!0),i(e,t,r,n)})})};i(e,t._manager._hypertyURL,o,n)})}).catch(function(e){console.error("Reason:",e),reject(e)})}send(e,t){let r=this,s="reporter"===r.controllerMode?r.dataObjectReporter:r.dataObjectObserver;return new Promise(function(o,n){r.child_cseq+=1;let i={type:"chat",content:e},a=t||{userProfile:r.myIdentity};s.addChild(i,a).then(function(e){console.log("[ChatManager.ChatController][addChild - Chat Message]: ",e);let t={childId:e._childId,from:e._owner,value:e.data,type:"create",identity:a},n=new De(s.url,r._manager._runtimeURL,r._manager._hypertyURL,r._manager._bus),i=function(e,t,r,s){let n=s;e.sharingStatus.then(o(r)).catch(s=>{n.onLive(t,()=>{n.unsubscribeLive(t),e.share(!0),i(e,t,r,n)})})};i(e,r._manager._hypertyURL,t,n)}).catch(function(e){console.error("Reason:",e),n(e)})})}onChange(e){this._onChange=e}onMessage(e){this._onMessage=e}onUserAdded(e){this._onUserAdded=e}onUserRemoved(e){this._onUserRemoved=e}onClose(e){this._onClose=e}onResponse(e){this._onResponse=e}addUser(e){let t=this,r=e=>(console.log("Element:",e.length),0!==e.length);return new Promise(function(s,o){if(0===e.filter(r).length)return o("Don't have users to invite");console.info("[ChatManager.ChatController.addUsers ]: ",e);let n=[],i=[],a={};e.forEach(e=>{let r=t.discovery.discoverHypertiesDO(e.user,["comm"],["chat"],e.domain);n.push(r)}),Promise.all(n).then(e=>{console.log("[ChatManager.ChatController.addUsers] Users Discovery Results->",e);let r=[];e.forEach(e=>{e.forEach(e=>{"live"===e.data.status?(r.push(e.data.hypertyID),a[e.data.hypertyID]=e):i.length<5&&i.push(e)})}),console.info("[ChatManager.ChatController]------------------------ Syncher Create ---------------------- \n"),console.info("[ChatManager.ChatController]Selected Hyperties: !!! ",r),console.info(`Have ${r.length} users;`);let s="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;i.length>0&&t._invitationsHandler.inviteDisconnectedHyperties(i,s),s.inviteObservers(r),s.invitations.length>0&&t._invitationsHandler.processInvitations(a,s)}).then(()=>{console.info("[ChatManager.ChatController]Are invited with success "+e.length+" users;"),s(!0)}).catch(e=>{console.error("An error occurred when trying to invite users;\n",e),o(e)})})}addUserReq(e){let t=this,r=e=>(console.log("Element:",e.length),0!==e.length);return new Promise(function(s,o){return 0===e.filter(r).length?o("[ChatManager.ChatController.addUserReq] Don't have users to add"):"observer"===!t.controllerMode?o("[ChatManager.ChatController.addUserReq] only allowed to Chat Observer"):void 0})}onInvitationResponse(e){this._onInvitationResponse=e,this._invitationsHandler.invitationResponse=e}removeUser(e){console.log("[ChatManager.ChatController]Not yet implemented: ",e)}close(e=!0){let t=this;return new Promise(function(r,s){if("reporter"===t.controllerMode)t._invitationsHandler.cleanInvitations(t.dataObjectReporter).then(()=>{if(e)try{delete t._manager._reportersControllers[t.dataObjectReporter.url],t.dataObjectReporter.delete(),r(!0),t._onClose&&t._onClose({code:200,desc:"deleted",url:t.dataObjectReporter.url})}catch(e){console.error(e),s(!1)}else t._manager.communicationObject.status="closed",r(!0)});else if(e)try{delete t._manager._observersControllers[t.dataObjectObserver.url],t.dataObjectObserver.unsubscribe(),r(!0)}catch(e){console.error(e),s(!1)}else r(!0)})}};class qe{constructor(e,t,r){let s=I(r);return r.hasOwnProperty("userProfile")||(s.userProfile=r),{hypertyURL:e,domain:t,domain:t,identity:s}}}var Ve=class{constructor(e,t,r,s){if(!e)throw Error("Syncher is a necessary dependecy");if(!t)throw Error("Domain is a necessary dependecy");this._syncher=e,this.myIdentity=r,this.controllerMode="reporter",this.child_cseq=0,this.domain=t,this._manager=s,e.owner,this._objectDescURL="hyperty-catalogue://catalogue."+t+"/.well-known/dataschema/Communication"}get url(){return"reporter"===this.controllerMode?this.dataObjectReporter.url:this.dataObjectObserver.url}set dataObjectReporter(e){if(!e)throw new Error("[ChatController] The data object reporter is necessary parameter ");let t=this;t.controllerMode="reporter",e.onSubscription(function(e){switch(e.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnsubscribe(e)}}),t._setOnAddChildListener(e),e.onRead(e=>{e.accept()}),e.onExecute(e=>{switch(e.method){case"addUser":t.addUser(e.params[0]).then(()=>{e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;case"removeUser":t.removeUser(e.params).then(()=>{e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;default:e.reject("[ChatController.onExecute] Chat method execution not accepted by Reporter")}}),t._dataObjectReporter=e}get dataObjectReporter(){return this._dataObjectReporter}get messages(){return"reporter"===this.controllerMode?this._dataObjectReporter._childrenObjects:this._dataObjectObserver._childrenObjects}set dataObjectObserver(e){let t=this;t.controllerMode="observer",t._dataObjectObserver=e,e.onChange("*",function(e){if(console.info("[ChatManager.ChatController]Observer - onChange",e),e.field.includes("participants"))switch(e.cType){case"add":t._onUserAdded&&t._onUserAdded(e);break;case"remove":t._onUserRemoved&&t._onUserRemoved(e)}t._onChange&&t._onChange(e)}),t._setOnAddChildListener(e)}get dataObjectObserver(){return this._dataObjectObserver}_setOnAddChildListener(e){let t=this;e.onAddChild(function(e){t.child_cseq+=1,console.info("[ChatManager.ChatController._setOnAddChildListener] new Child received: ",e),t._onMessage&&t._onMessage(e)})}get dataObject(){return"reporter"===this.controllerMode?this.dataObjectReporter:this.dataObjectObserver}set closeEvent(e){this._closeEvent=e,this._onClose&&this._onClose(e)}get closeEvent(){return this._closeEvent}_onSubscribe(e){let t=this._dataObjectReporter;e.accept(),console.log("[ChatManager.ChatController.onSubscribe] event",e,t.url),console.log("[ChatManager.ChatController.onSubscribe] New user has subscribe this object: ",t.data,e.identity);let r=JSON.parse(JSON.stringify(e.identity));r.hasOwnProperty("assertion")&&delete r.assertion;let s={hypertyURL:e.url,domain:e.domain,identity:r},o=e.identity.userProfile.guid;console.log("[ChatManager.ChatController.onSubscribe]  new participant",s),e.identity.legacy&&(s.legacy=e.identity.legacy),t.data.participants[o]=s,console.log("[ChatManager.ChatController.onSubscribe] communicationObject OBJ chatcontroller",t.data.participants),console.log("[ChatManager.ChatController.onSubscribe - onSubscription] ",s),this._onUserAdded&&this._onUserAdded(s)}_onUnsubscribe(e){let t=this._dataObjectReporter;console.log("[ChatManager.ChatController.onUnsubscribe] event",e,t.url);let r=e.identity.userProfile;console.log("[ChatManager.ChatController.onUnsubscribe]  participant left",r),e.identity.legacy&&(r.legacy=e.identity.legacy),delete t.data.participants[r.userURL],console.log("[ChatManager.ChatController.onUnsubscribe - this._onUserRemoved] ",this.onUserRemoved),this._onUserRemoved&&this._onUserRemoved(r)}sendFile(e){let t=this,r="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;return new Promise(function(s,o){let n={userProfile:t.myIdentity};r.addHypertyResource("resources","file",e,n).then(function(e){let r={userProfile:t.myIdentity};s({value:e,identity:r,resource:e})})}).catch(function(e){console.error("Reason:",e),reject(e)})}send(e,t){let r=this,s="reporter"===r.controllerMode?r.dataObjectReporter:r.dataObjectObserver;return new Promise(function(o,n){r.child_cseq+=1;let i={type:"chat",content:e},a=t||{userProfile:r.myIdentity};s.addChild(i,a,{anonymous:!0}).then(function(e){console.log("[ChatManager.ChatController][addChild - Chat Message]: ",e);let t={childId:e._childId,from:e._owner,value:e.data,type:"create",identity:a};o(t)}).catch(function(e){console.error("Reason:",e),n(e)})})}onChange(e){this._onChange=e}onMessage(e){this._onMessage=e}onTyping(e){this._dataObjectReporter?this._dataObjectReporter.onEvent(t=>{"typing"===t.value&&e()}):this._dataObjectObserver.onEvent(t=>{"typing"===t.value&&e()})}typing(){this._dataObjectReporter?this._dataObjectReporter.sendEvent("typing"):this._dataObjectObserver.sendEvent("typing")}onUserAdded(e){this._onUserAdded=e}onUserRemoved(e){this._onUserRemoved=e}onClose(e){this._onClose=e}onResponse(e){this._onResponse=e}onInvitationResponse(e){this._onInvitationResponse=e}removeUser(e){console.log("[ChatManager.ChatController]Not yet implemented: ",e)}close(e=!0){let t=this;return new Promise(function(r,s){if("reporter"===t.controllerMode)if(e)try{delete t._manager._reportersControllers[t.dataObjectReporter.url],t.dataObjectReporter.delete(),r(!0),t._onClose&&t._onClose({code:200,desc:"deleted",url:t.dataObjectReporter.url})}catch(e){console.error(e),s(!1)}else t._manager.communicationObject.status="closed",r(!0);else if(e)try{delete t._manager._observersControllers[t.dataObjectObserver.url],t.dataObjectObserver.unsubscribe(),r(!0)}catch(e){console.error(e),s(!1)}else r(!0)})}},We=class{constructor(e){this._bus=e,this._divideURL=x}createSyncher(e,t,r){return new class{constructor(e,t,r){let s=this;s._owner=e,s._bus=t,s._subURL=r.runtimeURL+"/sm",s._runtimeUrl=r.runtimeURL,s._p2pHandler=r.p2pHandler,s._p2pRequester=r.p2pRequester,s._reporters={},s._observers={},s._provisionals={},t.addListener(e,t=>{if(t.from!==e)switch(ke.info("[Syncher] Syncher-RCV: ",t,s),t.type){case"forward":s._onForward(t);break;case"create":s._onRemoteCreate(t);break;case"delete":s._onRemoteDelete(t);break;case"execute":s._onExecute(t)}})}get owner(){return this._owner}get reporters(){return this._reporters}get observers(){return this._observers}create(e,t,r,s=!1,o=!1,n="no name",i,a){if(!e)throw Error("[Syncher - Create] - You need specify the data object schema");if(!t)throw Error("[Syncher - Create] -The observers should be defined");a=a||{};let c=Object.assign({},a);return c.p2p=o,c.store=s,c.schema=e,c.authorise=t,c.p2pHandler=this._p2pHandler,c.p2pRequester=this._p2pRequester,c.data=r?I(r):{},c.name=0===n.length?"no name":n,c.reporter=a.hasOwnProperty("reporter")&&"boolean"!=typeof a.reporter?a.reporter:this._owner,c.resume=!1,a?(c.mutual=!!a.hasOwnProperty("mutual")&&a.mutual,c.name=a.hasOwnProperty("name")?a.name:c.name):c.mutual=!1,a.hasOwnProperty("reuseURL")&&(c.resource=a.reuseURL),i&&(c.identity=i),this._create(c)}resumeReporters(e){return ke.log("[syncher - create] - resume Reporter - criteria: ",e),Object.assign(e,{resume:!0}),this._resumeCreate(e)}subscribe(e){return this._subscribe(e)}resumeObservers(e){let t=e||{};return Object.assign(t,{resume:!0}),this._resumeSubscribe(t)}read(e,t){let r=this;return console.log("[Syncher.read] ",e),new Promise((s,o)=>{let n={type:"read",from:r._owner,to:r._subURL,body:{resource:e}};t&&(n.body.criteria=t),r._bus.postMessage(n,e=>{s(e.body.value)},!1)})}_readReporter(e){let t=this,r={type:"read",from:t._owner,to:e};return new Promise((e,s)=>{t._bus.postMessage(r,r=>t._readCallBack(r,e,s),!1)})}onNotification(e){this._onNotificationHandler=e}onClose(e){this._onClose=e}_create(e){let t=this;return new Promise((r,s)=>{let o=Object.assign({},e),n=e.resume;o.created=(new Date).toISOString(),o.runtime=t._runtimeUrl;let i=I(o);delete i.p2p,delete i.store,delete i.observers,delete i.identity;let a={type:"create",from:t._owner,to:t._subURL,body:{resume:n,value:i}};a.body.schema=o.schema,o.p2p&&(a.body.p2p=o.p2p),o.store&&(a.body.store=o.store),o.identity&&(a.body.identity=o.identity),console.log("[syncher._create]: ",o,a),t._bus.postMessage(a,n=>{if(ke.log("[syncher - create] - create-response: ",n),200===n.body.code){o.url=n.body.resource,o.status="live",o.syncher=t,o.childrens=n.body.childrenResources;let s=t._reporters[o.url];s||(s=new Se(o),t._reporters[o.url]=s),s.inviteObservers(e.authorise,e.p2p),r(s)}else s(n.body.desc)})})}_resumeCreate(e){let t=this;return new Promise((r,s)=>{let o=e.resume,n={type:"create",from:t._owner,to:t._subURL,body:{resume:o}};ke.log("[syncher - create]: ",e,n),e&&(n.body.value=e,e.hasOwnProperty("reporter")?n.body.value.reporter=e.reporter:n.body.value.reporter=t._owner),e.p2p&&(n.body.p2p=e.p2p),e.store&&(n.body.store=e.store),e.observers&&(n.body.authorise=e.observers),e.identity&&(n.body.identity=e.identity),ke.log("[syncher._resumeCreate] - resume message: ",n),t._bus.postMessage(n,e=>{if(ke.log("[syncher._resumeCreate] - create-resumed-response: ",e),200===e.body.code){let s=e.body.value;for(let e in s){let r=s[e];r.data=I(r.data)||{},r.childrenObjects&&(r.childrenObjects=I(r.childrenObjects)),r.mutual=!1,r.resume=!0,r.status="live",r.syncher=t,ke.log("[syncher._resumeCreate] - create-resumed-dataObjectReporter",r);let o=new Se(r);r.childrenObjects&&o.resumeChildrens(r.childrenObjects),t._reporters[r.url]=o}r(t._reporters),this._onReportersResume&&this._onReportersResume(this._reporters)}else 404===e.body.code?r({}):s(e.body.desc)})})}_subscribe(e){let t=this;return new Promise((r,s)=>{let o={type:"subscribe",from:t._owner,to:t._subURL,body:e};ke.log("[syncher_subscribe] - subscribe message: ",e,o);let n=t._bus.postMessage(o);t._bus.addResponseListener(t._owner,n,o=>{ke.log("[syncher] - subscribe-response: ",o);let i=o.body.resource,a=t._provisionals[i];if(delete t._provisionals[i],a&&a._releaseListeners(),o.body.code<200)ke.log("[syncher] - new DataProvisional: ",o.body.childrenResources,i),a=new Ce(t._owner,i,t._bus,o.body.childrenResources),t._provisionals[i]=a;else if(200===o.body.code){ke.log("[syncher] - new Data Object Observer: ",o,t._provisionals);let s=o.body.value;s.syncher=t,s.p2p=e.p2p,s.store=e.store,s.identity=e.identity,s.resume=!1,s.mutual=e.mutual;let c=t._observers[i];c?c.sync():(c=new Ue(s),t._observers[i]=c),ke.log("[syncher] - new Data Object Observer already exist: ",c),t._bus.removeResponseListener(t._owner,n),r(c),a&&a.apply(c)}else t._bus.removeResponseListener(t._owner,n),s(o.body.desc)})})}_resumeSubscribe(e){let t=this;return new Promise((r,s)=>{let o={type:"subscribe",from:t._owner,to:t._subURL,body:{}};e&&(e.hasOwnProperty("p2p")&&(o.body.p2p=e.p2p),e.hasOwnProperty("store")&&(o.body.store=e.store),e.hasOwnProperty("schema")&&(o.body.schema=e.schema),e.hasOwnProperty("identity")&&(o.body.identity=e.identity),e.hasOwnProperty("resource")&&(o.body.resource=e.resource)),o.body.resume=e.resume;let n=e.mutual;e.hasOwnProperty("mutual")&&(o.body.mutual=n),console.log("[syncher] - subscribe message: ",e,o),t._bus.postMessage(o,e=>{console.log("[syncher] - subscribe-resumed-response: ",e);let o=e.body.resource,n=t._provisionals[o];if(delete t._provisionals[o],n&&n._releaseListeners(),e.body.code<200)ke.log("[syncher] - resume new DataProvisional: ",e,o),n=new Ce(t._owner,o,t._bus,e.body.childrenResources),t._provisionals[o]=n;else if(200===e.body.code){let s=e.body.value;for(let r in s){let o=s[r];console.log("[syncher] - Resume Object Observer: ",e,o,t._provisionals),o.childrenObjects&&(o.childrenObjects=I(o.childrenObjects)),o.data=I(o.data)||{},o.resume=!0,o.syncher=t,console.log("[syncher._resumeSubscribe] - create new dataObject: ",o);let n=new Ue(o);o.childrenObjects&&n.resumeChildrens(o.childrenObjects),ke.log("[syncher._resumeSubscribe] - new dataObject",n),t._observers[n.url]=n,t._provisionals[n.url]&&t._provisionals[n.url].apply(n)}r(t._observers),this._onObserversResume&&this._onObserversResume(t._observers)}else 404===e.body.code?r({}):s(e.body.desc)})})}_onForward(e){this._reporters[e.body.to]._onForward(e)}_onRemoteCreate(e){let t=this,r=e.from.slice(0,-13),s=x(r).domain,o={type:e.type,from:e.body.source,url:r,domain:s,schema:e.body.schema,value:e.body.value,identity:e.body.identity,ack:r=>{let s=200;r&&(s=r),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:s}})}};t._onNotificationHandler&&(ke.info("[Syncher] NOTIFICATION-EVENT: ",o),t._onNotificationHandler(o))}_onRemoteDelete(e){let t=this,r=e.body.resource,s=t._observers[r],o={from:t.owner,to:t._subURL,id:e.id,type:"unsubscribe",body:{resource:e.body.resource}};t._bus.postMessage(o),delete t._observers[r];let n={type:e.type,url:r,identity:e.body.identity,ack:r=>{let o=200;r&&(o=r),200===o&&s&&s.delete(),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:o,source:t._owner}})}};t._onNotificationHandler&&(ke.log("NOTIFICATION-EVENT: ",n),t._onNotificationHandler(n))}_onExecute(e){let t=this,r={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}};if((e.from===t._runtimeUrl+"/registry/"||e.from===t._runtimeUrl+"/registry")&&e.body&&e.body.method&&"close"===e.body.method&&t._onClose){let e={type:"close",ack:e=>{e&&(r.body.code=e),t._bus.postMessage(r)}};ke.info("[Syncher] Close-EVENT: ",e),t._onClose(e)}else t._bus.postMessage(r)}onReportersResume(e){this._onReportersResume=e}onObserversResume(e){this._onObserversResume=e}}(e,t,r)}createIdentityManager(e,t,r){return new class{constructor(e,t,r){this.messageBus=r,this.domain=x(e).domain,this.owner=e,this.runtimeURL=t}discoverUserRegistered(e,t){let r=this;return new Promise(function(s,o){let n,i=e||".",a={type:"read",from:n=t||r.owner,to:r.runtimeURL+"/registry/",body:{resource:i,criteria:n}};r.messageBus.postMessage(a,e=>{let t=e.body.resource;t&&200===e.body.code?s(t):o("code: "+e.body.code+" No user was found")})})}discoverIdentityPerIdP(e){let t=this;return new Promise(function(r,s){let o={type:"read",from:this.owner,to:t.runtimeURL+"/idm",body:{resource:e,criteria:"idp"}};t.messageBus.postMessage(o,e=>{200===e.body.code?r(e.body.value):s(e.body.code+" "+e.body.desc)})})}}(e,t,r)}createDiscovery(e,t,r){return new class{constructor(e,t,r){this.messageBus=r,this.runtimeURL=t,this.domain=x(e).domain,this.discoveryURL=e}_isLegacyUser(e){return!(!e.includes(":")||e.includes("user://"))}discoverHypertiesPerUserProfileData(e,t,r){let s=this,o=[],n={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/hyperty/userprofile/"+e}};return(t||r)&&(n.body.criteria={resources:r,dataSchemes:t}),new Promise(function(t,r){s._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):s.messageBus.postMessage(n,r=>{200===r.body.code?(r.body.value.map(function(e){e.hypertyID!=s.discoveryURL&&o.push(e)}),0===o.length?t([]):(Ee.log("[Discovery.discoverHypertiesPerUserProfileData] Reply log: ",o),t(o))):(Ee.warn("[Discovery.discoverHypertiesPerUserProfileData] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverHypertiesPerUserProfileDataDO(e,t,r){return new Promise((e,t)=>{this.discoverHypertiesPerUserProfileData(...arguments).then(t=>{e(this._convertToDiscoveredObject(t))}).catch(e=>t(e))})}discoverDataObjectsPerUserProfileData(e,t,r){let s=this,o={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/dataObject/userprofile/"+e}};return(t||r)&&(o.body.criteria={resources:r,dataSchemes:t}),new Promise(function(t,r){s._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):s.messageBus.postMessage(o,r=>{200===r.body.code?(Ee.log("Reply log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjectsPerUserProfileData] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectsPerUserProfileDataDO(e,t,r){return new Promise((e,t)=>{this.discoverDataObjectsPerUserProfileData(...arguments).then(t=>e(this._convertToDiscoveredObject(t))).catch(e=>t(e))})}discoverHypertiesPerGUID(e,t,r){let s=this,o=[],n={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/hyperty/guid/"+e}};return(t||r)&&(n.body.criteria={resources:r,dataSchemes:t}),new Promise(function(t,r){s.messageBus.postMessage(n,n=>{200===n.body.code?(n.body.value.map(function(e){e.hypertyID!=s.discoveryURL&&o.push(e)}),0===o.length?r("No Hyperty was found"):(Ee.log("Reply log: ",o),t(o))):(Ee.warn("[Discovery.discoverHypertiesPerGUID] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}discoverHypertiesPerGUIDDO(e,t,r){return new Promise((e,t)=>{this.discoverHypertiesPerGUID(...arguments).then(t=>{e(this._convertToDiscoveredObject(t))}).catch(e=>t(e))})}discoverDataObjectsPerGUID(e,t,r){let s=this,o={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/dataObject/guid/"+e}};return(t||r)&&(o.body.criteria={resources:r,dataSchemes:t}),new Promise(function(t,r){s.messageBus.postMessage(o,r=>{200===r.body.code?(Ee.log("Reply log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjectsPerGUID] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectsPerGUIDDO(e,t,r){return new Promise((e,t)=>{this.discoverDataObjectsPerGUID(...arguments).then(t=>e(this._convertToDiscoveredObject(t))).catch(e=>t(e))})}discoverHyperties(e,t,r,s){let o,n=this,i=[];o=s||n.domain;let a={type:"read",from:n.discoveryURL,to:n.runtimeURL+"/discovery/",body:{resource:"/hyperty/user/"+e}};return a.body.criteria=t||r?{resources:r,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,r){n._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):n.messageBus.postMessage(a,r=>{200===r.body.code||500===r.body.code?(r.body.value.map(function(e){e.hypertyID!=n.discoveryURL&&i.push(e)}),Ee.log("[Discovery.discoverHyperties] Reply : ",i),t(i)):(Ee.warn("[Discovery.discoverHyperties] Error Reply for "+e+" Reason: ",r.body.description),t(i))})})}discoverHypertiesDO(e,t,r,s){return new Promise((e,t)=>{this.discoverHyperties(...arguments).then(t=>{e(this._convertToDiscoveredObject(t))}).catch(e=>t(e))})}discoverDataObjects(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:n.runtimeURL+"/discovery/",body:{resource:"/dataObject/user/"+e}};return i.body.criteria=t||r?{resources:r,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,r){n.messageBus.postMessage(i,r=>{200===r.body.code?(Ee.log("Reply Value Log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjects] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectsDO(e,t,r,s){return new Promise((e,t)=>{this.discoverDataObjects(...arguments).then(t=>e(this._convertToDiscoveredObject(t))).catch(e=>t(e))})}discoverHypertyPerURL(e,t){let r,s=this;r=t||s.domain;let o={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/hyperty/url/"+e,criteria:{domain:r}}};return new Promise(function(t,r){s.messageBus.postMessage(o,r=>{200===r.body.code?(Ee.log("Reply Value Log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverHypertyPerURL] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverHypertyPerURLDO(e,t){return new Promise((e,t)=>{this.discoverHypertyPerURL(...arguments).then(t=>e(new Ae(t,this.runtimeURL,this.discoveryURL,this.messageBus,this))).catch(e=>t(e))})}discoverDataObjectPerURL(e,t){let r,s=this;r=t||s.domain;let o={type:"read",from:s.discoveryURL,to:s.runtimeURL+"/discovery/",body:{resource:"/dataObject/url/"+e,criteria:{domain:r}}};return new Promise(function(t,r){s.messageBus.postMessage(o,r=>{200===r.body.code?(Ee.log("Reply Value Log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjectPerURL] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectPerURLDO(e,t){return new Promise((e,t)=>{this.discoverDataObjectPerURL(...arguments).then(t=>e(new Ae(t,this.runtimeURL,this.discoveryURL,this.messageBus,this))).catch(e=>t(e))})}discoverDataObjectsPerName(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:n.runtimeURL+"/discovery/",body:{resource:"/dataObject/name/"+e}};return i.body.criteria=t||r?{resources:r,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,r){n.messageBus.postMessage(i,r=>{200===r.body.code?(Ee.log("Reply Value Log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjectsPerName] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectsPerNameDO(e,t,r,s){return new Promise((e,t)=>{this.discoverDataObjectsPerName(...arguments).then(t=>e(this._convertToDiscoveredObject(t))).catch(e=>t(e))})}discoverDataObjectsPerReporter(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:n.runtimeURL+"/discovery/",body:{resource:"/dataObject/reporter/"+e}};return i.body.criteria=t||r?{resources:r,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,r){n.messageBus.postMessage(i,r=>{200===r.body.code?(Ee.log("Reply Value Log: ",r.body.value),t(r.body.value)):(Ee.warn("[Discovery.discoverDataObjectsPerName] Error Reply for "+e+" Reason: ",r.body.description),t([]))})})}discoverDataObjectsPerReporterDO(e,t,r,s){return new Promise((e,t)=>{this.discoverDataObjectsPerReporter(...arguments).then(t=>e(this._convertToDiscoveredObject(t))).catch(e=>t(e))})}_convertToDiscoveredObject(e){return e.map(e=>new Ae(e,this.runtimeURL,this.discoveryURL,this.messageBus,this))}discoverDataObject(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:"domain://registry."+o,body:{resource:e,criteria:{resources:r,dataSchemes:t}}};return new Promise(function(t,r){n.messageBus.postMessage(i,r=>{if(Ee.log("[Discovery]",r),r.body.code>299)return Ee.warn("[Discovery.discoverDataObject] Error Reply for "+e+" Reason: ",r.body.description),t([]);let s=r.body.value;t(s||[])})})}discoverHyperty(e,t,r,s){let o,n=this,i=function(e){if("user://"===e.substring(0,7)){let t=x(e);if(t.domain&&t.identity)return e;throw"userURL with wrong format"}return function(e){let t=e.indexOf("@");return"user://"+e.substring(t+1,e.length)+"/"+e.substring(0,t)}(e)}(e);return o=s||n.domain,new Promise(function(a,c){if(Ee.log("[Discovery.discoverHyperty] ACTIVE DOMAIN -> ",o,"user->",e,"schema->",t,"resources->",r,"domain->",s),e.includes(":")&&!e.includes("user://"))return Ee.log("[Discovery.discoverHyperty] "+e+" is legacy domain"),a({userID:e,hypertyID:e,schema:t,resources:r});let u={type:"read",from:n.discoveryURL,to:"domain://registry."+o,body:{resource:i,criteria:{resources:r,dataSchemes:t}}};Ee.info("[Discovery] msg to send->",u),n.messageBus.postMessage(u,e=>{Ee.info("[Discovery] ON discoverHyperty->",e);let t=e.body.value;t?a(t):c("No Hyperty was found")})})}discoverHypertyPerUser(e,t){let r,s=this;return new Promise(function(o,n){if(e.includes(":")&&!e.includes("user://"))return Ee.log("[Discovery.discoverHyperty] "+e+"is legacy domain"),o({id:e,hypertyURL:e,descriptor:"unknown"});r=t||s.domain;let i="user://"+e.substring(e.indexOf("@")+1,e.length)+"/"+e.substring(0,e.indexOf("@")),a={type:"read",from:s.discoveryURL,to:"domain://registry."+r,body:{resource:i}};Ee.info("[Discovery] Message: ",a,r,i),s.messageBus.postMessage(a,t=>{let r,s,i;Ee.info("[Discovery] message reply",t);let a=t.body.value;for(r in a)if(void 0!==a[r].lastModified)if(void 0===s)s=new Date(a[r].lastModified),i=r;else{let e=new Date(a[r].lastModified);s.getTime()<e.getTime()&&(s=e,i=r)}Ee.info("[Discovery] Last Hyperty: ",i,s);let c=i;if(void 0===c)return n("User Hyperty not found");let u={id:e,descriptor:a[c].descriptor,hypertyURL:c};Ee.info("[Discovery] ===> hypertyDiscovery messageBundle: ",u),o(u)})})}discoverHypertiesPerUser(e,t){let r,s=this;return Ee.log("on Function->",e),new Promise(function(o,n){if(e.includes(":")&&!e.includes("user://")){Ee.log("[Discovery.discoverHyperty] is legacy domain");let t={userID:e,hypertyID:e,schema:schema,resources:resources};return o(t)}r=t||s.domain;let i="user://"+e.substring(e.indexOf("@")+1,e.length)+"/"+e.substring(0,e.indexOf("@")),a={type:"read",from:s.discoveryURL,to:"domain://registry."+r,body:{resource:i}};Ee.log("[Discovery] Message discoverHypertiesPerUser: ",a,r,i),s.messageBus.postMessage(a,e=>{Ee.info("[Discovery] discoverHypertiesPerUser reply",e);let t=e.body.value;if(!t)return n("User Hyperty not found");o(t)})})}resumeDiscoveries(){let e=this;return Ee.log("[Discovery] resumeDiscoveries"),new Promise(function(t,r){let s={type:"read",from:e.discoveryURL,to:e.runtimeURL+"/subscriptions",body:{resource:e.discoveryURL}};e.messageBus.postMessage(s,r=>{Ee.log("[Discovery.resumeDiscoveries] reply: ",r);let s=[];200===r.body.code?(r.body.value.forEach(t=>{let r=t.split("/registration")[0];Ee.log("[Discovery.resumeDiscoveries] adding listener to: ",r),r.includes("hyperty://")?s.push(e.discoverHypertyPerURLDO(r)):s.push(e.discoverDataObjectPerURLDO(r))}),Promise.all(s).then(e=>{t(e)})):t([])})})}}(e,t,r)}createSearch(e,t){return new class{constructor(e,t){if(!e)throw new Error("The discovery component is a needed parameter");if(!t)throw new Error("The identityManager component is a needed parameter");this.discovery=e,this.identityManager=t}myIdentity(){let e=this;return new Promise(function(t,r){e.identityManager.discoverUserRegistered().then(e=>{t(e)}).catch(e=>{r(e)})})}hyperties(e,t,r,s=!1){}users(e,t,r,s,o=!1){if(!e)throw new Error("You need to provide a list of users");if(!t)throw new Error("You need to provide a list of domains");if(!s)throw new Error("You need to provide a list of resources");if(!r)throw new Error("You need to provide a list of schemes");let n=this;return new Promise(function(i,a){if(console.info("[Search] Users: ",e,e.length),console.info("[Search] Domains: ",t,t.length),0===e.length)console.info("Don't have users to discovery"),i(e);else{let c=[];e.forEach((e,i)=>{let a=t[i];console.info("[Search] Search user "+e+" for provided domain:",a),o?c.push(n.discovery.discoverHypertiesPerUserProfileData(e,r,s)):c.push(n.discovery.discoverHyperties(e,r,s,a))}),console.info("Requests promises: ",c),Promise.all(c.map(e=>e.then(e=>e,e=>e))).then(e=>{console.info("[Search] Hyperties from new Discovery",e);let t=e.map(function(e){if(e.hasOwnProperty("hypertyID"))return e;let t=Object.keys(e).reduceRight(function(t,r){let s=new Date(e[r].lastModified);return new Date(e[t].lastModified).getTime()<s.getTime()?r:t});return e[t]}).filter(e=>e.hasOwnProperty("hypertyID"));console.log("Requests result: ",t),e.forEach(function(e){if("No Hyperty was found"!==e)return i(t)}),a("No Hyperty was found")}).catch(t=>{console.error(t),i(e)})}})}}(e,t)}createContextObserver(e,t,r,s){return new He(e,t,r,s,this)}createContextReporter(e,t,r){return new Ne(e,t,r,this)}createNotificationHandler(e){return new class{constructor(e){if(!e)throw Error("[NotificationHandler Constructor] bus input is mandatory");this._bus=e,this._onNotificationHandler={}}onNotification(e,t){this._onNotificationHandler[e]=t}onCreate(e){let t=this,r=e.body.hasOwnProperty("resource")?e.body.resource:e.from.slice(0,-13),s=x(r).domain,o=r.split("://")[0],n=r=>{t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:400,desc:"Bad Request: "+r}})};e.body.hasOwnProperty("source")||n("Missing source"),e.body.hasOwnProperty("schema")||n("Missing schema"),e.body.hasOwnProperty("value")||n("Missing value"),e.body.hasOwnProperty("identity")||n("Missing identity");let i={type:e.type,from:e.body.source,url:r,domain:s,schema:e.body.schema,value:e.body.value,identity:e.body.identity,to:e.to,via:e.body.via,ack:r=>{let s=200;r&&(s=r),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:s}})},error:e=>{n(e)}};t._onNotificationHandler[o]&&(console.info("[NotificationHandler] NOTIFICATION-EVENT: ",i),t._onNotificationHandler[o](i))}onDelete(e){let t=this,r=e.body.resource,s=t._observers[r],o={from:t.owner,to:t._subURL,id:e.id,type:"unsubscribe",body:{resource:e.body.resource}};if(t._bus.postMessage(o),delete t._observers[r],s){let o={type:e.type,url:r,identity:e.body.identity,ack:r=>{let o=200;r&&(o=r),200===o&&s.delete(),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:o,source:t._owner}})}};t._onNotificationHandler&&(log.log("NOTIFICATION-EVENT: ",o),t._onNotificationHandler(o))}else t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,source:t._owner}})}}(e)}createMessageBodyIdentity(e,t,r,s,o,n,i,a){return new class{constructor(e,t,r,s,o,n,i,a){if(!n)throw new Error("IDP should be a parameter");if(!e)throw new Error("username should be a parameter");this.idp=n,i&&(this.assertion=i),this.userProfile=new class{constructor(e,t,r,s,o,n){e&&(this.preferred_username=e),r&&(this.picture=r),s&&(this.name=s),o&&(this.locale=o),t&&(this.userURL=t),n&&Object.assign(this,n)}}(e,t,r,s,o,a)}}(e,t,r,s,o,n,i,a)}createChatManager(e,t,r,s){return new class{constructor(e,t,r,s,o){if(!e)throw new Error("[ChatManager.constructor] The myUrl is a needed parameter");if(!t)throw new Error("[ChatManager.constructor] The MiniBus is a needed parameter");if(!r)throw new Error("[ChatManager.constructor] The configuration is a needed parameter");s||(s=o.createSyncher(e,t,r)),this._runtimeURL=r.runtimeURL;let n=o.divideURL(this._runtimeURL).domain,i=o.createDiscovery(e,r.runtimeURL,t),a=o.createIdentityManager(e,r.runtimeURL,t);this._objectDescURL="hyperty-catalogue://catalogue."+n+"/.well-known/dataschema/Communication",this._reportersControllers={},this._observersControllers={},this._myUrl=e,this._bus=t,this._syncher=s,this._domain=n,this.discovery=i,this.identityManager=a,this.currentIdentity,this.search=o.createSearch(i,a),this.communicationObject=Be,this.communicationChildren=Ke,console.log("[ChatManager] Discover ",i),console.log("[ChatManager] Identity Manager ",a)}set offline(e){this._offline=e}get offline(){return!!this._offline&&this._offline}processNotification(e){let t=this;if(console.log("[ChatManager.processNotification: ",e),"create"===e.type&&t._onInvitation&&t._onInvitation(e),"delete"===e.type){e.ack(200),t._observersControllers[e.url].closeEvent=e,delete t._observersControllers[e.url],t._observersControllers.closeEvent=e,t.communicationObject=Be;for(let t in this._reportersControllers)this._reportersControllers[t].close(e);for(let t in this._observersControllers)this._observersControllers[t].close(e)}}myIdentity(e){let t=this;return new Promise((r,s)=>{if(console.info("[ChatManager.myIdentity]"),e)return r(e);t._myUrl.includes("hyperty://")?t.identityManager.discoverUserRegistered().then(e=>{r(e)}).catch(function(e){s(e)}):t.identityManager.discoverIdentityPerIdP().then(e=>{r(e)}).catch(function(e){s(e)})})}create(e,t,r={}){let s=this,o=s._syncher;return new Promise((n,i)=>{let a;s.communicationObject=Be,s.communicationObject.cseq=1,s.communicationObject.startingTime=(new Date).toJSON(),s.communicationObject.status=Fe,s.myIdentity().then(c=>{a=c,console.log("[ChatManager.create ] My Identity",c);let u=new qe(s._myUrl,s._domain,c);s.communicationObject.participants[c.guid]=u,console.log("[ChatManager.create ] participants: ",s.communicationObject.participants),console.log("[ChatManager.create ] communicationObject",s.communicationObject),console.info("[ChatManager.create] searching "+t);let l=[],d=[],h={};t.forEach(e=>{let t=s.discovery.discoverHypertiesDO(e.user,["comm"],["chat"],e.domain);l.push(t)}),Promise.all(l).then(t=>{console.log("[ChatManager.create] Users Discovery Results->",t);let n=[];t.forEach(e=>{e.forEach(e=>{"live"===e.data.status?(n.push(e.data.hypertyID),h[e.data.hypertyID]=e):d.length<5&&d.push(e)})}),console.info("[ChatManager] ---------------------- Syncher Create ---------------------- \n"),console.info("[ChatManager] Selected Hyperties: !!! ",n),console.info(`Have ${n.length} users;`);let i=!r.mutual||r.mutual,a=Object.assign({resources:["chat"],mutual:i},r);return delete a.name,s.offline&&(a.offline=s.offline),console.info("[ChatManager] input data:",a),o.create(s._objectDescURL,n,s.communicationObject,!0,!1,e,{},a)}).then(function(e){console.info("[ChatManager] 3. Return Create Data Object Reporter",e);let t=new Ge(o,s.discovery,s._domain,s.search,a,s);t.dataObjectReporter=e,s._reportersControllers[e.url]=t,console.log("[ChatManager] chatController invitationsHandler: ",t.invitationsHandler),e.invitations.length>0&&t.invitationsHandler.processInvitations(h,e),d.length>0&&t.invitationsHandler.inviteDisconnectedHyperties(d,e),n(t)}).catch(function(e){i(e)})}).catch(e=>(console.log("[ChatManager.create] MyIdentity Error:",e),i(e)))})}onInvitation(e){this._onInvitation=e}join(e,t=!0,r){let s=this;return new Promise(function(o,n){let i,a=s._syncher;console.info("[ChatManager] ------------------------ Syncher subscribe ---------------------- \n"),console.info("invitationURL",e),s.myIdentity(r).then(r=>{i=r;let o={schema:s._objectDescURL,resource:e,store:!0,p2p:!1,mutual:t,domain_subscription:!0,identity:r};return s.offline&&(o.offline=s.offline),a.subscribe(o)}).then(function(e){console.info("Data Object Observer: ",e);let t=new Ge(a,s.discovery,s._domain,s.search,i,s);o(t),t.dataObjectObserver=e,s._observersControllers[e.url]=t}).catch(function(e){n(e)})})}}(e,t,r,s,this)}createChatController(e,t,r,s,o,n){return new Ge(e,t,r,s,o,n)}createSimpleChatManager(e,t,r,s){return new class{constructor(e,t,r,s,o){if(!e)throw new Error("[SimpleChatManager.constructor] The myUrl is a needed parameter");if(!t)throw new Error("[SimpleChatManager.constructor] The MiniBus is a needed parameter");if(!r)throw new Error("[SimpleChatManager.constructor] The configuration is a needed parameter");s||(s=o.createSyncher(e,t,r)),this._runtimeURL=r.runtimeURL;let n=o.divideURL(this._runtimeURL).domain,i=o.createIdentityManager(e,r.runtimeURL,t);this._objectDescURL="hyperty-catalogue://catalogue."+n+"/.well-known/dataschema/Communication",this._reportersControllers={},this._observersControllers={},this._myUrl=e,this._bus=t,this._syncher=s,this._domain=n,this._defaultStubTriggered=!1,this.identityManager=i,this.currentIdentity,this.communicationObject=Be,this.communicationChildren=Ke,console.log("[SimpleChatManager] Identity Manager ",i)}set offline(e){this._offline=e}get offline(){return!!this._offline&&this._offline}set backup(e){this._backup=e}get backup(){return!!this._backup&&this._backup}processNotification(e){let t=this;console.log("[SimpleChatManager.processNotification: ",e),"create"===e.type&&t._onInvitation&&t._onInvitation(e),"delete"===e.type&&(e.ack(200),t._onNotification&&t._onNotification(e),t._observersControllers[e.url]&&(t._observersControllers[e.url].closeEvent=e,delete t._observersControllers[e.url],t._observersControllers.closeEvent=e,t.communicationObject=Be))}myIdentity(e){let t=this;return new Promise((r,s)=>{if(console.info("[SimpleChatManager.myIdentity]"),e)return r(e);t._myUrl.includes("hyperty://")?t.identityManager.discoverUserRegistered().then(e=>{t.currentIdentity=e,r(e)}).catch(function(e){s(e)}):t.identityManager.discoverIdentityPerIdP().then(e=>{t.currentIdentity=e,r(e)}).catch(function(e){s(e)})})}create(e,t,r={}){let s=this,o=s._syncher;return new Promise((n,i)=>{let a;s.communicationObject=Be,s.communicationObject.cseq=1,s.communicationObject.startingTime=(new Date).toJSON(),s.communicationObject.status=Fe,s.myIdentity().then(n=>{a=n,console.log("[SimpleChatManager.create ] My Identity",n);let i=new qe(s._myUrl,s._domain,n);s.communicationObject.participants[n.guid]=i,console.log("[SimpleChatManager.create ] participants: ",s.communicationObject.participants),console.log("[SimpleChatManager.create ] communicationObject",s.communicationObject),console.info("[SimpleChatManager] ---------------------- Syncher Create ---------------------- \n"),console.info("[SimpleChatManager] Selected Hyperties: !!! ",t);let c=!r.mutual||r.mutual,u=Object.assign({resources:["chat"],mutual:c},r);return delete u.name,s.offline&&(u.offline=s.offline),s.backup&&(u.backup=s.backup),console.log("[SimpleChatManager] input data:",u),o.create(s._objectDescURL,t,s.communicationObject,!0,!1,e,{},u)}).then(function(e){console.info("[SimpleChatManager] 3. Return Create Data Object Reporter",e);let t=new Ve(o,s._domain,a,s);t.dataObjectReporter=e,s._reportersControllers[e.url]=t,n(t)}).catch(function(e){i(e)})}).catch(e=>(console.log("[SimpleChatManager.create] MyIdentity Error:",e),reject(e)))}onInvitation(e){this._onInvitation=e,this._triggerDefaultStubDeployment()}_triggerDefaultStubDeployment(){let e={from:this._myUrl,to:this._domain,type:"execute"};this._defaultStubTriggered||this._bus.postMessage(e),this._defaultStubTriggered=!0}onNotification(e){this._onNotification=e}join(e,t=!1,r){let s=this;return new Promise(function(o,n){let i,a=s._syncher;console.info("[SimpleChatManager] ------------------------ Syncher subscribe ---------------------- \n"),console.info("invitationURL",e),s.myIdentity(r).then(r=>{i=r;let o={schema:s._objectDescURL,resource:e,store:!0,p2p:!1,mutual:t,domain_subscription:!0,identity:r};return s.offline&&(o.offline=s.offline),a.subscribe(o)}).then(function(e){console.info("Data Object Observer: ",e);let t=new Ve(a,s._domain,i,s);o(t),t.dataObjectObserver=e,s._observersControllers[e.url]=t}).catch(function(e){n(e)})})}}(e,t,r,s,this)}createChat(e,t,r,s){return new Ve(e,t,r,s)}get divideURL(){return this._divideURL}createRegistrationStatus(e,t,r,s){return new De(e,t,r,s)}};class Je{constructor(e){let t=this;t._bus=e,t._factory=new We(e),t._components={},e.addListener(Je.InternalDeployAddress,e=>{switch(console.log("SandboxRegistry-RCV: ",e),e.type){case"create":t._onDeploy(e);break;case"delete":t._onRemove(e)}})}get components(){return this._components}_responseMsg(e,t,r){let s={id:e.id,type:"response",from:Je.InternalDeployAddress,to:Je.ExternalDeployAddress},o={};return t&&(o.code=t),r&&(o.desc=r),s.body=o,s}_onDeploy(e){let t,r,s=this,o=e.body.config,n=e.body.url,i=e.body.sourceCode;if(s._components.hasOwnProperty(n))t=500,r="Instance "+n+" already exist!";else try{console.log("SandboxRegistry-onDeploy: ",e),s._components[n]=s._create(n,i,o,s._factory),t=200}catch(e){t=500,r=e}let a=s._responseMsg(e,t,r);s._bus.postMessage(a)}_onRemove(e){let t,r,s=this,o=e.body.url;s._components.hasOwnProperty(o)?(delete s._components[o],s._bus.removeAllListenersOf(o),t=200):(t=500,r="Instance "+o+" doesn't exist!");let n=s._responseMsg(e,t,r);s._bus.postMessage(n)}_create(e,t,r,s){}}Je.ExternalDeployAddress="hyperty-runtime://sandbox/external",Je.InternalDeployAddress="hyperty-runtime://sandbox/internal";let Ye=s.getLogger("Bus");class ze{constructor(e,t,r){this._subscriptions=e,this._url=t,this._callback=r}get url(){return this._url}remove(){let e=this,t=e._subscriptions[e._url];if(t){let r=t.indexOf(e);t.splice(r,1),0===t.length&&delete e._subscriptions[e._url]}}}let $e,Qe="normal",Xe="window",Ze=s.getLogger("address-allocation");var et=class{constructor(e,t,r,s){if($e)return $e;this._url=e+"/address-allocation",this._bus=t,this._registry=r,this._subscriptionManager=s,$e=this}static get instance(){if(!$e)throw new Error("The address allocation was not instantiated");return $e}get url(){return this._url}create(e,t,r,s,o){return Ze.log("[AddressAllocation.create] info ",r),o?"boolean"==typeof o?o?this._reuseAllocatedAddress(e,t,r,s,o):this._allocateNewAddress(e,s,t,r):"string"==typeof o&&H(o)?new Promise((e,t)=>e({newAddress:!1,address:[o]})):void 0:(Ze.log("[AddressAllocation] - new address will be allocated"),this._allocateNewAddress(e,s,t,r))}_reuseAllocatedAddress(e,t,r,s,o){return new Promise((n,i)=>{console.log("REUSETEST -  _reuseAllocatedAddress",e,t,r,s,o),this._registry.checkRegisteredURLs(r,o).then(a=>{console.log("REUSETEST -  registeredurls",a),a?(Ze.info("[AddressAllocation - "+s+"] - Reuse URL"),n({newAddress:!1,address:a})):"string"==typeof o?(Ze.info("[AddressAllocation - reuseURL] - Object "+o+" not found"),i("URL Not Found")):"boolean"==typeof o?this._allocateNewAddress(e,s,t,r).then(n).catch(i):i("URL Not Found")})})}_allocateNewAddress(e,t,r,s){let o=this;return new Promise((n,i)=>{let a=[];var c;for(c=0;c<r;c++)a.push(t+"://"+e+"/"+K());let u={newAddress:!0,address:a};"hyperty"===t?s.hasOwnProperty("configuration")&&s.configuration.hasOwnProperty("domain_routing")&&!s.configuration.domain_routing?n(u):o._subscriptionManager.createSubscription(e,a,o._url).then(()=>{n(u)}):n(u)})}delete(e,t){return new Promise((e,t)=>{e(200)})}};let tt=s.getLogger("Registry");let rt=s.getLogger("P2PConnectionResolve");var st=class{constructor(){this._watching={},this._observers=[]}watch(e,t,r=!1){return this._watching[e]=r?Object.deepObserve(t,t=>{t.every(t=>{this._fireEvent(e,t)})}):Object.observe(t,t=>{t.every(t=>{this._fireEvent(e,t)})}),this._watching[e]}observe(e,t){this._observers.push({key:e,callback:t})}_fireEvent(e,t){this._observers.filter(t=>t.key===e).forEach(e=>{e.callback(t)})}};let ot=s.getLogger("Registry");const nt="created",it="live",at="deploying",ct="deployed",ut="in-progress",lt="disconnected",dt="deployment-failed";const ht={storageSchemas:{capabilities:{capabilities:"key,version,value"},subscriptions:{subscriptions:"key,version,value"},runtime:{"runtime:URL":"key,version,value","p2pHandler:URL":"key,version,value"},registry:{"registry:DataObjectURLs":"key,version,value","registry:HypertyURLs":"key,version,value"},cryptoManager:{userAsymmetricKey:"key,version,value",dataObjectSessionKeys:"key,version,value"},identity:{accessTokens:"key,version,value",identities:"userURL, userProfile.email, userProfile.userURL, userProfile.name"},runtimeCatalogue:{runtimeCatalogue:"&cguid, accessControlPolicy, constraints, dataObjects, type, objectName, sourcePackage, version, url"},policy:{"rethink:activePolicy":"key,version,value","rethink:groups":"key,version,value","rethink:userPolicies":"key,version,value","rethink:spPolicies":"key,version,value"},syncherManager:{"syncherManager:ObjectURLs":"key,version,value",remotes:"key,version,value"},hypertyResources:{hypertyResources:"&resourceURL, name, contentUrl, content, created, reporter, resourceType"}},runtimeURLS:{registry:{prefix:"hyperty-runtime://",suffix:"registry"},identityModule:{prefix:"hyperty-runtime://",suffix:"/idm"},runtimeUA:{prefix:"hyperty-runtime://",suffix:"/ua"},catalogue:{prefix:"hyperty-runtime://",suffix:"/catalogue"},graphConnector:{prefix:"hyperty-runtime://",suffix:"/graph"},syncManager:{prefix:"hyperty-runtime://",suffix:"/sm"}},catalogueURLs:{protocolstub:{prefix:"https://",suffix:"/.well-known/protocolstub/",fallback:"https://%domain%/.well-known/protocolstub/"},"idp-proxy":{prefix:"https://",suffix:"/.well-known/idp-proxy/",fallback:"https://%domain%/.well-known/idp-proxy/",all:"/all.json"}},msgNodeURL:{prefix:"domain://msg-node.",suffix:"",hypertyAddressAllocation:"/hyperty-address-allocation",objectAddressAllocation:"/object-address-allocation",subscriptionManagement:"/sm"},domainRegistryURL:{prefix:"domain://registry.",suffix:""},globalRegistryURL:"global://registry.",remoteStorage:"https://admin:admin@backup.rethink.alticelabs.com"};let yt=s.getLogger("IdentityModule");class pt{constructor(e,t,r){this._assertion=e,this._idp=t,this._userProfile=r}get assertion(){return this._assertion}get idp(){return this._idp}get userProfile(){return this._userProfile}}var ft=class{constructor(e,t){this._watchingYou=new st,this._storageManager=t,this._guid,this._type=e,this._identities={},this._accessTokens=this.watchingYou.watch("accessTokens",{},!0)}reset(){this._identities={},console.log(this),this.currentIdentity=void 0,this.defaultIdentity=void 0}get identities(){return this._identities}get accessTokens(){return this._accessTokens}get watchingYou(){return this._watchingYou}set guid(e){this._guid=e}get guid(){return this._guid}set defaultIdentity(e){if(!this.identities[e])throw new Error("[Identities.set defaultIdentity ] Error: identity does not exist here: ",e);this._defaultIdentity=e}set currentIdentity(e){if(!this.identities[e])throw e;this._currentIdentity=e}get defaultIdentity(){return!!this._defaultIdentity&&Object.assign({},this.identities[this._defaultIdentity])}get currentIdentity(){return Object.assign({},this.identities[this._currentIdentity])}get identifiers(){return Object.keys(this._identities)}getIdentity(e){return Object.assign({},this._identities[e])}loadIdentities(){let e=this;return new Promise(t=>{e._storageManager.get(null,null,"identities").then(r=>{yt.info("[Identities.Load Identities] identities: ",r),r&&(e._identities=r,e.identifiers.forEach(t=>{let r=k(),s=e._identities[t].expires;e.defaultIdentity=t,parseInt(s)>r&&(e.defaultIdentity.expires=parseInt(s),e.currentIdentity=t)})),t()})})}loadAccessTokens(){let e=this;return new Promise(t=>{e._storageManager.get("accessTokens").then(r=>{r&&(e._accessTokens=r),t()})})}addIdentity(e){let t=this;return new Promise((r,s)=>{if(t._isValid(e)){let t=e.identifiers[0];Object.assign(this._identities[t],e),this._storeIdentity(e).then(()=>{this._identities[t].status="created",r()})}else s("[Identities.addIdentity] invalid IdAssertion")})}addAssertion(e){let t=this;return new Promise((r,s)=>{if(t._isValid(e)){e.userProfile.guid=t._guid;let s=e.userProfile.userURL;t.identities[s]?t.identities[s]=e:t._identities[s]=e,t._store().then(()=>{this._identities[s].status="created",0==t.defaultIdentity&&(t.defaultIdentity=s),r(e)})}else s("[Identities.addAssertion] invalid IdAssertion: ",e)})}removeIdentity(e){let t=this;return new Promise((r,s)=>{delete t.identities[e],t._store().then(()=>{r()})})}addAccessToken(e){let t=this;return yt.info("[Identities.addAccessToken] ",e),new Promise((r,s)=>{t._isValidAccessToken(e)?(t._accessTokens[e.domain]=e,t._storeAccessTokens().then(()=>{t._accessTokens[e.domain].status="created",r(e)})):s("[Identities.addIdentity] invalid AccessToken: ",e)})}setAccessTokenInProgress(e){this._accessTokens[e]?this._accessTokens[e].status="in-progress":this._accessTokens[e]={status:"in-progress"}}getAccessToken(e,t){let r=this._accessTokens[e];return r?t.every(e=>-1!=r.resources.indexOf(e))?this._accessTokens[e]:new Error("[Identities.getAccessToken] Not found for ",e):void 0}removeAccessToken(e,t){let r=this;return new Promise(s=>{let o=this._accessTokens[e];o&&t.every(e=>-1!=o.resources.indexOf(e))?(delete this._accessTokens[e],r._storeAccessTokens().then(()=>{s()})):s()})}updateAssertion(e){let t=this;return new Promise(r=>{let s=e.userProfile.userURL;if(!t.identities[s])return reject("[Identities.updateAssertion] Identity not found for ",s);t.identities[s]=e,t._store().then(()=>{r()})})}updateAccessToken(e){let t=this;return yt.info("[Identities.updateAccessToken] ",e),new Promise((r,s)=>{t._isValidAccessToken(e)?(t._accessTokens[e.domain].expires=e.expires,t._accessTokens[e.domain].accessToken=e.accessToken,t._storeAccessTokens().then(()=>{t._accessTokens[e.domain].status="created",r(e)})):s("[Identities.updateAccessToken] invalid AccessToken: ",e)})}addIdAssertion(e,t,r,s){let o=new pt(t,r,s);this.idAssertionList.push(o)}_isValid(e){if(!e.hasOwnProperty("assertion"))return!1;let t,r=e.assertion.split(".");try{t=r[1]?X(r[1]):X(e.assertion)}catch(e){return!1}return!0}_isValidAccessToken(e){return!!(e.hasOwnProperty("accessToken")&&e.hasOwnProperty("domain")&&e.hasOwnProperty("resources")&&Array.isArray(e.resources)&&e.hasOwnProperty("expires")&&Number.isInteger(e.expires)&&e.hasOwnProperty("input"))}_store(){let e=this;return new Promise((t,r)=>{const s=Object.keys(this._identities).map(t=>e._storageManager.set(t,0,this._identities[t],"identities"));Promise.all(s).then(()=>{t()}).catch(e=>{r("On _sendReporterSessionKey from method storeIdentity error: "+e)})})}_storeAccessTokens(){let e=this;return new Promise((t,r)=>{let s=I(e._accessTokens);e._storageManager.set("accessTokens",0,s).then(()=>{t()}).catch(e=>{r("On _sendReporterSessionKey from method storeIdentity error: "+e)})})}};let gt=s.getLogger("IdentityModule");let bt=s.getLogger("IdentityModule");let mt=s.getLogger("RuntimeUA");let _t=s.getLogger("IdentityHandler");var vt=class{and(e){return e[0]&&e[1]}between(e){let t=parseInt(e[0][0]),r=parseInt(e[0][1]),s=e[1];return r<t&&(s=s<t?s+=2400:s,r+=2400),s>t&&s<r}equals(e){return"*"===String(e[0])||String(e[0])===String(e[1])}greaterThan(e){return e[1]>e[0]}in(e){return e[0].indexOf(e[1])>-1}lessThan(e){return e[1]<e[0]}not(e){return!e[0]}or(e){return e[0]||e[1]}},wt=class{combine(e){return-1!==e.indexOf(!0)||-1===e.indexOf(!1)&&"Not Applicable"}},Rt=class{combine(e){return-1===e.indexOf(!1)&&(-1!==e.indexOf(!0)||"Not Applicable")}},Ot=class{combine(e){for(let t in e)if("Not Applicable"!==e[t])return e[t];return"Not Applicable"}},St=class{constructor(e,t,r){this.attribute=e,this.operator=t,this.params=r,this.operators=new vt}isApplicable(e,t){e[this.attribute]={message:t};let r,s=e[this.attribute];return"in"!==this.operator||Array.isArray(this.params)?this.operators[this.operator]([this.params,s]):(r=e.getGroup(this.params,t.to),this.operators[this.operator]([r,s]))}},Pt=class extends St{constructor(e,t,r){super(e,t,r)}isApplicable(e,t){return!!("subscribe"===t.type&e.isFromRemoteSM(t.from))&&super.isApplicable(e,t)}},Lt=class{constructor(e){this.operators=new vt,void 0!==e.operators&&(e=e.condition),e=this.buildCondition(e),this.condition=e}buildCondition(e){return Array.isArray(e[1])?e[1]=this.buildCondition(e[1]):"subscription"===e[1].attribute?e[1]=new Pt(e[1].attribute,e[1].operator,e[1].params):e[1]=new St(e[1].attribute,e[1].operator,e[1].params),void 0!==e[2]&&(Array.isArray(e[2])?e[2]=this.buildCondition(e[2]):"subscription"===e[2].attribute?e[2]=new Pt(e[2].attribute,e[2].operator,e[2].params):e[2]=new St(e[2].attribute,e[2].operator,e[2].params)),e}isApplicable(e,t,r,s,o,n,i){for(o||(o=this.condition[0],n=this.condition[1],i=this.condition[2]);!(n instanceof St)&!(n instanceof Pt)&"boolean"!=typeof n;)n=this.isApplicable(e,t,r,s,n[0],n[1],n[2]);if(void 0!==i)for(;!(i instanceof St)&!(i instanceof Pt)&"boolean"!=typeof i;)i=this.isApplicable(e,t,r,s,i[0],i[1],i[2]);let a,c="boolean"==typeof n?n:n.isApplicable(e,t,r,s);return void 0!==i&&(a="boolean"==typeof i?i:i.isApplicable(e,t,r,s)),this.operators[o]([c,a])}},Mt=class{constructor(e,t,r,s,o){this.decision=e,this.setCondition(t),this.priority=o,this.scope=r,this.target=s}setCondition(e){if(e instanceof St||e instanceof Lt||e instanceof Lt)this.condition=e;else switch(e.attribute){case"subscription":this.condition=new Lt(e.attribute,e.operator,e.params);break;case void 0:this.condition=new Lt(e);break;default:this.condition=new St(e.attribute,e.operator,e.params)}}evaluate(e,t,r){let s,o=r?t.to:t.from;switch(this.scope){case"global":break;case"hyperty":if(E(o)){let t=e.runtimeRegistry.getReporterURLSynchonous(D(o));void 0!==t&&(s=e.runtimeRegistry.getHypertyName(t))}else"hyperty"===o.split("://")[0]&&(s=e.runtimeRegistry.getHypertyName(D(o)));if(s===this.target)break;return"Not Applicable";case"identity":let t;if(E(o)){let r=e.runtimeRegistry.getReporterURLSynchonous(D(o));t=e.runtimeRegistry.getHypertyOwner(r)}else"hyperty"===o.split("://")[0]&&(t=e.runtimeRegistry.getHypertyOwner(D(o)));if(void 0!==t&&(t=A(t)),t===this.target)break;return"Not Applicable"}return this.condition.isApplicable(e,t,this.scope,this.target)?this.decision:"Not Applicable"}},jt=class{constructor(e,t,r,s){if(!e)throw new Error("key is not defined");if(!r)throw new Error("actions are not defined");this.actions=r,this.key=e,this._setRules(t),this._setCombiningAlgorithm(s)}addAction(e,t){this.actions.push({method:e,param:t})}createRule(e,t,r,s,o){void 0===o&&(o=this.getLastPriority()+1);let n=new Mt(e,t,r,s,o);this.rules.push(n)}deleteRule(e){let t=this.rules.indexOf(e);this.rules.splice(t,1)}enforceActions(e,t){return new Promise((r,s)=>{let o=[];if(0!==this.actions.length){for(let r in this.actions){let s=e.pep.actionsService[this.actions[r].method](t,this.actions[r].param);o.push(s)}Promise.all(o).then(e=>{r(e)},e=>{s(e)})}else r([t])})}evaluateRules(e,t,r){let s=[];for(let o in this.rules)s.push(this.rules[o].evaluate(e,t,r));return this.combiningAlgorithm.combine(s)}getLastPriority(){let e=[];if(0!==this.rules.length){for(let t in this.rules)e.push(this.rules[t].priority);return Math.max.apply(Math,e)}return-1}getRuleByPriority(e){for(let t in this.rules)if(String(this.rules[t].priority)===String(e))return this.rules[t];throw Error("Rule with priority "+e+" does not exist!")}_setCombiningAlgorithm(e){switch(e||(e="blockOverrides"),e){case"blockOverrides":this.combiningAlgorithm=new Rt;break;case"allowOverrides":this.combiningAlgorithm=new wt;break;case"firstApplicable":this.combiningAlgorithm=new Ot;break;default:throw Error("Unknown algorithm: "+e)}}_setRules(e){this.rules=[];for(let t in e){let r=e[t];void 0===r.priority&&(r.priority=this.getLastPriority()+1),r instanceof Mt||(r=new Mt(r.decision,r.condition,r.scope,r.target,r.priority)),this.rules.push(r)}}sortRules(){return this.rules.sort(function(e,t){let r=e.priority,s=t.priority;return r<s?-1:r>s?1:0})}};s.getLogger("PEP");s.getLogger("Pipeline");class Ut{constructor(e,t,r,s){this._inStop=!1,this._pipeline=e,this._iter=t,this._msg=r,this._onDeliver=s}get pipeline(){return this._pipeline}get msg(){return this._msg}set msg(e){this._msg=e}next(){let e=this;e._inStop||(e._iter.hasNext?e._iter.next(e):e._onDeliver(e._msg))}deliver(){let e=this;e._inStop||(e._inStop=!0,e._onDeliver(e._msg))}fail(e){let t=this;t._inStop||(t._inStop=!0,t._pipeline.onFail&&t._pipeline.onFail(e))}}class xt{constructor(e){this._index=-1,this._array=e}get hasNext(){return this._index<this._array.length-1}get next(){return this._index++,this._array[this._index]}}var Ct=class{constructor(e){this.handlers=[],this.onFail=e}process(e,t){let r=this;if(r.handlers.length>0){let s=new xt(r.handlers);s.next(new Ut(r,s,e,t))}else t(e)}};let kt=s.getLogger("MessageBus");function It(e){for(var t=0,r=new Uint8Array(4*e.length),s=0;s!=e.length;s++){try{e.charCodeAt(s)}catch(e){return void console.log(e.message)}var o=e.charCodeAt(s);if(o<128)r[t++]=o;else{if(o<2048)r[t++]=o>>6|192;else{if(o>55295&&o<56320){if(++s==e.length)throw"UTF-8 encode: incomplete surrogate pair";var n=e.charCodeAt(s);if(n<56320||n>57343)throw"UTF-8 encode: second char code 0x"+n.toString(16)+" at index "+s+" in surrogate pair out of range";o=65536+((1023&o)<<10)+(1023&n),r[t++]=o>>18|240,r[t++]=o>>12&63|128}else r[t++]=o>>12|224;r[t++]=o>>6&63|128}r[t++]=63&o|128}}return r.subarray(0,t)}let Dt=s.getLogger("CryptoManager");let At=s.getLogger("CryptoManager");var Et=new class{constructor(e){this.storageManager=e,this.userDefaultKeyRef="userAsymmetricKey"}init(e,t,r,s,o,n,i,a){if(!e)throw new Error("[] runtimeURL is missing.");if(!r)throw new Error("storageManager is missing");if(!a)throw new Error("runtimeFactory is missing");this._runtimeURL=e,this._cryptoManagerURL=this._runtimeURL+"/cryptoManager",this.storageManager=r,this.dataObjectsStorage=s,this.runtimeCapabilities=t,this._runtimeFactory=a,this._domain=x(this._runtimeURL).domain,this.crypto=new class{constructor(e){"function"==typeof e.createWebcrypto?this._crypto=e.createWebcrypto():this._crypto=crypto}encryptRSA(e,t){Dt.log("encryptRSA:pubKey",e),Dt.log("encryptRSA:data",t);let r=this;return new Promise(function(s,o){r._importRSAencryptKey(new Uint8Array(e)).then(function(e){r._crypto.subtle.encrypt({name:"RSA-OAEP"},e,t).then(function(e){s(new Uint8Array(e))}).catch(function(e){o(e)})})})}decryptRSA(e,t){Dt.log("decryptRSA:privKey",e),Dt.log("decryptRSA:data",t);let r=this;return new Promise(function(s,o){r._importRSAdecryptKey(e).then(function(e){r._crypto.subtle.decrypt({name:"RSA-OAEP"},e,t).then(function(e){let t=new Uint8Array(e);s(t)}).catch(function(e){o(e)})})})}signRSA(e,t){let r=this;return new Promise(function(s,o){r._importRSAsignKey(e).then(function(e){r._crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,It(t)).then(function(e){s(new Uint8Array(e))}).catch(function(e){o(e)})})})}verifyRSA(e,t,r){let s=this;return new Promise(function(o,n){s._importRSAverifyKey(e).then(function(e){s._crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5"},e,r,It(t)).then(function(e){o(e)}).catch(function(e){n(e)})})})}encryptAES(e,t,r){Dt.log("encryptAES:key",e),Dt.log("encryptAES:data",t),Dt.log("encryptAES:iv",r);let s=this;return new Promise(function(o,n){s._importAESkey(e).then(function(e){s._crypto.subtle.encrypt({name:"AES-CBC",iv:r},e,It(t)).then(function(e){o(new Uint8Array(e))}).catch(function(e){n(e)})})})}decryptAES(e,t,r){Dt.log("decryptAES:key",e),Dt.log("decryptAES:data",t),Dt.log("decryptAES:iv",r);let s=this;return new Promise(function(o,n){s._importAESkey(e).then(function(e){s._crypto.subtle.decrypt({name:"AES-CBC",iv:r},e,t).then(function(e){let t=function(e){for(var t="",r=0;r<e.length;){var s=e[r++];if(s>127){if(s>191&&s<224){if(r>=e.length)throw"UTF-8 decode: incomplete 2-byte sequence";s=(31&s)<<6|63&e[r]}else if(s>223&&s<240){if(r+1>=e.length)throw"UTF-8 decode: incomplete 3-byte sequence";s=(15&s)<<12|(63&e[r])<<6|63&e[++r]}else{if(!(s>239&&s<248))throw"UTF-8 decode: unknown multibyte start 0x"+s.toString(16)+" at index "+(r-1);if(r+2>=e.length)throw"UTF-8 decode: incomplete 4-byte sequence";s=(7&s)<<18|(63&e[r])<<12|(63&e[++r])<<6|63&e[++r]}++r}if(s<=65535)t+=String.fromCharCode(s);else{if(!(s<=1114111))throw"UTF-8 decode: code point 0x"+s.toString(16)+" exceeds UTF-16 reach";s-=65536,t+=String.fromCharCode(s>>10|55296),t+=String.fromCharCode(1023&s|56320)}}return t}(new Uint8Array(e));Dt.log("crypto-decryptAES",t),o(t)}).catch(function(e){n(e)})})})}hashHMAC(e,t){Dt.log("hashHMAC:key",e),Dt.log("hashHMAC:data",t);let r=this;return new Promise(function(s,o){"string"!=typeof t&&(t=JSON.stringify(t),Dt.log("Converting hashHMAC inpured DATA"),Dt.log("HHashHMAC:",t)),r._importHMACkey(e).then(function(e){r._crypto.subtle.sign({name:"HMAC"},e,It(t)).then(function(e){Dt.log("HashHMAC signature:",new Uint8Array(e)),s(new Uint8Array(e))}).catch(function(e){o(e)})})})}verifyHMAC(e,t,r){Dt.log("verifyHMAC:key",e),Dt.log("verifyHMAC:data",t),Dt.log("verifyHMAC:signature",r);let s=this;return new Promise(function(o,n){s._importHMACkey(e).then(function(e){"string"!=typeof t&&(t=JSON.stringify(t),Dt.log("Converting verifyHMAC inputed DATA:",t)),s._crypto.subtle.verify({name:"HMAC"},e,r,It(t)).then(function(e){Dt.log("verifyHMAC result",e),e?o(e):n(e)}).catch(function(e){Dt.error("crypto-verifyHMAC",e),n(e)})})})}generateRSAKeyPair(){let e=this,t={};return new Promise(function(r,s){e._crypto.subtle.generateKey({name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(o){e._crypto.subtle.exportKey("spki",o.publicKey).then(function(r){return t.public=new Uint8Array(r),e._crypto.subtle.exportKey("pkcs8",o.privateKey)}).then(function(e){t.private=new Uint8Array(e),r(t)}).catch(function(e){Dt.error(e),s(e)})}).catch(function(e){Dt.error(e),s(e)})})}generateIV(){let e=new Uint8Array(16);return this._crypto.getRandomValues(e),e}generateRandom(){let e=new Uint8Array(32);this._crypto.getRandomValues(e);let t=It(Date.now().toString()),r=t.slice(t.length-4,t.length);for(let t=0;t<4;t++)e[t]=r[t];return e}generatePMS(){let e=new Uint8Array(48);return this._crypto.getRandomValues(e),e}generateMasterSecret(e,t){let r=this;return new Promise(function(s,o){let n=new Uint8Array(48),i=t;r._digest(e).then(e=>{r.hashHMAC(e,i).then(function(t){for(let e=0;e<32;e++)n[e]=t[e];return r.hashHMAC(e,i+t)}).then(function(e){for(let t=0;t<16;t++)n[t+32]=e[t];s(n)}).catch(function(e){o(e)})})})}generateKeys(e,t){let r=this;return new Promise(function(s,o){let n=[],i=t;r.hashHMAC(e,i).then(function(t){return n.push(t),r.hashHMAC(e,i+t)}).then(function(t){return n.push(t),r.hashHMAC(e,i+t)}).then(function(t){return n.push(t),r.hashHMAC(e,i+t)}).then(function(e){n.push(e),s(n)}).catch(function(e){o(e)})})}_importRSAsignKey(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.importKey("pkcs8",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(e){r(e)}).catch(function(e){Dt.error("crypto-_importRSAsignKey",e),s(e)})})}_importRSAverifyKey(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.importKey("spki",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"]).then(function(e){r(e)}).catch(function(e){Dt.error("crypto-_importRSAverifyKey",e),s(e)})})}_importRSAencryptKey(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:{name:"SHA-256"}},!0,["encrypt"]).then(function(e){r(e)}).catch(function(e){Dt.error("crypto-_importRSAencryptKey",e.name),s(e)})})}_importRSAdecryptKey(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.importKey("pkcs8",e,{name:"RSA-OAEP",hash:{name:"SHA-256"}},!0,["decrypt"]).then(function(e){r(e)}).catch(function(e){Dt.error("crypto-_importRSAdecryptKey",e),s(e)})})}concatPMSwithRandoms(e,t,r){let s=new Uint8Array(e.length+t.length+r.length);for(let t=0;t<e.length;t++)s[t]=e[t];for(let r=0;r<t.length;r++)s[r+e.length]=e[r];for(let o=0;o<r.length;o++)s[o+e.length+t.length]=e[o];return s}_generate256bitKey(){let e=new Uint8Array(32);return this._crypto.getRandomValues(e),e}_importHMACkey(e){let t=this;return new Promise(function(r,s){t._digest(e).then(e=>{t._crypto.subtle.importKey("raw",e,{name:"HMAC",hash:{name:"SHA-256"},length:256},!0,["sign","verify"]).then(function(e){r(e)}).catch(function(e){s(e)})})})}_digest(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.digest({name:"SHA-256"},e).then(function(e){r(new Uint8Array(e))}).catch(function(e){Dt.error(e),s(e)})})}_importAESkey(e){let t=this;return new Promise(function(r,s){t._crypto.subtle.importKey("raw",e,{name:"AES-CBC"},!0,["encrypt","decrypt"]).then(function(e){r(e)}).catch(function(e){Dt.error("crypto-importAESkey",e),s(e)})})}_sha256(e){let t=this,r=new TextEncoder("utf-8").encode(e);return t._crypto.subtle.digest("SHA-256",r).then(function(e){return t._hex(e)})}_hex(e){let t=[],r=new DataView(e);for(let e=0;e<r.byteLength;e+=4){let s="00000000",o=(s+r.getUint32(e).toString(16)).slice(-s.length);t.push(o)}return t.join("")}}(this._runtimeFactory),this.chatKeys={},this.dataObjectSessionKeys={},this.isToUseEncryption=!0,this._registry=o,this._coreDiscovery=n,this._idm=i}get messageBus(){return this._messageBus}set messageBus(e){this._messageBus=e,this.addCryptoGUIListeners()}get coreDiscovery(){return this._coreDiscovery}set coreDiscovery(e){this._coreDiscovery=e}get registry(){return this._registry}set registry(e){this._registry=e}loadSessionKeys(){let e=this;return new Promise(t=>{e.storageManager.get("dataObjectSessionKeys").then(r=>{e.dataObjectSessionKeys=r||{},t()})})}_isFromRemoteSM(e){return"runtime"===e.split("://")[0]&&e!==this._runtimeURL+"/sm"}addCryptoGUIListeners(){let e=this;e._messageBus.addListener(e._cryptoManagerURL,t=>{"generateRSAKeyPair"!==t.body.method||e._crypto.getMyPublicKey().then(r=>{let s={type:"execute",value:r,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){At.error("On addGUIListeners from if generateRSAKeyPair method postMessage error: "+e)}})})}_isToEncrypt(e){At.log("[CryptoManager._isToEncrypt]",e);let t="create"===e.type,r=e.from.includes("hyperty://"),s=e.to.includes("hyperty://"),o=E(e.to),n=this.registry.getDataObjectReporter(e.to),i=e.hasOwnProperty("body")&&e.body.hasOwnProperty("mutual")?e.body.mutual:!(e.hasOwnProperty("body")&&e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("mutual"))||e.body.value.mutual;return!!i&&(null===n||!T(n))&&(this.isToUseEncryption||"handshake"===e.type?"update"===e.type?(At.info("update:encryption disabled"),!1):"forward"===e.type?(At.info("forward:encryption disabled"),!1):!T(e.to)&&(t&&r&&s||t&&r&&o&&i||"handshake"===e.type||"update"===e.type&&i):(At.info("not handshake: encryption disabled"),!1))}_isToDecrypt(e){let t=this;return new Promise((r,s)=>{let o="subscribe"===e.type,n=t._isFromRemoteSM(e.from),i=e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("mutual")?e.body.value.mutual:!e.body.hasOwnProperty("mutual")||e.body.mutual;if(o&&n&&i){At.log("[CryptoManager._isToDecrypt] _doMutualAuthenticationPhase1"),console.log("[CryptoManager._isToDecrypt] ",e);let o=t.registry.getDataObjectReporter(e.to);if(null!==o&&T(o))return r(!1);t._doMutualAuthenticationPhase1(e).then(()=>{r(!1)},e=>{s(e)})}else e.hasOwnProperty("body")&&e.body.hasOwnProperty("value")&&"string"==typeof e.body.value&&i?(At.log("[CryptoManager._isToDecrypt] true"),r(!0)):(At.log("[CryptoManager._isToDecrypt] false"),r(!1))}).catch(e=>{At.error("[CryptoManager._isToDecrypt]",e)})}encryptMessage(e){let t=this;return At.log("encrypt message "),new Promise(function(r,s){let o="handshake"===e.type;if(!t._isToEncrypt(e))return r(e);let n=z(e.to),i=E(n),a=T(e.to),c="hyperty"===x(e.from).type,u="hyperty"===x(e.to).type;if("update"===e.type)return At.log("encrypt message: message type update"),r(e);if(a)r(e);else if(c&&u){let n=t._registry.getHypertyOwner(e.from);if(n){let i=t.chatKeys[e.from+"<->"+e.to];if(i||(i=t._newChatCrypto(e,n),t.chatKeys[e.from+"<->"+e.to]=i,e.body.handshakePhase="startHandShake"),i.authenticated&&!o){let s=t.crypto.generateIV();t.crypto.encryptAES(i.keys.hypertyFromSessionKey,ee(e.body.value),s).then(o=>{let n=t._filterMessageToHash(e,ee(e.body.value)+ee(s),i.hypertyFrom.messageInfo);t.crypto.hashHMAC(i.keys.hypertyFromHashKey,n).then(t=>{let n={iv:Q(s),value:Q(o),hash:Q(t)};e.body.value=Q(n),r(e)})})}else o?r(e):t._doHandShakePhase(e,i).then(function(r){t.chatKeys[e.from+"<->"+e.to]=r.chatKeys,t._messageBus.postMessage(r.message),s("encrypt handshake protocol phase ")})}else s("In encryptMessage: Hyperty owner URL was not found")}else c&&i&&t.storageManager.get("dataObjectSessionKeys").then(o=>{let i=(o=Y(o||{}))?o[n]:null;t.dataObjectsStorage.getDataObject(n).then(o=>{if(!i&&o.reporter&&o.reporter===e.from){let e=t.crypto.generateRandom();t.dataObjectSessionKeys[n]={sessionKey:e,isToEncrypt:!0};let r=J(t.dataObjectSessionKeys);t.storageManager.set("dataObjectSessionKeys",0,r).catch(e=>{s("On encryptMessage from method storageManager.set error: "+e)}),i=t.dataObjectSessionKeys[n]}if(i)if(i.isToEncrypt){let s=t.crypto.generateIV(),o=ee(s),n=ee(e.body.value);t.crypto.encryptAES(i.sessionKey,n,s).then(a=>{delete e.body.identity.assertion,delete e.body.identity.expires;let c=t._filterMessageToHash(e,n+o);t.crypto.hashHMAC(i.sessionKey,c).then(t=>{let o={value:Q(a),iv:Q(s),hash:Q(t)};e.body.value=ee(o),r(e)})})}else r(e);else s("Data object key could not be defined: Failed to decrypt message ")}).catch(e=>{s("On encryptMessage from method dataObjectsStorage.getDataObject error: "+e)})}).catch(e=>{s("On encryptMessage from method storageManager.get error: "+e)})})}encryptDataObject(e,t){let r=this;return new Promise(function(s,o){At.info("dataObject value to encrypt: ",e);let n=z(t);r.storageManager.get("dataObjectSessionKeys").then(t=>{let i=(t=Y(t||{}))?t[n]:null;if(!i)return o("No dataObjectKey for this dataObjectURL:",n);if(!i.isToEncrypt)return At.info("The dataObject is not encrypted"),s(e);{let t=r.crypto.generateIV();r.crypto.encryptAES(i.sessionKey,ee(e),t).then(e=>{let r={value:Q(e),iv:Q(t)};return s(r)}).catch(e=>{o("On encryptDataObject from method encryptAES error: "+e)})}}).catch(e=>{o("On encryptDataObject from method storageManager.get error: "+e)})})}decryptMessage(e){let t=this;return new Promise(function(r,s){let o="handshake"===e.type;t._isToDecrypt(e).then(n=>{if(!n)return r(e);let i=z(e.to),a=E(i),c="hyperty"===x(e.from).type,u="hyperty"===x(e.to).type;if("update"===e.type)return r(e);if(c&&u){let n=t._registry.getHypertyOwner(e.to);if(n){let i=t.chatKeys[e.to+"<->"+e.from];if(i||(i=t._newChatCrypto(e,n,"decrypt"),t.chatKeys[e.to+"<->"+e.from]=i),i.authenticated&&!o){let s=X(e.body.value),o=Z(s.iv),n=Z(s.value),a=Z(s.hash);t.crypto.decryptAES(i.keys.hypertyToSessionKey,n,o).then(s=>{e.body.value=s;let n=t._filterMessageToHash(e,s+o);t.crypto.verifyHMAC(i.keys.hypertyToHashKey,n,a).then(t=>{e.body.assertedIdentity=!0,r(e)})})}else o?t._doHandShakePhase(e,i).then(function(r){"handShakeEnd"===r||(t.chatKeys[e.to+"<->"+e.from]=r.chatKeys,t._messageBus.postMessage(r.message))}):s("wrong message do decrypt")}else s("error on decrypt message")}else c&&a?t.storageManager.get("dataObjectSessionKeys").then(o=>{let n=(o=Y(o||{}))?o[i]:null;if(n)if(n.isToEncrypt){let o=te(e.body.value),i=Z(o.iv),a=Z(o.value),c=Z(o.hash);t.crypto.decryptAES(n.sessionKey,a,i).then(o=>{let a=te(o);e.body.value=a;let u=t._filterMessageToHash(e,ee(a)+ee(i));t.crypto.verifyHMAC(n.sessionKey,u,c).then(t=>{At.log("Received message HMAC result",t),e.body.assertedIdentity=!0,r(e)}).catch(e=>{s("Message HMAC is invalid: "+e)})})}else e.body.assertedIdentity=!0,r(e);else e.body.assertedIdentity=!0,r(e)}):s("wrong message to decrypt")})})}decryptDataObject(e,t){let r=this;return new Promise(function(s,o){if(!r.isToUseEncryption)return s(e);let n=z(t);r.storageManager.get("dataObjectSessionKeys").then(t=>{let i=(t=Y(t))?t[n]:null;if(!i)return o("No dataObjectKey for this dataObjectURL:",n);if(!i.isToEncrypt)return s(e);{let t=Z(e.iv),n=Z(e.value);r.crypto.decryptAES(i.sessionKey,n,t).then(e=>{let r={value:te(e),iv:Q(t)};return s(r)}).catch(e=>{o("On decryptDataObject from method encryptAES error: "+e)})}})})}_doMutualAuthenticationPhase1(e){let t=this;return new Promise(function(r,s){let o=e.to.split("/");o.pop();let n=o[0]+"//"+o[2]+"/"+o[3];t._doMutualAuthenticationPhase2(n,e.body.subscriber).then(()=>{t._registry.registerSubscriber(n,e.body.subscriber),r()},e=>{s(e)})})}_doMutualAuthenticationPhase2(e,t){At.info("doMutualAuthentication:sender ",e),At.info("doMutualAuthentication:receiver ",t);let r=this;return new Promise(function(s,o){let n,i=r._registry.getReporterURLSynchonous(e);i&&(n=e,e=i);let a={to:t,from:e,callback:void 0,body:{handshakePhase:"startHandShake",ignore:"ignoreMessage"}};if(!e||!t)return o("sender or receiver missing on doMutualAuthentication");let c=r.chatKeys[e+"<->"+t],u=r._registry.getHypertyOwner(e);if(u){if(!c){let o=function(e){s(e)};a.callback=o,a.dataObjectURL=n,c=r._newChatCrypto(a,u),r.chatKeys[e+"<->"+t]=c}if(c.authenticated){let i={to:e,from:t};c.dataObjectURL=n,r._sendReporterSessionKey(i,c).then(e=>{r._messageBus.postMessage(e.message),s("exchange of chat sessionKey initiated")}).catch(e=>{o("On doMutualAuthentication from method _sendReporterSessionKey error: "+e)})}else r._doHandShakePhase(a,c)}else o("Mutual authentication error: Hyperty owner could not be resolved")})}_sendReporterSessionKey(e,t){let r=this;return new Promise(function(s,o){let n,i,a,c,u=r.dataObjectSessionKeys[t.dataObjectURL],l={};if(u)a=u.sessionKey;else{a=r.crypto.generateRandom(),r.dataObjectSessionKeys[t.dataObjectURL]={sessionKey:a,isToEncrypt:!0};let e=J(r.dataObjectSessionKeys);r.storageManager.set("dataObjectSessionKeys",0,e).catch(e=>{o("On _sendReporterSessionKey from method storageManager.set(dataObjectSessionKeys...) error: "+e)})}try{i=Q({value:Q(a),dataObjectURL:t.dataObjectURL})}catch(e){return o("On _sendReporterSessionKey from method storageManager.set error valueToEncrypt: "+e)}c=r.crypto.generateIV(),l.iv=Q(c),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,i,c).then(s=>{n={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"reporterSessionKey",value:Q(s)}};let o=r._filterMessageToHash(n,i+c,t.hypertyFrom.messageInfo);return r.crypto.hashHMAC(t.keys.hypertyFromHashKey,o)}).then(e=>{let r=Q({value:n.body.value,hash:Q(e),iv:l.iv});n.body.value=r,s({message:n,chatKeys:t})}).catch(e=>{o("On _sendReporterSessionKey from chained promises encryptAES error: "+e)})})}_resolveDomain(e){return e?"domain-idp://"+e:"domain-idp://google.com"}_doHandShakePhase(e,t){let r=this;return new Promise(function(s,o){let n,i,a,c,u=e.body.handshakePhase,l={};switch(At.info("handshake phase: ",u),u){case"startHandShake":{t.keys.fromRandom=r.crypto.generateRandom();let o={type:"handshake",to:e.to,from:e.from,body:{handshakePhase:"senderHello",value:Q(t.keys.fromRandom)}};t.handshakeHistory.senderHello=r._filterMessageToHash(o,void 0,t.hypertyFrom.messageInfo),t.initialMessage?s({message:o,chatKeys:t}):(r.chatKeys[e.from+"<->"+e.to]=t,r._messageBus.postMessage(o));break}case"senderHello":{At.log("senderHello"),t.handshakeHistory.senderHello=r._filterMessageToHash(e),t.keys.fromRandom=Z(e.body.value),t.keys.toRandom=r.crypto.generateRandom();let o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverHello",value:Q(t.keys.toRandom)}};t.handshakeHistory.receiverHello=r._filterMessageToHash(o,void 0,t.hypertyFrom.messageInfo),s({message:o,chatKeys:t});break}case"receiverHello":At.log("receiverHello"),r.getMyPrivateKey().then(s=>(c=s,t.handshakeHistory.receiverHello=r._filterMessageToHash(e),r._idm.validateAssertion(e.body.identity.assertion,void 0,e.body.identity.idp.domain))).then(s=>{let o=re("string"==typeof s.contents?s.contents:s.contents.nonce),n=r.crypto.generatePMS(),i=e.body.value;t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=o,t.hypertyTo.userID=e.body.identity.userProfile.userURL,t.keys.toRandom=Z(i),t.keys.premasterKey=n;let a=r.crypto.concatPMSwithRandoms(n,t.keys.toRandom,t.keys.fromRandom);return r.crypto.generateMasterSecret(a,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(e=>(t.keys.masterKey=e,r.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom))).then(s=>{t.keys.hypertyToSessionKey=new Uint8Array(s[0]),t.keys.hypertyFromSessionKey=new Uint8Array(s[1]),t.keys.hypertyToHashKey=new Uint8Array(s[2]),t.keys.hypertyFromHashKey=new Uint8Array(s[3]),n=r.crypto.generateIV(),l.iv=Q(n);let o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}};return a=r._filterMessageToHash(o,"ok"+n,t.hypertyFrom.messageInfo),r.crypto.hashHMAC(t.keys.hypertyFromHashKey,a)}).then(e=>(l.hash=Q(e),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok",n))).then(e=>(l.symetricEncryption=Q(e),r.crypto.encryptRSA(t.hypertyTo.publicKey,t.keys.premasterKey))).then(s=>{l.assymetricEncryption=Q(s);let o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}},n=r._filterMessageToHash(o,t.keys.premasterKey,t.hypertyFrom.messageInfo);return r.crypto.signRSA(c,Q(t.handshakeHistory)+Q(n))}).then(o=>{l.signature=Q(o);let i={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate",value:Q(l)}};t.handshakeHistory.senderCertificate=r._filterMessageToHash(i,"ok"+n,t.hypertyFrom.messageInfo),s({message:i,chatKeys:t})},e=>o(e));break;case"senderCertificate":{At.log("senderCertificate");let i=X(e.body.value);r.getMyPrivateKey().then(t=>(c=t,r._idm.validateAssertion(e.body.identity.assertion,void 0,e.body.identity.idp.domain))).then(s=>{let o=Z(i.assymetricEncryption),n=re("string"==typeof s.contents?s.contents:s.contents.nonce);return t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=n,t.hypertyTo.userID=e.body.identity.userProfile.userURL,r.crypto.decryptRSA(c,o)},e=>{o("Error during authentication of identity: ",e.message)}).then(s=>{t.keys.premasterKey=new Uint8Array(s);let o=Z(i.signature),n=r._filterMessageToHash(e,t.keys.premasterKey);return r.crypto.verifyRSA(t.hypertyTo.publicKey,Q(t.handshakeHistory)+Q(n),o)}).then(e=>{let s=r.crypto.concatPMSwithRandoms(t.keys.premasterKey,t.keys.toRandom,t.keys.fromRandom);return r.crypto.generateMasterSecret(s,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(e=>(t.keys.masterKey=e,r.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom))).then(e=>{t.keys.hypertyFromSessionKey=new Uint8Array(e[0]),t.keys.hypertyToSessionKey=new Uint8Array(e[1]),t.keys.hypertyFromHashKey=new Uint8Array(e[2]),t.keys.hypertyToHashKey=new Uint8Array(e[3]),n=Z(i.iv);let s=Z(i.symetricEncryption);return r.crypto.decryptAES(t.keys.hypertyToSessionKey,s,n)}).then(s=>{t.handshakeHistory.senderCertificate=r._filterMessageToHash(e,s+n);let o=Z(i.hash);return a=r._filterMessageToHash(e,s+n),r.crypto.verifyHMAC(t.keys.hypertyToHashKey,a,o)}).then(s=>{let o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage"}};return n=r.crypto.generateIV(),l.iv=Q(n),a=r._filterMessageToHash(o,"ok!"+n,t.hypertyFrom.messageInfo),r.crypto.hashHMAC(t.keys.hypertyFromHashKey,a)}).then(e=>(l.hash=Q(e),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!",n))).then(o=>{l.value=Q(o);let i={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage",value:Q(l)}};t.handshakeHistory.receiverFinishedMessage=r._filterMessageToHash(i,"ok!"+n,t.hypertyFrom.messageInfo),t.authenticated=!0,s({message:i,chatKeys:t})}).catch(e=>{o("On _doHandShakePhase from senderCertificate error: "+e)});break}case"receiverFinishedMessage":{t.authenticated=!0,l=X(e.body.value),n=Z(l.iv);let a=Z(l.value);i=Z(l.hash),r.crypto.decryptAES(t.keys.hypertyToSessionKey,a,n).then(a=>{t.handshakeHistory.receiverFinishedMessage=r._filterMessageToHash(e,a+n);let c=r._filterMessageToHash(e,a+n);r.crypto.verifyHMAC(t.keys.hypertyToHashKey,c,i).then(n=>{if(t.initialMessage){let r={type:"create",to:e.from,from:e.to,body:{value:t.initialMessage.body.value}};s({message:r,chatKeys:t})}else r._sendReporterSessionKey(e,t).then(e=>{s(e)}).catch(e=>{o("On _doHandShakePhase from receiverFinishedMessage error: "+e)})})});break}case"reporterSessionKey":{At.log("reporterSessionKey");let a=X(e.body.value);i=Z(a.hash),n=Z(a.iv);let c,u,d,h,y=Z(a.value);r.crypto.decryptAES(t.keys.hypertyToSessionKey,y,n).then(s=>{c=X(s),u=Z(c.value),d=c.dataObjectURL;let o=r._filterMessageToHash(e,s+n);return r.crypto.verifyHMAC(t.keys.hypertyToHashKey,o,i)}).then(e=>{r.dataObjectSessionKeys[d]={sessionKey:u,isToEncrypt:!0};let s=J(r.dataObjectSessionKeys);return r.storageManager.set("dataObjectSessionKeys",0,s).catch(e=>{o("On _sendReporterSessionKey from method reporterSessionKey error: "+e)}),n=r.crypto.generateIV(),l.iv=Q(n),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!!",n)}).then(s=>{h={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverAcknowledge"}},l.value=Q(s);let o=r._filterMessageToHash(h,"ok!!"+n,t.hypertyFrom.messageInfo);return r.crypto.hashHMAC(t.keys.hypertyFromHashKey,o)}).then(e=>{let r=Q({value:l.value,hash:Q(e),iv:l.iv});h.body.value=r,s({message:h,chatKeys:t})}).catch(e=>{o("On _doHandShakePhase from reporterSessionKey error: "+e)});break}case"receiverAcknowledge":{At.log("receiverAcknowledge");let i=X(e.body.value),a=Z(i.hash);n=Z(i.iv);let c=Z(i.value);r.crypto.decryptAES(t.keys.hypertyToSessionKey,c,n).then(s=>{let o=r._filterMessageToHash(e,s+n);return r.crypto.verifyHMAC(t.keys.hypertyToHashKey,o,a)}).then(e=>{let r=t.callback;r&&r("handShakeEnd"),s("handShakeEnd")}).catch(e=>{o("On _doHandShakePhase from receiverAcknowledge error: "+e)});break}default:o(e)}})}_filterMessageToHash(e,t,r){return{type:e.type,from:e.from,to:e.to,body:{identity:r||e.body.identity,value:t||e.body.value,handshakePhase:e.body.handshakePhase}}}_newChatCrypto(e,t,r){let s=r?e.to:e.from,o=r?e.from:e.to,n=this._idm.getIdentity(t);return{hypertyFrom:{hyperty:s,userID:n.userProfile.userURL,assertion:n.assertion,messageInfo:n},hypertyTo:{hyperty:o,userID:void 0,publicKey:void 0,assertion:void 0},keys:{hypertyToSessionKey:void 0,hypertyFromSessionKey:void 0,hypertyToHashKey:void 0,hypertyFromHashKey:void 0,toRandom:void 0,fromRandom:void 0,premasterKey:void 0,masterKey:void 0},handshakeHistory:{senderHello:void 0,receiverHello:void 0,senderCertificate:void 0,receiverFinishedMessage:void 0},initialMessage:e.body.ignore?void 0:e,callback:e.callback,authenticated:!1,dataObjectURL:e.dataObjectURL}}getMyPublicKey(e=this.userDefaultKeyRef){let t=this;return new Promise((r,s)=>{t.storageManager.get(e).then(o=>{if(o)return r(o.public);t._generateAndStoreNewAsymetricKey(e).then(e=>{r(e.public)}).catch(e=>{At.error("[getMyPublicKey:_generateAndStoreNewAsymetricKey:err]: "+e.message),s(e)})}).catch(e=>{At.error("[getMyPublicKey:storageManager:err]: "+e.message),s(e)})})}getMyPrivateKey(e=this.userDefaultKeyRef){let t=this;return new Promise((r,s)=>{t.storageManager.get(e).then(o=>{if(o)return r(o.private);t._generateAndStoreNewAsymetricKey(e).then(e=>{r(e.private)}).catch(e=>{At.error("[getMyPrivateKey:_generateAndStoreNewAsymetricKey:err]: "+e.message),s(e)})}).catch(e=>{At.error("[getMyPrivateKey:storageManager:err]: "+e.message),s(e)})})}_generateAndStoreNewAsymetricKey(e){let t=this,r=void 0;return new Promise((s,o)=>{let n={};n.private=K(),n.public=K(),At.log("_generateAndStoreNewAsymetricKey:userAsymmetricKeyGenerated",n),r=n,t.storageManager.set(e,0,n),s(r)}).catch(e=>{At.error("[_generateAndStoreNewAsymetricKey:err]: "+e.message),reject(e)})}};let Tt=s.getLogger("Loader");let Ht={};function Nt(e,t,r=!1){if(!e)throw new Error("[Runtime.Storage.createSyncDB] name is a needed parameter");if(!t)throw new Error("[Runtime.Storage.createSyncDB] The runtime factory is a needed parameter");let s=r||ht.remoteStorage;return t.syncStorageManager(e,s)}let Ft=s.getLogger("Descriptors");let Bt=s.getLogger("CoreDiscovery");let Kt=s.getLogger("DataObjectsStorage");let Gt=s.getLogger("HypertyResourcesStorage");let qt=s.getLogger("SynSubscription");var Vt=class{constructor(e,t,r,s){let o=this,n=r+"/children/",i=r+"/changes";o._deleteListener=e.addListener(i,s=>{if("delete"===s.type){qt.log("Subscription-DELETE: ",s);let n={type:"delete",from:s.from,to:t,body:{identity:s.body.identity,resource:r}};e.postMessage(n,e=>{qt.log("Subscription-DELETE-REPLY: ",e),200===e.body.code&&o._releaseListeners()})}}),o._changeListener=s?e.addPublish(i):e.addForward(i,t),o._childrenListeners=[];let a=e.addPublish(n);if(o._childrenListeners.push(a),!s){let r=e.addForward(n,t);o._childrenListeners.push(r)}}_releaseListeners(){this._deleteListener.remove(),this._changeListener.remove(),this._childrenListeners.forEach(e=>{e.remove()})}};let Wt=s.getLogger("ReporterObject");var Jt=class{constructor(e,t,r,s,o){this._parent=e,this._owner=t,this._url=r,this._bus=e._bus,this._domain=x(r).domain,this._objSubscriptorURL=this._url+"/subscription",this._subscriptions={},this._childrens=s,this._childrenListeners=[],this._forwards={},this._isToSaveData=!1,this._allocateListeners(),this._offline=o||!1}get offline(){return this._offline}_allocateListeners(){let e=this;e._subscriptionListener=e._bus.addListener(e._objSubscriptorURL,t=>{switch(Wt.info("[SyncherManager.ReporterObject received ]",t),t.type){case"subscribe":e._onRemoteSubscribe(t);break;case"unsubscribe":e._onRemoteUnSubscribe(t);break;case"response":e._onRemoteResponse(t);break;case"forward":e._onForwardedRemoteSubscribe(t)}});let t=e._url+"/changes";e._changeListener=e._bus.addListener(t,r=>{if(Wt.info("[SyncherManager.ReporterObject ] SyncherManager-"+t+"-RCV: ",r),this._isToSaveData&&r.body.attribute){let t="backupRevision"!==r.body.attribute;Wt.log("[SyncherManager.ReporterObject ] SyncherManager - save data: ",r),e._parent._dataObjectsStorage.update(!0,e._url,"version",r.body.version,t),e._parent._dataObjectsStorage.update(!0,e._url,"lastModified",r.body.lastModified,t),e._parent._dataObjectsStorage.saveData(!0,e._url,r.body.attribute,r.body.value,t)}})}set isToSaveData(e){this._isToSaveData=e}_onForwardedRemoteSubscribe(e){this._onRemoteSubscribe(e.body)}_releaseListeners(){let e=this;e._subscriptionListener.remove(),e._changeListener.remove(),e._childrenListeners.forEach(e=>{e.remove()}),Object.keys(e._forwards).forEach(t=>{e.forwardUnSubscribe(t)}),Object.keys(e._subscriptions).forEach(t=>{e._subscriptions[t]._releaseListeners()})}resumeSubscriptions(e){let t=this;e&&Object.keys(e).forEach(r=>{let s=e[r];Wt.log("[SyncherManager.ReporterObject] - resume subscriptions",t,s,t._childrens),t._subscriptions[s]||(t._subscriptions[s]=new Vt(t._bus,t._owner,t._url,!0))})}forwardSubscribe(e){let t=this,r={type:"subscribe",from:t._parent._url,to:"domain://msg-node."+t._domain+"/sm",body:{resources:e,source:t._owner}};return new Promise((s,o)=>{t._bus.postMessageWithRetries(r,10,r=>{if(Wt.log("[SyncherManager.ReporterObject ]forward-subscribe-response(reporter): ",r),200===r.body.code){let r=t._bus.addForward(t._url,t._owner);t._forwards[e[0]]=r,s()}else o("Error on msg-node subscription: "+r.body.desc)})})}forwardUnSubscribe(e){this._forwards[e].remove(),delete this._forwards[e];let t={type:"unsubscribe",from:this._parent._url,to:"domain://msg-node."+this._domain+"/sm",body:{resources:[e],source:this._owner}};this._bus.postMessage(t)}addChildrens(){let e=this;return new Promise((t,r)=>{if(0===e._childrens.length)return void t();let s=e._url+"/children/";Wt.log("[SyncherManager.ReporterObject - addChildrens] - childrens: ",s);let o=[];o.push(s);let n={type:"subscribe",from:e._parent._url,to:"domain://msg-node."+e._domain+"/sm",body:{resources:o,source:e._owner}};e._bus.postMessage(n,s=>{Wt.log("[SyncherManager.ReporterObject ]node-subscribe-response(reporter):",s),200===s.body.code?(o.forEach(t=>{let r=e._bus.addListener(t,t=>{if(Wt.log("[SyncherManager.ReporterObject received]",t),"create"===t.type&&t.to.includes("children")&&this._isToSaveData){let r=V(t.to).url;t.body.hasOwnProperty("mutual")||(t.body.mutual=!0),"string"!=typeof t.body.value&&t.body.mutual?(Wt.log("[SyncherManager.ReporterObject] encrypting received data ",t.body.value),Et.encryptDataObject(t.body.value,r).then(r=>{Wt.log("[SyncherManager.ReporterObject] encrypted data ",r),e._storeChildObject(t,JSON.stringify(r))}).catch(r=>{Wt.warn("[SyncherManager._decryptChildrens] failed : ",r," Storing unencrypted"),e._storeChildObject(t,t.body.value)})):e._storeChildObject(t,t.body.value)}});e._childrenListeners.push(r);let s=e._bus.addForward(t,e._owner);e._childrenListeners.push(s)}),t()):r("Error on msg-node subscription: "+s.body.desc)})})}_storeChildObject(e,t){let r,s=V(e.to),o=s.url,n=s.resource,i=e.body.resource,a=n;r="heartbeat"===i?t:{identity:e.body.identity,value:t},i&&(a=i),console.log("[SyncherManager.ReporterObject._storeChildObject] : ",o,a,r),this._parent._dataObjectsStorage.saveChildrens(!0,o,a,r)}delete(){let e=x(this._owner).domain;this._bus.postMessage({type:"delete",from:this._objSubscriptorURL,to:this._url+"/changes"}),this._bus.postMessage({type:"delete",from:this._parent._url,to:"domain://msg-node."+e+"/object-address-allocation",body:{resource:this._url,childrenResources:this._childrens}}),this._releaseListeners(),delete this._parent._reporters[this._url]}_onRemoteResponse(e){this._bus.postMessage({id:e.id,type:"response",from:e.to,to:this._url,body:{code:e.body.code,identity:e.body.identity,source:e.from}})}_onRemoteSubscribe(e){let t=this,r=e.body.subscriber;t._subscriptions[r]&&t._subscriptions[r]._releaseListeners();{let s={type:"forward",from:t._url,to:t._owner,body:{type:e.type,from:r,to:t._url,identity:e.body.identity}};e.body.hasOwnProperty("mutual")&&(s.body.mutual=e.body.mutual),t._bus.postMessage(s,s=>{let o;Wt.log("[SyncherManager.ReporterObject ]forward-reply: ",s),200===s.body.code&&(t._subscriptions[r]||(Wt.log("[SyncherManager.ReporterObject] - _onRemoteSubscribe:",t._childrens),t._subscriptions[r]=new Vt(t._bus,t._owner,t._url,!0))),e.body.identity&&e.body.identity.userProfile.userURL&&(o=e.body.identity.userProfile.userURL,t._parent._dataObjectsStorage.update(!0,t._url,"subscriberUsers",o)),t._parent._dataObjectsStorage.update(!0,t._url,"subscriptions",r),s.body.owner=t._owner,t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:s.body})})}}_onRemoteUnSubscribe(e){let t=this,r=e.body.source,s=t._subscriptions[r];if(s){s._releaseListeners(),delete t._subscriptions[r];let o={type:"forward",from:t._url,to:t._owner,body:{type:e.type,from:r,to:t._url,identity:e.body.identity}};t._bus.postMessage(o)}}};let Yt=s.getLogger("ObserverObject");var zt=class{constructor(e,t,r){let s=this;s._parent=e,s._url=t,s._childrens=r,s._bus=e._bus,s._subscriptions={},s._storageSubscriptions={},s._childrenListeners=[],this._isToSaveData=!1;let o=s._url+"/changes";s._changeListener=s._bus.addListener(o,e=>{Yt.log("[SyncherManager.ObserverObject ] SyncherManager-"+o+"-RCV: ",e),this._isToSaveData&&e.body.attribute&&(Yt.log("[SyncherManager.ObserverObject ] SyncherManager - save data: ",e),s._parent._dataObjectsStorage.update(!1,s._url,"version",e.body.version),s._parent._dataObjectsStorage.update(!1,s._url,"lastModified",e.body.lastModified),s._parent._dataObjectsStorage.saveData(!1,s._url,e.body.attribute,e.body.value))})}set isToSaveData(e){this._isToSaveData=e}_newSubscription(e){let t=this,r=t._subscriptions[e];Yt.log("[Observer Object - new subscription] - ",t._subscriptions,e,t._subscriptions.hasOwnProperty(e)),r||(t._subscriptions[e]=new Vt(t._bus,e,t._url,!1))}addSubscription(e){this._newSubscription(e)}addChildrens(){let e=this;return new Promise(t=>{if(0===e._childrens.length)return void t();let r=e._url+"/children/";Yt.log("[SyncherManager.ObserverObject - addChildrens] - childrens: ",r);let s=e._bus.addListener(r,t=>{if(Yt.log("[SyncherManager.ObserverObject received]",t),"create"===t.type&&t.to.includes("children")&&this._isToSaveData){let r=V(t.to).url;t.body.hasOwnProperty("mutual")||(t.body.mutual=!0),"string"!=typeof t.body.value&&t.body.mutual?(Yt.log("[SyncherManager.ObserverObject] encrypting received data ",t.body.value),Et.encryptDataObject(t.body.value,r).then(r=>{Yt.log("[SyncherManager.ObserverObject] encrypted data ",r),e._storeChildObject(t,JSON.stringify(r))}).catch(r=>{Yt.warn("[SyncherManager.ObserverObject._encryptChild] failed, storing unencrypted ",r),e._storeChildObject(t,t.body.value)})):e._storeChildObject(t,t.body.value)}Yt.log("[SyncherManager.ObserverObject children Listeners]",e._childrenListeners,s),-1===e._childrenListeners.indexOf(s)&&e._childrenListeners.push(s)})})}_storeChildObject(e,t){let r=V(e.to),s=r.url,o=r.resource,n={},i=e.body.resource,a=o;"heartbeat"===i?n=t:(n.identity=e.body.identity,n.value=t),i&&(a=i),Yt.log("[SyncherManager.ObserverObject._storeChildObject] : ",s,a,n),this._parent._dataObjectsStorage.saveChildrens(!1,s,a,n)}removeSubscription(e){let t=this,r=e.from,s=x(r).domain,o=t._url+"/subscription",n=t._subscriptions[r];n&&(t._bus.postMessage({type:"unsubscribe",from:t._parent._url,to:o,body:{source:r,identity:e.body.identity}}),t._bus.postMessage({type:"unsubscribe",from:t._parent._url,to:"domain://msg-node."+s+"/sm",body:{resource:t._url,resources:[t._url+"/children/"]}}),n._releaseListeners(),delete t._subscriptions[r])}};let $t=s.getLogger("SyncherManager");let Qt=s.getLogger("Subscription");let Xt=s.getLogger("SubscriptionManager");s.getLogger("PEP");let Zt=s.getLogger("RuntimeUA");t.default=class{constructor(e,t,r){if(!e)throw new Error("The runtime descriptor is a needed parameter");if(!t)throw new Error("The sandbox factory is a needed parameter");if(!r)throw new Error("You need the domain of runtime");if(this.runtimeConfiguration=Object.assign({domain:r},ht),this.runtimeFactory=t,this.log=Zt,this.logLevels=o.a,e.p2pHandlerStub&&"string"==typeof e.p2pHandlerStub&&e.p2pHandlerStub.includes("://")?this.p2p=!0:this.p2p=!1,U.runtimeDescriptor=e,this.runtimeUtils=U,this.storages={},"function"!=typeof t.storageManager)throw new Error("Check your Runtime Factory because it needs the Storage Manager implementation");this.storages=function(e,t){if(!e)throw new Error("The runtime factory is a needed parameter");return console.log("[Storage.storage] storageSchemas ",ht.storageSchemas),Object.keys(ht.storageSchemas).forEach(r=>{Ht.hasOwnProperty(r)||(Ht[r]=e.storageManager(r,ht.storageSchemas[r],t))}),Ht}(t,this),"function"==typeof t.runtimeCapabilities?this.runtimeCapabilities=t.runtimeCapabilities(this.storages.capabilities):Zt.info("Check your RuntimeFactory because it needs the Runtime Capabilities implementation")}init(e){return new Promise((t,r)=>{this.domain=this.runtimeConfiguration.domain,Zt.info("[RuntimeUA - init] Starting ");try{let s=this.runtimeCapabilities.getRuntimeCapabilities(),o=this.storages.runtime.get("runtime:URL"),n=this.storages.syncherManager.get("syncherManager:ObjectURLs"),i=this.storages.hypertyResources.get(),a=this.storages.runtime.get("p2pHandler:URL");Promise.all([o,s,n,i,a]).then(t=>(this.runtimeURL=t[0]?t[0].runtimeURL:t[0],this.runtimeURL||(this.runtimeURL="runtime://"+this.domain+"/"+K(),this.storages.runtime.set("runtime:URL",1,{runtimeURL:this.runtimeURL})),this.capabilities=t[1],Object.assign(U.runtimeCapabilities.constraints,t[1]),this._dataObjectsStorage=new class{constructor(e,t={},r,s){if(!e)throw new Error("[Store Data Objects] - Needs the storageManager component");this._storageManager=e,this._storeDataObject=t,this._cache={},this._createSyncDB=Nt,this._remotes={},this._factory=r,this._table="syncherManager:ObjectURLs",this._remoteStorageTable="dataObjectStorage",this._remoteSchema="url",this._runtimeUrl=s}loadRemote(e=!1){let t=this;return new Promise((r,s)=>{let o=[];t._storageManager.get(null,null,"remotes").then(n=>{Kt.log("[StoreDataObjects.loadRemote] remotes: ",n),n||r(),e||(t._remotes=n),Kt.log("[StoreDataObjects.loadRemote] loading: ",t._remotes);let i=Object.keys(n);0===i.length&&r(),i.forEach(e=>{let r="do-"+e.split("/")[3];t._remotes[e]=Nt(r,this._factory),o.push(t._remotes[e].get())}),Promise.all(o).then(e=>{Kt.log("[StoreDataObjects.loadRemote] loaded: ",e);let o=e;0===o.length&&r(),o.forEach(e=>{let s=t._remoteDoc2dataObject(e);Kt.log("[StoreDataObjects.loadRemote] loaded remote ",s);let o=this._getTypeOfObject(s.isReporter);t._storeDataObject||(t._storeDataObject={}),t._storeDataObject.hasOwnProperty(o)||(t._storeDataObject[o]={}),t._storeDataObject[o][s.url]=s,r(t._storeDataObject)},e=>{s(e)})})},e=>{s(e)}),r()})}deleteRemotes(){let e=this;return new Promise((t,r)=>{let s=[];e._storageManager.get(null,null,"remotes").then(r=>{Kt.info("[StoreDataObjects.deleteRemotes] remotes: ",r),r||t();let o=Object.keys(e._remotes);0===o.length&&t(),o.forEach(t=>{s.push(e._remotes[t].disconnect()),s.push(e._remotes[t].delete())}),Promise.all(s).then(()=>{Kt.log("[StoreDataObjects.deleteRemotes] deleted."),t()},e=>{t()})}),t()})}set(e){return new Promise((t,r)=>{let s=this._storeDataObject?this._storeDataObject:{},o=this._getTypeOfObject(e.isReporter);s.hasOwnProperty(o)||(s[o]={}),s[o].hasOwnProperty(e.url)||(s[o][e.url]={},s[o][e.url].subscriptions=[],s[o][e.url].subscriberUsers=[],s[o][e.url].childrenObjects={},s[o][e.url].data={}),Object.assign(s[o][e.url],e),delete s[o][e.url].subscriberUser,delete s[o][e.url].subscriberHyperty,s[o][e.url].backup=!!e.hasOwnProperty("backup")&&e.backup,e.subscriberHyperty&&!e.isReporter&&this._updateToArray(s[o],e.url,"subscriptions",e.subscriberHyperty),e.subscriberUser&&s[o][e.url].subscriberUsers.indexOf(e.subscriberUser)&&this._updateToArray(s[o],e.url,"subscriberUsers",e.subscriberUser),this._storeDataObject=s;let n=!!e.hasOwnProperty("backup")&&e.backup,i=n?e.url:this._table,a=n?"do-"+i.split("/")[3]:this._table;n&&!this._remotes[e.url]&&(this._remoteSchema,this._remotes[e.url]=Nt(a,this._factory)),n&&this._storageManager.set(i,0,a,"remotes");let c=n?this._remotes[i]:this._storageManager;n?c.set(i,s[o][e.url]).then(()=>{e.isReporter&&c.connect(),t(s[o][e.url])},e=>{Kt.error("[DataObjectStorage.set] failed to save into remote storage: ",e),r(e)}):(console.log("[DataObjectStorage.set] _storeDataObject before filter ",this._storeDataObject),c.set(a,1,this._filterRemotes(this._storeDataObject),i).then(()=>{t(s[o][e.url])}))})}_filterRemotes(e){let t=Object.keys(this._remotes),r=I(e);return console.log("[DataObjectStorage._filterRemotes] starting filtering ",r),t.forEach(e=>{r.reporters&&r.reporters[e]?(delete r.reporters[e],console.log("[DataObjectStorage._filterRemotes] filter updated ",r)):delete r.observers[e]}),console.log("[DataObjectStorage._filterRemotes] ",r),r}saveData(e,t,r,s,o){let n=this._storeDataObject,i=this._getTypeOfObject(e);if(!n||!n[i]||!n[i][t])return void Kt.log("[StoreDataObjects - save data] - not saved");if(Kt.log("[StoreDataObjects - saveData] - ",e,i,t,r,s),n[i][t].hasOwnProperty("data")||(n[i][t].data={}),r){let e;e="object"==typeof s?I(s):s,q(n[i][t].data,r,e)}else n[i][t].data=I(s)||{};this._storeDataObject=n;let a=n[i][t].backup?n[i][t].url:"syncherManager:ObjectURLs",c=n[i][t].backup?this._remotes[a]:this._storageManager;return n[i][t].backup?c.set(a,n[i][t]):c.set("syncherManager:ObjectURLs",1,this._filterRemotes(n),this._table,o)}saveChildrens(e,t,r,s){let o=this._storeDataObject,n=this._getTypeOfObject(e);if(!o||!o[n]||!o[n][t])return void Kt.log("[StoreDataObjects - save childrens] - not saved");o[n][t].hasOwnProperty("childrens")||(o[n][t].childrenObjects={}),r?q(o[n][t].childrenObjects,r,I(s)):o[n][t].childrenObjects=I(s)||{},this._storeDataObject=o;let i=o[n][t].backup?o[n][t].url:"syncherManager:ObjectURLs",a=o[n][t].backup?this._remotes[i]:this._storageManager;return o[n][t].backup?a.set(r,s).then(()=>{this._runtimeUrl===s.value.runtime&&a.backup(r)}):a.set("syncherManager:ObjectURLs",1,this._filterRemotes(o),this._table,updateRuntimeStatus)}update(e,t,r,s,o){let n=this._storeDataObject,i=this._getTypeOfObject(e);if(n&&n[i]&&n[i][t]){if(Kt.log("[StoreDataObjects - update] - ",e,i,t,r,s),n[i]&&n[i][t]&&t&&r&&s){if("subscriptions"===r||"subscriberUsers"===r){let e=!0;"subscriptions"===r&&(e=!this._isOwner(n[i][t],s)),e&&this._updateToArray(n[i],t,r,s)}else n[i][t][r]=s;this._storeDataObject=n;let e=n[i][t].backup?n[i][t].url:"syncherManager:ObjectURLs",a=n[i][t].backup?this._remotes[e]:this._storageManager;return n[i][t].backup?a.set(e,n[i][t]):a.set("syncherManager:ObjectURLs",1,this._filterRemotes(n),this._table,o)}}else Kt.log("[StoreDataObjects - update] - not saved")}delete(e,t,r,s){let o=this._storeDataObject,n=this._getTypeOfObject(e);if(o&&o[n]&&o[n][t]){if(o[n]&&o[n][t]&&t&&r&&s){"subscriptions"===r||"subscriberUsers"===r?this._removeFromArray(o[n],t,r,s):delete o[n][t][r],this._storeDataObject=o;let e=o[n][t].backup?o[n][t].url:"syncherManager:ObjectURLs",i=o[n][t].backup?this._remotes[e]:this._storageManager;return o[n][t].backup?i.set(e,o[n][t]):i.set(e,1,this._filterRemotes(o),this._table,updateRuntimeStatus)}}else Kt.log("[StoreDataObjects - delete] - not saved")}deleteResource(e){let t=this;return new Promise((r,s)=>{if(e){let s,o,n;return Kt.log("[DataObjectStorage.deleteResource] deleting: ",e),t._storeDataObject.hasOwnProperty("observers")&&t._storeDataObject.observers.hasOwnProperty(e)&&(s=!!t._storeDataObject.observers[e].backup&&t._storeDataObject.observers[e].backup,o=s?t._storeDataObject.observers[e].url:"syncherManager:ObjectURLs",n=s?t._remotes[o]:t._storageManager,delete t._storeDataObject.observers[e]),t._storeDataObject.hasOwnProperty("reporters")&&t._storeDataObject.reporters.hasOwnProperty(e)&&(s=!!t._storeDataObject.reporters[e].backup&&t._storeDataObject.reporters[e].backup,o=s?t._storeDataObject.reporters[e].url:"syncherManager:ObjectURLs",n=s?t._remotes[o]:t._storageManager,delete t._storeDataObject.reporters[e]),s&&n?n.delete().then(()=>{Kt.log("[DataObjectStorage.deleteResource] deleting sync db ",e),delete t._remotes[o],delete t._factory.databases["do-"+o.split("/")[3]],delete t._factory.storeManager["do-"+o.split("/")[3]],t._storageManager.delete(e,null,"remotes")}):(delete t._factory.databases[o],delete t._factory.storeManager[o],n.set(o,1,this._filterRemotes(t._storeDataObject))),r()}s(new Error("[StoreDataObjects] - Can't delete this "+e))})}sync(e){let t=this;return console.log("[DataObjectStorage._sync] resource: ",e),new Promise((r,s)=>{if(t._remotes[e])t._remotes[e].get(e,"isReporter").then(o=>{t._remotes[e].get(e,"subscriptions").then(n=>{t._remotes[e].sync().then(()=>{t._remotes[e].get().then(s=>{Kt.info("[DataObjectStorage.sync] returning synched DO: ",s);let i=t._remoteDoc2dataObject(s);i.isReporter=o,i.subscriptions=n,t._storeDataObject.hasOwnProperty("observers")&&t._storeDataObject.observers.hasOwnProperty(e)&&(t._storeDataObject.observers[e]=i),t._storeDataObject.hasOwnProperty("reporters")&&t._storeDataObject.reporters.hasOwnProperty(e)&&(t._storeDataObject.reporters[e]=i),t._remotes[e].set(e,i).then(()=>{r(i)})},e=>{Kt.error("[DataObjectStorage.sync] Error ",e),s(e)})},e=>{Kt.error("[DataObjectStorage.sync] Error ",e),s(e)})})});else{let t=e+" not found in local storage.";Kt.warn("[DataObjectStorage.sync] warning ",t),s(t)}})}_remoteDoc2dataObject(e){if(e.length>1){let t,r=e[e.length-1];for(r.childrenObjects={},t=0;t<e.length-1;t++)r.childrenObjects[e[t]._id]=e[t];return r}return e[0]}stopSync(e){this._remotes[e]&&this._remotes[e].disconnect()}getDataObject(e){return new Promise((t,r)=>{let s,o=this._storeDataObject,n=o.hasOwnProperty("observers")?o.observers:{},i=o.hasOwnProperty("reporters")?o.reporters:{},a=Object.keys(i).find(t=>t===e),c=Object.keys(n).find(t=>t===e);return c&&(s=o.observers[c]),a&&(s=o.reporters[a]),Kt.info("[StoreDataObjects - getDataObject] - for observer: ",c),Kt.info("[StoreDataObjects - getDataObject] - for reporters: ",a),Kt.info("[StoreDataObjects - getDataObject] - resolve: ",s),s?t(s):r("No dataObject was found")})}getResourcesByCriteria(e,t){return new Promise(r=>{let s=this._getTypeOfObject(t),o=this._storeDataObject;if(!o)return Kt.log("[DataObjectsStorage.getResourcesByCriteria] don't have stored data objects"),r(null);if(e.body&&e.body.hasOwnProperty("resume")&&!e.body.resume)return r(null);let n=[],i=this._hasSubscription(o[s],e.from),a=this._searchOwner(o[s],e.from),c=this._checkProtostubResume(o,e);if(Kt.log("[StoredDataObjects - getResourcesByCriteria]:",o,e,i,a),!(e.hasOwnProperty("from")&&i||a||c))return r(null);{let t;t=a?this._getResourcesByOwner(o[s],e.from):this._getResourcesBySubscription(o[s],e.from);let r=[];e.body&&e.body.identity&&(r=this._getResourcesByIdentity(o[s],e.body.identity));let i=[];e.body&&e.body.schema&&(i=this._getResourcesBySchema(o[s],e.body.schema));let u=[];if(e.body&&e.body.value){let t=e.body.value;delete t.data,u=this._getResourcesByMetadata(o[s],t)}let l=[];if(e.body&&e.body.value&&e.body.value.data&&(l=this._getResourcesByData(o[s],e.body.value.data)),0==(n=this._intersection(t,r,i,l,u)).length&&c&&"observers"==s&&e.from.split("protostub").length>0){let t=o[s],r=x(e.from).domain;t&&Object.keys(t).filter(e=>{t[e].subscriptions.forEach(function(t){x(t).domain==r&&n.push(e)})})}}let u={};n.forEach(e=>{let t=o[s][e];return u[e]=t,u}),Kt.log("[Store Data Objects] - ",u),r(u)})}_getResourcesByIdentity(e,t){return e?Object.keys(e).filter(r=>e[r].subscriberUsers.filter(e=>e===t).length):[]}_getResourcesByOwner(e,t){return e?Object.keys(e).filter(r=>e[r].reporter===t):[]}_getResourcesBySubscription(e,t){return e?Object.keys(e).filter(r=>e[r].subscriptions.filter(e=>e===t).length):[]}_getResourcesBySchema(e,t){return Object.keys(e).filter(r=>{let s=e[r];return Object.keys(s).filter(e=>"schema"===e&&s[e]===t).length})}_getResourcesByMetadata(e,t){return t?Object.keys(e).filter(r=>{let s=e[r];return Object.keys(s).filter(e=>Object.keys(t).filter(r=>e===r&&s[e]===t[r]).length).length}):[]}_getResourcesByData(e,t){return t?Object.keys(e).filter(r=>{let s=e[r].hasOwnProperty("data")?e[r].data:{};return Object.keys(s).filter(e=>Object.keys(t).filter(r=>e===r&&s[e]===t[r]).length).length}):[]}_hasSubscription(e,t){return!!e&&Object.keys(e).filter(r=>e[r].subscriptions.filter(e=>e===t).length).length>0}_searchOwner(e,t){return!!e&&Object.keys(e).filter(r=>e[r].reporter===t).length>0}_checkProtostubResume(e,t){if(!e)return!1;if(t.hasOwnProperty("body")&&t.body.hasOwnProperty("value")&&t.body.value.hasOwnProperty("reporter")){let r=t.body.value.reporter;if(e.hasOwnProperty("reporters")){let t=e.reporters;return Object.keys(t).filter(e=>t[e].reporter===r).length>0}return!1}if(e.hasOwnProperty("observers")){let r=e.observers,s=x(t.from).domain;return Object.keys(r).filter(e=>{let t=!1;if(r[e].subscriptions.forEach(function(e){x(e).domain==s&&(t=!0)}),t)return!0}).length>0}}_isOwner(e,t){return!!e&&e.reporter===t}_intersection(){let e=Array.from(arguments).reduce((e,t)=>e.concat(t)).filter((e,t,r)=>r.indexOf(e)===t);return Kt.log("DataObjectsStorage._intersection] Result an unique array of strings: ",e),e}_updateToArray(e,t,r,s){Kt.log("[DataObjectsStorage] - _updateToArray: ",e,t,r,s),-1===e[t][r].indexOf(s)&&e[t][r].push(s)}_removeFromArray(e,t,r,s){let o=e[t][r].indexOf(s);-1===o&&e[t][r].splice(o,1)}_hasValue(e,t,r){return e.hasOwnProperty(t)&&e[t]===r}_getTypeOfObject(e){return e?"reporters":"observers"}}(this.storages.syncherManager,t[2]||{},this.runtimeFactory,this.runtimeURL),this._hypertyResources=t[3]||{},this.p2pHandlerURL=t[4]?t[4].p2pHandlerURL:t[4],this.p2pHandlerURL||(this.p2pHandlerURL=this.runtimeURL+"/p2phandler/"+K(),Zt.info("[RuntimeUA - init] P2PHandlerURL: ",this.p2pHandlerURL),this.storages.runtime.set("p2pHandler:URL",1,{p2pHandlerURL:this.p2pHandlerURL})),this._loadComponents(e))).then(e=>(this._setNetworkStatusListeners(),this._hypertyResourcesStorage=new class{constructor(e,t,r,s){if(!r)throw new Error("[HypertyResourcesStorage constructor] mandatory storageManager parameter missing");if(!e)throw new Error("[HypertyResourcesStorage constructor] mandatory runtimeURL parameter missing");if(!t)throw new Error("[HypertyResourcesStorage constructor] mandatory bus parameter missing");let o=this;o._bus=t,o._storageLimit=.9,o._url=e+"/storage",o._storageManager=r,o.promiseQueue=new class{constructor(e){this.flushing=!1,this.Promise=Promise,this.concurrency="number"!=typeof e?1:e,this.promises=[],this.queue=[],this.isProcessing=!1}done(e){this.callback=e}add(e){if(this.queue.push(e),!this.isProcessing)return this.queue.reduce((e,t)=>e.then(e=>t.then(t=>[...e,t])),Promise.resolve([])).then(e=>{this.isProcessing=!1})}},o._hypertyResources=s,t.addListener(o._url,e=>{switch(Gt.info("[HypertyResourcesStorage] Message RCV: ",e),e.type){case"create":o._onCreate(e);break;case"read":o._onRead(e);break;case"delete":o._onDelete(e)}})}checkStorageQuota(){return new Promise((e,t)=>{if(this._availableQuota&&this._usage)return e($(this._usage,this._availableQuota));navigator&&navigator.storage.estimate().then(t=>{this._availableQuota=t.quota,this._usage=t.usage,e($(this._usage,this._availableQuota))}).catch(e=>{Gt.error("[HypertyResourcesStorage] CheckStorageQuota error: ",e),t(e)})})}_onCreate(e){let t=this;if(!e.body||!e.body.value)throw new Error("[HypertyResourcesStorage._onCreate] mandatory message body value missing: ",e);let r=e.body.value,s=r.contentURL,o="";if(s){const e=s[0],r=e.substr(e.lastIndexOf("/")+1);o=t._url+"/"+r}else s=[],o=t._url+"/"+K();t._hypertyResources.hasOwnProperty(o)||(s.push(o),r.contentURL=s),this._hypertyResources[o]=r,this.promiseQueue.add(this._toSave(o,e,r))}_toSave(e,t,r){return new Promise((s,o)=>{const n=r=>{let s={from:t.to,to:t.from,id:t.id,type:"response",body:{value:e,code:500,description:r}};return this._bus.postMessage(s),o(r)};this.checkStorageQuota().then(e=>{if(r.size>e.quota){const e="The storage do not have space to store that resource";throw n(e),Error(e)}const t=e.quota,s=e.usage+r.size;return!(e.percent>=this._storageLimit||s>t)||this._getOlderResources(r.size)}).then(()=>this._storageManager.set(e,1,r)).then(()=>{let r={from:t.to,to:t.from,id:t.id,type:"response",body:{value:e,code:200}};return this._bus.postMessage(r),Gt.log("Success"),s()}).catch(n)})}_getOlderResources(e){return new Promise((t,r)=>{this._storageManager.get().then(s=>{let o=0;const n=Object.keys(s).sort((e,t)=>s[e].created<s[t].created).reduce((t,r)=>{const s=this._hypertyResources[r];return Gt.log("[HypertyResourcesStorage] _getOlderResources: ",o,e,r,this._availableQuota),o<=e&&(o+=s.size,t.push(r)),t},[]).map(e=>this._storageManager.delete(e));Promise.all(n).then(()=>{t(!0)}).catch(e=>{r(e)})})})}_onRead(e){let t=this;if(!e.body||!e.body.resource)throw new Error("[HypertyResourcesStorage._onRead] mandatory message body resource missing: ",e);let r=e.body.resource,s={from:e.to,to:e.from,id:e.id,type:"response",body:{}};Gt.info("[HypertyResourcesStorage._onRead] get resourceURL:",r),this._storageManager.get("resourceURL",r).then(e=>{Gt.info("[HypertyResourcesStorage._onRead] found content:",e),e?"file"===e.resourceType?t._onReadFile(s,e):(s.body.code=200,s.body.p2p=!0,s.body.value=e,t._bus.postMessage(s)):(s.body.code=404,s.body.desc="Content Not Found for "+r,t._bus.postMessage(s))})}_onReadFile(e,t){let r=this,s=new FileReader;if(s.onload=function(s){Gt.info("[FileHypertyResource.init] file loaded ",s),e.body.code=200,e.body.p2p=!0,e.body.value=I(t),e.body.value.content=s.target.result,r._bus.postMessage(e)},t.mimetype.includes("text/"))s.readAsText(t.content);else{const e=t.content;let r;r=Array.isArray(e)?new Blob(e,{type:t.mimetype}):new Blob([e],{type:t.mimetype}),s.readAsArrayBuffer(r)}}_onDelete(e){let t=this;if(!e.body)throw new Error("[HypertyResourcesStorage._onDelete] mandatory message body missing: ",e);if(e.body.resource)delete t._hypertyResources[e.body.resource];else{if(!e.body.resources)throw new Error("[HypertyResourcesStorage._onDelete] mandatory resource missing: ",e);e.body.resources.forEach(e=>{delete t._hypertyResources[e]})}t._storageManager.delete("resourceURL",e.body.resource).then(()=>{let r={from:e.to,to:e.from,id:e.id,type:"response",body:{code:200}};t._bus.postMessage(r)}).catch(r=>{let s={from:e.to,to:e.from,id:e.id,type:"response",body:{code:400,description:r}};t._bus.postMessage(s)})}}(this.runtimeURL,this.messageBus,this.storages.hypertyResources,this._hypertyResources),this.p2p?(Zt.info("[RuntimeUA - init] load p2pHandler: ",e),this._loadP2PHandler()):(Zt.info("[RuntimeUA - init] P2P not supported"),"P2P Not Supported"))).then(e=>{Zt.info("[runtime ua - init] - status: ",e),t(!0)},e=>{Zt.error("ERROR: ",e),t(!0)})}catch(e){r(e)}})}_setNetworkStatusListeners(){this.runtimeFactory.listenOnline(this._updateRuntimeStatus("online")),this.runtimeFactory.listenOffline(this._updateRuntimeStatus("offline"))}_updateRuntimeStatus(e){this.messageBus.postMessage({from:this.runtimeURL,to:this.runtimeURL+"/status",type:"update",body:e})}_loadP2PHandler(){return new Promise(e=>{let t=U.runtimeDescriptor.p2pHandlerStub,r={isHandlerStub:!0,runtimeURL:this.runtimeURL};Zt.log("[RuntimeUA loadP2PHandler] P2PStubHandler: ",t),this.loader.loadStub(t,r).then(t=>{let r=this.runtimeURL+"/ua",s={type:"subscribe",from:r,to:"domain://msg-node."+this.domain+"/sm",body:{subscribe:[t.url],source:this.runtimeURL}};this.messageBus.addListener(r,e=>{Zt.log("[runtime ua - listener] - receive msg: ",e)}),this.messageBus.postMessage(s,e=>{Zt.log("[runtime ua - postMessage] - reply: ",e)}),Zt.info("[runtime ua - p2p installation] - success: ",t),e(!0)}).catch(t=>{Zt.info("[runtime ua - p2p installation] - fail: ",t),e(!1)})})}_loadComponents(e){return new Promise((t,r)=>{try{this.descriptorInstance=new class{constructor(e,t){if(!e)throw Error("The descriptor need to know the runtime url to be used");if(!t)throw Error("The descriptor needs the runtime configuration");this.log=Ft,this.runtimeConfiguration=t,this.runtimeURL=e,this.constraints=U.runtimeCapabilities}getDescriptor(e){return fetch(e).then(e=>e.json())}getHypertyDescriptor(e){return this.catalogue.getHypertyDescriptor(e,!0,this.constraints)}getStubDescriptor(e){return new Promise((t,r)=>{let s,o,n,i=x(this.runtimeURL).domain;if(e.includes("://")){let t=x(e);s=t.domain;let r=t.identity;o=r?r.substring(r.lastIndexOf("/")+1):"default"}else o="default",s=e;if(n=B(this.runtimeConfiguration,"catalogueURLs","protocolstub",o),s!==this.runtimeConfiguration.domain)if(e.indexOf("https")&&e.indexOf("hyperty-catalogue")){let e=F(this.runtimeConfiguration,"catalogueURLs","protocolstub");n=e.prefix+s+e.suffix+o}else n=e;return Ft.log("Load ProtocolStub for domain, "+s+" : ",n),this.catalogue.getStubDescriptor(n,!0,this.constraints).then(e=>{t(e)}).catch(e=>{o=s,s=i;let t=F(this.runtimeConfiguration,"catalogueURLs","protocolstub");return n=t.prefix+s+t.suffix+o,this.catalogue.getStubDescriptor(n,!0,this.constraints)}).then(e=>{t(e)}).catch(e=>{r(e)})})}getIdpProxyDescriptor(e){return new Promise((t,r)=>{let s,o,n=x(this.runtimeURL).domain,i=this.constraints;if(i.constraints.onlyAccessToken=!0,i.constraints.onlyIdAssertionValidation=!0,console.log("LOG HERE",i),e.includes("://")){let t=x(e);s=t.domain;let r=t.identity;o=r?r.substring(r.lastIndexOf("/")+1):"default"}else o="default",s=e;let a=F(this.runtimeConfiguration,"catalogueURLs","idpProxy");return e=a.prefix+s+a.suffix+o,this.catalogue.getIdpProxyDescriptor(e,!0,i).then(e=>{t(e)}).catch(()=>(o=s,s=n,e=B(this.runtimeConfiguration,"catalogueURLs","idpProxy",o),this.catalogue.getIdpProxyDescriptor(e,!0,i))).then(e=>{t(e)}).catch(e=>{r(e)})})}}(this.runtimeURL,this.runtimeConfiguration),this.loader=new class{constructor(e,t,r){if(!t)throw Error("[Runtime.Loader] The descriptor need to know the runtime configuration");if(!r)throw Error("[Runtime.Loader] The descriptor need to know the runtime Descriptor instance");this.log=Tt,this.runtimeConfiguration=t,this.descriptors=r,console.log(System),console.log(et)}set runtimeURL(e){this._runtimeURL=e}get runtimeURL(){return this._runtimeURL}set registry(e){this._registry=e;let t=et.instance;this._addressAllocation=t,Tt.log("[Loader - AddressAllocation] - ",t)}get registry(){return this._registry}set messageBus(e){this._messagesBus=e}get messageBus(){return this._messagesBus}set runtimeFactory(e){this._runtimeFactory=e}get runtimeFactory(){return this._runtimeFactory}loadHyperty(e,t=!1,r,s){if(!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader] hypertyUrl parameter is needed");let o,n,i,a=!1,c=e.replace(".js",".json");return new Promise((s,u)=>{let l=e=>{Tt.info("[Runtime.Loader] Something failed on the deploy hyperty: ",e),u(e)},d=e=>{a=!0,u(e)};System.import(e).then(e=>{i=new e.default}).then(()=>this.descriptors.getDescriptor(c)).then(e=>{Tt.info("[Runtime.Loader.loadHyperty] hyperty Instance ",i);let h=e;h.dataObjects[0]=h.dataObjects[0].replace("%domain%",this._registry._domain),Tt.info("[Runtime.Loader] 1: return hyperty descriptor: ",h),i.name=e.name,n=this.registry.getAppSandbox(),this._addressAllocation.create(this._registry._domain,1,h,"hyperty",t).then(e=>!a&&(Tt.info("[Runtime.Loader] 6: return the addresses for the hyperty",e),this.registry.registerHyperty(n,c,h,e,r)),d).then(e=>{if(a)return!1;Tt.info("[Runtime.Loader] 7: registration result",e),o=e.url;let t={};if(!C(h.configuration))try{t=Object.assign({},JSON.parse(h.configuration))}catch(e){t=h.configuration}t.runtimeURL=this._runtimeURL,e.p2pHandler&&(t.p2pHandler=e.p2pHandler,t.p2pRequester=e.p2pRequester);try{return n.deployComponent(i,o,t)}catch(e){Tt.info("[Runtime.Loader] Error on deploy component:",e),u(e)}},d).then(e=>{if(a)return!1;Tt.info("[Runtime.Loader] 8: Deploy component status for hyperty: ",e),this.messageBus.addListener(o,e=>{n.postMessage(e)}),this.messageBus.addListener(this.runtimeURL+"/status",e=>{n.postMessage(e)});let t={runtimeHypertyURL:o,status:e,name:i.name,instance:i};Tt.info("[Runtime.Loader] Hyperty deployed: ",t),s(i),Tt.info("[Runtime.Loader] ------------------ END ------------------------")},d).catch(l)})})}loadStub(e,t){if(!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader.loadStub]ProtoStub descriptor url parameter is needed");return new Promise((r,s)=>{let o,n,i,a=x(e).domain;a||(a=e);let c,u,l,d=!1,h=e=>{Tt.info("[Runtime.Loader.loadStub]Something failed on the deploy of protocolstub: ",e),s(e)},y=e=>{d=!0,s(e)},p=!1,f=!1,g={};Tt.info("[Runtime.Loader.loadStub] starting loading for ",e," with p2pconfig ",t),Tt.info("[Runtime.Loader.loadStub]Discover or Create a new ProtoStub for domain: ",a);try{if(t)if(t.hasOwnProperty("isHandlerStub")&&t.isHandlerStub)p=!0,c=this.runtimeURL,l=this.registry.discoverP2PStub();else{f=!0;let e=t.remoteRuntimeURL;c=e,l=this.registry.discoverP2PStub(e)}else c=a,l=this.registry.discoverProtostub(a);Tt.info("[Runtime.Loader.loadStub]1. Proto Stub Discovered for ",e,": ",l),r(l),Tt.info(" [Runtime.Loader]------------------- END ---------------------------\n")}catch(l){return Tt.info("[Runtime.Loader.loadStub]1. Proto Stub not found "+l),this._load("protocolstub",e).then(e=>!d&&(n=e.descriptor,Tt.info("[Runtime.Loader.loadStub]2. return the ProtoStub descriptor ",n),u=e.instance,n&&n.constraints&&(g=n.constraints),Tt.info("[Runtime.Loader.loadStub]3. return the ProtoStub Source Code"),this.registry.getSandbox(a,g))).then(e=>!d&&(Tt.info("[Runtime.Loader.loadStub]4. if the sandbox is registered then return the sandbox ",e),o=e,e)).catch(e=>!d&&(Tt.info("[Runtime.Loader.loadStub]5. Sandbox was not found, creating a new one ",e),this._runtimeFactory.createSandbox(g).then(e=>(e.addListener("*",e=>{this.messageBus.postMessage(e)}),e)))).then(r=>!d&&(Tt.info("[Runtime.Loader.loadStub]6. return the sandbox instance and register",r,"to domain ",a),o=r,this.registry.registerStub(o,c,t,e,n)),y).then(e=>{if(d)return!1;Tt.info("[Runtime.Loader.loadStub] 7. return the runtime protostub url: ",e),i=e.url;let r={};if(!C(n.configuration))try{r=Object.assign({},JSON.parse(n.configuration))}catch(e){r=n.configuration}if(t)try{r=Object.assign(r,JSON.parse(t))}catch(e){r=Object.assign(r,t)}r.runtimeURL=this._runtimeURL;try{return Tt.info("[Runtime.Loader.loadStub] 8: adding sandbox listener to protostubURL : ",i),this.messageBus.addListener(i,e=>{o.postMessage(e)}),o.deployComponent(u,i,r)}catch(e){Tt.error("[Runtime.Loader.loadStub] Error on deploy component:",e),s(e)}},y).then(()=>{if(d)return!1;let e;t?(Tt.log("[Runtime.Loader.loadStub] p2pConfig: ",t),t.hasOwnProperty("isHandlerStub")&&(e=this.registry.p2pHandlerStub[this._runtimeURL]),t.hasOwnProperty("p2pRequesterStub")&&(e=this.registry.p2pRequesterStub[t.remoteRuntimeURL])):e=this.registry.protostubsList[a],Tt.log("[Runtime.Loader.loadStub] Stub: ",e),r(u),Tt.info("[Runtime.Loader.loadStub]------------------- END ---------------------------\n")},y).catch(h)}})}_load(e,t){let r,s,o=x(this.runtimeURL).domain,n=new System.constructor,i=x(t);r=i.domain;let a=i.identity;t.includes("://")?(r=i.domain,s=a?a.substring(a.lastIndexOf("/")+1):"default"):(s="default",r=t);let c=F(this.runtimeConfiguration,"catalogueURLs",e),u="idp-proxy"===e?".idp":".ps",l=c.prefix+r+c.suffix+s+u+".js";Tt.log("[Loader._load] first import for "+t);let d=c.prefix+r+c.suffix+s+u+".json";return n.import(l).then(e=>new e.default).then(e=>this.descriptors.getDescriptor(d,e).then(t=>({descriptor:t,instance:e}))).catch(()=>{s=r,r=o;let t=B(this.runtimeConfiguration,"catalogueURLs",e,s,!0),i=t.replace(".js",".json");return Tt.log("[Loader._load] 2nd import for "+t),n.import(t).then(e=>new e.default).then(e=>this.descriptors.getDescriptor(i).then(t=>({descriptor:t,instance:e})))})}loadIdpProxy(e){if(!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader] IdpProxy descriptor url parameter is needed");return new Promise((t,r)=>{let s,o,n,i=x(e).domain;i||(i=e);let a=!1,c=e=>{Tt.info("[Runtime.Loader] Something failed on the deploy of IdpProxy: ",e),r(e)},u=e=>{a=!0,r(e)};Tt.info("[Runtime.Loader] ------------------- IDP Proxy Deploy ---------------------------\n"),Tt.info("[Runtime.Loader] Discover or Create a new IdpProxy for domain/URL: ",i);try{let l=this.registry.discoverIdpProxy(i);Tt.info("[Runtime.Loader] 1. IDPProxy Discovered: ",l);let d=this.registry.idpProxyList[i];Tt.log("Deployed: ",d),t(d),Tt.info("[Runtime.Loader] ------------------- END ---------------------------\n")}catch(l){Tt.info("[Runtime.Loader] 1. IdpProxy not found:",l),this._load("idp-proxy",e).then(e=>(Tt.info("[Runtime.Loader] 2. Return the IDPProxy descriptor"),o=e.descriptor,d=e.instance,this.registry.getSandbox(i))).then(e=>!a&&(Tt.info("[Runtime.Loader] 4. if the sandbox is registered then return the sandbox",e),s=e,e)).catch(e=>!a&&(Tt.info("[Runtime.Loader] 5. Sandbox was not found, creating a new one",e),o&&o.hasOwnProperty("capabilities")&&(o=o.stubCapabilities),this._runtimeFactory.createSandbox({}).then(e=>(e.addListener("*",e=>{this.messageBus.postMessage(e)}),e)))).then(e=>!a&&(Tt.info("[Runtime.Loader] 6. return the sandbox instance and register",e,"to domain ",i),s=e,this.registry.registerIdpProxy(e,i)),u).then(e=>{if(a)return!1;Tt.info("[Runtime.Loader] 7. Return the runtime Idp Proxy URL: ",e),n=e;let t={};if(!C(o.configuration))try{t=Object.assign({},JSON.parse(o.configuration))}catch(e){t=o.configuration}t.runtimeURL=this._runtimeURL;try{return this.messageBus.addListener(n,e=>{s.postMessage(e)}),s.deployComponent(d,e,t)}catch(e){Tt.info("[Runtime.Loader] Error on deploy component:",e),r(e)}},u).then(()=>{if(a)return!1;let e=this.registry.idpProxyList[i];Tt.log("[Runtime.Loader.loadIdpProxy] 8: loaded: ",e),t(e),Tt.info("[Runtime.Loader.loadIdpProxy] ------------------- END ---------------------------\n")},u).catch(c)}})}_readyToUse(){let e=!1;if(!this._runtimeURL)throw new Error("[Runtime.Loader] The loader need the runtime url address");if(!this._messagesBus)throw new Error("[Runtime.Loader] The loader need the messageBus component");if(!this._registry)throw new Error("[Runtime.Loader] The loader need the registry component");if(!this._runtimeFactory)throw new Error("[Runtime.Loader] The loader need the runtime factory component");return e=!0,!0}}(this.runtimeURL,this.runtimeConfiguration,this.descriptorInstance),this.identityModule=new class{constructor(e,t,r,s,o){if(!e)throw new Error("runtimeURL is missing.");if(!r)throw new Error("storageManager is missing");if(!o)throw new Error("cryptoManager is missing");this._runtimeURL=e,this.dataObjectsStorage=s,this._idmURL=this._runtimeURL+"/idm",this._guiURL=this._runtimeURL+"/identity-gui",this.runtimeCapabilities=t,this._domain=x(this._runtimeURL).domain,this._identities=new ft("human",r),this._crypto=o,this.dataObjectsIdentity={},this._listOfIdps=[],this.guiDeployed=!1}get messageBus(){return this._messageBus}set messageBus(e){this._messageBus=e,this.addGUIListeners()}get coreDiscovery(){return this._coreDiscovery}set coreDiscovery(e){this._coreDiscovery=e}get registry(){return this._registry}set registry(e){this._registry=e}getIdentity(e){return this.identities.getIdentity(e)}get identities(){return this._identities}set identities(e){this._identities=e}get idps(){return this._listOfIdps}getIdentitiesToChoose(){return new Promise(e=>{let t=ht.catalogueURLs["idp-proxy"].prefix,r=ht.catalogueURLs["idp-proxy"].suffix,s=ht.catalogueURLs["idp-proxy"].all;const o=t+this._domain+r+s;Promise.all([this.runtimeCapabilities.isAvailable("browser"),this.runtimeCapabilities.isAvailable("node")]).then(t=>{const r=t[0],s=t[1],n={constraints:{}};n.constraints.node=s,n.constraints.browser=r,this._getAllIdps(o).then(t=>{const r=t.map(e=>({domain:e,type:"idToken"}));return bt.info("[IdentityModule.getIdentityAssertion:getIdentitiesToChoose]",t,r),this._listOfIdps=r,e({defaultIdentity:this.identities.defaultIdentity,identities:this.identities.identities,idps:r})})})})}_getAllIdps(e){return new Promise(function(t,r){fetch(e).then(function(e){console.log(e),e.json().then(function(e){console.log(e),t(e.idps)})},function(e){r(e)})})}init(e){let t=this;return new Promise(r=>{t._identities.loadIdentities().then(()=>{e?(t.identities.guid=e,t._identities.loadAccessTokens().then(()=>{r()})):t._crypto.getMyPublicKey().then(s=>{t._crypto.crypto._sha256(ee(s)).then(s=>{e="user-guid://"+s,t.identities.guid=e,t._identities.loadAccessTokens().then(()=>{r()})}).catch(e=>{console.log("[IdentityModule] error",e)})})})})}getIdentityAssertion(e){bt.log("[IdentityModule.getIdentityAssertion:identityBundle]",e);let t=this;return new Promise(function(r,s){t.runtimeCapabilities.isAvailable("browser").then(o=>{if(bt.log("runtime browser identity acquisition",o),o)if(e&&e.hasOwnProperty("idp")){let o=e.idp,n=e.hasOwnProperty("origin")?e.origin:"origin",i=e.hasOwnProperty("idHint")?e.idHint:"";if(t.identities.defaultIdentity){let e=t.identities.defaultIdentity;if(e.expires>k())return r(e);e.hasOwnProperty("refresh")?(bt.log("[Identity.IdentityModule.getIdentityAssertion] refreshing assertion: ",e),t._refreshIdAssertion().then(e=>(bt.log("[IdentityModule.getIdentityAssertion] refreshed assertion.",e),r(e)),e=>{bt.error("[IdentityModule.getIdentityAssertion] error on refresIdAssertion: ",e," Asking for a new IdAssertion."),t._getIdAssertionForDomain(n,o,i).then(e=>{r(e)},e=>{s(e)})})):t._getIdAssertionForDomain(n,o,i).then(e=>{r(e)},e=>{s(e)})}else t._getIdAssertionForDomain(n,o,i).then(e=>{r(e)},e=>{s(e)})}else if(t.identities.defaultIdentity){let e=t.identities.defaultIdentity;if(e.expires>k())return r(e);e.hasOwnProperty("refresh")?(bt.log("[Identity.IdentityModule.getValidToken] refreshing assertion: ",e),t._refreshIdAssertion(e).then(e=>(bt.log("[IdentityModule.getIdentityAssertion] refreshed assertion.",e),r(e)),e=>{bt.error("[IdentityModule.getIdentityAssertion] error on refresIdAssertion: ",e," Asking for a new IdAssertion."),t.selectIdentityFromGUI().then(e=>(bt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,r(e)),e=>s(e))})):t.selectIdentityFromGUI().then(e=>(bt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,r(e)),e=>s(e))}else t.selectIdentityFromGUI().then(e=>(bt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,r(e)),e=>s(e))}).catch(e=>(bt.error("Error on identity acquisition ",e),s(e))),t.runtimeCapabilities.isAvailable("node").then(e=>{if(bt.log("node identity acquisition",e),e){if(t.identities.currentIdentity)return r(t.identities.currentIdentity);{bt.log("getIdentityAssertion for nodejs");let e={type:"idp",value:"nodejs-idp",code:200,auth:!1};t.callNodeJsGenerateMethods(e.value,"origin").then(e=>{r(e)},e=>{s(e)})}}}).catch(e=>{bt.error("Error on identity acquisition ",e),s(e)})})}_getIdAssertionForDomain(e,t,r){let s=this;return new Promise((o,n)=>{s.selectIdentityForHyperty(e,t,r).then(e=>(bt.log("[IdentityModule._getIdAssertionForDomain] Identity selected by hyperty."),o(e)),e=>{s.selectIdentityFromGUI().then(e=>(bt.log("[IdentityModule._getIdAssertionForDomain] Identity selected by hyperty."),o(e)),e=>n(e))})})}_refreshIdAssertion(e){let t=this;return new Promise((r,s)=>{t.sendRefreshMessage(e).then(e=>{bt.log("[Identity.IdentityModule.getValidToken] refreshed assertion: ",e),t.identities.updateAssertion(e).then(()=>{r(e)},e=>{bt.error("[IdentityModule.getValidToken] error updating the assertion ",e),s(e)})},e=>{bt.error("[IdentityModule.getValidToken] error refreshing the assertion ",e),s(e)})})}getUsersIDs(){return this.identities.identifiers}deleteIdentity(e){return this.identities.removeIdentity(e)}listenShowAdmin(e){this._showAdmin=e}requestIdentityToGUI(e,t){bt.log("[IdentityModule.requestIdentityToGUI:identities]",e),bt.log("[IdentityModule.requestIdentityToGUI:idps]",t);let r=this;return new Promise(function(s,o){if(!1===r.guiDeployed){let e=new class{constructor(e,t){gt.log("FakeGUI_deployed");let r=this;r._url=e,r._waitTime=1e4,r._messageBus=t,r._messageBus.addListener(r._url,e=>{if(e.hasOwnProperty("type")&&"create"===e.type&&e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("identities")&&e.body.value.hasOwnProperty("idps")){let t,s=e.body.value.identities,o=e.body.value.idps;t=void 0!==s[0]?{type:"identity",value:s[0],code:200}:{type:"idp",value:o[2].domain,code:200};let n={id:e.id,type:"response",to:e.from,from:e.to,body:t};"wait"===e.body.value?setTimeout(()=>{r._messageBus.postMessage(n)},r._waitTime):r._messageBus.postMessage(n)}else gt.log("Ignoring messages not intended to FakeGUI.",e)})}}(r._guiURL,r._messageBus);r.guiFake=e,r.guiDeployed=!0}let n={type:"create",to:r._guiURL,from:r._idmURL,body:{value:{identities:e,idps:t}}},i=e=>{if(r._messageBus.removeResponseListener(r._idmURL,e.id),200===e.body.code){let t=e.body;bt.log("selectedIdentity: ",t.value),s(t)}else o("error on requesting an identity to the GUI")};try{r._messageBus.postMessage(n,i,!1)}catch(e){o("In method callIdentityModuleFunc error: "+e)}})}callNodeJsGenerateMethods(e,t){bt.log("[callNodeJsGenerateMethods:idp]",e),bt.log("[callNodeJsGenerateMethods:origin]",t);let r=this;return new Promise((s,o)=>{let n;r._crypto.getMyPublicKey().then(function(s){return bt.log("[callNodeJsGenerateMethods:key]",s),n=ee(s),bt.log("[callNodeJsGenerateMethods] NO_URL"),r.generateAssertion(n,t,"url",e)}).then(function(e){e?s(e):o("Error on obtaining Identity")}).catch(function(e){bt.log(e),o(e)})})}callGenerateMethods(e,t){bt.log("[callGenerateMethods:idp]",e),bt.log("[callGenerateMethods:origin]",t);let r=this;return new Promise((s,o)=>{let n;r._crypto.getMyPublicKey().then(function(s){return bt.log("[callGenerateMethods:key]",s),n=ee(s),bt.log("generateAssertion:no_hint"),r.generateAssertion(n,t,"",e)}).then(function(s){return r.myHint=s,bt.log("generateAssertion:hint"),r.generateAssertion(n,t,s,e)}).then(function(e){e?s(e):o("Error on obtaining Identity")}).catch(function(e){bt.error(e),o(e)})})}loginSelectedIdentity(e,t,r,s){bt.log("[loginSelectedIdentity:publicKey]",e),bt.log("[loginSelectedIdentity:origin]",t),bt.log("[loginSelectedIdentity:idp]",r),bt.log("[loginSelectedIdentity:loginUrl]",s);let o=this;return new Promise((n,i)=>{bt.log("[IdentityModule] openPopup"),o.callIdentityModuleFunc("openPopup",{urlreceived:s}).then(e=>e,e=>(bt.error("Error while logging in for the selected identity."),i(e))).then(s=>{o.sendGenerateMessage(e,t,s,r).then(e=>{if(!e.hasOwnProperty("assertion"))return bt.error("Error while logging in for the selected identity."),i("Could not generate a valid assertion for selected identity.");o.identities.addAssertion(e).then(e=>{n("Login was successfull")}).catch(e=>{i("Login has failed:"+e)})}).catch(e=>{i("On loginSelectedIdentity from method sendGenerateMessage error:  "+e)})})})}selectIdentityForHyperty(e,t,r){bt.log("[selectIdentityForHyperty:origin]",e),bt.log("[selectIdentityForHyperty:idp]",t),bt.log("[selectIdentityForHyperty:idHint]",r);let s=this;return new Promise((o,n)=>{s._crypto.getMyPublicKey().then(function(i){let a=ee(i);s.sendGenerateMessage(a,e,r,t).then(r=>{r.hasOwnProperty("assertion")?s.identities.addAssertion(r).then(e=>o(r),e=>n(e)):r.hasOwnProperty("loginUrl")?s.loginSelectedIdentity(a,e,t,r.loginUrl).then(e=>o(e),e=>n(e)):(bt.log("Proceeding by logging in."),s.callGenerateMethods(t,e).then(e=>o(e),e=>n(e)))}).catch(e=>{n("On selectIdentityForHyperty from method sendGenerateMessage error:  "+e)})}).catch(e=>{n("On selectIdentityForHyperty from method generateRSAKeyPair error:  "+e)})})}selectIdentityFromGUI(e){bt.log("[IdentityModule.selectIdentityFromGUI:origin]",e);let t=this;return new Promise((r,s)=>{this.getIdentitiesToChoose().then(e=>t.requestIdentityToGUI(e.identities,e.idps)).then(o=>{if("identity"===o.type)t.identities.identities[o.value]?r(t.identities.identities[o.value]):s("[IdentityModule.selectIdentityFromGUI] identity not found: ",o.value);else{if("idp"!==o.type)return s("error on GUI received message.");t.callGenerateMethods(o.value,e).then(e=>r(e),e=>s(e))}}).catch(e=>{s("On selectIdentityFromGUI from method requestIdentityToGUI error:  "+e)})})}callIdentityModuleFunc(e,t,r,s){bt.log("[callIdentityModuleFunc:methodName]",e),bt.log("[callIdentityModuleFunc:parameters]",t);let o=this;return new Promise((n,i)=>{if(o._showAdmin)"getAccessToken"===e?o._showAdmin(e,t.urlreceived,r,s).then(e=>{n(e)}):o._showAdmin(e);else{let r={type:"execute",to:o._guiURL,from:o._idmURL,body:{resource:"identity",method:e,params:t}},s=e=>{o._messageBus.removeResponseListener(o._idmURL,e.id);let t=e.body.value;n(t)};try{o._messageBus.postMessage(r,s,!1)}catch(e){i("In method callIdentityModuleFunc error: "+e)}}})}getToken(e){let t=this,r=e.from,s=e.to;return e.hasOwnProperty("body")&&e.body.hasOwnProperty("source")&&(r=e.body.source),"forward"===e.type&&(r=e.body.from),e.hasOwnProperty("body")&&e.body.hasOwnProperty("subscriber")&&(r=e.body.subscriber),new Promise(function(o,n){bt.log("[IdentityModule.getToken] for msg ",e),t.registry.isLegacy(s).then(function(s){s?t._getAccessToken(e).then(e=>{bt.log("[IdentityModule.getToken] access token ",e),o(I(e))}).catch(e=>{n("[IdentityModule.getToken] Access Token error "+e)}):t._getValidToken(r).then(e=>{o(e)}).catch(e=>{n("On getToken from method _getValidToken error: "+e)})}).catch(e=>{n("On getToken from method isLegacy error: "+e)})})}getIdToken(e){bt.info("getIdToken:hypertyURL ",e);let t=this;return new Promise(function(r,s){let o;if("hyperty"===e.split("://")[0]){if(o=t.registry.getHypertyOwner(e)){let e=t.identities.getIdentity(o);return e?r(e):s("[IdentityModule.getIdToken] Identity not found for: ",o)}return s("[IdentityModule.getIdToken] User not found for hyperty: ",o)}t._getHypertyFromDataObject(e).then(e=>{if(o=t.registry.getHypertyOwner(e)){let e=t.identities.getIdentity(o);return e?r(e):s("[IdentityModule.getIdToken] Identity not found for: ",o)}return s("[IdentityModule.getIdToken] User not found for hyperty: ",e)}).catch(e=>{bt.error("[IdentityModule.getIdToken] Error: ",e),s(e)})})}_getAccessToken(e){let t=e.to,r=this;return new Promise(s=>{if(!e.hasOwnProperty("body"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body: ",e);if(!e.body.hasOwnProperty("value"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body value: ",e);if(!e.body.value.hasOwnProperty("resources"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body value resources: ",e);let o=x(t).domain;t.includes("protostub")&&(o=o.replace(o.split(".")[0]+".",""));let n=e.body.value.resources;r._getAccessTokenForDomain(o,n).then(e=>{s(e)})})}_getAccessTokenForDomain(e,t){let r,s=this;return new Promise((o,n)=>{try{r=s.identities.getAccessToken(e,t)}catch(e){return n("[IdentityModule._getAccessTokenForDomain] Access Token error "+err)}if(r){if("in-progress"===r.status)return o(s._inProgressAccessToken(e,t));{let n=k();if(bt.log("[Identity.IdentityModule._getAccessTokenForDomain] found  Access Token ",r),!(n>=r.expires))return o(I(r));r.hasOwnProperty("refresh")?s._refreshAccessToken(I(r)).then(e=>o(s.identities.updateAccessToken(e))):s._revokeAccessToken(r,e,t).then(()=>{setTimeout(()=>s._getNewAccessToken(e,t),1e3)})}}else s._getNewAccessToken(e,t).then(e=>(bt.log("[Identity.IdentityModule._getAccessTokenForDomain] new Access Token ",e),o(e))).catch(e=>{n("[IdentityModule._getAccessTokenForDomain] on getNewAccessToken "+e)})})}_revokeAccessToken(e,t,r){let s=this;return bt.log("[IdentityModule._revokeAccessToken] to be revoked ",e),new Promise((o,n)=>{let i;i={type:"execute",to:s._resolveDomain(e.domain),from:s._idmURL,body:{method:"revokeAccessToken",params:{token:e}}},bt.log("[IdentityModule._revokeAccessToken] revoke msg ",i);try{s._messageBus.postMessage(i,e=>{let n=e.body.value;n&&s._identities.removeAccessToken(t,r).then(()=>{o(n)}),o()})}catch(e){n("In IdentityModule._revokeAccessToken on postMessage error: "+e)}})}_inProgressAccessToken(e,t){this.identities.watchingYou.observe("accessTokens",r=>{bt.log("[IdentityModule._inProgressAccessToken] accessTokens changed "+this.identities.accessTokens);let s=r.keypath;if(s.includes("status")&&(s=s.replace(".status","")),s===e&&"status"===r.name&&"created"===r.newValue)return this.identities.getAccessToken(e,t)})}_getNewAccessToken(e,t){let r=this;return new Promise(function(s,o){r.identities.setAccessTokenInProgress(e);let n={type:"execute",to:r._resolveDomain(e),from:r._idmURL,body:{method:"getAccessTokenAuthorisationEndpoint",params:t}};r._messageBus.postMessage(n,i=>{if(i.body.code>299)return o("[IdentityModule._getNewAccessToken] Error on getAccessTokenAuthorisationEndpoint from IdP Proxy: ",i.body.desc);r.callIdentityModuleFunc("getAccessToken",{urlreceived:i.body.value},e,t[0]).then(e=>{bt.log("[IdentityModule:callIdentityModuleFunc:openPopup] auhtorisation result: ",e),n.body.method="getAccessToken",n.body.params={resources:t,login:e},r._messageBus.postMessage(n,e=>{if(e.body.code>299)return o("[IdentityModule._getNewAccessToken] Error on getAccessToken from IdP Proxy: ",e.body.desc);r.identities.addAccessToken(e.body.value).then(t=>(bt.info("[IdentityModule._getNewAccessToken] resolving token: ",t),s(e.body.value)),e=>{o(e)})})},e=>{o(e)})})})}_refreshAccessToken(e){let t=this;return bt.log("IdentityModule._refreshAccessToken:outdatedToken",e),new Promise((r,s)=>{let o;o={type:"execute",to:t._resolveDomain(e.domain),from:t._idmURL,body:{method:"refreshAccessToken",params:{token:e}}};try{t._messageBus.postMessage(o,e=>{let t=e.body.value;r(t)})}catch(e){s("In IdentityModule._refreshAccessToken on postMessage error: "+e)}})}sendRefreshMessage(e){let t=this;return bt.log("sendRefreshMessage:oldIdentity",e),new Promise((r,s)=>{let o,n=t._resolveDomain(e.idp.domain),i=t.getIdentity(e.userProfile.userURL);bt.info("sendRefreshMessage:oldIdentity",e),o={type:"execute",to:n,from:t._idmURL,body:{resource:"identity",method:"refreshAssertion",params:{identity:i}}};try{t._messageBus.postMessage(o,t=>{if(t.body.code<300){let e=t.body.value;r(e)}else r(e)})}catch(e){s("In sendRefreshMessage on postMessage error: "+e)}})}getAccessToken(e,t,r){bt.log("[getAccessToken:idpDomain]",e);let s=this;return new Promise((o,n)=>{let i;i={type:"execute",to:s._resolveDomain(e),from:s._idmURL,body:{resource:"identity",method:"getAccessToken",params:{resources:t,login:r}}};try{s._messageBus.postMessage(i,e=>{if(e.body.code<299){let t=e.body.value;o(t)}else o(e.body)})}catch(e){n("IdentityModule.In getAccessToken: "+e)}})}getAccessTokenAuthorisationEndpoint(e,t){bt.log("[getAccessTokenAuthorisationEndpoint:idpDomain]",t);let r=this;return new Promise((s,o)=>{let n;n={type:"execute",to:r._resolveDomain(t),from:r._idmURL,body:{resource:"identity",method:"getAccessTokenAuthorisationEndpoint",params:{resources:e}}};try{r._messageBus.postMessage(n,e=>{let t=e.body.value;s(t)})}catch(e){o("In getAccessTokenAuthorisationEndpoint: "+e)}})}sendGenerateMessage(e,t,r,s){bt.log("[sendGenerateMessage:contents]",e),bt.log("[sendGenerateMessage:origin]",t),bt.log("[sendGenerateMessage:usernameHint]",r),bt.log("[sendGenerateMessage:idpDomain]",s),bt.log("sendGenerateMessage_hint");let o=this;return new Promise((n,i)=>{let a;a={type:"execute",to:o._resolveDomain(s),from:o._idmURL,body:{resource:"identity",method:"generateAssertion",params:{contents:e,origin:t,usernameHint:r}}};try{o._messageBus.postMessage(a,e=>{e.body.code<300?n(e.body.value):i(e.body)})}catch(e){i("In sendGenerateMessage: "+e)}})}generateAssertion(e,t,r,s){bt.log("[generateAssertion:contents]",e),bt.log("[generateAssertion:origin]",t),bt.log("[generateAssertion:usernameHint]",r),bt.log("[generateAssertion:idpDomain]",s);let o=this;return new Promise(function(n,i){bt.log("[IdentityModule:sendGenerateMessage:sendGenerateMessage]",r),o.sendGenerateMessage(e,t,r,s).then(e=>{e?o.identities.addAssertion(e).then(t=>{n(e)},e=>{i(e)}):i("error on obtaining identity information")},e=>{e.hasOwnProperty("description")&&e.description.hasOwnProperty("loginUrl")?o.callIdentityModuleFunc("login",{urlreceived:e.description.loginUrl}).then(e=>{bt.log("[IdentityModule:callIdentityModuleFunc:openPopup]",r),n(e)},e=>{i(e)}):(bt.error("[IdentityModule:sendGenerateMessage] generate assertion with hint error ",e),i(e))}).catch(e=>{i("On generateAssertion from method sendGenerateMessage error: "+e)})})}validateAssertion(e,t,r){bt.log("[validateAssertion:assertion]",e),bt.log("[validateAssertion:origin]",t),bt.log("[validateAssertion:idpDomain]",r);let s=this,o={type:"execute",to:s._resolveDomain(r),from:s._idmURL,body:{resource:"identity",method:"validateAssertion",params:{assertion:e,origin:t}}};return new Promise(function(e,t){try{s._messageBus.postMessage(o,r=>{200===r.body.code?e(r.body.value):t("error",r.body.code)})}catch(e){t("On validateAssertion from method postMessage error: "+e)}})}addGUIListeners(){let e=this;e._messageBus.addListener(e._idmURL,t=>{let r,s=t.body.method;if(bt.log("[IdentityModule:addGUIListeners]",t,t.body,s),"deployGUI"===s)r=e.deployGUI();else{if("getIdentitiesToChoose"===s)return void e.getIdentitiesToChoose().then(r=>{let s={type:"execute",value:r,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}});if("unregisterIdentity"===s){let s=t.body.params.email;r=e.unregisterIdentity(s)}else{if("getMyPublicKey"===s)return void e._crypto.getMyPublicKey().then(r=>{let s={type:"execute",value:r=ee(r),code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners from if generateRSAKeyPair method postMessage error: "+e)}});if("sendGenerateMessage"===s){let r=t.body.params.contents,s=t.body.params.origin,o=t.body.params.usernameHint,n=t.body.params.idpDomain,i={id:t.id,type:"response",to:t.from,from:t.to};return void e.sendGenerateMessage(r,s,o,n).then(t=>{let r={type:"execute",value:t,code:200};i.body=r;try{e._messageBus.postMessage(i)}catch(e){bt.error("IdentityModule.addGUIListeners sendGenerateMessage error: "+e)}},t=>{bt.info("IDPProxy generateAssertion reply error "+t),i.body=t,e._messageBus.postMessage(i)})}if("getAccessTokenAuthorisationEndpoint"===s){let r=t.body.params.scope,s=t.body.params.idpDomain;return void e.getAccessTokenAuthorisationEndpoint(r,s).then(r=>{let s={type:"execute",value:r,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}})}if("addAccessToken"===s){let r=t.body.params;return void e.identities.addAccessToken(r).then(r=>{let s={type:"execute",value:r,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}if("getAccessToken"===s){let r=t.body.params.idpDomain,s=t.body.params.resources,o=t.body.params.login,n={id:t.id,type:"response",to:t.from,from:t.to};return void e.getAccessToken(r,s,o).then(t=>{let r={type:"execute",value:t,code:200};n.body=r;try{e._messageBus.postMessage(n)}catch(e){bt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}},t=>{try{n.body=t,e._messageBus.postMessage(n)}catch(e){bt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}})}if("addAssertion"===s){let r=t.body.params;return void e.identities.addAssertion(r).then(r=>{let s={type:"execute",value:r,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:s};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}if("refreshAccessToken"===s){let r=t.body.params.domain,s=t.body.params.resources;return void e._getAccessTokenForDomain(r,s).then(r=>{let s={id:t.id,type:"response",to:t.from,from:t.to,body:{value:r.accessToken,code:200}};try{e._messageBus.postMessage(s)}catch(e){bt.error("On addGUIListeners for refreshAccessToken request: "+e)}})}if("unauthorise"===s){let r=t.body.params.domain,s=t.body.params.resources;try{e._revokeAccessToken(e.identities.getAccessToken(r,s),r,s)}catch(e){return reject("[IdentityModule.addGUIListeners] unauthorise error "+err)}let o={id:t.id,type:"response",to:t.from,from:t.to,body:{value:!0,code:200}};try{e._messageBus.postMessage(o)}catch(e){bt.error("On addGUIListeners for refreshAccessToken request: "+e)}return}}}let o={type:"execute",value:r,code:200},n={id:t.id,type:"response",to:t.from,from:t.to,body:o};try{e._messageBus.postMessage(n)}catch(e){bt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}deployGUI(){this.guiDeployed=!0}_getValidToken(e){bt.log("[IdentityModule._getValidToken]:hypertyURL",e);let t=this;return new Promise((r,s)=>{t.getIdToken(e).then(function(e){bt.log("[IdentityModule._getValidToken] retrieved IdAssertion",e);let o=k();if(!e.hasOwnProperty("expires"))return r(e);let n=e.expires;bt.log("[Identity.IdentityModule.getValidToken] Token expires in",n),bt.log("[Identity.IdentityModule.getValidToken] time now:",o),o>=n?e.hasOwnProperty("refresh")?(bt.log("[Identity.IdentityModule.getValidToken] refreshing assertion: ",e),t.sendRefreshMessage(e).then(e=>{bt.log("[Identity.IdentityModule.getValidToken] refreshed assertion: ",e),t.identities.updateAssertion(e).then(()=>{r(e)},e=>{bt.error("[IdentityModule.getValidToken] error updating the assertion ",e),s(e)})},e=>{bt.error("[IdentityModule.getValidToken] error refreshing the assertion ",e),s(e)})):t.callGenerateMethods(e.idp.domain).then(e=>{r(e)}).catch(e=>{s("[IdentityModule.getValidToken] error when generating a new assertion "+e)}):r(e)}).catch(function(e){bt.error("[IdentityModule.getValidToken] error on getIdToken",e),s(e)})})}_getHypertyFromDataObject(e){bt.info("_getHypertyFromDataObject:dataObjectURL",e);let t=this;return new Promise(function(r,s){let o=x(e).domain,n=z(e),i=t.registry.getReporterURLSynchonous(n);if(bt.info("_getHypertyFromDataObject:reporterURL",i),i)r(i);else{let i=t.dataObjectsIdentity[n];if(bt.info("_getHypertyFromDataObject:storedReporterURL",i),i)r(i);else{let i=t.registry.getDataObjectSubscriberHyperty(e);bt.info("_getHypertyFromDataObject:subscriberHyperty",i),i?r(i):t._coreDiscovery.discoverDataObjectPerURL(n,o).then(e=>{bt.info("_getHypertyFromDataObject:dataObject",e),t.dataObjectsIdentity[n]=e.reporter,bt.info("_getHypertyFromDataObject:dataObject.reporter",e.reporter),r(e.reporter)},e=>{s(e)})}}})}_resolveDomain(e){return e?"domain-idp://"+e:"domain-idp://google.com"}}(this.runtimeURL,this.runtimeCapabilities,this.storages.identity,this._dataObjectsStorage,Et);let s=this.runtimeFactory.createAppSandbox();this.registry=new class{constructor(e,t,r,s,o,n,i){if(!e)throw new Error("runtimeURL is missing.");if(!o)throw new Error("storageManager is missing.");this.registryURL=e+"/registry/",this.appSandbox=t,this.runtimeURL=e,this.p2pHandlerURL=n,this.remoteRegistry=i,this.idModule=r,this.storageManager=o,this.runtimeCapabilities=s,this.identifier=K(),this.hypertiesListToRemove={},this.hypertiesList=[],this.remoteHypertyList=[],this.remoteDataObjectList=[],this.idpLegacyProxyList={},this.watchingYou=new st,this.p2pHandlerStub={},this.p2pRequesterStub=this.watchingYou.watch("p2pRequesterStub",{},!0),this.p2pConnectionList=this.watchingYou.watch("p2pConnectionList",{},!0),this.p2pHandlerAssociation={},this.protostubsList=this.watchingYou.watch("protostubsList",{},!0),this.idpProxyList=this.watchingYou.watch("idpProxyList",{},!0),this.dataObjectList={},this.subscribedDataObjectList={},this.sandboxesList={sandbox:{},appSandbox:{}},this.pepList={},this.registries={},this._domain=x(this.registryURL).domain,this.sandboxesList.appSandbox[e]=t;let a=new class{constructor(e){this._registry=e,this._remoteP2PEntities={}}checkP2P(e){if(!e.hasOwnProperty("to"))return Promise.reject("The p2p verification was failed");let t,r=e.to.split("://")[0],s=e.to.split("://")[1].split("/")[2];t=s?e.to.substring(0,e.to.indexOf("/"+s)):e.to;let o={};switch(e.body&&e.body.p2p&&(o.p2p=e.body.p2p),e.body&&e.body.p2pHandler&&e.body.p2pRequester&&(o.p2pHandler=e.body.p2pHandler,o.p2pRequester=e.body.p2pRequester,o.runtime=e.body.p2pHandler.split("/p2phandler/")[0]),r){case"runtime":return this.checkP2PRuntime(t,o);default:return this.checkP2PEntity(t,o)}}checkP2PEntity(e,t){let r=this;return new Promise((s,o)=>{let n=r._remoteP2PEntities[e];if(n)s(n);else if(t.runtime)s(t);else if(t.p2p){rt.log("[Registry - checkP2PEntity] - search in Domain Registry: ",e);let t={type:"read",from:r._registry.registryURL,to:"domain://registry."+r._registry._domain,body:{resource:e}};r._registry._messageBus.postMessage(t,e=>{if(rt.log("[Registry - checkP2PEntity] Domain Registry reply",e),"value"in e.body){let t=e.body.value;t.hasOwnProperty("p2pHandler")?s(t):o("[Registry checkP2PEntity] Hyperty found does not support P2P",e.body.value)}else o("[Registry checkP2PEntity] Hyperty with P2PHandler not found",e.body.code)})}else o("[Registry checkP2PEntity] No P2P Connection available for ",e)})}checkP2PRuntime(e,t){let r=this,s={};return new Promise((o,n)=>{r._registry.p2pConnectionList[e]?o({runtime:e}):t.runtime?o(s=t):n("[Registry.P2PConnectionResolve.checkP2PRuntime] No P2P Connection found to ",e)})}checkP2PHyperty(e,t){let r=this;return new Promise((s,o)=>{let n;for(let t in r._registry.remoteHypertyList)if(n=r._registry.remoteHypertyList[t],rt.log("[Registry - checkP2PHyperty] - for each Hyperty: ",n),n.hypertyID===e)return void(n.hasOwnProperty("p2pHandler")?s(n):o("[Registry checkP2PHyperty] Hyperty found does not support P2P",n));if(!n&&t.runtime)s(t);else if(!n&&t.p2p){rt.log("[Registry - checkP2PHyperty] - search in Domain Registry: ",n);let t={type:"read",from:r._registry.registryURL,to:"domain://registry."+r._registry._domain,body:{resource:e}};r._registry._messageBus.postMessage(t,e=>{if(rt.log("[Registry - checkP2PHyperty] Domain Registry reply",e),"value"in e.body){let t=e.body.value;r._registry.remoteHypertyList.push(t),t.hasOwnProperty("p2pHandler")?s(t):o("[Registry checkP2PHyperty] Hyperty found does not support P2P",e.body.value)}else o("[Registry checkP2PHyperty] Hyperty with P2PHandler not found",e.body.code)})}else o("[Registry checkP2PHyperty] No P2P Connection available for ",e)})}checkP2PDataObject(e,t){let r=this;return new Promise((s,o)=>{let n=r._registry.remoteDataObjectList.filter(t=>r._registry.remoteDataObjectList[t].url===e);if(0!==n.length&&n[0].p2pRequester)s(n[0]);else if(0!==n.length)o("[Registry checkP2PDataObject] Data Object found does not support P2P",n[0]);else if(0===n.length&&t.runtime)s(t);else if(n.length&&t.p2p){let t={type:"read",from:r._registry.registryURL,to:"domain://registry."+r._registry._domain,body:{resource:e}};r._registry._messageBus.postMessage(t,e=>{if(rt.log("discover data object per url reply",e),"value"in e.body){let t=e.body.value;r._registry.remoteDataObjectList.push(t),t.p2pRequester?s(t):o("[Registry checkP2PDataObject] Data Object found does not support P2P",e.body.value)}else o("[Registry checkP2PDataObject] not found",e.body.code)})}else o("[Registry checkP2PDataObject] no P2P Connection found")})}addRemoteP2PEntity(e,t){this._remoteP2PEntities[e]=t}removeRemoteP2PEntity(e){delete this._remoteP2PEntities[e]}reconnectP2PRequester(e){let t=this;return rt.log("[P2PConenctionResolve.reconnectP2PRequester] lets try to reconnect P2P Requester Stub: ",e),new Promise((r,s)=>{let o=e.runtime,n={type:"execute",from:t._registry.registryURL,to:e.url,body:{method:"connect",params:[e.p2pHandler]}};t._registry.watchingYou.observe("p2pRequesterStub",e=>{if(rt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequesterStubs changed "+t._registry.p2pRequesterStub),e.keypath.split(".")[0]===o&&"status"===e.name)switch(e.newValue){case"live":rt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequester is live "+t._registry.p2pRequesterStub[o]),r(t._registry.p2pRequesterStub[o].url);break;case"failed":rt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequester reconnect failed "+t._registry.p2pRequesterStub[o]),s("P2P Requester reconnect failed")}}),t._registry._messageBus.postMessage(n,e=>{rt.log("[P2PConenctionResolve.reconnectP2PRequester] reconnect request reply",e)})})}}(this);this._p2pConnectionResolve=a,this._hypertyUrls={},this._dataObjectUrls={}}loadRegistry(){let e=this;return new Promise(t=>{e.storageManager.get("registry:HypertyURLs").then(r=>{r&&(e._hypertyUrls=r),e.storageManager.get("registry:DataObjectURLs").then(r=>{r&&(e._dataObjectUrls=r),t()})})})}set loader(e){this._loader=e}get loader(){return this._loader}get messageBus(){return this._messageBus}set messageBus(e){let t=this;t._messageBus=e,t._messageBus.addListener(t.registryURL,function(e){let r,s,o,n,i;if(N(e.from),e.body.hasOwnProperty("criteria"),e.body.hasOwnProperty("resource")&&"."!==e.body.resource&&(r=H(e.body.resource),s=function(e){return"user"===x(e).type}(e.body.resource),o=N(e.body.resource)),e.type,e.body.hasOwnProperty("value")&&(n=e.body.value.hasOwnProperty("name"),i=e.body.value.hasOwnProperty("user")),"response"===e.type)return void ot.error("[Register listener] skipping ",e);let a=t._getIdentityAssociated(e.body.resource,e.body.criteria),c={id:e.id,type:"response",to:e.from,from:e.to,body:{resource:a}};c.body.code=a?200:404,t._messageBus.postMessage(c)});let r=et.instance;t.addressAllocation=r,t._domainRegistration=new class{constructor(e,t,r,s){if(!e)throw new Error("runtimeURL is missing.");if(!t)throw new Error("registryURL is missing.");if(!r)throw new Error("domain is missing.");if(!s)throw new Error("messageBus is missing.");this.registryURL=t,this.runtimeURL=e,this._registrationRetries=5,this.expiresTime=3600,this._domain=r,this._messageBus=s}unregisterHyperty(e){let t={type:"update",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:"/hyperty/"+e,value:"disconnected",attribute:"status"}};this._messageBus.postMessage(t,e=>{tt.log("[DomainRegistration] unregister hyperty Reply",e)})}unregisterDataObject(e){let t={type:"update",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:e,value:{status:"disconnected"}}};this._messageBus.postMessage(t,e=>{tt.log("[DomainRegistration] unregister dataObject Reply",e)})}deleteDataObjectInstance(e){let t={type:"delete",from:this.registryURL,to:"domain://registry."+this._domain,body:{value:{name:e}}};this._messageBus.postMessage(t,e=>{tt.log("[DomainRegistration] unregister dataObject Reply",e)})}updateHypertyInstance(e,t){let r={type:"UPDATE",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:e,value:t}};this._messageBus.post.postMessage(r,e=>{})}registerDataObject(e,t,r){let s,o,n=this;return new Promise(function(i,a){let c,u=[],l=e.url.split(":");u.push(l[0]),0!==Object.keys(r).length&&(s=r[n.runtimeURL].url,o=U.runtimeDescriptor.p2pRequesterStub),e.startingTime=e.created,delete e.authorise,delete e.created,delete e.mutual,delete e.resume,e.expires||(e.expires=n.expiresTime),e.dataSchemes=u,s&&(e.p2pHandler=s,e.p2pRequester=o),e.status="live",t?(tt.log("[Registry.registerDataObject] registering previously registered data object URL",e),c={type:"update",to:"domain://registry."+n._domain,from:n.registryURL,body:{resource:e.url,value:{status:"live"}}}):(tt.log("[Registry.registerDataObject] registering new data object URL",e),c={type:"create",from:n.registryURL,to:"domain://registry."+n._domain,body:{value:e,policy:"policy"}});try{n._messageBus.postMessageWithRetries(c,n._registrationRetries,t=>{200===t.body.code?i(e):a("error on register DataObject")})}catch(e){tt.error(e),a(e)}setInterval(function(){let t={type:"update",from:n.registryURL,to:"domain://registry."+n._domain,body:{resource:e.url,value:{status:"live"},method:"refresh"}};n._messageBus.postMessage(t,e=>{})},e.expires/1.1/2*1e3)})}registerHyperty(e,t){let r=this;return new Promise(function(s,o){let n,i=r.runtimeURL,a=r.expiresTime,c={user:e.user.email,descriptor:e.descriptorURL,url:e.hypertyURL,expires:a,resources:e.resources,dataSchemes:e.dataSchemes,runtime:i,status:"live"};e.p2pHandler&&(c.p2pHandler=e.p2pHandler,c.p2pRequester=e.p2pRequester),e.descriptor.configuration&&e.descriptor.configuration.expires&&(a=e.descriptor.configuration.expires),t?(n={type:"update",to:"domain://registry."+r._domain,from:r.registryURL,body:{resource:e.hypertyURL,value:{status:"live",user:e.user.email}}},e.p2pHandler&&(n.body.value.p2pHandler=e.p2pHandler,n.body.value.p2pRequester=e.p2pRequester)):n={type:"create",from:r.registryURL,to:"domain://registry."+r._domain,body:{value:c,policy:"policy"}};try{r._messageBus.postMessageWithRetries(n,r._registrationRetries,t=>{if(200===t.body.code){let t={url:e.hypertyURL};e.p2pHandler&&(t.p2pHandler=e.p2pHandler,t.p2pRequester=e.p2pRequester),s(t)}else{if(404!==t.body.code)throw new Error("Failed to register an Hyperty to domain: ",t);n={type:"create",from:r.registryURL,to:"domain://registry."+r._domain,body:{value:c,policy:"policy"}};try{r._messageBus.postMessageWithRetries(n,r._registrationRetries,t=>{if(200!==t.body.code)throw new Error("Failed to register an Hyperty: "+t);{let t={url:e.hypertyURL};e.p2pHandler&&(t.p2pHandler=e.p2pHandler,t.p2pRequester=e.p2pRequester),s(t)}})}catch(e){tt.error(e),o(e)}}})}catch(e){tt.error(e),o(e)}setInterval(function(){let t={type:"update",from:r.registryURL,to:"domain://registry."+r._domain,body:{resource:e.hypertyURL,value:{status:"live"},method:"refresh"}};r._messageBus.postMessage(t,e=>{})},a/1.1/2*1e3)})}}(t.runtimeURL,t.registryURL,t._domain,e)}_getIdentityAssociated(e,t){let r=this;for(let s in r.hypertiesList){let o=r.hypertiesList[s];if(o._hypertyURL===t)switch(e){case"username":return o._user.username;case"cn":return o._user.cn;case"locale":return o._user.locale;case"avatar":return o._user.avatar;case"userURL":return o._user.userURL;case".":return o._user;default:return""}}return""}getAppSandbox(){return this.appSandbox}getHypertyOwner(e){let t=this;for(let r in t.hypertiesList){let s=t.hypertiesList[r];if(s.hypertyURL===e)return s.user.userURL}}getDataObjectReporter(e){let t=this,r=D(e);for(let e in t.dataObjectList){let s=t.dataObjectList[e];if(s.url===r)return s.reporter}return null}getHypertyName(e){let t,r=this,s="hyperty"===x(e).type?e:r.getReporterURLSynchonous(e);for(let e in r.hypertiesList){let o=r.hypertiesList[e];if(o.hypertyURL===s){t=o.objectName;break}}return t}getReporterURL(e){let t=this;return new Promise(function(r,s){let o=t.dataObjectList[e];o?r(o.reporter):s("No reporter was found")})}getReporterURLSynchonous(e){let t=this.dataObjectList[e];return t?t.reporter:void 0}getDataObjectSubscriberHyperty(e){return this.subscribedDataObjectList[e]}registerSubscribedDataObject(e,t){void 0===this.subscribedDataObjectList[e]&&(this.subscribedDataObjectList[e]=t)}getPreAuthSubscribers(e){let t=this.dataObjectList[e],r=[];return t&&(r=t.authorise),r}unregisterAllHyperties(){let e=this,t=[];return new Promise(function(r,s){for(let r in e.hypertiesList){let s=e.hypertiesList[r],o=e.unregisterHypertyInstance(s.hypertyURL);t.push(o)}Promise.all(t).then(()=>{r("successfully unregistered all hyperties")},e=>{s(e)})})}unregisterHypertyInstance(e){let t=this,r={type:"execute",from:t.registryURL,to:e,body:{method:"close"}};t._messageBus.postMessage(r,r=>{ot.log("[Registry.unregisterHypertyInstance] Close Reply",r),t._domainRegistration.unregisterHyperty(e)})}unregisterDataObject(e){this._domainRegistration.unregisterDataObject(e)}registerSubscriber(e,t){let r=this.dataObjectList[e];r&&(r.subscribers||(r.subscribers=[]),r.subscribers.push(t),this.dataObjectList[e]=r)}getDataObjectSubscribers(e){let t=this.dataObjectList[e];if(t)return t.subscribers;throw"No dataObject was found"}registerDataObject(e){let t=this,r=I(e);return new Promise(function(s,o){t.dataObjectList[e.url]=e,t._dataObjectUrls[e.name+e.schema+e.resources+e.reporter]=e.url,t.storageManager.set("registry:DataObjectURLs",0,t._dataObjectUrls).then(()=>{t.isInterworkingProtoStub(r.reporter)&&(r.interworking=!0);let o=!0;r.hasOwnProperty("domain_registration")&&(o=r.domain_registration),o?t._domainRegistration.registerDataObject(r,e.resume,t.p2pHandlerStub).then(e=>{s(e)}):s(r)}).catch(function(e){ot.error("[Registry registerDataObject] Error: ",e),o(e)})})}_getResourcesAndSchemes(e){let t=this;return new Promise(r=>{let s;"string"==typeof e.hypertyType?(s=[]).push(e.hypertyType):s=e.hypertyType;let o=e.objectName,n=e.dataObjects,i=[];for(let e in n)i.push(t.getDataSchemaDescriptor(n[e]));Promise.all(i).then(function(e){let t=[];for(let r in e){let s=e[r];t.push(s.sourcePackage.sourceCode.properties.scheme)}r({resources:s,dataSchema:t,name:o})})})}getDataSchemaDescriptor(e,t=!0,r){return new Promise(t=>{let r=e.split("/dataschema/")[1];ot.log("[RuntimeCatalogue.getDataSchemaDescriptor] schema ",r);let s={sourcePackage:{sourceCode:{properties:{}}}};switch(r){case"Context":case"ContextReporter":case"ContextObserver":s.sourcePackage.sourceCode.properties.scheme="context";break;case"Connection":s.sourcePackage.sourceCode.properties.scheme="connection";break;case"WalletData":s.sourcePackage.sourceCode.properties.scheme="walletData";break;case"Communication":s.sourcePackage.sourceCode.properties.scheme="comm",s.sourcePackage.sourceCode.properties.childrens=["resources"];break;case"HelloWorldDataSchema":s.sourcePackage.sourceCode.properties.scheme="hello";break;default:s.sourcePackage.sourceCode.properties.scheme="resource",s.sourcePackage.sourceCode.properties.childrens=[]}t(s)})}checkRegisteredURLs(e,t){let r=this;return new Promise(s=>{let o=e.reporter?"registry:DataObjectURLs":"registry:HypertyURLs";"string"==typeof t&&(o=t&&"hyperty"!==x(t).type?"registry:DataObjectURLs":"registry:HypertyURLs"),r.storageManager.get(o).then(n=>{if(n||(n={}),"string"==typeof t){ot.info("[Registry - checkRegisteredURLs] - look for "+t+" on ",n);let e=Object.keys(n).map(e=>{let r=n[e].indexOf(t);return n[e][r]});return ot.info("[Registry - checkRegisteredURLs] - found "+e.length+" results on ",e),1===e.length?s(e):s(void 0)}if("registry:HypertyURLs"!==o){let t=e.name+e.schema+e.resources+e.reporter;if(n[t]){if("string"==typeof n[t]){let e=[];return e.push(n[t]),s(e)}return s(n[t])}return s(void 0)}r._getResourcesAndSchemes(e).then(e=>n[e.resources+e.dataSchema+e.name]?s(n[e.resources+e.dataSchema+e.name]):s(void 0))})})}registerHyperty(e,t,r,s,o){let n,i=this;return new Promise(function(a,c){i.idModule.getIdentityAssertion(o).then(function(o){let u=o.userProfile;void 0===i._messageBus?c("[Registry registerHyperty] MessageBus is undefined"):i._getResourcesAndSchemes(r).then(o=>{n=o,i._hypertyUrls[n.resources+n.dataSchema+n.name]=s.address,i.storageManager.set("registry:HypertyURLs",0,i._hypertyUrls).then(()=>{let o,l;"app"===e.type?i.sandboxesList.appSandbox[s.address[0]]=e:"normal"===e.type?i.sandboxesList.sandbox[s.address[0]]=e:c("Wrong SandboxType"),0!==Object.keys(i.p2pHandlerStub).length&&(o=i.p2pHandlerStub[i.runtimeURL].url,l=U.runtimeDescriptor.p2pRequesterStub);let d=new class extends class{constructor(e,t,r,s,o,n,i,a,c){this._id=e,this._url=t,this._descriptorURL=r,this._startingTime=o,this._lastModified=n,this._status=i,this._stubs=a,this._stubsConfiguration=c,this._p2pRequester=s}get id(){return this._id}get url(){return this._url}get descriptorURL(){return this._descriptorURL}get p2pRequester(){return this._p2pRequester}get lastModified(){return this._lastModified}}{constructor(e,t,r,s,o,n,i,a,c,u,l,d,h,y,p){super(e,t,r,l,y,p),this._descriptor=s,this._hypertyURL=o,this._user=n,this._guid=i,this._runtime=a,this._context=c,this._p2pHandler=u,this._dataSchemes=d,this._resources=h}set user(e){this.user=e}get user(){return this._user}get hypertyURL(){return this._hypertyURL}get descriptor(){return this._descriptor}get objectName(){return this._descriptor._objectName}get p2pHandler(){return this._p2pHandler}get dataSchemes(){return this._dataSchemes}get resources(){return this._resources}get runtimeURL(){return this._runtime}}(i.identifier,i.registryURL,t,r,s.address[0],u,"guid",i.runtimeURL,"ctx",o,l,n.dataSchema,n.resources);i.hypertiesList.push(d);let h=!0;r.hasOwnProperty("configuration")&&r.configuration.hasOwnProperty("domain_registration")&&(h=r.configuration.domain_registration),h?i._domainRegistration.registerHyperty(d,s.newAddress).then(e=>{a(e)}):a({url:d.hypertyURL})}).catch(function(e){c(e)})})},function(e){c("[Registry registerHyperty] ",e)})})}unregisterHyperty(e){let t=this;return new Promise(function(r,s){let o=!1,n=0;for(n=0;n<t.hypertiesList.length;n++){let r=t.hypertiesList[n];if(void 0!==r&&r.hypertyURL===e){o=!0;break}}!1===o?s("Hyperty not found"):(delete t.hypertiesList[n],r("Hyperty successfully deleted"))})}discoverProtostub(e){if(!e)throw new Error("Parameter url needed");let t=this,r=x(e).domain;if(t.protostubsList.hasOwnProperty(r)&&t.protostubsList[r].status===it)return t.protostubsList[r];throw t.protostubsList[r]={status:at},new Error("[Registry - discoverProtoStub ] Message Node Protostub Not Found. Creating one")}discoverP2PStub(e){let t=this;if(e){if(t.p2pRequesterStub.hasOwnProperty(e)&&t.p2pRequesterStub[e].status===it)return t.p2pRequesterStub[e];throw t.p2pRequesterStub[e]={status:nt},new Error("[Registry - discoverP2PStub ] P2P Requester Stub Not Found. Creating one")}if(t.p2pHandlerStub.hasOwnProperty(t.runtimeURL))return t.p2pHandlerStub[t.runtimeURL];throw t.p2pHandlerStub[t.runtimeURL]={status:nt},new Error("[Registry - discoverP2PStub ] P2P Handler Stub Not Found.")}registerStub(e,t,r,s,o){let n=this,i=o;return new Promise(function(a,c){let u,l;if(void 0===n._messageBus&&c("MessageBus not found on registerStub"),ot.info("[Registry - registerStub] - stubID ",t),r)if(r.hasOwnProperty("isHandlerStub")&&r.isHandlerStub)u=n.p2pHandlerURL,n.p2pHandlerStub[t]={url:u,status:nt},n.p2pHandlerAssociation[n.runtimeURL]=[],n.sandboxesList.sandbox[u]=e,ot.info("[Registry - registerStub - P2PHandlerStub] - ",t," - ",u),a(n.p2pHandlerStub[t]);else{l=r.p2pRequesterStub,u="runtime://"+x(r.remoteRuntimeURL).domain+"/p2prequester/"+K(),ot.info("[Registry - registerStub - P2PRequesterStub] - ",l," - ",u),n.p2pHandlerAssociation[n.runtimeURL].push(u),n.p2pRequesterStub[t]={url:u,status:nt},n.sandboxesList.sandbox[u]=e;let s={type:"subscribe",from:n.registryURL,to:"domain://msg-node."+n._domain+"/sm",body:{subscribe:[u],source:n.registryURL}};n._messageBus.postMessage(s,e=>{}),a(n.p2pRequesterStub[t])}else console.log("[Registry - registerStub - Normal Stub] descriptor",o),u="runtime://"+t+"/protostub/"+K(),ot.info("[Registry - registerStub - Normal Stub] - ",t),n.protostubsList[t]={url:u,status:at},s&&(n.protostubsList[t].descriptorURL=s),i&&i.interworking&&(n.protostubsList[t].interworking=i.interworking),n.sandboxesList.sandbox[u]=e,a(n.protostubsList[t]);n._messageBus.addListener(u+"/status",e=>{n._onProtostubStatusEvent(e)})})}_onProtostubStatusEvent(e){let t=this,r=e.from;if(e.to.includes("/status")){{let r=e.from;e.from=t.runtimeURL,e.to=t.runtimeURL+"/status",e.body.resource=r,t._messageBus.postMessage(e)}if(r.includes("/protostub/"))Object.keys(t.protostubsList).filter(e=>t.protostubsList[e].url===r).map(r=>{t.protostubsList[r].status=e.body.value});else if(e.body.resource){let s=e.body.resource;if(t.p2pConnectionList[s])t.p2pConnectionList[s].status=e.body.value,t.p2pConnectionList[s].url=r;else{let o={status:e.body.value,url:r};t.p2pConnectionList[s]=o}r.includes("/p2prequester/")?t.p2pRequesterStub[s].status=e.body.value:"disconnected"===e.body.value&&delete t.p2pConnectionList[s]}else{if(r.includes("/p2prequester/"))return void ot.error("[Registry onProtostubStatusEvent] resource missing: ",e);t.p2pHandlerStub[t.runtimeURL].status=e.body.value}}else ot.error("[Registry onProtostubStatusEvent] Not Status Event: ",e)}unregisterStub(e){let t=this;return new Promise(function(r,s){t.protostubsList.hasOwnProperty(e)?(delete t.protostubsList[e],r("ProtostubURL removed")):s("Error on unregisterStub: Hyperty not found")})}registerIdpProxy(e,t){let r=this;return new Promise(function(s,o){let n;void 0===r._messageBus&&o("MessageBus not found on registerStub"),n="domain-idp://"+t+"/stub/"+K(),r.idpProxyList[t]={url:n,status:at},r.sandboxesList.sandbox[n]=e,s(n),r._messageBus.addListener(n+"/status",e=>{r._onIdpProxyStatusEvent(e)})})}_onIdpProxyStatusEvent(e){let t=this,r=e.from;e.to.includes("/status")?Object.keys(t.idpProxyList).filter(e=>t.idpProxyList[e].url===r).map(r=>{t.idpProxyList[r].status=e.body.value}):ot.error("[Registry onIdpProxyStatusEvent] Not Status Event: ",e)}discoverIdpProxy(e){if(!e)throw new Error("Parameter url needed");let t=this,r=x(e).domain;if(t.idpProxyList.hasOwnProperty(r)&&t.idpProxyList[r].status===it)return t.idpProxyList[r];throw t.idpProxyList[r]={status:ut},new Error("[Registry - discoverIdpProxy ] Idp Proxy Not Found. Creating one")}registerPEP(e,t){let r=this;return new Promise(function(s){r.pepList[t]=e,s("PEP registered with success")})}unregisterPEP(e){let t=this;return new Promise(function(r,s){void 0===t.pepList[e]?s("Pep Not found."):r("PEP successfully removed.")})}getSandbox(e,t){if(!e)throw new Error("Parameter url needed");let r=this;return new Promise(function(s,o){let n;if(!(n=r.sandboxesList.appSandbox[e])&&!(n=r.sandboxesList.sandbox[e])){let s;s=e.includes("://")?x(e).domain:e;for(let e in r.sandboxesList.sandbox)if(e.includes(s)&&r.sandboxesList.sandbox[e].matches(t)){const s=r.sandboxesList.sandbox[e];Object.keys(t).filter(e=>"browser"===e&&s.type===Qe||"windowSanbox"===e&&s.type===Xe).length>0&&(n=s);break}}n?s(n):o("no sandbox found for: "+e)})}resolveNormalStub(e){let t=this;return new Promise((r,s)=>{let o=x(e),n=o.domain,i=o.type;if(e.includes(t.runtimeURL)||e.includes("://sandbox/"))return ot.error("[Registry - resolve] URL to be resolved should have listeners ",e),s("[Registry - resolve] URL to be resolved should have listeners ",e);e.includes("global://registry")?n=t._domain:n.indexOf("msg-node.")&&n.indexOf("registry.")||(n=n.substring(n.indexOf(".")+1)),t.isLegacy(e).then(o=>{let a;o&&"domain-idp"!==i&&(n=i+"."+function(e){let t=x(e).domain.split("."),r=t.length;return 1==r?t[r-1]:t[r-2]+"."+t[r-1]}(e)),ot.info("[Registry.resolve] domainUrl:",n),a="domain-idp"===i?!!t.idpProxyList.hasOwnProperty(n)&&t.idpProxyList[n]:!!t.protostubsList.hasOwnProperty(n)&&t.protostubsList[n],ot.info("[Registry.resolve] registred:",a),a&&a.hasOwnProperty("status")&&(a.status===ct||a.status===nt||a.status===it||a.status===lt)?(ot.info("[Registry.resolve] Resolved: ",a.url,a.status),r(a.url)):"domain-idp"===i?(t.watchingYou.observe("idpProxyList",e=>{let s=e.keypath;s.includes("status")&&(s=s.replace(".status","")),s===n&&"status"===e.name&&e.newValue===nt&&r(t.idpProxyList[n].url)}),a&&a.status!==dt||(ot.info("[Registry.resolveNormalStub] deploy new IDPProxy: ",n),t.loader.loadIdpProxy(n).then(()=>{ot.info("[Registry.resolveNormalStub] IdP Proxy deployed: ",t.idpProxyList[n])}).catch(e=>{ot.error("[Registry.resolve] Error resolving Load IDPProxy: ",e),t.idpProxyList[n].status="deployment-failed",s(e)}))):(t.watchingYou.observe("protostubsList",e=>{let s=e.keypath;s.includes("status")&&(s=s.replace(".status","")),s===n&&"status"===e.name&&e.newValue===nt&&r(t.protostubsList[n].url)}),a&&a.status!==dt||(ot.info("[Registry.resolve] trigger new ProtocolStub: ",n),t.loader.loadStub(n).then(()=>{}).catch(e=>{ot.error("[Registry.resolveNormalStub] Error resolving Load ProtocolStub: ",e),s(e)})))}).catch(e=>{ot.error("[Registry.resolve] Error resolving islegacy: ",e),s(e)})})}resolve(e){ot.info("[Registry - Resolve] -  ",e);let t=this;return new Promise((r,s)=>{let o=e.to?e.to:e,n=!(!e.body||!e.body.p2p)&&e.body.p2p;!t.p2pHandlerStub[t.runtimeURL]||G(o)||o.includes(t.runtimeURL)||o.includes("/p2phandler/")||o.includes("/p2prequester/")?(ot.info("[Registry - resolve] - Resolve normal stub: ",t.p2pHandlerStub,t.runtimeURL,G(o),n,o),t.resolveNormalStub(o).then(e=>{r(e)})):(ot.info("[Registry - resolve] - checkP2P: ",n,o,t._p2pConnectionResolve),t._p2pConnectionResolve.checkP2P(e).then(s=>{let i=t.p2pConnectionList[s.runtime];switch(i||(i=s,t.p2pConnectionList[s.runtime]=i),i.status){case it:e.body.peer=s.runtime,r(i.url,e);break;case nt:case ut:t.resolveNormalStub(o).then(e=>{r(e)});break;case lt:ot.info("[Registry - Resolve] - p2pConnection is disconnected lets try to reconnect"),t._p2pConnectionResolve.reconnectP2PRequester(i).then(e=>{r(e)},e=>{ot.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(e=>{r(e)})});break;default:ot.info("[Registry - resolve] - P2P: ",n),n?t._setupP2PRequester(s).then(e=>{r(e)},e=>{ot.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(e=>{r(e)})}):t.resolveNormalStub(o).then(e=>{r(e)})}},e=>{ot.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(e=>{r(e)})}))})}_setupP2PRequester(e){let t=this;return ot.log("[Registry._setupP2PConnection] loadStub with p2pRequester: ",e),new Promise((r,s)=>{let o=e.runtime,n={remoteRuntimeURL:o,p2pHandler:e.p2pHandler,p2pRequesterStub:!0};t.watchingYou.observe("p2pRequesterStub",e=>{ot.log("[Registry._setupP2PConnection] p2pRequesterStubs changed "+t.p2pRequesterStub),e.keypath.split(".")[0]===o&&"status"===e.name&&e.newValue===it&&(ot.log("[Registry._setupP2PConnection] p2pRequester is live "+t.p2pRequesterStub[o]),r(t.p2pRequesterStub[o].url))}),t.loader.loadStub(e.p2pRequester,n).then(()=>{ot.log("[Registry._setupP2PConnection] p2pRequester deployed: ",t.p2pRequesterStub[o])}).catch(e=>{s(e)})})}isLegacy(e){let t=this;return new Promise((r,s)=>{if(e===t._domain)return r(!1);ot.log("[Registry] [Registry.Registry.isLegacy] ",e);let o=x(e);if(-1!==["hyperty-runtime","domain","global","hyperty"].indexOf(o.type)||o.domain===t._domain)return r(!1);if(e.split("@").length>1){let e=o.domain;if(t.idpLegacyProxyList.hasOwnProperty(e)){let s=t.idpLegacyProxyList[e];return s.interworking?r(s.interworking):r(!1)}t._loader.descriptors.getIdpProxyDescriptor(e).then(s=>{s.interworking?(t.idpLegacyProxyList[e]=s,r(s.interworking)):r(!1)}).catch(t=>{ot.warn("problem loading idp proxy descriptor for domain:",e," because ",t),s(t)})}else r(t.isInterworkingProtoStub(e))})}isLocal(e){let t=e.split("://")[0];if(-1!==["hyperty-runtime","runtime"].indexOf(t))return e.includes(this.runtimeURL);if(-1!==["hyperty"].indexOf(t)){for(let t in this.hypertiesList)if(this.hypertiesList[t].hypertyURL===e)return!0;return!1}e.includes("/subscription")&&(e=e.substring(0,e.indexOf("/subscription")));let r=this.dataObjectList[e];return!(!r||r.interworking&&r.interworking)}isInterworkingProtoStub(e){let t=this;return"boolean"!=typeof e&&!!e.includes("/protostub/")&&Object.keys(t.protostubsList).filter(r=>t.protostubsList[r].url===e).map(e=>!!t.protostubsList[e].hasOwnProperty("interworking")&&t.protostubsList[e].interworking)[0]}}(this.runtimeURL,s,this.identityModule,this.runtimeCapabilities,this.storages.registry,this.p2pHandlerURL),this.registry.loader=this.loader,this.messageBus=new class extends class{constructor(){this._msgId=0,this._subscriptions={},this._responseTimeOut=15e3,this._responseCallbacks={},this._registerExternalListener()}addListener(e,t){let r=this,s=new ze(r._subscriptions,e,t),o=r._subscriptions[e];return o||(o=[],r._subscriptions[e]=o),o.push(s),s}addResponseListener(e,t,r){this._responseCallbacks[e+t]=r}removeResponseListener(e,t){delete this._responseCallbacks[e+t]}removeAllListenersOf(e){delete this._subscriptions[e]}bind(e,t,r){let s=this;return{thisListener:s.addListener(e,e=>{r.postMessage(e)}),targetListener:r.addListener(t,e=>{s.postMessage(e)}),unbind:()=>{this.thisListener.remove(),this.targetListener.remove()}}}_publishOnDefault(e){let t=this._subscriptions["*"];t&&this._publishOn(t,e)}_publishOn(e,t){e.forEach(e=>{e._callback(t)})}_responseCallback(e,t,r=!0){let s=this;if(t){let o=e.from+e.id;s._responseCallbacks[o]=t,r&&setTimeout(()=>{let t=s._responseCallbacks[o];delete s._responseCallbacks[o],t&&t({id:e.id,type:"response",body:{code:408,desc:"Response timeout!",value:e}})},s._responseTimeOut)}}_onResponse(e){let t=this;if("response"===e.type){let r=e.to+e.id,s=t._responseCallbacks[r];if(e.body.code>=200&&delete t._responseCallbacks[r],s)return s(e),!0}return!1}_onMessage(e){let t=this;if(!t._onResponse(e)){let r=t._subscriptions[e.to];r?t._publishOn(r,e):t._publishOnDefault(e)}}_genId(e){e.id&&0!==e.id||(this._msgId++,e.id=this._msgId)}postMessage(e,t){}postMessageWithRetries(e,t,r){let s=this,o=0,n=()=>{new Promise((t,o)=>{s.postMessage(e,s=>{408===s.body.code||500===s.body.code?o():(Ye.info("[Bus.postMessageWithRetries] msg delivered: ",e),r(s),t())})}).then(()=>{},()=>{if(Ye.warn(`[Bus.postMessageWithRetries] Message Bounced (retry ${o}): '`,e),!(o++<t))throw new Error(`[Error] Message Bounced (delivery attempts ${t}): '`+e);n()})};n()}_onPostMessage(e){}_registerExternalListener(){}}{constructor(e,t){super(),this._registry=e,this._forwards={},this._runtimeUrl=t,this._pipelineIn=new Ct(e=>{kt.error("PIPELINE-ERROR: ",JSON.stringify(e))}),this._pipelineOut=new Ct(e=>{kt.error("PIPELINE-ERROR: ",JSON.stringify(e))})}get pipelineIn(){return this._pipelineIn}get pipelineOut(){return this._pipelineOut}postMessage(e,t,r){kt.info("onPOSTMessage: ",e);let s=this,o=o=>{if(s._responseCallback(e,t,r),!s._onResponse(o)){let e=s._subscriptions[o.to];e?s._publishOn(e,o):o.to.includes(s._runtimeUrl)||s._onPostMessage(o)}};return s._genId(e),s._isToProcess(e)?s._isIncomingMessage(e)?s._pipelineIn.process(e,o):s._pipelineOut.process(e,o):o(e),e.id}_isToProcess(e){let t=["domain","domain-idp","global","hyperty-runtime","runtime"],r=e.from.split("://")[0],s=e.to.split("://")[0],o=e.from,n=e.to;return e.body&&e.body.source&&(o=e.body.source),e.body&&e.body.subscriber&&(o=e.body.subscriber),!(-1!==o.indexOf("/p2phandler/")||-1!==o.indexOf("/p2prequester/")||-1!==n.indexOf("/p2phandler/")||-1!==n.indexOf("/p2prequester/")||this._registry.isLocal(o)&&this._registry.isLocal(e.to)||e.from===r||e.to===s||"read"===e.type||"response"===e.type||e.from.includes("hyperty://")&&"delete"===e.type||-1!==t.indexOf(r)&&-1!==t.indexOf(s))}_isIncomingMessage(e){let t;return"forward"===e.type?(kt.info("[MessageBus - isIncomingMessage] - message.type: ",e.type),t=e.body.from):e.hasOwnProperty("body")&&e.body.hasOwnProperty("source")&&e.body.source?(kt.info("[MessageBus - isIncomingMessage] - message.body.source: ",e.body.source),t=e.body.source):e.hasOwnProperty("body")&&e.body.hasOwnProperty("subscriber")&&e.body.subscriber?(kt.info("[MessageBus - isIncomingMessage] - message.body.subscriber: ",e.body.subscriber),t=e.body.subscriber):e.hasOwnProperty("body")&&e.body.hasOwnProperty("reporter")&&e.body.reporter?(kt.info("[MessageBus - isIncomingMessage] - message.body.reporter: ",e.body.reporter),t=e.body.reporter):(kt.info("[MessageBus - isIncomingMessage] - message.from ",e.from),t=e.from),kt.info("[MessageBus - isIncomingMessage] - check if isLocal: ",t),!this._registry.isLocal(t)}addPublish(e){let t=this,r=t._forwards[e];return r||(r={counter:0,fl:t.addListener(e,r=>{kt.info("MB-PUBLISH: ( "+e+" )"),r.body&&r.body.source&&r.body.source.includes("/protostub/")||r.to.includes(t._runtimeUrl)||t._onPostMessage(r)}),remove:()=>{this.counter--,0===this.counter&&(this.fl.remove(),delete t._forwards[e])}},t._forwards[e]=r),r.counter++,r}addForward(e,t){let r=this;return r.addListener(e,s=>{kt.info("MB-FORWARD: ( "+e+" to "+t+" )"),r.forward(t,s)})}forward(e,t){let r=this._subscriptions[e];r&&this._publishOn(r,t)}_onPostMessage(e){let t=this;t._registry.resolve(e).then((r,s)=>{s?t.forward(r,s):t.forward(r,e)}).catch(function(e){kt.error("RESOLVE-ERROR: ",e)})}}(this.registry,this.runtimeURL),this.subscriptionManager=new class{constructor(e,t,r){if(!e)throw new Error("[SubscriptionManager] - needs the runtimeURL parameter");if(!t)throw new Error("[SubscriptionManager] - needs the MessageBus instance");let s=this;s._bus=t,s._storage=r,s._subscriptions={},s._subscriptionsStorage={},s.runtimeURL=e,s._url=e+"/subscriptions",s._domain=x(e).domain,t.addListener(s._url,e=>{switch(Xt.info("[SubscriptionManager] RCV: ",e),e.type){case"subscribe":s._onSubscribe(e);break;case"unsubscribe":s._onUnSubscribe(e);break;case"read":s._onRead(e)}})}init(){let e=this;return new Promise(t=>{e._storage.get("subscriptions").then(r=>{Xt.log("[SubscriptionManager.init] resume subscriptions: ",r),r&&(e._subscriptionsStorage=r,Object.values(r).forEach(t=>{e.createSubscription(t.domain,t.resources,t.subscriber,t.identity)})),t()})})}get url(){return this._url}_onSubscribe(e){let t=this,r=e.body.resources,s=e.from,o=x(r[0]).domain,n=e.body.identity;t.createSubscription(o,r,s,n).then(i=>{i.id=e.id,i.from=t._url,i.to=s,i.body=e.body,i.body.code=200,Xt.log("[SubscriptionManager] - craeteSubscription: ",e,i,s),t._bus.postMessage(i),t._subscriptionsStorage[s]?r.forEach(e=>{t._subscriptionsStorage[s].resources.includes(e)||t._subscriptionsStorage[s].resources.push(e)}):t._subscriptionsStorage[s]={domain:o,resources:r,subscriber:s,identity:n},t._storage.set("subscriptions",1,t._subscriptionsStorage)})}createSubscription(e,t,r,s){let o=this;return new Promise(n=>{let i={type:"subscribe",from:o._url,to:"domain://msg-node."+e+"/sm",body:{identity:s,resources:t,source:r}};o._bus.postMessage(i,e=>{Xt.log("[SubscriptionManager] node-subscribe-response: ",e);let s=o._subscriptions[r];Xt.log("[SubscriptionManager] - ",o._subscriptions,t,o._subscriptions.hasOwnProperty(r)),s||(o._subscriptions[r]={}),t.forEach(e=>{o._subscriptions[r][e]=new class{constructor(e,t,r){this._subscriber=t,this.resource=r,Qt.log("[SubscriptionManager.Subscription] new: ",t,r),this._listener=e.addForward(r,t)}_releaseListeners(){this._listener.remove()}}(o._bus,r,e)}),n(e)})})}_onUnSubscribe(e){let t=this,r=e.from,s=e.body.resource;if(t._subscriptions[r]&&t._subscriptions[r][s]){let e=x(s).domain,o=t._subscriptions[r][s];if(t._bus.postMessage({type:"unsubscribe",from:t._url,to:"domain://msg-node."+e+"/sm",body:{resources:[s],source:r}}),o._releaseListeners(),delete t._subscriptions[r][s],t._subscriptionsStorage[r]){let e=t._subscriptionsStorage[r].resources.indexOf(s);-1!=e&&t._subscriptionsStorage[r].resources.splice(e,1),t._storage.set("subscriptions",1,t._subscriptionsStorage)}}t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}})}_onRead(e){let t,r=this,s=e.body.resource;Xt.log("[SubscriptionManager] - request to read Subscriptions: ",e),r._storage.get("subscriptions").then(o=>{if(o&&o[s]){let r=o[s].resources;t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:r}}}else t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,description:"Not Found"}};r._bus.postMessage(t)})}}(this.runtimeURL,this.messageBus,this.storages.subscriptions),this.addressAllocation=new et(this.runtimeURL,this.messageBus,this.registry,this.subscriptionManager),this.policyEngine=new class{constructor(e){this.pdp=new class{constructor(e){this.context=e,this.operators=new vt}evaluatePolicies(e,t){let r=this.context.getPolicies(e,t),s="Not Applicable";if(void 0!==r&&((s=this.evaluatePolicy(e,r.serviceProviderPolicy,t))||"Not Applicable"===s)){let o=this.evaluatePolicy(e,r.userPolicy,t);"Not Applicable"!==o&&(s=o)}return s}evaluatePolicy(e,t,r){let s="Not Applicable";return t&&(s=t.evaluateRules(this.context,e,r)),s}}(e),this.actionsService=new class{constructor(e){this.context=e}enforcePolicies(e,t){let r=this;return new Promise((s,o)=>{let n=r.context.getPolicies(e,t);void 0!==n?void 0!==n.serviceProviderPolicy?n.serviceProviderPolicy.enforceActions(r.context,e).then(e=>{s(e)},e=>{o(e)}):void 0!==n.userPolicy?n.userPolicy.enforceActions(r.context,e).then(e=>{s(e)},e=>{o(e)}):s([e]):s([e])})}forwardToID(e,t){let r=this;if(!r.context.runtimeRegistry)throw new Error("forward message to given ID is unsupported in this environment");return new Promise((s,o)=>{r.context.runtimeRegistry.hypertiesList[0].hypertyURL===e.to&&"runtime"!==e.to.split("://")[0]?r.context.runtimeRegistry.discoverHypertyPerUser(t).then(t=>{e.to=t.hypertyURL,e.body.via=void 0,s(e),r.context.runtimeRegistry._messageBus.postMessage(e)},e=>{o(e)}):s(e)})}forwardToHyperty(e,t){let r=this;if(!r.context.runtimeRegistry)throw new Error("forward message to given ID is unsupported in this environment");return new Promise(s=>{r.context.runtimeRegistry.hypertiesList[0].hypertyURL===e.to&&"runtime"!==e.to.split("://")[0]?(e.to=t,e.body.via=void 0,s(e),r.context.runtimeRegistry._messageBus.postMessage(e)):s(e)})}sendAutomaticMessage(e,t){let r=this;return new Promise(s=>{let o={from:e.to,to:e.from,body:{value:t},type:e.type};s(e),r.context.runtimeRegistry._messageBus.postMessage(o)})}}(e),this.context=e,e.pep=this,e.loadConfigurations()}get messageBus(){return this.context.messageBus}set messageBus(e){this.context.messageBus=e,this.addGUIListeners()}addGUIListeners(){let e=this;e.context.messageBus.addListener(e.context.pepURL,t=>{let r,s=t.body.method;if("addToGroup"===s){let s=t.body.params.groupName,o=t.body.params.userEmail;r=e.context.addToGroup(s,o)}else if("createGroup"===s){let s=t.body.params.groupName;r=e.context.createGroup(s)}else if("addPolicy"===s){let s=t.body.params.source,o=t.body.params.key,n=t.body.params.policy,i=t.body.params.combiningAlgorithm;r=e.addPolicy(s,o,n,i)}else if("deleteGroup"===s){let s=t.body.params.groupName;r=e.context.deleteGroup(s)}else if("removePolicy"===s){let s=t.body.params.source,o=t.body.params.key;r=e.removePolicy(s,o)}else if("savePolicies"===s){let s=t.body.params.source;r=e.context.savePolicies(s)}else if("userPolicies"===s)r=e.context.userPolicies;else if("activeUserPolicy"===s){let s=t.body.params.userPolicy;s&&(e.context.activeUserPolicy=s),r=e.context.activeUserPolicy}else if("userPolicy"===s){let s=t.body.params.key;r=e.context.userPolicies[s]}else"saveActivePolicy"===s?r=e.context.saveActivePolicy():"getMyEmails"===s?r=e.context.getMyEmails():"getMyHyperties"===s?r=e.context.getMyHyperties():"groups"===s?r=e.context.groups:"getGroupsNames"===s&&(r=e.context.getGroupsNames());if("removeFromGroup"===s){let s=t.body.params.groupName,o=t.body.params.userEmail;r=e.context.removeFromGroup(s,o)}let o={type:"execute",value:r,code:200},n={id:t.id,type:"response",to:t.from,from:t.to,body:o};e.context.messageBus.postMessage(n)})}addPolicy(e,t,r,s){if(!e)throw new Error("source is not defined");if(!t)throw new Error("key is not defined");switch(void 0===r?r=new jt(t,[],[],s):r instanceof jt||(r=new jt(r.key,r.rules,r.actions,r.combiningAlgorithm)),e){case"SERVICE_PROVIDER":this.context.savePolicies(e,r,t);break;case"USER":this.context.userPolicies[t]=r,this.context.savePolicies(e);break;default:throw Error("Unknown policy source: "+e)}}authorise(e,t){if(!e)throw new Error("message is not defined");if(!e.from)throw new Error("message.from is not defined");if(!e.to)throw new Error("message.to is not defined");if(!e.type)throw new Error("message.type is not defined");return e.body=e.body||{},new Promise((r,s)=>{e.body=e.body||{};let o=this,n=o.pdp.evaluatePolicies(e,t);"Not Applicable"===n&&(n=o.context.defaultBehaviour,e.body.auth=!1),o.actionsService.enforcePolicies(e,t).then(t=>{for(let o in t)if(e=t[o],n)e.body.auth=void 0===e.body.auth||e.body.auth,r(e);else{let t={body:{code:403,description:"Blocked by policy"},from:e.to,to:e.from,type:"response"};s(t)}},e=>{s(e)})})}authoriseSync(e){let t;return e.body=e.body||{},"Not Applicable"===(t=this.pdp.evaluatePolicies(e,!0))&&(t=this.context.defaultBehaviour),t}removePolicy(e,t){if(!e)throw new Error("source is not defined");if("*"!==e&&!t)throw new Error("key is not defined");switch(e){case"*":this.context.serviceProviderPolicy={},this.context.userPolicies={},this.context.activeUserPolicy=void 0,this.context.savePolicies("USER"),this.context.savePolicies("SERVICE_PROVIDER"),this.context.saveActivePolicy();break;case"SERVICE_PROVIDER":delete this.context.serviceProviderPolicy[t],this.context.savePolicies();break;case"USER":delete this.context.userPolicies[t],t===this.context.activeUserPolicy&&(this.context.activeUserPolicy=void 0,this.context.saveActivePolicy()),this.context.savePolicies("USER");break;default:throw Error("Unknown policy source: "+e)}}}(new class extends class{constructor(){this.defaultBehaviour=!0,this.groups={}}get scheme(){return this._scheme}get date(){return this._date}get domain(){return this._domain}get type(){return this._type}get source(){return this._source}get time(){return this._time}get weekday(){return this._weekday}set scheme(e){let t=e.message.from;E(t)?this._scheme=x(t).type:this._scheme=void 0}set date(e){let t=new Date,r=String(t.getDate());1===r.length&&(r="0"+r);let s=String(t.getMonth()+1);1===s.length&&(s="0"+s),this._date=r+"/"+s+"/"+t.getFullYear()}set domain(e){void 0!==e.message.body.identity&&(this._domain=function(e){let t=e.indexOf("@");return{username:e.substring(0,t),domain:e.substring(t+1,e.length)}}(e.message.body.identity.userProfile.username).domain)}set type(e){let t=e.message;void 0!==t.body.value&&(this._type=t.body.value.resourceType)}set source(e){void 0!==e.message.body.identity&&(this._source=e.message.body.identity.userProfile.username)}set time(e){e=new Date;let t=String(e.getMinutes());1===t.length&&(t="0"+t),this._time=parseInt(String(e.getHours())+t)}set weekday(e){this._weekday=String((new Date).getDay())}}{constructor(e,t,r,s,o){super(),this._runtimeURL=e,this._pepURL=this._runtimeURL+"/pep",this._guiURL=this._runtimeURL+"/policy-gui",this.idModule=t,this.runtimeRegistry=r,this.activeUserPolicy=void 0,this.serviceProviderPolicy={},this.userPolicies={},this.storageManager=s,this.runtimeCapabilities=o}get pepURL(){return this._pepURL}get guiURL(){return this._guiURL}get runtimeURL(){return this._runtimeURL}get messageBus(){return this._messageBus}set messageBus(e){this._messageBus=e}get subscription(){return this._subscription}set subscription(e){this._subscription=e.message.body.subscriber}loadConfigurations(){let e=this;return new Promise((t,r)=>{console.log(e.storageManager),e.storageManager.get("rethink:activePolicy").then(t=>(e.activeUserPolicy=t,e.storageManager.get("rethink:groups"))).then(t=>{let r=t;return e.groups=void 0===r?{}:r,e.storageManager.get("rethink:spPolicies")}).then(r=>{let s=r;e.serviceProviderPolicy=void 0===s?{}:s,e._loadUserPolicies().then(()=>{t()})})})}getPolicies(e,t){let r={};return void 0!==this.activeUserPolicy&&(r.userPolicy=this.userPolicies[this.activeUserPolicy]),r.serviceProviderPolicy=this.getServiceProviderPolicy(e,t),r}_isValidUpdate(e){let t=this;return new Promise((r,s)=>{e.from.split("://").length>1?t.idModule._getHypertyFromDataObject(e.from).then(t=>{t===e.body.source?r(e):s("The source of the message is not valid.")},e=>{s(e)}):r(e)})}getMyEmails(){let e=this.idModule.getIdentities(),t=[];for(let r in e)t.push(A(e[r].identity));return t}getMyHyperties(){let e=this.runtimeRegistry.hypertiesList,t=[];for(let r in e){let s=e[r].objectName;-1===t.indexOf(s)&&t.push(s)}return t}getServiceProviderPolicy(e,t){let r;if(t){let t=this.runtimeRegistry.getHypertyName(e.to);r=this.serviceProviderPolicy[t]}else{let t=this.runtimeRegistry.getHypertyName(e.from);r=this.serviceProviderPolicy[t]}return r}getURL(e){let t=e.split("/");return t[0]+"//"+t[2]+"/"+t[3]}_loadUserPolicies(){let e=this;return new Promise((t,r)=>{e.storageManager.get("rethink:userPolicies").then(e=>{let r=e;if(void 0!==r)for(let e in r)this.pep.addPolicy("USER",e,r[e]);t()})})}_getLastComponentOfURL(e){let t=e.split("/");return t[t.length-1]}_getPoliciesJSON(e){for(let t in e){let r=e[t].combiningAlgorithm;e[t].combiningAlgorithm=r instanceof Rt?"blockOverrides":r instanceof wt?"allowOverrides":r instanceof Ot?"firstApplicable":void 0}return e}saveActivePolicy(){let e=this;return new Promise((t,r)=>{e.storageManager.set("rethink:activePolicy",0,this.activeUserPolicy).then(()=>{t()})})}saveGroups(){let e=this;return new Promise((t,r)=>{e.storageManager.set("rethink:groups",0,this.groups).then(()=>{t()})})}savePolicies(e,t,r){let s;switch(e){case"USER":s=JSON.stringify(this.userPolicies),s=this._getPoliciesJSON(JSON.parse(s)),this.storageManager.set("rethink:userPolicies",0,s);break;case"SERVICE_PROVIDER":void 0!==t&void 0!==r&&(this.serviceProviderPolicy[r]=t),s=JSON.stringify(this.serviceProviderPolicy),s=this._getPoliciesJSON(JSON.parse(s)),this.storageManager.set("rethink:spPolicies",0,s);break;default:throw Error("Unknown policy source: "+e)}}getGroupsNames(){let e=this.groups,t=[];if(void 0!==e)for(let r in e)t.push(r);return t}getGroup(e,t){let r=[];if("preauthorised"===e){let e=t.split("/");e.pop(),e=e[0]+"//"+e[2],r=this.runtimeRegistry.getPreAuthSubscribers(e)}else void 0!==this.groups[e]&&(r=this.groups[e]);return r}createGroup(e){this.groups[e]=[],this.saveGroups()}deleteGroup(e){delete this.groups[e],this.saveGroups()}addToGroup(e,t){let r=this.groups;if(void 0===r[e])throw Error('Group "'+e+'" does not exist!');-1===r[e].indexOf(t)&&(r[e].push(t),this.saveGroups())}removeFromGroup(e,t){let r=this.groups[e];r.splice(r.indexOf(t),1),this.saveGroups()}}(this.runtimeURL,this.identityModule,this.registry,this.storages.policy,this.runtimeCapabilities)),this.coreDiscovery=new class{constructor(e,t,r,s,o){if(!s)throw Error("The catalogue needs the runtimeFactory");let n=this;this._messageBus=t,n.graphConnector=r,n.httpRequest=s.createHttpRequest(),n.domain=x(e).domain,n.discoveryURL=e+"/discovery/",n.registry=o,n.messageBus.addListener(n.discoveryURL,e=>{n.discoveryManager(e).then(t=>{n.messageBus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:t}})}).catch(function(t){let r,s;"GraphConnector"===t?(r="This search is not available at the moment. Try later.",s=500):(r="Not Found",s=404),n.messageBus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:s,description:r}})})})}get messageBus(){return this._messageBus}set messageBus(e){this._messageBus=e}discoveryManager(e){let t=this,r=(x(e.from).domain,e.body.resource.split("/").filter(Boolean)),s=[],o=[];switch(Bt.log("[CoreDiscovery.discoveryManager] received: ",e),e.body.criteria&&(e.body.criteria.resources&&(s=e.body.criteria.resources),e.body.criteria.dataSchemes&&(o=e.body.criteria.dataSchemes)),r[1]){case"user":return"hyperty"==r[0]?t.discoverHyperties(e.body.resource.split("user/")[1],o,s,e.body.criteria.domain):t.discoverDataObjects(e.body.resource.split("user/")[1],o,s,e.body.criteria.domain);case"url":return"hyperty"==r[0]?t.discoverHypertyPerURL(e.body.resource.split("url/")[1],e.body.criteria.domain):t.discoverDataObjectPerURL(e.body.resource.split("url/")[1],e.body.criteria.domain);case"name":return t.discoverDataObjectsPerName(e.body.resource.split("name/")[1],o,s,e.body.criteria.domain);case"reporter":return t.discoverDataObjectsPerReporter(e.body.resource.split("reporter/")[1],o,s,e.body.criteria.domain);case"guid":return void 0!==t.graphConnector&&null!==t.graphConnector?"hyperty"==r[0]?t.discoverHypertiesPerGUID(e.body.resource.split("user-guid://")[1],o,s):t.discoverDataObjectsPerGUID(e.body.resource.split("user-guid://")[1],o,s):Promise.reject("GraphConnector");case"userprofile":return void 0!==t.graphConnector&&null!==t.graphConnector?"hyperty"==r[0]?t.discoverHypertiesPerUserProfileData(e.body.resource.split("userprofile/")[1],o,s):t.discoverDataObjectsPerUserProfileData(e.body.resource.split("userprofile/")[1],o,s):Promise.reject("GraphConnector")}}discoverHypertiesPerUserProfileData(e,t,r){let s=this;return new Promise(function(o,n){s.discoverGUIDPerUserIdentifier(e).then(function(e){let i=e.map(function(e){return new Promise(function(o,n){s.discoverHypertiesPerGUID(e,t,r).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(i).then(function(e){let t=[].concat.apply([],e);if(0===t.length)return n("No hyperties were found");o(t)})}).catch(function(e){return n(e)})})}discoverDataObjectsPerUserProfileData(e,t,r){let s=this;return new Promise(function(o,n){s.discoverGUIDPerUserIdentifier(e).then(function(e){let i=e.map(function(e){return new Promise(function(o,n){s.discoverDataObjectsPerGUID(e,t,r).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(i).then(function(e){let t=[].concat.apply([],e);if(0===t.length)return n("No dataObjects were found");o(t)})}).catch(function(e){return n(e)})})}discoverHypertiesPerGUID(e,t,r){let s=this;return new Promise(function(o,n){s.discoverUserIdsPerGUID(e).then(function(e){let i=e.map(function(e){return new Promise(function(o,n){s.discoverHyperties(e.uID,t,r,e.domain).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(i).then(function(e){let t=[].concat.apply([],e);if(0===t.length)return n("No hyperties were found");o(t)})}).catch(function(e){return n(e)})})}discoverDataObjectsPerGUID(e,t,r){let s=this;return new Promise(function(o,n){s.discoverUserIdsPerGUID(e).then(function(e){let i=e.map(function(e){return new Promise(function(o,n){s.discoverDataObjects(e.uID,t,r,e.domain).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(i).then(function(e){let t=[].concat.apply([],e);if(0===t.length)return n("No dataObjects were found");o(t)})}).catch(function(e){return n(e)})})}discoverHyperties(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:"domain://registry."+o,body:{}};return e.indexOf("user://")>-1?i.body.resource=e:i.body.resource="/hyperty/idp-identifier/"+e,t.length>0&&(i.body.criteria||(i.body.criteria={}),i.body.criteria.dataSchemes=t),r.length>0&&(i.body.criteria||(i.body.criteria={}),i.body.criteria.resources=r),new Promise(function(e,t){n.messageBus.postMessage(i,r=>{if(200!==r.body.code&&500!==r.body.code)return t("No Hyperty was found");{let o=r.body.value,n=[];for(var s in o)n.push(o[s]);if(!(n.length>0))return t("No Hyperty was found");e(n)}})})}discoverDataObjects(e,t,r,s){let o,n=this,i=[];return o=s||n.domain,new Promise(function(s,a){n.discoverHyperties(e,[],[],o).then(function(e){let c=[];for(var u in e)c.push(e[u]);let l=c.map(function(e){return new Promise(function(s,i){n.discoverDataObjectsPerReporter(e.hypertyID,t,r,o).then(function(e){s(e)}).catch(function(e){s([])})})});Promise.all(l).then(function(e){[].concat.apply([],e).forEach(function(e){i.push(e)});let t=[];for(var r in i)t.push(i[r]);if(0===t.length)return a("No dataObjects were found");s(t)})}).catch(function(e){return a(e)})})}discoverHypertyPerURL(e,t){let r,s=this;r=t||s.domain;let o={type:"read",from:s.discoveryURL,to:"domain://registry."+r,body:{resource:e}};return new Promise(function(e,t){s.messageBus.postMessage(o,r=>{if(200!==r.body.code&&500!==r.body.code)return t("No Hyperty was found");let s=r.body.value;if(!s)return t("No Hyperty was found");e(s)})})}discoverDataObjectPerURL(e,t){let r,s=this;r=t||s.domain;let o={type:"read",from:s.discoveryURL,to:"domain://registry."+r,body:{resource:e}};return new Promise(function(e,t){s.messageBus.postMessage(o,r=>{let s=r.body.value;if(!s)return t("DataObject not found");e(s)})})}discoverDataObjectsPerName(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:"domain://registry."+o,body:{resource:e}};return t.length>0&&(i.body.criteria||(i.body.criteria={}),i.body.criteria.dataSchemes=t),r.length>0&&(i.body.criteria||(i.body.criteria={}),i.body.criteria.resources=r),new Promise(function(e,t){n.messageBus.postMessage(i,r=>{let s=r.body.value,o=[];for(var n in s)o.push(s[n]);if(!(o.length>0))return t("No DataObject was found");e(o)})})}discoverDataObjectsPerReporter(e,t,r,s){let o,n=this;o=s||n.domain;let i={type:"read",from:n.discoveryURL,to:"domain://registry."+o,body:{resource:"/comm",criteria:{reporter:e}}};return t.length>0&&(i.body.criteria.dataSchemes=t),r.length>0&&(i.body.criteria.resources=r),new Promise(function(e,t){n.messageBus.postMessage(i,r=>{let s=r.body.value,o=[];for(var n in s)o.push(s[n]);if(!(o.length>0))return t("No DataObject was found");e(o)})})}discoverUserIdsPerGUID(e){let t=this;return new Promise(function(r,s){t.graphConnector.queryGlobalRegistry(e).then(function(e){if("string"==typeof e||!e)return s("Unsuccessful discover userIDs by GUID");{let t=e.userIDs;if(0===t.length)return s("UserIDs not available");r(t)}}).catch(function(e){return s(e)})})}discoverGUIDPerUserIdentifier(e){let t=this;return new Promise(function(r,s){t.httpRequest.get("https://rethink.tlabscloud.com/discovery/rest/discover/lookup?searchquery="+e).then(function(e){let t=JSON.parse(e).results.filter(function(e){return null!=e.rethinkID});if(0===t.length)return s("Unsuccessful discover GUID by user identifier");let o=t.map(function(e){return e.rethinkID});return r(o)}).catch(function(e){return s(e)})})}}(this.runtimeURL,this.messageBus,this.graphConnector,this.runtimeFactory,this.registry),this.identityHandler=new class{constructor(e){this._idm=e}reset(){console.log("IM reset"),this._idm.identities=new ft(this._idm.identities._type,this._idm.identities._storageManager),console.log(this._idm.identities)}_isToSetID(e){let t=e.from;if(e.body&&e.body.hasOwnProperty("source")&&(t=e.body.source),e.body&&e.body.hasOwnProperty("subscriber")&&(t=e.body.subscriber),"forward"===e.type)return!1;if("event"===e.type)return!1;if(t.includes("/p2prequester/")||t.includes("/p2phandler/"))return!1;let r=t.split("://")[0];return-1===["domain-idp","runtime","domain"].indexOf(r)}processMessage(e){return _t.log("[IdentityHandler.processMessage] ",e),new Promise((t,r)=>this._isToSetID(e)?e.body&&e.body.value&&e.body.value.anonymous?(e.body.identity&&e.body.identity.guid?e.body.identity={userProfile:{guid:e.body.identity.guid}}:e.body.identity={userProfile:{guid:"anonymous"}},t(e)):void this._idm.getToken(e).then(r=>{e.hasOwnProperty("body")||(e.body={}),e.body.identity=r,t(e)}).catch(e=>{_t.error(e),r(e)}):t(e))}}(this.identityModule),Et.init(this.runtimeURL,this.runtimeCapabilities,this.storages.cryptoManager,this._dataObjectsStorage,this.registry,this.coreDiscovery,this.identityModule,this.runtimeFactory),this.handlers=new class{constructor(e,t,r){if(!e)throw Error("[MsgBusHandlers] pep input paramenter is mandatory");if(!t)throw Error("[MsgBusHandlers] idm input paramente is mandatory");if(!r)throw Error("[MsgBusHandlers] crypto input paramente is mandatory");this.policyEngine=e,this.identityManager=t,this.cryptoManager=r}get pepInHandler(){let e=this;return t=>{e.policyEngine.authorise(t.msg,!0).then(e=>{t.msg=e,t.next()}).catch(e=>{mt.error(e),t.fail(e)})}}get pepOutHandler(){let e=this;return t=>{e.policyEngine.authorise(t.msg,!1).then(e=>{t.msg=e,t.next()}).catch(e=>{mt.error(e),t.fail(e)})}}get idmHandler(){let e=this;return t=>{e.identityManager.processMessage(t.msg).then(e=>{t.msg=e,t.next()}).catch(e=>{mt.error(e),t.fail(e)})}}get encryptHandler(){let e=this;return t=>{e.cryptoManager.encryptMessage(t.msg).then(e=>{t.msg=e,t.next()}).catch(e=>{mt.error(e),t.fail(e)})}}get decryptHandler(){let e=this;return t=>{e.cryptoManager.decryptMessage(t.msg).then(e=>{t.msg=e,t.next()}).catch(e=>{mt.warn(e),t.fail(e)})}}}(this.policyEngine,this.identityHandler,Et),this.messageBus.pipelineOut.handlers=[this.handlers.idmHandler,this.handlers.pepOutHandler],this.messageBus.pipelineIn.handlers=[this.handlers.pepInHandler],s.addListener("*",e=>{this.messageBus.postMessage(e)}),Et.messageBus=this.messageBus,this.registry.messageBus=this.messageBus,this.policyEngine.messageBus=this.messageBus,this.identityModule.messageBus=this.messageBus,this.identityModule.registry=this.registry,this.identityModule.coreDiscovery=this.coreDiscovery,this.runtimeFactory.messageBus=this.messageBus,this.syncherManager=new class{constructor(e,t,r,s,o,n,i){if(!e)throw new Error("[Syncher Manager] - needs the runtimeURL parameter");if(!t)throw new Error("[Syncher Manager] - needs the MessageBus instance");if(!r)throw new Error("[Syncher Manager] - needs the Registry instance");if(!s)throw new Error("[Syncher Manager] - need the storageManager instance");let a=this;a._bus=t,a._registry=r,a._storageManager=s,a._identityModule=i,a.runtimeURL=e,a._url=e+"/sm",a._objectURL=e+"/object-allocation",a._reporters={},a._observers={},a._dataObjectsStorage=n,console.log("[NOTSAVING] storeDataObjects",n),a._domain=x(e).domain,a._allocator=o||et.instance,$t.log("[SyncherManager - AddressAllocation] - ",a._allocator),t.addListener(a._url,e=>{switch($t.info("[SyncherManager] RCV: ",e),e.type){case"create":a._onCreate(e);break;case"delete":a._onDelete(e);break;case"subscribe":a._onLocalSubscribe(e);break;case"unsubscribe":a._onLocalUnSubscribe(e);break;case"read":a._onRead(e);break;case"execute":a._onExecute(e)}})}get url(){return this._url}_onExecute(e){let t=this,r={type:"response",from:e.to,to:e.from,id:e.id};if($t.info("[SyncherManager.onExecute] new message",e),e.hasOwnProperty("body")&&e.body.hasOwnProperty("method")&&e.body.hasOwnProperty("params")){switch(e.body.method){case"sync":t._dataObjectsStorage.sync(e.body.params[0],e.body.params[1],!1);break;case"stopSync":t._dataObjectsStorage.stopSync(e.body.params[0])}r.body={code:200},t._bus.postMessage(r)}else r.body={code:400,desc:"missing body or body method / params mandatory fields"},$t.error("[SyncherManager.onExecute] error. Missing body or body method / params mandatory fields",e),t._bus.postMessage(r)}_onRead(e){let t=this,r={type:"response",from:e.to,to:e.from,id:e.id};$t.info("[SyncherManager.onRead] new message",e),e.hasOwnProperty("body")&&e.body.hasOwnProperty("resource")?t._dataObjectsStorage.sync(e.body.resource,!0).then(e=>{r.body={code:200,value:e},$t.info("[SyncherManager.onRead] found object: ",e),t._bus.postMessage(r)},e=>{r.body={code:404,desc:e},$t.warn("[SyncherManager.onRead] warning: ",e),t._bus.postMessage(r)}):(r.body={code:400,desc:"missing body or body resource mandatory fields"},$t.error("[SyncherManager.onRead] error. Missing body or body resource mandatory fields",e),t._bus.postMessage(r))}_onCreate(e){let t=e.from,r=e.to,s=this;e.body.attribute?this._storeChildrens(e):!e.body.hasOwnProperty("resume")||e.body.hasOwnProperty("resume")&&!e.body.resume?e.body.authorise?(this._authorise(e),$t.info("[SyncherManager.onCreate - invite observers]",e)):($t.info("[SyncherManager.onCreate - Create New Object]",e),this._newCreate(e)):this._dataObjectsStorage.getResourcesByCriteria(e,!0).then(o=>{if($t.info("[SyncherManager - Create Resumed] - ResourcesByCriteria | Message: ",e," result: ",o),o&&Object.keys(o).length>0){let n=[];Object.keys(o).forEach(t=>{n.push(s._resumeCreate(e,o[t]))}),Promise.all(n).then(s=>{$t.log("[SyncherManager - Create Resumed]",s);let o=Object.values(s).filter(e=>!1!==e);$t.info("[SyncherManager.onCreate] returning resumed objects : ",o),this._bus.postMessage({id:e.id,type:"response",from:r,to:t,body:{code:200,value:I(o)}})})}else{let t={};t.id=e.id,t.from=e.to,t.to=e.from,t.type="response",t.body={code:404,desc:"No data objects reporters to be resumed"},this._bus.postMessage(t)}})}_storeChildrens(e){let t=e.body.resource,r=e.body.attribute;"childrenObjects"===r?this._dataObjectsStorage.saveChildrens(!1,t,void 0,e.body.value):this._dataObjectsStorage.saveChildrens(!0,t,r,e.body.value)}_newCreate(e){let t=this,r=e.from,s=x(e.from).domain;t._registry.isInterworkingProtoStub(e.from)&&(s=x(t.runtimeURL).domain);let o=!e.body.value.hasOwnProperty("domain_routing")||e.body.value.domain_routing;t._registry.getDataSchemaDescriptor(e.body.schema).then(n=>{let i=n.sourcePackage.sourceCode.properties,a=i.scheme?i.scheme:"resource",c=i.childrens?i.childrens:[],u={name:e.body.value.name,schema:e.body.value.schema,reporter:e.body.value.reporter,resources:e.body.value.resources},l=e.body.value.resource;t._allocator.create(s,1,u,a,l).then(s=>{let n=I(e.body.value);n.url=s.address[0],n.authorise=e.body.authorise,n.childrens=c,delete n.data,$t.log("[SyncherManager._newCreate] ALLOCATOR CREATE:",s);let i=n.url+"/subscription";$t.log("[SyncherManager._newCreate] Subscription URL",i),$t.info("[SyncherManager._newCreate] Register Object: ",n),t._registry.registerDataObject(n).then(s=>{let a,u;if($t.log("[SyncherManager._newCreate] DataObject successfully registered",s),this._reporters[n.url])a=this._reporters[n.url];else{let e=!!n.offline&&n.offline;a=new Jt(t,r,n.url,c,e)}$t.log("[SyncherManager - new Create] - ",e),u=e.body.hasOwnProperty("identity")&&e.body.identity.userProfile&&e.body.identity.userProfile.userURL?e.body.identity.userProfile.userURL:t._registry.getHypertyOwner(e.from);let l=I(n);l.subscriberUser=u,l.isReporter=!0,e.body.hasOwnProperty("store")&&e.body.store&&(a.isToSaveData=!0,l.isToSaveData=!0,e.body.value.data&&(l.data=I(e.body.value.data))),t._dataObjectsStorage.set(l).then(s=>{if(l.offline){e.body.identity.guid=t._identityModule._identities.guid;let r={from:e.to,to:l.offline+"/register",type:"forward",body:e};r.body.body.resource=n.url,r.body.body.value=l,$t.log("[SyncherManager.newCreate] registering new object at offline manager ",r),t._bus.postMessage(r)}let u={id:e.id,type:"response",from:e.to,to:r,body:{code:200,resource:n.url,childrenResources:c}};o?a.forwardSubscribe([n.url,i]).then(()=>{a.addChildrens().then(()=>{t._reporters[n.url]=a,t._bus.postMessage(u)})}):a.addChildrens().then(()=>{t._reporters[n.url]=a,t._bus.postMessage(u)})},e=>{$t.error(e)})},function(e){$t.error(e)})})}).catch(s=>{let o={id:e.id,type:"response",from:e.to,to:r,body:{code:500,desc:s}};t._bus.postMessage(o)})}_resumeCreate(e,t){let r=this;return new Promise(s=>{let o=e.from,n=t.schema,i=t.url,a=!t.hasOwnProperty("domain_registration")||t.domain_registration;t.data,$t.log("[SyncherManager] - resume create",e,t),r._registry.getDataSchemaDescriptor(n).then(n=>{let c,u,l=n.sourcePackage.sourceCode.properties,d=(l.scheme&&l.scheme.constant,l.childrens?l.childrens:[]);if($t.log("[SyncherManager] - getDataSchemaDescriptor: ",n,d),this._reporters[i]?c=this._reporters[i]:(u=!!t.offline&&t.offline,c=new Jt(r,o,i,d,u)),c.isToSaveData=t.isToSaveData,u){let e={from:r._url,to:u+"/register",type:"update",body:{}};$t.log("[SyncherManager._resumeCreate] update object at offline manager ",e),r._bus.postMessage(e)}a?c.forwardSubscribe([t.url]).then(()=>{$t.log("[SyncherManager._resumeCreate] resumingReporterSubscription ",t),r._resumeReporterSubscriptions(e,t,c,d,a).then(e=>{$t.log("[SyncherManager._resumeCreate] resolved resumed object ",e),s(e)})}):s(r._resumeReporterSubscriptions(e,t,c,d,a))}).catch(e=>{$t.error("[SyncherManager - resume create] - fail on getDataSchemaDescriptor: ",e),s(!1)})})}_resumeReporterSubscriptions(e,t,r,s,o){let n=this,i=t.url,a=I(e.body.value);return a.url=t.url,a.expires=t.expires,a.domain_registration=o,delete a.data,new Promise(e=>{r.addChildrens().then(()=>(r.resumeSubscriptions(t.subscriptions),n._reporters[i]=r,$t.info("[SyncherManager - resume create] - resolved resumed: ",t),n._decryptChildrens(t,s))).then(t=>{$t.info("[SyncherManager._resumeReporterSubscriptions] Register Object: ",a),n._registry.registerDataObject(a).then(r=>{$t.log("[SyncherManager._resumeReporterSubscriptions] DataObject registration successfully updated",r),$t.log("[SyncherManager._resumeReporterSubscriptions] resolving object",t),e(t)})}).catch(t=>{$t.error("[SyncherManager - resume create] - fail on addChildrens: ",t),e(!1)})})}_decryptChildrens(e,t){let r=I(e);return new Promise(e=>{t?(0===Object.keys(r.childrenObjects).length&&e(r),t.forEach(t=>{let s=r.childrenObjects;$t.log("[SyncherManager._decryptChildrens] dataObjectChilds to decrypt ",s);let o=[];Object.keys(s).forEach(e=>{let t=s[e],n=e.split("#")[0];if("string"==typeof t.value){$t.log("[SyncherManager._decryptChildrens] createdBy ",n," object: ",t.value);let e=Et.decryptDataObject(JSON.parse(t.value),r.url);o.push(e)}}),Promise.all(o).then(t=>{$t.log("[SyncherManager._decryptChildrens] returning decrypted ",t),t.forEach(e=>{const t=e.value.url;r.childrenObjects[t].value=e.value}),$t.log("[SyncherManager._decryptChildrens] storedObject ",r),e(r)}).catch(e=>{$t.warn("[SyncherManager._decryptChildrens] failed : ",e)})})):e(r)})}_authorise(e){let t=this;if(!e.body.resource)throw new Error("[SyncherManager._authorise] invitation request without data object url:",e);let r=e.body.resource+"/subscription",s=!!e.body.p2p&&e.body.p2p;$t.log("[SyncherManager -  authorise] - ",e),e.body.authorise&&e.body.authorise.forEach(o=>{t._bus.postMessage({type:"create",from:r,to:o,body:{p2p:s,identity:e.body.identity,source:e.from,value:e.body.value,schema:e.body.schema}},r=>{let s={from:e.to,to:e.from,id:e.id,type:r.type,body:r.body};t._bus.postMessage(s)})})}_onDelete(e){let t=this,r=e.body.resource,s=t._reporters[r];if(s){if(s.offline){let r={from:e.to,to:s.offline+"/register",type:"forward",body:e};$t.log("[SyncherManager._onDelete] unregistering object from offline manager ",r),t._bus.postMessage(r)}s.delete(),this._dataObjectsStorage.deleteResource(r).then(s=>{$t.log("[SyncherManager - onDelete] - deleteResource: ",s),t._registry.unregisterDataObject(r),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}})})}}_onLocalSubscribe(e){e.body.hasOwnProperty("resume")&&e.body.resume?this._dataObjectsStorage.getResourcesByCriteria(e,!1).then(t=>{if($t.info("[SyncherManager.onLocalSubscribe. resume]: ",e," result: ",t),t&&Object.keys(t).length>0){let r=[];Object.keys(t).forEach(s=>{$t.log("[SyncherManager - resume Subscribe] - reuse current object url: ",t[s]),r.push(this._resumeSubscription(e,t[s]))}),Promise.all(r).then(t=>{$t.log("[SyncherManager - Observers Resumed]",t);let r=Object.values(t).filter(e=>!1!==e),s={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:r}};$t.log("[SyncherManager - Observers Resumed] replying ",s),this._bus.postMessage(s)})}else{let t={};t.id=e.id,t.from=e.to,t.to=e.from,t.type="response",t.body={code:404,desc:"No data objects observers to be resumed"},this._bus.postMessage(t)}}):($t.log("[SyncherManager.onLocalSubscribe - new Subscribe] - ",e.body.schema,e.body.resource),this._newSubscription(e))}_newSubscription(e){let t=this,r=e.body.resource,s=e.from,o=x(r).domain,n=!e.body.hasOwnProperty("domain_subscription")||e.body.domain_subscription,i=r+"/children/";t._registry.getDataSchemaDescriptor(e.body.schema).then(a=>{let c=a.sourcePackage.sourceCode.properties,u=c.childrens?c.childrens:[],l=[];if(l.push(r+"/changes"),l.push(i),n){let n={type:"subscribe",from:t._url,to:"domain://msg-node."+o+"/sm",body:{identity:e.body.identity,resources:l,source:s}};t._bus.postMessage(n,o=>{$t.log("node-subscribe-response(observer): ",o),console.log("REUSETEST SyncherManager - node-subscribe-response(observer): ",o),200===o.body.code?t._newReporterSubscribe(e,s,r,u):t._bus.postMessage({id:e.id,type:"response",from:e.to,to:s,body:o.body})})}else t._newReporterSubscribe(e,s,r,u)})}_newReporterSubscribe(e,t,r,s){let o=this,n=r+"/subscription";o._bus.postMessage({id:e.id,type:"response",from:e.to,to:t,body:{code:100,childrenResources:s,schema:e.body.schema,resource:e.body.resource}});let i={type:"subscribe",from:o._url,to:n,body:{identity:e.body.identity,subscriber:t}};e.body.hasOwnProperty("mutual")&&(i.body.mutual=e.body.mutual),$t.log("[SyncherManager._newSubscription]",i,e),console.log("REUSETEST SyncherManager - [SyncherManager._newSubscription]",i,e),o._bus.postMessage(i,n=>{$t.log("reporter-subscribe-response-new: ",n),console.log("REUSETEST SyncherManager - reporter-subscribe-response-new: ",n),200===n.body.code?o._processSuccessfullSubscription(n,t,r,s,e):e.body.offline&&o._processOfflineSubscription(i,e.body.offline,t,r,s,e)})}_processOfflineSubscription(e,t,r,s,o,n){let i=this,a={from:e.from,type:"forward",to:t,body:e};console.log("[SyncherManager._processOfflineSubscription] forwading ",a),i._bus.postMessage(a,e=>{$t.log("[SyncherManager._processOfflineSubscription] reply ",e),200===e.body.code&&i._processSuccessfullSubscription(e,r,s,o,n)})}_processSuccessfullSubscription(e,t,r,s,o){let n=this;$t.log("[SyncherManager._newSubscription] - observers: ",n._observers,r,n._observers[r]),console.log("REUSETEST SyncherManager - 200 code[SyncherManager._newSubscription] - observers: ",n._observers,r,n._observers[r]);let i=n._observers[r];i||(i=new zt(n,r,s),$t.log("[SyncherManager._newSubscription] - observers: create new ObserverObject: ",i),n._observers[r]=i,i.addSubscription(t),i.addChildrens());let a,c=!1;o.body.hasOwnProperty("identity")&&o.body.identity.userProfile&&o.body.identity.userProfile.userURL?(a=o.body.identity.userProfile.userURL).includes("user://")||(c=!0):(a=n._registry.getHypertyOwner(o.from))||(c=!0);let u=I(e.body.value);delete u.data,delete u.childrenObjects,u.childrens=s,u.subscriberUser=a,u.isReporter=!1,u.subscriberHyperty=t,c||(n._dataObjectsStorage.set(u),(u.hasOwnProperty("store")&&u.store||u.hasOwnProperty("isToSaveData")&&u.isToSaveData)&&(i.isToSaveData=!0,n._dataObjectsStorage.update(!1,r,"isToSaveData",!0),n._dataObjectsStorage.saveData(!1,r,null,e.body.value.data))),e.id=o.id,e.from=n._url,e.to=t,e.body.schema=o.body.schema,e.body.resource=o.body.resource,o.body.hasOwnProperty("mutual")&&(e.body.mutual=o.body.mutual),$t.log("[subscribe] - new subscription: ",o,e,i),this._bus.postMessage(e)}_resumeSubscription(e,t){return new Promise(r=>{let s=t.url,o=t.schema,n=e.from,i=s+"/children/";$t.log("[SyncherManager - ReuseSubscription] - objURL: ",s," - schema:",o),this._registry.getDataSchemaDescriptor(o).then(r=>{let a=r.sourcePackage.sourceCode.properties,c=a.childrens?a.childrens:[],u=[];u.push(s+"/changes"),u.push(i),this._bus.postMessage({id:e.id,type:"response",from:e.to,to:n,body:{code:100,childrenResources:c,schema:o,resource:s}});let l=this._observers[s];return l||((l=new zt(this,s,c)).isToSaveData=t.isToSaveData,this._observers[s]=l),l.addSubscription(n),l.addChildrens(),this._decryptChildrens(t,c)}).then(e=>{r(e)}).catch(e=>{$t.error("[SyncherManager - resume subscription] - fail on getDataSchemaDescriptor: ",e),r(!1)})})}_onLocalUnSubscribe(e){let t=this,r=(e.from,e.body.resource),s=t._observers[r];s&&(s.removeSubscription(e),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}}),this._dataObjectsStorage.deleteResource(r),delete t._observers[r])}}(this.runtimeURL,this.messageBus,this.registry,this.storages.syncherManager,null,this._dataObjectsStorage,this.identityModule),this.loader.runtimeURL=this.runtimeURL,this.loader.messageBus=this.messageBus,this.loader.registry=this.registry,this.loader.runtimeFactory=this.runtimeFactory;const o=[];o.push(this.subscriptionManager.init()),o.push(this.identityModule.init(e)),o.push(Et.loadSessionKeys()),o.push(this.registry.loadRegistry()),o.push(this._dataObjectsStorage.loadRemote()),Promise.all(o).then(e=>{5===e.length?t(!0):r("[RuntimeUA._loadComponents] Error ] ",e)}).catch(e=>{throw Error(e)})}catch(e){r(e)}})}loadHyperty(e,t=!1,r){if(!e)throw new Error("Hyperty descriptor url parameter is needed");return this.loader.loadHyperty(e,t,r)}loadStub(e){if(!e)throw new Error("ProtoStub descriptor url parameter is needed");return this.loader.loadStub(e)}loadIdpProxy(e){if(Zt.log("ipdProxyCatalogueURL",e),!e)throw new Error("The IDP Proxy URL is a needed parameter, could be a DOMAIN or a URL");return this.loader.loadIdpProxy(e)}close(e){console.log("Runtime core logout: ",e);let t=this;return!0===e&&this.identityHandler.reset(),Zt.info("Unregister all hyperties"),new Promise(function(e,r){t.registry.unregisterAllHyperties().then(function(t){Zt.info("All the hyperties are unregisted with Success:",t),e(!0)}).catch(function(e){Zt.error("Failed to unregister the hyperties",e),r(!1)})})}reset(){console.log("RuntimeUA.Runtime core reset: ");let e=[];return new Promise((t,r)=>{this._dataObjectsStorage.deleteRemotes().then(()=>{}).then(()=>{this.storages.identity.get(!1,!1,"identities").then(r=>{Object.keys(r).forEach(t=>{e.push(this.storages.identity.delete(t,!1,"identities"))}),e.push(this.storages.capabilities.delete("capabilities")),e.push(this.storages.cryptoManager.delete("userAsymmetricKey")),e.push(this.storages.hypertyResources.delete("hypertyResources")),e.push(this.storages.identity.delete("accessTokens")),e.push(this.storages.registry.delete("registry:DataObjectURLs")),e.push(this.storages.registry.delete("registry:HypertyURLs")),e.push(this.storages.runtime.delete("p2pHandler:URL")),e.push(this.storages.runtime.delete("runtime:URL")),e.push(this.storages.subscriptions.delete("subscriptions")),e.push(this.storages.syncherManager.delete("syncherManager:ObjectURLs")),e.push(this.storages.syncherManager.delete("remotes")),Promise.all(e).then(e=>(Zt.info("[RuntimeUA.reset] reset with Success:",e),t(!0))).catch(function(e){Zt.error("Failed to reset all DBs",e),t(!1)})})})})}}}]))}}});