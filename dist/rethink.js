// version: 0.15.0
// date: Fri Dec 21 2018 09:06:41 GMT+0000 (Western European Standard Time)
// licence: 
/**
* Copyright 2016 PT Inovação e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/


// version: 0.15.0
// date: Fri Dec 21 2018 09:06:41 GMT+0000 (Western European Standard Time)
// licence: 
/**
* Copyright 2016 PT Inovação e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/


!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("rethink",[],t):"object"==typeof exports?exports.rethink=t():e.rethink=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=32)}([function(e,t,n){"use strict";function r(e){function t(e){return e.replace(/([a-zA-Z-]*)(:\/\/(?:\.)?|:)([-a-zA-Z0-9@:%._+~#=]{2,256})([-a-zA-Z0-9@:%._+~#=\/]*)/gi,"$1,$3,$4").split(",")}var n=t(e);if(n[0]===e&&!n[0].includes("@")){var r={type:"",domain:e,identity:""};return console.warn("[DivideURL] DivideURL don't support url without scheme. Please review your url address",e),r}return n[0]===e&&n[0].includes("@")&&(n=t((n[0]===e?"smtp":n[0])+"://"+n[0])),n[1].includes("@")&&(n[2]=n[0]+"://"+n[1],n[1]=n[1].substr(n[1].indexOf("@")+1)),{type:n[0],domain:n[1],identity:n[2]}}function o(e){return!(Object.keys(e).length>0)}function i(){return Math.floor(Date.now()/1e3)}function s(e){if(e)return JSON.parse(JSON.stringify(e))}function a(e){var t=e.split("/");return t[0]+"//"+t[2]+"/"+t[3]}function c(e){var t=r(e);return t.identity.replace("/","")+"@"+t.domain}function u(e){if("user://"===e.substring(0,7)){var t=r(e);if(t.domain&&t.identity)return e;throw"userURL with wrong format"}return function(e){var t=e.indexOf("@");return"user://"+e.substring(t+1,e.length)+"/"+e.substring(0,t)}(e)}function l(e){var t=e.split("://")[0];return-1===["domain-idp","runtime","domain","hyperty"].indexOf(t)}function f(e){return e.split("@").length>1}function d(e){return e.split("/").length>=3}function h(e){return"user"===r(e).type}function y(e){return"hyperty"===r(e).type}function p(e,t,n){return e[t][n]}function v(e,t,n,r){var o,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=e[t];if(!s.hasOwnProperty(n))throw Error("The configuration "+JSON.stringify(s,"",2)+" don't have the "+n+" resource you are looking for");var a=s[n];return r?(o=a.prefix+e.domain+a.suffix+r,a.hasOwnProperty("fallback")&&i&&(o=a.fallback.indexOf("%domain%")?a.fallback.replace(/(%domain%)/g,e.domain)+r:a.fallback+r)):o=a.prefix+e.domain+a.suffix,o}function b(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function g(e){var t=r(e).domain.split("."),n=t.length;return 1==n?t[n-1]:t[n-2]+"."+t[n-1]}function m(e){var t,n=r(e),o=n.domain.split("."),i=["registry","msg-node"];return o.length>1&&(t=o.filter(function(e){return-1!==i.indexOf(e)})[0]),!(!t||-1===i.indexOf(t))||!!n.type&&-1!==["domain","global","domain-idp"].indexOf(n.type)}function _(e){var t=e.indexOf("@");return{username:e.substring(0,t),domain:e.substring(t+1,e.length)}}function w(e,t,n){e||(e={}),"string"==typeof t&&(t=k(t));for(var r=t.length-1,o=0;o<r;++o){var i=t[o];i in e||(e[i]={}),e=e[i]}e[t[r]]=n}function O(e){console.info("[utils - splitObjectURL]: ",e);var t=e.split("/"),n={url:t[0]+"//"+t[2]+"/"+t[3],resource:t[5]};return console.info("[utils - splitObjectURL]: ",n),n}function k(e){if(e.includes("://")){var t=e.split(/([0-9a-zA-Z][-\w]*):\/\//g)[0],n=t.split("."),r=e.replace(t,"");if(e.includes("identity")){var o=r.split("identity.");console.log("array2 "+o),r=o[0].slice(".",-1),o=o[1].split("."),n.push(r,"identity"),n=n.concat(o)}else n.push(r);return n.filter(Boolean)}return e.split(".")}function R(e){var t={},n=Object.keys(e);if(n)try{for(var r=0;r<n.length;r++){var o=n[r];t[o]={},t[o].sessionKey=e[o].sessionKey.toString(),t[o].isToEncrypt=e[o].isToEncrypt}}catch(e){console.error("_chatkeysToStringCloner:err",e)}return t}function P(e){var t={},n=Object.keys(e);if(n)try{for(var r=0;r<n.length;r++){var o=n[r];t[o]={};var i=JSON.parse("["+e[o].sessionKey+"]");t[o].sessionKey=new Uint8Array(i),t[o].isToEncrypt=e[o].isToEncrypt}}catch(e){console.error("_chatkeysToArrayCloner:err",e)}return t}function S(e){var t=e.split("/");return t.length<=6?t[0]+"//"+t[2]+"/"+t[3]:t[0]+"//"+t[2]+"/"+t[3]+"/"+t[4]}function j(e,t){var n=(e/t).toFixed(2);return{quota:t,usage:e,percent:Number(n)}}function E(e){try{var t=x(e);return btoa(t)}catch(e){throw console.error("[Utils.encode:err] "+e),e}}function M(e){try{return JSON.parse(atob(e))}catch(e){throw console.log("[Utils.decode:err] "+e),e}}function C(e){try{return new Uint8Array(M(e))}catch(e){throw console.error("[Utils.decodeToUint8Array:err] "+e),e}}function x(e){try{return e.constructor===Uint8Array?"["+e.toString()+"]":JSON.stringify(e)}catch(e){throw console.error("[Utils.stringify:err] "+e),e}}function L(e){try{return JSON.parse(e)}catch(t){throw console.error("[Utils.parse:err]"+t),console.trace(),console.error("That that cause the error:",e),t}}function I(e){try{return new Uint8Array(L(e))}catch(e){throw console.error("[Utils.parseToUint8Array:err]"+e),e}}n.d(t,"k",function(){return r}),n.d(t,"l",function(){return o}),n.d(t,"C",function(){return i}),n.d(t,"i",function(){return s}),n.d(t,"B",function(){return a}),n.d(t,"p",function(){return c}),n.d(t,"f",function(){return u}),n.d(t,"s",function(){return l}),n.d(t,"u",function(){return f}),n.d(t,"v",function(){return d}),n.d(t,"w",function(){return h}),n.d(t,"t",function(){return y}),n.d(t,"o",function(){return p}),n.d(t,"c",function(){return v}),n.d(t,"n",function(){return b}),n.d(t,"q",function(){return g}),n.d(t,"r",function(){return m}),n.d(t,"j",function(){return _}),n.d(t,"a",function(){return w}),n.d(t,"D",function(){return O}),n.d(t,"y",function(){return k}),n.d(t,"e",function(){return R}),n.d(t,"d",function(){return P}),n.d(t,"z",function(){return S}),n.d(t,"b",function(){return j}),n.d(t,"m",function(){return E}),n.d(t,"g",function(){return M}),n.d(t,"h",function(){return C}),n.d(t,"E",function(){return x}),n.d(t,"x",function(){return L}),n.d(t,"A",function(){return I})},function(e,t,n){var r,o;!function(i,s){"use strict";void 0===(o="function"==typeof(r=function(){var e=function(){},t="undefined",n=["trace","debug","info","warn","error"];function r(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(t,r){for(var o=0;o<n.length;o++){var i=n[o];this[i]=o<t?e:this.methodFactory(i,t,r)}this.log=this.debug}function i(n,i,s){return function(n){return"debug"===n&&(n="log"),typeof console!==t&&(void 0!==console[n]?r(console,n):void 0!==console.log?r(console,"log"):e)}(n)||function(e,n,r){return function(){typeof console!==t&&(o.call(this,n,r),this[e].apply(this,arguments))}}.apply(this,arguments)}function s(e,r,s){var a,c=this,u="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(u)+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=s||i,c.getLevel=function(){return a},c.setLevel=function(r,i){if("string"==typeof r&&void 0!==c.levels[r.toUpperCase()]&&(r=c.levels[r.toUpperCase()]),!("number"==typeof r&&r>=0&&r<=c.levels.SILENT))throw"log.setLevel() called with invalid level: "+r;if(a=r,!1!==i&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[u]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+r+";"}catch(e){}}}(r),o.call(c,r,e),typeof console===t&&r<c.levels.SILENT)return"No console available for logging"},c.setDefaultLevel=function(e){l()||c.setLevel(e,!1)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)};var f=l();null==f&&(f=null==r?"WARN":r),c.setLevel(f,!1)}var a=new s,c={};a.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new s(e,a.getLevel(),a.methodFactory)),t};var u=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=u),a},a.getLoggers=function(){return c},a})?r.call(t,n,t,e):r)||(e.exports=o)}()},function(e,t,n){(function(t,n){!function(t,n){e.exports=n()}(0,function(){"use strict";var e=Object.keys,r=Array.isArray,o="undefined"!=typeof self?self:"undefined"!=typeof window?window:t;function i(t,n){return"object"!=typeof n?t:(e(n).forEach(function(e){t[e]=n[e]}),t)}var s=Object.getPrototypeOf,a={}.hasOwnProperty;function c(e,t){return a.call(e,t)}function u(t,n){"function"==typeof n&&(n=n(s(t))),e(n).forEach(function(e){l(t,e,n[e])})}function l(e,t,n,r){Object.defineProperty(e,t,i(n&&c(n,"get")&&"function"==typeof n.get?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function f(e){return{from:function(t){return e.prototype=Object.create(t.prototype),l(e.prototype,"constructor",e),{extend:u.bind(null,e.prototype)}}}}var d=Object.getOwnPropertyDescriptor,h=[].slice;function y(e,t,n){return h.call(e,t,n)}function p(e,t){return t(e)}function v(e){var t=setTimeout(e,1e3);clearTimeout(t)}function b(e){if(!e)throw new Error("Assertion Failed")}function g(e){o.setImmediate?n(e):setTimeout(e,0)}function m(e,t){return e.reduce(function(e,n,r){var o=t(n,r);return o&&(e[o[0]]=o[1]),e},{})}function _(e,t,n){try{e.apply(null,n)}catch(e){t&&t(e)}}function w(e,t){if(c(e,t))return e[t];if(!t)return e;if("string"!=typeof t){for(var n=[],r=0,o=t.length;r<o;++r){var i=w(e,t[r]);n.push(i)}return n}var s=t.indexOf(".");if(-1!==s){var a=e[t.substr(0,s)];return void 0===a?void 0:w(a,t.substr(s+1))}}function O(e,t,n){if(e&&void 0!==t&&!("isFrozen"in Object&&Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){b("string"!=typeof n&&"length"in n);for(var r=0,o=t.length;r<o;++r)O(e,t[r],n[r])}else{var i=t.indexOf(".");if(-1!==i){var s=t.substr(0,i),a=t.substr(i+1);if(""===a)void 0===n?delete e[s]:e[s]=n;else{var c=e[s];c||(c=e[s]={}),O(c,a,n)}}else void 0===n?delete e[t]:e[t]=n}}function k(e){var t={};for(var n in e)c(e,n)&&(t[n]=e[n]);return t}function R(e){if(!e||"object"!=typeof e)return e;var t;if(r(e)){t=[];for(var n=0,o=e.length;n<o;++n)t.push(R(e[n]))}else if(e instanceof Date)(t=new Date).setTime(e.getTime());else for(var i in t=e.constructor?Object.create(e.constructor.prototype):{},e)c(e,i)&&(t[i]=R(e[i]));return t}function P(t,n,r,o){return r=r||{},o=o||"",e(t).forEach(function(e){if(c(n,e)){var i=t[e],s=n[e];"object"==typeof i&&"object"==typeof s&&i&&s&&i.constructor===s.constructor?P(i,s,r,o+e+"."):i!==s&&(r[o+e]=n[e])}else r[o+e]=void 0}),e(n).forEach(function(e){c(t,e)||(r[o+e]=n[e])}),r}var S="undefined"!=typeof Symbol&&Symbol.iterator,j=S?function(e){var t;return null!=e&&(t=e[S])&&t.apply(e)}:function(){return null},E={};function M(e){var t,n,o,i;if(1===arguments.length){if(r(e))return e.slice();if(this===E&&"string"==typeof e)return[e];if(i=j(e)){for(n=[];!(o=i.next()).done;)n.push(o.value);return n}if(null==e)return[e];if("number"==typeof(t=e.length)){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var C=[].concat;function x(){}function L(e){return e}function I(e,t){return null==e||e===L?t:function(n){return t(e(n))}}function T(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function U(e,t){return e===x?t:function(){var n=e.apply(this,arguments);void 0!==n&&(arguments[0]=n);var r=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var i=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?T(r,this.onsuccess):r),o&&(this.onerror=this.onerror?T(o,this.onerror):o),void 0!==i?i:n}}function A(e,t){return e===x?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?T(n,this.onsuccess):n),r&&(this.onerror=this.onerror?T(r,this.onerror):r)}}function D(e,t){return e===x?t:function(n){var r=e.apply(this,arguments);i(n,r);var o=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return o&&(this.onsuccess=this.onsuccess?T(o,this.onsuccess):o),s&&(this.onerror=this.onerror?T(s,this.onerror):s),void 0===r?void 0===a?void 0:a:i(r,a)}}function N(e,t){return e===x?t:function(){return!1!==t.apply(this,arguments)&&e.apply(this,arguments)}}function H(e,t){return e===x?t:function(){var n=e.apply(this,arguments);if(n&&"function"==typeof n.then){for(var r=this,o=arguments.length,i=new Array(o);o--;)i[o]=arguments[o];return n.then(function(){return t.apply(r,i)})}return t.apply(this,arguments)}}var B="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function F(e,t){B=e,K=t}var K=function(){return!0},q=!new Error("").stack;function G(){if(q)try{throw G.arguments,new Error}catch(e){return e}return new Error}function V(e,t){var n=e.stack;return n?(t=t||0,0===n.indexOf(e.name)&&(t+=(e.name+e.message).split("\n").length),n.split("\n").slice(t).filter(K).map(function(e){return"\n"+e}).join("")):""}function W(e,t){return function(){return console.warn(e+" is deprecated. See https://github.com/dfahlander/Dexie.js/wiki/Deprecations. "+V(G(),1)),t.apply(this,arguments)}}var J=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Y=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","IncompatiblePromise"].concat(J),z={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed"};function $(e,t){this._e=G(),this.name=e,this.message=t}function Q(e,t,n,r){this._e=G(),this.failures=t,this.failedKeys=r,this.successCount=n}function X(e,t){this._e=G(),this.name="BulkError",this.failures=t,this.message=function(e,t){return e+". Errors: "+t.map(function(e){return e.toString()}).filter(function(e,t,n){return n.indexOf(e)===t}).join("\n")}(e,t)}f($).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+V(this._e,2))}},toString:function(){return this.name+": "+this.message}}),f(Q).from($),f(X).from($);var Z=Y.reduce(function(e,t){return e[t]=t+"Error",e},{}),ee=$,te=Y.reduce(function(e,t){var n=t+"Error";function r(e,r){this._e=G(),this.name=n,e?"string"==typeof e?(this.message=e,this.inner=r||null):"object"==typeof e&&(this.message=e.name+" "+e.message,this.inner=e):(this.message=z[t]||n,this.inner=null)}return f(r).from(ee),e[t]=r,e},{});te.Syntax=SyntaxError,te.Type=TypeError,te.Range=RangeError;var ne=J.reduce(function(e,t){return e[t+"Error"]=te[t],e},{}),re=Y.reduce(function(e,t){return-1===["Syntax","Type","Range"].indexOf(t)&&(e[t+"Error"]=te[t]),e},{});function oe(t){var n={},o=function(e,r){if(r){for(var o=arguments.length,i=new Array(o-1);--o;)i[o-1]=arguments[o];return n[e].subscribe.apply(null,i),t}if("string"==typeof e)return n[e]};o.addEventType=a;for(var i=1,s=arguments.length;i<s;++i)a(arguments[i]);return o;function a(t,i,s){if("object"==typeof t)return function(t){e(t).forEach(function(e){var n=t[e];if(r(n))a(e,t[e][0],t[e][1]);else{if("asap"!==n)throw new te.InvalidArgument("Invalid event config");var o=a(e,L,function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];o.subscribers.forEach(function(e){g(function(){e.apply(null,t)})})})}})}(t);i||(i=N),s||(s=x);var c={subscribers:[],fire:s,subscribe:function(e){-1===c.subscribers.indexOf(e)&&(c.subscribers.push(e),c.fire=i(c.fire,e))},unsubscribe:function(e){c.subscribers=c.subscribers.filter(function(t){return t!==e}),c.fire=c.subscribers.reduce(i,s)}};return n[t]=o[t]=c,c}}re.ModifyError=Q,re.DexieError=$,re.BulkError=X;var ie={},se=100,ae=!1,ce=o.setImmediate?n.bind(null,Ee):o.MutationObserver?function(){var e=document.createElement("div");new MutationObserver(function(){Ee(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(Ee,0)},ue=function(e,t){be.push([e,t]),fe&&(ce(),fe=!1)},le=!0,fe=!0,de=[],he=[],ye=null,pe=L,ve={global:!0,ref:0,unhandleds:[],onunhandled:De,finalize:function(){this.unhandleds.forEach(function(e){try{De(e[0],e[1])}catch(e){}})}},be=[],ge=0,me=[];function _e(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=x,this._lib=!1;var t=this._PSD=ve;if(B&&(this._stackHolder=G(),this._prev=null,this._numPrev=0,je(this,ye)),"function"!=typeof e){if(e!==ie)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(!1===this._state&&ke(this,this._value))}this._state=null,this._value=null,++t.ref,function e(t,n){try{n(function(n){if(null===t._state){if(n===t)throw new TypeError("A promise cannot be resolved with itself.");var r=t._lib&&Me();n&&"function"==typeof n.then?e(t,function(e,t){n instanceof _e?n._then(e,t):n.then(e,t)}):(t._state=!0,t._value=n,Re(t)),r&&Ce()}},ke.bind(null,t))}catch(e){ke(t,e)}}(this,e)}function we(e,t,n,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=r,this.psd=ve}u(_e.prototype,{then:function(e,t){var n=this,r=new _e(function(r,o){Pe(n,new we(e,t,r,o))});return B&&(!this._prev||null===this._state)&&je(r,this),r},_then:function(e,t){Pe(this,new we(null,null,e,t))},catch:function(e){if(1===arguments.length)return this.then(null,e);var t=arguments[0],n=arguments[1];return"function"==typeof t?this.then(null,function(e){return e instanceof t?n(e):Le(e)}):this.then(null,function(e){return e&&e.name===t?n(e):Le(e)})},finally:function(e){return this.then(function(t){return e(),t},function(t){return e(),Le(t)})},uncaught:function(e){var t=this;return this.onuncatched=N(this.onuncatched,e),!1===this._state&&-1===de.indexOf(this)&&de.some(function(e,n,r){return e._value===t._value&&(r[n]=t)}),this},stack:{get:function(){if(this._stack)return this._stack;try{ae=!0;var e=function e(t,n,r){if(n.length===r)return n;var o="";if(!1===t._state){var i,s,a=t._value;null!=a?(i=a.name||"Error",s=a.message||a,o=V(a,0)):(i=a,s=""),n.push(i+(s?": "+s:"")+o)}return B&&((o=V(t._stackHolder,2))&&-1===n.indexOf(o)&&n.push(o),t._prev&&e(t._prev,n,r)),n}(this,[],20).join("\nFrom previous: ");return null!==this._state&&(this._stack=e),e}finally{ae=!1}}}}),u(_e,{all:function(){var e=M.apply(null,arguments);return new _e(function(t,n){0===e.length&&t([]);var r=e.length;e.forEach(function(o,i){return _e.resolve(o).then(function(n){e[i]=n,--r||t(e)},n)})})},resolve:function(e){return e instanceof _e?e:e&&"function"==typeof e.then?new _e(function(t,n){e.then(t,n)}):new _e(ie,!0,e)},reject:Le,race:function(){var e=M.apply(null,arguments);return new _e(function(t,n){e.map(function(e){return _e.resolve(e).then(t,n)})})},PSD:{get:function(){return ve},set:function(e){return ve=e}},newPSD:Te,usePSD:Ue,scheduler:{get:function(){return ue},set:function(e){ue=e}},rejectionMapper:{get:function(){return pe},set:function(e){pe=e}},follow:function(e){return new _e(function(t,n){return Te(function(t,n){var r=ve;r.unhandleds=[],r.onunhandled=n,r.finalize=T(function(){var e=this;!function(e){me.push(function t(){e(),me.splice(me.indexOf(t),1)}),++ge,ue(function(){0==--ge&&xe()},[])}(function(){0===e.unhandleds.length?t():n(e.unhandleds[0])})},r.finalize),e()},t,n)})},on:oe(null,{error:[N,function(e){console.warn("Unhandled rejection: "+(e.stack||e))}]})});var Oe=_e.on.error;function ke(e,t){if(he.push(t),null===e._state){var n=e._lib&&Me();t=pe(t),e._state=!1,e._value=t,B&&null!==t&&"object"==typeof t&&!t._promise&&_(function(){var n=function e(t,n){var r;return d(t,n)||(r=s(t))&&e(r,n)}(t,"stack");t._promise=e,l(t,"stack",{get:function(){return ae?n&&(n.get?n.get.apply(t):n.value):e.stack}})}),function(e){de.some(function(t){return t._value===e._value})||de.push(e)}(e),Re(e),n&&Ce()}}function Re(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)Pe(e,t[n]);var o=e._PSD;--o.ref||o.finalize(),0===ge&&(++ge,ue(function(){0==--ge&&xe()},[]))}function Pe(e,t){if(null!==e._state){var n=e._state?t.onFulfilled:t.onRejected;if(null===n)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++ge,ue(Se,[n,e,t])}else e._listeners.push(t)}function Se(e,t,n){var r=ve,o=n.psd;try{o!==r&&(ve=o),ye=t;var i,s=t._value;t._state?i=e(s):(he.length&&(he=[]),i=e(s),-1===he.indexOf(s)&&function(e){for(var t=de.length;t;)if(de[--t]._value===e._value)return void de.splice(t,1)}(t)),n.resolve(i)}catch(e){n.reject(e)}finally{o!==r&&(ve=r),ye=null,0==--ge&&xe(),--o.ref||o.finalize()}}function je(e,t){var n=t?t._numPrev+1:0;n<se&&(e._prev=t,e._numPrev=n)}function Ee(){Me()&&Ce()}function Me(){var e=le;return le=!1,fe=!1,e}function Ce(){var e,t,n;do{for(;be.length>0;)for(e=be,be=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}}while(be.length>0);le=!0,fe=!0}function xe(){var e=de;de=[],e.forEach(function(e){e._PSD.onunhandled.call(null,e._value,e)});for(var t=me.slice(0),n=t.length;n;)t[--n]()}function Le(e){return new _e(ie,!1,e)}function Ie(e,t){var n=ve;return function(){var r=Me(),o=ve;try{return o!==n&&(ve=n),e.apply(this,arguments)}catch(e){t&&t(e)}finally{o!==n&&(ve=o),r&&Ce()}}}function Te(e,t,n,r){var o=ve,i=Object.create(o);i.parent=o,i.ref=0,i.global=!1,++o.ref,i.finalize=function(){--this.parent.ref||this.parent.finalize()};var s=Ue(i,e,t,n,r);return 0===i.ref&&i.finalize(),s}function Ue(e,t,n,r,o){var i=ve;try{return e!==i&&(ve=e),t(n,r,o)}finally{e!==i&&(ve=i)}}Oe.subscribe=W("Promise.on('error')",Oe.subscribe),Oe.unsubscribe=W("Promise.on('error').unsubscribe",Oe.unsubscribe);var Ae="unhandledrejection";function De(e,t){var n;try{n=t.onuncatched(e)}catch(e){}if(!1!==n)try{var r,s={promise:t,reason:e};if(o.document&&document.createEvent?((r=document.createEvent("Event")).initEvent(Ae,!0,!0),i(r,s)):o.CustomEvent&&i(r=new CustomEvent(Ae,{detail:s}),s),r&&o.dispatchEvent&&(dispatchEvent(r),!o.PromiseRejectionEvent&&o.onunhandledrejection))try{o.onunhandledrejection(r)}catch(e){}r.defaultPrevented||_e.on.error.fire(e,t)}catch(e){}}function Ne(e,t){var n=_e.reject(e);return t?n.uncaught(t):n}v(function(){ue=function(e,t){setTimeout(function(){e.apply(null,t)},0)}});var He=String.fromCharCode(65535),Be=function(){try{return IDBKeyRange.only([[]]),[[]]}catch(e){return He}}(),Fe="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Ke="String expected.",qe=[],Ge="undefined"!=typeof navigator&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Ve=Ge,We=Ge,Je=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)};function Ye(t,n){var o,s,a,d=Ye.dependencies,h=i({addons:Ye.addons,autoOpen:!0,indexedDB:d.indexedDB,IDBKeyRange:d.IDBKeyRange},n),g=h.addons,S=h.autoOpen,j=h.indexedDB,T=h.IDBKeyRange,N=this._dbSchema={},F=[],K=[],q={},V=null,J=null,Y=!1,z=!1,$="readwrite",Z=this,ee=new _e(function(e){o=e}),ne=new _e(function(e,t){s=t}),re=!0,ie=!!ut(j);function se(e){this._cfg={version:e,storesSource:null,dbschema:{},tables:{},contentUpgrade:null},this.stores({})}function ae(t,n,r){var o=Z._createTransaction($,K,N);o.create(n),o._completion.catch(r);var i=o._reject.bind(o);Te(function(){ve.trans=o,0===t?(e(N).forEach(function(e){ce(n,e,N[e].primKey,N[e].indexes)}),_e.follow(function(){return Z.on.populate.fire(o)}).catch(i)):function(t,n,r){var o=[],i=F.filter(function(e){return e._cfg.version===t})[0];if(!i)throw new te.Upgrade("Dexie specification of currently installed DB version is missing");N=Z._dbSchema=i._cfg.dbschema;var s=!1;return F.filter(function(e){return e._cfg.version>t}).forEach(function(e){o.push(function(){var t=N,o=e._cfg.dbschema;De(t,r),De(o,r),N=Z._dbSchema=o;var i=function(e,t){var n={del:[],add:[],change:[]};for(var r in e)t[r]||n.del.push(r);for(r in t){var o=e[r],i=t[r];if(o){var s={name:r,def:i,recreate:!1,del:[],add:[],change:[]};if(o.primKey.src!==i.primKey.src)s.recreate=!0,n.change.push(s);else{var a=o.idxByName,c=i.idxByName;for(var u in a)c[u]||s.del.push(u);for(u in c){var l=a[u],f=c[u];l?l.src!==f.src&&s.change.push(f):s.add.push(f)}(s.del.length>0||s.add.length>0||s.change.length>0)&&n.change.push(s)}}else n.add.push([r,i])}return n}(t,o);if(i.add.forEach(function(e){ce(r,e[0],e[1].primKey,e[1].indexes)}),i.change.forEach(function(e){if(e.recreate)throw new te.Upgrade("Not yet support for changing primary key");var t=r.objectStore(e.name);e.add.forEach(function(e){ue(t,e)}),e.change.forEach(function(e){t.deleteIndex(e.name),ue(t,e)}),e.del.forEach(function(e){t.deleteIndex(e)})}),e._cfg.contentUpgrade)return s=!0,_e.follow(function(){e._cfg.contentUpgrade(n)})}),o.push(function(t){s&&Ve||function(e,t){for(var n=0;n<t.db.objectStoreNames.length;++n){var r=t.db.objectStoreNames[n];null==e[r]&&t.db.deleteObjectStore(r)}}(e._cfg.dbschema,t)})}),function e(){return o.length?_e.resolve(o.shift()(n.idbtrans)).then(e):_e.resolve()}().then(function(){var t,n;n=r,e(t=N).forEach(function(e){n.db.objectStoreNames.contains(e)||ce(n,e,t[e].primKey,t[e].indexes)})})}(t,o,n).catch(i)})}function ce(e,t,n,r){var o=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(e){ue(o,e)}),o}function ue(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function le(e){return Z.on.error.fire(e)}function fe(e,t,n){if(z||ve.letThrough){var r=Z._createTransaction(e,t,N);return r._promise(e,function(e,t){Te(function(){ve.trans=r,n(e,t,r)})}).then(function(e){return r._completion.then(function(){return e})})}if(!Y){if(!S)return Ne(new te.DatabaseClosed,le);Z.open().catch(x)}return ee.then(function(){return fe(e,t,n)})}function de(e,t,n){this.name=e,this.schema=t,this.hook=q[e]?q[e].hook:oe(null,{creating:[U,x],reading:[I,L],updating:[D,x],deleting:[A,x]}),this._collClass=n||me}function he(e,t,n){de.call(this,e,t,n||Oe)}function ye(e,t,n){return(n?tt:et)(function(n){e.push(n),t&&t()})}function pe(e,t,n,r,o){return new _e(function(i,s){var a=n.length,c=a-1;if(0===a)return i();if(r){var u,l=tt(s),f=Ze(null);_(function(){for(var r=0;r<a;++r){u={onsuccess:null,onerror:null};var s=n[r];o.call(u,s[0],s[1],t);var d=e.delete(s[0]);d._hookCtx=u,d.onerror=l,d.onsuccess=r===c?Ze(i):f}},function(e){throw u.onerror&&u.onerror(e),e})}else for(var d=0;d<a;++d){var h=e.delete(n[d]);h.onerror=Ie(et(s)),d===c&&(h.onsuccess=Ie(function(){return i()}))}}).uncaught(le)}function be(e,t,n,r){var o=this;this.db=Z,this.mode=e,this.storeNames=t,this.idbtrans=null,this.on=oe(this,"complete","error","abort"),this.parent=r||null,this.active=!0,this._tables=null,this._reculock=0,this._blockedFuncs=[],this._psd=null,this._dbschema=n,this._resolve=null,this._reject=null,this._completion=new _e(function(e,t){o._resolve=e,o._reject=t}).uncaught(le),this._completion.then(function(){o.on.complete.fire()},function(e){return o.on.error.fire(e),o.parent?o.parent._reject(e):o.active&&o.idbtrans&&o.idbtrans.abort(),o.active=!1,Ne(e)})}function ge(e,t,n){this._ctx={table:e,index:":id"===t?null:t,collClass:e._collClass,or:n}}function me(e,t){var n=null,r=null;if(t)try{n=t()}catch(e){r=e}var o=e._ctx,i=o.table;this._ctx={table:i,index:o.index,isPrimKey:!o.index||i.schema.primKey.keyPath&&o.index===i.schema.primKey.name,range:n,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:r,or:o.or,valueMapper:i.hook.reading.fire}}function we(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Oe(){me.apply(this,arguments)}function ke(e,t){return e._cfg.version-t._cfg.version}function Re(e,t,n,r){t.forEach(function(t){var o=Z._tableFactory(n,r[t]);e.forEach(function(e){t in e||(e[t]=o)})})}function Pe(e,t,n,r,o,i){var s=Ie(i?function(e,t,r){return n(i(e),t,r)}:n,o);e.onerror||(e.onerror=et(o)),e.onsuccess=function(e,t){return function(){try{e.apply(this,arguments)}catch(e){t(e)}}}(t?function(){var n=e.result;if(n){var i=function(){n.continue()};t(n,function(e){i=e},r,o)&&s(n.value,n,function(e){i=e}),i()}else r()}:function(){var t=e.result;if(t){var n=function(){t.continue()};s(t.value,t,function(e){n=e}),n()}else r()},o)}function Se(e,t){return j.cmp(e,t)}function je(e,t){return Se(e,t)<0?e:t}function Ee(e,t){return Se(e,t)>0?e:t}function Me(e,t){return j.cmp(e,t)}function Ce(e,t){return j.cmp(t,e)}function xe(e,t){return e<t?-1:e===t?0:1}function Le(e,t){return e>t?-1:e===t?0:1}function Ae(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}function De(e,t){for(var n=t.db.objectStoreNames,r=0;r<n.length;++r){var o=n[r],i=t.objectStore(o);a="getAll"in i;for(var s=0;s<i.indexNames.length;++s){var c=i.indexNames[s],u=i.index(c).keyPath,l="string"==typeof u?u:"["+y(u).join("+")+"]";if(e[o]){var f=e[o].idxByName[l];f&&(f.name=c)}}}}function Ge(e){Z.on("blocked").fire(e),qe.filter(function(e){return e.name===Z.name&&e!==Z&&!e._vcFired}).map(function(t){return t.on("versionchange").fire(e)})}this.version=function(e){if(V||Y)throw new te.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=F.filter(function(t){return t._cfg.version===e})[0];return t||(t=new se(e),F.push(t),F.sort(ke),t)},i(se.prototype,{stores:function(t){this._cfg.storesSource=this._cfg.storesSource?i(this._cfg.storesSource,t):t;var n={};F.forEach(function(e){i(n,e._cfg.storesSource)});var r=this._cfg.dbschema={};return this._parseStoresSpec(n,r),N=Z._dbSchema=r,[q,Z,be.prototype].forEach(function(e){for(var t in e)e[t]instanceof de&&delete e[t]}),Re([q,Z,be.prototype,this._cfg.tables],e(r),$,r),K=e(r),this},upgrade:function(t){var n=this;return ze(function(){t(Z._createTransaction($,e(n._cfg.dbschema),n._cfg.dbschema))}),this._cfg.contentUpgrade=t,this},_parseStoresSpec:function(t,n){e(t).forEach(function(e){if(null!==t[e]){var o={},i=function(e){var t=[];return e.split(",").forEach(function(e){var n=(e=e.trim()).replace(/([&*]|\+\+)/g,""),o=/^\[/.test(n)?n.match(/^\[(.*)\]$/)[1].split("+"):n;t.push(new it(n,o||null,/\&/.test(e),/\*/.test(e),/\+\+/.test(e),r(o),/\./.test(e)))}),t}(t[e]),s=i.shift();if(s.multi)throw new te.Schema("Primary key cannot be multi-valued");s.keyPath&&O(o,s.keyPath,s.auto?0:s.keyPath),i.forEach(function(e){if(e.auto)throw new te.Schema("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new te.Schema("Index must have a name and cannot be an empty string");O(o,e.keyPath,e.compound?e.keyPath.map(function(){return""}):"")}),n[e]=new st(e,s,i,o)}})}}),this._allTables=q,this._tableFactory=function(e,t){return"readonly"===e?new de(t.name,t,me):new he(t.name,t)},this._createTransaction=function(e,t,n,r){return new be(e,t,n,r)},this._whenReady=function(e){return new _e($e||z||ve.letThrough?e:function(t,n){if(!Y){if(!S)return void n(new te.DatabaseClosed);Z.open().catch(x)}ee.then(function(){e(t,n)})}).uncaught(le)},this.verno=0,this.open=function(){if(Y||V)return ee.then(function(){return J?Ne(J,le):Z});B&&(ne._stackHolder=G()),Y=!0,J=null,z=!1;var n=o,r=null;return _e.race([ne,new _e(function(n,o){if(v(function(){return n()}),F.length>0&&(re=!1),!j)throw new te.MissingAPI("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using old Safari versions, make sure to include indexedDB polyfill.");var i=re?j.open(t):j.open(t,Math.round(10*Z.verno));if(!i)throw new te.MissingAPI("IndexedDB API not available");i.onerror=Ie(et(o)),i.onblocked=Ie(Ge),i.onupgradeneeded=Ie(function(e){if(r=i.transaction,re&&!Z._allowEmptyDB){i.onerror=nt,r.abort(),i.result.close();var n=j.deleteDatabase(t);n.onsuccess=n.onerror=Ie(function(){o(new te.NoSuchDatabase("Database "+t+" doesnt exist"))})}else r.onerror=Ie(et(o)),ae((e.oldVersion>Math.pow(2,62)?0:e.oldVersion)/10,r,o)},o),i.onsuccess=Ie(function(){if(r=null,V=i.result,qe.push(Z),re)!function(){if(Z.verno=V.version/10,Z._dbSchema=N={},0!==(K=y(V.objectStoreNames,0)).length){var t=V.transaction(ct(K),"readonly");K.forEach(function(e){for(var n=t.objectStore(e),r=n.keyPath,o=r&&"string"==typeof r&&-1!==r.indexOf("."),i=new it(r,r||"",!1,!1,!!n.autoIncrement,r&&"string"!=typeof r,o),s=[],a=0;a<n.indexNames.length;++a){var c=n.index(n.indexNames[a]);o=(r=c.keyPath)&&"string"==typeof r&&-1!==r.indexOf(".");var u=new it(c.name,r,!!c.unique,!!c.multiEntry,!1,r&&"string"!=typeof r,o);s.push(u)}N[e]=new st(e,i,s,{})}),Re([q,be.prototype],e(N),$,N)}}();else if(V.objectStoreNames.length>0)try{De(N,V.transaction(ct(V.objectStoreNames),"readonly"))}catch(e){}V.onversionchange=Ie(function(e){Z._vcFired=!0,Z.on("versionchange").fire(e)}),ie||rt(function(e){if(-1===e.indexOf(t))return e.push(t)}),n()},o)})]).then(function(){return Ye.vip(Z.on.ready.fire)}).then(function(){return Y=!1,Z}).catch(function(e){try{r&&r.abort()}catch(e){}return Y=!1,Z.close(),Ne(J=e,le)}).finally(function(){z=!0,n()})},this.close=function(){var e=qe.indexOf(Z);if(e>=0&&qe.splice(e,1),V){try{V.close()}catch(e){}V=null}S=!1,J=new te.DatabaseClosed,Y&&s(J),ee=new _e(function(e){o=e}),ne=new _e(function(e,t){s=t})},this.delete=function(){var e=arguments.length>0;return new _e(function(n,r){if(e)throw new te.InvalidArgument("Arguments not allowed in db.delete()");function o(){Z.close();var e=j.deleteDatabase(t);e.onsuccess=Ie(function(){ie||rt(function(e){var n=e.indexOf(t);if(n>=0)return e.splice(n,1)}),n()}),e.onerror=Ie(et(r)),e.onblocked=Ge}Y?ee.then(o):o()}).uncaught(le)},this.backendDB=function(){return V},this.isOpen=function(){return null!==V},this.hasFailed=function(){return null!==J},this.dynamicallyOpened=function(){return re},this.name=t,l(this,"tables",{get:function(){return e(q).map(function(e){return q[e]})}}),this.on=oe(this,"error","populate","blocked","versionchange",{ready:[H,x]}),this.on.error.subscribe=W("Dexie.on.error",this.on.error.subscribe),this.on.error.unsubscribe=W("Dexie.on.error.unsubscribe",this.on.error.unsubscribe),this.on.ready.subscribe=p(this.on.ready.subscribe,function(e){return function(t,n){Ye.vip(function(){z?(J||_e.resolve().then(t),n&&e(t)):(e(t),n||e(function e(){Z.on.ready.unsubscribe(t),Z.on.ready.unsubscribe(e)}))})}}),ze(function(){Z.on("populate").fire(Z._createTransaction($,K,N)),Z.on("error").fire(new Error)}),this.transaction=function(e,t,n){var r=arguments.length;if(r<2)throw new te.InvalidArgument("Too few arguments");for(var o=new Array(r-1);--r;)o[r-1]=arguments[r];n=o.pop();var i=function(e){return C.apply([],e)}(o),s=ve.trans;s&&s.db===Z&&-1===e.indexOf("!")||(s=null);var a=-1!==e.indexOf("?");e=e.replace("!","").replace("?","");try{var u=i.map(function(e){var t=e instanceof de?e.name:e;if("string"!=typeof t)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return t});if("r"==e||"readonly"==e)e="readonly";else{if("rw"!=e&&e!=$)throw new te.InvalidArgument("Invalid transaction mode: "+e);e=$}if(s){if("readonly"===s.mode&&e===$){if(!a)throw new te.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&u.forEach(function(e){if(s&&-1===s.storeNames.indexOf(e)){if(!a)throw new te.SubTransaction("Table "+e+" not included in parent transaction.");s=null}})}}catch(e){return s?s._promise(null,function(t,n){n(e)}):Ne(e,le)}return s?s._promise(e,l,"lock"):Z._whenReady(l);function l(t){var r=ve;t(_e.resolve().then(function(){return Te(function(){ve.transless=ve.transless||r;var t=Z._createTransaction(e,u,N,s);ve.trans=t,s?t.idbtrans=s.idbtrans:t.create();var o,i=u.map(function(e){return q[e]});return i.push(t),_e.follow(function(){if(o=n.apply(t,i))if("function"==typeof o.next&&"function"==typeof o.throw)o=ot(o);else if("function"==typeof o.then&&!c(o,"_PSD"))throw new te.IncompatiblePromise("Incompatible Promise returned from transaction scope (read more at http://tinyurl.com/znyqjqc). Transaction scope: "+n.toString())}).uncaught(le).then(function(){return s&&t._resolve(),t._completion}).then(function(){return o}).catch(function(e){return t._reject(e),Ne(e)})})}))}},this.table=function(e){if($e&&re)return new he(e);if(!c(q,e))throw new te.InvalidTable("Table "+e+" does not exist");return q[e]},u(de.prototype,{_trans:function(e,t,n){var r=ve.trans;return r&&r.db===Z?r._promise(e,t,n):fe(e,[this.name],t)},_idbstore:function(e,t,n){if($e)return new _e(t);var r=ve.trans,o=this.name;function i(e,n,r){t(e,n,r.idbtrans.objectStore(o),r)}return r&&r.db===Z?r._promise(e,i,n):fe(e,[this.name],i)},get:function(e,t){var n=this;return this._idbstore("readonly",function(t,r,o){$e&&t(n.schema.instanceTemplate);var i=o.get(e);i.onerror=et(r),i.onsuccess=Ie(function(){t(n.hook.reading.fire(i.result))},r)}).then(t)},where:function(e){return new ge(this,e)},count:function(e){return this.toCollection().count(e)},offset:function(e){return this.toCollection().offset(e)},limit:function(e){return this.toCollection().limit(e)},reverse:function(){return this.toCollection().reverse()},filter:function(e){return this.toCollection().and(e)},each:function(e){return this.toCollection().each(e)},toArray:function(e){return this.toCollection().toArray(e)},orderBy:function(e){return new this._collClass(new ge(this,e))},toCollection:function(){return new this._collClass(new ge(this))},mapToClass:function(e,t){this.schema.mappedClass=e;var n=Object.create(e.prototype);t&&Qe(n,t),this.schema.instanceTemplate=n;var r=function(t){if(!t)return t;var n=Object.create(e.prototype);for(var r in t)if(c(t,r))try{n[r]=t[r]}catch(e){}return n};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=r,this.hook("reading",r),e},defineClass:function(e){return this.mapToClass(Ye.defineClass(e),e)}}),f(he).from(de).extend({bulkDelete:function(e){return this.hook.deleting.fire===x?this._idbstore($,function(t,n,r,o){t(pe(r,o,e,!1,x))}):this.where(":id").anyOf(e).delete().then(function(){})},bulkPut:function(e,t){var n=this;return this._idbstore($,function(r,o,i){if(!i.keyPath&&!n.schema.primKey.auto&&!t)throw new te.InvalidArgument("bulkPut() with non-inbound keys requires keys array in second argument");if(i.keyPath&&t)throw new te.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(t&&t.length!==e.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");if(0===e.length)return r();var s,a,c=function(e){0===u.length?r(e):o(new X(n.name+".bulkPut(): "+u.length+" of "+l+" operations failed",u))},u=[],l=e.length,f=n;if(n.hook.creating.fire===x&&n.hook.updating.fire===x){a=ye(u);for(var d=0,h=e.length;d<h;++d)(s=t?i.put(e[d],t[d]):i.put(e[d])).onerror=a;s.onerror=ye(u,c),s.onsuccess=Xe(c)}else{var y=t||i.keyPath&&e.map(function(e){return w(e,i.keyPath)}),p=y&&m(y,function(t,n){return null!=t&&[t,e[n]]});(y?f.where(":id").anyOf(y.filter(function(e){return null!=e})).modify(function(){this.value=p[this.primKey],p[this.primKey]=null}).catch(Q,function(e){u=e.failures}).then(function(){for(var n=[],r=t&&[],o=y.length-1;o>=0;--o){var i=y[o];(null==i||p[i])&&(n.push(e[o]),t&&r.push(i),null!=i&&(p[i]=null))}return n.reverse(),t&&r.reverse(),f.bulkAdd(n,r)}).then(function(e){var t=y[y.length-1];return null!=t?t:e}):f.bulkAdd(e)).then(c).catch(X,function(e){u=u.concat(e.failures),c()}).catch(o)}},"locked")},bulkAdd:function(e,t){var n=this,r=this.hook.creating.fire;return this._idbstore($,function(o,i,s,a){if(!s.keyPath&&!n.schema.primKey.auto&&!t)throw new te.InvalidArgument("bulkAdd() with non-inbound keys requires keys array in second argument");if(s.keyPath&&t)throw new te.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(t&&t.length!==e.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");if(0===e.length)return o();function c(e){0===d.length?o(e):i(new X(n.name+".bulkAdd(): "+d.length+" of "+h+" operations failed",d))}var u,l,f,d=[],h=e.length;if(r!==x){var y,p=s.keyPath;l=ye(d,null,!0),f=Ze(null),_(function(){for(var n=0,o=e.length;n<o;++n){y={onerror:null,onsuccess:null};var i=t&&t[n],c=e[n],d=t?i:p?w(c,p):void 0,h=r.call(y,d,c,a);null==d&&null!=h&&(p?O(c=R(c),p,h):i=h),(u=null!=i?s.add(c,i):s.add(c))._hookCtx=y,n<o-1&&(u.onerror=l,y.onsuccess&&(u.onsuccess=f))}},function(e){throw y.onerror&&y.onerror(e),e}),u.onerror=ye(d,c,!0),u.onsuccess=Ze(c)}else{l=ye(d);for(var v=0,b=e.length;v<b;++v)(u=t?s.add(e[v],t[v]):s.add(e[v])).onerror=l;u.onerror=ye(d,c),u.onsuccess=Xe(c)}})},add:function(e,t){var n=this.hook.creating.fire;return this._idbstore($,function(r,o,i,s){var a={onsuccess:null,onerror:null};if(n!==x){var c=null!=t?t:i.keyPath?w(e,i.keyPath):void 0,u=n.call(a,c,e,s);null==c&&null!=u&&(i.keyPath?O(e,i.keyPath,u):t=u)}try{var l=null!=t?i.add(e,t):i.add(e);l._hookCtx=a,l.onerror=tt(o),l.onsuccess=Ze(function(t){var n=i.keyPath;n&&O(e,n,t),r(t)})}catch(e){throw a.onerror&&a.onerror(e),e}})},put:function(e,t){var n=this,r=this.hook.creating.fire,o=this.hook.updating.fire;return r!==x||o!==x?this._trans($,function(r,o,i){var s=void 0!==t?t:n.schema.primKey.keyPath&&w(e,n.schema.primKey.keyPath);null==s?n.add(e).then(r,o):(i._lock(),e=R(e),n.where(":id").equals(s).modify(function(){this.value=e}).then(function(r){return 0===r?n.add(e,t):s}).finally(function(){i._unlock()}).then(r,o))}):this._idbstore($,function(n,r,o){var i=void 0!==t?o.put(e,t):o.put(e);i.onerror=et(r),i.onsuccess=function(t){var r=o.keyPath;r&&O(e,r,t.target.result),n(i.result)}})},delete:function(e){return this.hook.deleting.subscribers.length?this.where(":id").equals(e).delete():this._idbstore($,function(t,n,r){var o=r.delete(e);o.onerror=et(n),o.onsuccess=function(){t(o.result)}})},clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore($,function(e,t,n){var r=n.clear();r.onerror=et(t),r.onsuccess=function(){e(r.result)}})},update:function(t,n){if("object"!=typeof n||r(n))throw new te.InvalidArgument("Modifications must be an object.");if("object"!=typeof t||r(t))return this.where(":id").equals(t).modify(n);e(n).forEach(function(e){O(t,e,n[e])});var o=w(t,this.schema.primKey.keyPath);return void 0===o?Ne(new te.InvalidArgument("Given object does not contain its primary key"),le):this.where(":id").equals(o).modify(n)}}),u(be.prototype,{_lock:function(){return b(!ve.global),++this._reculock,1!==this._reculock||ve.global||(ve.lockOwnerFor=this),this},_unlock:function(){if(b(!ve.global),0==--this._reculock)for(ve.global||(ve.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{Ue(e[1],e[0])}catch(e){}}return this},_locked:function(){return this._reculock&&ve.lockOwnerFor!==this},create:function(e){var t=this;if(b(!this.idbtrans),!e&&!V)switch(J&&J.name){case"DatabaseClosedError":throw new te.DatabaseClosed(J);case"MissingAPIError":throw new te.MissingAPI(J.message,J);default:throw new te.OpenFailed(J)}if(!this.active)throw new te.TransactionInactive;return b(null===this._completion._state),(e=this.idbtrans=e||V.transaction(ct(this.storeNames),this.mode)).onerror=Ie(function(n){nt(n),t._reject(e.error)}),e.onabort=Ie(function(e){nt(e),t.active&&t._reject(new te.Abort),t.active=!1,t.on("abort").fire(e)}),e.oncomplete=Ie(function(){t.active=!1,t._resolve()}),this},_promise:function(e,t,n){var r=this,o=r._locked()?new _e(function(o,i){r._blockedFuncs.push([function(){r._promise(e,t,n).then(o,i)},ve])}):Te(function(){var o=r.active?new _e(function(o,i){if(e===$&&r.mode!==$)throw new te.ReadOnly("Transaction is readonly");!r.idbtrans&&e&&r.create(),n&&r._lock(),t(o,i,r)}):Ne(new te.TransactionInactive);return r.active&&n&&o.finally(function(){r._unlock()}),o});return o._lib=!0,o.uncaught(le)},abort:function(){this.active&&this._reject(new te.Abort),this.active=!1},tables:{get:W("Transaction.tables",function(){return m(this.storeNames,function(e){return[e,q[e]]})})},complete:W("Transaction.complete()",function(e){return this.on("complete",e)}),error:W("Transaction.error()",function(e){return this.on("error",e)}),table:W("Transaction.table()",function(e){if(-1===this.storeNames.indexOf(e))throw new te.InvalidTable("Table "+e+" not in transaction");return q[e]})}),u(ge.prototype,function(){function e(e,t,n){var r=e instanceof ge?new e._ctx.collClass(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function t(e){return new e._ctx.collClass(e,function(){return T.only("")}).limit(0)}function n(e,t,n,r,o,i){for(var s=Math.min(e.length,r.length),a=-1,c=0;c<s;++c){var u=t[c];if(u!==r[c])return o(e[c],n[c])<0?e.substr(0,c)+n[c]+n.substr(c+1):o(e[c],r[c])<0?e.substr(0,c)+r[c]+n.substr(c+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):null;o(e[c],u)<0&&(a=c)}return s<r.length&&"next"===i?e+n.substr(e.length):s<e.length&&"prev"===i?e.substr(0,n.length):a<0?null:e.substr(0,a)+r[a]+n.substr(a+1)}function r(t,r,o,i){var s,a,c,u,l,f,d,h=o.length;if(!o.every(function(e){return"string"==typeof e}))return e(t,Ke);function y(e){s=function(e){return"next"===e?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}(e),a=function(e){return"next"===e?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}(e),c="next"===e?xe:Le;var t=o.map(function(e){return{lower:a(e),upper:s(e)}}).sort(function(e,t){return c(e.lower,t.lower)});u=t.map(function(e){return e.upper}),l=t.map(function(e){return e.lower}),f=e,d="next"===e?"":i}y("next");var p=new t._ctx.collClass(t,function(){return T.bound(u[0],l[h-1]+i)});p._ondirectionchange=function(e){y(e)};var v=0;return p._addAlgorithm(function(e,t,o){var i=e.key;if("string"!=typeof i)return!1;var s=a(i);if(r(s,l,v))return!0;for(var y=null,p=v;p<h;++p){var b=n(i,s,u[p],l[p],c,f);null===b&&null===y?v=p+1:(null===y||c(y,b)>0)&&(y=b)}return t(null!==y?function(){e.continue(y+d)}:o),!1}),p}return{between:function(n,r,o,i){o=!1!==o,i=!0===i;try{return Se(n,r)>0||0===Se(n,r)&&(o||i)&&(!o||!i)?t(this):new this._ctx.collClass(this,function(){return T.bound(n,r,!o,!i)})}catch(t){return e(this,Fe)}},equals:function(e){return new this._ctx.collClass(this,function(){return T.only(e)})},above:function(e){return new this._ctx.collClass(this,function(){return T.lowerBound(e,!0)})},aboveOrEqual:function(e){return new this._ctx.collClass(this,function(){return T.lowerBound(e)})},below:function(e){return new this._ctx.collClass(this,function(){return T.upperBound(e,!0)})},belowOrEqual:function(e){return new this._ctx.collClass(this,function(){return T.upperBound(e)})},startsWith:function(t){return"string"!=typeof t?e(this,Ke):this.between(t,t+He,!0,!0)},startsWithIgnoreCase:function(e){return""===e?this.startsWith(e):r(this,function(e,t){return 0===e.indexOf(t[0])},[e],He)},equalsIgnoreCase:function(e){return r(this,function(e,t){return e===t[0]},[e],"")},anyOfIgnoreCase:function(){var e=M.apply(E,arguments);return 0===e.length?t(this):r(this,function(e,t){return-1!==t.indexOf(e)},e,"")},startsWithAnyOfIgnoreCase:function(){var e=M.apply(E,arguments);return 0===e.length?t(this):r(this,function(e,t){return t.some(function(t){return 0===e.indexOf(t)})},e,He)},anyOf:function(){var n=M.apply(E,arguments),r=Me;try{n.sort(r)}catch(t){return e(this,Fe)}if(0===n.length)return t(this);var o=new this._ctx.collClass(this,function(){return T.bound(n[0],n[n.length-1])});o._ondirectionchange=function(e){r="next"===e?Me:Ce,n.sort(r)};var i=0;return o._addAlgorithm(function(e,t,o){for(var s=e.key;r(s,n[i])>0;)if(++i===n.length)return t(o),!1;return 0===r(s,n[i])||(t(function(){e.continue(n[i])}),!1)}),o},notEqual:function(e){return this.inAnyRange([[-1/0,e],[e,Be]],{includeLowers:!1,includeUppers:!1})},noneOf:function(){var t=M.apply(E,arguments);if(0===t.length)return new this._ctx.collClass(this);try{t.sort(Me)}catch(t){return e(this,Fe)}var n=t.reduce(function(e,t){return e?e.concat([[e[e.length-1][1],t]]):[[-1/0,t]]},null);return n.push([t[t.length-1],Be]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})},inAnyRange:function(n,r){var o=this._ctx;if(0===n.length)return t(this);if(!n.every(function(e){return void 0!==e[0]&&void 0!==e[1]&&Me(e[0],e[1])<=0}))return e(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",te.InvalidArgument);var i,s=!r||!1!==r.includeLowers,a=r&&!0===r.includeUppers,c=Me;function u(e,t){return c(e[0],t[0])}try{(i=n.reduce(function(e,t){for(var n=0,r=e.length;n<r;++n){var o=e[n];if(Se(t[0],o[1])<0&&Se(t[1],o[0])>0){o[0]=je(o[0],t[0]),o[1]=Ee(o[1],t[1]);break}}return n===r&&e.push(t),e},[])).sort(u)}catch(t){return e(this,Fe)}var l=0,f=a?function(e){return Me(e,i[l][1])>0}:function(e){return Me(e,i[l][1])>=0},d=s?function(e){return Ce(e,i[l][0])>0}:function(e){return Ce(e,i[l][0])>=0},h=f,y=new o.collClass(this,function(){return T.bound(i[0][0],i[i.length-1][1],!s,!a)});return y._ondirectionchange=function(e){"next"===e?(h=f,c=Me):(h=d,c=Ce),i.sort(u)},y._addAlgorithm(function(e,t,n){for(var r=e.key;h(r);)if(++l===i.length)return t(n),!1;return!!function(e){return!f(e)&&!d(e)}(r)||0!==Se(r,i[l][1])&&0!==Se(r,i[l][0])&&(t(function(){c===Me?e.continue(i[l][0]):e.continue(i[l][1])}),!1)}),y},startsWithAnyOf:function(){var n=M.apply(E,arguments);return n.every(function(e){return"string"==typeof e})?0===n.length?t(this):this.inAnyRange(n.map(function(e){return[e,e+He]})):e(this,"startsWithAnyOf() only works with strings")}}}),u(me.prototype,function(){function e(e,t){e.filter=Ae(e.filter,t)}function t(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return Ae(r(),t())}:t,e.justLimit=n&&!r}function n(e,t){if(e.isPrimKey)return t;var n=e.table.schema.idxByName[e.index];if(!n)throw new te.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return t.index(n.name)}function r(e,t){var r=n(e,t);return e.keysOnly&&"openKeyCursor"in r?r.openKeyCursor(e.range||null,e.dir+e.unique):r.openCursor(e.range||null,e.dir+e.unique)}function o(e,t,n,o,i){var s=e.replayFilter?Ae(e.filter,e.replayFilter()):e.filter;e.or?function(){var a={},u=0;function l(){2==++u&&n()}function f(e,n,r){if(!s||s(n,r,l,o)){var i=n.primaryKey.toString();c(a,i)||(a[i]=!0,t(e,n,r))}}e.or._iterate(f,l,o,i),Pe(r(e,i),e.algorithm,f,l,o,!e.keysOnly&&e.valueMapper)}():Pe(r(e,i),Ae(e.algorithm,s),t,n,o,!e.keysOnly&&e.valueMapper)}function s(e){return e.table.schema.instanceTemplate}return{_read:function(e,t){var n=this._ctx;return n.error?n.table._trans(null,function(e,t){t(n.error)}):n.table._idbstore("readonly",e).then(t)},_write:function(e){var t=this._ctx;return t.error?t.table._trans(null,function(e,n){n(t.error)}):t.table._idbstore($,e,"locked")},_addAlgorithm:function(e){var t=this._ctx;t.algorithm=Ae(t.algorithm,e)},_iterate:function(e,t,n,r){return o(this._ctx,e,t,n,r)},clone:function(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&i(n,e),t._ctx=n,t},raw:function(){return this._ctx.valueMapper=null,this},each:function(e){var t=this._ctx;if($e){var n=s(t),r=t.table.schema.primKey.keyPath,i=w(n,t.index?t.table.schema.idxByName[t.index].keyPath:r),a=w(n,r);e(n,{key:i,primaryKey:a})}return this._read(function(n,r,i){o(t,e,n,r,i)})},count:function(e){if($e)return _e.resolve(0).then(e);var t=this._ctx;if(we(t,!0))return this._read(function(e,r,o){var i=n(t,o),s=t.range?i.count(t.range):i.count();s.onerror=et(r),s.onsuccess=function(n){e(Math.min(n.target.result,t.limit))}},e);var r=0;return this._read(function(e,n,i){o(t,function(){return++r,!1},function(){e(r)},n,i)},e)},sortBy:function(e,t){var n=e.split(".").reverse(),r=n[0],o=n.length-1;function i(e,t){return t?i(e[n[t]],t-1):e[r]}var s="next"===this._ctx.dir?1:-1;function a(e,t){var n=i(e,o),r=i(t,o);return n<r?-s:n>r?s:0}return this.toArray(function(e){return e.sort(a)}).then(t)},toArray:function(e){var t=this._ctx;return this._read(function(e,r,i){if($e&&e([s(t)]),a&&"next"===t.dir&&we(t,!0)&&t.limit>0){var c=t.table.hook.reading.fire,u=n(t,i),l=t.limit<1/0?u.getAll(t.range,t.limit):u.getAll(t.range);l.onerror=et(r),l.onsuccess=c===L?Xe(e):Ie(Xe(function(t){try{e(t.map(c))}catch(e){r(e)}}))}else{var f=[];o(t,function(e){f.push(e)},function(){e(f)},r,i)}},e)},offset:function(e){var n=this._ctx;return e<=0?this:(n.offset+=e,we(n)?t(n,function(){var t=e;return function(e,n){return 0===t||(1===t?(--t,!1):(n(function(){e.advance(t),t=0}),!1))}}):t(n,function(){var t=e;return function(){return--t<0}}),this)},limit:function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),t(this._ctx,function(){var t=e;return function(e,n,r){return--t<=0&&n(r),t>=0}},!0),this},until:function(t,n){var r=this._ctx;return $e&&t(s(r)),e(this._ctx,function(e,r,o){return!t(e.value)||(r(o),n)}),this},first:function(e){return this.limit(1).toArray(function(e){return e[0]}).then(e)},last:function(e){return this.reverse().first(e)},filter:function(t){return $e&&t(s(this._ctx)),e(this._ctx,function(e){return t(e.value)}),function(e,t){e.isMatch=Ae(e.isMatch,t)}(this._ctx,t),this},and:function(e){return this.filter(e)},or:function(e){return new ge(this._ctx.table,e,this)},reverse:function(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},desc:function(){return this.reverse()},eachKey:function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.key,n)})},eachUniqueKey:function(e){return this._ctx.unique="unique",this.eachKey(e)},eachPrimaryKey:function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.primaryKey,n)})},keys:function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var n=[];return this.each(function(e,t){n.push(t.key)}).then(function(){return n}).then(e)},primaryKeys:function(e){var t=this._ctx;if(a&&"next"===t.dir&&we(t,!0)&&t.limit>0)return this._read(function(e,r,o){var i=n(t,o),s=t.limit<1/0?i.getAllKeys(t.range,t.limit):i.getAllKeys(t.range);s.onerror=et(r),s.onsuccess=Xe(e)}).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(e,t){r.push(t.primaryKey)}).then(function(){return r}).then(e)},uniqueKeys:function(e){return this._ctx.unique="unique",this.keys(e)},firstKey:function(e){return this.limit(1).keys(function(e){return e[0]}).then(e)},lastKey:function(e){return this.reverse().firstKey(e)},distinct:function(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return e(this._ctx,function(e){var t=e.primaryKey.toString(),n=c(r,t);return r[t]=!0,!n}),this}}}),f(Oe).from(me).extend({modify:function(t){var n=this,r=this._ctx,o=r.table.hook,s=o.updating.fire,a=o.deleting.fire;return $e&&"function"==typeof t&&t.call({value:r.table.schema.instanceTemplate},r.table.schema.instanceTemplate),this._write(function(r,o,u,l){var f;if("function"==typeof t)f=s===x&&a===x?t:function(n){var r=R(n);if(!1===t.call(this,n,this))return!1;if(c(this,"value")){var o=P(r,this.value),i=s.call(this,o,this.primKey,r,l);i&&(n=this.value,e(i).forEach(function(e){O(n,e,i[e])}))}else a.call(this,this.primKey,n,l)};else if(s===x){var d=e(t),h=d.length;f=function(e){for(var n=!1,r=0;r<h;++r){var o=d[r],i=t[o];w(e,o)!==i&&(O(e,o,i),n=!0)}return n}}else{var y=t;t=k(y),f=function(n){var r=!1,o=s.call(this,t,this.primKey,R(n),l);return o&&i(t,o),e(t).forEach(function(e){var o=t[e];w(n,e)!==o&&(O(n,e,o),r=!0)}),o&&(t=k(y)),r}}var p=0,v=0,b=!1,g=[],m=[],S=null;function j(e){return e&&(g.push(e),m.push(S)),o(new Q("Error modifying one or more objects",g,v,m))}function E(){b&&v+g.length===p&&(g.length>0?j():r(v))}n.clone().raw()._iterate(function(e,t){S=t.primaryKey;var n={primKey:t.primaryKey,value:e,onsuccess:null,onerror:null};function r(e){return g.push(e),m.push(n.primKey),E(),!0}if(!1!==f.call(n,e,n)){var o=!c(n,"value");++p,_(function(){var e=o?t.delete():t.update(n.value);e._hookCtx=n,e.onerror=tt(r),e.onsuccess=Ze(function(){++v,E()})},r)}else n.onsuccess&&n.onsuccess(n.value)},function(){b=!0,E()},j,u)})},delete:function(){var e=this,t=this._ctx,n=t.range,r=t.table.hook.deleting.fire,o=r!==x;if(!o&&we(t)&&(t.isPrimKey&&!We||!n))return this._write(function(e,t,r){var o=et(t),i=n?r.count(n):r.count();i.onerror=o,i.onsuccess=function(){var s=i.result;_(function(){var t=n?r.delete(n):r.clear();t.onerror=o,t.onsuccess=function(){return e(s)}},function(e){return t(e)})}});var i=o?2e3:1e4;return this._write(function(n,s,a,c){var u=0,l=e.clone({keysOnly:!t.isMatch&&!o}).distinct().limit(i).raw(),f=[],d=function(){return l.each(o?function(e,t){f.push([t.primaryKey,t.value])}:function(e,t){f.push(t.primaryKey)}).then(function(){return o?f.sort(function(e,t){return Me(e[0],t[0])}):f.sort(Me),pe(a,c,f,o,r)}).then(function(){var e=f.length;return f=[],e<i?u+=e:d()})};n(d())})}}),i(this,{Collection:me,Table:de,Transaction:be,Version:se,WhereClause:ge,WriteableCollection:Oe,WriteableTable:he}),Z.on("versionchange",function(e){e.newVersion>0?console.warn("Another connection wants to upgrade database '"+Z.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+Z.name+"'. Closing db now to resume the delete request."),Z.close()}),Z.on("blocked",function(e){!e.newVersion||e.newVersion<e.oldVersion?console.warn("Dexie.delete('"+Z.name+"') was blocked"):console.warn("Upgrade '"+Z.name+"' blocked by other connection holding version "+e.oldVersion/10)}),g.forEach(function(e){e(Z)})}F(B,Je);var ze=function(){},$e=!1;function Qe(t,n){return e(n).forEach(function(e){var o=function e(t){if("function"==typeof t)return new t;if(r(t))return[e(t[0])];if(t&&"object"==typeof t){var n={};return Qe(n,t),n}return t}(n[e]);t[e]=o}),t}function Xe(e){return function(t){e(t.target.result)}}function Ze(e){return Ie(function(t){var n=t.target,r=n.result,o=n._hookCtx,i=o&&o.onsuccess;i&&i(r),e&&e(r)},e)}function et(e){return function(t){return nt(t),e(t.target.error),!1}}function tt(e){return Ie(function(t){var n=t.target,r=n.error,o=n._hookCtx,i=o&&o.onerror;return i&&i(r),nt(t),e(r),!1})}function nt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}function rt(e){var t,n=Ye.dependencies.localStorage;if(!n)return e([]);try{t=JSON.parse(n.getItem("Dexie.DatabaseNames")||"[]")}catch(e){t=[]}e(t)&&n.setItem("Dexie.DatabaseNames",JSON.stringify(t))}function ot(e){var t=function(t){return e.next(t)},n=i(t),o=i(function(t){return e.throw(t)});function i(e){return function(t){var i=e(t),s=i.value;return i.done?s:s&&"function"==typeof s.then?s.then(n,o):r(s)?_e.all(s).then(n,o):n(s)}}return i(t)()}function it(e,t,n,r,o,i,s){this.name=e,this.keyPath=t,this.unique=n,this.multi=r,this.auto=o,this.compound=i,this.dotted=s;var a="string"==typeof t?t:t&&"["+[].join.call(t,"+")+"]";this.src=(n?"&":"")+(r?"*":"")+(o?"++":"")+a}function st(e,t,n,r){this.name=e,this.primKey=t||new it,this.indexes=n||[new it],this.instanceTemplate=r,this.mappedClass=null,this.idxByName=m(n,function(e){return[e.name,e]})}var at=o.idbModules&&o.idbModules.shimIndexedDB?o.idbModules:{};function ct(e){return 1===e.length?e[0]:e}function ut(e){var t=e&&(e.getDatabaseNames||e.webkitGetDatabaseNames);return t&&t.bind(e)}return u(Ye,re),u(Ye,{delete:function(e){var t=new Ye(e),n=t.delete();return n.onblocked=function(e){return t.on("blocked",e),this},n},exists:function(e){return new Ye(e).open().then(function(e){return e.close(),!0}).catch(Ye.NoSuchDatabaseError,function(){return!1})},getDatabaseNames:function(e){return new _e(function(e,t){var n=ut(indexedDB);if(n){var r=n();r.onsuccess=function(t){e(y(t.target.result,0))},r.onerror=et(t)}else rt(function(t){return e(t),!1})}).then(e)},defineClass:function(e){return function(t){t?i(this,t):$e&&Qe(this,e)}},applyStructure:Qe,ignoreTransaction:function(e){return ve.trans?Ue(ve.transless,e):e()},vip:function(e){return Te(function(){return ve.letThrough=!0,e()})},async:function(e){return function(){try{var t=ot(e.apply(this,arguments));return t&&"function"==typeof t.then?t:_e.resolve(t)}catch(e){return Ne(e)}}},spawn:function(e,t,n){try{var r=ot(e.apply(n,t||[]));return r&&"function"==typeof r.then?r:_e.resolve(r)}catch(e){return Ne(e)}},currentTransaction:{get:function(){return ve.trans||null}},Promise:_e,debug:{get:function(){return B},set:function(e){F(e,"dexie"===e?function(){return!0}:Je)}},derive:f,extend:i,props:u,override:p,Events:oe,events:{get:W(function(){return oe})},getByKeyPath:w,setByKeyPath:O,delByKeyPath:function(e,t){"string"==typeof t?O(e,t,void 0):"length"in t&&[].map.call(t,function(t){O(e,t,void 0)})},shallowClone:k,deepClone:R,getObjectDiff:P,asap:g,maxKey:Be,addons:[],connections:qe,MultiModifyError:te.Modify,errnames:Z,IndexSpec:it,TableSchema:st,dependencies:{indexedDB:at.shimIndexedDB||o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:at.IDBKeyRange||o.IDBKeyRange||o.webkitIDBKeyRange},semVer:"1.5.1",version:"1.5.1".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,2*n)}),fakeAutoComplete:ze,default:Ye}),_(function(){Ye.dependencies.localStorage=null!=("undefined"!=typeof chrome&&null!==chrome?chrome.storage:void 0)?null:o.localStorage}),_e.rejectionMapper=function(e,t){if(!e||e instanceof $||e instanceof TypeError||e instanceof SyntaxError||!e.name||!ne[e.name])return e;var n=new ne[e.name](t||e.message,e);return"stack"in e&&l(n,"stack",{get:function(){return this.inner.stack}}),n},v(function(){Ye.fakeAutoComplete=ze=v,Ye.fake=$e=!0}),Ye})}).call(this,n(24),n(25).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",function(){return l});var r=n(4),o=n(6);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var l={APP:"app",NORMAL:"normal",WINDOW:"window"},f=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=u(u(n=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?u(e):t}(this,a(t).call(this))));return e&&(r.capabilities=e),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,o.a),function(e,t,n){t&&s(e.prototype,t)}(t,[{key:"deployComponent",value:function(e,t,n){var o=this;return new Promise(function(i,s){var a={type:"create",from:r.a.ExternalDeployAddress,to:r.a.InternalDeployAddress,body:{url:t,sourceCode:e,config:n}};o.postMessage(a,function(e){200===e.body.code?i("deployed"):s(e.body.desc)})})}},{key:"removeComponent",value:function(e){var t=this;return new Promise(function(n,o){var i={type:"delete",from:r.a.ExternalDeployAddress,to:r.a.InternalDeployAddress,body:{url:e}};t.postMessage(i,function(e){200===e.body.code?n("undeployed"):o(e.body.desc)})})}},{key:"matches",value:function(e){var t=this,n=Object.keys(e).filter(function(n){return!(t.capabilities[n]&&t.capabilities[n]===e[n])});return 0===n.length||!e[n]}}]),t}();t.b=f},function(e,t,n){"use strict";var r=n(12);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var n=this;n._bus=t,n._factory=new r.a(t),n._components={},t.addListener(e.InternalDeployAddress,function(e){switch(console.log("SandboxRegistry-RCV: ",e),e.type){case"create":n._onDeploy(e);break;case"delete":n._onRemove(e)}})}return function(e,t,n){t&&o(e.prototype,t)}(e,[{key:"_responseMsg",value:function(t,n,r){var o={id:t.id,type:"response",from:e.InternalDeployAddress,to:e.ExternalDeployAddress},i={};return n&&(i.code=n),r&&(i.desc=r),o.body=i,o}},{key:"_onDeploy",value:function(e){var t,n,r=e.body.config,o=e.body.url,i=e.body.sourceCode;if(this._components.hasOwnProperty(o))t=500,n="Instance "+o+" already exist!";else try{console.log("SandboxRegistry-onDeploy: ",e),this._components[o]=this._create(o,i,r,this._factory),t=200}catch(e){t=500,n=e}var s=this._responseMsg(e,t,n);this._bus.postMessage(s)}},{key:"_onRemove",value:function(e){var t,n,r=e.body.url;this._components.hasOwnProperty(r)?(delete this._components[r],this._bus.removeAllListenersOf(r),t=200):(t=500,n="Instance "+r+" doesn't exist!");var o=this._responseMsg(e,t,n);this._bus.postMessage(o)}},{key:"_create",value:function(e,t,n,r){}},{key:"components",get:function(){return this._components}}]),e}();i.ExternalDeployAddress="hyperty-runtime://sandbox/external",i.InternalDeployAddress="hyperty-runtime://sandbox/internal",t.a=i},function(e,t,n){"use strict";var r=n(1),o=n(0);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=r.getLogger("RegistrationStatus"),a=function(){function e(t,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._registryObjectURL=t,this._runtimeURL=n,this._domain=Object(o.k)(n).domain,this._discoveredObjectURL=r,this._messageBus=i,this._subscriptionSet=!1,this._subscribers={live:{},disconnected:{}}}return function(e,t,n){t&&i(e.prototype,t)}(e,[{key:"onLive",value:function(e,t){var n=this;return new Promise(function(r,o){n._subscriptionSet?(n._subscribers.live[e]=t,r()):n._subscribe().then(function(){n._subscribers.live[e]=t,r()}).catch(function(e){return o(e)})})}},{key:"onDisconnected",value:function(e,t){var n=this;return new Promise(function(r,o){n._subscriptionSet?(n._subscribers.disconnected[e]=t,r()):n._subscribe().then(function(){n._subscribers.disconnected[e]=t,r()}).catch(function(e){return o(e)})})}},{key:"_subscribe",value:function(){var e=this,t={type:"subscribe",from:this._discoveredObjectURL,to:this._runtimeURL+"/subscriptions",body:{resources:[this._registryObjectURL+"/registration"]}};return new Promise(function(n,r){e._messageBus.postMessage(t,function(t){s.log("[DiscoveredObject.subscribe] ".concat(e._registryObjectURL," rcved reply "),t),200===t.body.code?(e._generateListener(e._registryObjectURL+"/registration"),e._subscriptionSet=!0,n()):(s.error("Error subscribing ",e._registryObjectURL),r("Error subscribing "+e._registryObjectURL))})})}},{key:"_generateListener",value:function(e){var t=this;this._messageBus.addListener(e,function(e){s.log("[DiscoveredObject.notification] ".concat(t._registryObjectURL,": "),e),t._processNotification(e)})}},{key:"_processNotification",value:function(e){var t=this,n=e.body.value;setTimeout(function(){Object.keys(t._subscribers[n]).forEach(function(e){return t._subscribers[n][e]()})},5e3)}},{key:"_unsubscribe",value:function(){var e=this,t={type:"unsubscribe",from:this._discoveredObjectURL,to:this._runtimeURL+"/subscriptions",body:{resource:this._registryObjectURL+"/registration"}};return new Promise(function(n,r){e._messageBus.postMessage(t,function(t){s.log("[DiscoveredObject.unsubscribe] ".concat(e._registryObjectURL," rcved reply "),t),200===t.body.code?n():(s.error("Error unsubscribing ",e._registryObjectURL),r("Error unsubscribing "+e._registryObjectURL))})})}},{key:"unsubscribeLive",value:function(e){var t=this;return new Promise(function(n,r){e in t._subscribers.live&&delete t._subscribers.live[e],t._areSubscriptionsEmpty()?t._unsubscribe().then(function(){return n()}).catch(function(e){return r(e)}):n()})}},{key:"unsubscribeDisconnected",value:function(e){var t=this;return new Promise(function(n,r){e in t._subscribers.disconnected?(delete t._subscribers.disconnected[e],t._areSubscriptionsEmpty()?t._unsubscribe().then(function(){return n()}).catch(function(e){return r(e)}):n()):r("".concat(e," doesn't subscribe onDisconnected for ").concat(t._registryObjectURL))})}},{key:"_areSubscriptionsEmpty",value:function(){return 0===Object.keys(this._subscribers.live).length&&0===Object.keys(this._subscribers.disconnected).length}}]),e}();t.a=a},function(e,t,n){"use strict";var r=n(7);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,s(t).call(this))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,r.a),function(e,t,n){t&&i(e.prototype,t)}(t,[{key:"postMessage",value:function(e,t,n){return this._genId(e),this._responseCallback(e,t,n),this._onPostMessage(e),e.id}},{key:"_onMessage",value:function(e){if(!this._onResponse(e)){var t=this._subscriptions[e.to];t?(this._publishOn(t,e),e.to.startsWith("hyperty")||this._publishOnDefault(e)):this._publishOnDefault(e)}}}]),t}();t.a=c},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}var s=n(1).getLogger("Bus"),a=function(){function e(){r(this,e),this._msgId=0,this._subscriptions={},this._responseTimeOut=15e3,this._responseCallbacks={},this._registerExternalListener()}return i(e,[{key:"addListener",value:function(e,t){var n=new c(this._subscriptions,e,t),r=this._subscriptions[e];return r||(r=[],this._subscriptions[e]=r),r.push(n),n}},{key:"addResponseListener",value:function(e,t,n){this._responseCallbacks[e+t]=n}},{key:"removeResponseListener",value:function(e,t){delete this._responseCallbacks[e+t]}},{key:"removeAllListenersOf",value:function(e){delete this._subscriptions[e]}},{key:"bind",value:function(e,t,n){var r=this,o=this;return{thisListener:o.addListener(e,function(e){n.postMessage(e)}),targetListener:n.addListener(t,function(e){o.postMessage(e)}),unbind:function(){r.thisListener.remove(),r.targetListener.remove()}}}},{key:"_publishOnDefault",value:function(e){var t=this._subscriptions["*"];t&&this._publishOn(t,e)}},{key:"_publishOn",value:function(e,t){e.forEach(function(e){e._callback(t)})}},{key:"_responseCallback",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this;if(t){var o=e.from+e.id;r._responseCallbacks[o]=t,n&&setTimeout(function(){var t=r._responseCallbacks[o];delete r._responseCallbacks[o],t&&t({id:e.id,type:"response",body:{code:408,desc:"Response timeout!",value:e}})},r._responseTimeOut)}}},{key:"_onResponse",value:function(e){if("response"===e.type){var t=e.to+e.id,n=this._responseCallbacks[t];if(e.body.code>=200&&delete this._responseCallbacks[t],n)return n(e),!0}return!1}},{key:"_onMessage",value:function(e){if(!this._onResponse(e)){var t=this._subscriptions[e.to];t?this._publishOn(t,e):this._publishOnDefault(e)}}},{key:"_genId",value:function(e){e.id&&0!==e.id||(this._msgId++,e.id=this._msgId)}},{key:"postMessage",value:function(e,t){}},{key:"postMessageWithRetries",value:function(e,t,n){var r=this,o=0;!function i(){new Promise(function(t,o){r.postMessage(e,function(r){408===r.body.code||500===r.body.code?o():(s.info("[Bus.postMessageWithRetries] msg delivered: ",e),n(r),t())})}).then(function(){},function(){if(s.warn("[Bus.postMessageWithRetries] Message Bounced (retry ".concat(o,"): '"),e),!(o++<t)){var n="[Error] Message Bounced (delivery attempts ".concat(t,"): '");throw new Error(n+e)}i()})}()}},{key:"_onPostMessage",value:function(e){}},{key:"_registerExternalListener",value:function(){}}]),e}(),c=function(){function e(t,n,o){r(this,e),this._subscriptions=t,this._url=n,this._callback=o}return i(e,[{key:"remove",value:function(){var e=this._subscriptions[this._url];if(e){var t=e.indexOf(this);e.splice(t,1),0===e.length&&delete this._subscriptions[this._url]}}},{key:"url",get:function(){return this._url}}]),e}();t.a=a},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t)}(e,[{key:"addEventListener",value:function(e,t){this[e]=t}},{key:"trigger",value:function(e,t){this[e]&&this[e](t)}}]),e}();t.a=o},function(e,t,n){"use strict";var r=n(0);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(t,n,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.messageBus=o,this.domain=Object(r.k)(t).domain,this.owner=t,this.runtimeURL=n}return function(e,t,n){t&&o(e.prototype,t)}(e,[{key:"discoverUserRegistered",value:function(e,t){var n=this;return new Promise(function(r,o){var i,s=e||".",a={type:"read",from:i=t||n.owner,to:n.runtimeURL+"/registry/",body:{resource:s,criteria:i}};n.messageBus.postMessage(a,function(e){var t=e.body.resource;t&&200===e.body.code?r(t):o("code: "+e.body.code+" No user was found")})})}},{key:"discoverIdentityPerIdP",value:function(e){var t=this;return new Promise(function(n,r){var o={type:"read",from:this.owner,to:t.runtimeURL+"/idm",body:{resource:e,criteria:"idp"}};t.messageBus.postMessage(o,function(e){200===e.body.code?n(e.body.value):r(e.body.code+" "+e.body.desc)})})}}]),e}();t.a=i},function(e,t,n){"use strict";var r=n(8);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var u=function(e){function t(e,n,r,i,a,u){var l;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!e)throw new Error("The hypertyURL is a needed parameter");if(!n)throw new Error("The MiniBus is a needed parameter");if(!r)throw new Error("The configuration is a needed parameter ");if(!a)throw new Error("The factory is a needed parameter ");var f=c(c(l=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?c(e):t}(this,s(t).call(this))));f._contextResourceTypes=i,f._url=e,f._discoverUsersPromises={},f._observePromises={},console.log("[ContextObserver] started with hypertyURL->",e),f._domain=a.divideURL(r.runtimeURL).domain,f._objectDescURL="hyperty-catalogue://catalogue."+f._domain+"/.well-known/dataschema/Context",f._users2observe=[],f._observers={},l._syncher=u||a.createSyncher(e,n,r);var d=a.createDiscovery(e,r.runtimeURL,n);return f._discovery=d,f._discoveries={},window.discovery=f._discovery,l}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,r.a),function(e,t,n){t&&i(e.prototype,t)}(t,[{key:"start",value:function(e,t){var n=this;return console.log("[ContextObserver.start] "),new Promise(function(r,o){n._syncher.resumeObservers({store:!0}).then(function(o){var i=Object.keys(o);i.length>0?(console.log("[ContextObserver.start] resuming: ",o),n._observers=o,r(o),i.forEach(function(n){var r=o[n];e&&(context.data.values=e),r.sync(),t&&r.onDisconnected(t)})):r(!1)}).catch(function(e){console.info("[ContextObserver] Resume Observer failed | ",e),r(!1)})}).catch(function(e){reject("[ContextObserver] Start failed | ",e)})}},{key:"resumeDiscoveries",value:function(){var e=this;return new Promise(function(t,n){e._discovery.resumeDiscoveries().then(function(n){console.log("[ContextObserver._resumeDiscoveries] found: ",n),n.forEach(function(n){n.data.resources&&n.data.resources[0]===e._contextResourceTypes[0]&&(console.log("[ContextObserver._resumeDiscoveries] resuming: ",n),"live"===n.data.status?(t([n.data]),n.unsubscribeLive(e._url)):n.onLive(e._url,function(){console.log("[ContextObserver._resumeDiscoveries] disconnected Hyperty is back to live",n),t([n.data]),n.unsubscribeLive(e._url)}))})})}).catch(function(e){reject("[ContextObserver] resumeDiscoveries failed | ",e)})}},{key:"onResumeObserver",value:function(e){this._onResumeObserver=e}},{key:"discoverUsers",value:function(e,t){var n=this,r=e+"@"+t;return n._discoverUsersPromises[r]||(n._discoverUsersPromises[r]=new Promise(function(r,o){n._discovery.discoverHypertiesDO(e,["context"],n._contextResourceTypes,t).then(function(e){console.log("[ContextObserver.discoverUsers] discovery result->",e);var t=[],o=[];e.forEach(function(e){n._discoveries[e.data.hypertyID]=e,"live"===e.data.status?t.push(e.data):o.push(e)}),t.length>0?(console.log("[ContextObserver.discoverUsers] returning discovered hyperties data->",t),r(t)):o.length>0&&(console.log("[ContextObserver.discoverUsers] disconnected Hyperties ",o),o[0].onLive(n._url,function(){console.log("[ContextObserver.discoverUsers] disconnected Hyperty is back to live",o[0]),t.push(o[0].data),r(t),o[0].unsubscribeLive(n._url)}))})})),n._discoverUsersPromises[r]}},{key:"observe",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this;return n._observePromises[e.hypertyID]||(n._observePromises[e.hypertyID]=new Promise(function(r,o){n._users2observe.forEach(function(t){if(t._reporter===e.hypertyID)return r(t)}),n._discovery.discoverDataObjectsPerReporter(e.hypertyID,["context"],n._contextResourceTypes,n._domain).then(function(i){console.log("[ContextObserver.discoverAvailability] discovered context objects ",i);var s,a=0;i.forEach(function(e){e.hasOwnProperty("lastModified")&&e.hasOwnProperty("url")&&Date.parse(e.lastModified)>a&&(a=e.lastModified,s=e.url)}),0!=a&&s?r(n._subscribeContext(e,s,t)):o("[ContextObserver.observe] discovered DataObjecs are invalid",i)})})),n._observePromises[e.hypertyID]}},{key:"_subscribeContext",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this;return new Promise(function(e,o){r._users2observe.forEach(function(n){if(n.url===t)return e(n)});var i={schema:r._objectDescURL,resource:t,store:null,p2p:null,mutual:null,domain_subscription:n};r._syncher.subscribe(i).then(function(t){console.log("[ContextObserver._subscribeContext] observer object",t),r._users2observe.push(t),t.onDisconnected(function(){console.log("[ContextObserver.onDisconnected]: ",t),t.data.values[0].value="unavailable",t.sync()}),e(t)})})}},{key:"_discoverAndSubscribeLegacyUsers",value:function(e){var t=this;return new Promise(function(n,r){t._discovery.discoverDataObjectsPerName(e).then(function(e){console.log("[ContextObserver._discoverAndSubscribeLegacyUsers] All DataObjects Result",e),e.forEach(function(e){"live"===e.status&&(console.log("Live obj",e),e.hypertyID||(e.hypertyID=e.reporter),t._subscribeContext(e.schema,e.url).then(function(e){return console.log("[ContextObserver._discoverAndSubscribeLegacyUsers] _subscribeContext",e),n(e)}))})}).catch(function(e){console.log("error ",e)})})}},{key:"unobserve",value:function(e){var t=this;t._users2observe.forEach(function(n,r){n.url===e&&(n.unsubscribe(),t._users2observe.splice(r,1))})}}]),t}();t.a=u},function(e,t,n){"use strict";var r=n(8);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var u=function(e){function t(e,n,r,i,a){var u;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),!e)throw new Error("The hypertyURL is a needed parameter");if(!n)throw new Error("The MiniBus is a needed parameter");if(!r)throw new Error("The configuration is a needed parameter");return c(c(u=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?c(e):t}(this,s(t).call(this,e,n,r)))),console.info("[ContextReporter] started with url: ",e),u.syncher=a||i.createSyncher(e,n,r),u.domain=i.divideURL(r.runtimeURL).domain,u.contexts={},u.contextDescURL="hyperty-catalogue://catalogue."+u.domain+"/.well-known/dataschema/Context",u.syncher.onNotification(function(e){c(c(u)).onNotification(e)}),u.syncher.onClose(function(e){console.log("[ContextReporter.onClose]"),c(c(u)).setStatus(e.id,"unavailable"),e.ack()}),u}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,r.a),function(e,t,n){t&&i(e.prototype,t)}(t,[{key:"start",value:function(){var e=this,t=this;return new Promise(function(n,r){e.syncher.resumeReporters({store:!0}).then(function(e){var r=Object.keys(e);r.length>0?(console.log("[ContextReporter.start] resuming ",e[r[0]]),t.contexts=e,r.forEach(function(e){t._onSubscription(t.contexts[e])}),n(t.contexts)):(console.log("[ContextReporter.start] nothing to resume ",e),n(!1))}).catch(function(e){console.error("[ContextReporter] Resume failed | ",e)})}).catch(function(e){reject("[ContextReporter] Start failed | ",e)})}},{key:"processNotification",value:function(e){console.log("[ContextReporter.processNotification: ",e),e.ack()}},{key:"create",value:function(e,t,n){var r,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"myContext",i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=this;return new Promise(function(c,u){r=i||s?i&&!s?{resources:n,expires:30,reporter:i}:!i&&s?{resources:n,expires:30,reuseURL:s}:{resources:n,expires:30,reuseURL:s,reporter:i}:{resources:n,expires:30},console.info("[ContextReporter.create] lets create a new User availability Context Object ",r),a.syncher.create(a.contextDescURL,[],t,!0,!1,o,null,r).then(function(t){a.contexts[e]=t,a._onSubscription(t),c(t)}).catch(function(e){u(e)})})}},{key:"_onSubscription",value:function(e){e.onSubscription(function(e){console.info("[ContextReporter._onSubscription] accepting: ",e),e.accept()})}},{key:"setContext",value:function(e,t){console.log("THIS [ContextReporter.setContext] before change :",this.contexts[e]),console.log("[ContextReporter.setContext] before change :",this.contexts[e].data),this.contexts[e].data.values=t,console.debug("[ContextReporter.setContext] after change :",this.contexts[e].data),this.trigger(e+"-context-update",t)}}]),t}();t.a=u},function(e,t,n){"use strict";var r=n(13),o=n(0);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("[NotificationHandler Constructor] bus input is mandatory");this._bus=t,this._onNotificationHandler={}}return function(e,t,n){t&&i(e.prototype,t)}(e,[{key:"onNotification",value:function(e,t){this._onNotificationHandler[e]=t}},{key:"onCreate",value:function(e){var t=this,n=e.body.hasOwnProperty("resource")?e.body.resource:e.from.slice(0,-13),r=Object(o.k)(n).domain,i=n.split("://")[0],s=function(n){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:400,desc:"Bad Request: "+n}})};e.body.hasOwnProperty("source")||s("Missing source"),e.body.hasOwnProperty("schema")||s("Missing schema"),e.body.hasOwnProperty("value")||s("Missing value"),e.body.hasOwnProperty("identity")||s("Missing identity");var a={type:e.type,from:e.body.source,url:n,domain:r,schema:e.body.schema,value:e.body.value,identity:e.body.identity,to:e.to,via:e.body.via,ack:function(n){var r=200;n&&(r=n),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:r}})},error:function(e){s(e)}};t._onNotificationHandler[i]&&(console.info("[NotificationHandler] NOTIFICATION-EVENT: ",a),t._onNotificationHandler[i](a))}},{key:"onDelete",value:function(e){var t=this,n=e.body.resource,r=t._observers[n],o={from:t.owner,to:t._subURL,id:e.id,type:"unsubscribe",body:{resource:e.body.resource}};if(t._bus.postMessage(o),delete t._observers[n],r){var i={type:e.type,url:n,identity:e.body.identity,ack:function(n){var o=200;n&&(o=n),200===o&&r.delete(),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:o,source:t._owner}})}};t._onNotificationHandler&&(log.log("NOTIFICATION-EVENT: ",i),t._onNotificationHandler(i))}else t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,source:t._owner}})}}]),e}(),a=n(9),c=n(14),u=n(5);function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var f=function(){function e(t,n){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("The discovery component is a needed parameter");if(!n)throw new Error("The identityManager component is a needed parameter");this.discovery=t,this.identityManager=n}return function(e,t,n){t&&l(e.prototype,t)}(e,[{key:"myIdentity",value:function(){var e=this;return new Promise(function(t,n){e.identityManager.discoverUserRegistered().then(function(e){t(e)}).catch(function(e){n(e)})})}},{key:"hyperties",value:function(e,t,n){arguments.length>3&&void 0!==arguments[3]&&arguments[3]}},{key:"users",value:function(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!e)throw new Error("You need to provide a list of users");if(!t)throw new Error("You need to provide a list of domains");if(!r)throw new Error("You need to provide a list of resources");if(!n)throw new Error("You need to provide a list of schemes");var i=this;return new Promise(function(s,a){if(console.info("[Search] Users: ",e,e.length),console.info("[Search] Domains: ",t,t.length),0===e.length)console.info("Don't have users to discovery"),s(e);else{var c=[];e.forEach(function(e,s){var a=t[s];console.info("[Search] Search user "+e+" for provided domain:",a),o?c.push(i.discovery.discoverHypertiesPerUserProfileData(e,n,r)):c.push(i.discovery.discoverHyperties(e,n,r,a))}),console.info("Requests promises: ",c),Promise.all(c.map(function(e){return e.then(function(e){return e},function(e){return e})})).then(function(e){console.info("[Search] Hyperties from new Discovery",e);var t=e.map(function(e){if(e.hasOwnProperty("hypertyID"))return e;var t=Object.keys(e).reduceRight(function(t,n){var r=new Date(e[n].lastModified);return new Date(e[t].lastModified).getTime()<r.getTime()?n:t});return e[t]}).filter(function(e){return e.hasOwnProperty("hypertyID")});console.log("Requests result: ",t),e.forEach(function(e){if("No Hyperty was found"!==e)return s(t)}),a("No Hyperty was found")}).catch(function(t){console.error(t),s(e)})}})}}]),e}(),d=n(10),h=n(11),y=function e(t,n,r,o,i,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t&&(this.preferred_username=t),r&&(this.picture=r),o&&(this.name=o),i&&(this.locale=i),n&&(this.userURL=n),s&&Object.assign(this,s)},p=function e(t,n,r,o,i,s,a,c){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!s)throw new Error("IDP should be a parameter");if(!t)throw new Error("username should be a parameter");this.idp=s,a&&(this.assertion=a),this.userProfile=new y(t,n,r,o,i,c)},v="open",b={startingTime:"",status:"",participants:{}},g={parent:"communication",listener:"resources",type:"HypertyResource"};function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("hypertyURL is a necessary dependecy");this._hypertyURL=t,this._pending={}}return function(e,t,n){t&&m(e.prototype,t)}(e,[{key:"inviteDisconnectedHyperties",value:function(e,t){var n=this;console.log("[GroupChatManager.InvitationsHandler.inviteDisconnectedHyperties] lets invite ",e),e.forEach(function(e){n._pending[t]||(n._pending[t]={}),n._pending[t][e.data.hypertyID]=e,e.onLive(n._hypertyURL,function(){console.log("[GroupChatManager.create] disconnected Hyperty is back to live",e),t.inviteObservers([e.data.hypertyID]),e.unsubscribeLive(n._hypertyURL),delete n._pending[t][e.data.hypertyID]})})}},{key:"processInvitations",value:function(e,t){var n=this,r=this,o=t.invitations||[];console.log("[GroupChatManager.InvitationsHandler.processInvitations] waiting for replies ",o,this._invitationsResponse),o.forEach(function(o){o.then(function(e){console.log("[GroupChatManager.InvitationsHandler.processInvitations] - OK: ",e,n._invitationsResponse),n._invitationsResponse&&n._invitationsResponse(e)}).catch(function(o){console.log("[GroupChatManager.InvitationsHandler.processInvitations] - NOT OK: ",o,n._invitationsResponse),n._invitationsResponse&&n._invitationsResponse(o),r.inviteDisconnectedHyperties([e[o.invited]],t)})})}},{key:"resumeDiscoveries",value:function(e,t){var n=this;return new Promise(function(r,o){var i={},s=[],a=[],c=[];e.resumeDiscoveries().then(function(e){console.log("[GroupChatManager.InvitationsHandler.resumeDiscoveries] found: ",e),e.forEach(function(e){e.data.resources&&"chat"===e.data.resources[0]&&(console.log("[GroupChatManager.InvitationsHandler.resumeDiscoveries] resuming: ",e),"live"===e.data.status?(i[e.data.hypertyID]=e,s.push(e.data.hypertyID),c.push(e.unsubscribeLive(n._hypertyURL))):a.push(e))}),a.length>0&&n.inviteDisconnectedHyperties(a,t),Object.keys(i).length>0?(t.inviteObservers(s),t.invitations.length>0&&n.processInvitations(i,t),Promise.all(c).then(function(){r()})):r()})}).catch(function(e){reject("[GroupChatManager.InvitationsHandler.resumeDiscoveries] failed | ",e)})}},{key:"cleanInvitations",value:function(e){var t=this,n=t._pending[e];return console.log("[GroupChatManager.InvitationsHandler.cleanInvitations] ",n),n?new Promise(function(e,r){var o=Object.keys(n),i=[];o.forEach(function(e){i.push(n[e].unsubscribeLive(t._hypertyURL))}),Promise.all(o).then(function(){e()})}):Promise.resolve()}},{key:"invitationResponse",set:function(e){this._invitationsResponse=e}}]),e}();function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var O=function(){function e(t,n,r,o,i,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("Syncher is a necessary dependecy");if(!n)throw Error("Discover is a necessary dependecy");if(!r)throw Error("Domain is a necessary dependecy");if(!o)throw Error("Search is a necessary dependecy");this._syncher=t,this.discovery=n,this.search=o,this.myIdentity=i,this.controllerMode="reporter",this.child_cseq=0,this.domain=r,this._manager=s;var a=t.owner;this._objectDescURL="hyperty-catalogue://catalogue."+r+"/.well-known/dataschema/Communication",this._invitationsHandler=new _(a)}return function(e,t,n){t&&w(e.prototype,t)}(e,[{key:"_setOnAddChildListener",value:function(e){var t=this;e.onAddChild(function(e){t.child_cseq+=1,console.info("[ChatManager.ChatController._setOnAddChildListener] new Child received: ",e),t._onMessage&&t._onMessage(e)})}},{key:"_onSubscribe",value:function(e){var t=this._dataObjectReporter;e.accept(),console.log("[ChatManager.ChatController.onSubscribe] event",e,t.url),console.log("[ChatManager.ChatController.onSubscribe] New user has subscribe this object: ",t.data,e.identity);var n=JSON.parse(JSON.stringify(e.identity));n.hasOwnProperty("assertion")&&delete n.assertion;var r={hypertyURL:e.url,domain:e.domain,identity:n},o=e.identity.userProfile.guid;console.log("[ChatManager.ChatController.onSubscribe]  new participant",r),e.identity.legacy&&(r.legacy=e.identity.legacy),t.data.participants[o]=r,console.log("[ChatManager.ChatController.onSubscribe] communicationObject OBJ chatcontroller",t.data.participants),console.log("[ChatManager.ChatController.onSubscribe - onSubscription] ",r),this._onUserAdded&&this._onUserAdded(r)}},{key:"_onUnsubscribe",value:function(e){var t=this._dataObjectReporter;console.log("[ChatManager.ChatController.onUnsubscribe] event",e,t.url);var n=e.identity.userProfile;console.log("[ChatManager.ChatController.onUnsubscribe]  participant left",n),e.identity.legacy&&(n.legacy=e.identity.legacy),delete t.data.participants[n.userURL],console.log("[ChatManager.ChatController.onUnsubscribe - this._onUserRemoved] ",this.onUserRemoved),this._onUserRemoved&&this._onUserRemoved(n)}},{key:"sendFile",value:function(e){var t=this,n="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;return new Promise(function(r,o){var i={userProfile:t.myIdentity};n.addHypertyResource("resources","file",e,i).then(function(e){var o={value:e,identity:{userProfile:t.myIdentity},resource:e},i=new u.a(n.url,t._manager._runtimeURL,t._manager._hypertyURL,t._manager._bus);!function e(t,n,o,i){var s=i;t.sharingStatus.then(r(o)).catch(function(r){console.log("[ChatManager.ChatController.sendFile] share failed: ",r),s.onLive(n,function(){s.unsubscribeLive(n),t.share(!0),e(t,n,o,s)})})}(e,t._manager._hypertyURL,o,i)})}).catch(function(e){console.error("Reason:",e),reject(e)})}},{key:"send",value:function(e,t){var n=this,r="reporter"===n.controllerMode?n.dataObjectReporter:n.dataObjectObserver;return new Promise(function(o,i){n.child_cseq+=1;var s={type:"chat",content:e},a=t||{userProfile:n.myIdentity};r.addChild(s,a).then(function(e){console.log("[ChatManager.ChatController][addChild - Chat Message]: ",e);var t={childId:e._childId,from:e._owner,value:e.data,type:"create",identity:a},i=new u.a(r.url,n._manager._runtimeURL,n._manager._hypertyURL,n._manager._bus);!function e(t,n,r,i){var s=i;t.sharingStatus.then(o(r)).catch(function(o){s.onLive(n,function(){s.unsubscribeLive(n),t.share(!0),e(t,n,r,s)})})}(e,n._manager._hypertyURL,t,i)}).catch(function(e){console.error("Reason:",e),i(e)})})}},{key:"onChange",value:function(e){this._onChange=e}},{key:"onMessage",value:function(e){this._onMessage=e}},{key:"onUserAdded",value:function(e){this._onUserAdded=e}},{key:"onUserRemoved",value:function(e){this._onUserRemoved=e}},{key:"onClose",value:function(e){this._onClose=e}},{key:"onResponse",value:function(e){this._onResponse=e}},{key:"addUser",value:function(e){var t=this,n=function(e){return console.log("Element:",e.length),0!==e.length};return new Promise(function(r,o){if(0===e.filter(n).length)return o("Don't have users to invite");console.info("[ChatManager.ChatController.addUsers ]: ",e);var i=[],s=[],a={};e.forEach(function(e){var n=t.discovery.discoverHypertiesDO(e.user,["comm"],["chat"],e.domain);i.push(n)}),Promise.all(i).then(function(e){console.log("[ChatManager.ChatController.addUsers] Users Discovery Results->",e);var n=[];e.forEach(function(e){e.forEach(function(e){"live"===e.data.status?(n.push(e.data.hypertyID),a[e.data.hypertyID]=e):s.length<5&&s.push(e)})}),console.info("[ChatManager.ChatController]------------------------ Syncher Create ---------------------- \n"),console.info("[ChatManager.ChatController]Selected Hyperties: !!! ",n),console.info("Have ".concat(n.length," users;"));var r="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;s.length>0&&t._invitationsHandler.inviteDisconnectedHyperties(s,r),r.inviteObservers(n),r.invitations.length>0&&t._invitationsHandler.processInvitations(a,r)}).then(function(){console.info("[ChatManager.ChatController]Are invited with success "+e.length+" users;"),r(!0)}).catch(function(e){console.error("An error occurred when trying to invite users;\n",e),o(e)})})}},{key:"addUserReq",value:function(e){var t=this,n=function(e){return console.log("Element:",e.length),0!==e.length};return new Promise(function(r,o){return 0===e.filter(n).length?o("[ChatManager.ChatController.addUserReq] Don't have users to add"):"observer"===!t.controllerMode?o("[ChatManager.ChatController.addUserReq] only allowed to Chat Observer"):void 0})}},{key:"onInvitationResponse",value:function(e){this._onInvitationResponse=e,this._invitationsHandler.invitationResponse=e}},{key:"removeUser",value:function(e){console.log("[ChatManager.ChatController]Not yet implemented: ",e)}},{key:"close",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this;return new Promise(function(n,r){if("reporter"===t.controllerMode)t._invitationsHandler.cleanInvitations(t.dataObjectReporter).then(function(){if(e)try{delete t._manager._reportersControllers[t.dataObjectReporter.url],t.dataObjectReporter.delete(),n(!0),t._onClose&&t._onClose({code:200,desc:"deleted",url:t.dataObjectReporter.url})}catch(e){console.error(e),r(!1)}else t._manager.communicationObject.status="closed",n(!0)});else if(e)try{delete t._manager._observersControllers[t.dataObjectObserver.url],t.dataObjectObserver.unsubscribe(),n(!0)}catch(e){console.error(e),r(!1)}else n(!0)})}},{key:"invitationsHandler",get:function(){return this._invitationsHandler}},{key:"url",get:function(){return"reporter"===this.controllerMode?this.dataObjectReporter.url:this.dataObjectObserver.url}},{key:"dataObjectReporter",set:function(e){if(!e)throw new Error("[ChatController] The data object reporter is necessary parameter ");var t=this;t.controllerMode="reporter",e.onSubscription(function(e){switch(e.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnsubscribe(e)}}),t._setOnAddChildListener(e),e.onRead(function(e){e.accept()}),e.onExecute(function(e){switch(e.method){case"addUser":t.addUser(e.params[0]).then(function(){e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;case"removeUser":t.removeUser(e.params).then(function(){e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;default:e.reject("[ChatController.onExecute] Chat method execution not accepted by Reporter")}}),t._dataObjectReporter=e},get:function(){return this._dataObjectReporter}},{key:"messages",get:function(){return"reporter"===this.controllerMode?this._dataObjectReporter._childrenObjects:this._dataObjectObserver._childrenObjects}},{key:"dataObjectObserver",set:function(e){var t=this;t.controllerMode="observer",t._dataObjectObserver=e,e.onChange("*",function(e){if(console.info("[ChatManager.ChatController]Observer - onChange",e),e.field.includes("participants"))switch(e.cType){case"add":t._onUserAdded&&t._onUserAdded(e);break;case"remove":t._onUserRemoved&&t._onUserRemoved(e)}t._onChange&&t._onChange(e)}),t._setOnAddChildListener(e)},get:function(){return this._dataObjectObserver}},{key:"dataObject",get:function(){return"reporter"===this.controllerMode?this.dataObjectReporter:this.dataObjectObserver}},{key:"closeEvent",set:function(e){this._closeEvent=e,this._onClose&&this._onClose(e)},get:function(){return this._closeEvent}}]),e}();function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var R=function e(t,n,r){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var s=Object(o.i)(r);return r.hasOwnProperty("userProfile")||(s.userProfile=r),k(i={hypertyURL:t,domain:n},"domain",n),k(i,"identity",s),i};function P(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var S=function(){function e(t,n,r,o,i){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[ChatManager.constructor] The myUrl is a needed parameter");if(!n)throw new Error("[ChatManager.constructor] The MiniBus is a needed parameter");if(!r)throw new Error("[ChatManager.constructor] The configuration is a needed parameter");o||(o=i.createSyncher(t,n,r)),this._runtimeURL=r.runtimeURL;var s=i.divideURL(this._runtimeURL).domain,a=i.createDiscovery(t,r.runtimeURL,n),c=i.createIdentityManager(t,r.runtimeURL,n);this._objectDescURL="hyperty-catalogue://catalogue."+s+"/.well-known/dataschema/Communication",this._reportersControllers={},this._observersControllers={},this._myUrl=t,this._bus=n,this._syncher=o,this._domain=s,this.discovery=a,this.identityManager=c,this.currentIdentity,this.search=i.createSearch(a,c),this.communicationObject=b,this.communicationChildren=g,console.log("[ChatManager] Discover ",a),console.log("[ChatManager] Identity Manager ",c)}return function(e,t,n){t&&P(e.prototype,t)}(e,[{key:"processNotification",value:function(e){if(console.log("[ChatManager.processNotification: ",e),"create"===e.type&&this._onInvitation&&this._onInvitation(e),"delete"===e.type){for(var t in e.ack(200),this._observersControllers[e.url].closeEvent=e,delete this._observersControllers[e.url],this._observersControllers.closeEvent=e,this.communicationObject=b,this._reportersControllers)this._reportersControllers[t].close(e);for(var n in this._observersControllers)this._observersControllers[n].close(e)}}},{key:"myIdentity",value:function(e){var t=this;return new Promise(function(n,r){if(console.info("[ChatManager.myIdentity]"),e)return n(e);t._myUrl.includes("hyperty://")?t.identityManager.discoverUserRegistered().then(function(e){n(e)}).catch(function(e){r(e)}):t.identityManager.discoverIdentityPerIdP().then(function(e){n(e)}).catch(function(e){r(e)})})}},{key:"create",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this,o=r._syncher;return new Promise(function(i,s){var a;r.communicationObject=b,r.communicationObject.cseq=1,r.communicationObject.startingTime=(new Date).toJSON(),r.communicationObject.status=v,r.myIdentity().then(function(c){a=c,console.log("[ChatManager.create ] My Identity",c);var u=new R(r._myUrl,r._domain,c);r.communicationObject.participants[c.guid]=u,console.log("[ChatManager.create ] participants: ",r.communicationObject.participants),console.log("[ChatManager.create ] communicationObject",r.communicationObject),console.info("[ChatManager.create] searching "+t);var l=[],f=[],d={};t.forEach(function(e){var t=r.discovery.discoverHypertiesDO(e.user,["comm"],["chat"],e.domain);l.push(t)}),Promise.all(l).then(function(t){console.log("[ChatManager.create] Users Discovery Results->",t);var i=[];t.forEach(function(e){e.forEach(function(e){"live"===e.data.status?(i.push(e.data.hypertyID),d[e.data.hypertyID]=e):f.length<5&&f.push(e)})}),console.info("[ChatManager] ---------------------- Syncher Create ---------------------- \n"),console.info("[ChatManager] Selected Hyperties: !!! ",i),console.info("Have ".concat(i.length," users;"));var s=!n.mutual||n.mutual,a=Object.assign({resources:["chat"],mutual:s},n);return delete a.name,r.offline&&(a.offline=r.offline),console.info("[ChatManager] input data:",a),o.create(r._objectDescURL,i,r.communicationObject,!0,!1,e,{},a)}).then(function(e){console.info("[ChatManager] 3. Return Create Data Object Reporter",e);var t=new O(o,r.discovery,r._domain,r.search,a,r);t.dataObjectReporter=e,r._reportersControllers[e.url]=t,console.log("[ChatManager] chatController invitationsHandler: ",t.invitationsHandler),e.invitations.length>0&&t.invitationsHandler.processInvitations(d,e),f.length>0&&t.invitationsHandler.inviteDisconnectedHyperties(f,e),i(t)}).catch(function(e){s(e)})}).catch(function(e){return console.log("[ChatManager.create] MyIdentity Error:",e),s(e)})})}},{key:"onInvitation",value:function(e){this._onInvitation=e}},{key:"join",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0,r=this;return new Promise(function(o,i){var s,a=r._syncher;console.info("[ChatManager] ------------------------ Syncher subscribe ---------------------- \n"),console.info("invitationURL",e),r.myIdentity(n).then(function(n){s=n;var o={schema:r._objectDescURL,resource:e,store:!0,p2p:!1,mutual:t,domain_subscription:!0,identity:n};return r.offline&&(o.offline=r.offline),a.subscribe(o)}).then(function(e){console.info("Data Object Observer: ",e);var t=new O(a,r.discovery,r._domain,r.search,s,r);o(t),t.dataObjectObserver=e,r._observersControllers[e.url]=t}).catch(function(e){i(e)})})}},{key:"offline",set:function(e){this._offline=e},get:function(){return!!this._offline&&this._offline}}]),e}();function j(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var E=function(){function e(t,n,r,o){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("Syncher is a necessary dependecy");if(!n)throw Error("Domain is a necessary dependecy");this._syncher=t,this.myIdentity=r,this.controllerMode="reporter",this.child_cseq=0,this.domain=n,this._manager=o,t.owner,this._objectDescURL="hyperty-catalogue://catalogue."+n+"/.well-known/dataschema/Communication"}return function(e,t,n){t&&j(e.prototype,t)}(e,[{key:"_setOnAddChildListener",value:function(e){var t=this;e.onAddChild(function(e){t.child_cseq+=1,console.info("[ChatManager.ChatController._setOnAddChildListener] new Child received: ",e),t._onMessage&&t._onMessage(e)})}},{key:"_onSubscribe",value:function(e){var t=this._dataObjectReporter;e.accept(),console.log("[ChatManager.ChatController.onSubscribe] event",e,t.url),console.log("[ChatManager.ChatController.onSubscribe] New user has subscribe this object: ",t.data,e.identity);var n=JSON.parse(JSON.stringify(e.identity));n.hasOwnProperty("assertion")&&delete n.assertion;var r={hypertyURL:e.url,domain:e.domain,identity:n},o=e.identity.userProfile.guid;console.log("[ChatManager.ChatController.onSubscribe]  new participant",r),e.identity.legacy&&(r.legacy=e.identity.legacy),t.data.participants[o]=r,console.log("[ChatManager.ChatController.onSubscribe] communicationObject OBJ chatcontroller",t.data.participants),console.log("[ChatManager.ChatController.onSubscribe - onSubscription] ",r),this._onUserAdded&&this._onUserAdded(r)}},{key:"_onUnsubscribe",value:function(e){var t=this._dataObjectReporter;console.log("[ChatManager.ChatController.onUnsubscribe] event",e,t.url);var n=e.identity.userProfile;console.log("[ChatManager.ChatController.onUnsubscribe]  participant left",n),e.identity.legacy&&(n.legacy=e.identity.legacy),delete t.data.participants[n.userURL],console.log("[ChatManager.ChatController.onUnsubscribe - this._onUserRemoved] ",this.onUserRemoved),this._onUserRemoved&&this._onUserRemoved(n)}},{key:"sendFile",value:function(e){var t=this,n="reporter"===t.controllerMode?t.dataObjectReporter:t.dataObjectObserver;return new Promise(function(r,o){var i={userProfile:t.myIdentity};n.addHypertyResource("resources","file",e,i).then(function(e){var n={userProfile:t.myIdentity};r({value:e,identity:n,resource:e})})}).catch(function(e){console.error("Reason:",e),reject(e)})}},{key:"send",value:function(e,t){var n=this,r="reporter"===n.controllerMode?n.dataObjectReporter:n.dataObjectObserver;return new Promise(function(o,i){n.child_cseq+=1;var s={type:"chat",content:e},a=t||{userProfile:n.myIdentity};r.addChild(s,a).then(function(e){console.log("[ChatManager.ChatController][addChild - Chat Message]: ",e);var t={childId:e._childId,from:e._owner,value:e.data,type:"create",identity:a};o(t)}).catch(function(e){console.error("Reason:",e),i(e)})})}},{key:"onChange",value:function(e){this._onChange=e}},{key:"onMessage",value:function(e){this._onMessage=e}},{key:"onUserAdded",value:function(e){this._onUserAdded=e}},{key:"onUserRemoved",value:function(e){this._onUserRemoved=e}},{key:"onClose",value:function(e){this._onClose=e}},{key:"onResponse",value:function(e){this._onResponse=e}},{key:"onInvitationResponse",value:function(e){this._onInvitationResponse=e}},{key:"removeUser",value:function(e){console.log("[ChatManager.ChatController]Not yet implemented: ",e)}},{key:"close",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this;return new Promise(function(n,r){if("reporter"===t.controllerMode)if(e)try{delete t._manager._reportersControllers[t.dataObjectReporter.url],t.dataObjectReporter.delete(),n(!0),t._onClose&&t._onClose({code:200,desc:"deleted",url:t.dataObjectReporter.url})}catch(e){console.error(e),r(!1)}else t._manager.communicationObject.status="closed",n(!0);else if(e)try{delete t._manager._observersControllers[t.dataObjectObserver.url],t.dataObjectObserver.unsubscribe(),n(!0)}catch(e){console.error(e),r(!1)}else n(!0)})}},{key:"url",get:function(){return"reporter"===this.controllerMode?this.dataObjectReporter.url:this.dataObjectObserver.url}},{key:"dataObjectReporter",set:function(e){if(!e)throw new Error("[ChatController] The data object reporter is necessary parameter ");var t=this;t.controllerMode="reporter",e.onSubscription(function(e){switch(e.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnsubscribe(e)}}),t._setOnAddChildListener(e),e.onRead(function(e){e.accept()}),e.onExecute(function(e){switch(e.method){case"addUser":t.addUser(e.params[0]).then(function(){e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;case"removeUser":t.removeUser(e.params).then(function(){e.accept()}).catch(function(t){console.error("Reason:",t),e.reject(t)});break;default:e.reject("[ChatController.onExecute] Chat method execution not accepted by Reporter")}}),t._dataObjectReporter=e},get:function(){return this._dataObjectReporter}},{key:"messages",get:function(){return"reporter"===this.controllerMode?this._dataObjectReporter._childrenObjects:this._dataObjectObserver._childrenObjects}},{key:"dataObjectObserver",set:function(e){var t=this;t.controllerMode="observer",t._dataObjectObserver=e,e.onChange("*",function(e){if(console.info("[ChatManager.ChatController]Observer - onChange",e),e.field.includes("participants"))switch(e.cType){case"add":t._onUserAdded&&t._onUserAdded(e);break;case"remove":t._onUserRemoved&&t._onUserRemoved(e)}t._onChange&&t._onChange(e)}),t._setOnAddChildListener(e)},get:function(){return this._dataObjectObserver}},{key:"dataObject",get:function(){return"reporter"===this.controllerMode?this.dataObjectReporter:this.dataObjectObserver}},{key:"closeEvent",set:function(e){this._closeEvent=e,this._onClose&&this._onClose(e)},get:function(){return this._closeEvent}}]),e}();function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var C=function(){function e(t,n,r,o,i){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[SimpleChatManager.constructor] The myUrl is a needed parameter");if(!n)throw new Error("[SimpleChatManager.constructor] The MiniBus is a needed parameter");if(!r)throw new Error("[SimpleChatManager.constructor] The configuration is a needed parameter");o||(o=i.createSyncher(t,n,r)),this._runtimeURL=r.runtimeURL;var s=i.divideURL(this._runtimeURL).domain,a=i.createIdentityManager(t,r.runtimeURL,n);this._objectDescURL="hyperty-catalogue://catalogue."+s+"/.well-known/dataschema/Communication",this._reportersControllers={},this._observersControllers={},this._myUrl=t,this._bus=n,this._syncher=o,this._domain=s,this.identityManager=a,this.currentIdentity,this.communicationObject=b,this.communicationChildren=g,console.log("[SimpleChatManager] Identity Manager ",a)}return function(e,t,n){t&&M(e.prototype,t)}(e,[{key:"processNotification",value:function(e){if(console.log("[SimpleChatManager.processNotification: ",e),"create"===e.type&&this._onInvitation&&this._onInvitation(e),"delete"===e.type){for(var t in e.ack(200),this._observersControllers[e.url].closeEvent=e,delete this._observersControllers[e.url],this._observersControllers.closeEvent=e,this.communicationObject=b,this._reportersControllers)this._reportersControllers[t].close(e);for(var n in this._observersControllers)this._observersControllers[n].close(e)}}},{key:"myIdentity",value:function(e){var t=this;return new Promise(function(n,r){if(console.info("[SimpleChatManager.myIdentity]"),e)return n(e);t._myUrl.includes("hyperty://")?t.identityManager.discoverUserRegistered().then(function(e){t.currentIdentity=e,n(e)}).catch(function(e){r(e)}):t.identityManager.discoverIdentityPerIdP().then(function(e){t.currentIdentity=e,n(e)}).catch(function(e){r(e)})})}},{key:"create",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this,o=r._syncher;return new Promise(function(i,s){var a;r.communicationObject=b,r.communicationObject.cseq=1,r.communicationObject.startingTime=(new Date).toJSON(),r.communicationObject.status=v,r.myIdentity().then(function(i){a=i,console.log("[SimpleChatManager.create ] My Identity",i);var s=new R(r._myUrl,r._domain,i);r.communicationObject.participants[i.guid]=s,console.log("[SimpleChatManager.create ] participants: ",r.communicationObject.participants),console.log("[SimpleChatManager.create ] communicationObject",r.communicationObject),console.info("[SimpleChatManager] ---------------------- Syncher Create ---------------------- \n"),console.info("[SimpleChatManager] Selected Hyperties: !!! ",t);var c=!n.mutual||n.mutual,u=Object.assign({resources:["chat"],mutual:c},n);return delete u.name,r.offline&&(u.offline=r.offline),r.backup&&(u.backup=r.backup),console.log("[SimpleChatManager] input data:",u),o.create(r._objectDescURL,t,r.communicationObject,!0,!1,e,{},u)}).then(function(e){console.info("[SimpleChatManager] 3. Return Create Data Object Reporter",e);var t=new E(o,r._domain,a,r);t.dataObjectReporter=e,r._reportersControllers[e.url]=t,i(t)}).catch(function(e){s(e)})}).catch(function(e){return console.log("[SimpleChatManager.create] MyIdentity Error:",e),reject(e)})}},{key:"onInvitation",value:function(e){this._onInvitation=e}},{key:"join",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=this;return new Promise(function(o,i){var s,a=r._syncher;console.info("[SimpleChatManager] ------------------------ Syncher subscribe ---------------------- \n"),console.info("invitationURL",e),r.myIdentity(n).then(function(n){s=n;var o={schema:r._objectDescURL,resource:e,store:!0,p2p:!1,mutual:t,domain_subscription:!0,identity:n};return r.offline&&(o.offline=r.offline),a.subscribe(o)}).then(function(e){console.info("Data Object Observer: ",e);var t=new E(a,r._domain,s,r);o(t),t.dataObjectObserver=e,r._observersControllers[e.url]=t}).catch(function(e){i(e)})})}},{key:"offline",set:function(e){this._offline=e},get:function(){return!!this._offline&&this._offline}},{key:"backup",set:function(e){this._backup=e},get:function(){return!!this._backup&&this._backup}}]),e}();function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var L=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._bus=t,this._divideURL=o.k}return function(e,t,n){t&&x(e.prototype,t)}(e,[{key:"createSyncher",value:function(e,t,n){return new r.a(e,t,n)}},{key:"createIdentityManager",value:function(e,t,n){return new a.a(e,t,n)}},{key:"createDiscovery",value:function(e,t,n){return new c.a(e,t,n)}},{key:"createSearch",value:function(e,t){return new f(e,t)}},{key:"createContextObserver",value:function(e,t,n,r){return new d.a(e,t,n,r,this)}},{key:"createContextReporter",value:function(e,t,n){return new h.a(e,t,n,this)}},{key:"createNotificationHandler",value:function(e){return new s(e)}},{key:"createMessageBodyIdentity",value:function(e,t,n,r,o,i,s,a){return new p(e,t,n,r,o,i,s,a)}},{key:"createChatManager",value:function(e,t,n,r){return new S(e,t,n,r,this)}},{key:"createChatController",value:function(e,t,n,r,o,i){return new O(e,t,n,r,o,i)}},{key:"createSimpleChatManager",value:function(e,t,n,r){return new C(e,t,n,r,this)}},{key:"createChat",value:function(e,t,n,r){return new E(e,t,n,r)}},{key:"createRegistrationStatus",value:function(e,t,n,r){return new u.a(e,t,n,r)}},{key:"divideURL",get:function(){return this._divideURL}}]),e}();t.a=L},function(e,t,n){"use strict";var r=n(1),o=n(0);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n(19);var s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._observers=[],this._filters={},this._data=t||{},this._internalObserve(this._data)}return function(e,t,n){t&&i(e.prototype,t)}(e,[{key:"observe",value:function(e){this._observers.push(e)}},{key:"find",value:function(e){var t=Object(o.y)(e);return this._findWithSplit(t)}},{key:"findBefore",value:function(e){var t={},n=Object(o.y)(e);return t.last=n.pop(),t.obj=this._findWithSplit(n),t}},{key:"_findWithSplit",value:function(e){var t=this._data;return e.forEach(function(e){t=t[e]}),t}},{key:"_internalObserve",value:function(e){var t=this;this._data=Object.deepObserve(e,function(e){e.every(function(e){t._onChanges(e)})})}},{key:"_fireEvent",value:function(e){this._observers.forEach(function(t){t(e)})}},{key:"_onChanges",value:function(e){var t,n=e.object;n.constructor===Object&&(t=c.OBJECT),n.constructor===Array&&(t=c.ARRAY);var r=e.keypath,o=n[e.name];"update"!==e.type||r.includes(".length")||this._fireEvent({cType:a.UPDATE,oType:t,field:r,data:o}),"add"===e.type&&this._fireEvent({cType:a.ADD,oType:t,field:r,data:o}),"delete"===e.type&&this._fireEvent({cType:a.REMOVE,oType:t,field:r})}},{key:"data",get:function(){return this._data}}]),e}(),a={UPDATE:"update",ADD:"add",REMOVE:"remove"},c={OBJECT:"object",ARRAY:"array"},u=s;function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var f=r.getLogger("DataObjectChild"),d=function(){function e(t){function n(e){throw"[DataObjectChild] "+e+" mandatory parameter is missing"}!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.parent?this._parent=t.parent:n("parent"),t.url?this._url=t.url:n("url"),t.created?this._created=t.created:n("created"),t.reporter?this._reporter=t.reporter:n("reporter"),t.runtime?this._runtime=t.runtime:n("runtime"),t.schema?this._schema=t.schema:n("schema"),t.parentObject?this._parentObject=t.parentObject:n("parentObject"),t.name&&(this._name=t.name),t.description&&(this._description=t.description),t.tags&&(this._tags=t.tags),t.resources&&(this._resources=t.resources),t.observerStorage&&(this._observerStorage=t.observerStorage),t.publicObservation&&(this._publicObservation=t.publicObservation),this._childId=t.url,t.data?this._syncObj=new u(t.data):this._syncObj=new u({}),f.log("[DataObjectChild -  Constructor] - ",this._syncObj),this._bus=this._parentObject._bus,this._owner=this._parentObject._owner,this._allocateListeners(),this._metadata=t,delete this._metadata.parentObject,this._sharingStatus=!1}return function(e,t,n){t&&l(e.prototype,t)}(e,[{key:"share",value:function(e){var t=this;t._sharingStatus=new Promise(function(n,r){var i;i=e?t.metadata.parent:t.metadata.parent+"/children/";var s=t.metadata;s.data=t.data;var a={type:"create",from:t.metadata.reporter,to:i,body:{resource:s.url,value:s}};if(t.identity&&(a.body.identity=t.identity),t._parentObject.data.hasOwnProperty("mutual")&&(a.body.mutual=t._parentObject.data.mutual),t._parentObject.metadata.reporter===t.metadata.reporter)return t._bus.postMessage(Object(o.i)(a)),n();var c=t._bus.postMessage(Object(o.i)(a),function(e){if(e.to===t._reporter){t._bus.removeResponseListener(a.from,e.id),f.log("[Syncher.DataObjectChild.share] Parent reporter reply ",e);var o={code:e.body&&e.body.code?e.body.code:500,desc:e.body&&e.body.desc?e.body.desc:"Unknown"};return e.body.code<300?n(o):r(o)}},!1);setTimeout(function(){return t._bus.removeResponseListener(a.from,c),r({code:408,desc:"timout"})},3e3)})}},{key:"store",value:function(){var e={},t=this.metadata.children+"."+this.metadata.url;e.value=this.metadata,e.identity=this.identity;var n={from:this.metadata.reporter,to:this._parentObject._syncher._subURL,type:"create",body:{resource:this.metadata.parent,attribute:t,value:e}};f.log("[DataObjectChild.store]:",n),this._bus.postMessage(n)}},{key:"_allocateListeners",value:function(){var e=this;e._reporter===e._owner&&(e._listener=e._bus.addListener(e._reporter,function(t){"response"===t.type&&t.id===e._msgId&&(f.log("DataObjectChild.onResponse:",t),e._onResponse(t))}))}},{key:"_releaseListeners",value:function(){this._listener&&this._listener.remove()}},{key:"delete",value:function(){this._releaseListeners()}},{key:"onChange",value:function(e){this._syncObj.observe(function(t){f.log("[DataObjectChild - observer] - ",t),e(t)})}},{key:"onResponse",value:function(e){this._onResponseHandler=e}},{key:"_onResponse",value:function(e){var t={type:e.type,url:e.body.source,code:e.body.code};this._onResponseHandler&&this._onResponseHandler(t)}},{key:"shareable",get:function(){var e=this.metadata;return e.data=this.data,e}},{key:"metadata",get:function(){return this._metadata}},{key:"childId",get:function(){return this._childId}},{key:"sharingStatus",get:function(){return this._sharingStatus}},{key:"data",get:function(){return this._syncObj.data}},{key:"identity",set:function(e){this._identity=e},get:function(){return this._identity}}]),e}();function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=function(){function e(t,n,r,o){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:60;function s(e){throw"[HeartBeat] "+e+" mandatory parameter is missing"}!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t?this._bus=t:s("bus"),o?this._dataObject=o:s("dataObject"),i?this._heartBeatRate=i:s("heartBeatRate"),r?this._runtimeUrl=r:s("runtimeUrl"),n?this._hypertyUrl=n:s("hypertyUrl"),this.heartbeat=0,this._stop={heartBeat:!1,sync:function(e){var t={from:n,to:r+"/sm",type:"execute",body:{method:"stopSync",params:[o.url]}};console.log("[Heartbeat.stop.sync()] sending msg:",t),e.postMessage(t)}}}return function(e,t,n){t&&h(e.prototype,t)}(e,[{key:"start",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];console.log("[HeartBeat] starting. isReporter: ",n),e||!n?this._getLastHearBeat().then(function(){t._isHeartBeatActive(t.heartBeat,2*t._heartBeatRate)?t._watchHeartBeat(t._heartBeatRate,!0,t._onHertbeatStopped):(console.log("[HeartBeat] heart beats are disabled for ",t._dataObject),t._stop.heartBeat=t._startHeartBeat(t._heartBeatRate),console.log("[HeartBeat]  ",t._hypertyUrl," started synching with remote storage server"),t._startSync())}):(this._startHeartBeat(this._heartBeatRate),this._startSync())}},{key:"_getLastHearBeat",value:function(){var e=this;return new Promise(function(t){setTimeout(function(){console.log("[HeartBeat._getLastHearBeat] stop waiting "),t()},1e3*e._heartBeatRate*1.5)})}},{key:"stop",value:function(){this._stop.heartBeat&&this._stop.heartBeat(),this._stop.sync(this._bus)}},{key:"onNewHeartbeat",value:function(e){this.heartbeat=e}},{key:"_isHeartBeatActive",value:function(e,t){var n=Object(o.C)()-e;return console.log("[HeartBeat._isHeartBeatActive] now - lastHeartBeat",n),console.log("[HeartBeat._isHeartBeatActive] ",!(n>2*t)),!(n>2*t)}},{key:"_startHeartBeat",value:function(e){var t=this,n={from:t._hypertyUrl,to:t._dataObject.url+"/children/",type:"create",body:{resource:"heartbeat",mutual:!1,value:Object(o.C)()}};console.log("[HeartBeat._startHeartBeat] starting ... ",n.body.value),this._bus.postMessage(n),this.heartbeat=Object(o.C)();var r=setInterval(function(){var e={from:t._hypertyUrl,to:t._dataObject.url+"/children/",type:"create",body:{resource:"heartbeat",mutual:!1,value:Object(o.C)()}};console.log("[HeartBeat] ",e),t._bus.postMessage(e),this.heartbeat=Object(o.C)()},1e3*e);return function(){clearInterval(r)}}},{key:"_startSync",value:function(){console.log("[HeartBeat._startSync] starting observer sync ",this._dataObject.data);var e=this._dataObject.data.backupRevision;console.log("[HeartBeat._startSync] backupRevision ",e);var t={from:this._hypertyUrl,to:this._runtimeUrl+"/sm",type:"execute",body:{method:"sync",params:[this._dataObject.url,e]}};console.log("[HeartBeat._startSync] sending msg ",t),this._bus.postMessage(t)}},{key:"_watchHeartBeat",value:function(e,t,n){var r=this,o=n;console.log("[HeartBeat._watchHeartBeat] started watching ",r.heartBeat);var i=setInterval(function(){t&&!r._isHeartBeatActive(r.heartBeat,r._heartBeatRate)?(console.log("[HeartBeat._watchHeartBeat] has stopped ",r._dataObject.data),clearInterval(i),o(r)):!t&&this._isHeartBeatActive(r.heartBeat,r._heartBeatRate)&&(console.log("[HeartBeat._watchHeartBeat] has changed to disabled ",r._dataObject.data),clearInterval(i),o())},1e3*e*2)}},{key:"_onHertbeatStopped",value:function(e){e._startHeartBeat(e._heartBeatRate),e._startSync()}},{key:"heartBeat",get:function(){return this.heartbeat?this.heartbeat:0}}]),e}();function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t,n){return(b="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var w=r.getLogger("HypertyResource"),O=function(e){function t(e,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var o=_(_(r=function(e,t){return!t||"object"!==p(t)&&"function"!=typeof t?_(e):t}(this,g(t).call(this,n))));return o.arraybufferSizeLimit=5242880,o._isSender=e,o._localStorageURL=o._parentObject._syncher._runtimeUrl+"/storage",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,d),function(e,t,n){t&&v(e.prototype,t)}(t,[{key:"save",value:function(){var e=this;return new Promise(function(t,n){var r={from:e._owner,to:e._localStorageURL,type:"create",body:{value:Object(o.i)(e._metadata)}};r.body.value.content=e._content,e._bus.postMessage(r,function(r){w.info("[HypertyResource.save] reply: ",r),e._bus.removeResponseListener(e._owner,r.id),200===r.body.code?(r.body.value&&(e._metadata.contentURL||(e._metadata.contentURL=[]),e._metadata.contentURL.push(r.body.value)),t()):n(r.body.code+" "+r.body.desc)},!1)})}},{key:"read",value:function(e){var t=this;return w.info("[HypertyResource.read] ",this),new Promise(function(n,r){if(t.content)n(t);else{var o=t._getBestContentURL(t._metadata.contentURL);w.log("Storage:",o);var i={from:t._owner,to:o.url,type:"read",body:{resource:o.url+"/"+o.resource,p2p:!0}};t.metadata.p2pRequester&&t.metadata.p2pHandler&&(i.body.p2pRequester=t.metadata.p2pRequester,i.body.p2pHandler=t.metadata.p2pHandler),t._getBestResource(i,e).then(function(e){w.info("[HypertyResource] - get locally the resource:",e),n(t)}).catch(function(i){w.warn("[HypertyResource] - get locally the resource fail",i);var s={from:t._owner,to:o.remoteURL,type:"read",body:{resource:o.remoteURL+"/"+o.resource,p2p:!0}};t.metadata.p2pRequester&&t.metadata.p2pHandler&&(s.body.p2pRequester=t.metadata.p2pRequester,s.body.p2pHandler=t.metadata.p2pHandler),t._getBestResource(s,e).then(function(e){w.warn("[HypertyResource] - get remotely the resource",e),n(t)}).catch(function(e){w.warn("[HypertyResource] - get remotely the resource fail",e),r(e.body.code+" "+e.body.desc)})})}})}},{key:"_getBestResource",value:function(e,t){var n=this;return new Promise(function(r,o){var i=setTimeout(function(){return n._bus.removeResponseListener(n._owner,s),e.body.code=408,e.body.desc="Response timeout",o(e)},3e3),s=n._bus.postMessage(e,function(e){w.log("[HypertyResource.read] reply: ",e);var s=e.id;switch(clearTimeout(i),e.body.code){case 200:n._content=e.body.value.content,e.body.value.size<n.arraybufferSizeLimit&&n.save(),n._bus.removeResponseListener(n._owner,s),r(e);break;case 183:t(e.body.value);break;default:n._bus.removeResponseListener(n._owner,s),o(e)}},!1)})}},{key:"delete",value:function(){var e=this;w.info("[HypertyResource.delete]",e.metadata);var t={from:e._owner,to:e._localStorageURL,type:"delete",body:{resources:e.metadata.contentURL}};return new Promise(function(n){e._bus.postMessage(t,function(e){e.body.code<300?n(!0):n(!1)})})}},{key:"_getBestContentURL",value:function(e){var t=e[0],n=t.substr(t.lastIndexOf("/")+1);return{url:this._localStorageURL,resource:n,remoteURL:t.substr(0,t.lastIndexOf("/"))}}},{key:"resourceType",get:function(){return this.metadata.resourceType}},{key:"mimetype",get:function(){return this._metadata.type}},{key:"content",get:function(){return this._content}},{key:"contentURL",get:function(){return this._metadata.contentURL}},{key:"shareable",get:function(){var e=b(g(t.prototype),"metadata",this);return e.resourceType=this.resourceType,e}}]),t}();function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var R="undefined"!=typeof Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),P=R&&"undefined"!=typeof Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),S="undefined"!=typeof HTMLCanvasElement&&HTMLCanvasElement.prototype.toBlob,j=S||"undefined"!=typeof Uint8Array&&"undefined"!=typeof ArrayBuffer&&"undefined"!=typeof atob,E="undefined"!=typeof FileReader||"undefined"!=typeof URL,M=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){n&&k(e,n)}(e,0,[{key:"resize",value:function(t,n,r){if("function"==typeof n&&(r=n,n={width:640,height:480}),n.width,n.height,!e.isSupported()||!t.type.match(/image.*/))return r(t,!1),!1;if(t.type.match(/image\/gif/))return r(t,!1),!1;var o=document.createElement("img");return o.onload=function(i){var s=o.width,a=o.height,c=!1;if(s>=a&&s>n.width?(a*=n.width/s,s=n.width,c=!0):a>n.height&&(s*=n.height/a,a=n.height,c=!0),c){var u=document.createElement("canvas");if(u.width=s,u.height=a,u.getContext("2d").drawImage(o,0,0,s,a),S)u.toBlob(function(e){r(e,!0)},t.type);else{var l=e._toBlob(u,t.type);r(l,!0)}}else r(t,!1)},e._loadImage(o,t),!0}},{key:"_toBlob",value:function(e,t){var n,r=e.toDataURL(t).split(",");n=r[0].indexOf("base64")>=0?atob(r[1]):decodeURIComponent(r[1]);for(var o=new ArrayBuffer(n.length),i=new Uint8Array(o),s=0;s<n.length;s+=1)i[s]=n.charCodeAt(s);var a=r[0].split(":")[1].split(";")[0],c=null;if(R)c=new Blob([P?i:o],{type:a});else{var u=new BlobBuilder;u.append(o),c=u.getBlob(a)}return c}},{key:"_loadImage",value:function(e,t,n){if("undefined"==typeof URL){var r=new FileReader;r.onload=function(t){e.src=t.target.result,n&&n()},r.readAsDataURL(t)}else e.src=URL.createObjectURL(t),n&&n()}},{key:"isSupported",value:function(){return"undefined"!=typeof HTMLCanvasElement&&j&&E}}]),e}();function C(e){return(C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function L(e){return(L=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function I(e,t){return(I=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var U=r.getLogger("FileHypertyResource"),A=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),T(T(r=function(e,t){return!t||"object"!==C(t)&&"function"!=typeof t?T(e):t}(this,L(t).call(this,e,n)))).metadata.resourceType="file",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&I(e,t)}(t,O),function(e,t,n){t&&x(e.prototype,t)}(t,[{key:"init",value:function(e){var t=this;if(!e)throw new Error("[FileHypertyResource.constructor] missing mandatory *file* input ");return new Promise(function(n,r){if(t._metadata.name=e.name,t._metadata.lastModified=e.lastModified,t._metadata.size=e.size,t._metadata.mimetype=e.type,U.log("[FileHypertyResource.init] file: ",e),t._isSender)switch(e.type.split("/")[0]){case"image":t._getImagePreview(e).then(function(r){t._metadata.preview=r,t._content=e,n()});break;default:t._content=e,n()}else t._content=e.content,e.preview&&(t._metadata.preview=e.preview),n()})}},{key:"_getImagePreview",value:function(e){var t=new FileReader;return new Promise(function(n,r){M.resize(e,{width:100,height:100},function(e,r){r?(t.readAsDataURL(e),t.onload=function(e){n(e.target.result)}):(U.warn("[FileHypertyResource._getImagePreview] unable to create image preview from original image "),n(void 0))})})}},{key:"toMessage",value:function(){}},{key:"name",get:function(){return this._metadata.name}},{key:"preview",get:function(){return this._metadata.preview}}]),t}();function D(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var N=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&D(e.prototype,t)}(e,[{key:"createHypertyResource",value:function(e,t,n){var r;switch(t){case"file":r=new A(e,n);break;default:throw new Error("[HypertyResourceFactory.createHypertyResource] not supported type: ",t)}return r}},{key:"createHypertyResourceWithContent",value:function(e,t,n,r){var o;return new Promise(function(i){switch(t){case"file":o=new A(e,r);break;default:reject()}o.init(n).then(function(){return o.save()}).then(function(){i(o)})})}}]),e}();function H(e){return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var F=r.getLogger("DataObject"),K=function(){function e(t){function n(e){throw"[DataObject] "+e+" mandatory parameter is missing"}if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.syncher?this._syncher=t.syncher:n("syncher"),t.url?this._url=t.url:n("url"),t.created?this._created=t.created:n("created"),t.reporter?this._reporter=t.reporter:n("reporter"),t.runtime?this._runtime=t.runtime:n("runtime"),t.schema?this._schema=t.schema:n("schema"),t.name?this._name=t.name:n("name"),this._status=t.status,t.data?this._syncObj=new u(t.data):this._syncObj=new u({}),this._childrens=t.childrens,this._mutual=t.mutual,this._version=0,this._childId=1,this._childrenListener,this._onAddChildrenHandler,this._resumed=t.resume,t.resume&&(this._version=t.version),this._owner=t.syncher._owner,this._bus=t.syncher._bus,t.description&&(this._description=t.description),t.tags&&(this._tags=t.tags),t.resources&&(this._resources=t.resources),t.observerStorage&&(this._observerStorage=t.observerStorage),t.publicObservation&&(this._publicObservation=t.publicObservation),this._metadata=Object.assign(t),(!t.hasOwnProperty("resume")||t.hasOwnProperty("resume")&&!t.resume)&&(this._metadata.lastModified=this._metadata.created),delete this._metadata.data,delete this._metadata.syncher,delete this._metadata.authorise,this._hypertyResourceFactory=new N,this._childrenObjects={},this._sharedChilds=[],t.backup&&this._childrens){var r=t.hasOwnProperty("childrenObjects")&&t.childrenObjects.hasOwnProperty("heartbeat")?t.childrenObjects.heartbeat:0;this._heartBeat=new y(this._bus,this._owner,this._syncher._runtimeUrl,this,15,r),this._resumed?this._heartBeat.start(!0,this.metadata.isReporter):this._heartBeat.start(!1,this.metadata.isReporter)}}return function(e,t,n){t&&B(e.prototype,t)}(e,[{key:"_getLastChildId",value:function(){var e=this,t=e._owner+"#0";return Object.keys(e._childrens).filter(function(n){e._childrens[n].childId>t&&(t=e._childrens[n].childId)}),Number(t.split("#")[1])}},{key:"_allocateListeners",value:function(){var e=this,t=this,n=t._url+"/children/";if(F.log("[Data Object - AllocateListeners] - ",t._childrens),t._childrens)var r=n,o=t._bus.addListener(r,function(n){if(n.from!==e._owner)switch(F.log("DataObject-Children-RCV: ",n),n.type){case"create":t._onChildCreate(n);break;case"delete":F.log(n);break;default:t._changeChildren(n)}t._childrenListener=o})}},{key:"_releaseListeners",value:function(){var e=this;e._childrenListener&&(e._childrenListener.remove(),Object.keys(e._childrenObjects).forEach(function(t){e._childrenObjects[t]._releaseListeners()}))}},{key:"sync",value:function(){var e=this,t=this;return F.info("[DataObject.sync] synchronising "),new Promise(function(n,r){var i={};e.metadata.backupRevision&&(i.backupRevision=e.metadata.backupRevision),t._syncher.read(t._metadata.url,i).then(function(e){F.info("[DataObject.sync] value to sync: ",e),Object.assign(t.data,Object(o.i)(e.data)),t._version=e.version,t._metadata.lastModified=e.lastModified,e.childrenObjects?(t.resumeChildrens(e.childrenObjects),t._storeChildrens(),n(!0)):n(!0)}).catch(function(e){F.info("[DataObject.sync] sync failed: ",e),n(!1)})})}},{key:"resumeChildrens",value:function(e){var t=this,n=this,r=this._owner.split("/")[3]+"#"+this._childId,o=e;Object.keys(o).forEach(function(e){var i=!1;"heartbeat"===e||(o[e].hasOwnProperty("value")&&o[e].value.resourceType&&!n._childrenObjects.hasOwnProperty(e)?(n._childrenObjects[e]=n._resumeHypertyResource(o[e]),i=!0):n._childrenObjects.hasOwnProperty(e)||(n._childrenObjects[e]=n._resumeChild(o[e]),F.log("[DataObject.resumeChildrens] new DataObjectChild: ",n._childrenObjects[e]),i=!0)),i&&e>r&&(r=e,F.log("[DataObjectReporter.resumeChildrens] - resuming: ",t._childrenObjects[e]))}),this._childId=Number(r.split("#")[1])}},{key:"_resumeChild",value:function(e){var t=e.value;t.parentObject=this,t.parent=this._url;var n=new d(t);n.identity=e.identity;var r={type:"create",from:n.reporter,url:n.parent,value:n.data,childId:n.url,identity:n.identity,child:n};return n.resourceType&&(r.resource=n),this._onAddChildrenHandler&&this._onAddChildrenHandler(r),n}},{key:"_resumeHypertyResource",value:function(e){var t=e.value;t.parentObject=this,t.parent=this._url;var n=this._hypertyResourceFactory.createHypertyResource(!1,t.resourceType,t);n.identity=e.identity;var r={type:"create",from:n.reporter,url:n.parent,value:n.data,childId:n.url,identity:n.identity,child:n};return n.resourceType&&(r.resource=n),this._onAddChildrenHandler&&this._onAddChildrenHandler(r),n}},{key:"pause",value:function(){throw"Not implemented"}},{key:"resume",value:function(){throw"Not implemented"}},{key:"stop",value:function(){throw"Not implemented"}},{key:"addChild",value:function(e,t,n){var r,o=this;return new Promise(function(i){var s=o._url+"/children/",a=o._getChildInput(n);a.data=e,r=new d(a),t&&(r.identity=t),r.share(),console.log("[DataObject.addChild] added ",r),r.onChange(function(e){o._onChange(e,{path:s,childId:a.url})}),o._childrenObjects[a.url]=r,i(r)})}},{key:"_deleteChildrens",value:function(){var e=this,t=[];return new Promise(function(n){if(e.childrens){var r;for(r in F.log("[DataObject.deleteChildrens]",e.childrens),e.childrens){var o=e.childrens[r];F.log("[DataObject._deleteChildrens] child",o),o.metadata.hasOwnProperty("resourceType")&&t.push(e.childrens[r].delete())}F.log("[DataObject._deleteChildrens] promises ",t),t.length>0?Promise.all(t).then(function(){n("[DataObject._deleteChildrens] done")}):n("[DataObject._deleteChildrens] nothing to delete")}})}},{key:"_getChildInput",value:function(e){var t=Object.assign({},e);return this._childId++,t.url=this._owner.split("/")[3]+"#"+this._childId,t.parentObject=this,t.reporter=this._owner,t.created=(new Date).toISOString(),t.runtime=this._syncher._runtimeUrl,t.p2pHandler=this._syncher._p2pHandler,t.p2pRequester=this._syncher._p2pRequester,t.schema=this._schema,t.parent=this.url,t.mutual=this.metadata.mutual,t}},{key:"addHypertyResource",value:function(e,t,n,r){var o=this;return new Promise(function(i){var s,a=o._url+"/children/",c=o._getChildInput(r);o._hypertyResourceFactory.createHypertyResourceWithContent(!0,e,t,c).then(function(e){s=e,n&&(s.identity=n),s.share(),F.log("[DataObject.addHypertyResource] added ",s),s.onChange(function(e){o._onChange(e,{path:a,childId:s.childId})}),o._childrenObjects[s.childId]=s,i(s)})})}},{key:"onAddChild",value:function(e){this._onAddChildrenHandler=e}},{key:"_onChildCreate",value:function(e){if("heartbeat"===e.body.resource)console.log("[DataObject._onChildCreate] new heartbeat received "+e.body.value),this._heartBeat.onNewHeartbeat(e.body.value);else{console.log("[DataObject._onChildCreate] new child receivedBy "+this._owner+" : ",e);var t={from:e.to,to:e.from,type:"response",id:e.id,body:{code:100}};this._bus.postMessage(t),e.body.value.resourceType?this._onHypertyResourceAdded(e):this._onChildAdded(e)}}},{key:"_onChildAdded",value:function(e){var t=Object(o.i)(e.body.value);t.parentObject=this;var n=new d(t);n.identity=e.body.identity,this._childrenObjects[t.url]=n,e.to===this.metadata.url&&n.store(),this._hypertyEvt(e,n)}},{key:"_onHypertyResourceAdded",value:function(e){var t,n=e.body.value;n.parentObject=this,(t=this._hypertyResourceFactory.createHypertyResource(!1,n.resourceType,n)).identity=e.body.identity,this._childrenObjects[t.childId]=t,this._hypertyEvt(e,t),e.to===this.metadata.url&&t.store()}},{key:"_hypertyEvt",value:function(e,t){var n={type:e.type,from:e.from,url:e.to,value:t.data,childId:t.url,identity:e.body.identity,child:t};t.resourceType&&(n.resource=t),this._onAddChildrenHandler&&this._onAddChildrenHandler(n)}},{key:"_onChange",value:function(e,t){if(this._metadata.lastModified=(new Date).toISOString(),this._version++,"live"===this._status){var n={type:"update",from:this._url,to:this._url+"/changes",body:{version:this._version,source:this._owner,attribute:e.field,lastModified:this._metadata.lastModified}};F.log("[DataObject - _onChange] - ",e,t,n),e.oType===c.OBJECT?e.cType!==a.REMOVE&&(n.body.value=Object(o.i)(e.data)):(n.body.attributeType=e.oType,n.body.value=e.data,e.cType!==a.UPDATE&&(n.body.operation=e.cType)),t&&(n.to=t.path,n.body.resource=t.childId),this.data._mutual||(n.body.mutual=this._mutual),this._bus.postMessage(n)}}},{key:"_changeObject",value:function(e,t){if(this._version+1<=t.body.version){this._version=t.body.version;var n,r=t.body.attribute;n="object"===H(t.body.value)?Object(o.i)(t.body.value):t.body.value;var i=e.findBefore(r);if(t.body.lastModified?this._metadata.lastModified=t.body.lastModified:this._metadata.lastModified=(new Date).toISOString(),t.body.attributeType===c.ARRAY)if(t.body.operation===a.ADD){var s=i.obj,u=i.last;Array.prototype.splice.apply(s,[u,0].concat(n))}else if(t.body.operation===a.REMOVE){var l=i.obj,f=i.last;l.splice(f,n)}else i.obj[i.last]=n;else t.body.hasOwnProperty("value")?i.obj[i.last]=n:delete i.obj[i.last]}else F.log("UNSYNCHRONIZED VERSION: (data => "+this._version+", msg => "+t.body.version+")")}},{key:"_changeChildren",value:function(e){Object(o.k)(e.to).identity;var t=e.body.resource,n=this._childrenObjects[t];F.log("Change children: ",this._owner,e,resource),n?this._changeObject(n._syncObj,e):F.warn("No children found for: ",t)}},{key:"metadata",get:function(){return this._metadata}},{key:"url",get:function(){return this._url}},{key:"schema",get:function(){return this._schema}},{key:"status",get:function(){return this._status}},{key:"data",get:function(){return this._syncObj.data}},{key:"childrens",get:function(){return this._childrenObjects}}]),e}();function q(e){return(q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function V(e,t,n){return(V="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=W(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function W(e){return(W=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function J(e,t){return(J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var z=r.getLogger("DataObjectReporter"),$=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=Y(Y(n=function(e,t){return!t||"object"!==q(t)&&"function"!=typeof t?Y(e):t}(this,W(t).call(this,e))));return r._subscriptions={},r._syncObj.observe(function(e){z.log("[Syncher.DataObjectReporter] "+r.url+" publish change: ",e),r._onChange(e)}),r._allocateListeners(),r.invitations=[],r._childrenSizeThreshold=5e4,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&J(e,t)}(t,K),function(e,t,n){t&&G(e.prototype,t)}(t,[{key:"_allocateListeners",value:function(){V(W(t.prototype),"_allocateListeners",this).call(this);var e=this;e._objectListener=e._bus.addListener(e._url,function(t){switch(z.log("[Syncher.DataObjectReporter] listener "+e._url+" Received: ",t),t.type){case"response":e._onResponse(t);break;case"read":e._onRead(t);break;case"execute":e._onExecute(t);break;case"create":e._onChildCreate(t)}}),e._runtimeStatusListener=e._bus.addListener(e._syncher._runtimeUrl+"/status",function(t){console.log("[Syncher.DataObjectReporter] runtime status event received "+t),t.body&&t.body.resource&&t.body.resource===e._url&&t.body.value&&t.body.value.backupRevision&&(e.data.backupRevision=t.body.value.backupRevision,console.log("[Syncher.DataObjectReporter] DO updated with backup revision "+e.data.backupRevision))})}},{key:"_releaseListeners",value:function(){V(W(t.prototype),"_releaseListeners",this).call(this),this._objectListener.remove()}},{key:"inviteObservers",value:function(e,t){var n=this,r=e;r.length>0&&(z.log("[Syncher.DataObjectReporter] InviteObservers ",r,n._metadata),r.forEach(function(e){var r=new Promise(function(r,o){var i={type:"create",from:n._syncher._owner,to:n._syncher._subURL,body:{resume:!1,resource:n._url,schema:n._schema,value:n._metadata,authorise:[e]}};t&&(i.body.p2p=t),n.data.mutual||(i.body.mutual=n.data.mutual),n._bus.postMessage(i,function(t){z.log("[Syncher.DataObjectReporter] Invitation reply ",t);var n={invited:e,code:t.body&&t.body.code?t.body.code:500,desc:t.body&&t.body.desc?t.body.desc:"Unknown"};n.code<300?r(n):o(n)})});n.invitations.push(r)}))}},{key:"delete",value:function(){var e=this;e._heartBeat&&e._heartBeat.stop(),e._deleteChildrens().then(function(t){z.log(t);var n={type:"delete",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(n,function(t){z.log("DataObjectReporter-DELETE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._reporters[e._url],e._syncObj={})})})}},{key:"onSubscription",value:function(e){this._onSubscriptionHandler=e}},{key:"onResponse",value:function(e){this._onResponseHandler=e}},{key:"onRead",value:function(e){this._onReadHandler=e}},{key:"onExecute",value:function(e){this._onExecuteHandler=e}},{key:"_onForward",value:function(e){switch(z.log("DataObjectReporter-RCV: ",e),e.body.type){case"subscribe":this._onSubscribe(e);break;case"unsubscribe":this._onUnSubscribe(e)}}},{key:"_onSubscribe",value:function(e){var t=this,n=e.body.from,r=Object(o.k)(n),i=r.domain,s=!0;e.body.hasOwnProperty("mutual")&&!e.body.mutual&&(s=!1),console.log("[DataObjectReporter._onSubscribe]",e,i,r);var a={type:e.body.type,url:n,domain:i,identity:e.body.identity,nutual:s,accept:function(){var r={url:n,status:"live"};t._subscriptions[n]=r,t.metadata.subscriptions&&t.metadata.subscriptions.push(r.url);var i=Object(o.i)(t._metadata);i.data=Object(o.i)(t.data),i.version=t._version;var s={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,schema:t._schema,value:i}};return e.body.hasOwnProperty("mutual")&&!e.body.mutual&&(s.body.mutual=e.body.mutual,t.data.mutual=!1),t._heartBeat&&(s.body.value.childrenObjects={},s.body.value.childrenObjects.heartbeat=t._heartBeat.heartbeat),console.log("[DataObjectReporter._onSubscribe.accept] sending response: ",s),t._bus.postMessage(s),r},reject:function(n){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:403,desc:n}})}};t._onSubscriptionHandler&&(z.log("SUBSCRIPTION-EVENT: ",a),t._onSubscriptionHandler(a))}},{key:"_onUnSubscribe",value:function(e){var t=e.body.from,n=Object(o.k)(t),r=n.domain;z.log("[DataObjectReporter._onUnSubscribe]",e,r,n),delete this._subscriptions[t],delete this.invitations[t];var i={type:e.body.type,url:t,domain:r,identity:e.body.identity};this._onSubscriptionHandler&&(z.log("UN-SUBSCRIPTION-EVENT: ",i),this._onSubscriptionHandler(i))}},{key:"_onResponse",value:function(e){var t={type:e.type,url:e.from,code:e.body.code};this._onResponseHandler&&(z.log("RESPONSE-EVENT: ",t),this._onResponseHandler(t))}},{key:"_onRead",value:function(e){var t=this,n=JSON.stringify(t.childrensJSON).length>t._childrenSizeThreshold,r={type:e.type,url:e.from,accept:function(){n?t._syncReplyForLargeData(e):t._syncReply(e)},reject:function(n){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:401,desc:n}})}},o=[];t.metadata.subscriptions?o=t.metadata.subscriptions:t._subscriptions&&(o=Object.keys(t._subscriptions).map(function(e){return t._subscriptions[e].url})),-1!=o.indexOf(e.from)?n?t._syncReplyForLargeData(e):t._syncReply(e):t._onReadHandler&&(z.log("READ-EVENT: ",r),t._onReadHandler(r))}},{key:"_syncReply",value:function(e){var t=Object(o.i)(this.metadata);t.data=Object(o.i)(this.data),t.childrenObjects=Object(o.i)(this.childrensJSON),t.version=this._version;var n={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:t}};this._bus.postMessage(n)}},{key:"_syncReplyForLargeData",value:function(e){var t=this,n=Object(o.i)(t.metadata);n.data=Object(o.i)(t.data),n.version=t._version,delete n.childrenObjects;var r=[],i={};for(child in t._childrenObjects)i[child]={},JSON.stringify(i).length>t._childrenSizeThreshold&&r.push(i),i[child]={},i[child].value=t._childrenObjects[child].metadata,i[child].identity=t._childrenObjects[child].identity;r.push(i),n.responses=r.length+1;var s={id:e.id,type:"response",from:e.to,to:e.from,body:{code:100,value:n}};t._bus.postMessage(s),r.forEach(function(e){var r=Object(o.i)(s);r.body.value=e,r.body.value.responses=n.responses,setTimeout(function(){t._bus.postMessage(r)},50)})}},{key:"_onExecute",value:function(e){var t=this;if(!e.body.method)throw e;var n={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}},r={type:e.type,url:e.from,method:e.body.method,params:e.body.params,accept:function(){t._bus.postMessage(n)},reject:function(n){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:401,desc:n}})}};t._onExecuteHandler&&(z.log("[DataObjectReporter] EXECUTE-EVENT: ",r),t._onExecuteHandler(r))}},{key:"subscriptions",get:function(){return this._subscriptions}},{key:"childrensJSON",get:function(){var e,t={};for(e in this._childrenObjects)t[e]={},t[e].value=this._childrenObjects[e].metadata,t[e].identity=this._childrenObjects[e].identity;return t}}]),t}();function Q(e){return(Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e,t,n){return(Z="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ee(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function ee(e){return(ee=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function te(e,t){return(te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ne(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var re=r.getLogger("DataObjectObserver"),oe=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=ne(ne(n=function(e,t){return!t||"object"!==Q(t)&&"function"!=typeof t?ne(e):t}(this,ee(t).call(this,e))));return r._version=e.version,r._filters={},r._syncObj.observe(function(e){r._onFilter(e)}),r._allocateListeners(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&te(e,t)}(t,K),function(e,t,n){t&&X(e.prototype,t)}(t,[{key:"sync",value:function(){var e=this;return re.info("[DataObjectObserver_sync] synchronising "),new Promise(function(t,n){e._syncher.read(e._metadata.url,{}).then(function(n){re.info("[DataObjectObserver_sync] value to sync: ",n),Object.assign(e.data,Object(o.i)(n.data)),e._version=n.version,e._metadata.lastModified=n.lastModified,n.childrenObjects?(e.resumeChildrens(n.childrenObjects),e._storeChildrens(),t(!0)):t(!0)}).catch(function(e){re.info("[DataObjectObserver_sync] sync failed: ",e),t(!1)})})}},{key:"_storeChildrens",value:function(){var e=this,t={};Object.keys(e._childrenObjects).forEach(function(n){var r=e._childrenObjects;t[n]={},t[n].value=r[n].metadata,t[n].identity=r[n].identity});var n={from:e._owner,to:e._syncher._subURL,type:"create",body:{resource:e._url,attribute:"childrenObjects",value:t}};e._bus.postMessage(n)}},{key:"_allocateListeners",value:function(){Z(ee(t.prototype),"_allocateListeners",this).call(this);var e=this;e._changeListener=e._bus.addListener(e._url+"/changes",function(t){"update"===t.type&&(re.log("DataObjectObserver-"+e._url+"-RCV: ",t),e._changeObject(e._syncObj,t))})}},{key:"_releaseListeners",value:function(){Z(ee(t.prototype),"_releaseListeners",this).call(this),this._changeListener.remove()}},{key:"delete",value:function(){var e=this;e._heartBeat&&e._heartBeat.stop(),e._deleteChildrens().then(function(){e.unsubscribe(),e._releaseListeners(),delete e._syncher._observers[e._url]})}},{key:"unsubscribe",value:function(){var e=this,t={type:"unsubscribe",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(t,function(t){re.log("DataObjectObserver-UNSUBSCRIBE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._observers[e._url])})}},{key:"onChange",value:function(e,t){var n=e,r={type:"exact",callback:t},o=e.indexOf("*");o===e.length-1&&(0===o?r.type="any":(r.type="start",n=e.substr(0,e.length-1))),this._filters[n]=r}},{key:"_onFilter",value:function(e){var t=this;Object.keys(t._filters).forEach(function(n){var r=t._filters[n];"any"===r.type?r.callback(e):"start"===r.type?0===e.field.indexOf(n)&&r.callback(e):"exact"===r.type&&e.field===n&&r.callback(e)})}},{key:"onDisconnected",value:function(e){var t=this;return new Promise(function(n,r){t._subscribeRegistration().then(function(){t._onDisconnected=e,n()}).catch(function(e){return r(e)})})}},{key:"_subscribeRegistration",value:function(){var e=this,t={type:"subscribe",from:this._owner,to:this._syncher._runtimeUrl+"/subscriptions",body:{resources:[this._url+"/registration"]}};return new Promise(function(n,r){e._bus.postMessage(t,function(t){re.log("[DataObjectObserver._subscribeRegistration] ".concat(e._url," rcved reply "),t),200===t.body.code?(e._generateListener(e._url+"/registration"),n()):(re.error("Error subscribing registration status for ",e._url),r("Error subscribing registration status for "+e._url))})})}},{key:"_generateListener",value:function(e){var t=this;t._bus.addListener(e,function(e){re.log("[DataObjectObserver.registrationNotification] ".concat(t._url,": "),e),e.body.value&&"disconnected"===e.body.value&&t._onDisconnected&&(re.log("[DataObjectObserver] ".concat(t._url,": was disconnected "),e),t._onDisconnected())})}},{key:"execute",value:function(e,t){var n=this,r=this;return new Promise(function(o,i){var s={type:"execute",from:n._owner,to:r._url,body:{method:e,params:t}};r._bus.postMessage(s,function(t){re.log("[DataObjectObserver.execute] ".concat(r._url," rcved reply "),t),200===t.body.code?o():(re.warn("[DataObjectObserver.execute] execution of method ".concat(e," was reject by reporter")),i("[DataObjectObserver.execute] execution of method ".concat(e," was reject by reporter")))})})}}]),t}();function ie(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var se=r.getLogger("DataProvisional"),ae=function(){function e(t,n,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._owner=t,this._url=n,this._bus=r,this._children=o,this._changes=[],this._allocateListeners()}return function(e,t,n){t&&ie(e.prototype,t)}(e,[{key:"_allocateListeners",value:function(){var e=this;e._listener=e._bus.addListener(e._url,function(t){se.log("DataProvisional-"+e._url+"-RCV: ",t),e._changes.push(t)})}},{key:"_releaseListeners",value:function(){this._listener.remove()}},{key:"apply",value:function(e){this._changes.forEach(function(t){e._changeObject(e._syncObj,t)})}},{key:"children",get:function(){return this._children}}]),e}();function ce(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ue=r.getLogger("Syncher"),le=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var o=this;o._owner=t,o._bus=n,o._subURL=r.runtimeURL+"/sm",o._runtimeUrl=r.runtimeURL,o._p2pHandler=r.p2pHandler,o._p2pRequester=r.p2pRequester,o._reporters={},o._observers={},o._provisionals={},n.addListener(t,function(e){if(e.from!==t)switch(ue.info("[Syncher] Syncher-RCV: ",e,o),e.type){case"forward":o._onForward(e);break;case"create":o._onRemoteCreate(e);break;case"delete":o._onRemoteDelete(e);break;case"execute":o._onExecute(e)}})}return function(e,t,n){t&&ce(e.prototype,t)}(e,[{key:"create",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"no name",a=arguments.length>6?arguments[6]:void 0,c=arguments.length>7?arguments[7]:void 0;if(!e)throw Error("[Syncher - Create] - You need specify the data object schema");if(!t)throw Error("[Syncher - Create] -The observers should be defined");c=c||{};var u=Object.assign({},c);return u.p2p=i,u.store=r,u.schema=e,u.authorise=t,u.p2pHandler=this._p2pHandler,u.p2pRequester=this._p2pRequester,u.data=n?Object(o.i)(n):{},u.name=0===s.length?"no name":s,u.reporter=c.hasOwnProperty("reporter")&&"boolean"!=typeof c.reporter?c.reporter:this._owner,u.resume=!1,c?(u.mutual=!!c.hasOwnProperty("mutual")&&c.mutual,u.name=c.hasOwnProperty("name")?c.name:u.name):u.mutual=!1,c.hasOwnProperty("reuseURL")&&(u.resource=c.reuseURL),a&&(u.identity=a),this._create(u)}},{key:"resumeReporters",value:function(e){return ue.log("[syncher - create] - resume Reporter - criteria: ",e),Object.assign(e,{resume:!0}),this._resumeCreate(e)}},{key:"subscribe",value:function(e){return this._subscribe(e)}},{key:"resumeObservers",value:function(e){var t=e||{};return Object.assign(t,{resume:!0}),this._resumeSubscribe(t)}},{key:"read",value:function(e,t){var n=this;return console.log("[Syncher.read] ",e),new Promise(function(t,r){n._readReporter(e).then(function(e){t(e)})})}},{key:"_readCallBack",value:function(e,t,n){console.log("[Syncher.read] reply: ",e);var r={},o={},i=0;if(e.body.code<300)if(e.body.value.hasOwnProperty("responses"))if(0===i)o=e.body.value,++i;else{var s;for(s in delete e.body.value.responses,e.body.value)r.hasOwnProperty(s)||(r[s]={}),Object.assign(r[s],e.body.value[s]);++i===o.responses&&(o.childrenObjects=r,delete o.responses,this._bus.removeResponseListener(e.from,e.id),t(o))}else this._bus.removeResponseListener(e.from,e.id),t(e.body.value);else n(e.body.desc)}},{key:"_readReporter",value:function(e){var t=this,n={type:"read",from:t._owner,to:e};return new Promise(function(e,r){t._bus.postMessage(n,function(n){return t._readCallBack(n,e,r)},!1)})}},{key:"onNotification",value:function(e){this._onNotificationHandler=e}},{key:"onClose",value:function(e){this._onClose=e}},{key:"_create",value:function(e){var t=this;return new Promise(function(n,r){var i=Object.assign({},e),s=e.resume;i.created=(new Date).toISOString(),i.runtime=t._runtimeUrl;var a=Object(o.i)(i);delete a.p2p,delete a.store,delete a.observers,delete a.identity;var c={type:"create",from:t._owner,to:t._subURL,body:{resume:s,value:a}};c.body.schema=i.schema,i.p2p&&(c.body.p2p=i.p2p),i.store&&(c.body.store=i.store),i.identity&&(c.body.identity=i.identity),console.log("[syncher._create]: ",i,c),t._bus.postMessage(c,function(o){if(ue.log("[syncher - create] - create-response: ",o),200===o.body.code){i.url=o.body.resource,i.status="live",i.syncher=t,i.childrens=o.body.childrenResources;var s=t._reporters[i.url];s||(s=new $(i),t._reporters[i.url]=s),s.inviteObservers(e.authorise,e.p2p),n(s)}else r(o.body.desc)})})}},{key:"_resumeCreate",value:function(e){var t=this,n=this;return new Promise(function(r,i){var s=e.resume,a={type:"create",from:n._owner,to:n._subURL,body:{resume:s}};ue.log("[syncher - create]: ",e,a),e&&(a.body.value=e,e.hasOwnProperty("reporter")?a.body.value.reporter=e.reporter:a.body.value.reporter=n._owner),e.p2p&&(a.body.p2p=e.p2p),e.store&&(a.body.store=e.store),e.observers&&(a.body.authorise=e.observers),e.identity&&(a.body.identity=e.identity),ue.log("[syncher._resumeCreate] - resume message: ",a),n._bus.postMessage(a,function(e){if(ue.log("[syncher._resumeCreate] - create-resumed-response: ",e),200===e.body.code){var s=e.body.value;for(var a in s){var c=s[a];c.data=Object(o.i)(c.data)||{},c.childrenObjects&&(c.childrenObjects=Object(o.i)(c.childrenObjects)),c.mutual=!1,c.resume=!0,c.status="live",c.syncher=n,ue.log("[syncher._resumeCreate] - create-resumed-dataObjectReporter",c);var u=new $(c);c.childrenObjects&&u.resumeChildrens(c.childrenObjects),n._reporters[c.url]=u}r(n._reporters),t._onReportersResume&&t._onReportersResume(t._reporters)}else 404===e.body.code?r({}):i(e.body.desc)})})}},{key:"_subscribe",value:function(e){var t=this;return new Promise(function(n,r){var o={type:"subscribe",from:t._owner,to:t._subURL,body:e};ue.log("[syncher_subscribe] - subscribe message: ",e,o),t._bus.postMessage(o,function(o){ue.log("[syncher] - subscribe-response: ",o);var i=o.body.resource,s=t._provisionals[i];if(delete t._provisionals[i],s&&s._releaseListeners(),o.body.code<200)ue.log("[syncher] - new DataProvisional: ",o.body.childrenResources,i),s=new ae(t._owner,i,t._bus,o.body.childrenResources),t._provisionals[i]=s;else if(200===o.body.code){ue.log("[syncher] - new Data Object Observer: ",o,t._provisionals);var a=o.body.value;a.syncher=t,a.p2p=e.p2p,a.store=e.store,a.identity=e.identity,a.resume=!1,a.mutual=e.mutual;var c=t._observers[i];c?c.sync():(c=new oe(a),t._observers[i]=c),ue.log("[syncher] - new Data Object Observer already exist: ",c),n(c),s&&s.apply(c)}else r(o.body.desc)})})}},{key:"_resumeSubscribe",value:function(e){var t=this,n=this;return new Promise(function(r,i){var s={type:"subscribe",from:n._owner,to:n._subURL,body:{}};e&&(e.hasOwnProperty("p2p")&&(s.body.p2p=e.p2p),e.hasOwnProperty("store")&&(s.body.store=e.store),e.hasOwnProperty("schema")&&(s.body.schema=e.schema),e.hasOwnProperty("identity")&&(s.body.identity=e.identity),e.hasOwnProperty("resource")&&(s.body.resource=e.resource)),s.body.resume=e.resume;var a=e.mutual;e.hasOwnProperty("mutual")&&(s.body.mutual=a),console.log("[syncher] - subscribe message: ",e,s),n._bus.postMessage(s,function(e){console.log("[syncher] - subscribe-resumed-response: ",e);var s=e.body.resource,a=n._provisionals[s];if(delete n._provisionals[s],a&&a._releaseListeners(),e.body.code<200)ue.log("[syncher] - resume new DataProvisional: ",e,s),a=new ae(n._owner,s,n._bus,e.body.childrenResources),n._provisionals[s]=a;else if(200===e.body.code){var c=e.body.value;for(var u in c){var l=c[u];console.log("[syncher] - Resume Object Observer: ",e,l,n._provisionals),l.childrenObjects&&(l.childrenObjects=Object(o.i)(l.childrenObjects)),l.data=Object(o.i)(l.data)||{},l.resume=!0,l.syncher=n,console.log("[syncher._resumeSubscribe] - create new dataObject: ",l);var f=new oe(l);l.childrenObjects&&f.resumeChildrens(l.childrenObjects),ue.log("[syncher._resumeSubscribe] - new dataObject",f),n._observers[f.url]=f,n._provisionals[f.url]&&n._provisionals[f.url].apply(f)}r(n._observers),t._onObserversResume&&t._onObserversResume(n._observers)}else 404===e.body.code?r({}):i(e.body.desc)})})}},{key:"_onForward",value:function(e){this._reporters[e.body.to]._onForward(e)}},{key:"_onRemoteCreate",value:function(e){var t=this,n=e.from.slice(0,-13),r=Object(o.k)(n).domain,i={type:e.type,from:e.body.source,url:n,domain:r,schema:e.body.schema,value:e.body.value,identity:e.body.identity,ack:function(n){var r=200;n&&(r=n),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:r}})}};t._onNotificationHandler&&(ue.info("[Syncher] NOTIFICATION-EVENT: ",i),t._onNotificationHandler(i))}},{key:"_onRemoteDelete",value:function(e){var t=this,n=e.body.resource,r=t._observers[n],o={from:t.owner,to:t._subURL,id:e.id,type:"unsubscribe",body:{resource:e.body.resource}};if(t._bus.postMessage(o),delete t._observers[n],r){var i={type:e.type,url:n,identity:e.body.identity,ack:function(n){var o=200;n&&(o=n),200===o&&r.delete(),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:o,source:t._owner}})}};t._onNotificationHandler&&(ue.log("NOTIFICATION-EVENT: ",i),t._onNotificationHandler(i))}else t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,source:t._owner}})}},{key:"_onExecute",value:function(e){var t=this,n={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}};if((e.from===t._runtimeUrl+"/registry/"||e.from===t._runtimeUrl+"/registry")&&e.body&&e.body.method&&"close"===e.body.method&&t._onClose){var r={type:"close",ack:function(e){e&&(n.body.code=e),t._bus.postMessage(n)}};ue.info("[Syncher] Close-EVENT: ",r),t._onClose(r)}else t._bus.postMessage(n)}},{key:"onReportersResume",value:function(e){this._onReportersResume=e}},{key:"onObserversResume",value:function(e){this._onObserversResume=e}},{key:"owner",get:function(){return this._owner}},{key:"reporters",get:function(){return this._reporters}},{key:"observers",get:function(){return this._observers}}]),e}();t.a=le},function(e,t,n){"use strict";var r=n(1),o=n(0),i=n(5);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var d=function(e){function t(e,n,r,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(s=a(this,c(t).call(this,e.hypertyID||e.url,n,r,o)))._data=e,s._discovery=i,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.a),l(t,[{key:"data",get:function(){return this._data}}]),l(t,[{key:"check",value:function(){var e=this,t={body:{}};e._discoveredObjectURL.startsWith("hyperty://")?e._discovery.discoverHypertyPerURL(e._discoveredObjectURL).then(function(n){t.body.status=n.status,e._processNotification(t)}):e._discovery.discoverDataObjectsPerURL(e._discoveredObjectURL).then(function(n){t.body.status=n.status,e._processNotification(t)})}}]),t}();function h(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p=r.getLogger("Discovery"),v=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.messageBus=r,this.runtimeURL=n,this.domain=Object(o.k)(t).domain,this.discoveryURL=t}return function(e,t,n){t&&y(e.prototype,t)}(e,[{key:"_isLegacyUser",value:function(e){return!(!e.includes(":")||e.includes("user://"))}},{key:"discoverHypertiesPerUserProfileData",value:function(e,t,n){var r=this,o=[],i={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/hyperty/userprofile/"+e}};return(t||n)&&(i.body.criteria={resources:n,dataSchemes:t}),new Promise(function(t,n){r._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):r.messageBus.postMessage(i,function(n){200===n.body.code?(n.body.value.map(function(e){e.hypertyID!=r.discoveryURL&&o.push(e)}),0===o.length?t([]):(p.log("[Discovery.discoverHypertiesPerUserProfileData] Reply log: ",o),t(o))):(p.warn("[Discovery.discoverHypertiesPerUserProfileData] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverHypertiesPerUserProfileDataDO",value:function(e,t,n){var r=this,o=arguments;return new Promise(function(e,t){r.discoverHypertiesPerUserProfileData.apply(r,h(o)).then(function(t){e(r._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjectsPerUserProfileData",value:function(e,t,n){var r=this,o={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/dataObject/userprofile/"+e}};return(t||n)&&(o.body.criteria={resources:n,dataSchemes:t}),new Promise(function(t,n){r._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):r.messageBus.postMessage(o,function(n){200===n.body.code?(p.log("Reply log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjectsPerUserProfileData] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectsPerUserProfileDataDO",value:function(e,t,n){var r=this,o=arguments;return new Promise(function(e,t){r.discoverDataObjectsPerUserProfileData.apply(r,h(o)).then(function(t){return e(r._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverHypertiesPerGUID",value:function(e,t,n){var r=this,o=[],i={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/hyperty/guid/"+e}};return(t||n)&&(i.body.criteria={resources:n,dataSchemes:t}),new Promise(function(t,n){r.messageBus.postMessage(i,function(i){200===i.body.code?(i.body.value.map(function(e){e.hypertyID!=r.discoveryURL&&o.push(e)}),0===o.length?n("No Hyperty was found"):(p.log("Reply log: ",o),t(o))):(p.warn("[Discovery.discoverHypertiesPerGUID] Error Reply for "+e+" Reason: ",i.body.description),t([]))})})}},{key:"discoverHypertiesPerGUIDDO",value:function(e,t,n){var r=this,o=arguments;return new Promise(function(e,t){r.discoverHypertiesPerGUID.apply(r,h(o)).then(function(t){e(r._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjectsPerGUID",value:function(e,t,n){var r=this,o={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/dataObject/guid/"+e}};return(t||n)&&(o.body.criteria={resources:n,dataSchemes:t}),new Promise(function(t,n){r.messageBus.postMessage(o,function(n){200===n.body.code?(p.log("Reply log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjectsPerGUID] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectsPerGUIDDO",value:function(e,t,n){var r=this,o=arguments;return new Promise(function(e,t){r.discoverDataObjectsPerGUID.apply(r,h(o)).then(function(t){return e(r._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverHyperties",value:function(e,t,n,r){var o,i=this,s=[];o=r||i.domain;var a={type:"read",from:i.discoveryURL,to:i.runtimeURL+"/discovery/",body:{resource:"/hyperty/user/"+e}};return a.body.criteria=t||n?{resources:n,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,n){i._isLegacyUser(e)?t([{hypertyID:e,status:"live"}]):i.messageBus.postMessage(a,function(n){200===n.body.code||500===n.body.code?(n.body.value.map(function(e){e.hypertyID!=i.discoveryURL&&s.push(e)}),p.log("[Discovery.discoverHyperties] Reply : ",s),t(s)):(p.warn("[Discovery.discoverHyperties] Error Reply for "+e+" Reason: ",n.body.description),t(s))})})}},{key:"discoverHypertiesDO",value:function(e,t,n,r){var o=this,i=arguments;return new Promise(function(e,t){o.discoverHyperties.apply(o,h(i)).then(function(t){e(o._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjects",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:i.runtimeURL+"/discovery/",body:{resource:"/dataObject/user/"+e}};return s.body.criteria=t||n?{resources:n,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,n){i.messageBus.postMessage(s,function(n){200===n.body.code?(p.log("Reply Value Log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjects] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectsDO",value:function(e,t,n,r){var o=this,i=arguments;return new Promise(function(e,t){o.discoverDataObjects.apply(o,h(i)).then(function(t){return e(o._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverHypertyPerURL",value:function(e,t){var n,r=this;n=t||r.domain;var o={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/hyperty/url/"+e,criteria:{domain:n}}};return new Promise(function(t,n){r.messageBus.postMessage(o,function(n){200===n.body.code?(p.log("Reply Value Log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverHypertyPerURL] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverHypertyPerURLDO",value:function(e,t){var n=this,r=arguments;return new Promise(function(e,t){n.discoverHypertyPerURL.apply(n,h(r)).then(function(t){return e(new d(t,n.runtimeURL,n.discoveryURL,n.messageBus,n))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjectPerURL",value:function(e,t){var n,r=this;n=t||r.domain;var o={type:"read",from:r.discoveryURL,to:r.runtimeURL+"/discovery/",body:{resource:"/dataObject/url/"+e,criteria:{domain:n}}};return new Promise(function(t,n){r.messageBus.postMessage(o,function(n){200===n.body.code?(p.log("Reply Value Log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjectPerURL] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectPerURLDO",value:function(e,t){var n=this,r=arguments;return new Promise(function(e,t){n.discoverDataObjectPerURL.apply(n,h(r)).then(function(t){return e(new d(t,n.runtimeURL,n.discoveryURL,n.messageBus,n))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjectsPerName",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:i.runtimeURL+"/discovery/",body:{resource:"/dataObject/name/"+e}};return s.body.criteria=t||n?{resources:n,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,n){i.messageBus.postMessage(s,function(n){200===n.body.code?(p.log("Reply Value Log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjectsPerName] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectsPerNameDO",value:function(e,t,n,r){var o=this,i=arguments;return new Promise(function(e,t){o.discoverDataObjectsPerName.apply(o,h(i)).then(function(t){return e(o._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"discoverDataObjectsPerReporter",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:i.runtimeURL+"/discovery/",body:{resource:"/dataObject/reporter/"+e}};return s.body.criteria=t||n?{resources:n,dataSchemes:t,domain:o}:{domain:o},new Promise(function(t,n){i.messageBus.postMessage(s,function(n){200===n.body.code?(p.log("Reply Value Log: ",n.body.value),t(n.body.value)):(p.warn("[Discovery.discoverDataObjectsPerName] Error Reply for "+e+" Reason: ",n.body.description),t([]))})})}},{key:"discoverDataObjectsPerReporterDO",value:function(e,t,n,r){var o=this,i=arguments;return new Promise(function(e,t){o.discoverDataObjectsPerReporter.apply(o,h(i)).then(function(t){return e(o._convertToDiscoveredObject(t))}).catch(function(e){return t(e)})})}},{key:"_convertToDiscoveredObject",value:function(e){var t=this;return e.map(function(e){return new d(e,t.runtimeURL,t.discoveryURL,t.messageBus,t)})}},{key:"discoverDataObject",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:"domain://registry."+o,body:{resource:e,criteria:{resources:n,dataSchemes:t}}};return new Promise(function(t,n){i.messageBus.postMessage(s,function(n){if(p.log("[Discovery]",n),n.body.code>299)return p.warn("[Discovery.discoverDataObject] Error Reply for "+e+" Reason: ",n.body.description),t([]);var r=n.body.value;t(r||[])})})}},{key:"discoverHyperty",value:function(e,t,n,r){var i,s=this,a=Object(o.f)(e);return i=r||s.domain,new Promise(function(o,c){if(p.log("[Discovery.discoverHyperty] ACTIVE DOMAIN -> ",i,"user->",e,"schema->",t,"resources->",n,"domain->",r),e.includes(":")&&!e.includes("user://"))return p.log("[Discovery.discoverHyperty] "+e+" is legacy domain"),o({userID:e,hypertyID:e,schema:t,resources:n});var u={type:"read",from:s.discoveryURL,to:"domain://registry."+i,body:{resource:a,criteria:{resources:n,dataSchemes:t}}};p.info("[Discovery] msg to send->",u),s.messageBus.postMessage(u,function(e){p.info("[Discovery] ON discoverHyperty->",e);var t=e.body.value;t?o(t):c("No Hyperty was found")})})}},{key:"discoverHypertyPerUser",value:function(e,t){var n,r=this;return new Promise(function(o,i){if(e.includes(":")&&!e.includes("user://"))return p.log("[Discovery.discoverHyperty] "+e+"is legacy domain"),o({id:e,hypertyURL:e,descriptor:"unknown"});n=t||r.domain;var s="user://"+e.substring(e.indexOf("@")+1,e.length)+"/"+e.substring(0,e.indexOf("@")),a={type:"read",from:r.discoveryURL,to:"domain://registry."+n,body:{resource:s}};p.info("[Discovery] Message: ",a,n,s),r.messageBus.postMessage(a,function(t){var n,r,s;p.info("[Discovery] message reply",t);var a=t.body.value;for(n in a)if(void 0!==a[n].lastModified)if(void 0===r)r=new Date(a[n].lastModified),s=n;else{var c=new Date(a[n].lastModified);r.getTime()<c.getTime()&&(r=c,s=n)}p.info("[Discovery] Last Hyperty: ",s,r);var u=s;if(void 0===u)return i("User Hyperty not found");var l={id:e,descriptor:a[u].descriptor,hypertyURL:u};p.info("[Discovery] ===> hypertyDiscovery messageBundle: ",l),o(l)})})}},{key:"discoverHypertiesPerUser",value:function(e,t){var n,r=this;return p.log("on Function->",e),new Promise(function(o,i){if(e.includes(":")&&!e.includes("user://")){p.log("[Discovery.discoverHyperty] is legacy domain");var s={userID:e,hypertyID:e,schema:schema,resources:resources};return o(s)}n=t||r.domain;var a="user://"+e.substring(e.indexOf("@")+1,e.length)+"/"+e.substring(0,e.indexOf("@")),c={type:"read",from:r.discoveryURL,to:"domain://registry."+n,body:{resource:a}};p.log("[Discovery] Message discoverHypertiesPerUser: ",c,n,a),r.messageBus.postMessage(c,function(e){p.info("[Discovery] discoverHypertiesPerUser reply",e);var t=e.body.value;if(!t)return i("User Hyperty not found");o(t)})})}},{key:"resumeDiscoveries",value:function(){var e=this;return p.log("[Discovery] resumeDiscoveries"),new Promise(function(t,n){var r={type:"read",from:e.discoveryURL,to:e.runtimeURL+"/subscriptions",body:{resource:e.discoveryURL}};e.messageBus.postMessage(r,function(n){p.log("[Discovery.resumeDiscoveries] reply: ",n);var r=[];200===n.body.code?(n.body.value.forEach(function(t){var n=t.split("/registration")[0];p.log("[Discovery.resumeDiscoveries] adding listener to: ",n),n.includes("hyperty://")?r.push(e.discoverHypertyPerURLDO(n)):r.push(e.discoverDataObjectPerURLDO(n))}),Promise.all(r).then(function(e){t(e)})):t([])})})}}]),e}();t.a=v},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t)}(e,[{key:"combine",value:function(e){return-1!==e.indexOf(!0)||-1===e.indexOf(!1)&&"Not Applicable"}}]),e}();t.a=o},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t)}(e,[{key:"combine",value:function(e){return-1===e.indexOf(!1)&&(-1!==e.indexOf(!0)||"Not Applicable")}}]),e}();t.a=o},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t)}(e,[{key:"combine",value:function(e){for(var t in e)if("Not Applicable"!==e[t])return e[t];return"Not Applicable"}}]),e}();t.a=o},function(e,t,n){var r,o;void 0===(o="function"==typeof(r=function(){Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=n.length;return function(o){if("object"!=typeof o&&"function"!=typeof o||null===o)throw new TypeError("Object.keys called on non-object");var i=[];for(var s in o)e.call(o,s)&&i.push(s);if(t)for(var a=0;a<r;a++)e.call(o,n[a])&&i.push(n[a]);return i}}()),Object.create||(Object.create=function(){function e(){}return function(t){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}()),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if(0===n)return-1;var r=0;if(arguments.length>1&&((r=Number(arguments[1]))!=r?r=0:0!==r&&r!==1/0&&r!==-1/0&&(r=(r>0||-1)*Math.floor(Math.abs(r)))),r>=n)return-1;for(var o=r>=0?r:Math.max(n-Math.abs(r),0);o<n;o++)if(o in t&&t[o]===e)return o;return-1}),Object.isFrozen||(Object.isFrozen=function(e){for(var t="tv4_test_frozen_key";e.hasOwnProperty(t);)t+=Math.random();try{return e[t]=!0,delete e[t],!1}catch(e){return!0}});var e={"+":!0,"#":!0,".":!0,"/":!0,";":!0,"?":!0,"&":!0},t={"*":!0};function n(e){return encodeURI(e).replace(/%25[0-9][0-9]/g,function(e){return"%"+e.substring(3)})}function r(r){var o="";e[r.charAt(0)]&&(o=r.charAt(0),r=r.substring(1));var i="",s="",a=!0,c=!1,u=!1;"+"===o?a=!1:"."===o?(s=".",i="."):"/"===o?(s="/",i="/"):"#"===o?(s="#",a=!1):";"===o?(s=";",i=";",c=!0,u=!0):"?"===o?(s="?",i="&",c=!0):"&"===o&&(s="&",i="&",c=!0);for(var l=[],f=r.split(","),d=[],h={},y=0;y<f.length;y++){var p=f[y],v=null;if(-1!==p.indexOf(":")){var b=p.split(":");p=b[0],v=parseInt(b[1],10)}for(var g={};t[p.charAt(p.length-1)];)g[p.charAt(p.length-1)]=!0,p=p.substring(0,p.length-1);var m={truncate:v,name:p,suffices:g};d.push(m),h[p]=m,l.push(p)}var _=function(e){for(var t="",r=0,o=0;o<d.length;o++){var l=d[o],f=e(l.name);if(null==f||Array.isArray(f)&&0===f.length||"object"==typeof f&&0===Object.keys(f).length)r++;else if(t+=o===r?s:i||",",Array.isArray(f)){c&&(t+=l.name+"=");for(var h=0;h<f.length;h++)h>0&&(t+=l.suffices["*"]&&i||",",l.suffices["*"]&&c&&(t+=l.name+"=")),t+=a?encodeURIComponent(f[h]).replace(/!/g,"%21"):n(f[h])}else if("object"==typeof f){c&&!l.suffices["*"]&&(t+=l.name+"=");var y=!0;for(var p in f)y||(t+=l.suffices["*"]&&i||","),y=!1,t+=a?encodeURIComponent(p).replace(/!/g,"%21"):n(p),t+=l.suffices["*"]?"=":",",t+=a?encodeURIComponent(f[p]).replace(/!/g,"%21"):n(f[p])}else c&&(t+=l.name,u&&""===f||(t+="=")),null!=l.truncate&&(f=f.substring(0,l.truncate)),t+=a?encodeURIComponent(f).replace(/!/g,"%21"):n(f)}return t};return _.varNames=l,{prefix:s,substitution:_}}function o(e){if(!(this instanceof o))return new o(e);for(var t=e.split("{"),n=[t.shift()],i=[],s=[],a=[];t.length>0;){var c=t.shift(),u=c.split("}")[0],l=c.substring(u.length+1),f=r(u);s.push(f.substitution),i.push(f.prefix),n.push(l),a=a.concat(f.substitution.varNames)}this.fill=function(e){for(var t=n[0],r=0;r<s.length;r++){t+=(0,s[r])(e),t+=n[r+1]}return t},this.varNames=a,this.template=e}o.prototype={toString:function(){return this.template},fillFromObject:function(e){return this.fill(function(t){return e[t]})}};var i=function(e,t,n,r,o){if(this.missing=[],this.missingMap={},this.formatValidators=e?Object.create(e.formatValidators):{},this.schemas=e?Object.create(e.schemas):{},this.collectMultiple=t,this.errors=[],this.handleError=t?this.collectError:this.returnError,r&&(this.checkRecursive=!0,this.scanned=[],this.scannedFrozen=[],this.scannedFrozenSchemas=[],this.scannedFrozenValidationErrors=[],this.validatedSchemasKey="tv4_validation_id",this.validationErrorsKey="tv4_validation_errors_id"),o&&(this.trackUnknownProperties=!0,this.knownPropertyPaths={},this.unknownPropertyPaths={}),this.errorReporter=n||h("en"),"string"==typeof this.errorReporter)throw new Error("debug");if(this.definedKeywords={},e)for(var i in e.definedKeywords)this.definedKeywords[i]=e.definedKeywords[i].slice(0)};function s(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(Array.isArray(e)!==Array.isArray(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!s(e[n],t[n]))return!1}else{var r;for(r in e)if(void 0===t[r]&&void 0!==e[r])return!1;for(r in t)if(void 0===e[r]&&void 0!==t[r])return!1;for(r in e)if(!s(e[r],t[r]))return!1}return!0}return!1}i.prototype.defineKeyword=function(e,t){this.definedKeywords[e]=this.definedKeywords[e]||[],this.definedKeywords[e].push(t)},i.prototype.createError=function(e,t,n,r,o,i,s){var a=new g(e,t,n,r,o);return a.message=this.errorReporter(a,i,s),a},i.prototype.returnError=function(e){return e},i.prototype.collectError=function(e){return e&&this.errors.push(e),null},i.prototype.prefixErrors=function(e,t,n){for(var r=e;r<this.errors.length;r++)this.errors[r]=this.errors[r].prefixWith(t,n);return this},i.prototype.banUnknownProperties=function(e,t){for(var n in this.unknownPropertyPaths){var r=this.createError(y.UNKNOWN_PROPERTY,{path:n},n,"",null,e,t),o=this.handleError(r);if(o)return o}return null},i.prototype.addFormat=function(e,t){if("object"==typeof e){for(var n in e)this.addFormat(n,e[n]);return this}this.formatValidators[e]=t},i.prototype.resolveRefs=function(e,t){if(void 0!==e.$ref){if((t=t||{})[e.$ref])return this.createError(y.CIRCULAR_REFERENCE,{urls:Object.keys(t).join(", ")},"","",null,void 0,e);t[e.$ref]=!0,e=this.getSchema(e.$ref,t)}return e},i.prototype.getSchema=function(e,t){var n;if(void 0!==this.schemas[e])return n=this.schemas[e],this.resolveRefs(n,t);var r=e,o="";if(-1!==e.indexOf("#")&&(o=e.substring(e.indexOf("#")+1),r=e.substring(0,e.indexOf("#"))),"object"==typeof this.schemas[r]){n=this.schemas[r];var i=decodeURIComponent(o);if(""===i)return this.resolveRefs(n,t);if("/"!==i.charAt(0))return;for(var s=i.split("/").slice(1),a=0;a<s.length;a++){var c=s[a].replace(/~1/g,"/").replace(/~0/g,"~");if(void 0===n[c]){n=void 0;break}n=n[c]}if(void 0!==n)return this.resolveRefs(n,t)}void 0===this.missing[r]&&(this.missing.push(r),this.missing[r]=r,this.missingMap[r]=r)},i.prototype.searchSchemas=function(e,t){if(Array.isArray(e))for(var n=0;n<e.length;n++)this.searchSchemas(e[n],t);else if(e&&"object"==typeof e)for(var r in"string"==typeof e.id&&function(e,t){if(t.substring(0,e.length)===e){var n=t.substring(e.length);if(t.length>0&&"/"===t.charAt(e.length-1)||"#"===n.charAt(0)||"?"===n.charAt(0))return!0}return!1}(t,e.id)&&void 0===this.schemas[e.id]&&(this.schemas[e.id]=e),e)if("enum"!==r)if("object"==typeof e[r])this.searchSchemas(e[r],t);else if("$ref"===r){var o=f(e[r]);o&&void 0===this.schemas[o]&&void 0===this.missingMap[o]&&(this.missingMap[o]=o)}},i.prototype.addSchema=function(e,t){if("string"!=typeof e||void 0===t){if("object"!=typeof e||"string"!=typeof e.id)return;e=(t=e).id}e===f(e)+"#"&&(e=f(e)),this.schemas[e]=t,delete this.missingMap[e],d(t,e),this.searchSchemas(t,e)},i.prototype.getSchemaMap=function(){var e={};for(var t in this.schemas)e[t]=this.schemas[t];return e},i.prototype.getSchemaUris=function(e){var t=[];for(var n in this.schemas)e&&!e.test(n)||t.push(n);return t},i.prototype.getMissingUris=function(e){var t=[];for(var n in this.missingMap)e&&!e.test(n)||t.push(n);return t},i.prototype.dropSchemas=function(){this.schemas={},this.reset()},i.prototype.reset=function(){this.missing=[],this.missingMap={},this.errors=[]},i.prototype.validateAll=function(e,t,n,r,o){var i;if(!(t=this.resolveRefs(t)))return null;if(t instanceof g)return this.errors.push(t),t;var s,a=this.errors.length,c=null,u=null;if(this.checkRecursive&&e&&"object"==typeof e){if(i=!this.scanned.length,e[this.validatedSchemasKey]){var l=e[this.validatedSchemasKey].indexOf(t);if(-1!==l)return this.errors=this.errors.concat(e[this.validationErrorsKey][l]),null}if(Object.isFrozen(e)&&-1!==(s=this.scannedFrozen.indexOf(e))){var f=this.scannedFrozenSchemas[s].indexOf(t);if(-1!==f)return this.errors=this.errors.concat(this.scannedFrozenValidationErrors[s][f]),null}if(this.scanned.push(e),Object.isFrozen(e))-1===s&&(s=this.scannedFrozen.length,this.scannedFrozen.push(e),this.scannedFrozenSchemas.push([])),c=this.scannedFrozenSchemas[s].length,this.scannedFrozenSchemas[s][c]=t,this.scannedFrozenValidationErrors[s][c]=[];else{if(!e[this.validatedSchemasKey])try{Object.defineProperty(e,this.validatedSchemasKey,{value:[],configurable:!0}),Object.defineProperty(e,this.validationErrorsKey,{value:[],configurable:!0})}catch(t){e[this.validatedSchemasKey]=[],e[this.validationErrorsKey]=[]}u=e[this.validatedSchemasKey].length,e[this.validatedSchemasKey][u]=t,e[this.validationErrorsKey][u]=[]}}var d=this.errors.length,h=this.validateBasic(e,t,o)||this.validateNumeric(e,t,o)||this.validateString(e,t,o)||this.validateArray(e,t,o)||this.validateObject(e,t,o)||this.validateCombinations(e,t,o)||this.validateHypermedia(e,t,o)||this.validateFormat(e,t,o)||this.validateDefinedKeywords(e,t,o)||null;if(i){for(;this.scanned.length;){delete this.scanned.pop()[this.validatedSchemasKey]}this.scannedFrozen=[],this.scannedFrozenSchemas=[]}if(h||d!==this.errors.length)for(;n&&n.length||r&&r.length;){var y=n&&n.length?""+n.pop():null,p=r&&r.length?""+r.pop():null;h&&(h=h.prefixWith(y,p)),this.prefixErrors(d,y,p)}return null!==c?this.scannedFrozenValidationErrors[s][c]=this.errors.slice(a):null!==u&&(e[this.validationErrorsKey][u]=this.errors.slice(a)),this.handleError(h)},i.prototype.validateFormat=function(e,t){if("string"!=typeof t.format||!this.formatValidators[t.format])return null;var n=this.formatValidators[t.format].call(null,e,t);return"string"==typeof n||"number"==typeof n?this.createError(y.FORMAT_CUSTOM,{message:n},"","/format",null,e,t):n&&"object"==typeof n?this.createError(y.FORMAT_CUSTOM,{message:n.message||"?"},n.dataPath||"",n.schemaPath||"/format",null,e,t):null},i.prototype.validateDefinedKeywords=function(e,t,n){for(var r in this.definedKeywords)if(void 0!==t[r])for(var o=this.definedKeywords[r],i=0;i<o.length;i++){var s=(0,o[i])(e,t[r],t,n);if("string"==typeof s||"number"==typeof s)return this.createError(y.KEYWORD_CUSTOM,{key:r,message:s},"","",null,e,t).prefixWith(null,r);if(s&&"object"==typeof s){var a=s.code;if("string"==typeof a){if(!y[a])throw new Error("Undefined error code (use defineError): "+a);a=y[a]}else"number"!=typeof a&&(a=y.KEYWORD_CUSTOM);var c="object"==typeof s.message?s.message:{key:r,message:s.message||"?"},u=s.schemaPath||"/"+r.replace(/~/g,"~0").replace(/\//g,"~1");return this.createError(a,c,s.dataPath||null,u,null,e,t)}}return null},i.prototype.validateBasic=function(e,t,n){var r;return(r=this.validateType(e,t,n))?r.prefixWith(null,"type"):(r=this.validateEnum(e,t,n))?r.prefixWith(null,"type"):null},i.prototype.validateType=function(e,t){if(void 0===t.type)return null;var n=typeof e;null===e?n="null":Array.isArray(e)&&(n="array");var r=t.type;Array.isArray(r)||(r=[r]);for(var o=0;o<r.length;o++){var i=r[o];if(i===n||"integer"===i&&"number"===n&&e%1==0)return null}return this.createError(y.INVALID_TYPE,{type:n,expected:r.join("/")},"","",null,e,t)},i.prototype.validateEnum=function(e,t){if(void 0===t.enum)return null;for(var n=0;n<t.enum.length;n++){if(s(e,t.enum[n]))return null}return this.createError(y.ENUM_MISMATCH,{value:"undefined"!=typeof JSON?JSON.stringify(e):e},"","",null,e,t)},i.prototype.validateNumeric=function(e,t,n){return this.validateMultipleOf(e,t,n)||this.validateMinMax(e,t,n)||this.validateNaN(e,t,n)||null};var a=Math.pow(2,-51),c=1-a;function u(e){var t=String(e).replace(/^\s+|\s+$/g,"").match(/^([^:\/?#]+:)?(\/\/(?:[^:@]*(?::[^:@]*)?@)?(([^:\/?#]*)(?::(\d*))?))?([^?#]*)(\?[^#]*)?(#[\s\S]*)?/);return t?{href:t[0]||"",protocol:t[1]||"",authority:t[2]||"",host:t[3]||"",hostname:t[4]||"",port:t[5]||"",pathname:t[6]||"",search:t[7]||"",hash:t[8]||""}:null}function l(e,t){return t=u(t||""),e=u(e||""),t&&e?(t.protocol||e.protocol)+(t.protocol||t.authority?t.authority:e.authority)+function(e){var t=[];return e.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(e){"/.."===e?t.pop():t.push(e)}),t.join("").replace(/^\//,"/"===e.charAt(0)?"/":"")}(t.protocol||t.authority||"/"===t.pathname.charAt(0)?t.pathname:t.pathname?(e.authority&&!e.pathname?"/":"")+e.pathname.slice(0,e.pathname.lastIndexOf("/")+1)+t.pathname:e.pathname)+(t.protocol||t.authority||t.pathname?t.search:t.search||e.search)+t.hash:null}function f(e){return e.split("#")[0]}function d(e,t){if(e&&"object"==typeof e)if(void 0===t?t=e.id:"string"==typeof e.id&&(t=l(t,e.id),e.id=t),Array.isArray(e))for(var n=0;n<e.length;n++)d(e[n],t);else for(var r in"string"==typeof e.$ref&&(e.$ref=l(t,e.$ref)),e)"enum"!==r&&d(e[r],t)}function h(e){var t=m[e=e||"en"];return function(e){var n=t[e.code]||b[e.code];if("string"!=typeof n)return"Unknown error code "+e.code+": "+JSON.stringify(e.messageParams);var r=e.params;return n.replace(/\{([^{}]*)\}/g,function(e,t){var n=r[t];return"string"==typeof n||"number"==typeof n?n:e})}}i.prototype.validateMultipleOf=function(e,t){var n=t.multipleOf||t.divisibleBy;if(void 0===n)return null;if("number"==typeof e){var r=e/n%1;if(r>=a&&r<c)return this.createError(y.NUMBER_MULTIPLE_OF,{value:e,multipleOf:n},"","",null,e,t)}return null},i.prototype.validateMinMax=function(e,t){if("number"!=typeof e)return null;if(void 0!==t.minimum){if(e<t.minimum)return this.createError(y.NUMBER_MINIMUM,{value:e,minimum:t.minimum},"","/minimum",null,e,t);if(t.exclusiveMinimum&&e===t.minimum)return this.createError(y.NUMBER_MINIMUM_EXCLUSIVE,{value:e,minimum:t.minimum},"","/exclusiveMinimum",null,e,t)}if(void 0!==t.maximum){if(e>t.maximum)return this.createError(y.NUMBER_MAXIMUM,{value:e,maximum:t.maximum},"","/maximum",null,e,t);if(t.exclusiveMaximum&&e===t.maximum)return this.createError(y.NUMBER_MAXIMUM_EXCLUSIVE,{value:e,maximum:t.maximum},"","/exclusiveMaximum",null,e,t)}return null},i.prototype.validateNaN=function(e,t){return"number"!=typeof e?null:!0===isNaN(e)||e===1/0||e===-1/0?this.createError(y.NUMBER_NOT_A_NUMBER,{value:e},"","/type",null,e,t):null},i.prototype.validateString=function(e,t,n){return this.validateStringLength(e,t,n)||this.validateStringPattern(e,t,n)||null},i.prototype.validateStringLength=function(e,t){return"string"!=typeof e?null:void 0!==t.minLength&&e.length<t.minLength?this.createError(y.STRING_LENGTH_SHORT,{length:e.length,minimum:t.minLength},"","/minLength",null,e,t):void 0!==t.maxLength&&e.length>t.maxLength?this.createError(y.STRING_LENGTH_LONG,{length:e.length,maximum:t.maxLength},"","/maxLength",null,e,t):null},i.prototype.validateStringPattern=function(e,t){if("string"!=typeof e||"string"!=typeof t.pattern&&!(t.pattern instanceof RegExp))return null;var n;if(t.pattern instanceof RegExp)n=t.pattern;else{var r,o="",i=t.pattern.match(/^\/(.+)\/([img]*)$/);i?(r=i[1],o=i[2]):r=t.pattern,n=new RegExp(r,o)}return n.test(e)?null:this.createError(y.STRING_PATTERN,{pattern:t.pattern},"","/pattern",null,e,t)},i.prototype.validateArray=function(e,t,n){return Array.isArray(e)&&(this.validateArrayLength(e,t,n)||this.validateArrayUniqueItems(e,t,n)||this.validateArrayItems(e,t,n))||null},i.prototype.validateArrayLength=function(e,t){var n;return void 0!==t.minItems&&e.length<t.minItems&&(n=this.createError(y.ARRAY_LENGTH_SHORT,{length:e.length,minimum:t.minItems},"","/minItems",null,e,t),this.handleError(n))?n:void 0!==t.maxItems&&e.length>t.maxItems&&(n=this.createError(y.ARRAY_LENGTH_LONG,{length:e.length,maximum:t.maxItems},"","/maxItems",null,e,t),this.handleError(n))?n:null},i.prototype.validateArrayUniqueItems=function(e,t){if(t.uniqueItems)for(var n=0;n<e.length;n++)for(var r=n+1;r<e.length;r++)if(s(e[n],e[r])){var o=this.createError(y.ARRAY_UNIQUE,{match1:n,match2:r},"","/uniqueItems",null,e,t);if(this.handleError(o))return o}return null},i.prototype.validateArrayItems=function(e,t,n){if(void 0===t.items)return null;var r,o;if(Array.isArray(t.items)){for(o=0;o<e.length;o++)if(o<t.items.length){if(r=this.validateAll(e[o],t.items[o],[o],["items",o],n+"/"+o))return r}else if(void 0!==t.additionalItems)if("boolean"==typeof t.additionalItems){if(!t.additionalItems&&(r=this.createError(y.ARRAY_ADDITIONAL_ITEMS,{},"/"+o,"/additionalItems",null,e,t),this.handleError(r)))return r}else if(r=this.validateAll(e[o],t.additionalItems,[o],["additionalItems"],n+"/"+o))return r}else for(o=0;o<e.length;o++)if(r=this.validateAll(e[o],t.items,[o],["items"],n+"/"+o))return r;return null},i.prototype.validateObject=function(e,t,n){return"object"!=typeof e||null===e||Array.isArray(e)?null:this.validateObjectMinMaxProperties(e,t,n)||this.validateObjectRequiredProperties(e,t,n)||this.validateObjectProperties(e,t,n)||this.validateObjectDependencies(e,t,n)||null},i.prototype.validateObjectMinMaxProperties=function(e,t){var n,r=Object.keys(e);return void 0!==t.minProperties&&r.length<t.minProperties&&(n=this.createError(y.OBJECT_PROPERTIES_MINIMUM,{propertyCount:r.length,minimum:t.minProperties},"","/minProperties",null,e,t),this.handleError(n))?n:void 0!==t.maxProperties&&r.length>t.maxProperties&&(n=this.createError(y.OBJECT_PROPERTIES_MAXIMUM,{propertyCount:r.length,maximum:t.maxProperties},"","/maxProperties",null,e,t),this.handleError(n))?n:null},i.prototype.validateObjectRequiredProperties=function(e,t){if(void 0!==t.required)for(var n=0;n<t.required.length;n++){var r=t.required[n];if(void 0===e[r]){var o=this.createError(y.OBJECT_REQUIRED,{key:r},"","/required/"+n,null,e,t);if(this.handleError(o))return o}}return null},i.prototype.validateObjectProperties=function(e,t,n){var r;for(var o in e){var i=n+"/"+o.replace(/~/g,"~0").replace(/\//g,"~1"),s=!1;if(void 0!==t.properties&&void 0!==t.properties[o]&&(s=!0,r=this.validateAll(e[o],t.properties[o],[o],["properties",o],i)))return r;if(void 0!==t.patternProperties)for(var a in t.patternProperties){if(new RegExp(a).test(o)&&(s=!0,r=this.validateAll(e[o],t.patternProperties[a],[o],["patternProperties",a],i)))return r}if(s)this.trackUnknownProperties&&(this.knownPropertyPaths[i]=!0,delete this.unknownPropertyPaths[i]);else if(void 0!==t.additionalProperties){if(this.trackUnknownProperties&&(this.knownPropertyPaths[i]=!0,delete this.unknownPropertyPaths[i]),"boolean"==typeof t.additionalProperties){if(!t.additionalProperties&&(r=this.createError(y.OBJECT_ADDITIONAL_PROPERTIES,{key:o},"","/additionalProperties",null,e,t).prefixWith(o,null),this.handleError(r)))return r}else if(r=this.validateAll(e[o],t.additionalProperties,[o],["additionalProperties"],i))return r}else this.trackUnknownProperties&&!this.knownPropertyPaths[i]&&(this.unknownPropertyPaths[i]=!0)}return null},i.prototype.validateObjectDependencies=function(e,t,n){var r;if(void 0!==t.dependencies)for(var o in t.dependencies)if(void 0!==e[o]){var i=t.dependencies[o];if("string"==typeof i){if(void 0===e[i]&&(r=this.createError(y.OBJECT_DEPENDENCY_KEY,{key:o,missing:i},"","",null,e,t).prefixWith(null,o).prefixWith(null,"dependencies"),this.handleError(r)))return r}else if(Array.isArray(i))for(var s=0;s<i.length;s++){var a=i[s];if(void 0===e[a]&&(r=this.createError(y.OBJECT_DEPENDENCY_KEY,{key:o,missing:a},"","/"+s,null,e,t).prefixWith(null,o).prefixWith(null,"dependencies"),this.handleError(r)))return r}else if(r=this.validateAll(e,i,[],["dependencies",o],n))return r}return null},i.prototype.validateCombinations=function(e,t,n){return this.validateAllOf(e,t,n)||this.validateAnyOf(e,t,n)||this.validateOneOf(e,t,n)||this.validateNot(e,t,n)||null},i.prototype.validateAllOf=function(e,t,n){if(void 0===t.allOf)return null;for(var r,o=0;o<t.allOf.length;o++){var i=t.allOf[o];if(r=this.validateAll(e,i,[],["allOf",o],n))return r}return null},i.prototype.validateAnyOf=function(e,t,n){if(void 0===t.anyOf)return null;var r,o,i=[],s=this.errors.length;this.trackUnknownProperties&&(r=this.unknownPropertyPaths,o=this.knownPropertyPaths);for(var a=!0,c=0;c<t.anyOf.length;c++){this.trackUnknownProperties&&(this.unknownPropertyPaths={},this.knownPropertyPaths={});var u=t.anyOf[c],l=this.errors.length,f=this.validateAll(e,u,[],["anyOf",c],n);if(null===f&&l===this.errors.length){if(this.errors=this.errors.slice(0,s),this.trackUnknownProperties){for(var d in this.knownPropertyPaths)o[d]=!0,delete r[d];for(var h in this.unknownPropertyPaths)o[h]||(r[h]=!0);a=!1;continue}return null}f&&i.push(f.prefixWith(null,""+c).prefixWith(null,"anyOf"))}return this.trackUnknownProperties&&(this.unknownPropertyPaths=r,this.knownPropertyPaths=o),a?(i=i.concat(this.errors.slice(s)),this.errors=this.errors.slice(0,s),this.createError(y.ANY_OF_MISSING,{},"","/anyOf",i,e,t)):void 0},i.prototype.validateOneOf=function(e,t,n){if(void 0===t.oneOf)return null;var r,o,i=null,s=[],a=this.errors.length;this.trackUnknownProperties&&(r=this.unknownPropertyPaths,o=this.knownPropertyPaths);for(var c=0;c<t.oneOf.length;c++){this.trackUnknownProperties&&(this.unknownPropertyPaths={},this.knownPropertyPaths={});var u=t.oneOf[c],l=this.errors.length,f=this.validateAll(e,u,[],["oneOf",c],n);if(null===f&&l===this.errors.length){if(null!==i)return this.errors=this.errors.slice(0,a),this.createError(y.ONE_OF_MULTIPLE,{index1:i,index2:c},"","/oneOf",null,e,t);if(i=c,this.trackUnknownProperties){for(var d in this.knownPropertyPaths)o[d]=!0,delete r[d];for(var h in this.unknownPropertyPaths)o[h]||(r[h]=!0)}}else f&&s.push(f)}return this.trackUnknownProperties&&(this.unknownPropertyPaths=r,this.knownPropertyPaths=o),null===i?(s=s.concat(this.errors.slice(a)),this.errors=this.errors.slice(0,a),this.createError(y.ONE_OF_MISSING,{},"","/oneOf",s,e,t)):(this.errors=this.errors.slice(0,a),null)},i.prototype.validateNot=function(e,t,n){if(void 0===t.not)return null;var r,o,i=this.errors.length;this.trackUnknownProperties&&(r=this.unknownPropertyPaths,o=this.knownPropertyPaths,this.unknownPropertyPaths={},this.knownPropertyPaths={});var s=this.validateAll(e,t.not,null,null,n),a=this.errors.slice(i);return this.errors=this.errors.slice(0,i),this.trackUnknownProperties&&(this.unknownPropertyPaths=r,this.knownPropertyPaths=o),null===s&&0===a.length?this.createError(y.NOT_PASSED,{},"","/not",null,e,t):null},i.prototype.validateHypermedia=function(e,t,n){if(!t.links)return null;for(var r,i=0;i<t.links.length;i++){var s=t.links[i];if("describedby"===s.rel){for(var a=new o(s.href),c=!0,u=0;u<a.varNames.length;u++)if(!(a.varNames[u]in e)){c=!1;break}if(c){var l={$ref:a.fillFromObject(e)};if(r=this.validateAll(e,l,[],["links",i],n))return r}}}};var y={INVALID_TYPE:0,ENUM_MISMATCH:1,ANY_OF_MISSING:10,ONE_OF_MISSING:11,ONE_OF_MULTIPLE:12,NOT_PASSED:13,NUMBER_MULTIPLE_OF:100,NUMBER_MINIMUM:101,NUMBER_MINIMUM_EXCLUSIVE:102,NUMBER_MAXIMUM:103,NUMBER_MAXIMUM_EXCLUSIVE:104,NUMBER_NOT_A_NUMBER:105,STRING_LENGTH_SHORT:200,STRING_LENGTH_LONG:201,STRING_PATTERN:202,OBJECT_PROPERTIES_MINIMUM:300,OBJECT_PROPERTIES_MAXIMUM:301,OBJECT_REQUIRED:302,OBJECT_ADDITIONAL_PROPERTIES:303,OBJECT_DEPENDENCY_KEY:304,ARRAY_LENGTH_SHORT:400,ARRAY_LENGTH_LONG:401,ARRAY_UNIQUE:402,ARRAY_ADDITIONAL_ITEMS:403,FORMAT_CUSTOM:500,KEYWORD_CUSTOM:501,CIRCULAR_REFERENCE:600,UNKNOWN_PROPERTY:1e3},p={};for(var v in y)p[y[v]]=v;var b={INVALID_TYPE:"Invalid type: {type} (expected {expected})",ENUM_MISMATCH:"No enum match for: {value}",ANY_OF_MISSING:'Data does not match any schemas from "anyOf"',ONE_OF_MISSING:'Data does not match any schemas from "oneOf"',ONE_OF_MULTIPLE:'Data is valid against more than one schema from "oneOf": indices {index1} and {index2}',NOT_PASSED:'Data matches schema from "not"',NUMBER_MULTIPLE_OF:"Value {value} is not a multiple of {multipleOf}",NUMBER_MINIMUM:"Value {value} is less than minimum {minimum}",NUMBER_MINIMUM_EXCLUSIVE:"Value {value} is equal to exclusive minimum {minimum}",NUMBER_MAXIMUM:"Value {value} is greater than maximum {maximum}",NUMBER_MAXIMUM_EXCLUSIVE:"Value {value} is equal to exclusive maximum {maximum}",NUMBER_NOT_A_NUMBER:"Value {value} is not a valid number",STRING_LENGTH_SHORT:"String is too short ({length} chars), minimum {minimum}",STRING_LENGTH_LONG:"String is too long ({length} chars), maximum {maximum}",STRING_PATTERN:"String does not match pattern: {pattern}",OBJECT_PROPERTIES_MINIMUM:"Too few properties defined ({propertyCount}), minimum {minimum}",OBJECT_PROPERTIES_MAXIMUM:"Too many properties defined ({propertyCount}), maximum {maximum}",OBJECT_REQUIRED:"Missing required property: {key}",OBJECT_ADDITIONAL_PROPERTIES:"Additional properties not allowed",OBJECT_DEPENDENCY_KEY:"Dependency failed - key must exist: {missing} (due to key: {key})",ARRAY_LENGTH_SHORT:"Array is too short ({length}), minimum {minimum}",ARRAY_LENGTH_LONG:"Array is too long ({length}), maximum {maximum}",ARRAY_UNIQUE:"Array items are not unique (indices {match1} and {match2})",ARRAY_ADDITIONAL_ITEMS:"Additional items not allowed",FORMAT_CUSTOM:"Format validation failed ({message})",KEYWORD_CUSTOM:"Keyword failed: {key} ({message})",CIRCULAR_REFERENCE:"Circular $refs: {urls}",UNKNOWN_PROPERTY:"Unknown property (not in schema)"};function g(e,t,n,r,o){if(Error.call(this),void 0===e)throw new Error("No error code supplied: "+r);this.message="",this.params=t,this.code=e,this.dataPath=n||"",this.schemaPath=r||"",this.subErrors=o||null;var i=new Error(this.message);if(this.stack=i.stack||i.stacktrace,!this.stack)try{throw i}catch(i){this.stack=i.stack||i.stacktrace}}g.prototype=Object.create(Error.prototype),g.prototype.constructor=g,g.prototype.name="ValidationError",g.prototype.prefixWith=function(e,t){if(null!==e&&(e=e.replace(/~/g,"~0").replace(/\//g,"~1"),this.dataPath="/"+e+this.dataPath),null!==t&&(t=t.replace(/~/g,"~0").replace(/\//g,"~1"),this.schemaPath="/"+t+this.schemaPath),null!==this.subErrors)for(var n=0;n<this.subErrors.length;n++)this.subErrors[n].prefixWith(e,t);return this};var m={},_=function e(t){var n,r,o=new i,s={setErrorReporter:function(e){return"string"==typeof e?this.language(e):(r=e,!0)},addFormat:function(){o.addFormat.apply(o,arguments)},language:function(e){return e?(m[e]||(e=e.split("-")[0]),!!m[e]&&(n=e,e)):n},addLanguage:function(e,t){var n;for(n in y)t[n]&&!t[y[n]]&&(t[y[n]]=t[n]);var r=e.split("-")[0];if(m[r])for(n in m[e]=Object.create(m[r]),t)void 0===m[r][n]&&(m[r][n]=t[n]),m[e][n]=t[n];else m[e]=t,m[r]=t;return this},freshApi:function(t){var n=e();return t&&n.language(t),n},validate:function(e,t,s,a){var c=h(n),u=new i(o,!1,r?function(e,t,n){return r(e,t,n)||c(e,t,n)}:c,s,a);"string"==typeof t&&(t={$ref:t}),u.addSchema("",t);var l=u.validateAll(e,t,null,null,"");return!l&&a&&(l=u.banUnknownProperties(e,t)),this.error=l,this.missing=u.missing,this.valid=null===l,this.valid},validateResult:function(){var e={toString:function(){return this.valid?"valid":this.error.message}};return this.validate.apply(e,arguments),e},validateMultiple:function(e,t,s,a){var c=h(n),u=new i(o,!0,r?function(e,t,n){return r(e,t,n)||c(e,t,n)}:c,s,a);"string"==typeof t&&(t={$ref:t}),u.addSchema("",t),u.validateAll(e,t,null,null,""),a&&u.banUnknownProperties(e,t);var l={toString:function(){return this.valid?"valid":this.error.message}};return l.errors=u.errors,l.missing=u.missing,l.valid=0===l.errors.length,l},addSchema:function(){return o.addSchema.apply(o,arguments)},getSchema:function(){return o.getSchema.apply(o,arguments)},getSchemaMap:function(){return o.getSchemaMap.apply(o,arguments)},getSchemaUris:function(){return o.getSchemaUris.apply(o,arguments)},getMissingUris:function(){return o.getMissingUris.apply(o,arguments)},dropSchemas:function(){o.dropSchemas.apply(o,arguments)},defineKeyword:function(){o.defineKeyword.apply(o,arguments)},defineError:function(e,t,n){if("string"!=typeof e||!/^[A-Z]+(_[A-Z]+)*$/.test(e))throw new Error("Code name must be a string in UPPER_CASE_WITH_UNDERSCORES");if("number"!=typeof t||t%1!=0||t<1e4)throw new Error("Code number must be an integer > 10000");if(void 0!==y[e])throw new Error("Error already defined: "+e+" as "+y[e]);if(void 0!==p[t])throw new Error("Error code already used: "+p[t]+" as "+t);for(var r in y[e]=t,p[t]=e,b[e]=b[t]=n,m){var o=m[r];o[e]&&(o[t]=o[t]||o[e])}},reset:function(){o.reset(),this.error=null,this.missing=[],this.valid=!0},missing:[],error:null,valid:!0,normSchema:d,resolveUrl:l,getDocumentUri:f,errorCodes:y};return s.language(t||"en"),s}();return _.addLanguage("en-gb",b),_.tv4=_,_})?r.apply(t,[]):r)||(e.exports=o)},function(e,t){!function(){"use strict";if(!Object.observe&&"function"==typeof Proxy){function e(e,t,n,r,o,i){var s,a=this;function c(e,r){if(c.delay=r,!c.pause&&a.changeset.length>0){if(!e){var o=a.changeset.filter(function(e){return!n||n.indexOf(e.type)>=0});o.length>0&&t(o)}a.changeset=[]}}return c.pause=o,c.delay=i,a.get=function(e,t){return"__observer__"===t?a:"unobserve"===t?function(){return Object.unobserve(e),e}:"deliver"===t?c:e[t]},a.target=e,a.changeset=[],a.target.__observerCallbacks__||(Object.defineProperty(e,"__observerCallbacks__",{enumerable:!1,configurable:!0,writable:!1,value:[]}),Object.defineProperty(e,"__observers__",{enumerable:!1,configurable:!0,writable:!1,value:[]})),a.target.__observerCallbacks__.push(t),a.target.__observers__.push(this),s=new Proxy(e,a),c(!1,i),s}e.prototype.deliver=function(){return this.get(null,"deliver")},e.prototype.set=function(e,t,n){var r=e[t],o=void 0===r?"add":"update";if(e[t]=n,e.__observers__.indexOf(this)>=0&&(!this.acceptlist||this.acceptlist.indexOf(o)>=0)){var i={object:e,name:t,type:o},s=0===this.changeset.length,a=this.deliver();"update"===o&&(i.oldValue=r),this.changeset.push(i),s&&a(!1,"number"==typeof a.delay?a.delay:10)}return!0},e.prototype.deleteProperty=function(e,t){var n=e[t];if(delete e[t],e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("delete")>=0){var r={object:e,name:t,type:"delete",oldValue:n},o=0===this.changeset.length,i=this.deliver();this.changeset.push(r),o&&i(!1,"number"==typeof i.delay?i.delay:10)}return!0},e.prototype.defineProperty=function(e,t,n){if(Object.defineProperty(e,t,n),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("reconfigure")>=0){var r={object:e,name:t,type:"reconfigure"},o=0===this.changeset.length,i=this.deliver();this.changeset.push(r),o&&i(!1,"number"==typeof i.delay?i.delay:10)}return!0},e.prototype.setPrototypeOf=function(e,t){var n=Object.getPrototypeOf(e);if(Object.setPrototypeOf(e,t),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("setPrototype")>=0){var r={object:e,name:"__proto__",type:"setPrototype",oldValue:n},o=0===this.changeset.length,i=this.deliver();this.changeset.push(r),o&&i(!1,"number"==typeof i.delay?i.delay:10)}return!0},e.prototype.preventExtensions=function(e){if(Object.preventExtensions(e),e.__observers__.indexOf(this)>=0&&!this.acceptlist||this.acceptlist.indexOf("preventExtensions")>=0){var t={object:e,type:"preventExtensions"},n=0===this.changeset.length,r=this.deliver();this.changeset.push(t),n&&r(!1,"number"==typeof r.delay?r.delay:10)}return!0},Object.observe=function(t,n,r,o,i,s){return new e(t,n,r,o,i,s)},Object.unobserve=function(e,t){if(e.__observerCallbacks__){if(!t)return e.__observerCallbacks__.splice(0,e.__observerCallbacks__.length),void e.__observers__.splice(0,e.__observers__.length);e.__observerCallbacks__.forEach(function(n,r){t===n&&(e.__observerCallbacks__.splice(r,1),delete e.__observers__[r].callback,e.__observers__.splice(r,1))})}},Array.observe=function(e,t,n,r,o,i){if(!(e instanceof Array||Array.isArray(e)))throw new TypeError("First argument to Array.observer is not an Array");n=n||["add","update","delete","splice"];var s=new Proxy(e,{get:function(t,r){return"unobserve"===r?function(e){return e?Object.unobserve(t,e):t.unobserve()}:"splice"===r?function(r,o){if("number"!=typeof r||"number"!=typeof o)throw new TypeError("First two arguments to Array splice are not number, number");var i=this.slice(r,r+o),s=arguments.length>1?arguments.length-2:0,c={object:e,type:"splice",index:r,removed:i,addedCount:s};if(t.splice.apply(t,arguments),n.indexOf("splice")>=0){r=0===a.__observer__.changeset.length;var u=a.__observer__.deliver();a.__observer__.changeset.push(c),r&&u(!1,"number"==typeof u.delay?u.delay:10)}}:"push"===r?function(e){return this.splice(this.length,0,e)}:"pop"===r?function(){return this.splice(this.length-1,1)}:"unshift"===r?function(e){return this.splice(0,0,e)}:"shift"===r?function(){return this.splice(0,1)}:t[r]}}),a=Object.observe(s,function(e){var r=e.filter(function(e){return"length"!==e.name&&"add"!==e.name&&(!n||n.indexOf(e.type)>=0)});r.length>0&&t(r)},n,r,o,i);return a},Array.unobserve=function(e,t){return e.unobserve(t)}}Object.deepObserve=function(e,t,n){var r=function(e){return{}.toString.call(e).match(/\s([a-zA-Z]+)/)[1].toLowerCase()};function o(e,n){Object.keys(e).forEach(function(o){if(("object"===r(e[o])||"array"===r(e[o]))&&!e[o].hasOwnProperty("__observers__")){var i=n.slice(0);i.push(o),e[o]=Object.deepObserve(e[o],t,i)}})}return o(e,n=n||[]),Object.observe(e,function(e){var r=[];e.forEach(function(e){var t=(n.length>0?n.join(".")+".":"")+e.name;"update"!==e.type&&"add"!==e.type||o(e.object,n),r.push({name:e.name,object:e.object,type:e.type,oldValue:e.oldValue,newValue:e.object[e.name],keypath:t}),function e(t,n,o,i,s){i instanceof Object?Object.keys(i).forEach(function(a){if(!o||o[a]!==i[a]){var c=o&&void 0!==o[a]?o[a]:void 0,u=void 0===c?"add":"update",l=s+"."+a;r.push({name:t,object:n,type:u,oldValue:c,newValue:i[a],keypath:l}),e(t,n,c,i[a],l)}}):o instanceof Object&&Object.keys(o).forEach(function(a){var c=null===i?"update":"delete",u=s+"."+a;r.push({name:t,object:n,type:c,oldValue:o[a],newValue:i,keypath:u}),e(t,n,o[a],void 0,u)})}(e.name,e.object,e.oldValue,e.object[e.name],t)}),t(r)})}}()},function(e,t,n){"use strict";n.r(t);var r=n(0);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.defaultBehaviour=!0,this.groups={}}return function(e,t,n){t&&o(e.prototype,t)}(e,[{key:"scheme",get:function(){return this._scheme},set:function(e){var t=e.message.from;Object(r.s)(t)?this._scheme=Object(r.k)(t).type:this._scheme=void 0}},{key:"date",get:function(){return this._date},set:function(e){var t=new Date,n=String(t.getDate());1===n.length&&(n="0"+n);var r=String(t.getMonth()+1);1===r.length&&(r="0"+r),this._date=n+"/"+r+"/"+t.getFullYear()}},{key:"domain",get:function(){return this._domain},set:function(e){void 0!==e.message.body.identity&&(this._domain=Object(r.j)(e.message.body.identity.userProfile.username).domain)}},{key:"type",get:function(){return this._type},set:function(e){var t=e.message;void 0!==t.body.value&&(this._type=t.body.value.resourceType)}},{key:"source",get:function(){return this._source},set:function(e){void 0!==e.message.body.identity&&(this._source=e.message.body.identity.userProfile.username)}},{key:"time",get:function(){return this._time},set:function(e){e=new Date;var t=String(e.getMinutes());1===t.length&&(t="0"+t),this._time=parseInt(String(e.getHours())+t)}},{key:"weekday",get:function(){return this._weekday},set:function(e){this._weekday=String((new Date).getDay())}}]),e}();t.default=i},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n.r(t);var i=n(1).getLogger("StorageManager"),s=function(){function e(t,n,r,o){arguments.length>4&&void 0!==arguments[4]&&arguments[4];var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("The Storage Manager needs the database instance");if(!n)throw Error("The Storage Manager needs the storage name");var a={};r?a=r:a[n]="key,version,value",t.open().then(function(e){i.info("Found database name "+e.name+" with version no: "+e.verno)}).catch(i.error),this.db=t,this.storageName=n,this._remoteStorage=s,this._runtimeUA=o}return function(e,t,n){t&&o(e.prototype,t)}(e,[{key:"connect",value:function(e){return this.db.connect(this._remoteStorage,e)}},{key:"disconnect",value:function(){var e=this;return new Promise(function(t,n){e.db.disconnect(e._remoteStorage).then(function(){t()},function(e){n(e)})})}},{key:"getBackupRevision",value:function(e){var t=this;return new Promise(function(e){t.db._syncNodes.get({type:"remote"}).then(function(t){console.log("[StorageManager.getBackupRevision] retrieved status: ",t),t&&t.hasOwnProperty("appliedRemoteRevision")&&(null===t.appliedRemoteRevision&&(t.appliedRemoteRevision=0),e(t.appliedRemoteRevision))})})}},{key:"_updateBackupRevision",value:function(e){var t=this;return new Promise(function(n){t.db._syncNodes.get({type:"remote"}).then(function(r){console.log("[StorageManager._updateBackupRevision] retrieved status: ",r),r&&r.hasOwnProperty("appliedRemoteRevision")&&(null===r.appliedRemoteRevision&&(r.appliedRemoteRevision=0),t._runtimeUA._updateRuntimeStatus({resource:e,value:{backupRevision:r.appliedRemoteRevision}}),n(r.appliedRemoteRevision))})})}},{key:"_checkKey",value:function(e){return"string"!=typeof e?e.toString():e}},{key:"_getTable",value:function(e){var t;try{t=this.db.table(this.storageName).name}catch(n){t=this.db.table(e).name}return t}},{key:"_getPrimaryKey",value:function(e){return this.db.table(e).schema.primKey.name}},{key:"_isDefaultSchema",value:function(e){var t=this._getTable(e),n=this.db[t].schema.instanceTemplate;return n.hasOwnProperty("value")&&n.hasOwnProperty("version")&&n.hasOwnProperty("key")}},{key:"set",value:function(e,t,n,r){var o=this,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return new Promise(function(a,c){i.info("[StorageManager] - set ",e,n),r=r||e;var u=o._getTable(r),l=o._getPrimaryKey(u),f=n;if(o._isDefaultSchema(r))f={key:e,version:t,value:n};else{var d={};d[l]=e,Object.assign(f,d)}o.db[u].put(f).then(function(){s&&f.backup&&f.url?o._updateBackupRevision(f.url).then(function(){a()}):a()},function(){a()})})}},{key:"get",value:function(e,t,n){var o=this;console.info("[StorageManager] - get ",e,t),n=n||e;var i=this._getTable(n);if(i){var s=this._getPrimaryKey(i);return this.db.transaction("rw!",this.db[i],function(){if(!e&&!t)return o.db[i].toArray().then(function(e){return e.length>0?e.reduce(function(e,t){return e[t[s]]=t,e},function(){return{}}):{}});if(!t)return o.db[i].where(s).equals(e).first().then(function(e){return e&&e.hasOwnProperty("value")?e.value:e});var n=r(t);switch(Array.isArray(t)&&(n="array"),n){case"string":return o.db[i].where(e).equals(t).first().then(function(e){return e&&e.hasOwnProperty("value")?e.value:e});case"object":var a="value."+Object.keys(t).toString(),c=Object.values(t);return console.log(a,c),o.db[i].where(a).anyOf(c).first().then(function(e){return e&&e.hasOwnProperty("value")?e.value:e});case"array":return console.log("ARRAY:",t),o.db[i].where(t).then(function(e){return e&&e.hasOwnProperty("value")?e.value:e})}})}}},{key:"getVersion",value:function(e,t,n){var r=this;i.info("[StorageManager] - getVersion for key ",e),n=n||e;var o=this._getTable(n),s=this._getPrimaryKey(o),a=t;return t||(a=e),this.db.transaction("rw!",this.db[o],function(){return r.db[o].where(s).equals(a).first().then(function(e){return e&&e.hasOwnProperty("version")?e.version:e}).catch(function(t){i.info("error getting the version for ",e," with error: ",t)})})}},{key:"delete",value:function(e,t,n){if(e){n=n||e;var r=this._getTable(n),o=this._getPrimaryKey(r),i=t;return t||(i=e),this.db[r].where(o).equals(i).delete()}return this.db.delete()}},{key:"remoteStorage",set:function(e){this._remoteStorage=e}}]),e}();t.default=s},function(e,t,n){"use strict";n.r(t);var r=n(1),o=n(18),i=n.n(o);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&s(e.prototype,t)}(e,[{key:"validate",value:function(e){i.a.addSchema(e.id,e);var t=i.a.validateMultiple(JSON.parse(JSON.stringify(this)),e);return t.errors.forEach(function(e){delete e.stack}),(!t.valid||t.missing.length>0)&&(console.warn("Object validation "+(t.valid?"succeeded, but schema contained references:":"failed:"),JSON.stringify(t,null,2)),console.log("Object:",JSON.stringify(this,null,2))),t.valid}}]),e}();function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h="hyperty_data_object",y=function(e){function t(e,n,r,o,i,s,a){var c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(c=l(this,f(t).call(this)))._guid=e,c._type=n,c._version=r,c._objectName=o,c._description=i,c._language=s,c._sourcePackageURL=a,c._signature=null,c._sourcePackage=null,c}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,a),function(e,t,n){t&&u(e.prototype,t)}(t,[{key:"guid",get:function(){return this._guid},set:function(e){e&&(this._guid=e)}},{key:"type",get:function(){return this._type},set:function(e){e&&(this._type=e)}},{key:"version",get:function(){return this._version},set:function(e){e&&(this._version=e)}},{key:"objectName",get:function(){return this._objectName},set:function(e){e&&(this._objectName=e)}},{key:"description",get:function(){return this._description},set:function(e){e&&(this._description=e)}},{key:"language",get:function(){return this._language},set:function(e){e&&(this._language=e)}},{key:"signature",get:function(){return this._signature},set:function(e){e&&(this._signature=e)}},{key:"sourcePackage",get:function(){return this._sourcePackage},set:function(e){e&&(this._sourcePackage=e)}},{key:"sourcePackageURL",get:function(){return this._sourcePackageURL},set:function(e){e&&(this._sourcePackageURL=e)}}]),t}();function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var v=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._sourceCode=n,this._sourceCodeClassname=t,this._encoding=null,this._signature=null}return function(e,t,n){t&&p(e.prototype,t)}(e,[{key:"sourceCode",get:function(){return this._sourceCode},set:function(e){e&&(this._sourceCode=e)}},{key:"sourceCodeClassname",get:function(){return this._sourceCodeClassname},set:function(e){e&&(this._sourceCodeClassname=e)}},{key:"encoding",get:function(){return this._encoding},set:function(e){e&&(this._encoding=e)}},{key:"signature",get:function(){return this._signature},set:function(e){e&&(this._signature=e)}}]),e}();function b(e){return(b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _(e,t){return(_=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var w=function(e){function t(e,n,r,o,i,s,a,c,u){var l;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(l=function(e,t){return!t||"object"!==b(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,m(t).call(this,e,n,r,o,i,s,a)))._configuration={},l._constraints={},l._policies={},l._messageSchema=null,l._hypertyType=c,l._dataObjects=u,l}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_(e,t)}(t,y),function(e,t,n){t&&g(e.prototype,t)}(t,[{key:"hypertyType",get:function(){return this._hypertyType},set:function(e){e&&(this._hypertyType=e)}},{key:"dataObjects",get:function(){return this._dataObjects},set:function(e){e&&(this._dataObjects=e)}},{key:"configuration",get:function(){return this._configuration},set:function(e){e&&(this._configuration=e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){e&&(this._constraints=e)}},{key:"messageSchema",get:function(){return this._messageSchema},set:function(e){e&&(this._messageSchema=e)}},{key:"policies",get:function(){return this._policies},set:function(e){e&&(this._policies=e)}}]),t}();function O(e){return(O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function R(e){return(R=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function P(e,t){return(P=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S=function(e){function t(e,n,r,o,i,s,a,c,u,l,f,d,h,y,p){var v;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(v=function(e,t){return!t||"object"!==O(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,R(t).call(this,e,n,r,o,i,s,a)))._messageSchemas=c,v._configuration=u||{},v._constraints=l||{},v._hypertyType=f,v._dataObjects=d||[],v._interworking=h,v._idpProxy=y,v._mutualAuthentication=p,v}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&P(e,t)}(t,y),function(e,t,n){t&&k(e.prototype,t)}(t,[{key:"messageSchemas",get:function(){return this._messageSchemas},set:function(e){e&&(this._messageSchemas=e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){e&&(this._constraints=e)}},{key:"configuration",get:function(){return this._configuration},set:function(e){e&&(this._configuration=e)}},{key:"hypertyType",get:function(){return this._hypertyType},set:function(e){this._hypertyType=e}},{key:"dataObjects",get:function(){return this._dataObjects},set:function(e){this._dataObjects=e}},{key:"interworking",get:function(){return this._interworking},set:function(e){this._interworking=e}},{key:"idpProxy",get:function(){return this._idpProxy},set:function(e){this._idpProxy=e}},{key:"mutualAuthentication",get:function(){return this._mutualAuthentication},set:function(e){this._mutualAuthentication=e}}]),t}();function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function C(e,t,n){return t&&M(e.prototype,t),n&&M(e,n),e}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function L(e,t){return(L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var I=function(e){function t(e,n,r,o,i,s,a,c,u,l,f,d){var h;return E(this,t),(h=function(e,t){return!t||"object"!==j(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,x(t).call(this,e,n,r,o,i,s,a)))._runtimeType=c,h._hypertyCapabilities=u||new T(!0,!1,!1,!1,!1),h._protocolCapabilities=l||new U(!0,!1,!0,!1,!1,!1),h._p2pHandlerStub=f,h._p2pRequesterStub=d,h}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&L(e,t)}(t,y),C(t,[{key:"runtimeType",get:function(){return this._runtimeType},set:function(e){e&&(this._runtimeType=e)}},{key:"hypertyCapabilities",get:function(){return this._hypertyCapabilities},set:function(e){e&&(this._hypertyCapabilities=e)}},{key:"protocolCapabilities",get:function(){return this._hypertyCapabilities},set:function(e){e&&(this._protocolCapabilities=e)}},{key:"p2pHandlerStub",get:function(){return this._p2pHandlerStub},set:function(e){this._p2pHandlerStub=e}},{key:"p2pRequesterStub",get:function(){return this._p2pRequesterStub},set:function(e){this._p2pRequesterStub=e}}]),t}(),T=function(){function e(t,n,r,o,i){E(this,e),this._isWebRTC=t,this._isMic=n,this._isCamera=r,this._isSensor=o,this._isORTC=i}return C(e,[{key:"getCapabilitySet",value:function(){return JSON.stringify(this)}},{key:"isMic",get:function(){return this._isMic}},{key:"isCamera",get:function(){return this._isCamera}},{key:"isSensor",get:function(){return this._isSensor}},{key:"isWebRTC",get:function(){return this._isWebRTC}},{key:"isORTCS",get:function(){return this._isORTC}}]),e}(),U=function(){function e(t,n,r,o,i,s){E(this,e),this._isHttp=t,this._isHttps=n,this._isWS=r,this._isWSS=o,this._isCoap=i,this._isDataChannel=s}return C(e,[{key:"isHttp",value:function(){return this._isHttp}},{key:"isHttps",value:function(){return this._isHttps}},{key:"isWS",value:function(){return this._isWS}},{key:"isSensorSupported",value:function(){return this._isSensor}},{key:"isWSS",value:function(){return this._isWSS}},{key:"isCoap",value:function(){return this._isCoap}},{key:"isDataChannel",value:function(){return this._isDataChannel}},{key:"getCapabilitySet",value:function(){return JSON.stringify(this)}}]),e}(),A=I;function D(e){return(D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function H(e){return(H=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function B(e,t){return(B=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var F=function(e){function t(e,n,r,o,i,s,a,c,u){var l;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(l=function(e,t){return!t||"object"!==D(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,H(t).call(this,e,n,r,o,i,s,a)))._configuration=c,l._policies=u,l}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&B(e,t)}(t,y),function(e,t,n){t&&N(e.prototype,t)}(t,[{key:"configuration",get:function(){return this._configuration},set:function(e){this._configuration=e}},{key:"policies",get:function(){return this._policies},set:function(e){this._policies=e}}]),t}();function K(e){return(K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function G(e,t){return!t||"object"!==K(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function V(e){return(V=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function W(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&function(e,t){(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}(e,t)}var J=function(e){function t(e,n,r,o,i,s,a){return q(this,t),G(this,V(t).call(this,e,n,r,o,i,s,a))}return W(t,y),t}(),Y=function(e){function t(e,n,r,o,i,s,a,c,u){var l;return q(this,t),(l=G(this,V(t).call(this,e,n,r,o,i,s,a)))._accessControlPolicy=c,l._scheme=u,l}return W(t,J),t}(),z=function(e){function t(e,n,r,o,i,s,a,c){return q(this,t),G(this,V(t).call(this,e,n,r,o,i,s,a,c))}return W(t,Y),t}(),$=function(e){function t(e,n,r,o,i,s,a,c){return q(this,t),G(this,V(t).call(this,e,n,r,o,i,s,a,c))}return W(t,Y),t}(),Q=function(e){function t(e,n,r,o,i,s,a,c){return q(this,t),G(this,V(t).call(this,e,n,r,o,i,s,a,c))}return W(t,Y),t}(),X=function(e){function t(e,n,r,o,i,s,a,c){return q(this,t),G(this,V(t).call(this,e,n,r,o,i,s,a,c))}return W(t,Y),t}();function Z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ee=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&Z(e.prototype,t)}(e,[{key:"createCatalogueDataObject",value:function(e,t,n,r,o,i,s){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i||void 0===s)throw new Error("Invalid parameters!");return new y(e,t,n,r,o,i,s)}},{key:"createHypertyDescriptorObject",value:function(e,t,n,r,o,i,s,a){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i||void 0===s||void 0===a)throw new Error("Invalid parameters!");return new w(e,"hyperty",t,n,r,o,i,s,a)}},{key:"createProtoStubDescriptorObject",value:function(e,t,n,r,o,i,s,a,c,u,l,f,d,h){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i||void 0===s||void 0===a||void 0===c)throw new Error("Invalid parameters!");return new S(e,"protostub",t,n,r,o,i,s,a,c,u,l,f,d,h)}},{key:"createHypertyRuntimeDescriptorObject",value:function(e,t,n,r,o,i,s,a,c,u,l){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i||void 0===s)throw new Error("Invalid parameters!");return new A(e,"hyperty_runtime",t,n,r,o,i,s,a,c,u,l)}},{key:"createHypertyInterceptorDescriptorObject",value:function(e,t,n,r,o,i,s,a){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i)throw new Error("Invalid parameters!");return new F(e,"hyperty_inspector",t,n,r,o,i,s,a)}},{key:"createDataObjectSchema",value:function(e,t,n,r,o,i){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i)throw new Error("Invalid parameters!");return new J(e,h,t,n,r,o,i)}},{key:"createMessageDataObjectSchema",value:function(e,t,n,r,o,i){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i)throw new Error("Invalid parameters!");return new J(e,h,t,n,r,o,i)}},{key:"createHypertyDataObjectSchema",value:function(e,t,n,r,o,i,s,a){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===o||void 0===i||void 0===a||void 0===s)throw new Error("Invalid parameters!");return"COMM"===a?new z(e,h,t,n,r,o,i,a,s):"CONNECTION"===a?new $(e,h,t,n,r,o,i,a,s):"CTXT"===a?new X(e,h,t,n,r,o,i,a,s):"IDENTITY"===a?new Q(e,h,t,n,r,o,i,a,s):void 0}},{key:"createSourcePackage",value:function(e,t){if(void 0===t||void 0===e)throw new Error("Invalid parameters!");return new v(e,t)}}]),e}();function te(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ne=r.getLogger("RuntimeCatalogue"),re=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("The catalogue needs the runtimeFactory");this._factory=new ee,this.httpRequest=t.createHttpRequest(),this.atob=t.atob?t.atob:atob;var o=n||"runtimeCatalogue",i=r||"&cguid, accessControlPolicy, constraints, dataObjects, hypertyType, objectName, sourcePackage, version",s={};s[o]=i,this.storageManager=t.storageManager(o,s)}return function(e,t,n){t&&te(e.prototype,t)}(e,[{key:"getDescriptor",value:function(e,t){var n=this,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=arguments.length>3?arguments[3]:void 0;ne.info("[RuntimeCatalogue] - getting descriptor from: ",e," with constraints: ",o);var i,s=!1,a=!1,c=i=(i=null!=o?Promise.all([this.httpRequest.post(e+"/version",{body:JSON.stringify(o)}),this.httpRequest.post(e+"/cguid",{body:JSON.stringify(o)})]):Promise.all([this.httpRequest.get(e+"/version"),this.httpRequest.get(e+"/cguid")])).then(function(t){var r=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}(t,2),i=r[0],a=r[1];return ne.log("[RuntimeCatalogue.getDescriptor] - got version ("+i+") and cguid ("+a+") for descriptor "+e),n.storageManager.getVersion("cguid",a).then(function(t){return t>=i?(ne.log("[RuntimeCatalogue.getDescriptor] local version is updated for ",e),s=!0,n.storageManager.get("cguid",a)):(ne.log("[RuntimeCatalogue.getDescriptor] local version not updated for ",e," retrieving from remote catalogue ..."),(null!=o?n.httpRequest.post(e,{body:JSON.stringify(o)}):n.httpRequest.get(e)).then(function(e){if((e=JSON.parse(e)).ERROR)throw new Error(e);return e}))})}).catch(function(t){var n="Unable to get descriptor for "+e+(null!=o?" with constraints "+o:"")+": "+t;throw ne.error(n),new Error(n)});return r&&(ne.log("adding promise to attach sourcePackage"),c=i.then(function(e){return e.sourcePackage?(a=!0,e):(a=!1,n.attachRawSourcePackage(e))})),c.then(function(e){return(!s||s&&!a&&r)&&n.storageManager.set(e.cguid,e.version,e),t.apply(n,[e,o])})}},{key:"attachRawSourcePackage",value:function(e,t){var n=this;return ne.log("attaching raw sourcePackage from:",e.sourcePackageURL),new Promise(function(r,o){(null!=t?n.httpRequest.post(e.sourcePackageURL,{body:JSON.stringify(t)}):n.httpRequest.get(e.sourcePackageURL)).then(function(t){t=JSON.parse(t),e.sourcePackage=t,r(e)}).catch(function(e){o(e)})})}},{key:"getHypertyDescriptor",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.getDescriptor(e,this.createHyperty,t,n)}},{key:"getStubDescriptor",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.getDescriptor(e,this.createStub,t,n)}},{key:"getRuntimeDescriptor",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.getDescriptor(e,this.createRuntimeDescriptor,t,n)}},{key:"getDataSchemaDescriptor",value:function(e){return!(arguments.length>1&&void 0!==arguments[1])||arguments[1],arguments.length>2&&arguments[2],new Promise(function(t){var n=e.split("/dataschema/")[1];ne.log("[RuntimeCatalogue.getDataSchemaDescriptor] schema ",n);var r={sourcePackage:{sourceCode:{properties:{}}}};switch(n){case"Context":case"ContextReporter":case"ContextObserver":r.sourcePackage.sourceCode.properties.scheme="context";break;case"Connection":r.sourcePackage.sourceCode.properties.scheme="connection";break;case"WalletData":r.sourcePackage.sourceCode.properties.scheme="walletData";break;case"Communication":r.sourcePackage.sourceCode.properties.scheme="comm",r.sourcePackage.sourceCode.properties.childrens=["resources"];break;case"HelloWorldDataSchema":r.sourcePackage.sourceCode.properties.scheme="hello";break;default:r.sourcePackage.sourceCode.properties.scheme="resource",r.sourcePackage.sourceCode.properties.childrens=[]}t(r)})}},{key:"getIdpProxyDescriptor",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.getDescriptor(e,this.createIdpProxy,t,n)}},{key:"createHyperty",value:function(e){var t=this._factory.createHypertyDescriptorObject(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL,e.type||e.hypertyType,e.dataObjects);t.configuration=e.configuration,t.constraints=e.constraints,t.messageSchema=e.messageSchema,t.policies=e.policies,t.signature=e.signature;var n=e.sourcePackage;return n&&(t.sourcePackage=this.createSourcePackage(n)),t}},{key:"createStub",value:function(e){var t=this._factory.createProtoStubDescriptorObject(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL,e.messageSchemas,e.configuration,e.constraints,e.hypertyType,e.dataObjects,e.interworking,e.idpProxy,e.mutualAuthentication);t.signature=e.signature;var n=e.sourcePackage;return n&&(t.sourcePackage=this.createSourcePackage(n)),t}},{key:"createRuntimeDescriptor",value:function(e){try{e.hypertyCapabilities=JSON.parse(e.hypertyCapabilities),e.protocolCapabilities=JSON.parse(e.protocolCapabilities)}catch(e){}var t=this._factory.createHypertyRuntimeDescriptorObject(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL,e.type||e.runtimeType,e.hypertyCapabilities,e.protocolCapabilities,e.p2pHandlerStub,e.p2pRequesterStub);t.signature=e.signature;var n=e.sourcePackage;return n&&(t.sourcePackage=this.createSourcePackage(n)),t}},{key:"createDataSchema",value:function(e){var t;(t=e.accessControlPolicy&&e.scheme?this._factory.createHypertyDataObjectSchema(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL,e.accessControlPolicy,e.scheme):this._factory.createMessageDataObjectSchema(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL)).signature=e.signature;var n=e.sourcePackage;if(n){t.sourcePackage=this.createSourcePackage(n);try{t.sourcePackage.sourceCode=JSON.parse(t.sourcePackage.sourceCode)}catch(e){ne.log("DataSchema Source code is already parsed")}return t}return t}},{key:"createIdpProxy",value:function(e){var t=this._factory.createProtoStubDescriptorObject(e.cguid,e.version,e.objectName,e.description,e.language,e.sourcePackageURL,e.messageSchemas,e.configuration,e.constraints,e.hypertyType,e.dataObjects,e.interworking,e.idpProxy,e.mutualAuthentication);t.signature=e.signature;var n=e.sourcePackage;return n&&(n=this.createSourcePackage(n),t.sourcePackage=n),t}},{key:"createSourcePackage",value:function(e){"base64"===e.encoding&&(e.sourceCode=this.atob(e.sourceCode),e.encoding="utf-8");var t=this._factory.createSourcePackage(e.sourceCodeClassname,e.sourceCode);return e.encoding&&(t.encoding=e.encoding),e.signature&&(t.signature=e.signature),t}},{key:"getSourcePackageFromURL",value:function(e){var t=this;return ne.log("getting sourcePackage from:",e),new Promise(function(n,r){t.httpRequest.get(e).then(function(e){if(e.ERROR)r(e);else{e=JSON.parse(e);var o=t.createSourcePackage(e);n(o)}}).catch(function(e){r(e)})})}},{key:"getSourceCodeFromDescriptor",value:function(e){var t=this;return new Promise(function(n,r){e.sourcePackage?n(e.sourcePackage.sourceCode):t.storageManager.getVersion(e.sourcePackageURL+"/sourceCode").then(function(o){o>=e.version?(ne.log("returning cached version from storageManager"),t.storageManager.get(e.sourcePackageURL+"/sourceCode").then(function(e){n(e)}).catch(function(e){r(e)})):t.httpRequest.get(e.sourcePackageURL+"/sourceCode").then(function(o){o.ERROR?r(o):(t.storageManager.set(e.sourcePackageURL+"/sourceCode",e.version,o),n(o))}).catch(function(e){r(e)})}).catch(function(e){r(e)})})}},{key:"getTypeList",value:function(e,t){var n=this;return new Promise(function(r,o){(null!=t?n.httpRequest.post(e,{body:JSON.stringify(t)}):n.httpRequest.get(e)).then(function(e){e=JSON.parse(e),r(e)}).catch(function(e){o(e)})})}},{key:"deleteFromPM",value:function(e){return this.storageManager.delete(e)}},{key:"runtimeURL",set:function(e){this._runtimeURL=e},get:function(){return this._runtimeURL}}]),e}();t.default=re},function(e,t,n){"use strict";n.r(t);var r=n(1);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.context=t}return function(e,t,n){t&&o(e.prototype,t)}(e,[{key:"enforcePolicies",value:function(e,t){var n=this;return new Promise(function(r,o){var i=n.context.getPolicies(e,t);void 0!==i?void 0!==i.serviceProviderPolicy?i.serviceProviderPolicy.enforceActions(n.context,e).then(function(e){r(e)},function(e){o(e)}):void 0!==i.userPolicy?i.userPolicy.enforceActions(n.context,e).then(function(e){r(e)},function(e){o(e)}):r([e]):r([e])})}},{key:"forwardToID",value:function(e,t){var n=this;if(!n.context.runtimeRegistry)throw new Error("forward message to given ID is unsupported in this environment");return new Promise(function(r,o){n.context.runtimeRegistry.hypertiesList[0].hypertyURL===e.to&&"runtime"!==e.to.split("://")[0]?n.context.runtimeRegistry.discoverHypertyPerUser(t).then(function(t){e.to=t.hypertyURL,e.body.via=void 0,r(e),n.context.runtimeRegistry._messageBus.postMessage(e)},function(e){o(e)}):r(e)})}},{key:"forwardToHyperty",value:function(e,t){var n=this;if(!n.context.runtimeRegistry)throw new Error("forward message to given ID is unsupported in this environment");return new Promise(function(r){n.context.runtimeRegistry.hypertiesList[0].hypertyURL===e.to&&"runtime"!==e.to.split("://")[0]?(e.to=t,e.body.via=void 0,r(e),n.context.runtimeRegistry._messageBus.postMessage(e)):r(e)})}},{key:"sendAutomaticMessage",value:function(e,t){var n=this;return new Promise(function(r){var o={from:e.to,to:e.from,body:{value:t},type:e.type};r(e),n.context.runtimeRegistry._messageBus.postMessage(o)})}}]),e}();function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&s(e.prototype,t)}(e,[{key:"and",value:function(e){return e[0]&&e[1]}},{key:"between",value:function(e){var t=parseInt(e[0][0]),n=parseInt(e[0][1]),r=e[1];return n<t&&(r=r<t?r+=2400:r,n+=2400),r>t&&r<n}},{key:"equals",value:function(e){return"*"===String(e[0])||String(e[0])===String(e[1])}},{key:"greaterThan",value:function(e){return e[1]>e[0]}},{key:"in",value:function(e){return e[0].indexOf(e[1])>-1}},{key:"lessThan",value:function(e){return e[1]<e[0]}},{key:"not",value:function(e){return!e[0]}},{key:"or",value:function(e){return e[0]||e[1]}}]),e}();function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.context=t,this.operators=new a}return function(e,t,n){t&&c(e.prototype,t)}(e,[{key:"evaluatePolicies",value:function(e,t){var n=this.context.getPolicies(e,t),r="Not Applicable";if(void 0!==n&&((r=this.evaluatePolicy(e,n.serviceProviderPolicy,t))||"Not Applicable"===r)){var o=this.evaluatePolicy(e,n.userPolicy,t);"Not Applicable"!==o&&(r=o)}return r}},{key:"evaluatePolicy",value:function(e,t,n){var r="Not Applicable";return t&&(r=t.evaluateRules(this.context,e,n)),r}}]),e}(),l=n(15),f=n(16),d=n(17);function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.attribute=t,this.operator=n,this.params=r,this.operators=new a}return function(e,t,n){t&&h(e.prototype,t)}(e,[{key:"isApplicable",value:function(e,t){e[this.attribute]={message:t};var n,r=e[this.attribute];return"in"!==this.operator||Array.isArray(this.params)?this.operators[this.operator]([this.params,r]):(n=e.getGroup(this.params,t.to),this.operators[this.operator]([n,r]))}}]),e}();function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t,n){return(b="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _=function(e){function t(e,n,r){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){return!t||"object"!==p(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,g(t).call(this,e,n,r))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,y),function(e,t,n){t&&v(e.prototype,t)}(t,[{key:"isApplicable",value:function(e,n){return!!("subscribe"===n.type&e.isFromRemoteSM(n.from))&&b(g(t.prototype),"isApplicable",this).call(this,e,n)}}]),t}();function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var O=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.operators=new a,void 0!==t.operators&&(t=t.condition),t=this.buildCondition(t),this.condition=t}return function(e,t,n){t&&w(e.prototype,t)}(e,[{key:"buildCondition",value:function(e){return Array.isArray(e[1])?e[1]=this.buildCondition(e[1]):"subscription"===e[1].attribute?e[1]=new _(e[1].attribute,e[1].operator,e[1].params):e[1]=new y(e[1].attribute,e[1].operator,e[1].params),void 0!==e[2]&&(Array.isArray(e[2])?e[2]=this.buildCondition(e[2]):"subscription"===e[2].attribute?e[2]=new _(e[2].attribute,e[2].operator,e[2].params):e[2]=new y(e[2].attribute,e[2].operator,e[2].params)),e}},{key:"isApplicable",value:function(e,t,n,r,o,i,s){for(o||(o=this.condition[0],i=this.condition[1],s=this.condition[2]);!(i instanceof y)&!(i instanceof _)&"boolean"!=typeof i;)i=this.isApplicable(e,t,n,r,i[0],i[1],i[2]);if(void 0!==s)for(;!(s instanceof y)&!(s instanceof _)&"boolean"!=typeof s;)s=this.isApplicable(e,t,n,r,s[0],s[1],s[2]);var a,c="boolean"==typeof i?i:i.isApplicable(e,t,n,r);return void 0!==s&&(a="boolean"==typeof s?s:s.isApplicable(e,t,n,r)),this.operators[o]([c,a])}}]),e}(),k=n(0);function R(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var P=function(){function e(t,n,r,o,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.decision=t,this.setCondition(n),this.priority=i,this.scope=r,this.target=o}return function(e,t,n){t&&R(e.prototype,t)}(e,[{key:"setCondition",value:function(e){if(e instanceof y||e instanceof O||e instanceof O)this.condition=e;else switch(e.attribute){case"subscription":this.condition=new O(e.attribute,e.operator,e.params);break;case void 0:this.condition=new O(e);break;default:this.condition=new y(e.attribute,e.operator,e.params)}}},{key:"evaluate",value:function(e,t,n){var r,o=n?t.to:t.from;switch(this.scope){case"global":break;case"hyperty":if(Object(k.s)(o)){var i=e.runtimeRegistry.getReporterURLSynchonous(Object(k.B)(o));void 0!==i&&(r=e.runtimeRegistry.getHypertyName(i))}else"hyperty"===o.split("://")[0]&&(r=e.runtimeRegistry.getHypertyName(Object(k.B)(o)));if(r===this.target)break;return"Not Applicable";case"identity":var s;if(Object(k.s)(o)){var a=e.runtimeRegistry.getReporterURLSynchonous(Object(k.B)(o));s=e.runtimeRegistry.getHypertyOwner(a)}else"hyperty"===o.split("://")[0]&&(s=e.runtimeRegistry.getHypertyOwner(Object(k.B)(o)));if(void 0!==s&&(s=Object(k.p)(s)),s===this.target)break;return"Not Applicable"}return this.condition.isApplicable(e,t,this.scope,this.target)?this.decision:"Not Applicable"}}]),e}();function S(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var j=function(){function e(t,n,r,o){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("key is not defined");if(!r)throw new Error("actions are not defined");this.actions=r,this.key=t,this._setRules(n),this._setCombiningAlgorithm(o)}return function(e,t,n){t&&S(e.prototype,t)}(e,[{key:"addAction",value:function(e,t){this.actions.push({method:e,param:t})}},{key:"createRule",value:function(e,t,n,r,o){void 0===o&&(o=this.getLastPriority()+1);var i=new P(e,t,n,r,o);this.rules.push(i)}},{key:"deleteRule",value:function(e){var t=this.rules.indexOf(e);this.rules.splice(t,1)}},{key:"enforceActions",value:function(e,t){var n=this;return new Promise(function(r,o){var i=[];if(0!==n.actions.length){for(var s in n.actions){var a=e.pep.actionsService[n.actions[s].method](t,n.actions[s].param);i.push(a)}Promise.all(i).then(function(e){r(e)},function(e){o(e)})}else r([t])})}},{key:"evaluateRules",value:function(e,t,n){var r=[];for(var o in this.rules)r.push(this.rules[o].evaluate(e,t,n));return this.combiningAlgorithm.combine(r)}},{key:"getLastPriority",value:function(){var e=[];if(0!==this.rules.length){for(var t in this.rules)e.push(this.rules[t].priority);return Math.max.apply(Math,e)}return-1}},{key:"getRuleByPriority",value:function(e){for(var t in this.rules)if(String(this.rules[t].priority)===String(e))return this.rules[t];throw Error("Rule with priority "+e+" does not exist!")}},{key:"_setCombiningAlgorithm",value:function(e){switch(e||(e="blockOverrides"),e){case"blockOverrides":this.combiningAlgorithm=new f.a;break;case"allowOverrides":this.combiningAlgorithm=new l.a;break;case"firstApplicable":this.combiningAlgorithm=new d.a;break;default:throw Error("Unknown algorithm: "+e)}}},{key:"_setRules",value:function(e){for(var t in this.rules=[],e){var n=e[t];void 0===n.priority&&(n.priority=this.getLastPriority()+1),n instanceof P||(n=new P(n.decision,n.condition,n.scope,n.target,n.priority)),this.rules.push(n)}}},{key:"sortRules",value:function(){return this.rules.sort(function(e,t){var n=e.priority,r=t.priority;return n<r?-1:n>r?1:0})}}]),e}();function E(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}r.getLogger("PEP");var M=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.pdp=new u(t),this.actionsService=new i(t),this.context=t,t.pep=this,t.loadConfigurations()}return function(e,t,n){t&&E(e.prototype,t)}(e,[{key:"addGUIListeners",value:function(){var e=this;e.context.messageBus.addListener(e.context.pepURL,function(t){var n,r=t.body.method;if("addToGroup"===r){var o=t.body.params.groupName,i=t.body.params.userEmail;n=e.context.addToGroup(o,i)}else if("createGroup"===r){var s=t.body.params.groupName;n=e.context.createGroup(s)}else if("addPolicy"===r){var a=t.body.params.source,c=t.body.params.key,u=t.body.params.policy,l=t.body.params.combiningAlgorithm;n=e.addPolicy(a,c,u,l)}else if("deleteGroup"===r){var f=t.body.params.groupName;n=e.context.deleteGroup(f)}else if("removePolicy"===r){var d=t.body.params.source,h=t.body.params.key;n=e.removePolicy(d,h)}else if("savePolicies"===r){var y=t.body.params.source;n=e.context.savePolicies(y)}else if("userPolicies"===r)n=e.context.userPolicies;else if("activeUserPolicy"===r){var p=t.body.params.userPolicy;p&&(e.context.activeUserPolicy=p),n=e.context.activeUserPolicy}else if("userPolicy"===r){var v=t.body.params.key;n=e.context.userPolicies[v]}else"saveActivePolicy"===r?n=e.context.saveActivePolicy():"getMyEmails"===r?n=e.context.getMyEmails():"getMyHyperties"===r?n=e.context.getMyHyperties():"groups"===r?n=e.context.groups:"getGroupsNames"===r&&(n=e.context.getGroupsNames());if("removeFromGroup"===r){var b=t.body.params.groupName,g=t.body.params.userEmail;n=e.context.removeFromGroup(b,g)}var m={type:"execute",value:n,code:200},_={id:t.id,type:"response",to:t.from,from:t.to,body:m};e.context.messageBus.postMessage(_)})}},{key:"addPolicy",value:function(e,t,n,r){if(!e)throw new Error("source is not defined");if(!t)throw new Error("key is not defined");switch(void 0===n?n=new j(t,[],[],r):n instanceof j||(n=new j(n.key,n.rules,n.actions,n.combiningAlgorithm)),e){case"SERVICE_PROVIDER":this.context.savePolicies(e,n,t);break;case"USER":this.context.userPolicies[t]=n,this.context.savePolicies(e);break;default:throw Error("Unknown policy source: "+e)}}},{key:"authorise",value:function(e,t){var n=this;if(!e)throw new Error("message is not defined");if(!e.from)throw new Error("message.from is not defined");if(!e.to)throw new Error("message.to is not defined");if(!e.type)throw new Error("message.type is not defined");return e.body=e.body||{},new Promise(function(r,o){e.body=e.body||{};var i=n,s=i.pdp.evaluatePolicies(e,t);"Not Applicable"===s&&(s=i.context.defaultBehaviour,e.body.auth=!1),i.actionsService.enforcePolicies(e,t).then(function(t){for(var n in t)if(e=t[n],s)e.body.auth=void 0===e.body.auth||e.body.auth,r(e);else{var i={body:{code:403,description:"Blocked by policy"},from:e.to,to:e.from,type:"response"};o(i)}},function(e){o(e)})})}},{key:"authoriseSync",value:function(e){var t;return e.body=e.body||{},"Not Applicable"===(t=this.pdp.evaluatePolicies(e,!0))&&(t=this.context.defaultBehaviour),t}},{key:"removePolicy",value:function(e,t){if(!e)throw new Error("source is not defined");if("*"!==e&&!t)throw new Error("key is not defined");switch(e){case"*":this.context.serviceProviderPolicy={},this.context.userPolicies={},this.context.activeUserPolicy=void 0,this.context.savePolicies("USER"),this.context.savePolicies("SERVICE_PROVIDER"),this.context.saveActivePolicy();break;case"SERVICE_PROVIDER":delete this.context.serviceProviderPolicy[t],this.context.savePolicies();break;case"USER":delete this.context.userPolicies[t],t===this.context.activeUserPolicy&&(this.context.activeUserPolicy=void 0,this.context.saveActivePolicy()),this.context.savePolicies("USER");break;default:throw Error("Unknown policy source: "+e)}}},{key:"messageBus",get:function(){return this.context.messageBus},set:function(e){this.context.messageBus=e,this.addGUIListeners()}}]),e}();t.default=M},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,o=Function.prototype.apply;function i(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new i(o.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new i(o.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(30),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(24))},function(e,t){var n,r,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var c,u=[],l=!1,f=-1;function d(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=a(d);l=!0;for(var t=u.length;t;){for(c=u,u=[];++f<t;)c&&c[f].run();f=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function p(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new y(e,t)),1!==u.length||l||a(h)},y.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=p,o.addListener=p,o.once=p,o.off=p,o.removeListener=p,o.removeAllListeners=p,o.emit=p,o.prependListener=p,o.prependOnceListener=p,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){(function(t,n){e.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=135)}([function(e,t){var n=e.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){var r=n(32)("wks"),o=n(22),i=n(1).Symbol,s="function"==typeof i;(e.exports=function(e){return r[e]||(r[e]=s&&i[e]||(s?i:o)("Symbol."+e))}).store=r},function(e,t,n){var r=n(1),o=n(0),i=n(10),s=n(9),a=function(e,t,n){var c,u,l,f=e&a.F,d=e&a.G,h=e&a.S,y=e&a.P,p=e&a.B,v=e&a.W,b=d?o:o[t]||(o[t]={}),g=b.prototype,m=d?r:h?r[t]:(r[t]||{}).prototype;for(c in d&&(n=t),n)(u=!f&&m&&void 0!==m[c])&&c in b||(l=u?m[c]:n[c],b[c]=d&&"function"!=typeof m[c]?n[c]:p&&u?i(l,r):v&&m[c]==l?function(e){var t=function(t,n,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((b.virtual||(b.virtual={}))[c]=l,e&a.R&&g&&!g[c]&&s(g,c,l)))};a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,e.exports=a},function(e,t,n){var r=n(7);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,n){var r=n(4),o=n(44),i=n(35),s=Object.defineProperty;t.f=n(6)?Object.defineProperty:function(e,t,n){if(r(e),t=i(t,!0),r(n),o)try{return s(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){e.exports=!n(11)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var r=n(5),o=n(16);e.exports=n(6)?function(e,t,n){return r.f(e,t,o(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var r=n(18);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,o){return e.call(t,n,r,o)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var r=n(45),o=n(25);e.exports=function(e){return r(o(e))}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t){e.exports={}},function(e,t,n){var r=n(53),o=n(27);e.exports=Object.keys||function(e){return r(e,o)}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var r=n(25);e.exports=function(e){return Object(r(e))}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){e.exports=!0},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var r=n(5).f,o=n(8),i=n(2)("toStringTag");e.exports=function(e,t,n){e&&!o(e=n?e:e.prototype,i)&&r(e,i,{configurable:!0,value:t})}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){"use strict";(function(e,n){var r=Object.keys,o=Array.isArray,i="undefined"!=typeof self?self:"undefined"!=typeof window?window:e;function s(e,t){return"object"!=typeof t?e:(r(t).forEach(function(n){e[n]=t[n]}),e)}var a=Object.getPrototypeOf,c={}.hasOwnProperty;function u(e,t){return c.call(e,t)}function l(e,t){"function"==typeof t&&(t=t(a(e))),r(t).forEach(function(n){d(e,n,t[n])})}var f=Object.defineProperty;function d(e,t,n,r){f(e,t,s(n&&u(n,"get")&&"function"==typeof n.get?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function h(e){return{from:function(t){return e.prototype=Object.create(t.prototype),d(e.prototype,"constructor",e),{extend:l.bind(null,e.prototype)}}}}var y=Object.getOwnPropertyDescriptor,p=[].slice;function v(e,t,n){return p.call(e,t,n)}function b(e,t){return t(e)}function g(e){var t=setTimeout(e,1e3);clearTimeout(t)}function m(e){if(!e)throw new Error("Assertion Failed")}function _(e){i.setImmediate?n(e):setTimeout(e,0)}function w(e,t){return e.reduce(function(e,n,r){var o=t(n,r);return o&&(e[o[0]]=o[1]),e},{})}function O(e,t,n){try{e.apply(null,n)}catch(e){t&&t(e)}}function k(e,t){if(u(e,t))return e[t];if(!t)return e;if("string"!=typeof t){for(var n=[],r=0,o=t.length;r<o;++r){var i=k(e,t[r]);n.push(i)}return n}var s=t.indexOf(".");if(-1!==s){var a=e[t.substr(0,s)];return void 0===a?void 0:k(a,t.substr(s+1))}}function R(e,t,n){if(e&&void 0!==t&&!("isFrozen"in Object&&Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){m("string"!=typeof n&&"length"in n);for(var r=0,o=t.length;r<o;++r)R(e,t[r],n[r])}else{var i=t.indexOf(".");if(-1!==i){var s=t.substr(0,i),a=t.substr(i+1);if(""===a)void 0===n?delete e[s]:e[s]=n;else{var c=e[s];c||(c=e[s]={}),R(c,a,n)}}else void 0===n?delete e[t]:e[t]=n}}function P(e){var t={};for(var n in e)u(e,n)&&(t[n]=e[n]);return t}var S=[].concat;function j(e){return S.apply([],e)}var E="Boolean,String,Date,RegExp,Blob,File,FileList,ArrayBuffer,DataView,Uint8ClampedArray,ImageData,Map,Set".split(",").concat(j([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return i[e]}).map(function(e){return i[e]});function M(e){if(!e||"object"!=typeof e)return e;var t;if(o(e)){t=[];for(var n=0,r=e.length;n<r;++n)t.push(M(e[n]))}else if(E.indexOf(e.constructor)>=0)t=e;else for(var i in t=e.constructor?Object.create(e.constructor.prototype):{},e)u(e,i)&&(t[i]=M(e[i]));return t}function C(e,t,n,o){return n=n||{},o=o||"",r(e).forEach(function(r){if(u(t,r)){var i=e[r],s=t[r];"object"==typeof i&&"object"==typeof s&&i&&s&&""+i.constructor==""+s.constructor?C(i,s,n,o+r+"."):i!==s&&(n[o+r]=t[r])}else n[o+r]=void 0}),r(t).forEach(function(r){u(e,r)||(n[o+r]=t[r])}),n}var x="undefined"!=typeof Symbol&&Symbol.iterator,L=x?function(e){var t;return null!=e&&(t=e[x])&&t.apply(e)}:function(){return null},I={};function T(e){var t,n,r,i;if(1===arguments.length){if(o(e))return e.slice();if(this===I&&"string"==typeof e)return[e];if(i=L(e)){for(n=[];!(r=i.next()).done;)n.push(r.value);return n}if(null==e)return[e];if("number"==typeof(t=e.length)){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var U="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function A(e,t){U=e,D=t}var D=function(){return!0},N=!new Error("").stack;function H(){if(N)try{throw H.arguments,new Error}catch(e){return e}return new Error}function B(e,t){var n=e.stack;return n?(t=t||0,0===n.indexOf(e.name)&&(t+=(e.name+e.message).split("\n").length),n.split("\n").slice(t).filter(D).map(function(e){return"\n"+e}).join("")):""}var F=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],K=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(F),q={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed"};function G(e,t){this._e=H(),this.name=e,this.message=t}function V(e,t,n,r){this._e=H(),this.failures=t,this.failedKeys=r,this.successCount=n}function W(e,t){this._e=H(),this.name="BulkError",this.failures=t,this.message=function(e,t){return e+". Errors: "+t.map(function(e){return e.toString()}).filter(function(e,t,n){return n.indexOf(e)===t}).join("\n")}(e,t)}h(G).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+B(this._e,2))}},toString:function(){return this.name+": "+this.message}}),h(V).from(G),h(W).from(G);var J=K.reduce(function(e,t){return e[t]=t+"Error",e},{}),Y=G,z=K.reduce(function(e,t){var n=t+"Error";function r(e,r){this._e=H(),this.name=n,e?"string"==typeof e?(this.message=e,this.inner=r||null):"object"==typeof e&&(this.message=e.name+" "+e.message,this.inner=e):(this.message=q[t]||n,this.inner=null)}return h(r).from(Y),e[t]=r,e},{});z.Syntax=SyntaxError,z.Type=TypeError,z.Range=RangeError;var $=F.reduce(function(e,t){return e[t+"Error"]=z[t],e},{}),Q=K.reduce(function(e,t){return-1===["Syntax","Type","Range"].indexOf(t)&&(e[t+"Error"]=z[t]),e},{});function X(){}function Z(e){return e}function ee(e,t){return null==e||e===Z?t:function(n){return t(e(n))}}function te(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function ne(e,t){return e===X?t:function(){var n=e.apply(this,arguments);void 0!==n&&(arguments[0]=n);var r=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var i=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?te(r,this.onsuccess):r),o&&(this.onerror=this.onerror?te(o,this.onerror):o),void 0!==i?i:n}}function re(e,t){return e===X?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?te(n,this.onsuccess):n),r&&(this.onerror=this.onerror?te(r,this.onerror):r)}}function oe(e,t){return e===X?t:function(n){var r=e.apply(this,arguments);s(n,r);var o=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return o&&(this.onsuccess=this.onsuccess?te(o,this.onsuccess):o),i&&(this.onerror=this.onerror?te(i,this.onerror):i),void 0===r?void 0===a?void 0:a:s(r,a)}}function ie(e,t){return e===X?t:function(){return!1!==t.apply(this,arguments)&&e.apply(this,arguments)}}function se(e,t){return e===X?t:function(){var n=e.apply(this,arguments);if(n&&"function"==typeof n.then){for(var r=this,o=arguments.length,i=new Array(o);o--;)i[o]=arguments[o];return n.then(function(){return t.apply(r,i)})}return t.apply(this,arguments)}}Q.ModifyError=V,Q.DexieError=G,Q.BulkError=W;var ae={},ce=100,ue=7,le=function(){try{return new Function("let F=async ()=>{},p=F();return [p,Object.getPrototypeOf(p),Promise.resolve(),F.constructor];")()}catch(t){var e=i.Promise;return e?[e.resolve(),e.prototype,e.resolve()]:[]}}(),fe=le[0],de=le[1],he=le[2],ye=de&&de.then,pe=fe&&fe.constructor,ve=le[3],be=!!he,ge=!1,me=he?function(){he.then(Be)}:i.setImmediate?n.bind(null,Be):i.MutationObserver?function(){var e=document.createElement("div");new MutationObserver(function(){Be(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(Be,0)},_e=function(e,t){Me.push([e,t]),Oe&&(me(),Oe=!1)},we=!0,Oe=!0,ke=[],Re=[],Pe=null,Se=Z,je={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ut,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(function(e){try{ut(e[0],e[1])}catch(e){}})}},Ee=je,Me=[],Ce=0,xe=[];function Le(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=X,this._lib=!1;var t=this._PSD=Ee;if(U&&(this._stackHolder=H(),this._prev=null,this._numPrev=0),"function"!=typeof e){if(e!==ae)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(!1===this._state&&Ue(this,this._value))}this._state=null,this._value=null,++t.ref,function e(t,n){try{n(function(n){if(null===t._state){if(n===t)throw new TypeError("A promise cannot be resolved with itself.");var r=t._lib&&Fe();n&&"function"==typeof n.then?e(t,function(e,t){n instanceof Le?n._then(e,t):n.then(e,t)}):(t._state=!0,t._value=n,Ae(t)),r&&Ke()}},Ue.bind(null,t))}catch(e){Ue(t,e)}}(this,e)}var Ie={get:function(){var e=Ee,t=$e;function n(n,r){var o=this,i=!e.global&&(e!==Ee||t!==$e);i&&et();var s=new Le(function(t,s){De(o,new Te(st(n,e,i),st(r,e,i),t,s,e))});return U&&He(s,this),s}return n.prototype=ae,n},set:function(e){d(this,"then",e&&e.prototype===ae?Ie:{get:function(){return e},set:Ie.set})}};function Te(e,t,n,r,o){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=r,this.psd=o}function Ue(e,t){if(Re.push(t),null===e._state){var n=e._lib&&Fe();t=Se(t),e._state=!1,e._value=t,U&&null!==t&&"object"==typeof t&&!t._promise&&O(function(){var n=function e(t,n){var r;return y(t,n)||(r=a(t))&&e(r,n)}(t,"stack");t._promise=e,d(t,"stack",{get:function(){return ge?n&&(n.get?n.get.apply(t):n.value):e.stack}})}),function(e){ke.some(function(t){return t._value===e._value})||ke.push(e)}(e),Ae(e),n&&Ke()}}function Ae(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)De(e,t[n]);var o=e._PSD;--o.ref||o.finalize(),0===Ce&&(++Ce,_e(function(){0==--Ce&&qe()},[]))}function De(e,t){if(null!==e._state){var n=e._state?t.onFulfilled:t.onRejected;if(null===n)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Ce,_e(Ne,[n,e,t])}else e._listeners.push(t)}function Ne(e,t,n){try{Pe=t;var r,o=t._value;t._state?r=e(o):(Re.length&&(Re=[]),r=e(o),-1===Re.indexOf(o)&&function(e){for(var t=ke.length;t;)if(ke[--t]._value===e._value)return void ke.splice(t,1)}(t)),n.resolve(r)}catch(e){n.reject(e)}finally{Pe=null,0==--Ce&&qe(),--n.psd.ref||n.psd.finalize()}}function He(e,t){var n=t?t._numPrev+1:0;n<ce&&(e._prev=t,e._numPrev=n)}function Be(){Fe()&&Ke()}function Fe(){var e=we;return we=!1,Oe=!1,e}function Ke(){var e,t,n;do{for(;Me.length>0;)for(e=Me,Me=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}}while(Me.length>0);we=!0,Oe=!0}function qe(){var e=ke;ke=[],e.forEach(function(e){e._PSD.onunhandled.call(null,e._value,e)});for(var t=xe.slice(0),n=t.length;n;)t[--n]()}function Ge(e){return new Le(ae,!1,e)}function Ve(e,t){var n=Ee;return function(){var r=Fe(),o=Ee;try{return rt(n,!0),e.apply(this,arguments)}catch(e){t&&t(e)}finally{rt(o,!1),r&&Ke()}}}l(Le.prototype,{then:Ie,_then:function(e,t){De(this,new Te(null,null,e,t,Ee))},catch:function(e){if(1===arguments.length)return this.then(null,e);var t=arguments[0],n=arguments[1];return"function"==typeof t?this.then(null,function(e){return e instanceof t?n(e):Ge(e)}):this.then(null,function(e){return e&&e.name===t?n(e):Ge(e)})},finally:function(e){return this.then(function(t){return e(),t},function(t){return e(),Ge(t)})},stack:{get:function(){if(this._stack)return this._stack;try{ge=!0;var e=function e(t,n,r){if(n.length===r)return n;var o="";if(!1===t._state){var i,s,a=t._value;null!=a?(i=a.name||"Error",s=a.message||a,o=B(a,0)):(i=a,s=""),n.push(i+(s?": "+s:"")+o)}return U&&((o=B(t._stackHolder,2))&&-1===n.indexOf(o)&&n.push(o),t._prev&&e(t._prev,n,r)),n}(this,[],20).join("\nFrom previous: ");return null!==this._state&&(this._stack=e),e}finally{ge=!1}}},timeout:function(e,t){var n=this;return e<1/0?new Le(function(r,o){var i=setTimeout(function(){return o(new z.Timeout(t))},e);n.then(r,o).finally(clearTimeout.bind(null,i))}):this}}),"undefined"!=typeof Symbol&&Symbol.toStringTag&&d(Le.prototype,Symbol.toStringTag,"Promise"),je.env=ot(),l(Le,{all:function(){var e=T.apply(null,arguments).map(tt);return new Le(function(t,n){0===e.length&&t([]);var r=e.length;e.forEach(function(o,i){return Le.resolve(o).then(function(n){e[i]=n,--r||t(e)},n)})})},resolve:function(e){if(e instanceof Le)return e;if(e&&"function"==typeof e.then)return new Le(function(t,n){e.then(t,n)});var t=new Le(ae,!0,e);return He(t,Pe),t},reject:Ge,race:function(){var e=T.apply(null,arguments).map(tt);return new Le(function(t,n){e.map(function(e){return Le.resolve(e).then(t,n)})})},PSD:{get:function(){return Ee},set:function(e){return Ee=e}},newPSD:Xe,usePSD:it,scheduler:{get:function(){return _e},set:function(e){_e=e}},rejectionMapper:{get:function(){return Se},set:function(e){Se=e}},follow:function(e,t){return new Le(function(n,r){return Xe(function(t,n){var r=Ee;r.unhandleds=[],r.onunhandled=n,r.finalize=te(function(){var e=this;!function(e){xe.push(function t(){e(),xe.splice(xe.indexOf(t),1)}),++Ce,_e(function(){0==--Ce&&qe()},[])}(function(){0===e.unhandleds.length?t():n(e.unhandleds[0])})},r.finalize),e()},t,n,r)})}});var We={awaits:0,echoes:0,id:0},Je=0,Ye=[],ze=0,$e=0,Qe=0;function Xe(e,t,n,r){var o=Ee,i=Object.create(o);i.parent=o,i.ref=0,i.global=!1,i.id=++Qe;var a=je.env;i.env=be?{Promise:Le,PromiseProp:{value:Le,configurable:!0,writable:!0},all:Le.all,race:Le.race,resolve:Le.resolve,reject:Le.reject,nthen:at(a.nthen,i),gthen:at(a.gthen,i)}:{},t&&s(i,t),++o.ref,i.finalize=function(){--this.parent.ref||this.parent.finalize()};var c=it(i,e,n,r);return 0===i.ref&&i.finalize(),c}function Ze(){return We.id||(We.id=++Je),++We.awaits,We.echoes+=ue,We.id}function et(e){!We.awaits||e&&e!==We.id||(0==--We.awaits&&(We.id=0),We.echoes=We.awaits*ue)}function tt(e){return We.echoes&&e&&e.constructor===pe?(Ze(),e.then(function(e){return et(),e},function(e){return et(),lt(e)})):e}function nt(){var e=Ye[Ye.length-1];Ye.pop(),rt(e,!1)}function rt(e,t){var n=Ee;if((t?!We.echoes||ze++&&e===Ee:!ze||--ze&&e===Ee)||function(e){ye.call(fe,e)}(t?function(e){++$e,We.echoes&&0!=--We.echoes||(We.echoes=We.id=0),Ye.push(Ee),rt(e,!0)}.bind(null,e):nt),e!==Ee&&(Ee=e,n===je&&(je.env=ot()),be)){var r=je.env.Promise,o=e.env;de.then=o.nthen,r.prototype.then=o.gthen,(n.global||e.global)&&(Object.defineProperty(i,"Promise",o.PromiseProp),r.all=o.all,r.race=o.race,r.resolve=o.resolve,r.reject=o.reject)}}function ot(){var e=i.Promise;return be?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(i,"Promise"),all:e.all,race:e.race,resolve:e.resolve,reject:e.reject,nthen:de.then,gthen:e.prototype.then}:{}}function it(e,t,n,r,o){var i=Ee;try{return rt(e,!0),t(n,r,o)}finally{rt(i,!1)}}function st(e,t,n){return"function"!=typeof e?e:function(){var r=Ee;n&&Ze(),rt(t,!0);try{return e.apply(this,arguments)}finally{rt(r,!1)}}}function at(e,t){return function(n,r){return e.call(this,st(n,t,!1),st(r,t,!1))}}var ct="unhandledrejection";function ut(e,t){var n;try{n=t.onuncatched(e)}catch(e){}if(!1!==n)try{var r,o={promise:t,reason:e};if(i.document&&document.createEvent?((r=document.createEvent("Event")).initEvent(ct,!0,!0),s(r,o)):i.CustomEvent&&s(r=new CustomEvent(ct,{detail:o}),o),r&&i.dispatchEvent&&(dispatchEvent(r),!i.PromiseRejectionEvent&&i.onunhandledrejection))try{i.onunhandledrejection(r)}catch(e){}r.defaultPrevented||console.warn("Unhandled rejection: "+(e.stack||e))}catch(e){}}g(function(){_e=function(e,t){setTimeout(function(){e.apply(null,t)},0)}});var lt=Le.reject;function ft(e){var t={},n=function(n,r){if(r){for(var o=arguments.length,i=new Array(o-1);--o;)i[o-1]=arguments[o];return t[n].subscribe.apply(null,i),e}if("string"==typeof n)return t[n]};n.addEventType=a;for(var i=1,s=arguments.length;i<s;++i)a(arguments[i]);return n;function a(e,i,s){if("object"==typeof e)return function(e){r(e).forEach(function(t){var n=e[t];if(o(n))a(t,e[t][0],e[t][1]);else{if("asap"!==n)throw new z.InvalidArgument("Invalid event config");var r=a(t,Z,function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];r.subscribers.forEach(function(e){_(function(){e.apply(null,t)})})})}})}(e);i||(i=ie),s||(s=X);var c={subscribers:[],fire:s,subscribe:function(e){-1===c.subscribers.indexOf(e)&&(c.subscribers.push(e),c.fire=i(c.fire,e))},unsubscribe:function(e){c.subscribers=c.subscribers.filter(function(t){return t!==e}),c.fire=c.subscribers.reduce(i,s)}};return t[e]=n[e]=c,c}}var dt,ht=String.fromCharCode(65535),yt=function(){try{return IDBKeyRange.only([[]]),[[]]}catch(e){return ht}}(),pt=-1/0,vt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",bt="String expected.",gt=[],mt="undefined"!=typeof navigator&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),_t=mt,wt=mt,Ot=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)};function kt(e,t){var n,a,c,f=kt.dependencies,h=s({addons:kt.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange},t),y=h.addons,p=h.autoOpen,_=h.indexedDB,S=h.IDBKeyRange,E=this._dbSchema={},x=[],L=[],A={},D=null,N=null,F=!1,K=null,q=!1,G="readwrite",J=this,Y=new Le(function(e){n=e}),$=new Le(function(e,t){a=t}),Q=!0,te=!!At(_);function ie(e){this._cfg={version:e,storesSource:null,dbschema:{},tables:{},contentUpgrade:null},this.stores({})}function ae(e,t,n){var o=J._createTransaction(G,L,E);o.create(t),o._completion.catch(n);var i=o._reject.bind(o);Xe(function(){Ee.trans=o,0===e?(r(E).forEach(function(e){ce(t,e,E[e].primKey,E[e].indexes)}),Le.follow(function(){return J.on.populate.fire(o)}).catch(i)):function(e,t,n){var o=[],i=x.filter(function(t){return t._cfg.version===e})[0];if(!i)throw new z.Upgrade("Dexie specification of currently installed DB version is missing");E=J._dbSchema=i._cfg.dbschema;var s=!1;return x.filter(function(t){return t._cfg.version>e}).forEach(function(e){o.push(function(){var r=E,o=e._cfg.dbschema;xe(r,n),xe(o,n),E=J._dbSchema=o;var i=function(e,t){var n={del:[],add:[],change:[]};for(var r in e)t[r]||n.del.push(r);for(r in t){var o=e[r],i=t[r];if(o){var s={name:r,def:i,recreate:!1,del:[],add:[],change:[]};if(o.primKey.src!==i.primKey.src)s.recreate=!0,n.change.push(s);else{var a=o.idxByName,c=i.idxByName;for(var u in a)c[u]||s.del.push(u);for(u in c){var l=a[u],f=c[u];l?l.src!==f.src&&s.change.push(f):s.add.push(f)}(s.del.length>0||s.add.length>0||s.change.length>0)&&n.change.push(s)}}else n.add.push([r,i])}return n}(r,o);if(i.add.forEach(function(e){ce(n,e[0],e[1].primKey,e[1].indexes)}),i.change.forEach(function(e){if(e.recreate)throw new z.Upgrade("Not yet support for changing primary key");var t=n.objectStore(e.name);e.add.forEach(function(e){ue(t,e)}),e.change.forEach(function(e){t.deleteIndex(e.name),ue(t,e)}),e.del.forEach(function(e){t.deleteIndex(e)})}),e._cfg.contentUpgrade)return s=!0,Le.follow(function(){e._cfg.contentUpgrade(t)})}),o.push(function(t){s&&_t||function(e,t){for(var n=0;n<t.db.objectStoreNames.length;++n){var r=t.db.objectStoreNames[n];null==e[r]&&t.db.deleteObjectStore(r)}}(e._cfg.dbschema,t)})}),function e(){return o.length?Le.resolve(o.shift()(t.idbtrans)).then(e):Le.resolve()}().then(function(){var e,t;t=n,r(e=E).forEach(function(n){t.db.objectStoreNames.contains(n)||ce(t,n,e[n].primKey,e[n].indexes)})})}(e,o,t).catch(i)})}function ce(e,t,n,r){var o=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(e){ue(o,e)}),o}function ue(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function le(e,t,n){this.name=e,this.schema=t,this._tx=n,this.hook=A[e]?A[e].hook:ft(null,{creating:[ne,X],reading:[ee,Z],updating:[oe,X],deleting:[re,X]})}function fe(e,t,n){return(n?Ct:Et)(function(n){e.push(n),t&&t()})}function de(e,t,n,r,o){return new Le(function(i,s){var a=n.length,c=a-1;if(0===a)return i();if(r){var u,l=Ct(s),f=jt(null);O(function(){for(var r=0;r<a;++r){u={onsuccess:null,onerror:null};var s=n[r];o.call(u,s[0],s[1],t);var d=e.delete(s[0]);d._hookCtx=u,d.onerror=l,d.onsuccess=r===c?jt(i):f}},function(e){throw u.onerror&&u.onerror(e),e})}else for(var d=0;d<a;++d){var h=e.delete(n[d]);h.onerror=Et(s),d===c&&(h.onsuccess=Ve(function(){return i()}))}})}function he(e,t,n,r){var o=this;this.db=J,this.mode=e,this.storeNames=t,this.idbtrans=null,this.on=ft(this,"complete","error","abort"),this.parent=r||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Le(function(e,t){o._resolve=e,o._reject=t}),this._completion.then(function(){o.active=!1,o.on.complete.fire()},function(e){var t=o.active;return o.active=!1,o.on.error.fire(e),o.parent?o.parent._reject(e):t&&o.idbtrans&&o.idbtrans.abort(),lt(e)})}function ye(e,t,n){this._ctx={table:e,index:":id"===t?null:t,or:n}}function be(e,t){var n=null,r=null;if(t)try{n=t()}catch(e){r=e}var o=e._ctx,i=o.table;this._ctx={table:i,index:o.index,isPrimKey:!o.index||i.schema.primKey.keyPath&&o.index===i.schema.primKey.name,range:n,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:r,or:o.or,valueMapper:i.hook.reading.fire}}function ge(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function me(e,t){return e._cfg.version-t._cfg.version}function _e(e,t,n){t.forEach(function(t){var r=n[t];e.forEach(function(e){t in e||(e===he.prototype||e instanceof he?d(e,t,{get:function(){return this.table(t)}}):e[t]=new le(t,r))})})}function we(e,t,n,r,o,i){var s=Ve(i?function(e,t,r){return n(i(e),t,r)}:n,o);e.onerror||(e.onerror=Et(o)),e.onsuccess=function(e,t){return function(){try{e.apply(this,arguments)}catch(e){t(e)}}}(t?function(){var n=e.result;if(n){var i=function(){n.continue()};t(n,function(e){i=e},r,o)&&s(n.value,n,function(e){i=e}),i()}else r()}:function(){var t=e.result;if(t){var n=function(){t.continue()};s(t.value,t,function(e){n=e}),n()}else r()},o)}function Oe(e,t){return _.cmp(e,t)}function ke(e,t){return Oe(e,t)<0?e:t}function Re(e,t){return Oe(e,t)>0?e:t}function Pe(e,t){return _.cmp(e,t)}function Se(e,t){return _.cmp(t,e)}function je(e,t){return e<t?-1:e===t?0:1}function Me(e,t){return e>t?-1:e===t?0:1}function Ce(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}function xe(e,t){for(var n=t.db.objectStoreNames,r=0;r<n.length;++r){var o=n[r],s=t.objectStore(o);c="getAll"in s;for(var a=0;a<s.indexNames.length;++a){var u=s.indexNames[a],l=s.index(u).keyPath,f="string"==typeof l?l:"["+v(l).join("+")+"]";if(e[o]){var d=e[o].idxByName[f];d&&(d.name=u)}}}/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&i.WorkerGlobalScope&&i instanceof i.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(c=!1)}function Ie(e){J.on("blocked").fire(e),gt.filter(function(e){return e.name===J.name&&e!==J&&!e._vcFired}).map(function(t){return t.on("versionchange").fire(e)})}this.version=function(e){if(D||F)throw new z.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=x.filter(function(t){return t._cfg.version===e})[0];return t||(t=new ie(e),x.push(t),x.sort(me),Q=!1,t)},s(ie.prototype,{stores:function(e){this._cfg.storesSource=this._cfg.storesSource?s(this._cfg.storesSource,e):e;var t={};x.forEach(function(e){s(t,e._cfg.storesSource)});var n=this._cfg.dbschema={};return this._parseStoresSpec(t,n),E=J._dbSchema=n,[A,J,he.prototype].forEach(function(e){for(var t in e)e[t]instanceof le&&delete e[t]}),_e([A,J,he.prototype,this._cfg.tables],r(n),n),L=r(n),this},upgrade:function(e){var t=this;return Rt(function(){e(J._createTransaction(G,r(t._cfg.dbschema),t._cfg.dbschema))}),this._cfg.contentUpgrade=e,this},_parseStoresSpec:function(e,t){r(e).forEach(function(n){if(null!==e[n]){var r={},i=function(e){var t=[];return e.split(",").forEach(function(e){var n=(e=e.trim()).replace(/([&*]|\+\+)/g,""),r=/^\[/.test(n)?n.match(/^\[(.*)\]$/)[1].split("+"):n;t.push(new It(n,r||null,/\&/.test(e),/\*/.test(e),/\+\+/.test(e),o(r),/\./.test(e)))}),t}(e[n]),s=i.shift();if(s.multi)throw new z.Schema("Primary key cannot be multi-valued");s.keyPath&&R(r,s.keyPath,s.auto?0:s.keyPath),i.forEach(function(e){if(e.auto)throw new z.Schema("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new z.Schema("Index must have a name and cannot be an empty string");R(r,e.keyPath,e.compound?e.keyPath.map(function(){return""}):"")}),t[n]=new Tt(n,s,i,r)}})}}),this._allTables=A,this._createTransaction=function(e,t,n,r){return new he(e,t,n,r)},this._whenReady=function(e){return Pt||q||Ee.letThrough?e():new Le(function(e,t){if(!F){if(!p)return void t(new z.DatabaseClosed);J.open().catch(X)}Y.then(e,t)}).then(e)},this.verno=0,this.open=function(){if(F||D)return Y.then(function(){return N?lt(N):J});U&&($._stackHolder=H()),F=!0,N=null,q=!1;var t=n,o=null;return Le.race([$,new Le(function(t,n){if(g(function(){return t()}),!_)throw new z.MissingAPI("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using old Safari versions, make sure to include indexedDB polyfill.");var i=Q?_.open(e):_.open(e,Math.round(10*J.verno));if(!i)throw new z.MissingAPI("IndexedDB API not available");i.onerror=Et(n),i.onblocked=Ve(Ie),i.onupgradeneeded=Ve(function(t){if(o=i.transaction,Q&&!J._allowEmptyDB){i.onerror=xt,o.abort(),i.result.close();var r=_.deleteDatabase(e);r.onsuccess=r.onerror=Ve(function(){n(new z.NoSuchDatabase("Database "+e+" doesnt exist"))})}else o.onerror=Et(n),ae((t.oldVersion>Math.pow(2,62)?0:t.oldVersion)/10,o,n)},n),i.onsuccess=Ve(function(){if(o=null,D=i.result,gt.push(J),Q)!function(){if(J.verno=D.version/10,J._dbSchema=E={},0!==(L=v(D.objectStoreNames,0)).length){var e=D.transaction(Ut(L),"readonly");L.forEach(function(t){for(var n=e.objectStore(t),r=n.keyPath,o=r&&"string"==typeof r&&-1!==r.indexOf("."),i=new It(r,r||"",!1,!1,!!n.autoIncrement,r&&"string"!=typeof r,o),s=[],a=0;a<n.indexNames.length;++a){var c=n.index(n.indexNames[a]);o=(r=c.keyPath)&&"string"==typeof r&&-1!==r.indexOf(".");var u=new It(c.name,r,!!c.unique,!!c.multiEntry,!1,r&&"string"!=typeof r,o);s.push(u)}E[t]=new Tt(t,i,s,{})}),_e([A],r(E),E)}}();else if(D.objectStoreNames.length>0)try{xe(E,D.transaction(Ut(D.objectStoreNames),"readonly"))}catch(e){}D.onversionchange=Ve(function(e){J._vcFired=!0,J.on("versionchange").fire(e)}),te||"__dbnames"===e||dt.dbnames.put({name:e}).catch(X),t()},n)})]).then(function(){return K=[],Le.resolve(kt.vip(J.on.ready.fire)).then(function e(){if(K.length>0){var t=K.reduce(se,X);return K=[],Le.resolve(kt.vip(t)).then(e)}})}).finally(function(){K=null}).then(function(){return F=!1,J}).catch(function(e){try{o&&o.abort()}catch(e){}return F=!1,J.close(),lt(N=e)}).finally(function(){q=!0,t()})},this.close=function(){var e=gt.indexOf(J);if(e>=0&&gt.splice(e,1),D){try{D.close()}catch(e){}D=null}p=!1,N=new z.DatabaseClosed,F&&a(N),Y=new Le(function(e){n=e}),$=new Le(function(e,t){a=t})},this.delete=function(){var t=arguments.length>0;return new Le(function(n,r){if(t)throw new z.InvalidArgument("Arguments not allowed in db.delete()");function o(){J.close();var t=_.deleteDatabase(e);t.onsuccess=Ve(function(){te||dt.dbnames.delete(e).catch(X),n()}),t.onerror=Et(r),t.onblocked=Ie}F?Y.then(o):o()})},this.backendDB=function(){return D},this.isOpen=function(){return null!==D},this.hasBeenClosed=function(){return N&&N instanceof z.DatabaseClosed},this.hasFailed=function(){return null!==N},this.dynamicallyOpened=function(){return Q},this.name=e,l(this,{tables:{get:function(){return r(A).map(function(e){return A[e]})}}}),this.on=ft(this,"populate","blocked","versionchange",{ready:[se,X]}),this.on.ready.subscribe=b(this.on.ready.subscribe,function(e){return function(t,n){kt.vip(function(){q?(N||Le.resolve().then(t),n&&e(t)):K?(K.push(t),n&&e(t)):(e(t),n||e(function e(){J.on.ready.unsubscribe(t),J.on.ready.unsubscribe(e)}))})}}),Rt(function(){J.on("populate").fire(J._createTransaction(G,L,E))}),this.transaction=function(){var e=function(e,t,n){var r=arguments.length;if(r<2)throw new z.InvalidArgument("Too few arguments");for(var o=new Array(r-1);--r;)o[r-1]=arguments[r];return n=o.pop(),[e,j(o),n]}.apply(this,arguments);return this._transaction.apply(this,e)},this._transaction=function(e,t,n){var r=Ee.trans;r&&r.db===J&&-1===e.indexOf("!")||(r=null);var o=-1!==e.indexOf("?");e=e.replace("!","").replace("?","");try{var i=t.map(function(e){var t=e instanceof le?e.name:e;if("string"!=typeof t)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return t});if("r"==e||"readonly"==e)e="readonly";else{if("rw"!=e&&e!=G)throw new z.InvalidArgument("Invalid transaction mode: "+e);e=G}if(r){if("readonly"===r.mode&&e===G){if(!o)throw new z.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");r=null}r&&i.forEach(function(e){if(r&&-1===r.storeNames.indexOf(e)){if(!o)throw new z.SubTransaction("Table "+e+" not included in parent transaction.");r=null}}),o&&r&&!r.active&&(r=null)}}catch(e){return r?r._promise(null,function(t,n){n(e)}):lt(e)}return r?r._promise(e,s,"lock"):Ee.trans?it(Ee.transless,function(){return J._whenReady(s)}):J._whenReady(s);function s(){return Le.resolve().then(function(){var t,o=Ee.transless||Ee,s=J._createTransaction(e,i,E,r),a={trans:s,transless:o};r?s.idbtrans=r.idbtrans:s.create(),n.constructor===ve&&Ze();var c=Le.follow(function(){if(t=n.call(s,s))if(t.constructor===pe){var e=et.bind(null,null);t.then(e,e)}else"function"==typeof t.next&&"function"==typeof t.throw&&(t=Lt(t))},a);return(t&&"function"==typeof t.then?Le.resolve(t).then(function(e){return s.active?e:lt(new z.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):c.then(function(){return t})).then(function(e){return r&&s._resolve(),s._completion.then(function(){return e})}).catch(function(e){return s._reject(e),lt(e)})})}},this.table=function(e){if(Pt&&Q)return new le(e);if(!u(A,e))throw new z.InvalidTable("Table "+e+" does not exist");return A[e]},l(le.prototype,{_trans:function(e,t,n){var r=this._tx||Ee.trans;return r&&r.db===J?r===Ee.trans?r._promise(e,t,n):Xe(function(){return r._promise(e,t,n)},{trans:r,transless:Ee.transless||Ee}):function e(t,n,r){if(q||Ee.letThrough){var o=J._createTransaction(t,n,E);try{o.create()}catch(e){return lt(e)}return o._promise(t,function(e,t){return Xe(function(){return Ee.trans=o,r(e,t,o)})}).then(function(e){return o._completion.then(function(){return e})})}if(!F){if(!p)return lt(new z.DatabaseClosed);J.open().catch(X)}return Y.then(function(){return e(t,n,r)})}(e,[this.name],t)},_idbstore:function(e,t,n){if(Pt)return new Le(t);var r=this.name;return this._trans(e,function(e,n,o){if(-1===o.storeNames.indexOf(r))throw new z.NotFound("Table"+r+" not part of transaction");return t(e,n,o.idbtrans.objectStore(r),o)},n)},get:function(e,t){if(e&&e.constructor===Object)return this.where(e).first(t);var n=this;return this._idbstore("readonly",function(t,r,o){Pt&&t(n.schema.instanceTemplate);var i=o.get(e);i.onerror=Et(r),i.onsuccess=Ve(function(){t(n.hook.reading.fire(i.result))},r)}).then(t)},where:function(e){if("string"==typeof e)return new ye(this,e);if(o(e))return new ye(this,"["+e.join("+")+"]");var t=r(e);if(1===t.length)return this.where(t[0]).equals(e[t[0]]);var n=this.schema.indexes.concat(this.schema.primKey).filter(function(e){return e.compound&&t.every(function(t){return e.keyPath.indexOf(t)>=0})&&e.keyPath.every(function(e){return t.indexOf(e)>=0})})[0];if(n&&yt!==ht)return this.where(n.name).equals(n.keyPath.map(function(t){return e[t]}));n||console.warn("The query "+JSON.stringify(e)+" on "+this.name+" would benefit of a compound index ["+t.join("+")+"]");var i=this.schema.idxByName,s=t.reduce(function(t,n){return[t[0]||i[n],t[0]||!i[n]?Ce(t[1],function(t){return""+k(t,n)==""+e[n]}):t[1]]},[null,null]),a=s[0];return a?this.where(a.name).equals(e[a.keyPath]).filter(s[1]):n?this.filter(s[1]):this.where(t).equals("")},count:function(e){return this.toCollection().count(e)},offset:function(e){return this.toCollection().offset(e)},limit:function(e){return this.toCollection().limit(e)},reverse:function(){return this.toCollection().reverse()},filter:function(e){return this.toCollection().and(e)},each:function(e){return this.toCollection().each(e)},toArray:function(e){return this.toCollection().toArray(e)},orderBy:function(e){return new be(new ye(this,o(e)?"["+e.join("+")+"]":e))},toCollection:function(){return new be(new ye(this))},mapToClass:function(e,t){this.schema.mappedClass=e;var n=Object.create(e.prototype);t&&St(n,t),this.schema.instanceTemplate=n;var r=function(t){if(!t)return t;var n=Object.create(e.prototype);for(var r in t)if(u(t,r))try{n[r]=t[r]}catch(e){}return n};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=r,this.hook("reading",r),e},defineClass:function(e){return this.mapToClass(kt.defineClass(e),e)},bulkDelete:function(e){return this.hook.deleting.fire===X?this._idbstore(G,function(t,n,r,o){t(de(r,o,e,!1,X))}):this.where(":id").anyOf(e).delete().then(function(){})},bulkPut:function(e,t){var n=this;return this._idbstore(G,function(r,o,i){if(!i.keyPath&&!n.schema.primKey.auto&&!t)throw new z.InvalidArgument("bulkPut() with non-inbound keys requires keys array in second argument");if(i.keyPath&&t)throw new z.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(t&&t.length!==e.length)throw new z.InvalidArgument("Arguments objects and keys must have the same length");if(0===e.length)return r();var s,a,c=function(e){0===u.length?r(e):o(new W(n.name+".bulkPut(): "+u.length+" of "+l+" operations failed",u))},u=[],l=e.length,f=n;if(n.hook.creating.fire===X&&n.hook.updating.fire===X){a=fe(u);for(var d=0,h=e.length;d<h;++d)(s=t?i.put(e[d],t[d]):i.put(e[d])).onerror=a;s.onerror=fe(u,c),s.onsuccess=Mt(c)}else{var y=t||i.keyPath&&e.map(function(e){return k(e,i.keyPath)}),p=y&&w(y,function(t,n){return null!=t&&[t,e[n]]});(y?f.where(":id").anyOf(y.filter(function(e){return null!=e})).modify(function(){this.value=p[this.primKey],p[this.primKey]=null}).catch(V,function(e){u=e.failures}).then(function(){for(var n=[],r=t&&[],o=y.length-1;o>=0;--o){var i=y[o];(null==i||p[i])&&(n.push(e[o]),t&&r.push(i),null!=i&&(p[i]=null))}return n.reverse(),t&&r.reverse(),f.bulkAdd(n,r)}).then(function(e){var t=y[y.length-1];return null!=t?t:e}):f.bulkAdd(e)).then(c).catch(W,function(e){u=u.concat(e.failures),c()}).catch(o)}},"locked")},bulkAdd:function(e,t){var n=this,r=this.hook.creating.fire;return this._idbstore(G,function(o,i,s,a){if(!s.keyPath&&!n.schema.primKey.auto&&!t)throw new z.InvalidArgument("bulkAdd() with non-inbound keys requires keys array in second argument");if(s.keyPath&&t)throw new z.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(t&&t.length!==e.length)throw new z.InvalidArgument("Arguments objects and keys must have the same length");if(0===e.length)return o();function c(e){0===d.length?o(e):i(new W(n.name+".bulkAdd(): "+d.length+" of "+h+" operations failed",d))}var u,l,f,d=[],h=e.length;if(r!==X){var y,p=s.keyPath;l=fe(d,null,!0),f=jt(null),O(function(){for(var n=0,o=e.length;n<o;++n){y={onerror:null,onsuccess:null};var i=t&&t[n],c=e[n],d=t?i:p?k(c,p):void 0,h=r.call(y,d,c,a);null==d&&null!=h&&(p?R(c=M(c),p,h):i=h),(u=null!=i?s.add(c,i):s.add(c))._hookCtx=y,n<o-1&&(u.onerror=l,y.onsuccess&&(u.onsuccess=f))}},function(e){throw y.onerror&&y.onerror(e),e}),u.onerror=fe(d,c,!0),u.onsuccess=jt(c)}else{l=fe(d);for(var v=0,b=e.length;v<b;++v)(u=t?s.add(e[v],t[v]):s.add(e[v])).onerror=l;u.onerror=fe(d,c),u.onsuccess=Mt(c)}})},add:function(e,t){var n=this.hook.creating.fire;return this._idbstore(G,function(r,o,i,s){var a={onsuccess:null,onerror:null};if(n!==X){var c=null!=t?t:i.keyPath?k(e,i.keyPath):void 0,u=n.call(a,c,e,s);null==c&&null!=u&&(i.keyPath?R(e,i.keyPath,u):t=u)}try{var l=null!=t?i.add(e,t):i.add(e);l._hookCtx=a,l.onerror=Ct(o),l.onsuccess=jt(function(t){var n=i.keyPath;n&&R(e,n,t),r(t)})}catch(e){throw a.onerror&&a.onerror(e),e}})},put:function(e,t){var n=this,r=this.hook.creating.fire,o=this.hook.updating.fire;if(r!==X||o!==X){var i=this.schema.primKey.keyPath,s=void 0!==t?t:i&&k(e,i);return null==s?this.add(e):(e=M(e),this._trans(G,function(){return n.where(":id").equals(s).modify(function(){this.value=e}).then(function(r){return 0===r?n.add(e,t):s})},"locked"))}return this._idbstore(G,function(n,r,o){var i=void 0!==t?o.put(e,t):o.put(e);i.onerror=Et(r),i.onsuccess=Ve(function(t){var r=o.keyPath;r&&R(e,r,t.target.result),n(i.result)})})},delete:function(e){return this.hook.deleting.subscribers.length?this.where(":id").equals(e).delete():this._idbstore(G,function(t,n,r){var o=r.delete(e);o.onerror=Et(n),o.onsuccess=Ve(function(){t(o.result)})})},clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(G,function(e,t,n){var r=n.clear();r.onerror=Et(t),r.onsuccess=Ve(function(){e(r.result)})})},update:function(e,t){if("object"!=typeof t||o(t))throw new z.InvalidArgument("Modifications must be an object.");if("object"!=typeof e||o(e))return this.where(":id").equals(e).modify(t);r(t).forEach(function(n){R(e,n,t[n])});var n=k(e,this.schema.primKey.keyPath);return void 0===n?lt(new z.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(n).modify(t)}}),l(he.prototype,{_lock:function(){return m(!Ee.global),++this._reculock,1!==this._reculock||Ee.global||(Ee.lockOwnerFor=this),this},_unlock:function(){if(m(!Ee.global),0==--this._reculock)for(Ee.global||(Ee.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{it(e[1],e[0])}catch(e){}}return this},_locked:function(){return this._reculock&&Ee.lockOwnerFor!==this},create:function(e){var t=this;if(!this.mode)return this;if(m(!this.idbtrans),!e&&!D)switch(N&&N.name){case"DatabaseClosedError":throw new z.DatabaseClosed(N);case"MissingAPIError":throw new z.MissingAPI(N.message,N);default:throw new z.OpenFailed(N)}if(!this.active)throw new z.TransactionInactive;return m(null===this._completion._state),(e=this.idbtrans=e||D.transaction(Ut(this.storeNames),this.mode)).onerror=Ve(function(n){xt(n),t._reject(e.error)}),e.onabort=Ve(function(n){xt(n),t.active&&t._reject(new z.Abort(e.error)),t.active=!1,t.on("abort").fire(n)}),e.oncomplete=Ve(function(){t.active=!1,t._resolve()}),this},_promise:function(e,t,n){var r=this;if(e===G&&this.mode!==G)return lt(new z.ReadOnly("Transaction is readonly"));if(!this.active)return lt(new z.TransactionInactive);if(this._locked())return new Le(function(o,i){r._blockedFuncs.push([function(){r._promise(e,t,n).then(o,i)},Ee])});if(n)return Xe(function(){var e=new Le(function(e,n){r._lock();var o=t(e,n,r);o&&o.then&&o.then(e,n)});return e.finally(function(){return r._unlock()}),e._lib=!0,e});var o=new Le(function(e,n){var o=t(e,n,r);o&&o.then&&o.then(e,n)});return o._lib=!0,o},_root:function(){return this.parent?this.parent._root():this},waitFor:function(e){var t=this._root();if(e=Le.resolve(e),t._waitingFor)t._waitingFor=t._waitingFor.then(function(){return e});else{t._waitingFor=e,t._waitingQueue=[];var n=t.idbtrans.objectStore(t.storeNames[0]);!function e(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(n.get(-1/0).onsuccess=e)}()}var r=t._waitingFor;return new Le(function(n,o){e.then(function(e){return t._waitingQueue.push(Ve(n.bind(null,e)))},function(e){return t._waitingQueue.push(Ve(o.bind(null,e)))}).finally(function(){t._waitingFor===r&&(t._waitingFor=null)})})},abort:function(){this.active&&this._reject(new z.Abort),this.active=!1},tables:{get:function(){return console.warn("Transaction.tables is deprecated. See https://github.com/dfahlander/Dexie.js/wiki/Deprecations. "+B(H(),1)),function(){return A}.apply(this,arguments)}},table:function(e){return new le(e,J.table(e).schema,this)}}),l(ye.prototype,function(){function e(e,t,n){var r=e instanceof ye?new be(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function t(e){return new be(e,function(){return S.only("")}).limit(0)}function n(e,t,n,r,o,i){for(var s=Math.min(e.length,r.length),a=-1,c=0;c<s;++c){var u=t[c];if(u!==r[c])return o(e[c],n[c])<0?e.substr(0,c)+n[c]+n.substr(c+1):o(e[c],r[c])<0?e.substr(0,c)+r[c]+n.substr(c+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):null;o(e[c],u)<0&&(a=c)}return s<r.length&&"next"===i?e+n.substr(e.length):s<e.length&&"prev"===i?e.substr(0,n.length):a<0?null:e.substr(0,a)+r[a]+n.substr(a+1)}function r(t,r,o,i){var s,a,c,u,l,f,d,h=o.length;if(!o.every(function(e){return"string"==typeof e}))return e(t,bt);function y(e){s=function(e){return"next"===e?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}(e),a=function(e){return"next"===e?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}(e),c="next"===e?je:Me;var t=o.map(function(e){return{lower:a(e),upper:s(e)}}).sort(function(e,t){return c(e.lower,t.lower)});u=t.map(function(e){return e.upper}),l=t.map(function(e){return e.lower}),f=e,d="next"===e?"":i}y("next");var p=new be(t,function(){return S.bound(u[0],l[h-1]+i)});p._ondirectionchange=function(e){y(e)};var v=0;return p._addAlgorithm(function(e,t,o){var i=e.key;if("string"!=typeof i)return!1;var s=a(i);if(r(s,l,v))return!0;for(var y=null,p=v;p<h;++p){var b=n(i,s,u[p],l[p],c,f);null===b&&null===y?v=p+1:(null===y||c(y,b)>0)&&(y=b)}return t(null!==y?function(){e.continue(y+d)}:o),!1}),p}return{between:function(n,r,o,i){o=!1!==o,i=!0===i;try{return Oe(n,r)>0||0===Oe(n,r)&&(o||i)&&(!o||!i)?t(this):new be(this,function(){return S.bound(n,r,!o,!i)})}catch(t){return e(this,vt)}},equals:function(e){return new be(this,function(){return S.only(e)})},above:function(e){return new be(this,function(){return S.lowerBound(e,!0)})},aboveOrEqual:function(e){return new be(this,function(){return S.lowerBound(e)})},below:function(e){return new be(this,function(){return S.upperBound(e,!0)})},belowOrEqual:function(e){return new be(this,function(){return S.upperBound(e)})},startsWith:function(t){return"string"!=typeof t?e(this,bt):this.between(t,t+ht,!0,!0)},startsWithIgnoreCase:function(e){return""===e?this.startsWith(e):r(this,function(e,t){return 0===e.indexOf(t[0])},[e],ht)},equalsIgnoreCase:function(e){return r(this,function(e,t){return e===t[0]},[e],"")},anyOfIgnoreCase:function(){var e=T.apply(I,arguments);return 0===e.length?t(this):r(this,function(e,t){return-1!==t.indexOf(e)},e,"")},startsWithAnyOfIgnoreCase:function(){var e=T.apply(I,arguments);return 0===e.length?t(this):r(this,function(e,t){return t.some(function(t){return 0===e.indexOf(t)})},e,ht)},anyOf:function(){var n=T.apply(I,arguments),r=Pe;try{n.sort(r)}catch(t){return e(this,vt)}if(0===n.length)return t(this);var o=new be(this,function(){return S.bound(n[0],n[n.length-1])});o._ondirectionchange=function(e){r="next"===e?Pe:Se,n.sort(r)};var i=0;return o._addAlgorithm(function(e,t,o){for(var s=e.key;r(s,n[i])>0;)if(++i===n.length)return t(o),!1;return 0===r(s,n[i])||(t(function(){e.continue(n[i])}),!1)}),o},notEqual:function(e){return this.inAnyRange([[pt,e],[e,yt]],{includeLowers:!1,includeUppers:!1})},noneOf:function(){var t=T.apply(I,arguments);if(0===t.length)return new be(this);try{t.sort(Pe)}catch(t){return e(this,vt)}var n=t.reduce(function(e,t){return e?e.concat([[e[e.length-1][1],t]]):[[pt,t]]},null);return n.push([t[t.length-1],yt]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})},inAnyRange:function(n,r){if(0===n.length)return t(this);if(!n.every(function(e){return void 0!==e[0]&&void 0!==e[1]&&Pe(e[0],e[1])<=0}))return e(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",z.InvalidArgument);var o,i=!r||!1!==r.includeLowers,s=r&&!0===r.includeUppers,a=Pe;function c(e,t){return a(e[0],t[0])}try{(o=n.reduce(function(e,t){for(var n=0,r=e.length;n<r;++n){var o=e[n];if(Oe(t[0],o[1])<0&&Oe(t[1],o[0])>0){o[0]=ke(o[0],t[0]),o[1]=Re(o[1],t[1]);break}}return n===r&&e.push(t),e},[])).sort(c)}catch(t){return e(this,vt)}var u=0,l=s?function(e){return Pe(e,o[u][1])>0}:function(e){return Pe(e,o[u][1])>=0},f=i?function(e){return Se(e,o[u][0])>0}:function(e){return Se(e,o[u][0])>=0},d=l,h=new be(this,function(){return S.bound(o[0][0],o[o.length-1][1],!i,!s)});return h._ondirectionchange=function(e){"next"===e?(d=l,a=Pe):(d=f,a=Se),o.sort(c)},h._addAlgorithm(function(e,t,n){for(var r=e.key;d(r);)if(++u===o.length)return t(n),!1;return!!function(e){return!l(e)&&!f(e)}(r)||0!==Oe(r,o[u][1])&&0!==Oe(r,o[u][0])&&(t(function(){a===Pe?e.continue(o[u][0]):e.continue(o[u][1])}),!1)}),h},startsWithAnyOf:function(){var n=T.apply(I,arguments);return n.every(function(e){return"string"==typeof e})?0===n.length?t(this):this.inAnyRange(n.map(function(e){return[e,e+ht]})):e(this,"startsWithAnyOf() only works with strings")}}}),l(be.prototype,function(){function e(e,t){e.filter=Ce(e.filter,t)}function t(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return Ce(r(),t())}:t,e.justLimit=n&&!r}function n(e,t){if(e.isPrimKey)return t;var n=e.table.schema.idxByName[e.index];if(!n)throw new z.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return t.index(n.name)}function o(e,t){var r=n(e,t);return e.keysOnly&&"openKeyCursor"in r?r.openKeyCursor(e.range||null,e.dir+e.unique):r.openCursor(e.range||null,e.dir+e.unique)}function i(e,t,n,r,i){var s=e.replayFilter?Ce(e.filter,e.replayFilter()):e.filter;e.or?function(){var a={},c=0;function l(){2==++c&&n()}function f(e,n,o){if(!s||s(n,o,l,r)){var i=n.primaryKey,c=""+i;"[object ArrayBuffer]"===c&&(c=""+new Uint8Array(i)),u(a,c)||(a[c]=!0,t(e,n,o))}}e.or._iterate(f,l,r,i),we(o(e,i),e.algorithm,f,l,r,!e.keysOnly&&e.valueMapper)}():we(o(e,i),Ce(e.algorithm,s),t,n,r,!e.keysOnly&&e.valueMapper)}function a(e){return e.table.schema.instanceTemplate}return{_read:function(e,t){var n=this._ctx;return n.error?n.table._trans(null,lt.bind(null,n.error)):n.table._idbstore("readonly",e).then(t)},_write:function(e){var t=this._ctx;return t.error?t.table._trans(null,lt.bind(null,t.error)):t.table._idbstore(G,e,"locked")},_addAlgorithm:function(e){var t=this._ctx;t.algorithm=Ce(t.algorithm,e)},_iterate:function(e,t,n,r){return i(this._ctx,e,t,n,r)},clone:function(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&s(n,e),t._ctx=n,t},raw:function(){return this._ctx.valueMapper=null,this},each:function(e){var t=this._ctx;if(Pt){var n=a(t),r=t.table.schema.primKey.keyPath,o=k(n,t.index?t.table.schema.idxByName[t.index].keyPath:r),s=k(n,r);e(n,{key:o,primaryKey:s})}return this._read(function(n,r,o){i(t,e,n,r,o)})},count:function(e){if(Pt)return Le.resolve(0).then(e);var t=this._ctx;if(ge(t,!0))return this._read(function(e,r,o){var i=n(t,o),s=t.range?i.count(t.range):i.count();s.onerror=Et(r),s.onsuccess=function(n){e(Math.min(n.target.result,t.limit))}},e);var r=0;return this._read(function(e,n,o){i(t,function(){return++r,!1},function(){e(r)},n,o)},e)},sortBy:function(e,t){var n=e.split(".").reverse(),r=n[0],o=n.length-1;function i(e,t){return t?i(e[n[t]],t-1):e[r]}var s="next"===this._ctx.dir?1:-1;function a(e,t){var n=i(e,o),r=i(t,o);return n<r?-s:n>r?s:0}return this.toArray(function(e){return e.sort(a)}).then(t)},toArray:function(e){var t=this._ctx;return this._read(function(e,r,o){if(Pt&&e([a(t)]),c&&"next"===t.dir&&ge(t,!0)&&t.limit>0){var s=t.table.hook.reading.fire,u=n(t,o),l=t.limit<1/0?u.getAll(t.range,t.limit):u.getAll(t.range);l.onerror=Et(r),l.onsuccess=Mt(s===Z?e:function(t){try{e(t.map(s))}catch(e){r(e)}})}else{var f=[];i(t,function(e){f.push(e)},function(){e(f)},r,o)}},e)},offset:function(e){var n=this._ctx;return e<=0?this:(n.offset+=e,ge(n)?t(n,function(){var t=e;return function(e,n){return 0===t||(1===t?(--t,!1):(n(function(){e.advance(t),t=0}),!1))}}):t(n,function(){var t=e;return function(){return--t<0}}),this)},limit:function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),t(this._ctx,function(){var t=e;return function(e,n,r){return--t<=0&&n(r),t>=0}},!0),this},until:function(t,n){var r=this._ctx;return Pt&&t(a(r)),e(this._ctx,function(e,r,o){return!t(e.value)||(r(o),n)}),this},first:function(e){return this.limit(1).toArray(function(e){return e[0]}).then(e)},last:function(e){return this.reverse().first(e)},filter:function(t){return Pt&&t(a(this._ctx)),e(this._ctx,function(e){return t(e.value)}),function(e,t){e.isMatch=Ce(e.isMatch,t)}(this._ctx,t),this},and:function(e){return this.filter(e)},or:function(e){return new ye(this._ctx.table,e,this)},reverse:function(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},desc:function(){return this.reverse()},eachKey:function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.key,n)})},eachUniqueKey:function(e){return this._ctx.unique="unique",this.eachKey(e)},eachPrimaryKey:function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(t,n){e(n.primaryKey,n)})},keys:function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var n=[];return this.each(function(e,t){n.push(t.key)}).then(function(){return n}).then(e)},primaryKeys:function(e){var t=this._ctx;if(c&&"next"===t.dir&&ge(t,!0)&&t.limit>0)return this._read(function(e,r,o){var i=n(t,o),s=t.limit<1/0?i.getAllKeys(t.range,t.limit):i.getAllKeys(t.range);s.onerror=Et(r),s.onsuccess=Mt(e)}).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(e,t){r.push(t.primaryKey)}).then(function(){return r}).then(e)},uniqueKeys:function(e){return this._ctx.unique="unique",this.keys(e)},firstKey:function(e){return this.limit(1).keys(function(e){return e[0]}).then(e)},lastKey:function(e){return this.reverse().firstKey(e)},distinct:function(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return e(this._ctx,function(e){var t=e.primaryKey.toString(),n=u(r,t);return r[t]=!0,!n}),this},modify:function(e){var t=this,n=this._ctx,o=n.table.hook,i=o.updating.fire,a=o.deleting.fire;return Pt&&"function"==typeof e&&e.call({value:n.table.schema.instanceTemplate},n.table.schema.instanceTemplate),this._write(function(n,o,c,l){var f;if("function"==typeof e)f=i===X&&a===X?e:function(t){var n=M(t);if(!1===e.call(this,t,this))return!1;if(u(this,"value")){var o=C(n,this.value),s=i.call(this,o,this.primKey,n,l);s&&(t=this.value,r(s).forEach(function(e){R(t,e,s[e])}))}else a.call(this,this.primKey,t,l)};else if(i===X){var d=r(e),h=d.length;f=function(t){for(var n=!1,r=0;r<h;++r){var o=d[r],i=e[o];k(t,o)!==i&&(R(t,o,i),n=!0)}return n}}else{var y=e;e=P(y),f=function(t){var n=!1,o=i.call(this,e,this.primKey,M(t),l);return o&&s(e,o),r(e).forEach(function(r){var o=e[r];k(t,r)!==o&&(R(t,r,o),n=!0)}),o&&(e=P(y)),n}}var p=0,v=0,b=!1,g=[],m=[],_=null;function w(e){return e&&(g.push(e),m.push(_)),o(new V("Error modifying one or more objects",g,v,m))}function S(){b&&v+g.length===p&&(g.length>0?w():n(v))}t.clone().raw()._iterate(function(e,t){_=t.primaryKey;var n={primKey:t.primaryKey,value:e,onsuccess:null,onerror:null};function r(e){return g.push(e),m.push(n.primKey),S(),!0}if(!1!==f.call(n,e,n)){var o=!u(n,"value");++p,O(function(){var e=o?t.delete():t.update(n.value);e._hookCtx=n,e.onerror=Ct(r),e.onsuccess=jt(function(){++v,S()})},r)}else n.onsuccess&&n.onsuccess(n.value)},function(){b=!0,S()},w,c)})},delete:function(){var e=this,t=this._ctx,n=t.range,r=t.table.hook.deleting.fire,o=r!==X;if(!o&&ge(t)&&(t.isPrimKey&&!wt||!n))return this._write(function(e,t,r){var o=Et(t),i=n?r.count(n):r.count();i.onerror=o,i.onsuccess=function(){var s=i.result;O(function(){var t=n?r.delete(n):r.clear();t.onerror=o,t.onsuccess=function(){return e(s)}},function(e){return t(e)})}});var i=o?2e3:1e4;return this._write(function(n,s,a,c){var u=0,l=e.clone({keysOnly:!t.isMatch&&!o}).distinct().limit(i).raw(),f=[],d=function(){return l.each(o?function(e,t){f.push([t.primaryKey,t.value])}:function(e,t){f.push(t.primaryKey)}).then(function(){return o?f.sort(function(e,t){return Pe(e[0],t[0])}):f.sort(Pe),de(a,c,f,o,r)}).then(function(){var e=f.length;return f=[],e<i?u+=e:d()})};n(d())})}}}),s(this,{Collection:be,Table:le,Transaction:he,Version:ie,WhereClause:ye}),J.on("versionchange",function(e){e.newVersion>0?console.warn("Another connection wants to upgrade database '"+J.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+J.name+"'. Closing db now to resume the delete request."),J.close()}),J.on("blocked",function(e){!e.newVersion||e.newVersion<e.oldVersion?console.warn("Dexie.delete('"+J.name+"') was blocked"):console.warn("Upgrade '"+J.name+"' blocked by other connection holding version "+e.oldVersion/10)}),y.forEach(function(e){e(J)})}A(U,Ot);var Rt=function(){},Pt=!1;function St(e,t){return r(t).forEach(function(n){var r=function e(t){if("function"==typeof t)return new t;if(o(t))return[e(t[0])];if(t&&"object"==typeof t){var n={};return St(n,t),n}return t}(t[n]);e[n]=r}),e}function jt(e){return Ve(function(t){var n=t.target,r=n.result,o=n._hookCtx,i=o&&o.onsuccess;i&&i(r),e&&e(r)},e)}function Et(e){return Ve(function(t){return xt(t),e(t.target.error),!1})}function Mt(e){return Ve(function(t){e(t.target.result)})}function Ct(e){return Ve(function(t){var n=t.target,r=n.error,o=n._hookCtx,i=o&&o.onerror;return i&&i(r),xt(t),e(r),!1})}function xt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}function Lt(e){var t=function(t){return e.next(t)},n=i(t),r=i(function(t){return e.throw(t)});function i(e){return function(t){var i=e(t),s=i.value;return i.done?s:s&&"function"==typeof s.then?s.then(n,r):o(s)?Le.all(s).then(n,r):n(s)}}return i(t)()}function It(e,t,n,r,o,i,s){this.name=e,this.keyPath=t,this.unique=n,this.multi=r,this.auto=o,this.compound=i,this.dotted=s;var a="string"==typeof t?t:t&&"["+[].join.call(t,"+")+"]";this.src=(n?"&":"")+(r?"*":"")+(o?"++":"")+a}function Tt(e,t,n,r){this.name=e,this.primKey=t||new It,this.indexes=n||[new It],this.instanceTemplate=r,this.mappedClass=null,this.idxByName=w(n,function(e){return[e.name,e]})}function Ut(e){return 1===e.length?e[0]:e}function At(e){var t=e&&(e.getDatabaseNames||e.webkitGetDatabaseNames);return t&&t.bind(e)}l(kt,Q),l(kt,{delete:function(e){var t=new kt(e),n=t.delete();return n.onblocked=function(e){return t.on("blocked",e),this},n},exists:function(e){return new kt(e).open().then(function(e){return e.close(),!0}).catch(kt.NoSuchDatabaseError,function(){return!1})},getDatabaseNames:function(e){var t=At(kt.dependencies.indexedDB);return t?new Le(function(e,n){var r=t();r.onsuccess=function(t){e(v(t.target.result,0))},r.onerror=Et(n)}).then(e):dt.dbnames.toCollection().primaryKeys(e)},defineClass:function(e){return function(t){t?s(this,t):Pt&&St(this,e)}},applyStructure:St,ignoreTransaction:function(e){return Ee.trans?it(Ee.transless,e):e()},vip:function(e){return Xe(function(){return Ee.letThrough=!0,e()})},async:function(e){return function(){try{var t=Lt(e.apply(this,arguments));return t&&"function"==typeof t.then?t:Le.resolve(t)}catch(e){return lt(e)}}},spawn:function(e,t,n){try{var r=Lt(e.apply(n,t||[]));return r&&"function"==typeof r.then?r:Le.resolve(r)}catch(e){return lt(e)}},currentTransaction:{get:function(){return Ee.trans||null}},waitFor:function(e,t){var n=Le.resolve("function"==typeof e?kt.ignoreTransaction(e):e).timeout(t||6e4);return Ee.trans?Ee.trans.waitFor(n):n},Promise:Le,debug:{get:function(){return U},set:function(e){A(e,"dexie"===e?function(){return!0}:Ot)}},derive:h,extend:s,props:l,override:b,Events:ft,getByKeyPath:k,setByKeyPath:R,delByKeyPath:function(e,t){"string"==typeof t?R(e,t,void 0):"length"in t&&[].map.call(t,function(t){R(e,t,void 0)})},shallowClone:P,deepClone:M,getObjectDiff:C,asap:_,maxKey:yt,minKey:pt,addons:[],connections:gt,MultiModifyError:z.Modify,errnames:J,IndexSpec:It,TableSchema:Tt,dependencies:{indexedDB:i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB,IDBKeyRange:i.IDBKeyRange||i.webkitIDBKeyRange},semVer:"{version}",version:"{version}".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,2*n)}),fakeAutoComplete:Rt,default:kt,Dexie:kt}),Le.rejectionMapper=function(e,t){if(!e||e instanceof G||e instanceof TypeError||e instanceof SyntaxError||!e.name||!$[e.name])return e;var n=new $[e.name](t||e.message,e);return"stack"in e&&d(n,"stack",{get:function(){return this.inner.stack}}),n},g(function(){kt.fakeAutoComplete=Rt=g,kt.fake=Pt=!0}),(dt=new kt("__dbnames")).version(1).stores({dbnames:"name"}),function(){if(void 0!==typeof localStorage&&void 0!==i.document)try{JSON.parse(localStorage.getItem("Dexie.DatabaseNames")||"[]").forEach(function(e){return dt.dbnames.put({name:e}).catch(X)}),localStorage.removeItem("Dexie.DatabaseNames")}catch(e){}}(),t.a=kt}).call(t,n(63),n(133).setImmediate)},function(e,t,n){e.exports={default:n(93),__esModule:!0}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(7),o=n(1).document,i=r(o)&&r(o.createElement);e.exports=function(e){return i?o.createElement(e):{}}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){"use strict";var r=n(18);e.exports.f=function(e){return new function(e){var t,n;this.promise=new e(function(e,r){if(void 0!==t||void 0!==n)throw TypeError("Bad Promise constructor");t=e,n=r}),this.resolve=r(t),this.reject=r(n)}(e)}},function(e,t,n){var r=n(4),o=n(109),i=n(27),s=n(31)("IE_PROTO"),a=function(){},c=function(){var e,t=n(26)("iframe"),r=i.length;for(t.style.display="none",n(43).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),c=e.F;r--;)delete c.prototype[i[r]];return c()};e.exports=Object.create||function(e,t){var n;return null!==e?(a.prototype=r(e),n=new a,a.prototype=null,n[s]=e):n=c(),void 0===t?n:o(n,t)}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var r=n(32)("keys"),o=n(22);e.exports=function(e){return r[e]||(r[e]=o(e))}},function(e,t,n){var r=n(1),o=r["__core-js_shared__"]||(r["__core-js_shared__"]={});e.exports=function(e){return o[e]||(o[e]={})}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t,n){var r=n(33),o=Math.min;e.exports=function(e){return e>0?o(r(e),9007199254740991):0}},function(e,t,n){var r=n(7);e.exports=function(e,t){if(!r(e))return e;var n,o;if(t&&"function"==typeof(n=e.toString)&&!r(o=n.call(e)))return o;if("function"==typeof(n=e.valueOf)&&!r(o=n.call(e)))return o;if(!t&&"function"==typeof(n=e.toString)&&!r(o=n.call(e)))return o;throw TypeError("Can't convert object to primitive value")}},function(e,t,n){var r=n(1),o=n(0),i=n(19),s=n(37),a=n(5).f;e.exports=function(e){var t=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||a(t,e,{value:s.f(e)})}},function(e,t,n){t.f=n(2)},function(e,t,n){"use strict";var r=n(114)(!0);n(48)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=r(t,n),this._i+=e.length,{value:e,done:!1})})},function(e,t,n){"use strict";var r=n(23);function o(){}function i(e,t){return e===o?t:function(){var n=e.apply(this,arguments);if(n&&"function"==typeof n.then){var r=this,o=arguments;return n.then(function(){return t.apply(r,o)})}return t.apply(this,arguments)}}function s(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)})}var a=1,c=2,u=3;function l(e){return function(t){if(!t.hook._observing){t.hook._observing=!0;var n=t.name;t.hook("creating").subscribe(function(e,t){return function(n,o,i){var c=void 0;void 0===n&&t.schema.primKey.uuid&&(n=c=s(),t.schema.primKey.keyPath&&r.a.setByKeyPath(o,t.schema.primKey.keyPath,n));var u={source:i.source||null,table:t.name,key:void 0===n?null:n,type:a,obj:o},l=e._changes.add(u).then(function(e){return i._lastWrittenRevision=Math.max(i._lastWrittenRevision,e),e});return this.onsuccess=function(t){n!=t&&l._then(function(){u.key=t,e._changes.put(u)})},this.onerror=function(){l._then(function(t){e._changes.delete(t)})},c}}(e,t)),t.hook("updating").subscribe(function(e,t){return function(n,o,i,s){var a={},u=!1,l=r.a.deepClone(i);for(var f in n){var d=n[f];if(void 0===d)r.a.delByKeyPath(l,f),a[f]=null,u=!0;else{var h=r.a.getByKeyPath(i,f);d!==h&&JSON.stringify(d)!==JSON.stringify(h)&&(r.a.setByKeyPath(l,f,d),a[f]=d,u=!0)}}if(u){var y={source:s.source||null,table:t,key:o,type:c,mods:a,oldObj:i,obj:l},p=e._changes.add(y);this.onsuccess=function(){p._then(function(e){s._lastWrittenRevision=Math.max(s._lastWrittenRevision,e)})},this.onerror=function(){p._then(function(t){e._changes.delete(t)})}}}}(e,n)),t.hook("deleting").subscribe(function(e,t){return function(n,r,o){var i=e._changes.add({source:o.source||null,table:t,key:n,type:u,oldObj:r}).then(function(e){return o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e),e}).catch(function(e){console.log(r),console.log(e.stack)});this.onerror=function(){i._then(function(t){e._changes.delete(t)})}}}(e,n))}}}var f=r.a.Promise;function d(e,t,n,o,i){var s={};function a(){return o.node?r.a.ignoreTransaction(function(){return e.transaction("rw","_intercomm",function(){return e._intercomm.where({destinationNode:o.node.id}).toArray(function(t){return t.forEach(function(t){return function(t){if("response"===t.type){var n=s[t.requestId.toString()];n&&(t.isFailure?n.reject(t.message.error):n.resolve(t.message.result),delete s[t.requestId.toString()])}else t.resolve=function(n){e.observable.sendMessage("response",{result:n},t.sender,{requestId:t.id})},t.reject=function(n){e.observable.sendMessage("response",{error:n.toString()},t.sender,{isFailure:!0,requestId:t.id})},e.on.message.fire(t)}(t)}),e._intercomm.where("id").anyOf(t.map(function(e){return e.id})).delete()})})}):f.reject(new r.a.DatabaseClosedError)}return e.observable.sendMessage=function(n,a,c,u){if(u=u||{},!o.node)return u.wantReply?f.reject(new r.a.DatabaseClosedError):f.resolve();var l={message:a,destinationNode:c,sender:o.node.id,type:n};return r.a.extend(l,u),r.a.ignoreTransaction(function(){var n=["_intercomm"];u.wantReply&&n.push("_syncNodes");var r=e.transaction("rw",n,function(){return u.wantReply?e._syncNodes.where("id").equals(c).count(function(t){return t?e._intercomm.add(l):e._syncNodes.where("isMaster").above(0).first(function(t){return l.destinationNode=t.id,e._intercomm.add(l)})}):e._intercomm.add(l)}).then(function(n){var r=null;return u.wantReply&&(r=new f(function(e,t){s[n.toString()]={resolve:e,reject:t}})),i&&i.setItem("Dexie.Observable/intercomm/"+e.name,n.toString()),t.on.intercomm.fire(e.name),r});return u.wantReply?r:void r.catch(function(){})})},e.observable.broadcastMessage=function(t,n,i){if(o.node){var s=o.node.id;r.a.ignoreTransaction(function(){e._syncNodes.toArray(function(r){return f.all(r.filter(function(e){return"local"===e.type&&(i||e.id!==s)}).map(function(r){return e.observable.sendMessage(t,n,r.id)}))}).catch(function(){})})}},{onIntercomm:function(t){t===e.name&&a().catch("DatabaseClosedError",function(){})},consumeIntercommMessages:a}}function h(e){return function(t,n){t._changes="++rev",t._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",t._intercomm="++id,destinationNode",t._uncommittedChanges="++id,node",e.call(this,t,n),Object.keys(n).forEach(function(e){var t=n[e];0===t.primKey.name.indexOf("$$")&&(t.primKey.uuid=!0,t.primKey.name=t.primKey.name.substr(2),t.primKey.keyPath=t.primKey.keyPath.substr(2))}),Object.keys(n).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(n[e].observable=!0)})}}var y=self,p=r.a.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),v=r.a.override,b=r.a.Promise,g=!1;function m(e){var t=2e4,n=2e4,s=500,a=t-5e3,c=m.localStorageImpl,u=r.a.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});e.observable={},e.observable.SyncNode=u;var f=function(e,t,n){return function(o){t.latestRevision[e.name]<o&&(t.latestRevision[e.name]=o,r.a.ignoreTransaction(function(){t.on("latestRevisionIncremented").fire(e.name,o)}),n&&n.setItem("Dexie.Observable/latestRevision/"+e.name,o))}}(e,m,c),_=function(e,t){return function(n){return function(r,o,i,s){if(e.dynamicallyOpened())return n.apply(this,arguments);var a=!1;"readwrite"===r&&o.some(function(e){return i[e]&&i[e].observable})&&(a=!0,-1===(o=o.slice(0)).indexOf("_changes")&&o.push("_changes"));var c=n.call(this,r,o,i,s);return a&&(c._lastWrittenRevision=0,c.on("complete",function(){if(c._lastWrittenRevision)if(s){var e=function e(t){return t.parent?e(t.parent):t}(s);e._lastWrittenRevision=Math.max(c._lastWrittenRevision,e.lastWrittenRevision||0)}else t.timeoutHandle&&clearTimeout(t.timeoutHandle),t.timeoutHandle=setTimeout(function(){delete t.timeoutHandle,t(c._lastWrittenRevision)},25)}),c.parent&&c.parent.source&&(c.source=c.parent.source)),c}}}(e,f),w=l(e),O=function(e,t,n){return function(r){return function(){return Object.keys(e._allTables).forEach(function(r){var o=e._allTables[r];o.schema.observable&&n(o),"_syncNodes"===o.name&&o.mapToClass(t)}),r.apply(this,arguments)}}}(e,u,w),k={node:null},R=d(e,m,0,k,c),P=R.onIntercomm,S=R.consumeIntercommMessages;Object.defineProperty(e,"_localSyncNode",{get:function(){return k.node}});var j=null,E=null;r.a.fake&&(e.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),e._syncNodes.mapToClass(u),e._changes.mapToClass(p),k.node=new u({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),e.Version.prototype._parseStoresSpec=v(e.Version.prototype._parseStoresSpec,h),e.on.addEventType({changes:"asap",cleanup:[i,o],message:"asap"}),e._createTransaction=v(e._createTransaction,_),m.latestRevision[e.name]=m.latestRevision[e.name]||0,e.open=v(e.open,O),e.close=v(e.close,function(t){return function(){return e.dynamicallyOpened()?t.apply(this,arguments):(f.timeoutHandle&&(clearTimeout(f.timeoutHandle),delete f.timeoutHandle),m.on("latestRevisionIncremented").unsubscribe(C),m.on("suicideNurseCall").unsubscribe(A),m.on("intercomm").unsubscribe(P),m.on("beforeunload").unsubscribe(U),k.node&&k.node.id&&(m.on.suicideNurseCall.fire(e.name,k.node.id),c&&c.setItem("Dexie.Observable/deadnode:"+k.node.id.toString()+"/"+e.name,"dead"),k.node.deleteTimeStamp=1,k.node.lastHeartBeat=0,e._syncNodes.put(k.node),k.node=null),j&&clearTimeout(j),j=null,E&&clearTimeout(E),E=null,t.apply(this,arguments))}}),e.delete=v(e.delete,function(t){return function(){return t.apply(this,arguments).then(function(t){return m.latestRevision[e.name]=0,t})}}),e.on("ready",function(){return e.dynamicallyOpened()?e:e.table("_changes").orderBy("rev").last(function(n){var o=n?n.rev:0;return k.node=new u({myRevision:o,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),m.latestRevision[e.name]<o&&(m.latestRevision[e.name]=o,r.a.ignoreTransaction(function(){m.on.latestRevisionIncremented.fire(o)})),e.transaction("rw","_syncNodes",function(){return e._syncNodes.where("isMaster").equals(1).first(function(n){if(n){if(n.lastHeartBeat<Date.now()-t)return k.node.isMaster=1,n.isMaster=0,e._syncNodes.put(n)}else k.node.isMaster=1}).then(function(){return e._syncNodes.add(k.node).then(function(){m.on("latestRevisionIncremented",C),m.on("beforeunload",U),m.on("suicideNurseCall",A),m.on("intercomm",P),j=setTimeout(I,s),E=setTimeout(L,a)})})}).then(function(){T()})})},!0);var M=0;function C(t,n){if(t===e.name){if(M>=n)return;M=n,r.a.vip(function(){x(n).catch("DatabaseClosedError",function(){})})}}function x(t,n,o){if(!n&&x.ongoingOperation)return x.ongoingOperation;var i=!1,s=k.node;if(!s)return b.reject(new r.a.DatabaseClosedError);var a=e._changes.where("rev").above(s.myRevision).limit(1e3).toArray(function(t){if(t.length>0){var n=t[t.length-1];i=1e3===t.length,e.on("changes").fire(t,i),s.myRevision=n.rev}else o&&e.on("changes").fire([],!1);var r=!1;return e._syncNodes.where(":id").equals(s.id).modify(function(e){r=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,s.myRevision)}).then(function(){return r})}).then(function(t){if(!t)throw g?new Error("Browser is shutting down"):(e.close(),console.error("Out of sync"),y.location&&y.location.reload(!0),new Error("Out of sync"));if(i||m.latestRevision[e.name]>s.myRevision)return x(m.latestRevision[e.name],(n||0)+1,i)}).finally(function(){delete x.ongoingOperation});return n||(x.ongoingOperation=a),a}function L(){E=null;var t=k.node&&k.node.id;t&&e.transaction("rw!",e._syncNodes,function(){e._syncNodes.where({id:t}).first(function(t){if(t)return t.lastHeartBeat=Date.now(),t.deleteTimeStamp=null,e._syncNodes.put(t);e.isOpen()&&e.close()})}).catch("DatabaseClosedError",function(){}).finally(function(){k.node&&k.node.id===t&&e.isOpen()&&(E=setTimeout(L,a))})}function I(){j=null;var t=k.node&&k.node.id;t&&r.a.vip(function(){x(m.latestRevision[e.name]).then(T).then(S).catch("DatabaseClosedError",function(){}).finally(function(){k.node&&k.node.id===t&&e.isOpen()&&(j=setTimeout(I,s))})})}function T(){var o=k.node;return o?e.transaction("rw","_syncNodes","_changes","_intercomm",function(){var r=!1;e._syncNodes.where("lastHeartBeat").below(Date.now()-t).filter(function(e){return"local"===e.type}).modify(function(t){t.deleteTimeStamp&&t.deleteTimeStamp<Date.now()?(delete this.value,c&&c.removeItem("Dexie.Observable/deadnode:"+t.id+"/"+e.name),t.isMaster&&(e._syncNodes.update(o,{isMaster:1}),r=!0),e._intercomm.where({destinationNode:t.id}).modify(function(e){e.wantReply?e.destinationNode=o.id:delete this.value})):t.deleteTimeStamp||(t.deleteTimeStamp=Date.now()+n)}).then(function(){return m.deleteOldChanges(e),e.on("cleanup").fire(r)})}):b.reject(new r.a.DatabaseClosedError)}function U(){k.node&&(g=!0,k.node.deleteTimeStamp=1,k.node.lastHeartBeat=0,e._syncNodes.put(k.node),m.wereTheOneDying=!0,c&&c.setItem("Dexie.Observable/deadnode:"+k.node.id.toString()+"/"+e.name,"dead"))}function A(t,n){t!==e.name||m.wereTheOneDying||r.a.vip(function(){e._syncNodes.update(n,{deleteTimeStamp:1,lastHeartBeat:0}).then(T)})}}m.latestRevision={},m.on=r.a.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),m.createUUID=s,m.deleteOldChanges=function e(t){r.a.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()}).then(function(n){if(0!==n.length)return t._changes.bulkDelete(n).then(function(){100===n.length&&setTimeout(function(){return t.isOpen()&&e(t)},500)})})}).catch(function(){})},m._onStorage=function(e){return function(t){if(0===t.key.indexOf("Dexie.Observable/")){var n=t.key.split("/"),o=n[1],i=n[2];if("latestRevision"===o){var s=parseInt(t.newValue,10);!isNaN(s)&&s>e.latestRevision[i]&&(e.latestRevision[i]=s,r.a.ignoreTransaction(function(){e.on("latestRevisionIncremented").fire(i,s)}))}else if(0===o.indexOf("deadnode:")){var a=parseInt(o.split(":")[1],10);t.newValue&&e.on.suicideNurseCall.fire(i,a)}else"intercomm"===o&&t.newValue&&e.on.intercomm.fire(i)}}}(m),m._onBeforeUnload=function(){m.on.beforeunload.fire()};try{m.localStorageImpl=y.localStorage}catch(e){}y.addEventListener&&(y.addEventListener("storage",m._onStorage),y.addEventListener("beforeunload",m._onBeforeUnload)),r.a.Observable=m,r.a.addons.push(m),t.a=m},function(e,t,n){e.exports={default:n(89),__esModule:!0}},function(e,t,n){"use strict";t.__esModule=!0;var r=s(n(78)),o=s(n(77)),i="function"==typeof o.default&&"symbol"==typeof r.default?function(e){return typeof e}:function(e){return e&&"function"==typeof o.default&&e.constructor===o.default&&e!==o.default.prototype?"symbol":typeof e};function s(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof o.default&&"symbol"===i(r.default)?function(e){return void 0===e?"undefined":i(e)}:function(e){return e&&"function"==typeof o.default&&e.constructor===o.default&&e!==o.default.prototype?"symbol":void 0===e?"undefined":i(e)}},function(e,t,n){var r=n(13),o=n(2)("toStringTag"),i="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,n,s;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),o))?n:i?r(t):"Object"==(s=r(t))&&"function"==typeof t.callee?"Arguments":s}},function(e,t,n){var r=n(1).document;e.exports=r&&r.documentElement},function(e,t,n){e.exports=!n(6)&&!n(11)(function(){return 7!=Object.defineProperty(n(26)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var r=n(13);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,n){var r=n(14),o=n(2)("iterator"),i=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||i[o]===e)}},function(e,t,n){var r=n(4);e.exports=function(e,t,n,o){try{return o?t(r(n)[0],n[1]):t(n)}catch(t){var i=e.return;throw void 0!==i&&r(i.call(e)),t}}},function(e,t,n){"use strict";var r=n(19),o=n(3),i=n(57),s=n(9),a=n(8),c=n(14),u=n(104),l=n(21),f=n(52),d=n(2)("iterator"),h=!([].keys&&"next"in[].keys()),y=function(){return this};e.exports=function(e,t,n,p,v,b,g){u(n,t,p);var m,_,w,O=function(e){if(!h&&e in S)return S[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},k=t+" Iterator",R="values"==v,P=!1,S=e.prototype,j=S[d]||S["@@iterator"]||v&&S[v],E=!h&&j||O(v),M=v?R?O("entries"):E:void 0,C="Array"==t&&S.entries||j;if(C&&(w=f(C.call(new e)))!==Object.prototype&&w.next&&(l(w,k,!0),r||a(w,d)||s(w,d,y)),R&&j&&"values"!==j.name&&(P=!0,E=function(){return j.call(this)}),r&&!g||!h&&!P&&S[d]||s(S,d,E),c[t]=E,c[k]=y,v)if(m={values:R?E:O("values"),keys:b?E:O("keys"),entries:M},g)for(_ in m)_ in S||i(S,_,m[_]);else o(o.P+o.F*(h||P),t,m);return m}},function(e,t,n){var r=n(2)("iterator"),o=!1;try{var i=[7][r]();i.return=function(){o=!0},Array.from(i,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!o)return!1;var n=!1;try{var i=[7],s=i[r]();s.next=function(){return{done:n=!0}},i[r]=function(){return s},e(i)}catch(e){}return n}},function(e,t,n){var r=n(20),o=n(16),i=n(12),s=n(35),a=n(8),c=n(44),u=Object.getOwnPropertyDescriptor;t.f=n(6)?u:function(e,t){if(e=i(e),t=s(t,!0),c)try{return u(e,t)}catch(e){}if(a(e,t))return o(!r.f.call(e,t),e[t])}},function(e,t,n){var r=n(53),o=n(27).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,o)}},function(e,t,n){var r=n(8),o=n(17),i=n(31)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=o(e),r(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t,n){var r=n(8),o=n(12),i=n(98)(!1),s=n(31)("IE_PROTO");e.exports=function(e,t){var n,a=o(e),c=0,u=[];for(n in a)n!=s&&r(a,n)&&u.push(n);for(;t.length>c;)r(a,n=t[c++])&&(~i(u,n)||u.push(n));return u}},function(e,t,n){var r=n(3),o=n(0),i=n(11);e.exports=function(e,t){var n=(o.Object||{})[e]||Object[e],s={};s[e]=t(n),r(r.S+r.F*i(function(){n(1)}),"Object",s)}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,n){var r=n(4),o=n(7),i=n(28);e.exports=function(e,t){if(r(e),o(t)&&t.constructor===e)return t;var n=i.f(e);return(0,n.resolve)(t),n.promise}},function(e,t,n){e.exports=n(9)},function(e,t,n){var r=n(4),o=n(18),i=n(2)("species");e.exports=function(e,t){var n,s=r(e).constructor;return void 0===s||null==(n=r(s)[i])?t:o(n)}},function(e,t,n){var r,o,i,s=n(10),a=n(102),c=n(43),u=n(26),l=n(1),f=l.process,d=l.setImmediate,h=l.clearImmediate,y=l.MessageChannel,p=l.Dispatch,v=0,b={},g=function(){var e=+this;if(b.hasOwnProperty(e)){var t=b[e];delete b[e],t()}},m=function(e){g.call(e.data)};d&&h||(d=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return b[++v]=function(){a("function"==typeof e?e:Function(e),t)},r(v),v},h=function(e){delete b[e]},"process"==n(13)(f)?r=function(e){f.nextTick(s(g,e,1))}:p&&p.now?r=function(e){p.now(s(g,e,1))}:y?(i=(o=new y).port2,o.port1.onmessage=m,r=s(i.postMessage,i,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*")},l.addEventListener("message",m,!1)):r="onreadystatechange"in u("script")?function(e){c.appendChild(u("script")).onreadystatechange=function(){c.removeChild(this),g.call(e)}}:function(e){setTimeout(s(g,e,1),0)}),e.exports={set:d,clear:h}},function(e,t,n){var r=n(42),o=n(2)("iterator"),i=n(14);e.exports=n(0).getIteratorMethod=function(e){if(null!=e)return e[o]||e["@@iterator"]||i[r(e)]}},function(e,t){},function(e,t,n){n(117);for(var r=n(1),o=n(9),i=n(14),s=n(2)("toStringTag"),a="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),c=0;c<a.length;c++){var u=a[c],l=r[u],f=l&&l.prototype;f&&!f[s]&&o(f,s,u),i[u]=i.Array}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var r=n(24),o=n.n(r);t.a=function(e){function t(t){if(!t)return o.a.resolve(!1);var n="/"===t[t.length-1]?""+t+i:t+"/"+i;return e.navigator.onLine?function(t){return e.fetch(t,{method:"HEAD"})}(n).then(function(){return!0}).catch(function(){return!1}):o.a.resolve(!1)}return{isOnline:t,onlineStatusChanged:function(n,r){e.addEventListener("online",function(){t(n).then(function(e){r(e)})}),e.addEventListener("offline",function(){r(!1)}),t(n).then(function(e){r(e)})}}};var i="check"},function(e,t,n){"use strict";var r=0,o=4,i=36,s=Math.pow(i,o);function a(e,t){var n="000000000"+e;return n.substr(n.length-t)}function c(){return a((Math.random()*s<<0).toString(i),o)}var u=function(){var e=0;for(var t in window)e++;return e}();t.a=function(){var e=(new Date).getTime().toString(i),t=a((navigator.mimeTypes.length+navigator.userAgent.length).toString(i)+u.toString(i),4),n=c()+c();return"c"+e+a((r=r<s?r:0,++r-1).toString(i),o)+t+n}},function(e,t,n){"use strict";t.a=function(e,t){return function(n,r,o,i,s,a,c,u,l,f,d){var h={clientIdentity:n.clientIdentity,baseRevision:i,partial:c,changes:a,syncedRevision:s};e(r,h,o).then(function(e){e.success?n.clientIdentity?(u(e.changes,e.currentRevision,e.partial,!1),l(),f({again:o.pollInterval})):(n.clientIdentity=e.clientIdentity,n.save().then(function(){u(e.changes,e.currentRevision,e.partial,!1),l(),f({again:o.pollInterval})}).catch(function(e){d(e,1/0)})):d(e.errorMessage,1/0)}).catch(function(e){t(r).then(function(t){d(e,t?o.pollInterval:1/0)})})}}},function(e,t,n){"use strict";var r=n(24),o=n.n(r),i=n(71),s=n.n(i),a=n(130),c=n.n(a);t.a=function(e,t,n){var r=new Headers;r.set("Content-Type","application/json");var i={headers:r,method:"POST",body:s()(t),mode:"cors",credentials:n.credentials};return c()(e,i).then(function(e){return e.ok?e.json():{success:!1,errorMessage:"Some server error occurred"}},function(e){return o.a.reject(e)})}},function(e,t,n){"use strict";var r=n(81),o=n.n(r),i=n(75),s=n.n(i),a=n(24),c=n.n(a),u=n(72),l=n.n(u),f=n(84),d=n.n(f),h=n(74),y=n.n(h),p=n(79),v=n.n(p),b=n(80),g=n.n(b),m=n(83),_=n.n(m),w=n(82),O=n.n(w);t.a=function(e){var t=e.Dexie,n=e.observable,r=e.syncable,i=e.sync,a=e.isOnline,u=e.onlineStatusChanged,f=e.cuid,h=function(e){function o(e,s){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};v()(this,o);var c=_()(this,(o.__proto__||y()(o)).call(this,e,{addons:[n,r].concat(d()(a.addons?a.addons:[]))}));s.forEach(function(e){e.upgrader?c.version(e.version).stores(e.stores).upgrade(e.upgrader):c.version(e.version).stores(e.stores)});var u={sync:i,partialsThreshold:a.partialsThreshold};return t.Syncable.registerSyncProtocol(k,u),c.options={},c.urls=[],c.statusChangeListeners={},c.syncable.on("statusChanged",function(e,n){var r=c.statusChangeListeners[n];r&&r(t.Syncable.StatusTexts[e])}),c}return O()(o,e),g()(o,[{key:"_connect",value:function(e,t){var n=this;return this.syncable.connect(k,e,t).catch(function(t){throw n.disconnect(e),t})}},{key:"connect",value:function(e,t){var n=this;return-1===this.urls.indexOf(e)?(this.options[e]=l()({},t,R),a(e).then(function(t){return t?n._connect(e,n.options[e]).then(function(){n.urls.push(e),u(e,function(t){t?n._connect(e,n.options[e]):n.disconnect(e)})}):c.a.reject(new Error("Is not online"))})):c.a.resolve()}},{key:"disconnect",value:function(e){var t=this;return this.syncable.disconnect(e).then(function(){t.urls=t.urls.filter(function(t){return t!==e})})}},{key:"removeUrl",value:function(e){var t=this;return this.syncable.delete(e).then(function(){t.urls=t.urls.filter(function(t){return t!==e}),t.statusChangeListeners[e]=void 0})}},{key:"statusChange",value:function(e,t){this.statusChangeListeners[e]=t}},{key:"getStatuses",value:function(){var e=this;return this.syncable.list().then(function(n){var r=n.map(function(t){return e.syncable.getStatus(t)});return c.a.all(r).then(function(e){return n.map(function(n,r){return{url:n,status:t.Syncable.StatusTexts[e[r]]}})})})}},{key:"getStatus",value:function(e){return this.syncable.getStatus(e).then(function(e){return t.Syncable.StatusTexts[e]})}},{key:"getID",value:function(){return o.getID()}}],[{key:"getID",value:function(){return f()}}]),o}(t);return h.statuses=s()(t.Syncable.Statuses).reduce(function(e,t){return l()(e,o()({},t,t))},{}),h};var k="sync_client_protocol",R={pollInterval:1e4,credentials:"omit"}},function(e,t,n){"use strict";var r=n(23),o=(n(39),r.a.Promise);function i(e){return function(){function t(e,t){this.nodeID=e,t&&r.a.extend(this,t)}return t.prototype.save=function(){return r.a.vip(function(){return e.save()})},t}()}var s=1,a=2,c=3;function u(e){return function(t){var n={};t.forEach(function(e){var t;n.hasOwnProperty(e.table)||(n[e.table]=((t={})[s]=[],t[c]=[],t[a]=[],t)),n[e.table][e.type].push(e)});var o=Object.keys(n),i=o.map(function(t){return e.table(t)});return e.transaction("rw",i,function(){o.forEach(function(t){var o=e.table(t),i=!o.schema.primKey.keyPath,u=n[t][s],l=n[t][c],f=n[t][a];u.length>0&&o.bulkPut(u.map(function(e){return e.obj}),i?u.map(function(e){return e.key}):void 0),f.length>0&&function(e,t){var n=t.map(function(e){return e.key}),o={};e.where(":id").anyOf(n).raw().each(function(e,t){o[t.primaryKey+""]=e}).then(function(){var n=t.filter(function(e){return o.hasOwnProperty(e.key+"")}).map(function(e){var t=o[e.key+""];return Object.keys(e.mods).forEach(function(n){r.a.setByKeyPath(t,n,e.mods[n])}),t});return e.bulkPut(n)})}(o,f),l.length>0&&o.bulkDelete(l.map(function(e){return e.key}))})})}}function l(e){if(0===e.remoteBaseRevisions.length)return{maxClientRevision:1/0,remoteBaseRevision:null};for(var t=e.remoteBaseRevisions.length-1;t>=0;--t)if(e.myRevision>=e.remoteBaseRevisions[t].local)return{maxClientRevision:t===e.remoteBaseRevisions.length-1?1/0:e.remoteBaseRevisions[t+1].local,remoteBaseRevision:e.remoteBaseRevisions[t].remote};return{maxClientRevision:e.remoteBaseRevisions[0].local,remoteBaseRevision:null}}function f(e,t){switch(e.type){case s:switch(t.type){case s:return t;case a:return function(e,t){var n=r.a.deepClone(e);return Object.keys(t.mods).forEach(function(e){r.a.setByKeyPath(n.obj,e,t.mods[e])}),n}(e,t);case c:return t}break;case a:switch(t.type){case s:return t;case a:return function(e,t){var n=r.a.deepClone(e);return Object.keys(t.mods).forEach(function(o){var i=!1;Object.keys(e.mods).filter(function(e){return 0===o.indexOf(e+".")}).forEach(function(e){r.a.setByKeyPath(n.mods[e],o.substr(e.length+1),t.mods[o]),i=!0}),i||(n.mods[o]=t.mods[o]),Object.keys(e.mods).filter(function(e){return 0===e.indexOf(o+".")}).forEach(function(e){delete n.mods[e]})}),n}(e,t);case c:return t}break;case c:switch(t.type){case s:return t;case a:case c:return e}}}function d(e,t,n){var o=n;return function(n,i){var c=function(e,t,n){return function(r,o,i,c){var u={},l=0,d=!1,h=t.id,y=r;return e.transaction("r",e._changes,function(){return e._changes.where("rev").between(r,i,!1,!0).until(function(){if(l===o)return d=!0,!0}).each(function(e){if(y=e.rev,e.source!==h){var t={type:e.type,table:e.table,key:e.key};e.type===s?t.obj=e.obj:e.type===a&&(t.mods=e.mods);var n=e.table+":"+e.key,r=u[n];if(r){var o=f(r,t);u[n]=o}else u[n]=t,++l}})}).then(function(){var e=Object.keys(u).map(function(e){return u[e]});return n.hasMoreToGive=d,c(e,d,{myRevision:y})})}}(e,n,t),u=function(e,t,n,r,o,i){return function a(c,u,f){var d=!1;return f.until(function(){if(u.length===n)return d=!0,!0}).each(function(e,t){u.push({type:s,table:c.currentTable,key:t.key,obj:t.value}),c.currentKey=t.key}).then(function(){if(d)return o.hasMoreToGive=!0,i(u,null,!0,{dbUploadState:c});if(0===c.tablesToUpload.length){var s=l(t);return r(c.localBaseRevision,n-u.length,s.maxClientRevision,function(e,t,n){return u=u.concat(e),n.dbUploadState=null,i(u,s.remoteBaseRevision,t,n)})}return c.currentTable=c.tablesToUpload.shift(),a(c,u,e.table(c.currentTable).orderBy(":id"))})}}(e,n,o,c,t,i);if(n.myRevision>=0){var d=l(n);return c(n.myRevision,o,d.maxClientRevision,function(e,t,n){return i(e,d.remoteBaseRevision,t,n)})}if(null===n.dbUploadState){var h=e.tables.filter(function(e){return e.schema.observable}).map(function(e){return e.name});if(0===h.length)return r.a.Promise.resolve(i([],null,!1,{}));var y={tablesToUpload:h,currentTable:h.shift(),currentKey:null};return e._changes.orderBy("rev").last(function(t){y.localBaseRevision=t&&t.rev||0;var n=e.table(y.currentTable).orderBy(":id");return u(y,[],n)})}if(n.dbUploadState.currentKey){var p=e.table(n.dbUploadState.currentTable).where(":id").above(n.dbUploadState.currentKey);return u(r.a.deepClone(n.dbUploadState),[],p)}return p=e.table(y.currentTable).orderBy(":id"),u(r.a.deepClone(n.dbUploadState),[],p)}}var h={ERROR:-1,OFFLINE:0,CONNECTING:1,ONLINE:2,SYNCING:3,ERROR_WILL_RETRY:4},y=r.a.Promise;function p(e,t,n,o,i){var s=function(e){return function t(n,o,i){function s(){return n.ongoingOperation?n.ongoingOperation=n.ongoingOperation.then(function(){return t(n,o,i)}):n.ongoingOperation=r.a.ignoreTransaction(function(){return r.a.vip(function(){return o()})}).finally(function(){delete n.ongoingOperation}),n.ongoingOperation}return i?e._localSyncNode&&i===e._localSyncNode.id?s():r.a.Promise.reject(new r.a.DatabaseClosedError):e.isOpen()?s():r.a.Promise.reject(new r.a.DatabaseClosedError)}}(e),a={hasMoreToGive:!0};function c(){return e._localSyncNode&&e._localSyncNode.id===n}return function(l,f){var p,v=d(e,a,t.partialsThreshold),b=f.url;function g(t){l.status!==t&&(l.status=t,l.save().then(function(){e.syncable.on.statusChanged.fire(t,b),e.observable.broadcastMessage("syncStatusChanged",{newStatus:t,url:b},!1)}).catch("DatabaseClosedError",function(){}))}return f.on("disconnect",function(e){isNaN(e)||g(e)}),g(h.CONNECTING),m();function m(){return s(m,function(){return O(l,_)},n)}function _(e,n,s,a){var u=new y(function(a,u){i.p=function(e){u(e)},r.a.asap(function(){try{t.sync(l.syncContext,b,o,n,l.appliedRemoteRevision,e,s,k,f,function(e){a(e)},r)}catch(e){r(e,1/0)}function r(e,t){u(e),c()&&(!isNaN(t)&&t<1/0?(setTimeout(function(){c()&&(g(h.SYNCING),m().catch("DatabaseClosedError",w))},t),g(h.ERROR_WILL_RETRY),p&&p.disconnect&&p.disconnect(),p=null):w(e))}})});return u.then(function(){}).finally(function(){i.p=null});function f(){return Object.keys(a).forEach(function(e){r.a.setByKeyPath(l,e,a[e])}),u.then(R),l.save()}}function w(e){f.disconnect(h.ERROR,e)}function O(e,t){return v(e,function n(o,i,s,a){return 0===o.length&&"myRevision"in a&&a.myRevision!==e.myRevision?(Object.keys(a).forEach(function(t){r.a.setByKeyPath(e,t,a[t])}),e.save().catch("DatabaseClosedError",function(){}),v(e,n)):t(o,i,s,a)})}function k(t,o,i){var a=function(e,t){return function(n,r){return e.transaction("rw!",e._uncommittedChanges,function(){return e._uncommittedChanges.bulkAdd(n.map(function(e){var n={node:t.id,type:e.type,table:e.table,key:e.key};return e.obj&&(n.obj=e.obj),e.mods&&(n.mods=e.mods),n}))}).then(function(){return t.appliedRemoteRevision=r,t.save()})}}(e,l),f=function(e,t){var n=u(e);return function(o,i){var s=e.tables.filter(function(e){return"_changes"===e.name||"_uncommittedChanges"===e.name||e.schema.observable});return e.transaction("rw!",s,function(){var s=r.a.currentTransaction,a=0;return e._changes.orderBy("rev").last(function(e){a=e&&e.rev||0}).then(function(){return s.source=t.id,e._uncommittedChanges.where("node").equals(t.id).toArray()}).then(function(e){return n(e)}).then(function(){return e._uncommittedChanges.where("node").equals(t.id).delete()}).then(function(){return n(o)}).then(function(){return e._changes.orderBy("rev").last()}).then(function(e){var n=e&&e.rev||0;if(t.appliedRemoteRevision=i,t.remoteBaseRevisions.push({remote:i,local:n}),t.myRevision===a&&(t.myRevision=n),t.remoteBaseRevisions.length>1)for(var r=t.remoteBaseRevisions.length-1;r>0;--r)if(t.myRevision>=t.remoteBaseRevisions[r].local){t.remoteBaseRevisions.splice(0,r);break}t.save().catch(function(e){console.warn("Dexie.Syncable: Unable to save SyncNode after applying remote changes: "+(e.stack||e))})})})}}(e,l);return s(k,function(){return c()?(i?a(t,o):f(t,o)).catch(function(e){return w(e),y.reject(e)}):y.reject(new r.a.DatabaseClosedError)},n)}function R(n){c()?(p=n,f.on("disconnect",function(){if(p){if(p.react)try{p.disconnect()}catch(e){}p=null}}),n.react?function(t){var n,o;function i(){p&&(g(h.SYNCING),o?n=!0:s())}function s(){p&&(n=!1,o=!0,O(l,function(e,i,a,c){p&&(e.length>0?t.react(e,i,a,function(){Object.keys(c).forEach(function(e){r.a.setByKeyPath(l,e,c[e])}),l.save().catch("DatabaseClosedError",function(){}),s()}):(o=!1,n?s():g(h.ONLINE)))}).catch(function(e){console.error("Got "+e.message+" caught by reactToChanges"),w(e)}))}e.on("changes",i),f.on("disconnect",function(){e.on.changes.unsubscribe(i)}),s()}(n):function(){function e(){O(l,function(n,i,s,a){t.sync(l.syncContext,b,o,i,l.appliedRemoteRevision,n,s,k,function(){Object.keys(a).forEach(function(e){r.a.setByKeyPath(l,e,a[e])}),l.save().catch("DatabaseClosedError",function(){})},function(t){p&&(p=t,s?e():!isNaN(t.again)&&t.again<1/0?(g(h.ONLINE),setTimeout(function(){p&&(g(h.SYNCING),e())},t.again)):f.disconnect(h.OFFLINE))},function(t,n){!isNaN(n)&&n<1/0?p&&(setTimeout(function(){p&&(g(h.SYNCING),e())},n),g(h.ERROR_WILL_RETRY)):w(t)})}).catch(w)}a.hasMoreToGive?e():p&&!isNaN(p.again)&&p.again<1/0?(g(h.ONLINE),setTimeout(function(){p&&(g(h.SYNCING),e())},p.again)):f.disconnect(h.OFFLINE)}()):n.disconnect&&n.disconnect()}}}function v(e,t){return function(n,o,s,a,c){var u=t.filter(function(e){return e.url===s});if(u.length>0){var l=u[0],f={};return r.a.getObjectDiff(l.syncOptions,a,f),0!==Object.keys(f).length?e.syncable.disconnect(s).then(function(){return d()}):u[0].connectPromise}function d(){var u={p:null},l=p(e,n,c,a,u),f=function(e,t,n){return function(o){return e.transaction("rw",e._syncNodes,e._changes,function(){if(!n)throw new Error("Url cannot be empty");return e._syncNodes.where("url").equalsIgnoreCase(n).first(function(s){if(s){var a=i(s);s.syncContext=new a(s.id,s.syncContext),s.syncProtocol=t,s.syncOptions=o,e._syncNodes.put(s)}else{(s=new e.observable.SyncNode).myRevision=-1,s.appliedRemoteRevision=null,s.remoteBaseRevisions=[],s.type="remote",s.syncProtocol=t,s.url=n,s.syncOptions=o,s.lastHeartBeat=Date.now(),s.dbUploadState=null;var c=i(s);r.a.Promise.resolve(function(){if(!1===o.initialUpload)return e._changes.toCollection().lastKey(function(e){s.myRevision=e})}()).then(function(){e._syncNodes.add(s).then(function(t){s.syncContext=new c(t),e._syncNodes.put(s)})})}return s})})}}(e,o,s)(a).then(function(e){return l(e,y)}),d=!1,y={url:s,status:h.OFFLINE,connectPromise:f,syncOptions:a,on:r.a.Events(null,"disconnect"),disconnect:function(e,n){var r=t.indexOf(y);r>=0&&t.splice(r,1),n&&u.p&&u.p(n),d||y.on.disconnect.fire(e,n),d=!0}};return t.push(y),f}return d()}}var b=r.a.override,g=r.a.Promise,m=r.a.Observable;function _(e){var t=[],n=v(e,t),i=function(e,t){return function(n,i,s,a){if(e.isOpen()){if(!e._localSyncNode)throw new Error("Precondition failed: local sync node is missing. Make sure Dexie.Observable is active!");return e._localSyncNode.isMaster?t(n,i,s,a,e._localSyncNode.id):e.table("_syncNodes").where("isMaster").above(0).first(function(t){return e.observable.sendMessage("connect",{protocolName:i,url:s,options:a},t.id,{wantReply:!0})})}return e.hasBeenClosed()?o.reject(new r.a.DatabaseClosedError):e.hasFailed()?o.reject(new r.a.InvalidStateError("Dexie.Syncable: Cannot connect. Database has failed to open")):new o(function(t,n){e.on("ready",function(){return e._syncNodes.get({url:s},function(r){var o=e.syncable.connect(i,s,a);if(o.then(t,n),!r||!r.appliedRemoteRevision)return o})}),e.open().catch(function(e){n(new r.a.InvalidStateError("Dexie.Syncable: Couldn't connect. Database failed to open",e))})})}}(e,n);e.on("message",function(t){r.a.vip(function(){"connect"===t.type?e.syncable.connect(t.message.protocolName,t.message.url,t.message.options).then(t.resolve,t.reject):"disconnect"===t.type?e.syncable.disconnect(t.message.url).then(t.resolve,t.reject):"syncStatusChanged"===t.type&&e.syncable.on.statusChanged.fire(t.message.newStatus,t.message.url)})}),e.on("cleanup",function(t){t&&r.a.ignoreTransaction(function(){return r.a.vip(function(){return e._syncNodes.where({type:"remote"}).filter(function(e){return e.status!==h.OFFLINE}).toArray(function(t){return g.all(t.map(function(t){return e.syncable.connect(t.syncProtocol,t.url,t.syncOptions).catch(function(e){console.warn("Dexie.Syncable: Could not connect to "+t.url+". "+(e.stack||e))})}))})})}).catch("DatabaseClosedError",function(){})}),e.on("ready",function(){e._localSyncNode&&e._localSyncNode.isMaster&&e._syncNodes.where("type").equals("remote").and(function(e){return e.status!==h.OFFLINE}).toArray(function(t){t.forEach(function(t){return e.syncable.connect(t.syncProtocol,t.url,t.syncOptions).catch(function(){})})}).catch("DatabaseClosedError",function(){})},!0),e.syncable={},e.syncable.getStatus=function(t,n){return e.isOpen()?r.a.vip(function(){return e._syncNodes.where("url").equals(t).first(function(e){return e?e.status:h.OFFLINE})}).then(n):g.resolve(_.Statuses.OFFLINE).then(n)},e.syncable.getOptions=function(t,n){return e.transaction("r?",e._syncNodes,function(){return e._syncNodes.where("url").equals(t).first(function(e){return e.syncOptions}).then(n)})},e.syncable.list=function(){return e.transaction("r?",e._syncNodes,function(){return e._syncNodes.where("type").equals("remote").toArray(function(e){return e.map(function(e){return e.url})})})},e.syncable.on=r.a.Events(e,{statusChanged:"asap"}),e.syncable.disconnect=function(n){return r.a.ignoreTransaction(function(){return g.resolve().then(function(){return e._localSyncNode&&e._localSyncNode.isMaster?g.all(t.filter(function(e){return e.url===n}).map(function(e){return e.disconnect(h.OFFLINE)})):e._syncNodes.where("isMaster").above(0).first(function(t){return e.observable.sendMessage("disconnect",{url:n},t.id,{wantReply:!0})})}).then(function(){return e._syncNodes.where("url").equals(n).modify(function(e){e.status=h.OFFLINE})})})},e.syncable.connect=function(e,t,n){n=n||{};var r=_.registeredProtocols[e];return r?i(r,e,t,n):g.reject(new Error("ISyncProtocol '"+e+"' is not registered in Dexie.Syncable.registerSyncProtocol()"))},e.syncable.delete=function(t){return e.syncable.disconnect(t).then(function(){return e.transaction("rw!",e._syncNodes,e._changes,e._uncommittedChanges,function(){var n;return e._syncNodes.where("url").equals(t).toArray(function(e){return e.map(function(e){return e.id})}).then(function(t){return n=t,e._syncNodes.where("id").anyOf(t).delete()}).then(function(){return e._uncommittedChanges.where("node").anyOf(n).delete()})}).then(function(){m.deleteOldChanges(e)})})},e.syncable.unsyncedChanges=function(t){return e._syncNodes.where("url").equals(t).first(function(t){return e._changes.where("rev").above(t.myRevision).toArray()})},e.close=b(e.close,function(e){return function(){return t.forEach(function(e){e.disconnect()}),e.apply(this,arguments)}}),Object.defineProperty(e.observable.SyncNode.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(){var t=this;return e.transaction("rw?",e._syncNodes,function(){return e._syncNodes.put(t)})}})}_.Statuses=h,_.StatusTexts={"-1":"ERROR",0:"OFFLINE",1:"CONNECTING",2:"ONLINE",3:"SYNCING",4:"ERROR_WILL_RETRY"},_.registeredProtocols={},_.registerSyncProtocol=function(e,t){var n=t.partialsThreshold;if("number"==typeof n){if(isNaN(n)||n<0)throw new Error("The given number for the threshold is not supported")}else t.partialsThreshold=1/0;_.registeredProtocols[e]=t},r.a.Syncable=_,r.a.addons.push(_),t.a=_},function(e,t,n){e.exports={default:n(85),__esModule:!0}},function(e,t,n){e.exports={default:n(86),__esModule:!0}},function(e,t,n){e.exports={default:n(87),__esModule:!0}},function(e,t,n){e.exports={default:n(88),__esModule:!0}},function(e,t,n){e.exports={default:n(90),__esModule:!0}},function(e,t,n){e.exports={default:n(91),__esModule:!0}},function(e,t,n){e.exports={default:n(92),__esModule:!0}},function(e,t,n){e.exports={default:n(94),__esModule:!0}},function(e,t,n){e.exports={default:n(95),__esModule:!0}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){"use strict";t.__esModule=!0;var r=function(e){return e&&e.__esModule?e:{default:e}}(n(40));t.default=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,r.default)(e,o.key,o)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}()},function(e,t,n){"use strict";t.__esModule=!0;var r=function(e){return e&&e.__esModule?e:{default:e}}(n(40));t.default=function(e,t,n){return t in e?(0,r.default)(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){"use strict";t.__esModule=!0;var r=s(n(76)),o=s(n(73)),i=s(n(41));function s(e){return e&&e.__esModule?e:{default:e}}t.default=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,i.default)(t)));e.prototype=(0,o.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(r.default?(0,r.default)(e,t):e.__proto__=t)}},function(e,t,n){"use strict";t.__esModule=!0;var r=function(e){return e&&e.__esModule?e:{default:e}}(n(41));t.default=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,r.default)(t))&&"function"!=typeof t?e:t}},function(e,t,n){"use strict";t.__esModule=!0;var r=function(e){return e&&e.__esModule?e:{default:e}}(n(70));t.default=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return(0,r.default)(e)}},function(e,t,n){n(38),n(116),e.exports=n(0).Array.from},function(e,t,n){var r=n(0),o=r.JSON||(r.JSON={stringify:JSON.stringify});e.exports=function(e){return o.stringify.apply(o,arguments)}},function(e,t,n){n(118),e.exports=n(0).Object.assign},function(e,t,n){n(119);var r=n(0).Object;e.exports=function(e,t){return r.create(e,t)}},function(e,t,n){n(120);var r=n(0).Object;e.exports=function(e,t,n){return r.defineProperty(e,t,n)}},function(e,t,n){n(121),e.exports=n(0).Object.getPrototypeOf},function(e,t,n){n(122),e.exports=n(0).Object.keys},function(e,t,n){n(123),e.exports=n(0).Object.setPrototypeOf},function(e,t,n){n(61),n(38),n(62),n(124),n(126),n(127),e.exports=n(0).Promise},function(e,t,n){n(125),n(61),n(128),n(129),e.exports=n(0).Symbol},function(e,t,n){n(38),n(62),e.exports=n(37).f("iterator")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t,n,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(n+": incorrect invocation!");return e}},function(e,t,n){var r=n(12),o=n(34),i=n(115);e.exports=function(e){return function(t,n,s){var a,c=r(t),u=o(c.length),l=i(s,u);if(e&&n!=n){for(;u>l;)if((a=c[l++])!=a)return!0}else for(;u>l;l++)if((e||l in c)&&c[l]===n)return e||l||0;return!e&&-1}}},function(e,t,n){"use strict";var r=n(5),o=n(16);e.exports=function(e,t,n){t in e?r.f(e,t,o(0,n)):e[t]=n}},function(e,t,n){var r=n(15),o=n(30),i=n(20);e.exports=function(e){var t=r(e),n=o.f;if(n)for(var s,a=n(e),c=i.f,u=0;a.length>u;)c.call(e,s=a[u++])&&t.push(s);return t}},function(e,t,n){var r=n(10),o=n(47),i=n(46),s=n(4),a=n(34),c=n(60),u={},l={};(t=e.exports=function(e,t,n,f,d){var h,y,p,v,b=d?function(){return e}:c(e),g=r(n,f,t?2:1),m=0;if("function"!=typeof b)throw TypeError(e+" is not iterable!");if(i(b)){for(h=a(e.length);h>m;m++)if((v=t?g(s(y=e[m])[0],y[1]):g(e[m]))===u||v===l)return v}else for(p=b.call(e);!(y=p.next()).done;)if((v=o(p,g,y.value,t))===u||v===l)return v}).BREAK=u,t.RETURN=l},function(e,t){e.exports=function(e,t,n){var r=void 0===n;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)}},function(e,t,n){var r=n(13);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){"use strict";var r=n(29),o=n(16),i=n(21),s={};n(9)(s,n(2)("iterator"),function(){return this}),e.exports=function(e,t,n){e.prototype=r(s,{next:o(1,n)}),i(e,t+" Iterator")}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,n){var r=n(22)("meta"),o=n(7),i=n(8),s=n(5).f,a=0,c=Object.isExtensible||function(){return!0},u=!n(11)(function(){return c(Object.preventExtensions({}))}),l=function(e){s(e,r,{value:{i:"O"+ ++a,w:{}}})},f=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,r)){if(!c(e))return"F";if(!t)return"E";l(e)}return e[r].i},getWeak:function(e,t){if(!i(e,r)){if(!c(e))return!0;if(!t)return!1;l(e)}return e[r].w},onFreeze:function(e){return u&&f.NEED&&c(e)&&!i(e,r)&&l(e),e}}},function(e,t,n){var r=n(1),o=n(59).set,i=r.MutationObserver||r.WebKitMutationObserver,s=r.process,a=r.Promise,c="process"==n(13)(s);e.exports=function(){var e,t,n,u=function(){var r,o;for(c&&(r=s.domain)&&r.exit();e;){o=e.fn,e=e.next;try{o()}catch(r){throw e?n():t=void 0,r}}t=void 0,r&&r.enter()};if(c)n=function(){s.nextTick(u)};else if(!i||r.navigator&&r.navigator.standalone)if(a&&a.resolve){var l=a.resolve();n=function(){l.then(u)}}else n=function(){o.call(r,u)};else{var f=!0,d=document.createTextNode("");new i(u).observe(d,{characterData:!0}),n=function(){d.data=f=!f}}return function(r){var o={fn:r,next:void 0};t&&(t.next=o),e||(e=o,n()),t=o}}},function(e,t,n){"use strict";var r=n(15),o=n(30),i=n(20),s=n(17),a=n(45),c=Object.assign;e.exports=!c||n(11)(function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach(function(e){t[e]=e}),7!=c({},e)[n]||Object.keys(c({},t)).join("")!=r})?function(e,t){for(var n=s(e),c=arguments.length,u=1,l=o.f,f=i.f;c>u;)for(var d,h=a(arguments[u++]),y=l?r(h).concat(l(h)):r(h),p=y.length,v=0;p>v;)f.call(h,d=y[v++])&&(n[d]=h[d]);return n}:c},function(e,t,n){var r=n(5),o=n(4),i=n(15);e.exports=n(6)?Object.defineProperties:function(e,t){o(e);for(var n,s=i(t),a=s.length,c=0;a>c;)r.f(e,n=s[c++],t[n]);return e}},function(e,t,n){var r=n(12),o=n(51).f,i={}.toString,s="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return s&&"[object Window]"==i.call(e)?function(e){try{return o(e)}catch(e){return s.slice()}}(e):o(r(e))}},function(e,t,n){var r=n(9);e.exports=function(e,t,n){for(var o in t)n&&e[o]?e[o]=t[o]:r(e,o,t[o]);return e}},function(e,t,n){var r=n(7),o=n(4),i=function(e,t){if(o(e),!r(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,r){try{(r=n(10)(Function.call,n(50).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return i(e,n),t?e.__proto__=n:r(e,n),e}}({},!1):void 0),check:i}},function(e,t,n){"use strict";var r=n(1),o=n(0),i=n(5),s=n(6),a=n(2)("species");e.exports=function(e){var t="function"==typeof o[e]?o[e]:r[e];s&&t&&!t[a]&&i.f(t,a,{configurable:!0,get:function(){return this}})}},function(e,t,n){var r=n(33),o=n(25);e.exports=function(e){return function(t,n){var i,s,a=String(o(t)),c=r(n),u=a.length;return c<0||c>=u?e?"":void 0:(i=a.charCodeAt(c))<55296||i>56319||c+1===u||(s=a.charCodeAt(c+1))<56320||s>57343?e?a.charAt(c):i:e?a.slice(c,c+2):s-56320+(i-55296<<10)+65536}}},function(e,t,n){var r=n(33),o=Math.max,i=Math.min;e.exports=function(e,t){return(e=r(e))<0?o(e+t,0):i(e,t)}},function(e,t,n){"use strict";var r=n(10),o=n(3),i=n(17),s=n(47),a=n(46),c=n(34),u=n(99),l=n(60);o(o.S+o.F*!n(49)(function(e){Array.from(e)}),"Array",{from:function(e){var t,n,o,f,d=i(e),h="function"==typeof this?this:Array,y=arguments.length,p=y>1?arguments[1]:void 0,v=void 0!==p,b=0,g=l(d);if(v&&(p=r(p,y>2?arguments[2]:void 0,2)),null==g||h==Array&&a(g))for(n=new h(t=c(d.length));t>b;b++)u(n,b,v?p(d[b],b):d[b]);else for(f=g.call(d),n=new h;!(o=f.next()).done;b++)u(n,b,v?s(f,p,[o.value,b],!0):o.value);return n.length=b,n}})},function(e,t,n){"use strict";var r=n(96),o=n(105),i=n(14),s=n(12);e.exports=n(48)(Array,"Array",function(e,t){this._t=s(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,o(1)):o(0,"keys"==t?n:"values"==t?e[n]:[n,e[n]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(e,t,n){var r=n(3);r(r.S+r.F,"Object",{assign:n(108)})},function(e,t,n){var r=n(3);r(r.S,"Object",{create:n(29)})},function(e,t,n){var r=n(3);r(r.S+r.F*!n(6),"Object",{defineProperty:n(5).f})},function(e,t,n){var r=n(17),o=n(52);n(54)("getPrototypeOf",function(){return function(e){return o(r(e))}})},function(e,t,n){var r=n(17),o=n(15);n(54)("keys",function(){return function(e){return o(r(e))}})},function(e,t,n){var r=n(3);r(r.S,"Object",{setPrototypeOf:n(112).set})},function(e,t,n){"use strict";var r,o,i,s,a=n(19),c=n(1),u=n(10),l=n(42),f=n(3),d=n(7),h=n(18),y=n(97),p=n(101),v=n(58),b=n(59).set,g=n(107)(),m=n(28),_=n(55),w=n(56),O=c.TypeError,k=c.process,R=c.Promise,P="process"==l(k),S=function(){},j=o=m.f,E=!!function(){try{var e=R.resolve(1),t=(e.constructor={})[n(2)("species")]=function(e){e(S,S)};return(P||"function"==typeof PromiseRejectionEvent)&&e.then(S)instanceof t}catch(e){}}(),M=function(e){var t;return!(!d(e)||"function"!=typeof(t=e.then))&&t},C=function(e,t){if(!e._n){e._n=!0;var n=e._c;g(function(){for(var r=e._v,o=1==e._s,i=0,s=function(t){var n,i,s=o?t.ok:t.fail,a=t.resolve,c=t.reject,u=t.domain;try{s?(o||(2==e._h&&I(e),e._h=1),!0===s?n=r:(u&&u.enter(),n=s(r),u&&u.exit()),n===t.promise?c(O("Promise-chain cycle")):(i=M(n))?i.call(n,a,c):a(n)):c(r)}catch(e){c(e)}};n.length>i;)s(n[i++]);e._c=[],e._n=!1,t&&!e._h&&x(e)})}},x=function(e){b.call(c,function(){var t,n,r,o=e._v,i=L(e);if(i&&(t=_(function(){P?k.emit("unhandledRejection",o,e):(n=c.onunhandledrejection)?n({promise:e,reason:o}):(r=c.console)&&r.error&&r.error("Unhandled promise rejection",o)}),e._h=P||L(e)?2:1),e._a=void 0,i&&t.e)throw t.v})},L=function(e){return 1!==e._h&&0===(e._a||e._c).length},I=function(e){b.call(c,function(){var t;P?k.emit("rejectionHandled",e):(t=c.onrejectionhandled)&&t({promise:e,reason:e._v})})},T=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),C(t,!0))},U=function(e){var t,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===e)throw O("Promise can't be resolved itself");(t=M(e))?g(function(){var r={_w:n,_d:!1};try{t.call(e,u(U,r,1),u(T,r,1))}catch(e){T.call(r,e)}}):(n._v=e,n._s=1,C(n,!1))}catch(e){T.call({_w:n,_d:!1},e)}}};E||(R=function(e){y(this,R,"Promise","_h"),h(e),r.call(this);try{e(u(U,this,1),u(T,this,1))}catch(e){T.call(this,e)}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=n(111)(R.prototype,{then:function(e,t){var n=j(v(this,R));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=P?k.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&C(this,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),i=function(){var e=new r;this.promise=e,this.resolve=u(U,e,1),this.reject=u(T,e,1)},m.f=j=function(e){return e===R||e===s?new i(e):o(e)}),f(f.G+f.W+f.F*!E,{Promise:R}),n(21)(R,"Promise"),n(113)("Promise"),s=n(0).Promise,f(f.S+f.F*!E,"Promise",{reject:function(e){var t=j(this);return(0,t.reject)(e),t.promise}}),f(f.S+f.F*(a||!E),"Promise",{resolve:function(e){return w(a&&this===s?R:this,e)}}),f(f.S+f.F*!(E&&n(49)(function(e){R.all(e).catch(S)})),"Promise",{all:function(e){var t=this,n=j(t),r=n.resolve,o=n.reject,i=_(function(){var n=[],i=0,s=1;p(e,!1,function(e){var a=i++,c=!1;n.push(void 0),s++,t.resolve(e).then(function(e){c||(c=!0,n[a]=e,--s||r(n))},o)}),--s||r(n)});return i.e&&o(i.v),n.promise},race:function(e){var t=this,n=j(t),r=n.reject,o=_(function(){p(e,!1,function(e){t.resolve(e).then(n.resolve,r)})});return o.e&&r(o.v),n.promise}})},function(e,t,n){"use strict";var r=n(1),o=n(8),i=n(6),s=n(3),a=n(57),c=n(106).KEY,u=n(11),l=n(32),f=n(21),d=n(22),h=n(2),y=n(37),p=n(36),v=n(100),b=n(103),g=n(4),m=n(7),_=n(12),w=n(35),O=n(16),k=n(29),R=n(110),P=n(50),S=n(5),j=n(15),E=P.f,M=S.f,C=R.f,x=r.Symbol,L=r.JSON,I=L&&L.stringify,T=h("_hidden"),U=h("toPrimitive"),A={}.propertyIsEnumerable,D=l("symbol-registry"),N=l("symbols"),H=l("op-symbols"),B=Object.prototype,F="function"==typeof x,K=r.QObject,q=!K||!K.prototype||!K.prototype.findChild,G=i&&u(function(){return 7!=k(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(e,t,n){var r=E(B,t);r&&delete B[t],M(e,t,n),r&&e!==B&&M(B,t,r)}:M,V=function(e){var t=N[e]=k(x.prototype);return t._k=e,t},W=F&&"symbol"==typeof x.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof x},J=function(e,t,n){return e===B&&J(H,t,n),g(e),t=w(t,!0),g(n),o(N,t)?(n.enumerable?(o(e,T)&&e[T][t]&&(e[T][t]=!1),n=k(n,{enumerable:O(0,!1)})):(o(e,T)||M(e,T,O(1,{})),e[T][t]=!0),G(e,t,n)):M(e,t,n)},Y=function(e,t){g(e);for(var n,r=v(t=_(t)),o=0,i=r.length;i>o;)J(e,n=r[o++],t[n]);return e},z=function(e){var t=A.call(this,e=w(e,!0));return!(this===B&&o(N,e)&&!o(H,e))&&(!(t||!o(this,e)||!o(N,e)||o(this,T)&&this[T][e])||t)},$=function(e,t){if(e=_(e),t=w(t,!0),e!==B||!o(N,t)||o(H,t)){var n=E(e,t);return!n||!o(N,t)||o(e,T)&&e[T][t]||(n.enumerable=!0),n}},Q=function(e){for(var t,n=C(_(e)),r=[],i=0;n.length>i;)o(N,t=n[i++])||t==T||t==c||r.push(t);return r},X=function(e){for(var t,n=e===B,r=C(n?H:_(e)),i=[],s=0;r.length>s;)!o(N,t=r[s++])||n&&!o(B,t)||i.push(N[t]);return i};F||(a((x=function(){if(this instanceof x)throw TypeError("Symbol is not a constructor!");var e=d(arguments.length>0?arguments[0]:void 0),t=function(n){this===B&&t.call(H,n),o(this,T)&&o(this[T],e)&&(this[T][e]=!1),G(this,e,O(1,n))};return i&&q&&G(B,e,{configurable:!0,set:t}),V(e)}).prototype,"toString",function(){return this._k}),P.f=$,S.f=J,n(51).f=R.f=Q,n(20).f=z,n(30).f=X,i&&!n(19)&&a(B,"propertyIsEnumerable",z,!0),y.f=function(e){return V(h(e))}),s(s.G+s.W+s.F*!F,{Symbol:x});for(var Z="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ee=0;Z.length>ee;)h(Z[ee++]);for(var te=j(h.store),ne=0;te.length>ne;)p(te[ne++]);s(s.S+s.F*!F,"Symbol",{for:function(e){return o(D,e+="")?D[e]:D[e]=x(e)},keyFor:function(e){if(!W(e))throw TypeError(e+" is not a symbol!");for(var t in D)if(D[t]===e)return t},useSetter:function(){q=!0},useSimple:function(){q=!1}}),s(s.S+s.F*!F,"Object",{create:function(e,t){return void 0===t?k(e):Y(k(e),t)},defineProperty:J,defineProperties:Y,getOwnPropertyDescriptor:$,getOwnPropertyNames:Q,getOwnPropertySymbols:X}),L&&s(s.S+s.F*(!F||u(function(){var e=x();return"[null]"!=I([e])||"{}"!=I({a:e})||"{}"!=I(Object(e))})),"JSON",{stringify:function(e){for(var t,n,r=[e],o=1;arguments.length>o;)r.push(arguments[o++]);if(n=t=r[1],(m(t)||void 0!==e)&&!W(e))return b(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!W(t))return t}),r[1]=t,I.apply(L,r)}}),x.prototype[U]||n(9)(x.prototype,U,x.prototype.valueOf),f(x,"Symbol"),f(Math,"Math",!0),f(r.JSON,"JSON",!0)},function(e,t,n){"use strict";var r=n(3),o=n(0),i=n(1),s=n(58),a=n(56);r(r.P+r.R,"Promise",{finally:function(e){var t=s(this,o.Promise||i.Promise),n="function"==typeof e;return this.then(n?function(n){return a(t,e()).then(function(){return n})}:e,n?function(n){return a(t,e()).then(function(){throw n})}:e)}})},function(e,t,n){"use strict";var r=n(3),o=n(28),i=n(55);r(r.S,"Promise",{try:function(e){var t=o.f(this),n=i(e);return(n.e?t.reject:t.resolve)(n.v),t.promise}})},function(e,t,n){n(36)("asyncIterator")},function(e,t,n){n(36)("observable")},function(e,t,n){n(134),e.exports=self.fetch.bind(self)},function(e,t){var n,r,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var c,u=[],l=!1,f=-1;function d(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=a(d);l=!0;for(var t=u.length;t;){for(c=u,u=[];++f<t;)c&&c[f].run();f=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function p(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new y(e,t)),1!==u.length||l||a(h)},y.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=p,o.addListener=p,o.once=p,o.off=p,o.removeListener=p,o.removeAllListeners=p,o.emit=p,o.prependListener=p,o.prependOnceListener=p,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,o=1,i={},s=!1,a=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick(function(){l(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&l(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),r=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){l(e.data)},r=function(t){e.port2.postMessage(t)}}():a&&"onreadystatechange"in a.createElement("script")?function(){var e=a.documentElement;r=function(t){var n=a.createElement("script");n.onreadystatechange=function(){l(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():r=function(e){setTimeout(l,0,e)},c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var s={callback:e,args:t};return i[o]=s,r(o),o++},c.clearImmediate=u}function u(e){delete i[e]}function l(e){if(s)setTimeout(l,0,e);else{var t=i[e];if(t){s=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}(t)}finally{u(e),s=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(t,n(63),n(131))},function(e,r,o){var i=Function.prototype.apply;function s(e,t){this._id=e,this._clearFn=t}r.setTimeout=function(){return new s(i.call(setTimeout,window,arguments),clearTimeout)},r.setInterval=function(){return new s(i.call(setInterval,window,arguments),clearInterval)},r.clearTimeout=r.clearInterval=function(e){e&&e.close()},s.prototype.unref=s.prototype.ref=function(){},s.prototype.close=function(){this._clearFn.call(window,this._id)},r.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},r.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},r._unrefActive=r.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},o(132),r.setImmediate=t,r.clearImmediate=n},function(e,t){!function(e){"use strict";if(!e.fetch){var t={searchParams:"URLSearchParams"in e,iterable:"Symbol"in e&&"iterator"in Symbol,blob:"FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in e,arrayBuffer:"ArrayBuffer"in e};if(t.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(e){return e&&DataView.prototype.isPrototypeOf(e)},o=ArrayBuffer.isView||function(e){return e&&n.indexOf(Object.prototype.toString.call(e))>-1};l.prototype.append=function(e,t){e=a(e),t=c(t);var n=this.map[e];this.map[e]=n?n+","+t:t},l.prototype.delete=function(e){delete this.map[a(e)]},l.prototype.get=function(e){return e=a(e),this.has(e)?this.map[e]:null},l.prototype.has=function(e){return this.map.hasOwnProperty(a(e))},l.prototype.set=function(e,t){this.map[a(e)]=c(t)},l.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},l.prototype.keys=function(){var e=[];return this.forEach(function(t,n){e.push(n)}),u(e)},l.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),u(e)},l.prototype.entries=function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),u(e)},t.iterable&&(l.prototype[Symbol.iterator]=l.prototype.entries);var i=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];v.prototype.clone=function(){return new v(this,{body:this._bodyInit})},p.call(v.prototype),p.call(g.prototype),g.prototype.clone=function(){return new g(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new l(this.headers),url:this.url})},g.error=function(){var e=new g(null,{status:0,statusText:""});return e.type="error",e};var s=[301,302,303,307,308];g.redirect=function(e,t){if(-1===s.indexOf(t))throw new RangeError("Invalid status code");return new g(null,{status:t,headers:{location:e}})},e.Headers=l,e.Request=v,e.Response=g,e.fetch=function(e,n){return new Promise(function(r,o){var i=new v(e,n),s=new XMLHttpRequest;s.onload=function(){var e={status:s.status,statusText:s.statusText,headers:function(e){var t=new l;return e.split(/\r?\n/).forEach(function(e){var n=e.split(":"),r=n.shift().trim();if(r){var o=n.join(":").trim();t.append(r,o)}}),t}(s.getAllResponseHeaders()||"")};e.url="responseURL"in s?s.responseURL:e.headers.get("X-Request-URL");var t="response"in s?s.response:s.responseText;r(new g(t,e))},s.onerror=function(){o(new TypeError("Network request failed"))},s.ontimeout=function(){o(new TypeError("Network request failed"))},s.open(i.method,i.url,!0),"include"===i.credentials&&(s.withCredentials=!0),"responseType"in s&&t.blob&&(s.responseType="blob"),i.headers.forEach(function(e,t){s.setRequestHeader(t,e)}),s.send(void 0===i._bodyInit?null:i._bodyInit)})},e.fetch.polyfill=!0}function a(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function c(e){return"string"!=typeof e&&(e=String(e)),e}function u(e){var n={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return t.iterable&&(n[Symbol.iterator]=function(){return n}),n}function l(e){this.map={},e instanceof l?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function f(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function d(e){return new Promise(function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function h(e){var t=new FileReader,n=d(t);return t.readAsArrayBuffer(e),n}function y(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function p(){return this.bodyUsed=!1,this._initBody=function(e){if(this._bodyInit=e,e)if("string"==typeof e)this._bodyText=e;else if(t.blob&&Blob.prototype.isPrototypeOf(e))this._bodyBlob=e;else if(t.formData&&FormData.prototype.isPrototypeOf(e))this._bodyFormData=e;else if(t.searchParams&&URLSearchParams.prototype.isPrototypeOf(e))this._bodyText=e.toString();else if(t.arrayBuffer&&t.blob&&r(e))this._bodyArrayBuffer=y(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!t.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(e)&&!o(e))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=y(e)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):t.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},t.blob&&(this.blob=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?f(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(h)}),this.text=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return function(e){var t=new FileReader,n=d(t);return t.readAsText(e),n}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},t.formData&&(this.formData=function(){return this.text().then(b)}),this.json=function(){return this.text().then(JSON.parse)},this}function v(e,t){var n=(t=t||{}).body;if(e instanceof v){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new l(e.headers)),this.method=e.method,this.mode=e.mode,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"omit",!t.headers&&this.headers||(this.headers=new l(t.headers)),this.method=function(e){var t=e.toUpperCase();return i.indexOf(t)>-1?t:e}(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function b(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var n=e.split("="),r=n.shift().replace(/\+/g," "),o=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(o))}}),t}function g(e,t){t||(t={}),this.type="default",this.status="status"in t?t.status:200,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new l(t.headers),this.url=t.url||"",this._initBody(e)}}("undefined"!=typeof self?self:this)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(23),o=n(39),i=n(69),s=n(65),a=n(66),c=n(64),u=n(67),l=n(68),f=n.i(c.a)(window),d=f.isOnline,h=f.onlineStatusChanged,y=n.i(a.a)(u.a,d);t.default=n.i(l.a)({Dexie:r.a,syncable:i.a,observable:o.a,sync:y,onlineStatusChanged:h,isOnline:d,cuid:s.a})}])}).call(this,n(25).setImmediate,n(25).clearImmediate)},,,function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,o=1,i={},s=!1,a=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick(function(){l(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&l(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),r=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){l(e.data)},r=function(t){e.port2.postMessage(t)}}():a&&"onreadystatechange"in a.createElement("script")?function(){var e=a.documentElement;r=function(t){var n=a.createElement("script");n.onreadystatechange=function(){l(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():r=function(e){setTimeout(l,0,e)},c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var s={callback:e,args:t};return i[o]=s,r(o),o++},c.clearImmediate=u}function u(e){delete i[e]}function l(e){if(s)setTimeout(l,0,e);else{var t=i[e];if(t){s=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}(t)}finally{u(e),s=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(24),n(26))},function(e,t,n){(function(e){function n(e,t){for(var n=0,r=e.length-1;r>=0;r--){var o=e[r];"."===o?e.splice(r,1):".."===o?(e.splice(r,1),n++):n&&(e.splice(r,1),n--)}if(t)for(;n--;n)e.unshift("..");return e}var r=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(e){return r.exec(e).slice(1)};function i(e,t){if(e.filter)return e.filter(t);for(var n=[],r=0;r<e.length;r++)t(e[r],r,e)&&n.push(e[r]);return n}t.resolve=function(){for(var t="",r=!1,o=arguments.length-1;o>=-1&&!r;o--){var s=o>=0?arguments[o]:e.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(t=s+"/"+t,r="/"===s.charAt(0))}return(r?"/":"")+(t=n(i(t.split("/"),function(e){return!!e}),!r).join("/"))||"."},t.normalize=function(e){var r=t.isAbsolute(e),o="/"===s(e,-1);return(e=n(i(e.split("/"),function(e){return!!e}),!r).join("/"))||r||(e="."),e&&o&&(e+="/"),(r?"/":"")+e},t.isAbsolute=function(e){return"/"===e.charAt(0)},t.join=function(){var e=Array.prototype.slice.call(arguments,0);return t.normalize(i(e,function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))},t.relative=function(e,n){function r(e){for(var t=0;t<e.length&&""===e[t];t++);for(var n=e.length-1;n>=0&&""===e[n];n--);return t>n?[]:e.slice(t,n-t+1)}e=t.resolve(e).substr(1),n=t.resolve(n).substr(1);for(var o=r(e.split("/")),i=r(n.split("/")),s=Math.min(o.length,i.length),a=s,c=0;c<s;c++)if(o[c]!==i[c]){a=c;break}var u=[];for(c=a;c<o.length;c++)u.push("..");return(u=u.concat(i.slice(a))).join("/")},t.sep="/",t.delimiter=":",t.dirname=function(e){var t=o(e),n=t[0],r=t[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},t.basename=function(e,t){var n=o(e)[2];return t&&n.substr(-1*t.length)===t&&(n=n.substr(0,n.length-t.length)),n},t.extname=function(e){return o(e)[3]};var s="b"==="ab".substr(-1)?function(e,t,n){return e.substr(t,n)}:function(e,t,n){return t<0&&(t=e.length+t),e.substr(t,n)}}).call(this,n(26))},function(e,t,n){"use strict";n.r(t);var r=n(3),o=n(4),i=n(6);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var f=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=l(l(n=function(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?l(e):t}(this,c(t).call(this))));return a.type=r.a.WINDOW,a.capabilities=e,console.log("[WindowSandbox] New with capabilities: ",e),a._bus=new i.a,a._bus._onPostMessage=function(e){console.log("[WindowSandbox]._onPostMessage -> external (out)","from: ",e.from,"to: ",e.to,"msg: ",e),a._onMessage(e)},a._sbr=new o.a(a._bus),a._sbr._create=function(e,t,r,o){var i;return console.log("SandboxRegistry._create ",e,r,o),window.eval(t),"function"==typeof activate&&(i=activate(e,n._bus,r,o)),"function"==typeof activate.default&&(i=activate.default(e,n._bus,r,o)),window.components[e]=i,i},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(t,r.b),function(e,t,n){t&&a(e.prototype,t)}(t,[{key:"_onPostMessage",value:function(e){console.log("SandboxBrowser._onPostMessage -> internal (in)","from: ",e.from,"to: ",e.to,"msg: ",e),this._bus._onMessage(e)}}]),t}();function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var b=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var s=v(v(n=function(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?v(e):t}(this,y(t).call(this))));return s.type=r.a.NORMAL,console.log("[SandboxBrowser] New with capabilities: ",e),s._bus=new i.a,s._bus._onPostMessage=function(e){console.log("SandboxBrowser._onPostMessage -> external (out)","from: ",e.from,"to: ",e.to),s._onMessage(e)},s._sbr=new o.a(s._bus),s._sbr._create=function(e,t,r,o){var i;return console.log("SandboxRegistry._create ",e,r),window.eval(t),"function"==typeof activate&&(i=activate(e,n._bus,r,o)),"function"==typeof activate.default&&(i=activate.default(e,n._bus,r,o)),window.components||(window.components={}),window.components[e]=i,i},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,r.b),function(e,t,n){t&&h(e.prototype,t)}(t,[{key:"_onPostMessage",value:function(e){console.log("SandboxBrowser._onPostMessage -> internal (in)","from: ",e.from,"to: ",e.to),this._bus._onMessage(e)}}]),t}();function g(e){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var k=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var s=O(O(n=function(e,t){return!t||"object"!==g(t)&&"function"!=typeof t?O(e):t}(this,_(t).call(this))));return s.type=r.a.APP,console.log("[AppSandboxBrowser] new with capabilities: ",e),s._bus=new i.a,s._bus._onPostMessage=function(e){console.log("AppSandboxBrowser._onPostMessage -> external (out)","from: ",e.from,"to: ",e.to),s._onMessage(e)},s._sbr=new o.a(s._bus),s._sbr._create=function(e,t,r,o){console.log("SandboxRegistry._create ",e,r),t._start(e,n._bus,r,o)},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&w(e,t)}(t,r.b),function(e,t,n){t&&m(e.prototype,t)}(t,[{key:"_onPostMessage",value:function(e){console.log("AppSandboxBrowser._onPostMessage -> internal (in)","from: ",e.from,"to: ",e.to),this._bus._onMessage(e)}}]),t}();function R(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var P={GET:"get",POST:"post",DELETE:"delete",UPDATE:"update"},S=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._withCredentials=!1,Object.keys(P).forEach(function(e){switch(e){case"GET":t[P[e]]=function(n){return t._makeLocalRequest(e,n)};break;case"POST":case"DELETE":case"UPDATE":t[P[e]]=function(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t._makeLocalRequest(e,n,r)}}})}return function(e,t,n){t&&R(e.prototype,t)}(e,[{key:"_makeLocalRequest",value:function(e,t,n){var r=this;return n||(n=null),console.log("method:",e,"| url: ",t,n?" | payload:"+JSON.stringify(n):""),new Promise(function(o,i){var s={"hyperty-catalogue://":"https://","https://":"https://","http://":"https://"},a=!1;for(var c in s)if(t.slice(0,c.length)===c){t=s[c]+t.slice(c.length,t.length),a=!0;break}if(a){var u=new XMLHttpRequest;r._withCredentials&&(u.withCredentials=r._withCredentials),r.xhr=u,u.addEventListener("readystatechange",function(e){var t=e.currentTarget;4===t.readyState&&(t.status>=200||t.status<=299?o(t.responseText):(console.log("rejecting promise because of response code: 200 != ",t.status,t.responseText),i(t.responseText)))}),u.open(e,t),"POST"===e?u.send(n.body):u.send()}else i("Invalid protocol of url: "+t)})}},{key:"withCredentials",set:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._withCredentials=e},get:function(){return this._withCredentials}}]),e}(),j=n(21);function E(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var M=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("The Runtime Capabilities need the storageManager");this.storageManager=t}return function(e,t,n){t&&E(e.prototype,t)}(e,[{key:"getRuntimeCapabilities",value:function(){var e=this;return new Promise(function(t,n){Promise.all([e._getEnvironment(),e._getMediaDevices()]).then(function(n){var r={};n.forEach(function(e){Object.assign(r,e)}),e.storageManager.set("capabilities","1",r),t(r)}).catch(function(e){n(e)})})}},{key:"isAvailable",value:function(e){var t=this;return new Promise(function(n){t.storageManager.get("capabilities").then(function(t){console.log("[RuntimeCapabilities isAvailable?] "+e+" is ",t.hasOwnProperty(e)&&t[e]),t.hasOwnProperty(e)&&t[e]?n(!0):n(!1)})})}},{key:"update",value:function(){var e=this;return new Promise(function(t,n){e.getRuntimeCapabilities().then(t).catch(n)})}},{key:"_getEnvironment",value:function(){return{browser:!(!window||!navigator),windowSandbox:!(!window||!navigator),node:!(window&&navigator)}}},{key:"_getMediaDevices",value:function(){return new Promise(function(e){var t={};if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return console.log("enumerateDevices() not supported."),void e(t);navigator.mediaDevices.enumerateDevices().then(function(n){n.forEach(function(e){"audioinput"===e.kind&&"default"===e.deviceId&&(t.mic=!0),"videoinput"===e.kind&&(t.camera=!0)}),e(t)}).catch(function(n){e(t),console.log(n.name+": "+n.message)})})}}]),e}(),C=n(2),x=n.n(C);function L(){}function I(e,t){return e===L?t:function(){var n=e.apply(this,arguments);if(n&&"function"==typeof n.then){var r=this,o=arguments;return n.then(function(){return t.apply(r,o)})}return t.apply(this,arguments)}}function T(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)})}var U=1,A=2,D=3;var N=x.a.Promise;function H(e){return function(t,n){t._changes="++rev",t._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",t._intercomm="++id,destinationNode",t._uncommittedChanges="++id,node",e.call(this,t,n),Object.keys(n).forEach(function(e){var t=n[e];0===t.primKey.name.indexOf("$$")&&(t.primKey.uuid=!0,t.primKey.name=t.primKey.name.substr(2),t.primKey.keyPath=t.primKey.keyPath.substr(2))}),Object.keys(n).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(n[e].observable=!0)})}}var B=self,F=x.a.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),K=x.a.override,q=x.a.Promise,G=!1;function V(e){var t=2e4,n=2e4,r=500,o=t-5e3,i=V.localStorageImpl,s=x.a.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});e.observable={},e.observable.SyncNode=s;var a=function(e,t,n){return function(r){t.latestRevision[e.name]<r&&(t.latestRevision[e.name]=r,x.a.ignoreTransaction(function(){t.on("latestRevisionIncremented").fire(e.name,r)}),n&&n.setItem("Dexie.Observable/latestRevision/"+e.name,r))}}(e,V,i),c=function(e,t){return function(n){return function(r,o,i,s){if(e.dynamicallyOpened())return n.apply(this,arguments);var a=!1;"readwrite"===r&&o.some(function(e){return i[e]&&i[e].observable})&&(a=!0,-1===(o=o.slice(0)).indexOf("_changes")&&o.push("_changes"));var c=n.call(this,r,o,i,s);return a&&(c._lastWrittenRevision=0,c.on("complete",function(){if(c._lastWrittenRevision)if(s){var e=function e(t){return t.parent?e(t.parent):t}(s);e._lastWrittenRevision=Math.max(c._lastWrittenRevision,e.lastWrittenRevision||0)}else t.timeoutHandle&&clearTimeout(t.timeoutHandle),t.timeoutHandle=setTimeout(function(){delete t.timeoutHandle,t(c._lastWrittenRevision)},25)}),c.parent&&c.parent.source&&(c.source=c.parent.source)),c}}}(e,a),u=function(e){return function(t){if(!t.hook._observing){t.hook._observing=!0;var n=t.name;t.hook("creating").subscribe(function(e,t){return function(n,r,o){var i=void 0;void 0===n&&t.schema.primKey.uuid&&(n=i=T(),t.schema.primKey.keyPath&&x.a.setByKeyPath(r,t.schema.primKey.keyPath,n));var s={source:o.source||null,table:t.name,key:void 0===n?null:n,type:U,obj:r},a=e._changes.add(s).then(function(e){return o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e),e});return this.onsuccess=function(t){n!=t&&a._then(function(){s.key=t,e._changes.put(s)})},this.onerror=function(){a._then(function(t){e._changes.delete(t)})},i}}(e,t)),t.hook("updating").subscribe(function(e,t){return function(n,r,o,i){var s={},a=!1,c=x.a.deepClone(o);for(var u in n){var l=n[u];if(void 0===l)x.a.delByKeyPath(c,u),s[u]=null,a=!0;else{var f=x.a.getByKeyPath(o,u);l!==f&&JSON.stringify(l)!==JSON.stringify(f)&&(x.a.setByKeyPath(c,u,l),s[u]=l,a=!0)}}if(a){var d={source:i.source||null,table:t,key:r,type:A,mods:s,oldObj:o,obj:c},h=e._changes.add(d);this.onsuccess=function(){h._then(function(e){i._lastWrittenRevision=Math.max(i._lastWrittenRevision,e)})},this.onerror=function(){h._then(function(t){e._changes.delete(t)})}}}}(e,n)),t.hook("deleting").subscribe(function(e,t){return function(n,r,o){var i=e._changes.add({source:o.source||null,table:t,key:n,type:D,oldObj:r}).then(function(e){return o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e),e}).catch(function(e){console.log(r),console.log(e.stack)});this.onerror=function(){i._then(function(t){e._changes.delete(t)})}}}(e,n))}}}(e),l=function(e,t,n){return function(r){return function(){return Object.keys(e._allTables).forEach(function(r){var o=e._allTables[r];o.schema.observable&&n(o),"_syncNodes"===o.name&&o.mapToClass(t)}),r.apply(this,arguments)}}}(e,s,u),f={node:null},d=function(e,t,n,r,o){var i={};function s(){return r.node?x.a.ignoreTransaction(function(){return e.transaction("rw","_intercomm",function(){return e._intercomm.where({destinationNode:r.node.id}).toArray(function(t){return t.forEach(function(t){return function(t){if("response"===t.type){var n=i[t.requestId.toString()];n&&(t.isFailure?n.reject(t.message.error):n.resolve(t.message.result),delete i[t.requestId.toString()])}else t.resolve=function(n){e.observable.sendMessage("response",{result:n},t.sender,{requestId:t.id})},t.reject=function(n){e.observable.sendMessage("response",{error:n.toString()},t.sender,{isFailure:!0,requestId:t.id})},e.on.message.fire(t)}(t)}),e._intercomm.where("id").anyOf(t.map(function(e){return e.id})).delete()})})}):N.reject(new x.a.DatabaseClosedError)}return e.observable.sendMessage=function(n,s,a,c){if(c=c||{},!r.node)return c.wantReply?N.reject(new x.a.DatabaseClosedError):N.resolve();var u={message:s,destinationNode:a,sender:r.node.id,type:n};return x.a.extend(u,c),x.a.ignoreTransaction(function(){var n=["_intercomm"];c.wantReply&&n.push("_syncNodes");var r=e.transaction("rw",n,function(){return c.wantReply?e._syncNodes.where("id").equals(a).count(function(t){return t?e._intercomm.add(u):e._syncNodes.where("isMaster").above(0).first(function(t){return u.destinationNode=t.id,e._intercomm.add(u)})}):e._intercomm.add(u)}).then(function(n){var r=null;return c.wantReply&&(r=new N(function(e,t){i[n.toString()]={resolve:e,reject:t}})),o&&o.setItem("Dexie.Observable/intercomm/"+e.name,n.toString()),t.on.intercomm.fire(e.name),r});return c.wantReply?r:void r.catch(function(){})})},e.observable.broadcastMessage=function(t,n,o){if(r.node){var i=r.node.id;x.a.ignoreTransaction(function(){e._syncNodes.toArray(function(r){return N.all(r.filter(function(e){return"local"===e.type&&(o||e.id!==i)}).map(function(r){return e.observable.sendMessage(t,n,r.id)}))}).catch(function(){})})}},{onIntercomm:function(t){t===e.name&&s().catch("DatabaseClosedError",function(){})},consumeIntercommMessages:s}}(e,V,0,f,i),h=d.onIntercomm,y=d.consumeIntercommMessages;Object.defineProperty(e,"_localSyncNode",{get:function(){return f.node}});var p=null,v=null;x.a.fake&&(e.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),e._syncNodes.mapToClass(s),e._changes.mapToClass(F),f.node=new s({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),e.Version.prototype._parseStoresSpec=K(e.Version.prototype._parseStoresSpec,H),e.on.addEventType({changes:"asap",cleanup:[I,L],message:"asap"}),e._createTransaction=K(e._createTransaction,c),V.latestRevision[e.name]=V.latestRevision[e.name]||0,e.open=K(e.open,l),e.close=K(e.close,function(t){return function(){return e.dynamicallyOpened()?t.apply(this,arguments):(a.timeoutHandle&&(clearTimeout(a.timeoutHandle),delete a.timeoutHandle),V.on("latestRevisionIncremented").unsubscribe(g),V.on("suicideNurseCall").unsubscribe(R),V.on("intercomm").unsubscribe(h),V.on("beforeunload").unsubscribe(k),f.node&&f.node.id&&(V.on.suicideNurseCall.fire(e.name,f.node.id),i&&i.setItem("Dexie.Observable/deadnode:"+f.node.id.toString()+"/"+e.name,"dead"),f.node.deleteTimeStamp=1,f.node.lastHeartBeat=0,e._syncNodes.put(f.node),f.node=null),p&&clearTimeout(p),p=null,v&&clearTimeout(v),v=null,t.apply(this,arguments))}}),e.delete=K(e.delete,function(t){return function(){return t.apply(this,arguments).then(function(t){return V.latestRevision[e.name]=0,t})}}),e.on("ready",function(){return e.dynamicallyOpened()?e:e.table("_changes").orderBy("rev").last(function(n){var i=n?n.rev:0;return f.node=new s({myRevision:i,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),V.latestRevision[e.name]<i&&(V.latestRevision[e.name]=i,x.a.ignoreTransaction(function(){V.on.latestRevisionIncremented.fire(i)})),e.transaction("rw","_syncNodes",function(){return e._syncNodes.where("isMaster").equals(1).first(function(n){if(n){if(n.lastHeartBeat<Date.now()-t)return f.node.isMaster=1,n.isMaster=0,e._syncNodes.put(n)}else f.node.isMaster=1}).then(function(){return e._syncNodes.add(f.node).then(function(){V.on("latestRevisionIncremented",g),V.on("beforeunload",k),V.on("suicideNurseCall",R),V.on("intercomm",h),p=setTimeout(w,r),v=setTimeout(_,o)})})}).then(function(){O()})})},!0);var b=0;function g(t,n){if(t===e.name){if(b>=n)return;b=n,x.a.vip(function(){m(n).catch("DatabaseClosedError",function(){})})}}function m(t,n,r){if(!n&&m.ongoingOperation)return m.ongoingOperation;var o=!1,i=f.node;if(!i)return q.reject(new x.a.DatabaseClosedError);var s=e._changes.where("rev").above(i.myRevision).limit(1e3).toArray(function(t){if(t.length>0){var n=t[t.length-1];o=1e3===t.length,e.on("changes").fire(t,o),i.myRevision=n.rev}else r&&e.on("changes").fire([],!1);var s=!1;return e._syncNodes.where(":id").equals(i.id).modify(function(e){s=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,i.myRevision)}).then(function(){return s})}).then(function(t){if(!t)throw G?new Error("Browser is shutting down"):(e.close(),console.error("Out of sync"),B.location&&B.location.reload(!0),new Error("Out of sync"));if(o||V.latestRevision[e.name]>i.myRevision)return m(V.latestRevision[e.name],(n||0)+1,o)}).finally(function(){delete m.ongoingOperation});return n||(m.ongoingOperation=s),s}function _(){v=null;var t=f.node&&f.node.id;t&&e.transaction("rw!",e._syncNodes,function(){e._syncNodes.where({id:t}).first(function(t){if(t)return t.lastHeartBeat=Date.now(),t.deleteTimeStamp=null,e._syncNodes.put(t);e.isOpen()&&e.close()})}).catch("DatabaseClosedError",function(){}).finally(function(){f.node&&f.node.id===t&&e.isOpen()&&(v=setTimeout(_,o))})}function w(){p=null;var t=f.node&&f.node.id;t&&x.a.vip(function(){m(V.latestRevision[e.name]).then(O).then(y).catch("DatabaseClosedError",function(){}).finally(function(){f.node&&f.node.id===t&&e.isOpen()&&(p=setTimeout(w,r))})})}function O(){var r=f.node;return r?e.transaction("rw","_syncNodes","_changes","_intercomm",function(){var o=!1;e._syncNodes.where("lastHeartBeat").below(Date.now()-t).filter(function(e){return"local"===e.type}).modify(function(t){t.deleteTimeStamp&&t.deleteTimeStamp<Date.now()?(delete this.value,i&&i.removeItem("Dexie.Observable/deadnode:"+t.id+"/"+e.name),t.isMaster&&(e._syncNodes.update(r,{isMaster:1}),o=!0),e._intercomm.where({destinationNode:t.id}).modify(function(e){e.wantReply?e.destinationNode=r.id:delete this.value})):t.deleteTimeStamp||(t.deleteTimeStamp=Date.now()+n)}).then(function(){return V.deleteOldChanges(e),e.on("cleanup").fire(o)})}):q.reject(new x.a.DatabaseClosedError)}function k(){f.node&&(G=!0,f.node.deleteTimeStamp=1,f.node.lastHeartBeat=0,e._syncNodes.put(f.node),V.wereTheOneDying=!0,i&&i.setItem("Dexie.Observable/deadnode:"+f.node.id.toString()+"/"+e.name,"dead"))}function R(t,n){t!==e.name||V.wereTheOneDying||x.a.vip(function(){e._syncNodes.update(n,{deleteTimeStamp:1,lastHeartBeat:0}).then(O)})}}V.latestRevision={},V.on=x.a.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),V.createUUID=T,V.deleteOldChanges=function e(t){x.a.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()}).then(function(n){if(0!==n.length)return t._changes.bulkDelete(n).then(function(){100===n.length&&setTimeout(function(){return t.isOpen()&&e(t)},500)})})}).catch(function(){})},V._onStorage=function(e){return function(t){if(0===t.key.indexOf("Dexie.Observable/")){var n=t.key.split("/"),r=n[1],o=n[2];if("latestRevision"===r){var i=parseInt(t.newValue,10);!isNaN(i)&&i>e.latestRevision[o]&&(e.latestRevision[o]=i,x.a.ignoreTransaction(function(){e.on("latestRevisionIncremented").fire(o,i)}))}else if(0===r.indexOf("deadnode:")){var s=parseInt(r.split(":")[1],10);t.newValue&&e.on.suicideNurseCall.fire(o,s)}else"intercomm"===r&&t.newValue&&e.on.intercomm.fire(o)}}}(V),V._onBeforeUnload=function(){V.on.beforeunload.fire()};try{V.localStorageImpl=B.localStorage}catch(e){}B.addEventListener&&(B.addEventListener("storage",V._onStorage),B.addEventListener("beforeunload",V._onBeforeUnload)),x.a.Observable=V,x.a.addons.push(V);var W=x.a.Promise;function J(e){return function(){function t(e,t){this.nodeID=e,t&&x.a.extend(this,t)}return t.prototype.save=function(){return x.a.vip(function(){return e.save()})},t}()}var Y=1,z=2,$=3;function Q(e){if(0===e.remoteBaseRevisions.length)return{maxClientRevision:1/0,remoteBaseRevision:null};for(var t=e.remoteBaseRevisions.length-1;t>=0;--t)if(e.myRevision>=e.remoteBaseRevisions[t].local)return{maxClientRevision:t===e.remoteBaseRevisions.length-1?1/0:e.remoteBaseRevisions[t+1].local,remoteBaseRevision:e.remoteBaseRevisions[t].remote};return{maxClientRevision:e.remoteBaseRevisions[0].local,remoteBaseRevision:null}}function X(e,t,n){var r=n;return function(n,o){var i=function(e,t,n){return function(r,o,i,s){var a={},c=0,u=!1,l=t.id,f=r;return e.transaction("r",e._changes,function(){return e._changes.where("rev").between(r,i,!1,!0).until(function(){if(c===o)return u=!0,!0}).each(function(e){if(f=e.rev,e.source!==l){var t={type:e.type,table:e.table,key:e.key};e.type===Y?t.obj=e.obj:e.type===z&&(t.mods=e.mods);var n=e.table+":"+e.key,r=a[n];if(r){var o=function(e,t){switch(e.type){case Y:switch(t.type){case Y:return t;case z:return function(e,t){var n=x.a.deepClone(e);return Object.keys(t.mods).forEach(function(e){x.a.setByKeyPath(n.obj,e,t.mods[e])}),n}(e,t);case $:return t}break;case z:switch(t.type){case Y:return t;case z:return function(e,t){var n=x.a.deepClone(e);return Object.keys(t.mods).forEach(function(r){var o=!1;Object.keys(e.mods).filter(function(e){return 0===r.indexOf(e+".")}).forEach(function(e){x.a.setByKeyPath(n.mods[e],r.substr(e.length+1),t.mods[r]),o=!0}),o||(n.mods[r]=t.mods[r]),Object.keys(e.mods).filter(function(e){return 0===e.indexOf(r+".")}).forEach(function(e){delete n.mods[e]})}),n}(e,t);case $:return t}break;case $:switch(t.type){case Y:return t;case z:case $:return e}}}(r,t);a[n]=o}else a[n]=t,++c}})}).then(function(){var e=Object.keys(a).map(function(e){return a[e]});return n.hasMoreToGive=u,s(e,u,{myRevision:f})})}}(e,n,t),s=function(e,t,n,r,o,i){return function s(a,c,u){var l=!1;return u.until(function(){if(c.length===n)return l=!0,!0}).each(function(e,t){c.push({type:Y,table:a.currentTable,key:t.key,obj:t.value}),a.currentKey=t.key}).then(function(){if(l)return o.hasMoreToGive=!0,i(c,null,!0,{dbUploadState:a});if(0===a.tablesToUpload.length){var u=Q(t);return r(a.localBaseRevision,n-c.length,u.maxClientRevision,function(e,t,n){return c=c.concat(e),n.dbUploadState=null,i(c,u.remoteBaseRevision,t,n)})}return a.currentTable=a.tablesToUpload.shift(),s(a,c,e.table(a.currentTable).orderBy(":id"))})}}(e,n,r,i,t,o);if(n.myRevision>=0){var a=Q(n);return i(n.myRevision,r,a.maxClientRevision,function(e,t,n){return o(e,a.remoteBaseRevision,t,n)})}if(null===n.dbUploadState){var c=e.tables.filter(function(e){return e.schema.observable}).map(function(e){return e.name});if(0===c.length)return x.a.Promise.resolve(o([],null,!1,{}));var u={tablesToUpload:c,currentTable:c.shift(),currentKey:null};return e._changes.orderBy("rev").last(function(t){u.localBaseRevision=t&&t.rev||0;var n=e.table(u.currentTable).orderBy(":id");return s(u,[],n)})}if(n.dbUploadState.currentKey){var l=e.table(n.dbUploadState.currentTable).where(":id").above(n.dbUploadState.currentKey);return s(x.a.deepClone(n.dbUploadState),[],l)}return l=e.table(u.currentTable).orderBy(":id"),s(x.a.deepClone(n.dbUploadState),[],l)}}var Z={ERROR:-1,OFFLINE:0,CONNECTING:1,ONLINE:2,SYNCING:3,ERROR_WILL_RETRY:4},ee=x.a.Promise;function te(e,t,n,r,o){var i=function(e){return function t(n,r,o){function i(){return n.ongoingOperation?n.ongoingOperation=n.ongoingOperation.then(function(){return t(n,r,o)}):n.ongoingOperation=x.a.ignoreTransaction(function(){return x.a.vip(function(){return r()})}).finally(function(){delete n.ongoingOperation}),n.ongoingOperation}return o?e._localSyncNode&&o===e._localSyncNode.id?i():x.a.Promise.reject(new x.a.DatabaseClosedError):e.isOpen()?i():x.a.Promise.reject(new x.a.DatabaseClosedError)}}(e),s={hasMoreToGive:!0};function a(){return e._localSyncNode&&e._localSyncNode.id===n}return function(c,u){var l,f=X(e,s,t.partialsThreshold),d=u.url;function h(t){c.status!==t&&(c.status=t,c.save().then(function(){e.syncable.on.statusChanged.fire(t,d),e.observable.broadcastMessage("syncStatusChanged",{newStatus:t,url:d},!1)}).catch("DatabaseClosedError",function(){}))}return u.on("disconnect",function(e){isNaN(e)||h(e)}),h(Z.CONNECTING),y();function y(){return i(y,function(){return b(c,p)},n)}function p(e,n,i,s){var u=new ee(function(s,u){o.p=function(e){u(e)},x.a.asap(function(){try{t.sync(c.syncContext,d,r,n,c.appliedRemoteRevision,e,i,g,f,function(e){s(e)},o)}catch(e){o(e,1/0)}function o(e,t){u(e),a()&&(!isNaN(t)&&t<1/0?(setTimeout(function(){a()&&(h(Z.SYNCING),y().catch("DatabaseClosedError",v))},t),h(Z.ERROR_WILL_RETRY),l&&l.disconnect&&l.disconnect(),l=null):v(e))}})});return u.then(function(){}).finally(function(){o.p=null});function f(){return Object.keys(s).forEach(function(e){x.a.setByKeyPath(c,e,s[e])}),u.then(m),c.save()}}function v(e){u.disconnect(Z.ERROR,e)}function b(e,t){return f(e,function n(r,o,i,s){return 0===r.length&&"myRevision"in s&&s.myRevision!==e.myRevision?(Object.keys(s).forEach(function(t){x.a.setByKeyPath(e,t,s[t])}),e.save().catch("DatabaseClosedError",function(){}),f(e,n)):t(r,o,i,s)})}function g(t,r,o){var s=function(e,t){return function(n,r){return e.transaction("rw!",e._uncommittedChanges,function(){return e._uncommittedChanges.bulkAdd(n.map(function(e){var n={node:t.id,type:e.type,table:e.table,key:e.key};return e.obj&&(n.obj=e.obj),e.mods&&(n.mods=e.mods),n}))}).then(function(){return t.appliedRemoteRevision=r,t.save()})}}(e,c),u=function(e,t){var n=function(e){return function(t){var n={};t.forEach(function(e){var t;n.hasOwnProperty(e.table)||(n[e.table]=((t={})[Y]=[],t[$]=[],t[z]=[],t)),n[e.table][e.type].push(e)});var r=Object.keys(n),o=r.map(function(t){return e.table(t)});return e.transaction("rw",o,function(){r.forEach(function(t){var r=e.table(t),o=!r.schema.primKey.keyPath,i=n[t][Y],s=n[t][$],a=n[t][z];i.length>0&&r.bulkPut(i.map(function(e){return e.obj}),o?i.map(function(e){return e.key}):void 0),a.length>0&&function(e,t){var n=t.map(function(e){return e.key}),r={};e.where(":id").anyOf(n).raw().each(function(e,t){r[t.primaryKey+""]=e}).then(function(){var n=t.filter(function(e){return r.hasOwnProperty(e.key+"")}).map(function(e){var t=r[e.key+""];return Object.keys(e.mods).forEach(function(n){x.a.setByKeyPath(t,n,e.mods[n])}),t});return e.bulkPut(n)})}(r,a),s.length>0&&r.bulkDelete(s.map(function(e){return e.key}))})})}}(e);return function(r,o){var i=e.tables.filter(function(e){return"_changes"===e.name||"_uncommittedChanges"===e.name||e.schema.observable});return e.transaction("rw!",i,function(){var i=x.a.currentTransaction,s=0;return e._changes.orderBy("rev").last(function(e){s=e&&e.rev||0}).then(function(){return i.source=t.id,e._uncommittedChanges.where("node").equals(t.id).toArray()}).then(function(e){return n(e)}).then(function(){return e._uncommittedChanges.where("node").equals(t.id).delete()}).then(function(){return n(r)}).then(function(){return e._changes.orderBy("rev").last()}).then(function(e){var n=e&&e.rev||0;if(t.appliedRemoteRevision=o,t.remoteBaseRevisions.push({remote:o,local:n}),t.myRevision===s&&(t.myRevision=n),t.remoteBaseRevisions.length>1)for(var r=t.remoteBaseRevisions.length-1;r>0;--r)if(t.myRevision>=t.remoteBaseRevisions[r].local){t.remoteBaseRevisions.splice(0,r);break}t.save().catch(function(e){console.warn("Dexie.Syncable: Unable to save SyncNode after applying remote changes: "+(e.stack||e))})})})}}(e,c);return i(g,function(){return a()?(o?s(t,r):u(t,r)).catch(function(e){return v(e),ee.reject(e)}):ee.reject(new x.a.DatabaseClosedError)},n)}function m(n){a()?(l=n,u.on("disconnect",function(){if(l){if(l.react)try{l.disconnect()}catch(e){}l=null}}),n.react?function(t){var n,r;function o(){l&&(h(Z.SYNCING),r?n=!0:i())}function i(){l&&(n=!1,r=!0,b(c,function(e,o,s,a){l&&(e.length>0?t.react(e,o,s,function(){Object.keys(a).forEach(function(e){x.a.setByKeyPath(c,e,a[e])}),c.save().catch("DatabaseClosedError",function(){}),i()}):(r=!1,n?i():h(Z.ONLINE)))}).catch(function(e){console.error("Got "+e.message+" caught by reactToChanges"),v(e)}))}e.on("changes",o),u.on("disconnect",function(){e.on.changes.unsubscribe(o)}),i()}(n):function(){function e(){b(c,function(n,o,i,s){t.sync(c.syncContext,d,r,o,c.appliedRemoteRevision,n,i,g,function(){Object.keys(s).forEach(function(e){x.a.setByKeyPath(c,e,s[e])}),c.save().catch("DatabaseClosedError",function(){})},function(t){l&&(l=t,i?e():!isNaN(t.again)&&t.again<1/0?(h(Z.ONLINE),setTimeout(function(){l&&(h(Z.SYNCING),e())},t.again)):u.disconnect(Z.OFFLINE))},function(t,n){!isNaN(n)&&n<1/0?l&&(setTimeout(function(){l&&(h(Z.SYNCING),e())},n),h(Z.ERROR_WILL_RETRY)):v(t)})}).catch(v)}s.hasMoreToGive?e():l&&!isNaN(l.again)&&l.again<1/0?(h(Z.ONLINE),setTimeout(function(){l&&(h(Z.SYNCING),e())},l.again)):u.disconnect(Z.OFFLINE)}()):n.disconnect&&n.disconnect()}}}var ne=x.a.override,re=x.a.Promise,oe=x.a.Observable;function ie(e){var t=[],n=function(e,t){return function(n,r,o,i,s){var a=t.filter(function(e){return e.url===o});if(a.length>0){var c=a[0],u={};return x.a.getObjectDiff(c.syncOptions,i,u),0!==Object.keys(u).length?e.syncable.disconnect(o).then(function(){return l()}):a[0].connectPromise}function l(){var a={p:null},c=te(e,n,s,i,a),u=function(e,t,n){return function(r){return e.transaction("rw",e._syncNodes,e._changes,function(){if(!n)throw new Error("Url cannot be empty");return e._syncNodes.where("url").equalsIgnoreCase(n).first(function(o){if(o){var i=J(o);o.syncContext=new i(o.id,o.syncContext),o.syncProtocol=t,o.syncOptions=r,e._syncNodes.put(o)}else{(o=new e.observable.SyncNode).myRevision=-1,o.appliedRemoteRevision=null,o.remoteBaseRevisions=[],o.type="remote",o.syncProtocol=t,o.url=n,o.syncOptions=r,o.lastHeartBeat=Date.now(),o.dbUploadState=null;var s=J(o);x.a.Promise.resolve(function(){if(!1===r.initialUpload)return e._changes.toCollection().lastKey(function(e){o.myRevision=e})}()).then(function(){e._syncNodes.add(o).then(function(t){o.syncContext=new s(t),e._syncNodes.put(o)})})}return o})})}}(e,r,o)(i).then(function(e){return c(e,f)}),l=!1,f={url:o,status:Z.OFFLINE,connectPromise:u,syncOptions:i,on:x.a.Events(null,"disconnect"),disconnect:function(e,n){var r=t.indexOf(f);r>=0&&t.splice(r,1),n&&a.p&&a.p(n),l||f.on.disconnect.fire(e,n),l=!0}};return t.push(f),u}return l()}}(e,t),r=function(e,t){return function(n,r,o,i){if(e.isOpen()){if(!e._localSyncNode)throw new Error("Precondition failed: local sync node is missing. Make sure Dexie.Observable is active!");return e._localSyncNode.isMaster?t(n,r,o,i,e._localSyncNode.id):e.table("_syncNodes").where("isMaster").above(0).first(function(t){return e.observable.sendMessage("connect",{protocolName:r,url:o,options:i},t.id,{wantReply:!0})})}return e.hasBeenClosed()?W.reject(new x.a.DatabaseClosedError):e.hasFailed()?W.reject(new x.a.InvalidStateError("Dexie.Syncable: Cannot connect. Database has failed to open")):new W(function(t,n){e.on("ready",function(){return e._syncNodes.get({url:o},function(s){var a=e.syncable.connect(r,o,i);if(a.then(t,n),!s||!s.appliedRemoteRevision)return a})}),e.open().catch(function(e){n(new x.a.InvalidStateError("Dexie.Syncable: Couldn't connect. Database failed to open",e))})})}}(e,n);e.on("message",function(t){x.a.vip(function(){"connect"===t.type?e.syncable.connect(t.message.protocolName,t.message.url,t.message.options).then(t.resolve,t.reject):"disconnect"===t.type?e.syncable.disconnect(t.message.url).then(t.resolve,t.reject):"syncStatusChanged"===t.type&&e.syncable.on.statusChanged.fire(t.message.newStatus,t.message.url)})}),e.on("cleanup",function(t){t&&x.a.ignoreTransaction(function(){return x.a.vip(function(){return e._syncNodes.where({type:"remote"}).filter(function(e){return e.status!==Z.OFFLINE}).toArray(function(t){return re.all(t.map(function(t){return e.syncable.connect(t.syncProtocol,t.url,t.syncOptions).catch(function(e){console.warn("Dexie.Syncable: Could not connect to "+t.url+". "+(e.stack||e))})}))})})}).catch("DatabaseClosedError",function(){})}),e.on("ready",function(){e._localSyncNode&&e._localSyncNode.isMaster&&e._syncNodes.where("type").equals("remote").and(function(e){return e.status!==Z.OFFLINE}).toArray(function(t){t.forEach(function(t){return e.syncable.connect(t.syncProtocol,t.url,t.syncOptions).catch(function(){})})}).catch("DatabaseClosedError",function(){})},!0),e.syncable={},e.syncable.getStatus=function(t,n){return e.isOpen()?x.a.vip(function(){return e._syncNodes.where("url").equals(t).first(function(e){return e?e.status:Z.OFFLINE})}).then(n):re.resolve(ie.Statuses.OFFLINE).then(n)},e.syncable.getOptions=function(t,n){return e.transaction("r?",e._syncNodes,function(){return e._syncNodes.where("url").equals(t).first(function(e){return e.syncOptions}).then(n)})},e.syncable.list=function(){return e.transaction("r?",e._syncNodes,function(){return e._syncNodes.where("type").equals("remote").toArray(function(e){return e.map(function(e){return e.url})})})},e.syncable.on=x.a.Events(e,{statusChanged:"asap"}),e.syncable.disconnect=function(n){return x.a.ignoreTransaction(function(){return re.resolve().then(function(){return e._localSyncNode&&e._localSyncNode.isMaster?re.all(t.filter(function(e){return e.url===n}).map(function(e){return e.disconnect(Z.OFFLINE)})):e._syncNodes.where("isMaster").above(0).first(function(t){return e.observable.sendMessage("disconnect",{url:n},t.id,{wantReply:!0})})}).then(function(){return e._syncNodes.where("url").equals(n).modify(function(e){e.status=Z.OFFLINE})})})},e.syncable.connect=function(e,t,n){n=n||{};var o=ie.registeredProtocols[e];return o?r(o,e,t,n):re.reject(new Error("ISyncProtocol '"+e+"' is not registered in Dexie.Syncable.registerSyncProtocol()"))},e.syncable.delete=function(t){return e.syncable.disconnect(t).then(function(){return e.transaction("rw!",e._syncNodes,e._changes,e._uncommittedChanges,function(){var n;return e._syncNodes.where("url").equals(t).toArray(function(e){return e.map(function(e){return e.id})}).then(function(t){return n=t,e._syncNodes.where("id").anyOf(t).delete()}).then(function(){return e._uncommittedChanges.where("node").anyOf(n).delete()})}).then(function(){oe.deleteOldChanges(e)})})},e.syncable.unsyncedChanges=function(t){return e._syncNodes.where("url").equals(t).first(function(t){return e._changes.where("rev").above(t.myRevision).toArray()})},e.close=ne(e.close,function(e){return function(){return t.forEach(function(e){e.disconnect()}),e.apply(this,arguments)}}),Object.defineProperty(e.observable.SyncNode.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(){var t=this;return e.transaction("rw?",e._syncNodes,function(){return e._syncNodes.put(t)})}})}ie.Statuses=Z,ie.StatusTexts={"-1":"ERROR",0:"OFFLINE",1:"CONNECTING",2:"ONLINE",3:"SYNCING",4:"ERROR_WILL_RETRY"},ie.registeredProtocols={},ie.registerSyncProtocol=function(e,t){var n=t.partialsThreshold;if("number"==typeof n){if(isNaN(n)||n<0)throw new Error("The given number for the threshold is not supported")}else t.partialsThreshold=1/0;ie.registeredProtocols[e]=t},x.a.Syncable=ie,x.a.addons.push(ie);var se=n(27),ae=n.n(se),ce=Object.create({createSandbox:function(e){var t=this;return new Promise(function(n){var r,o="",i={};e.hasOwnProperty("windowSandbox")&&e.windowSandbox&&(o="windowSandbox"),t.capabilitiesManager.isAvailable(o).then(function(e){e?(i={windowSandbox:!0},console.info("[createSandbox ] - windowSandbox"),r=new f(i)):(console.info("[createSandbox ] - sandbox"),r=new b(i)),n(r)}).catch(function(t){console.log("[createSandbox ] By default create a normal sandbox: ",t),console.info("[createSandbox ] - sandbox"),r=new b(e),n(r)})})},createAppSandbox:function(){return new k},createHttpRequest:function(){return new S},atob:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return atob(e)}),storageManager:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.databases||(this.databases={}),this.storeManager||(this.storeManager={}),navigator&&navigator.storage&&navigator.storage.persist&&navigator.storage.persist().then(function(e){e?console.log("Storage will not be cleared except by explicit user action"):console.log("Storage may be cleared by the UA under storage pressure.")}),!this.databases.hasOwnProperty(e)){var o={};if(t?o=t:o[e]="key,version,value",r){var i=[{version:1,stores:o}];this.databases[e]=new ae.a(e,i)}else this.databases[e]=new x.a(e,{addons:[]}),this.databases[e].version(1).stores(o)}return this.storeManager.hasOwnProperty(e)||(this.storeManager[e]=new j.default(this.databases[e],e,t,n,1,r)),r&&(this.storeManager[e].remote=r),this.storeManager[e]},runtimeCapabilities:function(){if(!this.capabilitiesManager){var e=this.storageManager("capabilities");this.capabilitiesManager=new M(e)}return this.capabilitiesManager}}),ue=n(0);function le(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var fe=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!r)throw Error("Message Bus not set!");var o=this;o._guiURL=t,o._idmURL=n,o._messageBus=r,o._messageBus.addListener(t,function(e){var t=e.body.method;if(console.log("[IdentitiesGUI.listener] received msg: "+e),"openPopup"!==t)   ;else{var n=e.body.params.urlreceived;o._openPopup(n).then(function(t){var n={type:"execute",value:t,code:200},r={id:e.id,type:"response",to:e.from,from:e.to,body:n};o._messageBus.postMessage(r)})}})}return function(e,t,n){t&&le(e.prototype,t)}(e,[{key:"callIdentityModuleFunc",value:function(e,t){var n=this,r=this;return new Promise(function(o,i){var s={type:"execute",to:r._idmURL,from:r._guiURL,body:{resource:"identity",method:e,params:t}};n._messageBus.postMessage(s,function(e){if(e.body.code<299){var t=e.body.value;o(t)}else o(e.body)})})}},{key:"_openPopup",value:function(e){var t=this;return new Promise(function(n,r){var o;if(console.log("[IdentitiesGUI._openPopup] url: "+e),e?(o||(o=window.open("","openIDrequest","location=1,status=1"),t.win=o),function(e){for(var t=(new Date).getTime(),n=t;n<t+1e3;)n=(new Date).getTime()}(),(o=t.win).location.href=e):(o=window.open("","openIDrequest","location=1,status=1"),t.win=o,n()),window.cordova)o.addEventListener("loadstart",function(e){var t=e.url,i=/\&code=(.+)$/.exec(t),s=/\&error=(.+)$/.exec(t);return i||s?(o.close(),n(t)):r("openPopup error 1 - should not happen")});else var i=setInterval(function(){try{if(o.closed&&clearInterval(i),-1!==o.document.URL.indexOf(location.origin)){window.clearInterval(i);var e=o.document.URL;return n(e),o.close()}}catch(e){}},500)})}},{key:"authorise",value:function(e,t){var n=this;return this._openPopup().then(function(r){var o={scope:t,idpDomain:e};return n.callIdentityModuleFunc("getAccessTokenAuthorisationEndpoint",o)}).then(function(e){return console.log("[IdentitiesGUI.authorise] receivedURL from idp Proxy: "+e),n._openPopup(e)}).then(function(r){console.log("[IdentitiesGUI.authorise.openPopup.result]",r);var o={resources:[t],idpDomain:e,login:r};return n.callIdentityModuleFunc("getAccessToken",o)}).then(function(e){return e.hasOwnProperty("code")&&e.code>299?(console.error("[IdentitiesGUI.authorise.getAccessToken] error",e),e):(console.log("[IdentitiesGUI.authorise.getAccessToken.result]",e),n.callIdentityModuleFunc("addAccessToken",e))}).then(function(e){return e})}},{key:"unauthorise",value:function(e,t){var n={resources:[t],domain:e};return this.callIdentityModuleFunc("unauthorise",Object(ue.i)(n)).then(function(e){return console.log("[IdentitiesGUI.unauthorise] result: "+e),e})}},{key:"reauthorise",value:function(e,t,n){var r=this;return this._openPopup(e).then(function(e){console.log("[IdentitiesGUI.reauthorise.openPopup.result]",e);var o={resources:[n],idpDomain:t,login:e};return r.callIdentityModuleFunc("getAccessToken",o)}).then(function(e){return e.hasOwnProperty("code")&&e.code>299?(console.error("[IdentitiesGUI.authorise.getAccessToken] error",e),e):(console.log("[IdentitiesGUI.authorise.getAccessToken.result]",e),r.callIdentityModuleFunc("addAccessToken",e))}).then(function(e){return e})}},{key:"loginWithIDP",value:function(e){var t,n=this;return this._openPopup().then(function(e){return n.callIdentityModuleFunc("getMyPublicKey",{})}).then(function(r){t=r;var o={contents:r,origin:"origin",usernameHint:void 0,idpDomain:e};return n.callIdentityModuleFunc("sendGenerateMessage",o)}).then(function(e){if(console.log("[IdentitiesGUI.loginWithIDP] received reply to request for Login URL from idp Proxy: "+e+"..."),e.hasOwnProperty("description")&&e.description.hasOwnProperty("loginUrl")){var t,r=e.description.loginUrl;if(-1!==r.indexOf("redirect_uri")){var o=r.substring(0,r.indexOf("redirect_uri")),i=r.substring(r.indexOf("redirect_uri"),r.length),s=i.substring(i.indexOf("&"),r.length);t=-1!==s.indexOf("&")?o+"redirect_uri="+location.origin+s:o+"redirect_uri="+location.origin}return n.resultURL=t||r,console.log("[IdentitiesGUI.openPopup]",n.resultURL),n._openPopup(n.resultURL)}}).then(function(r){console.log("[IdentitiesGUI.loginWithIDP] identity",r);var o={contents:t,origin:"origin",usernameHint:r,idpDomain:e};return n.callIdentityModuleFunc("sendGenerateMessage",o)}).then(function(e){return console.log("[IdentitiesGUI.loginWithIDP] sendGenerateMessage.result",e),n.callIdentityModuleFunc("addAssertion",e)}).then(function(e){var t={type:"identity",value:e.userProfile.userURL};return console.log("[IdentitiesGUI.loginWithIDP] final identity ",e),t})}},{key:"logOut",value:function(){return console.log("[IdentitiesGUI.logOut]"),new Promise(function(e,t){e(!0)})}}]),e}(),de=n(1),he=n.n(de),ye=he.a.getLogger("address-allocation"),pe=he.a.getLogger("Bus"),ve=he.a.getLogger("MessageBus"),be=he.a.getLogger("CoreDiscovery"),ge=he.a.getLogger("StorageManager"),me=he.a.getLogger("HypertyResourcesStorage"),_e=he.a.getLogger("IdentityModule"),we=he.a.getLogger("PEP"),Oe=he.a.getLogger("P2PConnectionResolve"),ke=he.a.getLogger("Registry"),Re=he.a.getLogger("RuntimeUA"),Pe=he.a.getLogger("Loader"),Se=he.a.getLogger("Descriptors"),je=he.a.getLogger("DataObjectsStorage"),Ee=he.a.getLogger("Subscription"),Me=he.a.getLogger("SubscriptionManager"),Ce=he.a.getLogger("ObserverObject"),xe=he.a.getLogger("ReporterObject"),Le=he.a.getLogger("SynSubscription"),Ie=he.a.getLogger("SyncherManager"),Te=he.a.getLogger("IdentityHandler"),Ue=he.a.getLogger("CryptoManager"),Ae=he.a.getLogger("Pipeline"),De=he.a.getLogger("Syncher"),Ne=he.a.getLogger("RuntimeCatalogue");ye.setLevel(0),pe.setLevel(3),ve.setLevel(3),be.setLevel(5),ge.setLevel(0),me.setLevel(3),_e.setLevel(0),we.setLevel(3),Oe.setLevel(3),ke.setLevel(0),Re.setLevel(0),Pe.setLevel(0),Se.setLevel(3),je.setLevel(0),Ee.setLevel(3),Me.setLevel(3),Ce.setLevel(0),xe.setLevel(0),Le.setLevel(3),Ie.setLevel(0),Te.setLevel(3),Ue.setLevel(0),Ae.setLevel(0),De.setLevel(0),De.setLevel(0),Ne.setLevel(0);var He={runtimeDescriptor:{},runtimeCapabilities:{constraints:{}}};function Be(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Fe,Ke=de.getLogger("address-allocation"),qe=function(){function e(t,n,r,o){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Fe)return Fe;this._url=t+"/address-allocation",this._bus=n,this._registry=r,this._subscriptionManager=o,Fe=this}return function(e,t,n){t&&Be(e.prototype,t),n&&Be(e,n)}(e,[{key:"create",value:function(e,t,n,r,o){return Ke.log("[AddressAllocation.create] info ",n),o?"boolean"==typeof o?o?this._reuseAllocatedAddress(e,t,n,r,o):this._allocateNewAddress(e,r,t,n):"string"==typeof o&&Object(ue.v)(o)?new Promise(function(e,t){return e({newAddress:!1,address:[o]})}):void 0:(Ke.log("[AddressAllocation] - new address will be allocated"),this._allocateNewAddress(e,r,t,n))}},{key:"_reuseAllocatedAddress",value:function(e,t,n,r,o){var i=this;return new Promise(function(s,a){console.log("REUSETEST -  _reuseAllocatedAddress",e,t,n,r,o),i._registry.checkRegisteredURLs(n,o).then(function(c){console.log("REUSETEST -  registeredurls",c),c?(Ke.info("[AddressAllocation - "+r+"] - Reuse URL"),s({newAddress:!1,address:c})):"string"==typeof o?(Ke.info("[AddressAllocation - reuseURL] - Object "+o+" not found"),a("URL Not Found")):"boolean"==typeof o?i._allocateNewAddress(e,r,t,n).then(s).catch(a):a("URL Not Found")})})}},{key:"_allocateNewAddress",value:function(e,t,n,r){var o=this;return new Promise(function(i,s){var a,c=[];for(a=0;a<n;a++)c.push(t+"://"+e+"/"+Object(ue.n)());var u={newAddress:!0,address:c};"hyperty"===t?r.hasOwnProperty("configuration")&&r.configuration.hasOwnProperty("domain_routing")&&!r.configuration.domain_routing?i(u):o._subscriptionManager.createSubscription(e,c,o._url).then(function(){i(u)}):i(u)})}},{key:"delete",value:function(e,t){return new Promise(function(e,t){e(200)})}},{key:"url",get:function(){return this._url}}],[{key:"instance",get:function(){if(!Fe)throw new Error("The address allocation was not instantiated");return Fe}}]),e}();function Ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ve=function(){function e(t,n,r,o,i,s,a,c,u){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._id=t,this._url=n,this._descriptorURL=r,this._startingTime=i,this._lastModified=s,this._status=a,this._stubs=c,this._stubsConfiguration=u,this._p2pRequester=o}return function(e,t,n){t&&Ge(e.prototype,t)}(e,[{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._url}},{key:"descriptorURL",get:function(){return this._descriptorURL}},{key:"p2pRequester",get:function(){return this._p2pRequester}},{key:"lastModified",get:function(){return this._lastModified}}]),e}();function We(e){return(We="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ye(e){return(Ye=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ze(e,t){return(ze=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $e(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var Qe=function(e){function t(e,n,r,o,i,s,a,c,u,l,f,d,h,y,p){var v;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var b=$e($e(v=function(e,t){return!t||"object"!==We(t)&&"function"!=typeof t?$e(e):t}(this,Ye(t).call(this,e,n,r,f,y,p))));return b._descriptor=o,b._hypertyURL=i,b._user=s,b._guid=a,b._runtime=c,b._context=u,b._p2pHandler=l,b._dataSchemes=d,b._resources=h,v}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ze(e,t)}(t,Ve),function(e,t,n){t&&Je(e.prototype,t)}(t,[{key:"user",set:function(e){this.user=e},get:function(){return this._user}},{key:"hypertyURL",get:function(){return this._hypertyURL}},{key:"descriptor",get:function(){return this._descriptor}},{key:"objectName",get:function(){return this._descriptor._objectName}},{key:"p2pHandler",get:function(){return this._p2pHandler}},{key:"dataSchemes",get:function(){return this._dataSchemes}},{key:"resources",get:function(){return this._resources}},{key:"runtimeURL",get:function(){return this._runtime}}]),t}();function Xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ze=de.getLogger("Registry"),et=function(){function e(t,n,r,o){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("runtimeURL is missing.");if(!n)throw new Error("registryURL is missing.");if(!r)throw new Error("domain is missing.");if(!o)throw new Error("messageBus is missing.");this.registryURL=n,this.runtimeURL=t,this._registrationRetries=5,this.expiresTime=3600,this._domain=r,this._messageBus=o}return function(e,t,n){t&&Xe(e.prototype,t)}(e,[{key:"unregisterHyperty",value:function(e){var t={type:"update",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:"/hyperty/"+e,value:"disconnected",attribute:"status"}};this._messageBus.postMessage(t,function(e){Ze.log("[DomainRegistration] unregister hyperty Reply",e)})}},{key:"unregisterDataObject",value:function(e){var t={type:"update",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:e,value:{status:"disconnected"}}};this._messageBus.postMessage(t,function(e){Ze.log("[DomainRegistration] unregister dataObject Reply",e)})}},{key:"deleteDataObjectInstance",value:function(e){var t={type:"delete",from:this.registryURL,to:"domain://registry."+this._domain,body:{value:{name:e}}};this._messageBus.postMessage(t,function(e){Ze.log("[DomainRegistration] unregister dataObject Reply",e)})}},{key:"updateHypertyInstance",value:function(e,t){var n={type:"UPDATE",from:this.registryURL,to:"domain://registry."+this._domain,body:{resource:e,value:t}};this._messageBus.post.postMessage(n,function(e){})}},{key:"registerDataObject",value:function(e,t,n){var r,o,i=this;return new Promise(function(s,a){var c,u=[],l=e.url.split(":");u.push(l[0]),0!==Object.keys(n).length&&(r=n[i.runtimeURL].url,o=He.runtimeDescriptor.p2pRequesterStub),e.startingTime=e.created,delete e.authorise,delete e.created,delete e.mutual,delete e.resume,e.expires||(e.expires=i.expiresTime),e.dataSchemes=u,r&&(e.p2pHandler=r,e.p2pRequester=o),e.status="live",t?(Ze.log("[Registry.registerDataObject] registering previously registered data object URL",e),c={type:"update",to:"domain://registry."+i._domain,from:i.registryURL,body:{resource:e.url,value:{status:"live"}}}):(Ze.log("[Registry.registerDataObject] registering new data object URL",e),c={type:"create",from:i.registryURL,to:"domain://registry."+i._domain,body:{value:e,policy:"policy"}});try{i._messageBus.postMessageWithRetries(c,i._registrationRetries,function(t){200===t.body.code?s(e):a("error on register DataObject")})}catch(e){Ze.error(e),a(e)}setInterval(function(){var t={type:"update",from:i.registryURL,to:"domain://registry."+i._domain,body:{resource:e.url,value:{status:"live"},method:"refresh"}};i._messageBus.postMessage(t,function(e){})},e.expires/1.1/2*1e3)})}},{key:"registerHyperty",value:function(e,t){var n=this;return new Promise(function(r,o){var i,s=n.runtimeURL,a=n.expiresTime,c={user:e.user.email,descriptor:e.descriptorURL,url:e.hypertyURL,expires:a,resources:e.resources,dataSchemes:e.dataSchemes,runtime:s,status:"live"};e.p2pHandler&&(c.p2pHandler=e.p2pHandler,c.p2pRequester=e.p2pRequester),e.descriptor.configuration&&e.descriptor.configuration.expires&&(a=e.descriptor.configuration.expires),t?(i={type:"update",to:"domain://registry."+n._domain,from:n.registryURL,body:{resource:e.hypertyURL,value:{status:"live",user:e.user.email}}},e.p2pHandler&&(i.body.value.p2pHandler=e.p2pHandler,i.body.value.p2pRequester=e.p2pRequester)):i={type:"create",from:n.registryURL,to:"domain://registry."+n._domain,body:{value:c,policy:"policy"}};try{n._messageBus.postMessageWithRetries(i,n._registrationRetries,function(t){if(200===t.body.code){var s={url:e.hypertyURL};e.p2pHandler&&(s.p2pHandler=e.p2pHandler,s.p2pRequester=e.p2pRequester),r(s)}else{if(404!==t.body.code)throw new Error("Failed to register an Hyperty to domain: ",t);i={type:"create",from:n.registryURL,to:"domain://registry."+n._domain,body:{value:c,policy:"policy"}};try{n._messageBus.postMessageWithRetries(i,n._registrationRetries,function(t){if(200!==t.body.code)throw new Error("Failed to register an Hyperty: "+t);var n={url:e.hypertyURL};e.p2pHandler&&(n.p2pHandler=e.p2pHandler,n.p2pRequester=e.p2pRequester),r(n)})}catch(e){Ze.error(e),o(e)}}})}catch(e){Ze.error(e),o(e)}setInterval(function(){var t={type:"update",from:n.registryURL,to:"domain://registry."+n._domain,body:{resource:e.hypertyURL,value:{status:"live"},method:"refresh"}};n._messageBus.postMessage(t,function(e){})},a/1.1/2*1e3)})}}]),e}();function tt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var nt=de.getLogger("P2PConnectionResolve"),rt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._registry=t,this._remoteP2PEntities={}}return function(e,t,n){t&&tt(e.prototype,t)}(e,[{key:"checkP2P",value:function(e){if(!e.hasOwnProperty("to"))return Promise.reject("The p2p verification was failed");var t,n=e.to.split("://")[0],r=e.to.split("://")[1].split("/")[2];t=r?e.to.substring(0,e.to.indexOf("/"+r)):e.to;var o={};switch(e.body&&e.body.p2p&&(o.p2p=e.body.p2p),e.body&&e.body.p2pHandler&&e.body.p2pRequester&&(o.p2pHandler=e.body.p2pHandler,o.p2pRequester=e.body.p2pRequester,o.runtime=e.body.p2pHandler.split("/p2phandler/")[0]),n){case"runtime":return this.checkP2PRuntime(t,o);default:return this.checkP2PEntity(t,o)}}},{key:"checkP2PEntity",value:function(e,t){var n=this;return new Promise(function(r,o){var i=n._remoteP2PEntities[e];if(i)r(i);else if(t.runtime)r(t);else if(t.p2p){nt.log("[Registry - checkP2PEntity] - search in Domain Registry: ",e);var s={type:"read",from:n._registry.registryURL,to:"domain://registry."+n._registry._domain,body:{resource:e}};n._registry._messageBus.postMessage(s,function(e){if(nt.log("[Registry - checkP2PEntity] Domain Registry reply",e),"value"in e.body){var t=e.body.value;t.hasOwnProperty("p2pHandler")?r(t):o("[Registry checkP2PEntity] Hyperty found does not support P2P",e.body.value)}else o("[Registry checkP2PEntity] Hyperty with P2PHandler not found",e.body.code)})}else o("[Registry checkP2PEntity] No P2P Connection available for ",e)})}},{key:"checkP2PRuntime",value:function(e,t){var n=this;return new Promise(function(r,o){n._registry.p2pConnectionList[e]?r({runtime:e}):t.runtime?r(t):o("[Registry.P2PConnectionResolve.checkP2PRuntime] No P2P Connection found to ",e)})}},{key:"checkP2PHyperty",value:function(e,t){var n=this;return new Promise(function(r,o){var i;for(var s in n._registry.remoteHypertyList)if(i=n._registry.remoteHypertyList[s],nt.log("[Registry - checkP2PHyperty] - for each Hyperty: ",i),i.hypertyID===e)return void(i.hasOwnProperty("p2pHandler")?r(i):o("[Registry checkP2PHyperty] Hyperty found does not support P2P",i));if(!i&&t.runtime)r(t);else if(!i&&t.p2p){nt.log("[Registry - checkP2PHyperty] - search in Domain Registry: ",i);var a={type:"read",from:n._registry.registryURL,to:"domain://registry."+n._registry._domain,body:{resource:e}};n._registry._messageBus.postMessage(a,function(e){if(nt.log("[Registry - checkP2PHyperty] Domain Registry reply",e),"value"in e.body){var t=e.body.value;n._registry.remoteHypertyList.push(t),t.hasOwnProperty("p2pHandler")?r(t):o("[Registry checkP2PHyperty] Hyperty found does not support P2P",e.body.value)}else o("[Registry checkP2PHyperty] Hyperty with P2PHandler not found",e.body.code)})}else o("[Registry checkP2PHyperty] No P2P Connection available for ",e)})}},{key:"checkP2PDataObject",value:function(e,t){var n=this;return new Promise(function(r,o){var i=n._registry.remoteDataObjectList.filter(function(t){return n._registry.remoteDataObjectList[t].url===e});if(0!==i.length&&i[0].p2pRequester)r(i[0]);else if(0!==i.length)o("[Registry checkP2PDataObject] Data Object found does not support P2P",i[0]);else if(0===i.length&&t.runtime)r(t);else if(i.length&&t.p2p){var s={type:"read",from:n._registry.registryURL,to:"domain://registry."+n._registry._domain,body:{resource:e}};n._registry._messageBus.postMessage(s,function(e){if(nt.log("discover data object per url reply",e),"value"in e.body){var t=e.body.value;n._registry.remoteDataObjectList.push(t),t.p2pRequester?r(t):o("[Registry checkP2PDataObject] Data Object found does not support P2P",e.body.value)}else o("[Registry checkP2PDataObject] not found",e.body.code)})}else o("[Registry checkP2PDataObject] no P2P Connection found")})}},{key:"addRemoteP2PEntity",value:function(e,t){this._remoteP2PEntities[e]=t}},{key:"removeRemoteP2PEntity",value:function(e){delete this._remoteP2PEntities[e]}},{key:"reconnectP2PRequester",value:function(e){var t=this;return nt.log("[P2PConenctionResolve.reconnectP2PRequester] lets try to reconnect P2P Requester Stub: ",e),new Promise(function(n,r){var o=e.runtime,i={type:"execute",from:t._registry.registryURL,to:e.url,body:{method:"connect",params:[e.p2pHandler]}};t._registry.watchingYou.observe("p2pRequesterStub",function(e){if(nt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequesterStubs changed "+t._registry.p2pRequesterStub),e.keypath.split(".")[0]===o&&"status"===e.name)switch(e.newValue){case"live":nt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequester is live "+t._registry.p2pRequesterStub[o]),n(t._registry.p2pRequesterStub[o].url);break;case"failed":nt.log("[P2PConenctionResolve.reconnectP2PRequester] p2pRequester reconnect failed "+t._registry.p2pRequesterStub[o]),r("P2P Requester reconnect failed")}}),t._registry._messageBus.postMessage(i,function(e){nt.log("[P2PConenctionResolve.reconnectP2PRequester] reconnect request reply",e)})})}}]),e}();function ot(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n(19);var it=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._watching={},this._observers=[]}return function(e,t,n){t&&ot(e.prototype,t)}(e,[{key:"watch",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._watching[e]=r?Object.deepObserve(t,function(t){t.every(function(t){n._fireEvent(e,t)})}):Object.observe(t,function(t){t.every(function(t){n._fireEvent(e,t)})}),this._watching[e]}},{key:"observe",value:function(e,t){this._observers.push({key:e,callback:t})}},{key:"_fireEvent",value:function(e,t){this._observers.filter(function(t){return t.key===e}).forEach(function(e){e.callback(t)})}}]),e}();function st(e){return(st="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function at(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ct=de.getLogger("Registry"),ut="created",lt="live",ft="deploying",dt="in-progress",ht="disconnected",yt="deployment-failed",pt=function(){function e(t,n,r,o,i,s,a,c){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("runtimeURL is missing.");if(!s)throw new Error("storageManager is missing.");this.registryURL=t+"/registry/",this.appSandbox=n,this.runtimeURL=t,this.p2pHandlerURL=a,this.runtimeCatalogue=o,this.remoteRegistry=c,this.idModule=r,this.storageManager=s,this.runtimeCapabilities=i,this.identifier=Object(ue.n)(),this.hypertiesListToRemove={},this.hypertiesList=[],this.remoteHypertyList=[],this.remoteDataObjectList=[],this.idpLegacyProxyList={},this.watchingYou=new it,this.p2pHandlerStub={},this.p2pRequesterStub=this.watchingYou.watch("p2pRequesterStub",{},!0),this.p2pConnectionList=this.watchingYou.watch("p2pConnectionList",{},!0),this.p2pHandlerAssociation={},this.protostubsList=this.watchingYou.watch("protostubsList",{},!0),this.idpProxyList=this.watchingYou.watch("idpProxyList",{},!0),this.dataObjectList={},this.subscribedDataObjectList={},this.sandboxesList={sandbox:{},appSandbox:{}},this.pepList={},this.registries={},this._domain=Object(ue.k)(this.registryURL).domain,this.sandboxesList.appSandbox[t]=n;var u=new rt(this);this._p2pConnectionResolve=u,this._hypertyUrls={},this._dataObjectUrls={}}return function(e,t,n){t&&at(e.prototype,t)}(e,[{key:"loadRegistry",value:function(){var e=this;return new Promise(function(t){e.storageManager.get("registry:HypertyURLs").then(function(n){n&&(e._hypertyUrls=n),e.storageManager.get("registry:DataObjectURLs").then(function(n){n&&(e._dataObjectUrls=n),t()})})})}},{key:"_getIdentityAssociated",value:function(e,t){for(var n in this.hypertiesList){var r=this.hypertiesList[n];if(r._hypertyURL===t)switch(e){case"username":return r._user.username;case"cn":return r._user.cn;case"locale":return r._user.locale;case"avatar":return r._user.avatar;case"userURL":return r._user.userURL;case".":return r._user;default:return""}}return""}},{key:"getAppSandbox",value:function(){return this.appSandbox}},{key:"getHypertyOwner",value:function(e){for(var t in this.hypertiesList){var n=this.hypertiesList[t];if(n.hypertyURL===e)return n.user.userURL}}},{key:"getDataObjectReporter",value:function(e){var t=Object(ue.B)(e);for(var n in this.dataObjectList){var r=this.dataObjectList[n];if(r.url===t)return r.reporter}return null}},{key:"getHypertyName",value:function(e){var t,n="hyperty"===Object(ue.k)(e).type?e:this.getReporterURLSynchonous(e);for(var r in this.hypertiesList){var o=this.hypertiesList[r];if(o.hypertyURL===n){t=o.objectName;break}}return t}},{key:"getReporterURL",value:function(e){var t=this;return new Promise(function(n,r){var o=t.dataObjectList[e];o?n(o.reporter):r("No reporter was found")})}},{key:"getReporterURLSynchonous",value:function(e){var t=this.dataObjectList[e];return t?t.reporter:void 0}},{key:"getDataObjectSubscriberHyperty",value:function(e){return this.subscribedDataObjectList[e]}},{key:"registerSubscribedDataObject",value:function(e,t){void 0===this.subscribedDataObjectList[e]&&(this.subscribedDataObjectList[e]=t)}},{key:"getPreAuthSubscribers",value:function(e){var t=this.dataObjectList[e],n=[];return t&&(n=t.authorise),n}},{key:"unregisterAllHyperties",value:function(){var e=this,t=[];return new Promise(function(n,r){for(var o in e.hypertiesList){var i=e.hypertiesList[o],s=e.unregisterHypertyInstance(i.hypertyURL);t.push(s)}Promise.all(t).then(function(){n("successfully unregistered all hyperties")},function(e){r(e)})})}},{key:"unregisterHypertyInstance",value:function(e){var t=this,n={type:"execute",from:t.registryURL,to:e,body:{method:"close"}};t._messageBus.postMessage(n,function(n){ct.log("[Registry.unregisterHypertyInstance] Close Reply",n),t._domainRegistration.unregisterHyperty(e)})}},{key:"unregisterDataObject",value:function(e){this._domainRegistration.unregisterDataObject(e)}},{key:"registerSubscriber",value:function(e,t){var n=this.dataObjectList[e];n&&(n.subscribers||(n.subscribers=[]),n.subscribers.push(t),this.dataObjectList[e]=n)}},{key:"getDataObjectSubscribers",value:function(e){var t=this.dataObjectList[e];if(t)return t.subscribers;throw"No dataObject was found"}},{key:"registerDataObject",value:function(e){var t=this,n=Object(ue.i)(e);return new Promise(function(r,o){t.dataObjectList[e.url]=e,t._dataObjectUrls[e.name+e.schema+e.resources+e.reporter]=e.url,t.storageManager.set("registry:DataObjectURLs",0,t._dataObjectUrls).then(function(){t.isInterworkingProtoStub(n.reporter)&&(n.interworking=!0);var o=!0;n.hasOwnProperty("domain_registration")&&(o=n.domain_registration),o?t._domainRegistration.registerDataObject(n,e.resume,t.p2pHandlerStub).then(function(e){r(e)}):r(n)}).catch(function(e){ct.error("[Registry registerDataObject] Error: ",e),o(e)})})}},{key:"_getResourcesAndSchemes",value:function(e){var t=this;return new Promise(function(n){var r;"string"==typeof e.hypertyType?(r=[]).push(e.hypertyType):r=e.hypertyType;var o=e.objectName,i=e.dataObjects,s=[];for(var a in i)s.push(t.runtimeCatalogue.getDataSchemaDescriptor(i[a]));Promise.all(s).then(function(e){var t=[];for(var i in e){var s=e[i];t.push(s.sourcePackage.sourceCode.properties.scheme)}n({resources:r,dataSchema:t,name:o})})})}},{key:"checkRegisteredURLs",value:function(e,t){var n=this;return new Promise(function(r){var o=e.reporter?"registry:DataObjectURLs":"registry:HypertyURLs";"string"==typeof t&&(o=t&&"hyperty"!==Object(ue.k)(t).type?"registry:DataObjectURLs":"registry:HypertyURLs"),n.storageManager.get(o).then(function(i){if(i||(i={}),"string"==typeof t){ct.info("[Registry - checkRegisteredURLs] - look for "+t+" on ",i);var s=Object.keys(i).map(function(e){var n=i[e].indexOf(t);return i[e][n]});return ct.info("[Registry - checkRegisteredURLs] - found "+s.length+" results on ",s),1===s.length?r(s):r(void 0)}if("registry:HypertyURLs"!==o){var a=e.name+e.schema+e.resources+e.reporter;if(i[a]){if("string"==typeof i[a]){var c=[];return c.push(i[a]),r(c)}return r(i[a])}return r(void 0)}n._getResourcesAndSchemes(e).then(function(e){return i[e.resources+e.dataSchema+e.name]?r(i[e.resources+e.dataSchema+e.name]):r(void 0)})})})}},{key:"registerHyperty",value:function(e,t,n,r,o){var i,s=this;return new Promise(function(a,c){s.idModule.getIdentityAssertion(o).then(function(o){var u=o.userProfile;void 0===s._messageBus?c("[Registry registerHyperty] MessageBus is undefined"):s._getResourcesAndSchemes(n).then(function(o){i=o,s._hypertyUrls[i.resources+i.dataSchema+i.name]=r.address,s.storageManager.set("registry:HypertyURLs",0,s._hypertyUrls).then(function(){var o,l;"app"===e.type?s.sandboxesList.appSandbox[r.address[0]]=e:"normal"===e.type?s.sandboxesList.sandbox[r.address[0]]=e:c("Wrong SandboxType"),0!==Object.keys(s.p2pHandlerStub).length&&(o=s.p2pHandlerStub[s.runtimeURL].url,l=He.runtimeDescriptor.p2pRequesterStub);var f=new Qe(s.identifier,s.registryURL,t,n,r.address[0],u,"guid",s.runtimeURL,"ctx",o,l,i.dataSchema,i.resources);s.hypertiesList.push(f);var d=!0;n.hasOwnProperty("_configuration")&&n.configuration.hasOwnProperty("domain_registration")&&(d=n.configuration.domain_registration),d?s._domainRegistration.registerHyperty(f,r.newAddress).then(function(e){a(e)}):a({url:f.hypertyURL})}).catch(function(e){c(e)})})},function(e){c("[Registry registerHyperty] ",e)})})}},{key:"unregisterHyperty",value:function(e){var t=this;return new Promise(function(n,r){var o=!1,i=0;for(i=0;i<t.hypertiesList.length;i++){var s=t.hypertiesList[i];if(void 0!==s&&s.hypertyURL===e){o=!0;break}}!1===o?r("Hyperty not found"):(delete t.hypertiesList[i],n("Hyperty successfully deleted"))})}},{key:"discoverProtostub",value:function(e){if(!e)throw new Error("Parameter url needed");var t=Object(ue.k)(e).domain;if(this.protostubsList.hasOwnProperty(t)&&this.protostubsList[t].status===lt)return this.protostubsList[t];throw this.protostubsList[t]={status:ft},new Error("[Registry - discoverProtoStub ] Message Node Protostub Not Found. Creating one")}},{key:"discoverP2PStub",value:function(e){if(e){if(this.p2pRequesterStub.hasOwnProperty(e)&&this.p2pRequesterStub[e].status===lt)return this.p2pRequesterStub[e];throw this.p2pRequesterStub[e]={status:ut},new Error("[Registry - discoverP2PStub ] P2P Requester Stub Not Found. Creating one")}if(this.p2pHandlerStub.hasOwnProperty(this.runtimeURL))return this.p2pHandlerStub[this.runtimeURL];throw this.p2pHandlerStub[this.runtimeURL]={status:ut},new Error("[Registry - discoverP2PStub ] P2P Handler Stub Not Found.")}},{key:"registerStub",value:function(e,t,n,r,o){var i=this,s=o;return new Promise(function(a,c){var u,l;if(void 0===i._messageBus&&c("MessageBus not found on registerStub"),ct.info("[Registry - registerStub] - stubID ",t),n)if(n.hasOwnProperty("isHandlerStub")&&n.isHandlerStub)u=i.p2pHandlerURL,i.p2pHandlerStub[t]={url:u,status:ut},i.p2pHandlerAssociation[i.runtimeURL]=[],i.sandboxesList.sandbox[u]=e,ct.info("[Registry - registerStub - P2PHandlerStub] - ",t," - ",u),a(i.p2pHandlerStub[t]);else{l=n.p2pRequesterStub,u="runtime://"+Object(ue.k)(n.remoteRuntimeURL).domain+"/p2prequester/"+Object(ue.n)(),ct.info("[Registry - registerStub - P2PRequesterStub] - ",l," - ",u),i.p2pHandlerAssociation[i.runtimeURL].push(u),i.p2pRequesterStub[t]={url:u,status:ut},i.sandboxesList.sandbox[u]=e;var f={type:"subscribe",from:i.registryURL,to:"domain://msg-node."+i._domain+"/sm",body:{subscribe:[u],source:i.registryURL}};i._messageBus.postMessage(f,function(e){}),a(i.p2pRequesterStub[t])}else console.log("[Registry - registerStub - Normal Stub] descriptor",o),u="string"===!st(o)&&o.hasOwnProperty("_interworking")&&o._interworking?"runtime://"+t+"/protostub/scheme1":"runtime://"+t+"/protostub/"+Object(ue.n)(),ct.info("[Registry - registerStub - Normal Stub] - ",t),i.protostubsList[t]={url:u,status:ft},r&&(i.protostubsList[t].descriptorURL=r),s&&s.interworking&&(i.protostubsList[t].interworking=s.interworking),i.sandboxesList.sandbox[u]=e,a(i.protostubsList[t]);i._messageBus.addListener(u+"/status",function(e){i._onProtostubStatusEvent(e)})})}},{key:"_onProtostubStatusEvent",value:function(e){var t=this,n=e.from;if(e.to.includes("/status")){var r=e.from;if(e.from=t.runtimeURL,e.to=t.runtimeURL+"/status",e.body.resource=r,t._messageBus.postMessage(e),n.includes("/protostub/"))Object.keys(t.protostubsList).filter(function(e){return t.protostubsList[e].url===n}).map(function(n){t.protostubsList[n].status=e.body.value});else if(e.body.resource){var o=e.body.resource;if(t.p2pConnectionList[o])t.p2pConnectionList[o].status=e.body.value,t.p2pConnectionList[o].url=n;else{var i={status:e.body.value,url:n};t.p2pConnectionList[o]=i}n.includes("/p2prequester/")?t.p2pRequesterStub[o].status=e.body.value:"disconnected"===e.body.value&&delete t.p2pConnectionList[o]}else{if(n.includes("/p2prequester/"))return void ct.error("[Registry onProtostubStatusEvent] resource missing: ",e);t.p2pHandlerStub[t.runtimeURL].status=e.body.value}}else ct.error("[Registry onProtostubStatusEvent] Not Status Event: ",e)}},{key:"unregisterStub",value:function(e){var t=this;return new Promise(function(n,r){t.protostubsList.hasOwnProperty(e)?(delete t.protostubsList[e],n("ProtostubURL removed")):r("Error on unregisterStub: Hyperty not found")})}},{key:"registerIdpProxy",value:function(e,t){var n=this;return new Promise(function(r,o){var i;void 0===n._messageBus&&o("MessageBus not found on registerStub"),i="domain-idp://"+t+"/stub/"+Object(ue.n)(),n.idpProxyList[t]={url:i,status:ft},n.sandboxesList.sandbox[i]=e,r(i),n._messageBus.addListener(i+"/status",function(e){n._onIdpProxyStatusEvent(e)})})}},{key:"_onIdpProxyStatusEvent",value:function(e){var t=this,n=e.from;e.to.includes("/status")?Object.keys(t.idpProxyList).filter(function(e){return t.idpProxyList[e].url===n}).map(function(n){t.idpProxyList[n].status=e.body.value}):ct.error("[Registry onIdpProxyStatusEvent] Not Status Event: ",e)}},{key:"discoverIdpProxy",value:function(e){if(!e)throw new Error("Parameter url needed");var t=Object(ue.k)(e).domain;if(this.idpProxyList.hasOwnProperty(t)&&this.idpProxyList[t].status===lt)return this.idpProxyList[t];throw this.idpProxyList[t]={status:dt},new Error("[Registry - discoverIdpProxy ] Idp Proxy Not Found. Creating one")}},{key:"registerPEP",value:function(e,t){var n=this;return new Promise(function(r){n.pepList[t]=e,r("PEP registered with success")})}},{key:"unregisterPEP",value:function(e){var t=this;return new Promise(function(n,r){void 0===t.pepList[e]?r("Pep Not found."):n("PEP successfully removed.")})}},{key:"getSandbox",value:function(e,t){if(!e)throw new Error("Parameter url needed");var n=this;return new Promise(function(o,i){var s,a;if(!(s=n.sandboxesList.appSandbox[e])&&!(s=n.sandboxesList.sandbox[e]))for(var c in a=e.includes("://")?Object(ue.k)(e).domain:e,n.sandboxesList.sandbox)if(c.includes(a)&&n.sandboxesList.sandbox[c].matches(t)&&"break"===function(){var e=n.sandboxesList.sandbox[c];return Object.keys(t).filter(function(t){return"browser"===t&&e.type===r.a.NORMAL||"windowSanbox"===t&&e.type===r.a.WINDOW}).length>0&&(s=e),"break"}())break;s?o(s):i("no sandbox found for: "+e)})}},{key:"resolveNormalStub",value:function(e){var t=this;return new Promise(function(n,r){var o=Object(ue.k)(e),i=o.domain,s=o.type;(e.includes(t.runtimeURL)||e.includes("://sandbox/"))&&(ct.error("[Registry - resolve] URL to be resolved should have listeners ",e),r("[Registry - resolve] URL to be resolved should have listeners ",e)),e.includes("global://registry")?i=t._domain:i.indexOf("msg-node.")&&i.indexOf("registry.")||(i=i.substring(i.indexOf(".")+1)),t.isLegacy(e).then(function(o){var a;o&&"domain-idp"!==s&&(i=s+"."+Object(ue.q)(e)),ct.info("[Registry.resolve] domainUrl:",i),a="domain-idp"===s?!!t.idpProxyList.hasOwnProperty(i)&&t.idpProxyList[i]:!!t.protostubsList.hasOwnProperty(i)&&t.protostubsList[i],ct.info("[Registry.resolve] registred:",a),a&&a.hasOwnProperty("status")&&("deployed"===a.status||a.status===ut||a.status===lt||a.status===ht)?(ct.info("[Registry.resolve] Resolved: ",a.url,a.status),n(a.url)):"domain-idp"===s?(t.watchingYou.observe("idpProxyList",function(e){var r=e.keypath;r.includes("status")&&(r=r.replace(".status","")),r===i&&"status"===e.name&&e.newValue===ut&&n(t.idpProxyList[i].url)}),a&&a.status!==yt||(ct.info("[Registry.resolveNormalStub] deploy new IDPProxy: ",i),t.loader.loadIdpProxy(i).then(function(){ct.info("[Registry.resolveNormalStub] IdP Proxy deployed: ",t.idpProxyList[i])}).catch(function(e){ct.error("[Registry.resolve] Error resolving Load IDPProxy: ",e),t.idpProxyList[i].status="deployment-failed",r(e)}))):(t.watchingYou.observe("protostubsList",function(e){var r=e.keypath;r.includes("status")&&(r=r.replace(".status","")),r===i&&"status"===e.name&&e.newValue===ut&&n(t.protostubsList[i].url)}),a&&a.status!==yt||(ct.info("[Registry.resolve] trigger new ProtocolStub: ",i),t.loader.loadStub(i).then(function(){}).catch(function(e){ct.error("[Registry.resolveNormalStub] Error resolving Load ProtocolStub: ",e),r(e)})))}).catch(function(e){ct.error("[Registry.resolve] Error resolving islegacy: ",e),r(e)})})}},{key:"resolve",value:function(e){ct.info("[Registry - Resolve] -  ",e);var t=this;return new Promise(function(n,r){var o=e.to?e.to:e,i=!(!e.body||!e.body.p2p)&&e.body.p2p;!t.p2pHandlerStub[t.runtimeURL]||Object(ue.r)(o)||o.includes(t.runtimeURL)||o.includes("/p2phandler/")||o.includes("/p2prequester/")?(ct.info("[Registry - resolve] - Resolve normal stub: ",t.p2pHandlerStub,t.runtimeURL,Object(ue.r)(o),i,o),t.resolveNormalStub(o).then(function(e){n(e)})):(ct.info("[Registry - resolve] - checkP2P: ",i,o,t._p2pConnectionResolve),t._p2pConnectionResolve.checkP2P(e).then(function(r){var s=t.p2pConnectionList[r.runtime];switch(s||(s=r,t.p2pConnectionList[r.runtime]=s),s.status){case lt:e.body.peer=r.runtime,n(s.url,e);break;case ut:case dt:t.resolveNormalStub(o).then(function(e){n(e)});break;case ht:ct.info("[Registry - Resolve] - p2pConnection is disconnected lets try to reconnect"),t._p2pConnectionResolve.reconnectP2PRequester(s).then(function(e){n(e)},function(e){ct.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(function(e){n(e)})});break;default:ct.info("[Registry - resolve] - P2P: ",i),i?t._setupP2PRequester(r).then(function(e){n(e)},function(e){ct.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(function(e){n(e)})}):t.resolveNormalStub(o).then(function(e){n(e)})}},function(e){ct.info("[Registry - Resolve] - Reason: ",e),t.resolveNormalStub(o).then(function(e){n(e)})}))})}},{key:"_setupP2PRequester",value:function(e){var t=this;return ct.log("[Registry._setupP2PConnection] loadStub with p2pRequester: ",e),new Promise(function(n,r){var o=e.runtime,i={remoteRuntimeURL:o,p2pHandler:e.p2pHandler,p2pRequesterStub:!0};t.watchingYou.observe("p2pRequesterStub",function(e){ct.log("[Registry._setupP2PConnection] p2pRequesterStubs changed "+t.p2pRequesterStub),e.keypath.split(".")[0]===o&&"status"===e.name&&e.newValue===lt&&(ct.log("[Registry._setupP2PConnection] p2pRequester is live "+t.p2pRequesterStub[o]),n(t.p2pRequesterStub[o].url))}),t.loader.loadStub(e.p2pRequester,i).then(function(){ct.log("[Registry._setupP2PConnection] p2pRequester deployed: ",t.p2pRequesterStub[o])}).catch(function(e){r(e)})})}},{key:"isLegacy",value:function(e){var t=this;return new Promise(function(n,r){if(e===t._domain)return n(!1);ct.log("[Registry] [Registry.Registry.isLegacy] ",e);var o=Object(ue.k)(e);if(-1!==["hyperty-runtime","domain","global","hyperty"].indexOf(o.type)||o.domain===t._domain)return n(!1);if(e.split("@").length>1){var i=o.domain;if(t.idpLegacyProxyList.hasOwnProperty(i)){var s=t.idpLegacyProxyList[i];return s.interworking?n(s.interworking):n(!1)}t._loader.descriptors.getIdpProxyDescriptor(i).then(function(e){e.interworking?(t.idpLegacyProxyList[i]=e,n(e.interworking)):n(!1)}).catch(function(e){ct.warn("problem loading idp proxy descriptor for domain:",i," because ",e),r(e)})}else n(t.isInterworkingProtoStub(e))})}},{key:"isLocal",value:function(e){var t=e.split("://")[0];if(-1!==["hyperty-runtime","runtime"].indexOf(t))return e.includes(this.runtimeURL);if(-1!==["hyperty"].indexOf(t)){for(var n in this.hypertiesList)if(this.hypertiesList[n].hypertyURL===e)return!0;return!1}e.includes("/subscription")&&(e=e.substring(0,e.indexOf("/subscription")));var r=this.dataObjectList[e];return!(!r||r.interworking&&r.interworking)}},{key:"isInterworkingProtoStub",value:function(e){var t=this;return"boolean"!=typeof e&&!!e.includes("/protostub/")&&Object.keys(t.protostubsList).filter(function(n){return t.protostubsList[n].url===e}).map(function(e){return!!t.protostubsList[e].hasOwnProperty("interworking")&&t.protostubsList[e].interworking})[0]}},{key:"loader",set:function(e){this._loader=e},get:function(){return this._loader}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){var t=this;t._messageBus=e,t._messageBus.addListener(t.registryURL,function(e){if(Object(ue.t)(e.from),e.body.hasOwnProperty("criteria"),e.body.hasOwnProperty("resource")&&"."!==e.body.resource&&(Object(ue.v)(e.body.resource),Object(ue.w)(e.body.resource),Object(ue.t)(e.body.resource)),e.type,e.body.hasOwnProperty("value")&&(e.body.value.hasOwnProperty("name"),e.body.value.hasOwnProperty("user")),"response"!==e.type){var n=t._getIdentityAssociated(e.body.resource,e.body.criteria),r={id:e.id,type:"response",to:e.from,from:e.to,body:{resource:n}};r.body.code=n?200:404,t._messageBus.postMessage(r)}else ct.error("[Register listener] skipping ",e)});var n=qe.instance;t.addressAllocation=n,t._domainRegistration=new et(t.runtimeURL,t.registryURL,t._domain,e)}}]),e}(),vt={storageSchemas:{capabilities:{capabilities:"key,version,value"},subscriptions:{subscriptions:"key,version,value"},runtime:{"runtime:URL":"key,version,value","p2pHandler:URL":"key,version,value"},registry:{"registry:DataObjectURLs":"key,version,value","registry:HypertyURLs":"key,version,value"},cryptoManager:{userAsymmetricKey:"key,version,value",dataObjectSessionKeys:"key,version,value"},identity:{accessTokens:"key,version,value",identities:"userURL, userProfile.email, userProfile.userURL, userProfile.name"},runtimeCatalogue:{runtimeCatalogue:"&cguid, accessControlPolicy, constraints, dataObjects, hypertyType, objectName, sourcePackage, version"},policy:{"rethink:activePolicy":"key,version,value","rethink:groups":"key,version,value","rethink:userPolicies":"key,version,value","rethink:spPolicies":"key,version,value"},syncherManager:{"syncherManager:ObjectURLs":"key,version,value",remotes:"key,version,value"},hypertyResources:{hypertyResources:"&resourceURL, name, contentUrl, content, created, reporter, resourceType"}},runtimeURLS:{registry:{prefix:"hyperty-runtime://",suffix:"registry"},identityModule:{prefix:"hyperty-runtime://",suffix:"/idm"},runtimeUA:{prefix:"hyperty-runtime://",suffix:"/ua"},catalogue:{prefix:"hyperty-runtime://",suffix:"/catalogue"},graphConnector:{prefix:"hyperty-runtime://",suffix:"/graph"},syncManager:{prefix:"hyperty-runtime://",suffix:"/sm"}},catalogueURLs:{protocolstub:{prefix:"hyperty-catalogue://catalogue.",suffix:"/.well-known/protocolstub/",fallback:"hyperty-catalogue://catalogue.%domain%/.well-known/protocolstub/"},idpProxy:{prefix:"hyperty-catalogue://catalogue.",suffix:"/.well-known/idp-proxy/",fallback:"hyperty-catalogue://catalogue.%domain%/.well-known/idp-proxy/"}},msgNodeURL:{prefix:"domain://msg-node.",suffix:"",hypertyAddressAllocation:"/hyperty-address-allocation",objectAddressAllocation:"/object-address-allocation",subscriptionManagement:"/sm"},domainRegistryURL:{prefix:"domain://registry.",suffix:""},globalRegistryURL:"global://registry.",remoteStorage:"https://hysmart.rethink.ptinovacao.pt/backup/"};function bt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function gt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function mt(e,t,n){return t&&gt(e.prototype,t),n&&gt(e,n),e}var _t=de.getLogger("IdentityModule"),wt=function(){function e(t,n){bt(this,e),this._watchingYou=new it,this._storageManager=n,this._guid,this._type=t,this._identities={},this._accessTokens=this.watchingYou.watch("accessTokens",{},!0)}return mt(e,[{key:"reset",value:function(){this._identities={},console.log(this),this.currentIdentity=void 0,this.defaultIdentity=void 0}},{key:"getIdentity",value:function(e){return Object.assign({},this._identities[e])}},{key:"loadIdentities",value:function(){var e=this;return new Promise(function(t){e._storageManager.get(null,null,"identities").then(function(n){_t.info("[Identities.Load Identities] identities: ",n),n&&(e._identities=n,e.identifiers.forEach(function(t){var n=Object(ue.C)(),r=e._identities[t].expires;e.defaultIdentity=t,parseInt(r)>n&&(e.defaultIdentity.expires=parseInt(r),e.currentIdentity=t)})),t()})})}},{key:"loadAccessTokens",value:function(){var e=this;return new Promise(function(t){e._storageManager.get("accessTokens").then(function(n){n&&(e._accessTokens=n),t()})})}},{key:"addIdentity",value:function(e){var t=this,n=this;return new Promise(function(r,o){if(n._isValid(e)){var i=e.identifiers[0];Object.assign(t._identities[i],e),t._storeIdentity(e).then(function(){t._identities[i].status="created",r()})}else o("[Identities.addIdentity] invalid IdAssertion")})}},{key:"addAssertion",value:function(e){var t=this,n=this;return new Promise(function(r,o){if(n._isValid(e)){e.userProfile.guid=n._guid;var i=e.userProfile.userURL;n.identities[i]?n.identities[i]=e:n._identities[i]=e,n._store().then(function(){t._identities[i].status="created",0==n.defaultIdentity&&(n.defaultIdentity=i),r(e)})}else o("[Identities.addAssertion] invalid IdAssertion: ",e)})}},{key:"removeIdentity",value:function(e){var t=this;return new Promise(function(n,r){delete t.identities[e],t._store().then(function(){n()})})}},{key:"addAccessToken",value:function(e){var t=this;return _t.info("[Identities.addAccessToken] ",e),new Promise(function(n,r){t._isValidAccessToken(e)?(t._accessTokens[e.domain]=e,t._storeAccessTokens().then(function(){t._accessTokens[e.domain].status="created",n(e)})):r("[Identities.addIdentity] invalid AccessToken: ",e)})}},{key:"setAccessTokenInProgress",value:function(e){this._accessTokens[e]?this._accessTokens[e].status="in-progress":this._accessTokens[e]={status:"in-progress"}}},{key:"getAccessToken",value:function(e,t){var n=this._accessTokens[e];return n?t.every(function(e){return-1!=n.resources.indexOf(e)})?this._accessTokens[e]:new Error("[Identities.getAccessToken] Not found for ",e):void 0}},{key:"removeAccessToken",value:function(e,t){var n=this,r=this;return new Promise(function(o){var i=n._accessTokens[e];i&&t.every(function(e){return-1!=i.resources.indexOf(e)})?(delete n._accessTokens[e],r._storeAccessTokens().then(function(){o()})):o()})}},{key:"updateAssertion",value:function(e){var t=this;return new Promise(function(n){var r=e.userProfile.userURL;if(!t.identities[r])return reject("[Identities.updateAssertion] Identity not found for ",r);t.identities[r]=e,t._store().then(function(){n()})})}},{key:"updateAccessToken",value:function(e){var t=this;return _t.info("[Identities.updateAccessToken] ",e),new Promise(function(n,r){t._isValidAccessToken(e)?(t._accessTokens[e.domain].expires=e.expires,t._accessTokens[e.domain].accessToken=e.accessToken,t._storeAccessTokens().then(function(){t._accessTokens[e.domain].status="created",n(e)})):r("[Identities.updateAccessToken] invalid AccessToken: ",e)})}},{key:"addIdAssertion",value:function(e,t,n,r){var o=new Ot(t,n,r);this.idAssertionList.push(o)}},{key:"_isValid",value:function(e){if(!e.hasOwnProperty("assertion"))return!1;var t=e.assertion.split(".");try{t[1]?Object(ue.g)(t[1]):Object(ue.g)(e.assertion)}catch(e){return!1}return!0}},{key:"_isValidAccessToken",value:function(e){return!!(e.hasOwnProperty("accessToken")&&e.hasOwnProperty("domain")&&e.hasOwnProperty("resources")&&Array.isArray(e.resources)&&e.hasOwnProperty("expires")&&Number.isInteger(e.expires)&&e.hasOwnProperty("input"))}},{key:"_store",value:function(){var e=this,t=this;return new Promise(function(n,r){var o=Object.keys(e._identities).map(function(n){return t._storageManager.set(n,0,e._identities[n],"identities")});Promise.all(o).then(function(){n()}).catch(function(e){r("On _sendReporterSessionKey from method storeIdentity error: "+e)})})}},{key:"_storeAccessTokens",value:function(){var e=this;return new Promise(function(t,n){var r=Object(ue.i)(e._accessTokens);e._storageManager.set("accessTokens",0,r).then(function(){t()}).catch(function(e){n("On _sendReporterSessionKey from method storeIdentity error: "+e)})})}},{key:"identities",get:function(){return this._identities}},{key:"accessTokens",get:function(){return this._accessTokens}},{key:"watchingYou",get:function(){return this._watchingYou}},{key:"guid",set:function(e){this._guid=e},get:function(){return this._guid}},{key:"defaultIdentity",set:function(e){if(!this.identities[e])throw new Error("[Identities.set defaultIdentity ] Error: identity does not exist here: ",e);this._defaultIdentity=e},get:function(){return!!this._defaultIdentity&&Object.assign({},this.identities[this._defaultIdentity])}},{key:"currentIdentity",set:function(e){if(!this.identities[e])throw e;this._currentIdentity=e},get:function(){return Object.assign({},this.identities[this._currentIdentity])}},{key:"identifiers",get:function(){return Object.keys(this._identities)}}]),e}(),Ot=function(){function e(t,n,r){bt(this,e),this._assertion=t,this._idp=n,this._userProfile=r}return mt(e,[{key:"assertion",get:function(){return this._assertion}},{key:"idp",get:function(){return this._idp}},{key:"userProfile",get:function(){return this._userProfile}}]),e}(),kt=wt,Rt=de.getLogger("IdentityModule"),Pt=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Rt.log("FakeGUI_deployed");var r=this;r._url=t,r._waitTime=1e4,r._messageBus=n,r._messageBus.addListener(r._url,function(e){if(e.hasOwnProperty("type")&&"create"===e.type&&e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("identities")&&e.body.value.hasOwnProperty("idps")){var t,n=e.body.value.identities,o=e.body.value.idps;t=void 0!==n[0]?{type:"identity",value:n[0],code:200}:{type:"idp",value:o[2].domain,code:200};var i={id:e.id,type:"response",to:e.from,from:e.to,body:t};"wait"===e.body.value?setTimeout(function(){r._messageBus.postMessage(i)},r._waitTime):r._messageBus.postMessage(i)}else Rt.log("Ignoring messages not intended to FakeGUI.",e)})};function St(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var jt=de.getLogger("IdentityModule"),Et=function(){function e(t,n,r,o,i,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("runtimeURL is missing.");if(!r)throw new Error("storageManager is missing");if(!i)throw new Error("cryptoManager is missing");if(!s)throw new Error("runtimeCatalogue is missing");this._runtimeURL=t,this._runtimeCatalogue=s,this.dataObjectsStorage=o,this._idmURL=this._runtimeURL+"/idm",this._guiURL=this._runtimeURL+"/identity-gui",this.runtimeCapabilities=n,this._domain=Object(ue.k)(this._runtimeURL).domain,this._identities=new kt("human",r),this._crypto=i,this.dataObjectsIdentity={},this._listOfIdps=[],this.guiDeployed=!1}return function(e,t,n){t&&St(e.prototype,t)}(e,[{key:"getIdentity",value:function(e){return this.identities.getIdentity(e)}},{key:"getIdentitiesToChoose",value:function(){var e=this;return new Promise(function(t){var n=vt.catalogueURLs.idpProxy.prefix+e._domain+vt.catalogueURLs.idpProxy.suffix;Promise.all([e.runtimeCapabilities.isAvailable("browser"),e.runtimeCapabilities.isAvailable("node")]).then(function(r){var o=r[0],i=r[1],s={constraints:{}};s.constraints.node=i,s.constraints.browser=o,e._runtimeCatalogue.getTypeList(n,s).then(function(n){var r=n.map(function(e){return{domain:e,type:"idToken"}});return jt.info("[IdentityModule.getIdentityAssertion:getIdentitiesToChoose]",n,r),e._listOfIdps=r,t({defaultIdentity:e.identities.defaultIdentity,identities:e.identities.identities,idps:r})})})})}},{key:"init",value:function(e){var t=this;return new Promise(function(n){t._identities.loadIdentities().then(function(){e?(t.identities.guid=e,t._identities.loadAccessTokens().then(function(){n()})):t._crypto.getMyPublicKey().then(function(r){t._crypto.crypto._sha256(Object(ue.E)(r)).then(function(r){e="user-guid://"+r,t.identities.guid=e,t._identities.loadAccessTokens().then(function(){n()})}).catch(function(e){console.log("[IdentityModule] error",e)})})})})}},{key:"getIdentityAssertion",value:function(e){jt.log("[IdentityModule.getIdentityAssertion:identityBundle]",e);var t=this;return new Promise(function(n,r){t.runtimeCapabilities.isAvailable("browser").then(function(o){if(jt.log("runtime browser identity acquisition",o),o)if(e&&e.hasOwnProperty("idp")){var i=e.idp,s=e.hasOwnProperty("origin")?e.origin:"origin",a=e.hasOwnProperty("idHint")?e.idHint:"";if(t.identities.defaultIdentity){var c=t.identities.defaultIdentity;if(c.expires>Object(ue.C)())return n(c);c.hasOwnProperty("refresh")?(jt.log("[Identity.IdentityModule.getIdentityAssertion] refreshing assertion: ",c),t._refreshIdAssertion().then(function(e){return jt.log("[IdentityModule.getIdentityAssertion] refreshed assertion.",e),n(e)},function(e){jt.error("[IdentityModule.getIdentityAssertion] error on refresIdAssertion: ",e," Asking for a new IdAssertion."),t._getIdAssertionForDomain(s,i,a).then(function(e){n(e)},function(e){r(e)})})):t._getIdAssertionForDomain(s,i,a).then(function(e){n(e)},function(e){r(e)})}else t._getIdAssertionForDomain(s,i,a).then(function(e){n(e)},function(e){r(e)})}else if(t.identities.defaultIdentity){var u=t.identities.defaultIdentity;if(u.expires>Object(ue.C)())return n(u);u.hasOwnProperty("refresh")?(jt.log("[Identity.IdentityModule.getValidToken] refreshing assertion: ",u),t._refreshIdAssertion(u).then(function(e){return jt.log("[IdentityModule.getIdentityAssertion] refreshed assertion.",e),n(e)},function(e){jt.error("[IdentityModule.getIdentityAssertion] error on refresIdAssertion: ",e," Asking for a new IdAssertion."),t.selectIdentityFromGUI().then(function(e){return jt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,n(e)},function(e){return r(e)})})):t.selectIdentityFromGUI().then(function(e){return jt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,n(e)},function(e){return r(e)})}else t.selectIdentityFromGUI().then(function(e){return jt.log("[IdentityModule] Identity selected from GUI."),t.identities.defaultIdentity=e.userProfile.userURL,n(e)},function(e){return r(e)})}).catch(function(e){return jt.error("Error on identity acquisition ",e),r(e)}),t.runtimeCapabilities.isAvailable("node").then(function(e){if(jt.log("node identity acquisition",e),e){if(t.identities.currentIdentity)return n(t.identities.currentIdentity);jt.log("getIdentityAssertion for nodejs"),t.callNodeJsGenerateMethods("nodejs-idp","origin").then(function(e){n(e)},function(e){r(e)})}}).catch(function(e){jt.error("Error on identity acquisition ",e),r(e)})})}},{key:"_getIdAssertionForDomain",value:function(e,t,n){var r=this;return new Promise(function(o,i){r.selectIdentityForHyperty(e,t,n).then(function(e){return jt.log("[IdentityModule._getIdAssertionForDomain] Identity selected by hyperty."),o(e)},function(e){r.selectIdentityFromGUI().then(function(e){return jt.log("[IdentityModule._getIdAssertionForDomain] Identity selected by hyperty."),o(e)},function(e){return i(e)})})})}},{key:"_refreshIdAssertion",value:function(e){var t=this;return new Promise(function(n,r){t.sendRefreshMessage(e).then(function(e){jt.log("[Identity.IdentityModule.getValidToken] refreshed assertion: ",e),t.identities.updateAssertion(e).then(function(){n(e)},function(e){jt.error("[IdentityModule.getValidToken] error updating the assertion ",e),r(e)})},function(e){jt.error("[IdentityModule.getValidToken] error refreshing the assertion ",e),r(e)})})}},{key:"getUsersIDs",value:function(){return this.identities.identifiers}},{key:"deleteIdentity",value:function(e){return this.identities.removeIdentity(e)}},{key:"listenShowAdmin",value:function(e){this._showAdmin=e}},{key:"requestIdentityToGUI",value:function(e,t){jt.log("[IdentityModule.requestIdentityToGUI:identities]",e),jt.log("[IdentityModule.requestIdentityToGUI:idps]",t);var n=this;return new Promise(function(r,o){if(!1===n.guiDeployed){var i=n._guiURL,s=new Pt(i,n._messageBus);n.guiFake=s,n.guiDeployed=!0}var a={type:"create",to:n._guiURL,from:n._idmURL,body:{value:{identities:e,idps:t}}};try{n._messageBus.postMessage(a,function(e){if(n._messageBus.removeResponseListener(n._idmURL,e.id),200===e.body.code){var t=e.body;jt.log("selectedIdentity: ",t.value),r(t)}else o("error on requesting an identity to the GUI")},!1)}catch(e){o("In method callIdentityModuleFunc error: "+e)}})}},{key:"callNodeJsGenerateMethods",value:function(e,t){jt.log("[callNodeJsGenerateMethods:idp]",e),jt.log("[callNodeJsGenerateMethods:origin]",t);var n=this;return new Promise(function(r,o){var i;n._crypto.getMyPublicKey().then(function(r){return jt.log("[callNodeJsGenerateMethods:key]",r),i=Object(ue.E)(r),jt.log("[callNodeJsGenerateMethods] NO_URL"),n.generateAssertion(i,t,"url",e)}).then(function(e){e?r(e):o("Error on obtaining Identity")}).catch(function(e){jt.log(e),o(e)})})}},{key:"callGenerateMethods",value:function(e,t){jt.log("[callGenerateMethods:idp]",e),jt.log("[callGenerateMethods:origin]",t);var n=this;return new Promise(function(r,o){var i;n._crypto.getMyPublicKey().then(function(r){return jt.log("[callGenerateMethods:key]",r),i=Object(ue.E)(r),jt.log("generateAssertion:no_hint"),n.generateAssertion(i,t,"",e)}).then(function(r){return n.myHint=r,jt.log("generateAssertion:hint"),n.generateAssertion(i,t,r,e)}).then(function(e){e?r(e):o("Error on obtaining Identity")}).catch(function(e){jt.error(e),o(e)})})}},{key:"loginSelectedIdentity",value:function(e,t,n,r){jt.log("[loginSelectedIdentity:publicKey]",e),jt.log("[loginSelectedIdentity:origin]",t),jt.log("[loginSelectedIdentity:idp]",n),jt.log("[loginSelectedIdentity:loginUrl]",r);var o=this;return new Promise(function(i,s){jt.log("[IdentityModule] openPopup"),o.callIdentityModuleFunc("login",{urlreceived:r}).then(function(e){return e},function(e){return jt.error("Error while logging in for the selected identity."),s(e)}).then(function(r){o.sendGenerateMessage(e,t,r,n).then(function(e){if(!e.hasOwnProperty("assertion"))return jt.error("Error while logging in for the selected identity."),s("Could not generate a valid assertion for selected identity.");o.identities.addAssertion(e).then(function(e){i("Login was successfull")}).catch(function(e){s("Login has failed:"+e)})}).catch(function(e){s("On loginSelectedIdentity from method sendGenerateMessage error:  "+e)})})})}},{key:"selectIdentityForHyperty",value:function(e,t,n){jt.log("[selectIdentityForHyperty:origin]",e),jt.log("[selectIdentityForHyperty:idp]",t),jt.log("[selectIdentityForHyperty:idHint]",n);var r=this;return new Promise(function(o,i){r._crypto.getMyPublicKey().then(function(s){var a=Object(ue.E)(s);r.sendGenerateMessage(a,e,n,t).then(function(n){n.hasOwnProperty("assertion")?r.identities.addAssertion(n).then(function(e){return o(n)},function(e){return i(e)}):n.hasOwnProperty("loginUrl")?r.loginSelectedIdentity(a,e,t,n.loginUrl).then(function(e){return o(e)},function(e){return i(e)}):(jt.log("Proceeding by logging in."),r.callGenerateMethods(t,e).then(function(e){return o(e)},function(e){return i(e)}))}).catch(function(e){i("On selectIdentityForHyperty from method sendGenerateMessage error:  "+e)})}).catch(function(e){i("On selectIdentityForHyperty from method generateRSAKeyPair error:  "+e)})})}},{key:"selectIdentityFromGUI",value:function(e){var t=this;jt.log("[IdentityModule.selectIdentityFromGUI:origin]",e);var n=this;return new Promise(function(r,o){t.getIdentitiesToChoose().then(function(e){return n.requestIdentityToGUI(e.identities,e.idps)}).then(function(t){if("identity"===t.type)n.identities.identities[t.value]?r(n.identities.identities[t.value]):o("[IdentityModule.selectIdentityFromGUI] identity not found: ",t.value);else{if("idp"!==t.type)return o("error on GUI received message.");n.callGenerateMethods(t.value,e).then(function(e){return r(e)},function(e){return o(e)})}}).catch(function(e){o("On selectIdentityFromGUI from method requestIdentityToGUI error:  "+e)})})}},{key:"callIdentityModuleFunc",value:function(e,t,n,r){jt.log("[callIdentityModuleFunc:methodName]",e),jt.log("[callIdentityModuleFunc:parameters]",t);var o=this;return new Promise(function(i,s){if(o._showAdmin)"getAccessToken"===e?o._showAdmin(e,t.urlreceived,n,r).then(function(e){i(e)}):o._showAdmin(e);else{var a={type:"execute",to:o._guiURL,from:o._idmURL,body:{resource:"identity",method:e,params:t}};try{o._messageBus.postMessage(a,function(e){o._messageBus.removeResponseListener(o._idmURL,e.id);var t=e.body.value;i(t)},!1)}catch(e){s("In method callIdentityModuleFunc error: "+e)}}})}},{key:"getToken",value:function(e){var t=this,n=e.from,r=e.to;return e.hasOwnProperty("body")&&e.body.hasOwnProperty("source")&&(n=e.body.source),"forward"===e.type&&(n=e.body.from),e.hasOwnProperty("body")&&e.body.hasOwnProperty("subscriber")&&(n=e.body.subscriber),new Promise(function(o,i){jt.log("[IdentityModule.getToken] for msg ",e),t.registry.isLegacy(r).then(function(r){r?t._getAccessToken(e).then(function(e){jt.log("[IdentityModule.getToken] access token ",e),o(Object(ue.i)(e))}).catch(function(e){i("[IdentityModule.getToken] Access Token error "+e)}):t._getValidToken(n).then(function(e){o(e)}).catch(function(e){i("On getToken from method _getValidToken error: "+e)})}).catch(function(e){i("On getToken from method isLegacy error: "+e)})})}},{key:"getIdToken",value:function(e){jt.info("getIdToken:hypertyURL ",e);var t=this;return new Promise(function(n,r){var o;if("hyperty"===e.split("://")[0]){if(o=t.registry.getHypertyOwner(e)){var i=t.identities.getIdentity(o);return i?n(i):r("[IdentityModule.getIdToken] Identity not found for: ",o)}return r("[IdentityModule.getIdToken] User not found for hyperty: ",o)}t._getHypertyFromDataObject(e).then(function(e){if(o=t.registry.getHypertyOwner(e)){var i=t.identities.getIdentity(o);return i?n(i):r("[IdentityModule.getIdToken] Identity not found for: ",o)}return r("[IdentityModule.getIdToken] User not found for hyperty: ",e)}).catch(function(e){jt.error("[IdentityModule.getIdToken] Error: ",e),r(e)})})}},{key:"_getAccessToken",value:function(e){var t=e.to,n=this;return new Promise(function(r){if(!e.hasOwnProperty("body"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body: ",e);if(!e.body.hasOwnProperty("value"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body value: ",e);if(!e.body.value.hasOwnProperty("resources"))return reject("[IdentityModule._getAccessToken] missing mandatory msg body value resources: ",e);var o=Object(ue.k)(t).domain;t.includes("protostub")&&(o=o.replace(o.split(".")[0]+".",""));var i=e.body.value.resources;n._getAccessTokenForDomain(o,i).then(function(e){r(e)})})}},{key:"_getAccessTokenForDomain",value:function(e,t){var n,r=this;return new Promise(function(o,i){try{n=r.identities.getAccessToken(e,t)}catch(e){return i("[IdentityModule._getAccessTokenForDomain] Access Token error "+err)}if(n){if("in-progress"===n.status)return o(r._inProgressAccessToken(e,t));var s=Object(ue.C)();if(jt.log("[Identity.IdentityModule._getAccessTokenForDomain] found  Access Token ",n),!(s>=n.expires))return o(Object(ue.i)(n));n.hasOwnProperty("refresh")?r._refreshAccessToken(Object(ue.i)(n)).then(function(e){return o(r.identities.updateAccessToken(e))}):r._revokeAccessToken(n,e,t).then(function(){setTimeout(function(){return r._getNewAccessToken(e,t)},1e3)})}else r._getNewAccessToken(e,t).then(function(e){return jt.log("[Identity.IdentityModule._getAccessTokenForDomain] new Access Token ",e),o(e)}).catch(function(e){i("[IdentityModule._getAccessTokenForDomain] on getNewAccessToken "+e)})})}},{key:"_revokeAccessToken",value:function(e,t,n){var r=this;return jt.log("[IdentityModule._revokeAccessToken] to be revoked ",e),new Promise(function(o,i){var s;s={type:"execute",to:t,from:r._idmURL,body:{method:"revokeAccessToken",params:{token:e}}};try{r._messageBus.postMessage(s,function(e){var i=e.body.value;i&&r._identities.removeAccessToken(t,n).then(function(){o(i)}),o()})}catch(e){i("In IdentityModule._revokeAccessToken on postMessage error: "+e)}})}},{key:"_inProgressAccessToken",value:function(e,t){var n=this;this.identities.watchingYou.observe("accessTokens",function(r){jt.log("[IdentityModule._inProgressAccessToken] accessTokens changed "+n.identities.accessTokens);var o=r.keypath;if(o.includes("status")&&(o=o.replace(".status","")),o===e&&"status"===r.name&&"created"===r.newValue)return n.identities.getAccessToken(e,t)})}},{key:"_getNewAccessToken",value:function(e,t){var n=this;return new Promise(function(r,o){n.identities.setAccessTokenInProgress(e);var i={type:"execute",to:n._resolveDomain(e),from:n._idmURL,body:{method:"getAccessTokenAuthorisationEndpoint",params:t}};n._messageBus.postMessage(i,function(s){if(s.body.code>299)return o("[IdentityModule._getNewAccessToken] Error on getAccessTokenAuthorisationEndpoint from IdP Proxy: ",s.body.desc);n.callIdentityModuleFunc("getAccessToken",{urlreceived:s.body.value},e,t[0]).then(function(e){jt.log("[IdentityModule:callIdentityModuleFunc:openPopup] auhtorisation result: ",e),i.body.method="getAccessToken",i.body.params={resources:t,login:e},n._messageBus.postMessage(i,function(e){if(e.body.code>299)return o("[IdentityModule._getNewAccessToken] Error on getAccessToken from IdP Proxy: ",e.body.desc);n.identities.addAccessToken(e.body.value).then(function(t){return jt.info("[IdentityModule._getNewAccessToken] resolving token: ",t),r(e.body.value)},function(e){o(e)})})},function(e){o(e)})})})}},{key:"_refreshAccessToken",value:function(e){var t=this;return jt.log("IdentityModule._refreshAccessToken:outdatedToken",e),new Promise(function(n,r){var o;o={type:"execute",to:t._resolveDomain(e.domain),from:t._idmURL,body:{method:"refreshAccessToken",params:{token:e}}};try{t._messageBus.postMessage(o,function(e){var t=e.body.value;n(t)})}catch(e){r("In IdentityModule._refreshAccessToken on postMessage error: "+e)}})}},{key:"sendRefreshMessage",value:function(e){var t=this;return jt.log("sendRefreshMessage:oldIdentity",e),new Promise(function(n,r){var o,i=t._resolveDomain(e.idp.domain),s=t.getIdentity(e.userProfile.userURL);jt.info("sendRefreshMessage:oldIdentity",e),o={type:"execute",to:i,from:t._idmURL,body:{resource:"identity",method:"refreshAssertion",params:{identity:s}}};try{t._messageBus.postMessage(o,function(e){if(e.body.code<300){var t=e.body.value;n(t)}else n(e.body.value.body.params,identity)})}catch(e){r("In sendRefreshMessage on postMessage error: "+e)}})}},{key:"getAccessToken",value:function(e,t,n){jt.log("[getAccessToken:idpDomain]",e);var r=this;return new Promise(function(o,i){var s;s={type:"execute",to:r._resolveDomain(e),from:r._idmURL,body:{resource:"identity",method:"getAccessToken",params:{resources:t,login:n}}};try{r._messageBus.postMessage(s,function(e){if(e.body.code<299){var t=e.body.value;o(t)}else o(e.body)})}catch(e){i("IdentityModule.In getAccessToken: "+e)}})}},{key:"getAccessTokenAuthorisationEndpoint",value:function(e,t){jt.log("[getAccessTokenAuthorisationEndpoint:idpDomain]",t);var n=this;return new Promise(function(r,o){var i;i={type:"execute",to:n._resolveDomain(t),from:n._idmURL,body:{resource:"identity",method:"getAccessTokenAuthorisationEndpoint",params:{resources:e}}};try{n._messageBus.postMessage(i,function(e){var t=e.body.value;r(t)})}catch(e){o("In getAccessTokenAuthorisationEndpoint: "+e)}})}},{key:"sendGenerateMessage",value:function(e,t,n,r){jt.log("[sendGenerateMessage:contents]",e),jt.log("[sendGenerateMessage:origin]",t),jt.log("[sendGenerateMessage:usernameHint]",n),jt.log("[sendGenerateMessage:idpDomain]",r),jt.log("sendGenerateMessage_hint");var o=this;return new Promise(function(i,s){var a;a={type:"execute",to:o._resolveDomain(r),from:o._idmURL,body:{resource:"identity",method:"generateAssertion",params:{contents:e,origin:t,usernameHint:n}}};try{o._messageBus.postMessage(a,function(e){e.body.code<300?i(e.body.value):s(e.body)})}catch(e){s("In sendGenerateMessage: "+e)}})}},{key:"generateAssertion",value:function(e,t,n,r){jt.log("[generateAssertion:contents]",e),jt.log("[generateAssertion:origin]",t),jt.log("[generateAssertion:usernameHint]",n),jt.log("[generateAssertion:idpDomain]",r);var o=this;return new Promise(function(i,s){jt.log("[IdentityModule:sendGenerateMessage:sendGenerateMessage]",n),o.sendGenerateMessage(e,t,n,r).then(function(e){e?o.identities.addAssertion(e).then(function(t){i(e)},function(e){s(e)}):s("error on obtaining identity information")},function(e){e.hasOwnProperty("description")&&e.description.hasOwnProperty("loginUrl")?o.callIdentityModuleFunc("login",{urlreceived:e.description.loginUrl}).then(function(e){jt.log("[IdentityModule:callIdentityModuleFunc:openPopup]",n),i(e)},function(e){s(e)}):(jt.error("[IdentityModule:sendGenerateMessage] generate assertion with hint error ",e),s(e))}).catch(function(e){s("On generateAssertion from method sendGenerateMessage error: "+e)})})}},{key:"validateAssertion",value:function(e,t,n){jt.log("[validateAssertion:assertion]",e),jt.log("[validateAssertion:origin]",t),jt.log("[validateAssertion:idpDomain]",n);var r=this,o={type:"execute",to:r._resolveDomain(n),from:r._idmURL,body:{resource:"identity",method:"validateAssertion",params:{assertion:e,origin:t}}};return new Promise(function(e,t){try{r._messageBus.postMessage(o,function(n){200===n.body.code?e(n.body.value):t("error",n.body.code)})}catch(e){t("On validateAssertion from method postMessage error: "+e)}})}},{key:"addGUIListeners",value:function(){var e=this;e._messageBus.addListener(e._idmURL,function(t){var n,r=t.body.method;if(jt.log("[IdentityModule:addGUIListeners]",t,t.body,r),"deployGUI"===r)n=e.deployGUI();else{if("getIdentitiesToChoose"===r)return void e.getIdentitiesToChoose().then(function(n){var r={type:"execute",value:n,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){jt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}});if("unregisterIdentity"===r){var o=t.body.params.email;n=e.unregisterIdentity(o)}else{if("getMyPublicKey"===r)return void e._crypto.getMyPublicKey().then(function(n){var r={type:"execute",value:n=Object(ue.E)(n),code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){jt.error("On addGUIListeners from if generateRSAKeyPair method postMessage error: "+e)}});if("sendGenerateMessage"===r){var i=t.body.params.contents,s=t.body.params.origin,a=t.body.params.usernameHint,c=t.body.params.idpDomain,u={id:t.id,type:"response",to:t.from,from:t.to};return void e.sendGenerateMessage(i,s,a,c).then(function(t){var n={type:"execute",value:t,code:200};u.body=n;try{e._messageBus.postMessage(u)}catch(e){jt.error("IdentityModule.addGUIListeners sendGenerateMessage error: "+e)}},function(t){jt.info("IDPProxy generateAssertion reply error "+t),u.body=t,e._messageBus.postMessage(u)})}if("getAccessTokenAuthorisationEndpoint"===r){var l=t.body.params.scope,f=t.body.params.idpDomain;return void e.getAccessTokenAuthorisationEndpoint(l,f).then(function(n){var r={type:"execute",value:n,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){jt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}})}if("addAccessToken"===r){var d=t.body.params;return void e.identities.addAccessToken(d).then(function(n){var r={type:"execute",value:n,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){jt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}if("getAccessToken"===r){var h=t.body.params.idpDomain,y=t.body.params.resources,p=t.body.params.login,v={id:t.id,type:"response",to:t.from,from:t.to};return void e.getAccessToken(h,y,p).then(function(t){var n={type:"execute",value:t,code:200};v.body=n;try{e._messageBus.postMessage(v)}catch(e){jt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}},function(t){try{v.body=t,e._messageBus.postMessage(v)}catch(e){jt.error("On addGUIListeners from if sendGenerateMessage method postMessage error: "+e)}})}if("addAssertion"===r){var b=t.body.params;return void e.identities.addAssertion(b).then(function(n){var r={type:"execute",value:n,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){jt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}if("refreshAccessToken"===r){var g=t.body.params.domain,m=t.body.params.resources;return void e._getAccessTokenForDomain(g,m).then(function(n){var r={id:t.id,type:"response",to:t.from,from:t.to,body:{value:n.accessToken,code:200}};try{e._messageBus.postMessage(r)}catch(e){jt.error("On addGUIListeners for refreshAccessToken request: "+e)}})}if("unauthorise"===r){var _=t.body.params.domain,w=t.body.params.resources;try{e._revokeAccessToken(e.identities.getAccessToken(_,w),_,w)}catch(e){return reject("[IdentityModule.addGUIListeners] unauthorise error "+err)}var O={id:t.id,type:"response",to:t.from,from:t.to,body:{value:!0,code:200}};try{e._messageBus.postMessage(O)}catch(e){jt.error("On addGUIListeners for refreshAccessToken request: "+e)}return}}}var k={type:"execute",value:n,code:200},R={id:t.id,type:"response",to:t.from,from:t.to,body:k};try{e._messageBus.postMessage(R)}catch(e){jt.error("On addGUIListeners from if storeIdentity method postMessage error: "+e)}})}},{key:"deployGUI",value:function(){this.guiDeployed=!0}},{key:"_getValidToken",value:function(e){jt.log("[IdentityModule._getValidToken]:hypertyURL",e);var t=this;return new Promise(function(n,r){t.getIdToken(e).then(function(e){jt.log("[IdentityModule._getValidToken] retrieved IdAssertion",e);var o=Object(ue.C)();if(!e.hasOwnProperty("expires"))return n(e);var i=e.expires;jt.log("[Identity.IdentityModule.getValidToken] Token expires in",i),jt.log("[Identity.IdentityModule.getValidToken] time now:",o),o>=i?e.hasOwnProperty("refresh")?(jt.log("[Identity.IdentityModule.getValidToken] refreshing assertion: ",e),t.sendRefreshMessage(e).then(function(e){jt.log("[Identity.IdentityModule.getValidToken] refreshed assertion: ",e),t.identities.updateAssertion(e).then(function(){n(e)},function(e){jt.error("[IdentityModule.getValidToken] error updating the assertion ",e),r(e)})},function(e){jt.error("[IdentityModule.getValidToken] error refreshing the assertion ",e),r(e)})):t.callGenerateMethods(e.idp.domain).then(function(e){n(e)}).catch(function(e){r("[IdentityModule.getValidToken] error when generating a new assertion "+e)}):n(e)}).catch(function(e){jt.error("[IdentityModule.getValidToken] error on getIdToken",e),r(e)})})}},{key:"_getHypertyFromDataObject",value:function(e){jt.info("_getHypertyFromDataObject:dataObjectURL",e);var t=this;return new Promise(function(n,r){var o=Object(ue.k)(e).domain,i=Object(ue.z)(e),s=t.registry.getReporterURLSynchonous(i);if(jt.info("_getHypertyFromDataObject:reporterURL",s),s)n(s);else{var a=t.dataObjectsIdentity[i];if(jt.info("_getHypertyFromDataObject:storedReporterURL",a),a)n(a);else{var c=t.registry.getDataObjectSubscriberHyperty(e);jt.info("_getHypertyFromDataObject:subscriberHyperty",c),c?n(c):t._coreDiscovery.discoverDataObjectPerURL(i,o).then(function(e){jt.info("_getHypertyFromDataObject:dataObject",e),t.dataObjectsIdentity[i]=e.reporter,jt.info("_getHypertyFromDataObject:dataObject.reporter",e.reporter),n(e.reporter)},function(e){r(e)})}}})}},{key:"_resolveDomain",value:function(e){return e?"domain-idp://"+e:"domain-idp://google.com"}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){this._messageBus=e,this.addGUIListeners()}},{key:"coreDiscovery",get:function(){return this._coreDiscovery},set:function(e){this._coreDiscovery=e}},{key:"registry",get:function(){return this._registry},set:function(e){this._registry=e}},{key:"identities",get:function(){return this._identities},set:function(e){this._identities=e}},{key:"idps",get:function(){return this._listOfIdps}}]),e}();function Mt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ct=de.getLogger("IdentityHandler"),xt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._idm=t}return function(e,t,n){t&&Mt(e.prototype,t)}(e,[{key:"reset",value:function(){console.log("IM reset"),this._idm.identities=new kt(this._idm.identities._type,this._idm.identities._storageManager),console.log(this._idm.identities)}},{key:"_isToSetID",value:function(e){var t=e.from;if(e.body&&e.body.hasOwnProperty("source")&&(t=e.body.source),e.body&&e.body.hasOwnProperty("subscriber")&&(t=e.body.subscriber),"forward"===e.type)return!1;if(t.includes("/p2prequester/")||t.includes("/p2phandler/"))return!1;var n=t.split("://")[0];return-1===["domain-idp","runtime","domain"].indexOf(n)}},{key:"processMessage",value:function(e){var t=this;return Ct.log("[IdentityHandler.processMessage] ",e),new Promise(function(n,r){if(!t._isToSetID(e))return n(e);t._idm.getToken(e).then(function(t){e.hasOwnProperty("body")||(e.body={}),e.body.identity=t,n(e)}).catch(function(e){Ct.error(e),r(e)})})}}]),e}(),Lt=n(23),It=n(7);function Tt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ut(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function At(e,t,n){return t&&Ut(e.prototype,t),n&&Ut(e,n),e}de.getLogger("Pipeline");var Dt=function(){function e(t){Tt(this,e),this.handlers=[],this.onFail=t}return At(e,[{key:"process",value:function(e,t){if(this.handlers.length>0){var n=new Ht(this.handlers);n.next(new Nt(this,n,e,t))}else t(e)}}]),e}(),Nt=function(){function e(t,n,r,o){Tt(this,e),this._inStop=!1,this._pipeline=t,this._iter=n,this._msg=r,this._onDeliver=o}return At(e,[{key:"next",value:function(){this._inStop||(this._iter.hasNext?this._iter.next(this):this._onDeliver(this._msg))}},{key:"deliver",value:function(){this._inStop||(this._inStop=!0,this._onDeliver(this._msg))}},{key:"fail",value:function(e){this._inStop||(this._inStop=!0,this._pipeline.onFail&&this._pipeline.onFail(e))}},{key:"pipeline",get:function(){return this._pipeline}},{key:"msg",get:function(){return this._msg},set:function(e){this._msg=e}}]),e}(),Ht=function(){function e(t){Tt(this,e),this._index=-1,this._array=t}return At(e,[{key:"hasNext",get:function(){return this._index<this._array.length-1}},{key:"next",get:function(){return this._index++,this._array[this._index]}}]),e}(),Bt=Dt;function Ft(e){return(Ft="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function qt(e){return(qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gt(e,t){return(Gt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Vt=de.getLogger("MessageBus"),Wt=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t){return!t||"object"!==Ft(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,qt(t).call(this)))._registry=e,n._forwards={},n._pipelineIn=new Bt(function(e){Vt.error("PIPELINE-ERROR: ",JSON.stringify(e))}),n._pipelineOut=new Bt(function(e){Vt.error("PIPELINE-ERROR: ",JSON.stringify(e))}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gt(e,t)}(t,It.a),function(e,t,n){t&&Kt(e.prototype,t)}(t,[{key:"postMessage",value:function(e,t,n){Vt.info("onPOSTMessage: ",e);var r=this,o=function(o){if(r._responseCallback(e,t,n),!r._onResponse(o)){var i=r._subscriptions[o.to];i?r._publishOn(i,o):r._onPostMessage(o)}};return r._genId(e),r._isToProcess(e)?r._isIncomingMessage(e)?r._pipelineIn.process(e,o):r._pipelineOut.process(e,o):o(e),e.id}},{key:"_isToProcess",value:function(e){var t=["domain","domain-idp","global","hyperty-runtime","runtime"],n=e.from.split("://")[0],r=e.to.split("://")[0],o=e.from,i=e.to;return e.body&&e.body.source&&(o=e.body.source),e.body&&e.body.subscriber&&(o=e.body.subscriber),!(-1!==o.indexOf("/p2phandler/")||-1!==o.indexOf("/p2prequester/")||-1!==i.indexOf("/p2phandler/")||-1!==i.indexOf("/p2prequester/")||this._registry.isLocal(o)&&this._registry.isLocal(e.to)||e.from===n||e.to===r||"read"===e.type||"response"===e.type||e.from.includes("hyperty://")&&"delete"===e.type||-1!==t.indexOf(n)&&-1!==t.indexOf(r))}},{key:"_isIncomingMessage",value:function(e){var t;return"forward"===e.type?(Vt.info("[MessageBus - isIncomingMessage] - message.type: ",e.type),t=e.body.from):e.hasOwnProperty("body")&&e.body.hasOwnProperty("source")&&e.body.source?(Vt.info("[MessageBus - isIncomingMessage] - message.body.source: ",e.body.source),t=e.body.source):e.hasOwnProperty("body")&&e.body.hasOwnProperty("subscriber")&&e.body.subscriber?(Vt.info("[MessageBus - isIncomingMessage] - message.body.subscriber: ",e.body.subscriber),t=e.body.subscriber):e.hasOwnProperty("body")&&e.body.hasOwnProperty("reporter")&&e.body.reporter?(Vt.info("[MessageBus - isIncomingMessage] - message.body.reporter: ",e.body.reporter),t=e.body.reporter):(Vt.info("[MessageBus - isIncomingMessage] - message.from ",e.from),t=e.from),Vt.info("[MessageBus - isIncomingMessage] - check if isLocal: ",t),!this._registry.isLocal(t)}},{key:"addPublish",value:function(e){var t=this,n=this,r=n._forwards[e];return r||(r={counter:0,fl:n.addListener(e,function(t){Vt.info("MB-PUBLISH: ( "+e+" )"),n._onPostMessage(t)}),remove:function(){t.counter--,0===t.counter&&(t.fl.remove(),delete n._forwards[e])}},n._forwards[e]=r),r.counter++,r}},{key:"addForward",value:function(e,t){var n=this;return n.addListener(e,function(r){Vt.info("MB-FORWARD: ( "+e+" to "+t+" )"),n.forward(t,r)})}},{key:"forward",value:function(e,t){var n=this._subscriptions[e];n&&this._publishOn(n,t)}},{key:"_onPostMessage",value:function(e){var t=this;t._registry.resolve(e).then(function(n,r){r?t.forward(n,r):t.forward(n,e)}).catch(function(e){Vt.error("RESOLVE-ERROR: ",e)})}},{key:"pipelineIn",get:function(){return this._pipelineIn}},{key:"pipelineOut",get:function(){return this._pipelineOut}}]),t}();function Jt(e){for(var t=0,n=new Uint8Array(4*e.length),r=0;r!=e.length;r++){try{e.charCodeAt(r)}catch(e){return void console.log(e.message)}var o=e.charCodeAt(r);if(o<128)n[t++]=o;else{if(o<2048)n[t++]=o>>6|192;else{if(o>55295&&o<56320){if(++r==e.length)throw"UTF-8 encode: incomplete surrogate pair";var i=e.charCodeAt(r);if(i<56320||i>57343)throw"UTF-8 encode: second char code 0x"+i.toString(16)+" at index "+r+" in surrogate pair out of range";o=65536+((1023&o)<<10)+(1023&i),n[t++]=o>>18|240,n[t++]=o>>12&63|128}else n[t++]=o>>12|224;n[t++]=o>>6&63|128}n[t++]=63&o|128}}return n.subarray(0,t)}function Yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var zt=de.getLogger("CryptoManager"),$t=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),"function"==typeof t.createWebcrypto?this._crypto=t.createWebcrypto():this._crypto=crypto}return function(e,t,n){t&&Yt(e.prototype,t)}(e,[{key:"encryptRSA",value:function(e,t){zt.log("encryptRSA:pubKey",e),zt.log("encryptRSA:data",t);var n=this;return new Promise(function(r,o){n._importRSAencryptKey(new Uint8Array(e)).then(function(e){n._crypto.subtle.encrypt({name:"RSA-OAEP"},e,t).then(function(e){r(new Uint8Array(e))}).catch(function(e){o(e)})})})}},{key:"decryptRSA",value:function(e,t){zt.log("decryptRSA:privKey",e),zt.log("decryptRSA:data",t);var n=this;return new Promise(function(r,o){n._importRSAdecryptKey(e).then(function(e){n._crypto.subtle.decrypt({name:"RSA-OAEP"},e,t).then(function(e){var t=new Uint8Array(e);r(t)}).catch(function(e){o(e)})})})}},{key:"signRSA",value:function(e,t){var n=this;return new Promise(function(r,o){n._importRSAsignKey(e).then(function(e){n._crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,Jt(t)).then(function(e){r(new Uint8Array(e))}).catch(function(e){o(e)})})})}},{key:"verifyRSA",value:function(e,t,n){var r=this;return new Promise(function(o,i){r._importRSAverifyKey(e).then(function(e){r._crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5"},e,n,Jt(t)).then(function(e){o(e)}).catch(function(e){i(e)})})})}},{key:"encryptAES",value:function(e,t,n){zt.log("encryptAES:key",e),zt.log("encryptAES:data",t),zt.log("encryptAES:iv",n);var r=this;return new Promise(function(o,i){r._importAESkey(e).then(function(e){r._crypto.subtle.encrypt({name:"AES-CBC",iv:n},e,Jt(t)).then(function(e){o(new Uint8Array(e))}).catch(function(e){i(e)})})})}},{key:"decryptAES",value:function(e,t,n){zt.log("decryptAES:key",e),zt.log("decryptAES:data",t),zt.log("decryptAES:iv",n);var r=this;return new Promise(function(o,i){r._importAESkey(e).then(function(e){r._crypto.subtle.decrypt({name:"AES-CBC",iv:n},e,t).then(function(e){var t=function(e){for(var t="",n=0;n<e.length;){var r=e[n++];if(r>127){if(r>191&&r<224){if(n>=e.length)throw"UTF-8 decode: incomplete 2-byte sequence";r=(31&r)<<6|63&e[n]}else if(r>223&&r<240){if(n+1>=e.length)throw"UTF-8 decode: incomplete 3-byte sequence";r=(15&r)<<12|(63&e[n])<<6|63&e[++n]}else{if(!(r>239&&r<248))throw"UTF-8 decode: unknown multibyte start 0x"+r.toString(16)+" at index "+(n-1);if(n+2>=e.length)throw"UTF-8 decode: incomplete 4-byte sequence";r=(7&r)<<18|(63&e[n])<<12|(63&e[++n])<<6|63&e[++n]}++n}if(r<=65535)t+=String.fromCharCode(r);else{if(!(r<=1114111))throw"UTF-8 decode: code point 0x"+r.toString(16)+" exceeds UTF-16 reach";r-=65536,t+=String.fromCharCode(r>>10|55296),t+=String.fromCharCode(1023&r|56320)}}return t}(new Uint8Array(e));zt.log("crypto-decryptAES",t),o(t)}).catch(function(e){i(e)})})})}},{key:"hashHMAC",value:function(e,t){zt.log("hashHMAC:key",e),zt.log("hashHMAC:data",t);var n=this;return new Promise(function(r,o){"string"!=typeof t&&(t=JSON.stringify(t),zt.log("Converting hashHMAC inpured DATA"),zt.log("HHashHMAC:",t)),n._importHMACkey(e).then(function(e){n._crypto.subtle.sign({name:"HMAC"},e,Jt(t)).then(function(e){zt.log("HashHMAC signature:",new Uint8Array(e)),r(new Uint8Array(e))}).catch(function(e){o(e)})})})}},{key:"verifyHMAC",value:function(e,t,n){zt.log("verifyHMAC:key",e),zt.log("verifyHMAC:data",t),zt.log("verifyHMAC:signature",n);var r=this;return new Promise(function(o,i){r._importHMACkey(e).then(function(e){"string"!=typeof t&&(t=JSON.stringify(t),zt.log("Converting verifyHMAC inputed DATA:",t)),r._crypto.subtle.verify({name:"HMAC"},e,n,Jt(t)).then(function(e){zt.log("verifyHMAC result",e),e?o(e):i(e)}).catch(function(e){zt.error("crypto-verifyHMAC",e),i(e)})})})}},{key:"generateRSAKeyPair",value:function(){var e=this,t={};return new Promise(function(n,r){e._crypto.subtle.generateKey({name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(o){e._crypto.subtle.exportKey("spki",o.publicKey).then(function(n){return t.public=new Uint8Array(n),e._crypto.subtle.exportKey("pkcs8",o.privateKey)}).then(function(e){t.private=new Uint8Array(e),n(t)}).catch(function(e){zt.error(e),r(e)})}).catch(function(e){zt.error(e),r(e)})})}},{key:"generateIV",value:function(){var e=new Uint8Array(16);return this._crypto.getRandomValues(e),e}},{key:"generateRandom",value:function(){var e=new Uint8Array(32);this._crypto.getRandomValues(e);for(var t=Jt(Date.now().toString()),n=t.slice(t.length-4,t.length),r=0;r<4;r++)e[r]=n[r];return e}},{key:"generatePMS",value:function(){var e=new Uint8Array(48);return this._crypto.getRandomValues(e),e}},{key:"generateMasterSecret",value:function(e,t){var n=this;return new Promise(function(r,o){var i=new Uint8Array(48),s=t;n._digest(e).then(function(e){n.hashHMAC(e,s).then(function(t){for(var r=0;r<32;r++)i[r]=t[r];return n.hashHMAC(e,s+t)}).then(function(e){for(var t=0;t<16;t++)i[t+32]=e[t];r(i)}).catch(function(e){o(e)})})})}},{key:"generateKeys",value:function(e,t){var n=this;return new Promise(function(r,o){var i=[],s=t;n.hashHMAC(e,s).then(function(t){return i.push(t),n.hashHMAC(e,s+t)}).then(function(t){return i.push(t),n.hashHMAC(e,s+t)}).then(function(t){return i.push(t),n.hashHMAC(e,s+t)}).then(function(e){i.push(e),r(i)}).catch(function(e){o(e)})})}},{key:"_importRSAsignKey",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.importKey("pkcs8",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(e){n(e)}).catch(function(e){zt.error("crypto-_importRSAsignKey",e),r(e)})})}},{key:"_importRSAverifyKey",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.importKey("spki",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"]).then(function(e){n(e)}).catch(function(e){zt.error("crypto-_importRSAverifyKey",e),r(e)})})}},{key:"_importRSAencryptKey",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:{name:"SHA-256"}},!0,["encrypt"]).then(function(e){n(e)}).catch(function(e){zt.error("crypto-_importRSAencryptKey",e.name),r(e)})})}},{key:"_importRSAdecryptKey",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.importKey("pkcs8",e,{name:"RSA-OAEP",hash:{name:"SHA-256"}},!0,["decrypt"]).then(function(e){n(e)}).catch(function(e){zt.error("crypto-_importRSAdecryptKey",e),r(e)})})}},{key:"concatPMSwithRandoms",value:function(e,t,n){for(var r=new Uint8Array(e.length+t.length+n.length),o=0;o<e.length;o++)r[o]=e[o];for(var i=0;i<t.length;i++)r[i+e.length]=e[i];for(var s=0;s<n.length;s++)r[s+e.length+t.length]=e[s];return r}},{key:"_generate256bitKey",value:function(){var e=new Uint8Array(32);return this._crypto.getRandomValues(e),e}},{key:"_importHMACkey",value:function(e){var t=this;return new Promise(function(n,r){t._digest(e).then(function(e){t._crypto.subtle.importKey("raw",e,{name:"HMAC",hash:{name:"SHA-256"},length:256},!0,["sign","verify"]).then(function(e){n(e)}).catch(function(e){r(e)})})})}},{key:"_digest",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.digest({name:"SHA-256"},e).then(function(e){n(new Uint8Array(e))}).catch(function(e){zt.error(e),r(e)})})}},{key:"_importAESkey",value:function(e){var t=this;return new Promise(function(n,r){t._crypto.subtle.importKey("raw",e,{name:"AES-CBC"},!0,["encrypt","decrypt"]).then(function(e){n(e)}).catch(function(e){zt.error("crypto-importAESkey",e),r(e)})})}},{key:"_sha256",value:function(e){var t=this,n=new TextEncoder("utf-8").encode(e);return t._crypto.subtle.digest("SHA-256",n).then(function(e){return t._hex(e)})}},{key:"_hex",value:function(e){for(var t=[],n=new DataView(e),r=0;r<n.byteLength;r+=4){var o=("00000000"+n.getUint32(r).toString(16)).slice(-"00000000".length);t.push(o)}return t.join("")}}]),e}();function Qt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Xt=de.getLogger("CryptoManager"),Zt=new(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.storageManager=t,this.userDefaultKeyRef="userAsymmetricKey"}return function(e,t,n){t&&Qt(e.prototype,t)}(e,[{key:"init",value:function(e,t,n,r,o,i,s,a){if(!e)throw new Error("[] runtimeURL is missing.");if(!n)throw new Error("storageManager is missing");if(!a)throw new Error("runtimeFactory is missing");this._runtimeURL=e,this._cryptoManagerURL=this._runtimeURL+"/cryptoManager",this.storageManager=n,this.dataObjectsStorage=r,this.runtimeCapabilities=t,this._runtimeFactory=a,this._domain=Object(ue.k)(this._runtimeURL).domain,this.crypto=new $t(this._runtimeFactory),this.chatKeys={},this.dataObjectSessionKeys={},this.isToUseEncryption=!0,this._registry=o,this._coreDiscovery=i,this._idm=s}},{key:"loadSessionKeys",value:function(){var e=this;return new Promise(function(t){e.storageManager.get("dataObjectSessionKeys").then(function(n){e.dataObjectSessionKeys=n||{},t()})})}},{key:"_isFromRemoteSM",value:function(e){return"runtime"===e.split("://")[0]&&e!==this._runtimeURL+"/sm"}},{key:"addCryptoGUIListeners",value:function(){var e=this;e._messageBus.addListener(e._cryptoManagerURL,function(t){"generateRSAKeyPair"!==t.body.method||e._crypto.getMyPublicKey().then(function(n){var r={type:"execute",value:n,code:200},o={id:t.id,type:"response",to:t.from,from:t.to,body:r};try{e._messageBus.postMessage(o)}catch(e){Xt.error("On addGUIListeners from if generateRSAKeyPair method postMessage error: "+e)}})})}},{key:"_isToEncrypt",value:function(e){Xt.log("[CryptoManager._isToEncrypt]",e);var t="create"===e.type,n=e.from.includes("hyperty://"),r=e.to.includes("hyperty://"),o=Object(ue.s)(e.to),i=this.registry.getDataObjectReporter(e.to),s=e.hasOwnProperty("body")&&e.body.hasOwnProperty("mutual")?e.body.mutual:!(e.hasOwnProperty("body")&&e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("mutual"))||e.body.value.mutual;return!!s&&(null===i||!Object(ue.u)(i))&&(this.isToUseEncryption||"handshake"===e.type?"update"===e.type?(Xt.info("update:encryption disabled"),!1):"forward"===e.type?(Xt.info("forward:encryption disabled"),!1):!Object(ue.u)(e.to)&&(t&&n&&r||t&&n&&o&&s||"handshake"===e.type||"update"===e.type&&s):(Xt.info("not handshake: encryption disabled"),!1))}},{key:"_isToDecrypt",value:function(e){var t=this;return new Promise(function(n,r){var o="subscribe"===e.type,i=t._isFromRemoteSM(e.from),s=e.body.hasOwnProperty("value")&&e.body.value.hasOwnProperty("mutual")?e.body.value.mutual:!e.body.hasOwnProperty("mutual")||e.body.mutual;if(o&&i&&s){Xt.log("[CryptoManager._isToDecrypt] _doMutualAuthenticationPhase1"),console.log("[CryptoManager._isToDecrypt] ",e);var a=t.registry.getDataObjectReporter(e.to);if(null!==a&&Object(ue.u)(a))return n(!1);t._doMutualAuthenticationPhase1(e).then(function(){n(!1)},function(e){r(e)})}else e.hasOwnProperty("body")&&e.body.hasOwnProperty("value")&&"string"==typeof e.body.value&&s?(Xt.log("[CryptoManager._isToDecrypt] true"),n(!0)):(Xt.log("[CryptoManager._isToDecrypt] false"),n(!1))}).catch(function(e){Xt.error("[CryptoManager._isToDecrypt]",e)})}},{key:"encryptMessage",value:function(e){var t=this;return Xt.log("encrypt message "),new Promise(function(n,r){var o="handshake"===e.type;if(!t._isToEncrypt(e))return n(e);var i=Object(ue.z)(e.to),s=Object(ue.s)(i),a=Object(ue.u)(e.to),c="hyperty"===Object(ue.k)(e.from).type,u="hyperty"===Object(ue.k)(e.to).type;if("update"===e.type)return Xt.log("encrypt message: message type update"),n(e);if(a)n(e);else if(c&&u){var l=t._registry.getHypertyOwner(e.from);if(l){var f=t.chatKeys[e.from+"<->"+e.to];if(f||(f=t._newChatCrypto(e,l),t.chatKeys[e.from+"<->"+e.to]=f,e.body.handshakePhase="startHandShake"),f.authenticated&&!o){var d=t.crypto.generateIV();t.crypto.encryptAES(f.keys.hypertyFromSessionKey,Object(ue.E)(e.body.value),d).then(function(r){var o=t._filterMessageToHash(e,Object(ue.E)(e.body.value)+Object(ue.E)(d),f.hypertyFrom.messageInfo);t.crypto.hashHMAC(f.keys.hypertyFromHashKey,o).then(function(t){var o={iv:Object(ue.m)(d),value:Object(ue.m)(r),hash:Object(ue.m)(t)};e.body.value=Object(ue.m)(o),n(e)})})}else o?n(e):t._doHandShakePhase(e,f).then(function(n){t.chatKeys[e.from+"<->"+e.to]=n.chatKeys,t._messageBus.postMessage(n.message),r("encrypt handshake protocol phase ")})}else r("In encryptMessage: Hyperty owner URL was not found")}else c&&s&&t.storageManager.get("dataObjectSessionKeys").then(function(o){var s=(o=Object(ue.d)(o||{}))?o[i]:null;t.dataObjectsStorage.getDataObject(i).then(function(o){if(!s&&o.reporter&&o.reporter===e.from){var a=t.crypto.generateRandom();t.dataObjectSessionKeys[i]={sessionKey:a,isToEncrypt:!0};var c=Object(ue.e)(t.dataObjectSessionKeys);t.storageManager.set("dataObjectSessionKeys",0,c).catch(function(e){r("On encryptMessage from method storageManager.set error: "+e)}),s=t.dataObjectSessionKeys[i]}if(s)if(s.isToEncrypt){var u=t.crypto.generateIV(),l=Object(ue.E)(u),f=Object(ue.E)(e.body.value);t.crypto.encryptAES(s.sessionKey,f,u).then(function(r){delete e.body.identity.assertion,delete e.body.identity.expires;var o=t._filterMessageToHash(e,f+l);t.crypto.hashHMAC(s.sessionKey,o).then(function(t){var o={value:Object(ue.m)(r),iv:Object(ue.m)(u),hash:Object(ue.m)(t)};e.body.value=Object(ue.E)(o),n(e)})})}else n(e);else r("Data object key could not be defined: Failed to decrypt message ")}).catch(function(e){r("On encryptMessage from method dataObjectsStorage.getDataObject error: "+e)})}).catch(function(e){r("On encryptMessage from method storageManager.get error: "+e)})})}},{key:"encryptDataObject",value:function(e,t){var n=this;return new Promise(function(r,o){Xt.info("dataObject value to encrypt: ",e);var i=Object(ue.z)(t);n.storageManager.get("dataObjectSessionKeys").then(function(t){var s=(t=Object(ue.d)(t||{}))?t[i]:null;if(!s)return o("No dataObjectKey for this dataObjectURL:",i);if(!s.isToEncrypt)return Xt.info("The dataObject is not encrypted"),r(e);var a=n.crypto.generateIV();n.crypto.encryptAES(s.sessionKey,Object(ue.E)(e),a).then(function(e){var t={value:Object(ue.m)(e),iv:Object(ue.m)(a)};return r(t)}).catch(function(e){o("On encryptDataObject from method encryptAES error: "+e)})}).catch(function(e){o("On encryptDataObject from method storageManager.get error: "+e)})})}},{key:"decryptMessage",value:function(e){var t=this;return new Promise(function(n,r){var o="handshake"===e.type;t._isToDecrypt(e).then(function(i){if(!i)return n(e);var s=Object(ue.z)(e.to),a=Object(ue.s)(s),c="hyperty"===Object(ue.k)(e.from).type,u="hyperty"===Object(ue.k)(e.to).type;if("update"===e.type)return n(e);if(c&&u){var l=t._registry.getHypertyOwner(e.to);if(l){var f=t.chatKeys[e.to+"<->"+e.from];if(f||(f=t._newChatCrypto(e,l,"decrypt"),t.chatKeys[e.to+"<->"+e.from]=f),f.authenticated&&!o){var d=Object(ue.g)(e.body.value),h=Object(ue.h)(d.iv),y=Object(ue.h)(d.value),p=Object(ue.h)(d.hash);t.crypto.decryptAES(f.keys.hypertyToSessionKey,y,h).then(function(r){e.body.value=r;var o=t._filterMessageToHash(e,r+h);t.crypto.verifyHMAC(f.keys.hypertyToHashKey,o,p).then(function(t){e.body.assertedIdentity=!0,n(e)})})}else o?t._doHandShakePhase(e,f).then(function(n){"handShakeEnd"===n||(t.chatKeys[e.to+"<->"+e.from]=n.chatKeys,t._messageBus.postMessage(n.message))}):r("wrong message do decrypt")}else r("error on decrypt message")}else c&&a?t.storageManager.get("dataObjectSessionKeys").then(function(o){var i=(o=Object(ue.d)(o||{}))?o[s]:null;if(i)if(i.isToEncrypt){var a=Object(ue.x)(e.body.value),c=Object(ue.h)(a.iv),u=Object(ue.h)(a.value),l=Object(ue.h)(a.hash);t.crypto.decryptAES(i.sessionKey,u,c).then(function(o){var s=Object(ue.x)(o);e.body.value=s;var a=t._filterMessageToHash(e,Object(ue.E)(s)+Object(ue.E)(c));t.crypto.verifyHMAC(i.sessionKey,a,l).then(function(t){Xt.log("Received message HMAC result",t),e.body.assertedIdentity=!0,n(e)}).catch(function(e){r("Message HMAC is invalid: "+e)})})}else e.body.assertedIdentity=!0,n(e);else e.body.assertedIdentity=!0,n(e)}):r("wrong message to decrypt")})})}},{key:"decryptDataObject",value:function(e,t){var n=this;return new Promise(function(r,o){if(!n.isToUseEncryption)return r(e);var i=Object(ue.z)(t);n.storageManager.get("dataObjectSessionKeys").then(function(t){var s=(t=Object(ue.d)(t))?t[i]:null;if(!s)return o("No dataObjectKey for this dataObjectURL:",i);if(!s.isToEncrypt)return r(e);var a=Object(ue.h)(e.iv),c=Object(ue.h)(e.value);n.crypto.decryptAES(s.sessionKey,c,a).then(function(e){var t={value:Object(ue.x)(e),iv:Object(ue.m)(a)};return r(t)}).catch(function(e){o("On decryptDataObject from method encryptAES error: "+e)})})})}},{key:"_doMutualAuthenticationPhase1",value:function(e){var t=this;return new Promise(function(n,r){var o=e.to.split("/");o.pop();var i=o[0]+"//"+o[2]+"/"+o[3];t._doMutualAuthenticationPhase2(i,e.body.subscriber).then(function(){t._registry.registerSubscriber(i,e.body.subscriber),n()},function(e){r(e)})})}},{key:"_doMutualAuthenticationPhase2",value:function(e,t){Xt.info("doMutualAuthentication:sender ",e),Xt.info("doMutualAuthentication:receiver ",t);var n=this;return new Promise(function(r,o){var i,s=n._registry.getReporterURLSynchonous(e);s&&(i=e,e=s);var a={to:t,from:e,callback:void 0,body:{handshakePhase:"startHandShake",ignore:"ignoreMessage"}};if(!e||!t)return o("sender or receiver missing on doMutualAuthentication");var c=n.chatKeys[e+"<->"+t],u=n._registry.getHypertyOwner(e);if(u)if(c||(a.callback=function(e){r(e)},a.dataObjectURL=i,c=n._newChatCrypto(a,u),n.chatKeys[e+"<->"+t]=c),c.authenticated){var l={to:e,from:t};c.dataObjectURL=i,n._sendReporterSessionKey(l,c).then(function(e){n._messageBus.postMessage(e.message),r("exchange of chat sessionKey initiated")}).catch(function(e){o("On doMutualAuthentication from method _sendReporterSessionKey error: "+e)})}else n._doHandShakePhase(a,c);else o("Mutual authentication error: Hyperty owner could not be resolved")})}},{key:"_sendReporterSessionKey",value:function(e,t){var n=this;return new Promise(function(r,o){var i,s,a,c,u=n.dataObjectSessionKeys[t.dataObjectURL],l={};if(u)a=u.sessionKey;else{a=n.crypto.generateRandom(),n.dataObjectSessionKeys[t.dataObjectURL]={sessionKey:a,isToEncrypt:!0};var f=Object(ue.e)(n.dataObjectSessionKeys);n.storageManager.set("dataObjectSessionKeys",0,f).catch(function(e){o("On _sendReporterSessionKey from method storageManager.set(dataObjectSessionKeys...) error: "+e)})}try{s=Object(ue.m)({value:Object(ue.m)(a),dataObjectURL:t.dataObjectURL})}catch(e){return o("On _sendReporterSessionKey from method storageManager.set error valueToEncrypt: "+e)}c=n.crypto.generateIV(),l.iv=Object(ue.m)(c),n.crypto.encryptAES(t.keys.hypertyFromSessionKey,s,c).then(function(r){i={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"reporterSessionKey",value:Object(ue.m)(r)}};var o=n._filterMessageToHash(i,s+c,t.hypertyFrom.messageInfo);return n.crypto.hashHMAC(t.keys.hypertyFromHashKey,o)}).then(function(e){var n=Object(ue.m)({value:i.body.value,hash:Object(ue.m)(e),iv:l.iv});i.body.value=n,r({message:i,chatKeys:t})}).catch(function(e){o("On _sendReporterSessionKey from chained promises encryptAES error: "+e)})})}},{key:"_resolveDomain",value:function(e){return e?"domain-idp://"+e:"domain-idp://google.com"}},{key:"_doHandShakePhase",value:function(e,t){var n=this;return new Promise(function(r,o){var i,s,a,c,u=e.body.handshakePhase,l={};switch(Xt.info("handshake phase: ",u),u){case"startHandShake":t.keys.fromRandom=n.crypto.generateRandom();var f={type:"handshake",to:e.to,from:e.from,body:{handshakePhase:"senderHello",value:Object(ue.m)(t.keys.fromRandom)}};t.handshakeHistory.senderHello=n._filterMessageToHash(f,void 0,t.hypertyFrom.messageInfo),t.initialMessage?r({message:f,chatKeys:t}):(n.chatKeys[e.from+"<->"+e.to]=t,n._messageBus.postMessage(f));break;case"senderHello":Xt.log("senderHello"),t.handshakeHistory.senderHello=n._filterMessageToHash(e),t.keys.fromRandom=Object(ue.h)(e.body.value),t.keys.toRandom=n.crypto.generateRandom();var d={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverHello",value:Object(ue.m)(t.keys.toRandom)}};t.handshakeHistory.receiverHello=n._filterMessageToHash(d,void 0,t.hypertyFrom.messageInfo),r({message:d,chatKeys:t});break;case"receiverHello":Xt.log("receiverHello"),n.getMyPrivateKey().then(function(r){return c=r,t.handshakeHistory.receiverHello=n._filterMessageToHash(e),n._idm.validateAssertion(e.body.identity.assertion,void 0,e.body.identity.idp.domain)}).then(function(r){var o="string"==typeof r.contents?r.contents:r.contents.nonce,i=Object(ue.A)(o),s=n.crypto.generatePMS(),a=e.body.value;t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=i,t.hypertyTo.userID=e.body.identity.userProfile.userURL,t.keys.toRandom=Object(ue.h)(a),t.keys.premasterKey=s;var c=n.crypto.concatPMSwithRandoms(s,t.keys.toRandom,t.keys.fromRandom);return n.crypto.generateMasterSecret(c,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){return t.keys.masterKey=e,n.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom)}).then(function(r){t.keys.hypertyToSessionKey=new Uint8Array(r[0]),t.keys.hypertyFromSessionKey=new Uint8Array(r[1]),t.keys.hypertyToHashKey=new Uint8Array(r[2]),t.keys.hypertyFromHashKey=new Uint8Array(r[3]),i=n.crypto.generateIV(),l.iv=Object(ue.m)(i);var o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}};return a=n._filterMessageToHash(o,"ok"+i,t.hypertyFrom.messageInfo),n.crypto.hashHMAC(t.keys.hypertyFromHashKey,a)}).then(function(e){return l.hash=Object(ue.m)(e),n.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok",i)}).then(function(e){return l.symetricEncryption=Object(ue.m)(e),n.crypto.encryptRSA(t.hypertyTo.publicKey,t.keys.premasterKey)}).then(function(r){l.assymetricEncryption=Object(ue.m)(r);var o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}},i=n._filterMessageToHash(o,t.keys.premasterKey,t.hypertyFrom.messageInfo);return n.crypto.signRSA(c,Object(ue.m)(t.handshakeHistory)+Object(ue.m)(i))}).then(function(o){l.signature=Object(ue.m)(o);var s={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate",value:Object(ue.m)(l)}};t.handshakeHistory.senderCertificate=n._filterMessageToHash(s,"ok"+i,t.hypertyFrom.messageInfo),r({message:s,chatKeys:t})},function(e){return o(e)});break;case"senderCertificate":Xt.log("senderCertificate");var h=Object(ue.g)(e.body.value);n.getMyPrivateKey().then(function(t){return c=t,n._idm.validateAssertion(e.body.identity.assertion,void 0,e.body.identity.idp.domain)}).then(function(r){var o=Object(ue.h)(h.assymetricEncryption),i="string"==typeof r.contents?r.contents:r.contents.nonce,s=Object(ue.A)(i);return t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=s,t.hypertyTo.userID=e.body.identity.userProfile.userURL,n.crypto.decryptRSA(c,o)},function(e){o("Error during authentication of identity: ",e.message)}).then(function(r){t.keys.premasterKey=new Uint8Array(r);var o=Object(ue.h)(h.signature),i=n._filterMessageToHash(e,t.keys.premasterKey);return n.crypto.verifyRSA(t.hypertyTo.publicKey,Object(ue.m)(t.handshakeHistory)+Object(ue.m)(i),o)}).then(function(e){var r=n.crypto.concatPMSwithRandoms(t.keys.premasterKey,t.keys.toRandom,t.keys.fromRandom);return n.crypto.generateMasterSecret(r,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){return t.keys.masterKey=e,n.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){t.keys.hypertyFromSessionKey=new Uint8Array(e[0]),t.keys.hypertyToSessionKey=new Uint8Array(e[1]),t.keys.hypertyFromHashKey=new Uint8Array(e[2]),t.keys.hypertyToHashKey=new Uint8Array(e[3]),i=Object(ue.h)(h.iv);var r=Object(ue.h)(h.symetricEncryption);return n.crypto.decryptAES(t.keys.hypertyToSessionKey,r,i)}).then(function(r){t.handshakeHistory.senderCertificate=n._filterMessageToHash(e,r+i);var o=Object(ue.h)(h.hash);return a=n._filterMessageToHash(e,r+i),n.crypto.verifyHMAC(t.keys.hypertyToHashKey,a,o)}).then(function(r){var o={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage"}};return i=n.crypto.generateIV(),l.iv=Object(ue.m)(i),a=n._filterMessageToHash(o,"ok!"+i,t.hypertyFrom.messageInfo),n.crypto.hashHMAC(t.keys.hypertyFromHashKey,a)}).then(function(e){return l.hash=Object(ue.m)(e),n.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!",i)}).then(function(o){l.value=Object(ue.m)(o);var s={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage",value:Object(ue.m)(l)}};t.handshakeHistory.receiverFinishedMessage=n._filterMessageToHash(s,"ok!"+i,t.hypertyFrom.messageInfo),t.authenticated=!0,r({message:s,chatKeys:t})}).catch(function(e){o("On _doHandShakePhase from senderCertificate error: "+e)});break;case"receiverFinishedMessage":t.authenticated=!0,l=Object(ue.g)(e.body.value),i=Object(ue.h)(l.iv);var y=Object(ue.h)(l.value);s=Object(ue.h)(l.hash),n.crypto.decryptAES(t.keys.hypertyToSessionKey,y,i).then(function(a){t.handshakeHistory.receiverFinishedMessage=n._filterMessageToHash(e,a+i);var c=n._filterMessageToHash(e,a+i);n.crypto.verifyHMAC(t.keys.hypertyToHashKey,c,s).then(function(i){if(t.initialMessage){var s={type:"create",to:e.from,from:e.to,body:{value:t.initialMessage.body.value}};r({message:s,chatKeys:t})}else n._sendReporterSessionKey(e,t).then(function(e){r(e)}).catch(function(e){o("On _doHandShakePhase from receiverFinishedMessage error: "+e)})})});break;case"reporterSessionKey":Xt.log("reporterSessionKey");var p=Object(ue.g)(e.body.value);s=Object(ue.h)(p.hash),i=Object(ue.h)(p.iv);var v,b,g,m,_=Object(ue.h)(p.value);n.crypto.decryptAES(t.keys.hypertyToSessionKey,_,i).then(function(r){v=Object(ue.g)(r),b=Object(ue.h)(v.value),g=v.dataObjectURL;var o=n._filterMessageToHash(e,r+i);return n.crypto.verifyHMAC(t.keys.hypertyToHashKey,o,s)}).then(function(e){n.dataObjectSessionKeys[g]={sessionKey:b,isToEncrypt:!0};var r=Object(ue.e)(n.dataObjectSessionKeys);return n.storageManager.set("dataObjectSessionKeys",0,r).catch(function(e){o("On _sendReporterSessionKey from method reporterSessionKey error: "+e)}),i=n.crypto.generateIV(),l.iv=Object(ue.m)(i),n.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!!",i)}).then(function(r){m={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverAcknowledge"}},l.value=Object(ue.m)(r);var o=n._filterMessageToHash(m,"ok!!"+i,t.hypertyFrom.messageInfo);return n.crypto.hashHMAC(t.keys.hypertyFromHashKey,o)}).then(function(e){var n=Object(ue.m)({value:l.value,hash:Object(ue.m)(e),iv:l.iv});m.body.value=n,r({message:m,chatKeys:t})}).catch(function(e){o("On _doHandShakePhase from reporterSessionKey error: "+e)});break;case"receiverAcknowledge":Xt.log("receiverAcknowledge");var w=Object(ue.g)(e.body.value),O=Object(ue.h)(w.hash);i=Object(ue.h)(w.iv);var k=Object(ue.h)(w.value);n.crypto.decryptAES(t.keys.hypertyToSessionKey,k,i).then(function(r){var o=n._filterMessageToHash(e,r+i);return n.crypto.verifyHMAC(t.keys.hypertyToHashKey,o,O)}).then(function(e){var n=t.callback;n&&n("handShakeEnd"),r("handShakeEnd")}).catch(function(e){o("On _doHandShakePhase from receiverAcknowledge error: "+e)});break;default:o(e)}})}},{key:"_filterMessageToHash",value:function(e,t,n){return{type:e.type,from:e.from,to:e.to,body:{identity:n||e.body.identity,value:t||e.body.value,handshakePhase:e.body.handshakePhase}}}},{key:"_newChatCrypto",value:function(e,t,n){var r=n?e.to:e.from,o=n?e.from:e.to,i=this._idm.getIdentity(t);return{hypertyFrom:{hyperty:r,userID:i.userProfile.userURL,assertion:i.assertion,messageInfo:i},hypertyTo:{hyperty:o,userID:void 0,publicKey:void 0,assertion:void 0},keys:{hypertyToSessionKey:void 0,hypertyFromSessionKey:void 0,hypertyToHashKey:void 0,hypertyFromHashKey:void 0,toRandom:void 0,fromRandom:void 0,premasterKey:void 0,masterKey:void 0},handshakeHistory:{senderHello:void 0,receiverHello:void 0,senderCertificate:void 0,receiverFinishedMessage:void 0},initialMessage:e.body.ignore?void 0:e,callback:e.callback,authenticated:!1,dataObjectURL:e.dataObjectURL}}},{key:"getMyPublicKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.userDefaultKeyRef,t=this;return new Promise(function(n,r){t.storageManager.get(e).then(function(o){if(o)return n(o.public);t._generateAndStoreNewAsymetricKey(e).then(function(e){n(e.public)}).catch(function(e){Xt.error("[getMyPublicKey:_generateAndStoreNewAsymetricKey:err]: "+e.message),r(e)})}).catch(function(e){Xt.error("[getMyPublicKey:storageManager:err]: "+e.message),r(e)})})}},{key:"getMyPrivateKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.userDefaultKeyRef,t=this;return new Promise(function(n,r){t.storageManager.get(e).then(function(o){if(o)return n(o.private);t._generateAndStoreNewAsymetricKey(e).then(function(e){n(e.private)}).catch(function(e){Xt.error("[getMyPrivateKey:_generateAndStoreNewAsymetricKey:err]: "+e.message),r(e)})}).catch(function(e){Xt.error("[getMyPrivateKey:storageManager:err]: "+e.message),r(e)})})}},{key:"_generateAndStoreNewAsymetricKey",value:function(e){var t=this,n=void 0;return new Promise(function(r,o){var i={};i.private=Object(ue.n)(),i.public=Object(ue.n)(),Xt.log("_generateAndStoreNewAsymetricKey:userAsymmetricKeyGenerated",i),n=i,t.storageManager.set(e,0,i),r(n)}).catch(function(e){Xt.error("[_generateAndStoreNewAsymetricKey:err]: "+e.message),reject(e)})}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){this._messageBus=e,this.addCryptoGUIListeners()}},{key:"coreDiscovery",get:function(){return this._coreDiscovery},set:function(e){this._coreDiscovery=e}},{key:"registry",get:function(){return this._registry},set:function(e){this._registry=e}}]),e}());function en(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n(31);var tn=de.getLogger("Loader"),nn=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!n)throw Error("[Runtime.Loader] The descriptor need to know the runtime configuration");if(!r)throw Error("[Runtime.Loader] The descriptor need to know the runtime Descriptor instance");this.log=tn,this.runtimeConfiguration=n,this.descriptors=r}return function(e,t,n){t&&en(e.prototype,t)}(e,[{key:"loadHyperty",value:function(e){var t,n,r=this,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;if(arguments.length>3&&arguments[3],!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader] hypertyClass parameter is needed");var s=!1,a=new e,c=a.name;return new Promise(function(e,u){var l=function(e){s=!0,u(e)};tn.info("[Runtime.Loader.loadHyperty] ",c);var f=a.descriptor;f.dataObjects[0]=f.dataObjects[0].replace("%domain%",r._registry._domain),tn.info("[Runtime.Loader] 1: return hyperty descriptor: ",f),n=r.registry.getAppSandbox(),r._addressAllocation.create(r._registry._domain,1,f,"hyperty",o).then(function(e){return!s&&(tn.info("[Runtime.Loader] 6: return the addresses for the hyperty",e),r.registry.registerHyperty(n,c,f,e,i))},l).then(function(e){if(s)return!1;tn.info("[Runtime.Loader] 7: registration result",e),t=e.url;var o={};if(!Object(ue.l)(f.configuration))try{o=Object.assign({},JSON.parse(f.configuration))}catch(e){o=f.configuration}o.runtimeURL=r._runtimeURL,e.p2pHandler&&(o.p2pHandler=e.p2pHandler,o.p2pRequester=e.p2pRequester);try{return n.deployComponent(a,t,o)}catch(e){tn.info("[Runtime.Loader] Error on deploy component:",e),u(e)}},l).then(function(o){if(s)return!1;tn.info("[Runtime.Loader] 8: Deploy component status for hyperty: ",o),r.messageBus.addListener(t,function(e){n.postMessage(e)}),r.messageBus.addListener(r.runtimeURL+"/status",function(e){n.postMessage(e)});var i={runtimeHypertyURL:t,status:o,name:c,instance:a};tn.info("[Runtime.Loader] Hyperty deployed: ",i),e(a),tn.info("[Runtime.Loader] ------------------ END ------------------------")},l).catch(function(e){tn.info("[Runtime.Loader] Something failed on the deploy hyperty: ",e),u(e)})})}},{key:"loadStub",value:function(e,t){var n=this;if(!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader.loadStub]ProtoStub descriptor url parameter is needed");return new Promise(function(r,o){var i,s,a,c,u=Object(ue.k)(e).domain;u||(u=e);var l,f,d=!1,h=function(e){tn.info("[Runtime.Loader.loadStub]Something failed on the deploy of protocolstub: ",e),o(e)},y=function(e){d=!0,o(e)},p={};tn.info("[Runtime.Loader.loadStub] starting loading for ",e," with p2pconfig ",t),tn.info("[Runtime.Loader.loadStub]Discover or Create a new ProtoStub for domain: ",u);try{if(t)if(t.hasOwnProperty("isHandlerStub")&&t.isHandlerStub)l=n.runtimeURL,f=n.registry.discoverP2PStub();else{var v=t.remoteRuntimeURL;l=v,f=n.registry.discoverP2PStub(v)}else l=u,f=n.registry.discoverProtostub(u);tn.info("[Runtime.Loader.loadStub]1. Proto Stub Discovered for ",e,": ",f),r(f),tn.info(" [Runtime.Loader]------------------- END ---------------------------\n")}catch(f){tn.info("[Runtime.Loader.loadStub]1. Proto Stub not found "+f),n.descriptors.getStubDescriptor(e).then(function(e){if(d)return!1;tn.info("[Runtime.Loader.loadStub]2. return the ProtoStub descriptor"),s=e;var t=e.sourcePackageURL;return"/sourcePackage"===t?e.sourcePackage:n.runtimeCatalogue.getSourcePackageFromURL(t)},y).catch(h).then(function(e){return!d&&(s&&s.constraints&&(p=s.constraints),tn.info("[Runtime.Loader.loadStub]3. return the ProtoStub Source Code"),c=e,n.registry.getSandbox(u,p))}).then(function(e){return!d&&(tn.info("[Runtime.Loader.loadStub]4. if the sandbox is registered then return the sandbox ",e),i=e,e)}).catch(function(e){return!d&&(tn.info("[Runtime.Loader.loadStub]5. Sandbox was not found, creating a new one ",e),n._runtimeFactory.createSandbox(p).then(function(e){return e.addListener("*",function(e){n.messageBus.postMessage(e)}),e}))}).then(function(r){return!d&&(tn.info("[Runtime.Loader.loadStub]6. return the sandbox instance and register",r,"to domain ",u),i=r,n.registry.registerStub(i,l,t,e,s))},y).then(function(e){if(d)return!1;tn.info("[Runtime.Loader.loadStub] 7. return the runtime protostub url: ",e),a=e.url;var r={};if(!Object(ue.l)(s.configuration))try{r=Object.assign({},JSON.parse(s.configuration))}catch(e){r=s.configuration}if(t)try{r=Object.assign(r,JSON.parse(t))}catch(e){r=Object.assign(r,t)}r.runtimeURL=n._runtimeURL;try{return tn.info("[Runtime.Loader.loadStub] 8: adding sandbox listener to protostubURL : ",a),n.messageBus.addListener(a,function(e){i.postMessage(e)}),i.deployComponent(c.sourceCode,a,r)}catch(e){tn.error("[Runtime.Loader.loadStub] Error on deploy component:",e),o(e)}},y).then(function(){if(d)return!1;var e;t?(tn.log("[Runtime.Loader.loadStub] p2pConfig: ",t),t.hasOwnProperty("isHandlerStub")&&(e=n.registry.p2pHandlerStub[n._runtimeURL]),t.hasOwnProperty("p2pRequesterStub")&&(e=n.registry.p2pRequesterStub[t.remoteRuntimeURL])):e=n.registry.protostubsList[u],tn.log("[Runtime.Loader.loadStub] Stub: ",e),r(e),tn.info("[Runtime.Loader.loadStub]------------------- END ---------------------------\n")},y).catch(h)}})}},{key:"loadIdpProxy",value:function(e){var t=this;if(!this._readyToUse())return!1;if(!e)throw new Error("[Runtime.Loader] IdpProxy descriptor url parameter is needed");return new Promise(function(n,r){var o,i,s,a,c=Object(ue.k)(e).domain;c||(c=e);var u=!1,l=function(e){u=!0,r(e)};tn.info("[Runtime.Loader] ------------------- IDP Proxy Deploy ---------------------------\n"),tn.info("[Runtime.Loader] Discover or Create a new IdpProxy for domain/URL: ",c);try{var f=t.registry.discoverIdpProxy(c);tn.info("[Runtime.Loader] 1. IDPProxy Discovered: ",f);var d=t.registry.idpProxyList[c];tn.log("Deployed: ",d),n(d),tn.info("[Runtime.Loader] ------------------- END ---------------------------\n")}catch(f){tn.info("[Runtime.Loader] 1. IdpProxy not found:",f),t.descriptors.getIdpProxyDescriptor(e).then(function(e){tn.info("[Runtime.Loader] 2. Return the IDPProxy descriptor"),i=e;var n=e.sourcePackageURL;return"/sourcePackage"===n?e.sourcePackage:t.runtimeCatalogue.getSourcePackageFromURL(n)},l).then(function(e){return!u&&(tn.info("[Runtime.Loader] 3. return the IDPProxy source package"),a=e,!0)},l).then(function(e){return!u&&t.registry.getSandbox(c)}).then(function(e){return!u&&(tn.info("[Runtime.Loader] 4. if the sandbox is registered then return the sandbox",e),o=e,e)}).catch(function(e){return!u&&(tn.info("[Runtime.Loader] 5. Sandbox was not found, creating a new one",e),i&&i.hasOwnProperty("capabilities")&&(i=i.stubCapabilities),t._runtimeFactory.createSandbox({}).then(function(e){return e.addListener("*",function(e){t.messageBus.postMessage(e)}),e}))}).then(function(e){return!u&&(tn.info("[Runtime.Loader] 6. return the sandbox instance and register",e,"to domain ",c),o=e,t.registry.registerIdpProxy(e,c))},l).then(function(e){if(u)return!1;tn.info("[Runtime.Loader] 7. Return the runtime Idp Proxy URL: ",e),s=e;var n={};if(!Object(ue.l)(i.configuration))try{n=Object.assign({},JSON.parse(i.configuration))}catch(e){n=i.configuration}n.runtimeURL=t._runtimeURL;try{return t.messageBus.addListener(s,function(e){o.postMessage(e)}),o.deployComponent(a.sourceCode,e,n)}catch(e){tn.info("[Runtime.Loader] Error on deploy component:",e),r(e)}},l).then(function(){if(u)return!1;var e=t.registry.idpProxyList[c];tn.log("[Runtime.Loader.loadIdpProxy] 8: loaded: ",e),n(e),tn.info("[Runtime.Loader.loadIdpProxy] ------------------- END ---------------------------\n")},l).catch(function(e){tn.info("[Runtime.Loader] Something failed on the deploy of IdpProxy: ",e),r(e)})}})}},{key:"_readyToUse",value:function(){if(!this._runtimeURL)throw new Error("[Runtime.Loader] The loader need the runtime url address");if(!this._messagesBus)throw new Error("[Runtime.Loader] The loader need the messageBus component");if(!this._registry)throw new Error("[Runtime.Loader] The loader need the registry component");if(!this._runtimeFactory)throw new Error("[Runtime.Loader] The loader need the runtime factory component");return!0}},{key:"runtimeURL",set:function(e){this._runtimeURL=e},get:function(){return this._runtimeURL}},{key:"registry",set:function(e){this._registry=e;var t=qe.instance;this._addressAllocation=t,tn.log("[Loader - AddressAllocation] - ",t)},get:function(){return this._registry}},{key:"messageBus",set:function(e){this._messagesBus=e},get:function(){return this._messagesBus}},{key:"runtimeFactory",set:function(e){this._runtimeFactory=e},get:function(){return this._runtimeFactory}}]),e}(),rn={};function on(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!t)throw new Error("The runtime factory is a needed parameter");var i=o||vt.remoteStorage;return t.storageManager(e,n,r,i)}function sn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var an=de.getLogger("Descriptors"),cn=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("The descriptor need to know the runtime url to be used");if(!n)throw Error("The descriptor needs the catalogue instance");if(!r)throw Error("The descriptor needs the runtime configuration");this.log=an,this.runtimeConfiguration=r,this.runtimeURL=t,this.catalogue=n,this.constraints=He.runtimeCapabilities}return function(e,t,n){t&&sn(e.prototype,t)}(e,[{key:"getHypertyDescriptor",value:function(e){return this.catalogue.getHypertyDescriptor(e,!0,this.constraints)}},{key:"getStubDescriptor",value:function(e){var t=this;return new Promise(function(n,r){var o,i,s,a=Object(ue.k)(t.runtimeURL).domain;if(e.includes("://")){var c=Object(ue.k)(e);o=c.domain;var u=c.identity;i=u?u.substring(u.lastIndexOf("/")+1):"default"}else i="default",o=e;if(s=Object(ue.c)(t.runtimeConfiguration,"catalogueURLs","protocolstub",i),o!==t.runtimeConfiguration.domain)if(e.indexOf("https")&&e.indexOf("hyperty-catalogue")){var l=Object(ue.o)(t.runtimeConfiguration,"catalogueURLs","protocolstub");s=l.prefix+o+l.suffix+i}else s=e;return an.log("Load ProtocolStub for domain, "+o+" : ",s),t.catalogue.getStubDescriptor(s,!0,t.constraints).then(function(e){n(e)}).catch(function(e){i=o,o=a;var n=Object(ue.o)(t.runtimeConfiguration,"catalogueURLs","protocolstub");return s=n.prefix+o+n.suffix+i,t.catalogue.getStubDescriptor(s,!0,t.constraints)}).then(function(e){n(e)}).catch(function(e){r(e)})})}},{key:"getIdpProxyDescriptor",value:function(e){var t=this;return new Promise(function(n,r){var o,i,s=Object(ue.k)(t.runtimeURL).domain,a=t.constraints;if(a.constraints.onlyAccessToken=!0,a.constraints.onlyIdAssertionValidation=!0,console.log("LOG HERE",a),e.includes("://")){var c=Object(ue.k)(e);o=c.domain;var u=c.identity;i=u?u.substring(u.lastIndexOf("/")+1):"default"}else i="default",o=e;var l=Object(ue.o)(t.runtimeConfiguration,"catalogueURLs","idpProxy");return e=l.prefix+o+l.suffix+i,t.catalogue.getIdpProxyDescriptor(e,!0,a).then(function(e){n(e)}).catch(function(){return i=o,o=s,e=Object(ue.c)(t.runtimeConfiguration,"catalogueURLs","idpProxy",i),t.catalogue.getIdpProxyDescriptor(e,!0,a)}).then(function(e){n(e)}).catch(function(e){r(e)})})}}]),e}();function un(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ln=de.getLogger("RuntimeUA"),fn=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw Error("[MsgBusHandlers] pep input paramenter is mandatory");if(!n)throw Error("[MsgBusHandlers] idm input paramente is mandatory");if(!r)throw Error("[MsgBusHandlers] crypto input paramente is mandatory");this.policyEngine=t,this.identityManager=n,this.cryptoManager=r}return function(e,t,n){t&&un(e.prototype,t)}(e,[{key:"pepInHandler",get:function(){var e=this;return function(t){e.policyEngine.authorise(t.msg,!0).then(function(e){t.msg=e,t.next()}).catch(function(e){ln.error(e),t.fail(e)})}}},{key:"pepOutHandler",get:function(){var e=this;return function(t){e.policyEngine.authorise(t.msg,!1).then(function(e){t.msg=e,t.next()}).catch(function(e){ln.error(e),t.fail(e)})}}},{key:"idmHandler",get:function(){var e=this;return function(t){e.identityManager.processMessage(t.msg).then(function(e){t.msg=e,t.next()}).catch(function(e){ln.error(e),t.fail(e)})}}},{key:"encryptHandler",get:function(){var e=this;return function(t){e.cryptoManager.encryptMessage(t.msg).then(function(e){t.msg=e,t.next()}).catch(function(e){ln.error(e),t.fail(e)})}}},{key:"decryptHandler",get:function(){var e=this;return function(t){e.cryptoManager.decryptMessage(t.msg).then(function(e){t.msg=e,t.next()}).catch(function(e){ln.warn(e),t.fail(e)})}}}]),e}();function dn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var hn=de.getLogger("CoreDiscovery"),yn=function(){function e(t,n,r,o,i){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!o)throw Error("The catalogue needs the runtimeFactory");var s=this;this._messageBus=n,s.graphConnector=r,s.httpRequest=o.createHttpRequest(),s.domain=Object(ue.k)(t).domain,s.discoveryURL=t+"/discovery/",s.registry=i,s.messageBus.addListener(s.discoveryURL,function(e){s.discoveryManager(e).then(function(t){s.messageBus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:t}})}).catch(function(t){var n,r;"GraphConnector"===t?(n="This search is not available at the moment. Try later.",r=500):(n="Not Found",r=404),s.messageBus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:r,description:n}})})})}return function(e,t,n){t&&dn(e.prototype,t)}(e,[{key:"discoveryManager",value:function(e){Object(ue.k)(e.from).domain;var t=e.body.resource.split("/").filter(Boolean),n=[],r=[];switch(hn.log("[CoreDiscovery.discoveryManager] received: ",e),e.body.criteria&&(e.body.criteria.resources&&(n=e.body.criteria.resources),e.body.criteria.dataSchemes&&(r=e.body.criteria.dataSchemes)),t[1]){case"user":return"hyperty"==t[0]?this.discoverHyperties(e.body.resource.split("user/")[1],r,n,e.body.criteria.domain):this.discoverDataObjects(e.body.resource.split("user/")[1],r,n,e.body.criteria.domain);case"url":return"hyperty"==t[0]?this.discoverHypertyPerURL(e.body.resource.split("url/")[1],e.body.criteria.domain):this.discoverDataObjectPerURL(e.body.resource.split("url/")[1],e.body.criteria.domain);case"name":return this.discoverDataObjectsPerName(e.body.resource.split("name/")[1],r,n,e.body.criteria.domain);case"reporter":return this.discoverDataObjectsPerReporter(e.body.resource.split("reporter/")[1],r,n,e.body.criteria.domain);case"guid":return void 0!==this.graphConnector&&null!==this.graphConnector?"hyperty"==t[0]?this.discoverHypertiesPerGUID(e.body.resource.split("user-guid://")[1],r,n):this.discoverDataObjectsPerGUID(e.body.resource.split("user-guid://")[1],r,n):Promise.reject("GraphConnector");case"userprofile":return void 0!==this.graphConnector&&null!==this.graphConnector?"hyperty"==t[0]?this.discoverHypertiesPerUserProfileData(e.body.resource.split("userprofile/")[1],r,n):this.discoverDataObjectsPerUserProfileData(e.body.resource.split("userprofile/")[1],r,n):Promise.reject("GraphConnector")}}},{key:"discoverHypertiesPerUserProfileData",value:function(e,t,n){var r=this;return new Promise(function(o,i){r.discoverGUIDPerUserIdentifier(e).then(function(e){var s=e.map(function(e){return new Promise(function(o,i){r.discoverHypertiesPerGUID(e,t,n).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(s).then(function(e){var t=[].concat.apply([],e);if(0===t.length)return i("No hyperties were found");o(t)})}).catch(function(e){return i(e)})})}},{key:"discoverDataObjectsPerUserProfileData",value:function(e,t,n){var r=this;return new Promise(function(o,i){r.discoverGUIDPerUserIdentifier(e).then(function(e){var s=e.map(function(e){return new Promise(function(o,i){r.discoverDataObjectsPerGUID(e,t,n).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(s).then(function(e){var t=[].concat.apply([],e);if(0===t.length)return i("No dataObjects were found");o(t)})}).catch(function(e){return i(e)})})}},{key:"discoverHypertiesPerGUID",value:function(e,t,n){var r=this;return new Promise(function(o,i){r.discoverUserIdsPerGUID(e).then(function(e){var s=e.map(function(e){return new Promise(function(o,i){r.discoverHyperties(e.uID,t,n,e.domain).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(s).then(function(e){var t=[].concat.apply([],e);if(0===t.length)return i("No hyperties were found");o(t)})}).catch(function(e){return i(e)})})}},{key:"discoverDataObjectsPerGUID",value:function(e,t,n){var r=this;return new Promise(function(o,i){r.discoverUserIdsPerGUID(e).then(function(e){var s=e.map(function(e){return new Promise(function(o,i){r.discoverDataObjects(e.uID,t,n,e.domain).then(function(e){o(e)}).catch(function(e){o([])})})});Promise.all(s).then(function(e){var t=[].concat.apply([],e);if(0===t.length)return i("No dataObjects were found");o(t)})}).catch(function(e){return i(e)})})}},{key:"discoverHyperties",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:"domain://registry."+o,body:{}};return e.indexOf("user://")>-1?s.body.resource=e:s.body.resource="/hyperty/idp-identifier/"+e,t.length>0&&(s.body.criteria||(s.body.criteria={}),s.body.criteria.dataSchemes=t),n.length>0&&(s.body.criteria||(s.body.criteria={}),s.body.criteria.resources=n),new Promise(function(e,t){i.messageBus.postMessage(s,function(n){if(200!==n.body.code&&500!==n.body.code)return t("No Hyperty was found");var r=n.body.value,o=[];for(var i in r)o.push(r[i]);if(!(o.length>0))return t("No Hyperty was found");e(o)})})}},{key:"discoverDataObjects",value:function(e,t,n,r){var o,i=this,s=[];return o=r||i.domain,new Promise(function(r,a){i.discoverHyperties(e,[],[],o).then(function(e){var c=[];for(var u in e)c.push(e[u]);var l=c.map(function(e){return new Promise(function(r,s){i.discoverDataObjectsPerReporter(e.hypertyID,t,n,o).then(function(e){r(e)}).catch(function(e){r([])})})});Promise.all(l).then(function(e){[].concat.apply([],e).forEach(function(e){s.push(e)});var t=[];for(var n in s)t.push(s[n]);if(0===t.length)return a("No dataObjects were found");r(t)})}).catch(function(e){return a(e)})})}},{key:"discoverHypertyPerURL",value:function(e,t){var n,r=this;n=t||r.domain;var o={type:"read",from:r.discoveryURL,to:"domain://registry."+n,body:{resource:e}};return new Promise(function(e,t){r.messageBus.postMessage(o,function(n){if(200!==n.body.code&&500!==n.body.code)return t("No Hyperty was found");var r=n.body.value;if(!r)return t("No Hyperty was found");e(r)})})}},{key:"discoverDataObjectPerURL",value:function(e,t){var n,r=this;n=t||r.domain;var o={type:"read",from:r.discoveryURL,to:"domain://registry."+n,body:{resource:e}};return new Promise(function(e,t){r.messageBus.postMessage(o,function(n){var r=n.body.value;if(!r)return t("DataObject not found");e(r)})})}},{key:"discoverDataObjectsPerName",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:"domain://registry."+o,body:{resource:e}};return t.length>0&&(s.body.criteria||(s.body.criteria={}),s.body.criteria.dataSchemes=t),n.length>0&&(s.body.criteria||(s.body.criteria={}),s.body.criteria.resources=n),new Promise(function(e,t){i.messageBus.postMessage(s,function(n){var r=n.body.value,o=[];for(var i in r)o.push(r[i]);if(!(o.length>0))return t("No DataObject was found");e(o)})})}},{key:"discoverDataObjectsPerReporter",value:function(e,t,n,r){var o,i=this;o=r||i.domain;var s={type:"read",from:i.discoveryURL,to:"domain://registry."+o,body:{resource:"/comm",criteria:{reporter:e}}};return t.length>0&&(s.body.criteria.dataSchemes=t),n.length>0&&(s.body.criteria.resources=n),new Promise(function(e,t){i.messageBus.postMessage(s,function(n){var r=n.body.value,o=[];for(var i in r)o.push(r[i]);if(!(o.length>0))return t("No DataObject was found");e(o)})})}},{key:"discoverUserIdsPerGUID",value:function(e){var t=this;return new Promise(function(n,r){t.graphConnector.queryGlobalRegistry(e).then(function(e){if("string"==typeof e||!e)return r("Unsuccessful discover userIDs by GUID");var t=e.userIDs;if(0===t.length)return r("UserIDs not available");n(t)}).catch(function(e){return r(e)})})}},{key:"discoverGUIDPerUserIdentifier",value:function(e){var t=this;return new Promise(function(n,r){t.httpRequest.get("https://rethink.tlabscloud.com/discovery/rest/discover/lookup?searchquery="+e).then(function(e){var t=JSON.parse(e).results.filter(function(e){return null!=e.rethinkID});if(0===t.length)return r("Unsuccessful discover GUID by user identifier");var o=t.map(function(e){return e.rethinkID});return n(o)}).catch(function(e){return r(e)})})}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){this._messageBus=e}}]),e}();function pn(e){return(pn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var bn=de.getLogger("DataObjectsStorage"),gn=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[Store Data Objects] - Needs the storageManager component");this._storageManager=t,this._storeDataObject=n,this._cache={},this._createSyncDB=on,this._remotes={},this._factory=r,this._table="syncherManager:ObjectURLs",this._remoteStorageTable="dataObjectStorage",this._remoteSchema="url",this._runtimeStatusUpdate=o}return function(e,t,n){t&&vn(e.prototype,t)}(e,[{key:"loadRemote",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=this;return new Promise(function(r,o){var i=[],s=[];n._storageManager.get(null,null,"remotes").then(function(a){bn.info("[StoreDataObjects.loadRemote] remotes: ",a),a||r(),t||(n._remotes=a),bn.info("[StoreDataObjects.loadRemote] loading: ",n._remotes);var c=Object.keys(a);0===c.length&&r(),c.forEach(function(t){var r={},o=t.split("/")[3];r[o]=e._remoteSchema,n._remotes[t]=on(t,e._factory,r,e._runtimeStatusUpdate),i.push(n._remotes[t].get(null,null,o))}),Promise.all(i).then(function(){bn.log("[StoreDataObjects.loadRemote] loaded. Starting init"),Object.keys(n._remotes).forEach(function(e){var t=e.split("/")[3];s.push(n._remotes[e].get(null,null,t))}),Promise.all(s).then(function(t){0===t.length&&r(),t.forEach(function(t){Object.keys(t).forEach(function(r){bn.log("[StoreDataObjects.loadRemote] loaded remote ",t[r]);var o=e._getTypeOfObject(t[r].isReporter);n._storeDataObject||(n._storeDataObject={}),n._storeDataObject.hasOwnProperty(o)||(n._storeDataObject[o]={}),n._storeDataObject[o][r]=t[r]})}),r(n._storeDataObject)},function(e){o(e)})})},function(e){o(e)}),r()})}},{key:"deleteRemotes",value:function(){var e=this;return new Promise(function(t,n){var r=[];e._storageManager.get(null,null,"remotes").then(function(n){bn.info("[StoreDataObjects.deleteRemotes] remotes: ",n),n||t();var o=Object.keys(e._remotes);0===o.length&&t(),o.forEach(function(t){r.push(e._remotes[t].disconnect()),r.push(e._remotes[t].delete())}),Promise.all(r).then(function(){bn.log("[StoreDataObjects.deleteRemotes] deleted."),t()},function(e){t()})}),t()})}},{key:"set",value:function(e){var t=this;return new Promise(function(n,r){var o=t._storeDataObject?t._storeDataObject:{},i=t._getTypeOfObject(e.isReporter);o.hasOwnProperty(i)||(o[i]={}),o[i].hasOwnProperty(e.url)||(o[i][e.url]={},o[i][e.url].subscriptions=[],o[i][e.url].subscriberUsers=[],o[i][e.url].childrenObjects={},o[i][e.url].data={}),Object.assign(o[i][e.url],e),delete o[i][e.url].subscriberUser,delete o[i][e.url].subscriberHyperty,o[i][e.url].backup=!!e.hasOwnProperty("backup")&&e.backup,e.subscriberHyperty&&!e.isReporter&&t._updateToArray(o[i],e.url,"subscriptions",e.subscriberHyperty),e.subscriberUser&&o[i][e.url].subscriberUsers.indexOf(e.subscriberUser)&&t._updateToArray(o[i],e.url,"subscriberUsers",e.subscriberUser),t._storeDataObject=o;var s=!!e.hasOwnProperty("backup")&&e.backup,a=s?e.url:t._table,c=s?a.split("/")[3]:t._table;if(s&&!t._remotes[a]){var u={};u[c]=t._remoteSchema,t._remotes[a]=on(a,t._factory,u,t._runtimeStatusUpdate)}s&&t._storageManager.set(e.url,0,e.url,"remotes");var l=s?t._remotes[a]:t._storageManager;if(e.isReporter&&s){var f={table:c};l.connect(f).then(function(){l.set(a,0,o[i][e.url],c).then(function(){n(o[i][e.url])},function(r){bn.error("[DataObjectStorage.set] failed to save into remote storage: ",r),t._connectToRemoteThread(l,f,a,o[i][e.url],c),n(o[i][e.url])})},function(r){bn.error("[DataObjectStorage.set] failed to connect with remote storage: ",r," trying again..."),t._connectToRemoteThread(l,f,a,o[i][e.url],c),n(o[i][e.url])})}else l.set(a,1,t._filterRemotes(o),c).then(function(){n(o[i][e.url])})})}},{key:"_connectToRemoteThread",value:function(e,t,n,r,o){var i,s=!1;i=setInterval(function(){s||function(r){bn.error("[DataObjectStorage._connectToRemote] trying to connect to remote storage ... "),e.connect(t).then(function(){e.set(n,0,r,o).then(function(){s=!0,clearInterval(i)},function(e){bn.error("[DataObjectStorage._connectToRemote] failed to save into remote storage: ",e)})},function(e){bn.error("[DataObjectStorage._connectToRemote] failed to connect to remote storage: ",e)})}(r)},5e3)}},{key:"_filterRemotes",value:function(e){var t=Object.keys(this._remotes),n=Object(ue.i)(e);return t.forEach(function(e){n.reporters[e]?delete n.reporters[e]:delete n.observers[e]}),console.log("[DataObjectStorage._filterRemotes] ",n),n}},{key:"saveData",value:function(e,t,n,r,o){var i=this._storeDataObject,s=this._getTypeOfObject(e);if(i&&i[s]&&i[s][t]){var a;bn.log("[StoreDataObjects - saveData] - ",e,s,t,n,r),i[s][t].hasOwnProperty("data")||(i[s][t].data={}),n?(a="object"===pn(r)?Object(ue.i)(r):r,Object(ue.a)(i[s][t].data,n,a)):i[s][t].data=Object(ue.i)(r)||{},this._storeDataObject=i;var c=i[s][t].backup?i[s][t].url:"syncherManager:ObjectURLs",u=i[s][t].backup?this._remotes[c]:this._storageManager,l=i[s][t].backup?c.split("/")[3]:this._table,f=i[s][t].backup?i[s][t]:this._filterRemotes(i);u.set(c,1,f,l,o).then(function(){return i[s][t]},function(e){return console.error(e),i[s][t]})}else bn.log("[StoreDataObjects - save data] - not saved")}},{key:"saveChildrens",value:function(e,t,n,r){var o=this._storeDataObject,i=this._getTypeOfObject(e);if(o&&o[i]&&o[i][t]){o[i][t].hasOwnProperty("childrens")||(o[i][t].childrenObjects={}),n?Object(ue.a)(o[i][t].childrenObjects,n,Object(ue.i)(r)):o[i][t].childrenObjects=Object(ue.i)(r)||{},this._storeDataObject=o;var s=o[i][t].backup?o[i][t].url:"syncherManager:ObjectURLs",a=o[i][t].backup?this._remotes[s]:this._storageManager,c=o[i][t].backup?s.split("/")[3]:this._table,u=o[i][t].backup?o[i][t]:this._filterRemotes(o);a.set(s,1,u,c).then(function(){return o[i][t]})}else bn.log("[StoreDataObjects - save childrens] - not saved")}},{key:"update",value:function(e,t,n,r,o){var i=this._storeDataObject,s=this._getTypeOfObject(e);if(i&&i[s]&&i[s][t]){if(bn.log("[StoreDataObjects - update] - ",e,s,t,n,r),i[s]&&i[s][t]&&t&&n&&r){if("subscriptions"===n||"subscriberUsers"===n){var a=!0;"subscriptions"===n&&(a=!this._isOwner(i[s][t],r)),a&&this._updateToArray(i[s],t,n,r)}else i[s][t][n]=r;this._storeDataObject=i;var c=i[s][t].backup?i[s][t].url:"syncherManager:ObjectURLs",u=i[s][t].backup?this._remotes[c]:this._storageManager,l=i[s][t].backup?c.split("/")[3]:this._table,f=i[s][t].backup?i[s][t]:this._filterRemotes(i);u.set(c,1,f,l,o).then(function(){return i[s][t]})}}else bn.log("[StoreDataObjects - update] - not saved")}},{key:"delete",value:function(e,t,n,r){var o=this._storeDataObject,i=this._getTypeOfObject(e);if(o&&o[i]&&o[i][t]){if(o[i]&&o[i][t]&&t&&n&&r){"subscriptions"===n||"subscriberUsers"===n?this._removeFromArray(o[i],t,n,r):delete o[i][t][n],this._storeDataObject=o;var s=o[i][t].backup?o[i][t].url:"syncherManager:ObjectURLs",a=o[i][t].backup?this._remotes[s]:this._storageManager,c=o[i][t].backup?s.split("/")[3]:this._table,u=o[i][t].backup?o[i][t]:this._filterRemotes(o);return a.set(s,1,u,c),o[i][t]}}else bn.log("[StoreDataObjects - delete] - not saved")}},{key:"deleteResource",value:function(e){var t=this,n=this;return new Promise(function(r,o){var i,s,a;if(e)return bn.info("[DataObjectStorage.deleteResource] deleting: ",e),n._storeDataObject.hasOwnProperty("observers")&&n._storeDataObject.observers.hasOwnProperty(e)&&(i=!!n._storeDataObject.observers[e].backup,s=i?n._storeDataObject.observers[e].url:"syncherManager:ObjectURLs",a=i?n._remotes[s]:n._storageManager,delete n._storeDataObject.observers[e]),n._storeDataObject.hasOwnProperty("reporters")&&n._storeDataObject.reporters.hasOwnProperty(e)&&(i=!!n._storeDataObject.reporters[e].backup,s=i?n._storeDataObject.reporters[e].url:"syncherManager:ObjectURLs",a=i?n._remotes[s]:n._storageManager,delete n._storeDataObject.reporters[e]),i&&a?a.delete().then(function(){delete n._remotes[s],n._storageManager.delete(e,null,"remotes")}):a.set(s,1,t._filterRemotes(n._storeDataObject)),r();o(new Error("[StoreDataObjects] - Can't delete this "+e))})}},{key:"getAll",value:function(){var e=this,t=this;return new Promise(function(n,r){t._storeDataObject=e._storageManager.get("syncherManager:ObjectURLs").then(function(e){t._storeDataObject=e,t.loadRemote(!0).then(function(e){n(t._storeDataObject)})})})}},{key:"sync",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this;if(r._remotes[e]){var o=e.split("/")[3];if(t)return r._sync(e,t,n,o);r._remotes[e].getBackupRevision(e).then(function(t){return r._sync(e,t,n,o)})}else{var i="[DataObjectStorage.sync] Info: "+e+" is not synched with remote storage.";bn.info(i)}}},{key:"_sync",value:function(e,t,n,r){var o=this;return console.log("[DataObjectStorage._sync] backupRevision: ",t),new Promise(function(i,s){var a={table:r,observer:!1,syncedRevision:t+3};o._remotes[e].connect(a).then(function(){bn.info("[DataObjectStorage.sync] connected with remote "),o._remotes[e].get(null,null,r).then(function(t){bn.info("[DataObjectStorage.sync] returning synched DO: ",t),n&&setTimeout(function(){o._remotes[e].disconnect().then(function(){bn.info("[DataObjectStorage.sync] disconnected ")},function(e){bn.error("[DataObjectStorage.sync] Error synching with remote storage"),s(e)})},2e3),i(t[e])},function(e){bn.error("[DataObjectStorage.sync] Error retrieving stored data object"),s(e)})},function(t){bn.error("[DataObjectStorage.sync] Error connecting to remote storage ",t),o._remotes[e].get(null,null,r).then(function(t){bn.info("[DataObjectStorage.sync] returning synched DO: ",t),i(t[e])})})})}},{key:"stopSync",value:function(e){this._remotes[e]&&this._remotes[e].disconnect()}},{key:"getDataObject",value:function(e){var t=this;return new Promise(function(n,r){var o,i=t._storeDataObject,s=i.hasOwnProperty("observers")?i.observers:{},a=i.hasOwnProperty("reporters")?i.reporters:{},c=Object.keys(a).find(function(t){return t===e}),u=Object.keys(s).find(function(t){return t===e});return u&&(o=i.observers[u]),c&&(o=i.reporters[c]),bn.info("[StoreDataObjects - getDataObject] - for observer: ",u),bn.info("[StoreDataObjects - getDataObject] - for reporters: ",c),bn.info("[StoreDataObjects - getDataObject] - resolve: ",o),o?n(o):r("No dataObject was found")})}},{key:"getResourcesByCriteria",value:function(e,t){var n=this;return new Promise(function(r){var o=n._getTypeOfObject(t),i=n._storeDataObject;if(!i)return bn.log("[DataObjectsStorage.getResourcesByCriteria] don't have stored data objects"),r(null);if(e.body&&e.body.hasOwnProperty("resume")&&!e.body.resume)return r(null);var s,a=[],c=n._hasSubscription(i[o],e.from),u=n._searchOwner(i[o],e.from),l=n._checkProtostubResume(i,e);if(bn.log("[StoredDataObjects - getResourcesByCriteria]:",i,e,c,u),!(e.hasOwnProperty("from")&&c||u||l))return r(null);s=u?n._getResourcesByOwner(i[o],e.from):n._getResourcesBySubscription(i[o],e.from);var f=[];e.body&&e.body.identity&&(f=n._getResourcesByIdentity(i[o],e.body.identity));var d=[];e.body&&e.body.schema&&(d=n._getResourcesBySchema(i[o],e.body.schema));var h=[];if(e.body&&e.body.value){var y=e.body.value;delete y.data,h=n._getResourcesByMetadata(i[o],y)}var p=[];if(e.body&&e.body.value&&e.body.value.data&&(p=n._getResourcesByData(i[o],e.body.value.data)),0==(a=n._intersection(s,f,d,p,h)).length&&l&&"observers"==o&&e.from.split("protostub").length>0){var v=i[o],b=Object(ue.k)(e.from).domain;Object.keys(v).filter(function(e){v[e].subscriptions.forEach(function(t){Object(ue.k)(t).domain==b&&a.push(e)})})}var g={};a.forEach(function(e){var t=i[o][e];return g[e]=t,g}),bn.log("[Store Data Objects] - ",g),r(g)})}},{key:"_getResourcesByIdentity",value:function(e,t){return e?Object.keys(e).filter(function(n){return e[n].subscriberUsers.filter(function(e){return e===t}).length}):[]}},{key:"_getResourcesByOwner",value:function(e,t){return e?Object.keys(e).filter(function(n){return e[n].reporter===t}):[]}},{key:"_getResourcesBySubscription",value:function(e,t){return e?Object.keys(e).filter(function(n){return e[n].subscriptions.filter(function(e){return e===t}).length}):[]}},{key:"_getResourcesBySchema",value:function(e,t){return Object.keys(e).filter(function(n){var r=e[n];return Object.keys(r).filter(function(e){return"schema"===e&&r[e]===t}).length})}},{key:"_getResourcesByMetadata",value:function(e,t){return t?Object.keys(e).filter(function(n){var r=e[n];return Object.keys(r).filter(function(e){return Object.keys(t).filter(function(n){return e===n&&r[e]===t[n]}).length}).length}):[]}},{key:"_getResourcesByData",value:function(e,t){return t?Object.keys(e).filter(function(n){var r=e[n].hasOwnProperty("data")?e[n].data:{};return Object.keys(r).filter(function(e){return Object.keys(t).filter(function(n){return e===n&&r[e]===t[n]}).length}).length}):[]}},{key:"_hasSubscription",value:function(e,t){return!!e&&Object.keys(e).filter(function(n){return e[n].subscriptions.filter(function(e){return e===t}).length}).length>0}},{key:"_searchOwner",value:function(e,t){return!!e&&Object.keys(e).filter(function(n){return e[n].reporter===t}).length>0}},{key:"_checkProtostubResume",value:function(e,t){if(!e)return!1;if(t.hasOwnProperty("body")&&t.body.hasOwnProperty("value")&&t.body.value.hasOwnProperty("reporter")){var n=t.body.value.reporter;if(e.hasOwnProperty("reporters")){var r=e.reporters;return Object.keys(r).filter(function(e){return r[e].reporter===n}).length>0}return!1}if(e.hasOwnProperty("observers")){var o=e.observers,i=Object(ue.k)(t.from).domain;return Object.keys(o).filter(function(e){var t=!1;if(o[e].subscriptions.forEach(function(e){Object(ue.k)(e).domain==i&&(t=!0)}),t)return!0}).length>0}}},{key:"_isOwner",value:function(e,t){return!!e&&e.reporter===t}},{key:"_intersection",value:function(){var e=Array.from(arguments).reduce(function(e,t){return e.concat(t)}).filter(function(e,t,n){return n.indexOf(e)===t});return bn.log("DataObjectsStorage._intersection] Result an unique array of strings: ",e),e}},{key:"_updateToArray",value:function(e,t,n,r){bn.log("[DataObjectsStorage] - _updateToArray: ",e,t,n,r),-1===e[t][n].indexOf(r)&&e[t][n].push(r)}},{key:"_removeFromArray",value:function(e,t,n,r){var o=e[t][n].indexOf(r);-1===o&&e[t][n].splice(o,1)}},{key:"_hasValue",value:function(e,t,n){return e.hasOwnProperty(t)&&e[t]===n}},{key:"_getTypeOfObject",value:function(e){return e?"reporters":"observers"}}]),e}();function mn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _n=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.flushing=!1,this.Promise=Promise,this.concurrency="number"!=typeof t?1:t,this.promises=[],this.queue=[],this.isProcessing=!1}return function(e,t,n){t&&mn(e.prototype,t)}(e,[{key:"done",value:function(e){this.callback=e}},{key:"add",value:function(e){var t=this;if(this.queue.push(e),!this.isProcessing)return this.queue.reduce(function(e,t){return e.then(function(e){return t.then(function(t){return[].concat(function(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}(e),[t])})})},Promise.resolve([])).then(function(e){t.isProcessing=!1})}}]),e}();function wn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var On=de.getLogger("HypertyResourcesStorage"),kn=function(){function e(t,n,r,o){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!r)throw new Error("[HypertyResourcesStorage constructor] mandatory storageManager parameter missing");if(!t)throw new Error("[HypertyResourcesStorage constructor] mandatory runtimeURL parameter missing");if(!n)throw new Error("[HypertyResourcesStorage constructor] mandatory bus parameter missing");var i=this;i._bus=n,i._storageLimit=.9,i._url=t+"/storage",i._storageManager=r,i.promiseQueue=new _n,i._hypertyResources=o,n.addListener(i._url,function(e){switch(On.info("[HypertyResourcesStorage] Message RCV: ",e),e.type){case"create":i._onCreate(e);break;case"read":i._onRead(e);break;case"delete":i._onDelete(e)}})}return function(e,t,n){t&&wn(e.prototype,t)}(e,[{key:"checkStorageQuota",value:function(){var e=this;return new Promise(function(t,n){if(e._availableQuota&&e._usage)return t(Object(ue.b)(e._usage,e._availableQuota));navigator&&navigator.storage.estimate().then(function(n){e._availableQuota=n.quota,e._usage=n.usage,t(Object(ue.b)(e._usage,e._availableQuota))}).catch(function(e){On.error("[HypertyResourcesStorage] CheckStorageQuota error: ",e),n(e)})})}},{key:"_onCreate",value:function(e){if(!e.body||!e.body.value)throw new Error("[HypertyResourcesStorage._onCreate] mandatory message body value missing: ",e);var t=e.body.value,n=t.contentURL,r="";if(n){var o=n[0],i=o.substr(o.lastIndexOf("/")+1);r=this._url+"/"+i}else n=[],r=this._url+"/"+Object(ue.n)();this._hypertyResources.hasOwnProperty(r)||(n.push(r),t.contentURL=n),this._hypertyResources[r]=t,this.promiseQueue.add(this._toSave(r,e,t))}},{key:"_toSave",value:function(e,t,n){var r=this;return new Promise(function(o,i){var s=function(n){var o={from:t.to,to:t.from,id:t.id,type:"response",body:{value:e,code:500,description:n}};return r._bus.postMessage(o),i(n)};r.checkStorageQuota().then(function(e){if(n.size>e.quota){var t="The storage do not have space to store that resource";throw s(t),Error(t)}var o=e.quota,i=e.usage+n.size;return!(e.percent>=r._storageLimit||i>o)||r._getOlderResources(n.size)}).then(function(){return r._storageManager.set(e,1,n)}).then(function(){var n={from:t.to,to:t.from,id:t.id,type:"response",body:{value:e,code:200}};return r._bus.postMessage(n),On.log("Success"),o()}).catch(s)})}},{key:"_getOlderResources",value:function(e){var t=this;return new Promise(function(n,r){t._storageManager.get().then(function(o){var i=0,s=Object.keys(o).sort(function(e,t){return o[e].created<o[t].created}).reduce(function(n,r){var o=t._hypertyResources[r];return On.log("[HypertyResourcesStorage] _getOlderResources: ",i,e,r,t._availableQuota),i<=e&&(i+=o.size,n.push(r)),n},[]).map(function(e){return t._storageManager.delete(e)});Promise.all(s).then(function(){n(!0)}).catch(function(e){r(e)})})})}},{key:"_onRead",value:function(e){var t=this;if(!e.body||!e.body.resource)throw new Error("[HypertyResourcesStorage._onRead] mandatory message body resource missing: ",e);var n=e.body.resource,r={from:e.to,to:e.from,id:e.id,type:"response",body:{}};On.info("[HypertyResourcesStorage._onRead] get resourceURL:",n),this._storageManager.get("resourceURL",n).then(function(e){On.info("[HypertyResourcesStorage._onRead] found content:",e),e?"file"===e.resourceType?t._onReadFile(r,e):(r.body.code=200,r.body.p2p=!0,r.body.value=e,t._bus.postMessage(r)):(r.body.code=404,r.body.desc="Content Not Found for "+n,t._bus.postMessage(r))})}},{key:"_onReadFile",value:function(e,t){var n=this,r=new FileReader;if(r.onload=function(r){On.info("[FileHypertyResource.init] file loaded ",r),e.body.code=200,e.body.p2p=!0,e.body.value=Object(ue.i)(t),e.body.value.content=r.target.result,n._bus.postMessage(e)},t.mimetype.includes("text/"))r.readAsText(t.content);else{var o,i=t.content;o=Array.isArray(i)?new Blob(i,{type:t.mimetype}):new Blob([i],{type:t.mimetype}),r.readAsArrayBuffer(o)}}},{key:"_onDelete",value:function(e){var t=this;if(!e.body)throw new Error("[HypertyResourcesStorage._onDelete] mandatory message body missing: ",e);if(e.body.resource)delete t._hypertyResources[e.body.resource];else{if(!e.body.resources)throw new Error("[HypertyResourcesStorage._onDelete] mandatory resource missing: ",e);e.body.resources.forEach(function(e){delete t._hypertyResources[e]})}t._storageManager.delete("resourceURL",e.body.resource).then(function(){var n={from:e.to,to:e.from,id:e.id,type:"response",body:{code:200}};t._bus.postMessage(n)}).catch(function(n){var r={from:e.to,to:e.from,id:e.id,type:"response",body:{code:400,description:n}};t._bus.postMessage(r)})}}]),e}();function Rn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Pn=de.getLogger("SynSubscription"),Sn=function(){function e(t,n,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=this,s=r+"/children/",a=r+"/changes";i._deleteListener=t.addListener(a,function(e){if("delete"===e.type){Pn.log("Subscription-DELETE: ",e);var o={type:"delete",from:e.from,to:n,body:{identity:e.body.identity,resource:r}};t.postMessage(o,function(e){Pn.log("Subscription-DELETE-REPLY: ",e),200===e.body.code&&i._releaseListeners()})}}),i._changeListener=o?t.addPublish(a):t.addForward(a,n),i._childrenListeners=[];var c=t.addPublish(s);if(i._childrenListeners.push(c),!o){var u=t.addForward(s,n);i._childrenListeners.push(u)}}return function(e,t,n){t&&Rn(e.prototype,t)}(e,[{key:"_releaseListeners",value:function(){this._deleteListener.remove(),this._changeListener.remove(),this._childrenListeners.forEach(function(e){e.remove()})}}]),e}();function jn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var En=de.getLogger("ReporterObject"),Mn=function(){function e(t,n,r,o,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._parent=t,this._owner=n,this._url=r,this._bus=t._bus,this._domain=Object(ue.k)(r).domain,this._objSubscriptorURL=this._url+"/subscription",this._subscriptions={},this._childrens=o,this._childrenListeners=[],this._forwards={},this._isToSaveData=!1,this._allocateListeners(),this._offline=i||!1}return function(e,t,n){t&&jn(e.prototype,t)}(e,[{key:"_allocateListeners",value:function(){var e=this,t=this;t._subscriptionListener=t._bus.addListener(t._objSubscriptorURL,function(e){switch(En.info("[SyncherManager.ReporterObject received ]",e),e.type){case"subscribe":t._onRemoteSubscribe(e);break;case"unsubscribe":t._onRemoteUnSubscribe(e);break;case"response":t._onRemoteResponse(e);break;case"forward":t._onForwardedRemoteSubscribe(e)}});var n=t._url+"/changes";t._changeListener=t._bus.addListener(n,function(r){if(En.info("[SyncherManager.ReporterObject ] SyncherManager-"+n+"-RCV: ",r),e._isToSaveData&&r.body.attribute){var o="backupRevision"!==r.body.attribute;En.log("[SyncherManager.ReporterObject ] SyncherManager - save data: ",r),t._parent._dataObjectsStorage.update(!0,t._url,"version",r.body.version,o),t._parent._dataObjectsStorage.update(!0,t._url,"lastModified",r.body.lastModified,o),t._parent._dataObjectsStorage.saveData(!0,t._url,r.body.attribute,r.body.value,o)}})}},{key:"_onForwardedRemoteSubscribe",value:function(e){this._onRemoteSubscribe(e.body)}},{key:"_releaseListeners",value:function(){var e=this;e._subscriptionListener.remove(),e._changeListener.remove(),e._childrenListeners.forEach(function(e){e.remove()}),Object.keys(e._forwards).forEach(function(t){e.forwardUnSubscribe(t)}),Object.keys(e._subscriptions).forEach(function(t){e._subscriptions[t]._releaseListeners()})}},{key:"resumeSubscriptions",value:function(e){var t=this;e&&Object.keys(e).forEach(function(n){var r=e[n];En.log("[SyncherManager.ReporterObject] - resume subscriptions",t,r,t._childrens),t._subscriptions[r]||(t._subscriptions[r]=new Sn(t._bus,t._owner,t._url,!0))})}},{key:"forwardSubscribe",value:function(e){var t=this,n={type:"subscribe",from:t._parent._url,to:"domain://msg-node."+t._domain+"/sm",body:{resources:e,source:t._owner}};return new Promise(function(r,o){t._bus.postMessage(n,function(n){if(En.log("[SyncherManager.ReporterObject ]forward-subscribe-response(reporter): ",n),200===n.body.code){var i=t._bus.addForward(t._url,t._owner);t._forwards[e[0]]=i,r()}else o("Error on msg-node subscription: "+n.body.desc)})})}},{key:"forwardUnSubscribe",value:function(e){this._forwards[e].remove(),delete this._forwards[e];var t={type:"unsubscribe",from:this._parent._url,to:"domain://msg-node."+this._domain+"/sm",body:{resources:[e],source:this._owner}};this._bus.postMessage(t)}},{key:"addChildrens",value:function(){var e=this,t=this;return new Promise(function(n,r){if(0!==t._childrens.length){var o=t._url+"/children/";En.log("[SyncherManager.ReporterObject - addChildrens] - childrens: ",o);var i=[];i.push(o);var s={type:"subscribe",from:t._parent._url,to:"domain://msg-node."+t._domain+"/sm",body:{resources:i,source:t._owner}};t._bus.postMessage(s,function(o){En.log("[SyncherManager.ReporterObject ]node-subscribe-response(reporter):",o),200===o.body.code?(i.forEach(function(n){var r=t._bus.addListener(n,function(n){if(En.log("[SyncherManager.ReporterObject received]",n),"create"===n.type&&n.to.includes("children")&&e._isToSaveData){var r=Object(ue.D)(n.to).url;n.body.hasOwnProperty("mutual")||(n.body.mutual=!0),"string"!=typeof n.body.value&&n.body.mutual?(En.log("[SyncherManager.ReporterObject] encrypting received data ",n.body.value),Zt.encryptDataObject(n.body.value,r).then(function(e){En.log("[SyncherManager.ReporterObject] encrypted data ",e),t._storeChildObject(n,JSON.stringify(e))}).catch(function(e){En.warn("[SyncherManager._decryptChildrens] failed : ",e," Storing unencrypted"),t._storeChildObject(n,n.body.value)})):t._storeChildObject(n,n.body.value)}});t._childrenListeners.push(r);var o=t._bus.addForward(n,t._owner);t._childrenListeners.push(o)}),n()):r("Error on msg-node subscription: "+o.body.desc)})}else n()})}},{key:"_storeChildObject",value:function(e,t){var n,r=Object(ue.D)(e.to),o=r.url,i=r.resource,s=e.body.resource,a=i;n="heartbeat"===s?t:{identity:e.body.identity,value:t},s&&(a=s),console.log("[SyncherManager.ReporterObject._storeChildObject] : ",o,a,n),this._parent._dataObjectsStorage.saveChildrens(!0,o,a,n)}},{key:"delete",value:function(){var e=Object(ue.k)(this._owner).domain;this._bus.postMessage({type:"delete",from:this._objSubscriptorURL,to:this._url+"/changes"}),this._bus.postMessage({type:"delete",from:this._parent._url,to:"domain://msg-node."+e+"/object-address-allocation",body:{resource:this._url,childrenResources:this._childrens}}),this._releaseListeners(),delete this._parent._reporters[this._url]}},{key:"_onRemoteResponse",value:function(e){this._bus.postMessage({id:e.id,type:"response",from:e.to,to:this._url,body:{code:e.body.code,identity:e.body.identity,source:e.from}})}},{key:"_onRemoteSubscribe",value:function(e){var t=this,n=e.body.subscriber;t._subscriptions[n]&&t._subscriptions[n]._releaseListeners();var r={type:"forward",from:t._url,to:t._owner,body:{type:e.type,from:n,to:t._url,identity:e.body.identity}};e.body.hasOwnProperty("mutual")&&(r.body.mutual=e.body.mutual),t._bus.postMessage(r,function(r){var o;En.log("[SyncherManager.ReporterObject ]forward-reply: ",r),200===r.body.code&&(t._subscriptions[n]||(En.log("[SyncherManager.ReporterObject] - _onRemoteSubscribe:",t._childrens),t._subscriptions[n]=new Sn(t._bus,t._owner,t._url,!0))),e.body.identity&&e.body.identity.userProfile.userURL&&(o=e.body.identity.userProfile.userURL,t._parent._dataObjectsStorage.update(!0,t._url,"subscriberUsers",o)),t._parent._dataObjectsStorage.update(!0,t._url,"subscriptions",n),r.body.owner=t._owner,t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:r.body})})}},{key:"_onRemoteUnSubscribe",value:function(e){var t=e.body.source,n=this._subscriptions[t];if(n){n._releaseListeners(),delete this._subscriptions[t];var r={type:"forward",from:this._url,to:this._owner,body:{type:e.type,from:t,to:this._url,identity:e.body.identity}};this._bus.postMessage(r)}}},{key:"offline",get:function(){return this._offline}},{key:"isToSaveData",set:function(e){this._isToSaveData=e}}]),e}();function Cn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var xn=de.getLogger("ObserverObject"),Ln=function(){function e(t,n,r){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=this;i._parent=t,i._url=n,i._childrens=r,i._bus=t._bus,i._subscriptions={},i._storageSubscriptions={},i._childrenListeners=[],this._isToSaveData=!1;var s=i._url+"/changes";i._changeListener=i._bus.addListener(s,function(e){xn.log("[SyncherManager.ObserverObject ] SyncherManager-"+s+"-RCV: ",e),o._isToSaveData&&e.body.attribute&&(xn.log("[SyncherManager.ObserverObject ] SyncherManager - save data: ",e),i._parent._dataObjectsStorage.update(!1,i._url,"version",e.body.version),i._parent._dataObjectsStorage.update(!1,i._url,"lastModified",e.body.lastModified),i._parent._dataObjectsStorage.saveData(!1,i._url,e.body.attribute,e.body.value))})}return function(e,t,n){t&&Cn(e.prototype,t)}(e,[{key:"_newSubscription",value:function(e){var t=this._subscriptions[e];xn.log("[Observer Object - new subscription] - ",this._subscriptions,e,this._subscriptions.hasOwnProperty(e)),t||(this._subscriptions[e]=new Sn(this._bus,e,this._url,!1))}},{key:"addSubscription",value:function(e){this._newSubscription(e)}},{key:"addChildrens",value:function(){var e=this,t=this;return new Promise(function(n){if(0!==t._childrens.length){var r=t._url+"/children/";xn.log("[SyncherManager.ObserverObject - addChildrens] - childrens: ",r);var o=t._bus.addListener(r,function(n){if(xn.log("[SyncherManager.ObserverObject received]",n),"create"===n.type&&n.to.includes("children")&&e._isToSaveData){var r=Object(ue.D)(n.to).url;n.body.hasOwnProperty("mutual")||(n.body.mutual=!0),"string"!=typeof n.body.value&&n.body.mutual?(xn.log("[SyncherManager.ObserverObject] encrypting received data ",n.body.value),Zt.encryptDataObject(n.body.value,r).then(function(e){xn.log("[SyncherManager.ObserverObject] encrypted data ",e),t._storeChildObject(n,JSON.stringify(e))}).catch(function(e){xn.warn("[SyncherManager.ObserverObject._encryptChild] failed, storing unencrypted ",e),t._storeChildObject(n,n.body.value)})):t._storeChildObject(n,n.body.value)}xn.log("[SyncherManager.ObserverObject children Listeners]",t._childrenListeners,o),-1===t._childrenListeners.indexOf(o)&&t._childrenListeners.push(o)})}else n()})}},{key:"_storeChildObject",value:function(e,t){var n=Object(ue.D)(e.to),r=n.url,o=n.resource,i={},s=e.body.resource,a=o;"heartbeat"===s?i=t:(i.identity=e.body.identity,i.value=t),s&&(a=s),xn.log("[SyncherManager.ObserverObject._storeChildObject] : ",r,a,i),this._parent._dataObjectsStorage.saveChildrens(!1,r,a,i)}},{key:"removeSubscription",value:function(e){var t=e.from,n=Object(ue.k)(t).domain,r=this._url+"/subscription",o=this._subscriptions[t];o&&(this._bus.postMessage({type:"unsubscribe",from:this._parent._url,to:r,body:{source:t,identity:e.body.identity}}),this._bus.postMessage({type:"unsubscribe",from:this._parent._url,to:"domain://msg-node."+n+"/sm",body:{resource:this._url,resources:[this._url+"/children/"]}}),o._releaseListeners(),delete this._subscriptions[t])}},{key:"isToSaveData",set:function(e){this._isToSaveData=e}}]),e}();function In(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Tn=de.getLogger("SyncherManager"),Un=function(){function e(t,n,r,o,i,s,a,c){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[Syncher Manager] - needs the runtimeURL parameter");if(!n)throw new Error("[Syncher Manager] - needs the MessageBus instance");if(!r)throw new Error("[Syncher Manager] - needs the Registry instance");if(!o)throw new Error("[Syncher Manager] - needs the RuntimeCatalogue instance");if(!i)throw new Error("[Syncher Manager] - need the storageManager instance");var u=this;u._bus=n,u._registry=r,u._catalog=o,u._storageManager=i,u._identityModule=c,u.runtimeURL=t,u._url=t+"/sm",u._objectURL=t+"/object-allocation",u._reporters={},u._observers={},u._dataObjectsStorage=a,console.log("[NOTSAVING] storeDataObjects",a),u._domain=Object(ue.k)(t).domain,u._allocator=s||qe.instance,Tn.log("[SyncherManager - AddressAllocation] - ",u._allocator),n.addListener(u._url,function(e){switch(Tn.info("[SyncherManager] RCV: ",e),e.type){case"create":u._onCreate(e);break;case"delete":u._onDelete(e);break;case"subscribe":u._onLocalSubscribe(e);break;case"unsubscribe":u._onLocalUnSubscribe(e);break;case"read":u._onRead(e);break;case"execute":u._onExecute(e)}})}return function(e,t,n){t&&In(e.prototype,t)}(e,[{key:"_onExecute",value:function(e){var t={type:"response",from:e.to,to:e.from,id:e.id};if(Tn.info("[SyncherManager.onExecute] new message",e),e.hasOwnProperty("body")&&e.body.hasOwnProperty("method")&&e.body.hasOwnProperty("params")){switch(e.body.method){case"sync":this._dataObjectsStorage.sync(e.body.params[0],e.body.params[1],!1);break;case"stopSync":this._dataObjectsStorage.stopSync(e.body.params[0])}t.body={code:200},this._bus.postMessage(t)}else t.body={code:400,desc:"missing body or body method / params mandatory fields"},Tn.error("[SyncherManager.onExecute] error. Missing body or body method / params mandatory fields",e),this._bus.postMessage(t)}},{key:"_onRead",value:function(e){var t=this,n={type:"response",from:e.to,to:e.from,id:e.id};Tn.info("[SyncherManager.onRead] new message",e),e.hasOwnProperty("body")&&e.body.hasOwnProperty("resource")?t._dataObjectsStorage.sync(e.body.resource,criteria.backupRevision,!0).then(function(e){n.body={code:200,value:e},Tn.info("[SyncherManager.onRead] found object: ",e),t._bus.postMessage(n)},function(e){n.body={code:400,desc:e},Tn.error("[SyncherManager.onRead] error: ",e),t._bus.postMessage(n)}):(n.body={code:400,desc:"missing body or body resource mandatory fields"},Tn.error("[SyncherManager.onRead] error. Missing body or body resource mandatory fields",e),t._bus.postMessage(n))}},{key:"_onCreate",value:function(e){var t=this,n=e.from,r=e.to,o=this;e.body.attribute?this._storeChildrens(e):!e.body.hasOwnProperty("resume")||e.body.hasOwnProperty("resume")&&!e.body.resume?e.body.authorise?(this._authorise(e),Tn.info("[SyncherManager.onCreate - invite observers]",e)):(Tn.info("[SyncherManager.onCreate - Create New Object]",e),this._newCreate(e)):this._dataObjectsStorage.getResourcesByCriteria(e,!0).then(function(i){if(Tn.info("[SyncherManager - Create Resumed] - ResourcesByCriteria | Message: ",e," result: ",i),i&&Object.keys(i).length>0){var s=[];Object.keys(i).forEach(function(t){s.push(o._resumeCreate(e,i[t]))}),Promise.all(s).then(function(o){Tn.log("[SyncherManager - Create Resumed]",o);var i=Object.values(o).filter(function(e){return!1!==e});Tn.info("[SyncherManager.onCreate] returning resumed objects : ",i),t._bus.postMessage({id:e.id,type:"response",from:r,to:n,body:{code:200,value:Object(ue.i)(i)}})})}else{var a={};a.id=e.id,a.from=e.to,a.to=e.from,a.type="response",a.body={code:404,desc:"No data objects reporters to be resumed"},t._bus.postMessage(a)}})}},{key:"_storeChildrens",value:function(e){var t=e.body.resource,n=e.body.attribute;"childrenObjects"===n?this._dataObjectsStorage.saveChildrens(!1,t,void 0,e.body.value):this._dataObjectsStorage.saveChildrens(!0,t,n,e.body.value)}},{key:"_newCreate",value:function(e){var t=this,n=this,r=e.from,o=Object(ue.k)(e.from).domain;n._registry.isInterworkingProtoStub(e.from)&&(o=Object(ue.k)(n.runtimeURL).domain);var i=!e.body.value.hasOwnProperty("domain_routing")||e.body.value.domain_routing;n._catalog.getDataSchemaDescriptor(e.body.schema).then(function(s){var a=s.sourcePackage.sourceCode.properties,c=a.scheme?a.scheme:"resource",u=a.children?a.children:[],l={name:e.body.value.name,schema:e.body.value.schema,reporter:e.body.value.reporter,resources:e.body.value.resources},f=e.body.value.resource;n._allocator.create(o,1,l,c,f).then(function(o){var s=Object(ue.i)(e.body.value);s.url=o.address[0],s.authorise=e.body.authorise,s.childrens=u,delete s.data,Tn.log("[SyncherManager._newCreate] ALLOCATOR CREATE:",o);var a=s.url+"/subscription";Tn.log("[SyncherManager._newCreate] Subscription URL",a),Tn.info("[SyncherManager._newCreate] Register Object: ",s),n._registry.registerDataObject(s).then(function(o){var c,l;if(Tn.log("[SyncherManager._newCreate] DataObject successfully registered",o),t._reporters[s.url])c=t._reporters[s.url];else{var f=!!s.offline&&s.offline;c=new Mn(n,r,s.url,u,f)}Tn.log("[SyncherManager - new Create] - ",e),l=e.body.hasOwnProperty("identity")&&e.body.identity.userProfile&&e.body.identity.userProfile.userURL?e.body.identity.userProfile.userURL:n._registry.getHypertyOwner(e.from);var d=Object(ue.i)(s);d.subscriberUser=l,d.isReporter=!0,e.body.hasOwnProperty("store")&&e.body.store&&(c.isToSaveData=!0,d.isToSaveData=!0,e.body.value.data&&(d.data=Object(ue.i)(e.body.value.data))),n._dataObjectsStorage.set(d).then(function(t){if(d.offline){e.body.identity.guid=n._identityModule._identities.guid;var o={from:e.to,to:d.offline+"/register",type:"forward",body:e};o.body.body.resource=s.url,o.body.body.value=d,Tn.log("[SyncherManager.newCreate] registering new object at offline manager ",o),n._bus.postMessage(o)}var l={id:e.id,type:"response",from:e.to,to:r,body:{code:200,resource:s.url,childrenResources:u}};i?c.forwardSubscribe([s.url,a]).then(function(){c.addChildrens().then(function(){n._reporters[s.url]=c,n._bus.postMessage(l)})}):c.addChildrens().then(function(){n._reporters[s.url]=c,n._bus.postMessage(l)})},function(e){Tn.error(e)})},function(e){Tn.error(e)})})}).catch(function(t){var o={id:e.id,type:"response",from:e.to,to:r,body:{code:500,desc:t}};n._bus.postMessage(o)})}},{key:"_resumeCreate",value:function(e,t){var n=this,r=this;return new Promise(function(o){var i=e.from,s=t.schema,a=t.url,c=!t.hasOwnProperty("domain_registration")||t.domain_registration;t.data,Tn.log("[SyncherManager] - resume create",e,t),r._catalog.getDataSchemaDescriptor(s).then(function(s){var u,l,f=s.sourcePackage.sourceCode.properties,d=(f.scheme&&f.scheme.constant,f.children?f.children.constant:[]);if(Tn.log("[SyncherManager] - getDataSchemaDescriptor: ",s,d),n._reporters[a]?u=n._reporters[a]:(l=!!t.offline&&t.offline,u=new Mn(r,i,a,d,l)),u.isToSaveData=t.isToSaveData,l){var h={from:r._url,to:l+"/register",type:"update",body:{}};Tn.log("[SyncherManager._resumeCreate] update object at offline manager ",h),r._bus.postMessage(h)}c?u.forwardSubscribe([t.url]).then(function(){Tn.log("[SyncherManager._resumeCreate] resumingReporterSubscription ",t),r._resumeReporterSubscriptions(e,t,u,d,c).then(function(e){Tn.log("[SyncherManager._resumeCreate] resolved resumed object ",e),o(e)})}):o(r._resumeReporterSubscriptions(e,t,u,d,c))}).catch(function(e){Tn.error("[SyncherManager - resume create] - fail on getDataSchemaDescriptor: ",e),o(!1)})})}},{key:"_resumeReporterSubscriptions",value:function(e,t,n,r,o){var i=this,s=t.url,a=Object(ue.i)(e.body.value);return a.url=t.url,a.expires=t.expires,a.domain_registration=o,delete a.data,new Promise(function(e){n.addChildrens().then(function(){return n.resumeSubscriptions(t.subscriptions),i._reporters[s]=n,Tn.info("[SyncherManager - resume create] - resolved resumed: ",t),i._decryptChildrens(t,r)}).then(function(t){Tn.info("[SyncherManager._resumeReporterSubscriptions] Register Object: ",a),i._registry.registerDataObject(a).then(function(n){Tn.log("[SyncherManager._resumeReporterSubscriptions] DataObject registration successfully updated",n),Tn.log("[SyncherManager._resumeReporterSubscriptions] resolving object",t),e(t)})}).catch(function(t){Tn.error("[SyncherManager - resume create] - fail on addChildrens: ",t),e(!1)})})}},{key:"_decryptChildrens",value:function(e,t){var n=Object(ue.i)(e);return new Promise(function(e){t?(0===Object.keys(n.childrenObjects).length&&e(n),t.forEach(function(t){var r=n.childrenObjects;Tn.log("[SyncherManager._decryptChildrens] dataObjectChilds to decrypt ",r);var o=[];Object.keys(r).forEach(function(e){var t=r[e],i=e.split("#")[0];if("string"==typeof t.value){Tn.log("[SyncherManager._decryptChildrens] createdBy ",i," object: ",t.value);var s=Zt.decryptDataObject(JSON.parse(t.value),n.url);o.push(s)}}),Promise.all(o).then(function(t){Tn.log("[SyncherManager._decryptChildrens] returning decrypted ",t),t.forEach(function(e){var t=e.value.url;n.childrenObjects[t].value=e.value}),Tn.log("[SyncherManager._decryptChildrens] storedObject ",n),e(n)}).catch(function(e){Tn.warn("[SyncherManager._decryptChildrens] failed : ",e)})})):e(n)})}},{key:"_authorise",value:function(e){var t=this;if(!e.body.resource)throw new Error("[SyncherManager._authorise] invitation request without data object url:",e);var n=e.body.resource+"/subscription",r=!!e.body.p2p&&e.body.p2p;Tn.log("[SyncherManager -  authorise] - ",e),e.body.authorise&&e.body.authorise.forEach(function(o){t._bus.postMessage({type:"create",from:n,to:o,body:{p2p:r,identity:e.body.identity,source:e.from,value:e.body.value,schema:e.body.schema}},function(n){var r={from:e.to,to:e.from,id:e.id,type:n.type,body:n.body};t._bus.postMessage(r)})})}},{key:"_onDelete",value:function(e){var t=this,n=e.body.resource,r=t._reporters[n];if(r){if(r.offline){var o={from:e.to,to:r.offline+"/register",type:"forward",body:e};Tn.log("[SyncherManager._onDelete] unregistering object from offline manager ",o),t._bus.postMessage(o)}r.delete(),this._dataObjectsStorage.deleteResource(n).then(function(r){Tn.log("[SyncherManager - onDelete] - deleteResource: ",r),t._registry.unregisterDataObject(n),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}})})}}},{key:"_onLocalSubscribe",value:function(e){var t=this;e.body.hasOwnProperty("resume")&&e.body.resume?this._dataObjectsStorage.getResourcesByCriteria(e,!1).then(function(n){if(Tn.info("[SyncherManager.onLocalSubscribe. resume]: ",e," result: ",n),n&&Object.keys(n).length>0){var r=[];Object.keys(n).forEach(function(o){Tn.log("[SyncherManager - resume Subscribe] - reuse current object url: ",n[o]),r.push(t._resumeSubscription(e,n[o]))}),Promise.all(r).then(function(n){Tn.log("[SyncherManager - Observers Resumed]",n);var r=Object.values(n).filter(function(e){return!1!==e}),o={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:r}};Tn.log("[SyncherManager - Observers Resumed] replying ",o),t._bus.postMessage(o)})}else{var o={};o.id=e.id,o.from=e.to,o.to=e.from,o.type="response",o.body={code:404,desc:"No data objects observers to be resumed"},t._bus.postMessage(o)}}):(Tn.log("[SyncherManager.onLocalSubscribe - new Subscribe] - ",e.body.schema,e.body.resource),this._newSubscription(e))}},{key:"_newSubscription",value:function(e){var t=this,n=e.body.resource,r=e.from,o=Object(ue.k)(n).domain,i=!e.body.hasOwnProperty("domain_subscription")||e.body.domain_subscription,s=n+"/children/";t._catalog.getDataSchemaDescriptor(e.body.schema).then(function(a){var c=a.sourcePackage.sourceCode.properties,u=c.children?c.children.constant:[],l=[];if(l.push(n+"/changes"),l.push(s),i){var f={type:"subscribe",from:t._url,to:"domain://msg-node."+o+"/sm",body:{identity:e.body.identity,resources:l,source:r}};t._bus.postMessage(f,function(o){Tn.log("node-subscribe-response(observer): ",o),console.log("REUSETEST SyncherManager - node-subscribe-response(observer): ",o),200===o.body.code?t._newReporterSubscribe(e,r,n,u):t._bus.postMessage({id:e.id,type:"response",from:e.to,to:r,body:o.body})})}else t._newReporterSubscribe(e,r,n,u)})}},{key:"_newReporterSubscribe",value:function(e,t,n,r){var o=this,i=n+"/subscription";o._bus.postMessage({id:e.id,type:"response",from:e.to,to:t,body:{code:100,childrenResources:r,schema:e.body.schema,resource:e.body.resource}});var s={type:"subscribe",from:o._url,to:i,body:{identity:e.body.identity,subscriber:t}};e.body.hasOwnProperty("mutual")&&(s.body.mutual=e.body.mutual),Tn.log("[SyncherManager._newSubscription]",s,e),console.log("REUSETEST SyncherManager - [SyncherManager._newSubscription]",s,e),o._bus.postMessage(s,function(i){Tn.log("reporter-subscribe-response-new: ",i),console.log("REUSETEST SyncherManager - reporter-subscribe-response-new: ",i),200===i.body.code?o._processSuccessfullSubscription(i,t,n,r,e):e.body.offline&&o._processOfflineSubscription(s,e.body.offline,t,n,r,e)})}},{key:"_processOfflineSubscription",value:function(e,t,n,r,o,i){var s=this,a={from:e.from,type:"forward",to:t,body:e};console.log("[SyncherManager._processOfflineSubscription] forwading ",a),s._bus.postMessage(a,function(e){Tn.log("[SyncherManager._processOfflineSubscription] reply ",e),200===e.body.code&&s._processSuccessfullSubscription(e,n,r,o,i)})}},{key:"_processSuccessfullSubscription",value:function(e,t,n,r,o){Tn.log("[SyncherManager._newSubscription] - observers: ",this._observers,n,this._observers[n]),console.log("REUSETEST SyncherManager - 200 code[SyncherManager._newSubscription] - observers: ",this._observers,n,this._observers[n]);var i=this._observers[n];i||(i=new Ln(this,n,r),Tn.log("[SyncherManager._newSubscription] - observers: create new ObserverObject: ",i),this._observers[n]=i,i.addSubscription(t),i.addChildrens());var s,a=!1;o.body.hasOwnProperty("identity")&&o.body.identity.userProfile&&o.body.identity.userProfile.userURL?(s=o.body.identity.userProfile.userURL).includes("user://")||(a=!0):(s=this._registry.getHypertyOwner(o.from))||(a=!0);var c=Object(ue.i)(e.body.value);delete c.data,delete c.childrenObjects,c.childrens=r,c.subscriberUser=s,c.isReporter=!1,c.subscriberHyperty=t,a||(this._dataObjectsStorage.set(c),(c.hasOwnProperty("store")&&c.store||c.hasOwnProperty("isToSaveData")&&c.isToSaveData)&&(i.isToSaveData=!0,this._dataObjectsStorage.update(!1,n,"isToSaveData",!0),this._dataObjectsStorage.saveData(!1,n,null,e.body.value.data))),e.id=o.id,e.from=this._url,e.to=t,e.body.schema=o.body.schema,e.body.resource=o.body.resource,o.body.hasOwnProperty("mutual")&&(e.body.mutual=o.body.mutual),Tn.log("[subscribe] - new subscription: ",o,e,i),this._bus.postMessage(e)}},{key:"_resumeSubscription",value:function(e,t){var n=this;return new Promise(function(r){var o=t.url,i=t.schema,s=e.from,a=o+"/children/";Tn.log("[SyncherManager - ReuseSubscription] - objURL: ",o," - schema:",i),n._catalog.getDataSchemaDescriptor(i).then(function(r){var c=r.sourcePackage.sourceCode.properties,u=c.children?c.children.constant:[],l=[];l.push(o+"/changes"),l.push(a),n._bus.postMessage({id:e.id,type:"response",from:e.to,to:s,body:{code:100,childrenResources:u,schema:i,resource:o}});var f=n._observers[o];return f||((f=new Ln(n,o,u)).isToSaveData=t.isToSaveData,n._observers[o]=f),f.addSubscription(s),f.addChildrens(),n._decryptChildrens(t,u)}).then(function(e){r(e)}).catch(function(e){Tn.error("[SyncherManager - resume subscription] - fail on getDataSchemaDescriptor: ",e),r(!1)})})}},{key:"_onLocalUnSubscribe",value:function(e){e.from;var t=e.body.resource,n=this._observers[t];n&&(n.removeSubscription(e),this._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}}),this._dataObjectsStorage.deleteResource(t),delete this._observers[t])}},{key:"url",get:function(){return this._url}}]),e}();function An(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Dn=de.getLogger("Subscription"),Nn=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._subscriber=n,this.resource=r,Dn.log("[SubscriptionManager.Subscription] new: ",n,r),this._listener=t.addForward(r,n)}return function(e,t,n){t&&An(e.prototype,t)}(e,[{key:"_releaseListeners",value:function(){this._listener.remove()}}]),e}();function Hn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Bn=de.getLogger("SubscriptionManager"),Fn=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[SubscriptionManager] - needs the runtimeURL parameter");if(!n)throw new Error("[SubscriptionManager] - needs the MessageBus instance");var o=this;o._bus=n,o._storage=r,o._subscriptions={},o._subscriptionsStorage={},o.runtimeURL=t,o._url=t+"/subscriptions",o._domain=Object(ue.k)(t).domain,n.addListener(o._url,function(e){switch(Bn.info("[SubscriptionManager] RCV: ",e),e.type){case"subscribe":o._onSubscribe(e);break;case"unsubscribe":o._onUnSubscribe(e);break;case"read":o._onRead(e)}})}return function(e,t,n){t&&Hn(e.prototype,t)}(e,[{key:"init",value:function(){var e=this;return new Promise(function(t){e._storage.get("subscriptions").then(function(n){Bn.log("[SubscriptionManager.init] resume subscriptions: ",n),n&&(e._subscriptionsStorage=n,Object.values(n).forEach(function(t){e.createSubscription(t.domain,t.resources,t.subscriber,t.identity)})),t()})})}},{key:"_onSubscribe",value:function(e){var t=this,n=e.body.resources,r=e.from,o=Object(ue.k)(n[0]).domain,i=e.body.identity;t.createSubscription(o,n,r,i).then(function(s){s.id=e.id,s.from=t._url,s.to=r,s.body=e.body,s.body.code=200,Bn.log("[SubscriptionManager] - craeteSubscription: ",e,s,r),t._bus.postMessage(s),t._subscriptionsStorage[r]?n.forEach(function(e){t._subscriptionsStorage[r].resources.includes(e)||t._subscriptionsStorage[r].resources.push(e)}):t._subscriptionsStorage[r]={domain:o,resources:n,subscriber:r,identity:i},t._storage.set("subscriptions",1,t._subscriptionsStorage)})}},{key:"createSubscription",value:function(e,t,n,r){var o=this;return new Promise(function(i){var s={type:"subscribe",from:o._url,to:"domain://msg-node."+e+"/sm",body:{identity:r,resources:t,source:n}};o._bus.postMessage(s,function(e){Bn.log("[SubscriptionManager] node-subscribe-response: ",e);var r=o._subscriptions[n];Bn.log("[SubscriptionManager] - ",o._subscriptions,t,o._subscriptions.hasOwnProperty(n)),r||(o._subscriptions[n]={}),t.forEach(function(e){o._subscriptions[n][e]=new Nn(o._bus,n,e)}),i(e)})})}},{key:"_onUnSubscribe",value:function(e){var t=e.from,n=e.body.resource;if(this._subscriptions[t]&&this._subscriptions[t][n]){var r=Object(ue.k)(n).domain,o=this._subscriptions[t][n];if(this._bus.postMessage({type:"unsubscribe",from:this._url,to:"domain://msg-node."+r+"/sm",body:{resources:[n],source:t}}),o._releaseListeners(),delete this._subscriptions[t][n],this._subscriptionsStorage[t]){var i=this._subscriptionsStorage[t].resources.indexOf(n);-1!=i&&this._subscriptionsStorage[t].resources.splice(i,1),this._storage.set("subscriptions",1,this._subscriptionsStorage)}}this._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}})}},{key:"_onRead",value:function(e){var t,n=this,r=e.body.resource;Bn.log("[SubscriptionManager] - request to read Subscriptions: ",e),n._storage.get("subscriptions").then(function(o){if(o&&o[r]){var i=o[r].resources;t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,value:i}}}else t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,description:"Not Found"}};n._bus.postMessage(t)})}},{key:"url",get:function(){return this._url}}]),e}(),Kn=n(15),qn=n(16),Gn=n(17),Vn=n(20);function Wn(e){return(Wn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Jn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Yn(e){return(Yn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function zn(e,t){return(zn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}de.getLogger("PEP");var $n=function(e){function t(e,n,r,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(s=function(e,t){return!t||"object"!==Wn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,Yn(t).call(this)))._runtimeURL=e,s._pepURL=s._runtimeURL+"/pep",s._guiURL=s._runtimeURL+"/policy-gui",s.idModule=n,s.runtimeRegistry=r,s.activeUserPolicy=void 0,s.serviceProviderPolicy={},s.userPolicies={},s.storageManager=o,s.runtimeCapabilities=i,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&zn(e,t)}(t,Vn.default),function(e,t,n){t&&Jn(e.prototype,t)}(t,[{key:"loadConfigurations",value:function(){var e=this;return new Promise(function(t,n){console.log(e.storageManager),e.storageManager.get("rethink:activePolicy").then(function(t){return e.activeUserPolicy=t,e.storageManager.get("rethink:groups")}).then(function(t){var n=t;return e.groups=void 0===n?{}:n,e.storageManager.get("rethink:spPolicies")}).then(function(n){var r=n;e.serviceProviderPolicy=void 0===r?{}:r,e._loadUserPolicies().then(function(){t()})})})}},{key:"getPolicies",value:function(e,t){var n={};return void 0!==this.activeUserPolicy&&(n.userPolicy=this.userPolicies[this.activeUserPolicy]),n.serviceProviderPolicy=this.getServiceProviderPolicy(e,t),n}},{key:"_isValidUpdate",value:function(e){var t=this;return new Promise(function(n,r){e.from.split("://").length>1?t.idModule._getHypertyFromDataObject(e.from).then(function(t){t===e.body.source?n(e):r("The source of the message is not valid.")},function(e){r(e)}):n(e)})}},{key:"getMyEmails",value:function(){var e=this.idModule.getIdentities(),t=[];for(var n in e)t.push(Object(ue.p)(e[n].identity));return t}},{key:"getMyHyperties",value:function(){var e=this.runtimeRegistry.hypertiesList,t=[];for(var n in e){var r=e[n].objectName;-1===t.indexOf(r)&&t.push(r)}return t}},{key:"getServiceProviderPolicy",value:function(e,t){var n;if(t){var r=this.runtimeRegistry.getHypertyName(e.to);n=this.serviceProviderPolicy[r]}else{var o=this.runtimeRegistry.getHypertyName(e.from);n=this.serviceProviderPolicy[o]}return n}},{key:"getURL",value:function(e){var t=e.split("/");return t[0]+"//"+t[2]+"/"+t[3]}},{key:"_loadUserPolicies",value:function(){var e=this,t=this;return new Promise(function(n,r){t.storageManager.get("rethink:userPolicies").then(function(t){var r=t;if(void 0!==r)for(var o in r)e.pep.addPolicy("USER",o,r[o]);n()})})}},{key:"_getLastComponentOfURL",value:function(e){var t=e.split("/");return t[t.length-1]}},{key:"_getPoliciesJSON",value:function(e){for(var t in e){var n=e[t].combiningAlgorithm;n instanceof qn.a?e[t].combiningAlgorithm="blockOverrides":n instanceof Kn.a?e[t].combiningAlgorithm="allowOverrides":n instanceof Gn.a?e[t].combiningAlgorithm="firstApplicable":e[t].combiningAlgorithm=void 0}return e}},{key:"saveActivePolicy",value:function(){var e=this,t=this;return new Promise(function(n,r){t.storageManager.set("rethink:activePolicy",0,e.activeUserPolicy).then(function(){n()})})}},{key:"saveGroups",value:function(){var e=this,t=this;return new Promise(function(n,r){t.storageManager.set("rethink:groups",0,e.groups).then(function(){n()})})}},{key:"savePolicies",value:function(e,t,n){var r;switch(e){case"USER":r=JSON.stringify(this.userPolicies),r=this._getPoliciesJSON(JSON.parse(r)),this.storageManager.set("rethink:userPolicies",0,r);break;case"SERVICE_PROVIDER":void 0!==t&void 0!==n&&(this.serviceProviderPolicy[n]=t),r=JSON.stringify(this.serviceProviderPolicy),r=this._getPoliciesJSON(JSON.parse(r)),this.storageManager.set("rethink:spPolicies",0,r);break;default:throw Error("Unknown policy source: "+e)}}},{key:"getGroupsNames",value:function(){var e=this.groups,t=[];if(void 0!==e)for(var n in e)t.push(n);return t}},{key:"getGroup",value:function(e,t){var n=[];if("preauthorised"===e){var r=t.split("/");r.pop(),r=r[0]+"//"+r[2],n=this.runtimeRegistry.getPreAuthSubscribers(r)}else void 0!==this.groups[e]&&(n=this.groups[e]);return n}},{key:"createGroup",value:function(e){this.groups[e]=[],this.saveGroups()}},{key:"deleteGroup",value:function(e){delete this.groups[e],this.saveGroups()}},{key:"addToGroup",value:function(e,t){var n=this.groups;if(void 0===n[e])throw Error('Group "'+e+'" does not exist!');-1===n[e].indexOf(t)&&(n[e].push(t),this.saveGroups())}},{key:"removeFromGroup",value:function(e,t){var n=this.groups[e];n.splice(n.indexOf(t),1),this.saveGroups()}},{key:"pepURL",get:function(){return this._pepURL}},{key:"guiURL",get:function(){return this._guiURL}},{key:"runtimeURL",get:function(){return this._runtimeURL}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){this._messageBus=e}},{key:"subscription",get:function(){return this._subscription},set:function(e){this._subscription=e.message.body.subscriber}}]),t}(),Qn=n(22);function Xn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Zn=de.getLogger("RuntimeUA"),er=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("The runtime descriptor is a needed parameter");if(!n)throw new Error("The sandbox factory is a needed parameter");if(!r)throw new Error("You need the domain of runtime");if(this.runtimeConfiguration=Object.assign({domain:r},vt),this.runtimeFactory=n,this.log=Zn,this.logLevels=he.a,t.p2pHandlerStub&&"string"==typeof t.p2pHandlerStub&&t.p2pHandlerStub.includes("://")?this.p2p=!0:this.p2p=!1,He.runtimeDescriptor=t,this.runtimeUtils=He,this.storages={},this.runtimeCatalogue=new Qn.default(n),"function"!=typeof n.storageManager)throw new Error("Check your Runtime Factory because it needs the Storage Manager implementation");this.storages=function(e,t){if(!e)throw new Error("The runtime factory is a needed parameter");return Object.keys(vt.storageSchemas).forEach(function(n){rn.hasOwnProperty(n)||(rn[n]=e.storageManager(n,vt.storageSchemas[n],t))}),rn}(n,this),"function"==typeof n.runtimeCapabilities?this.runtimeCapabilities=n.runtimeCapabilities(this.storages.capabilities):Zn.info("Check your RuntimeFactory because it needs the Runtime Capabilities implementation")}return function(e,t,n){t&&Xn(e.prototype,t)}(e,[{key:"init",value:function(e){var t=this;return new Promise(function(n,r){t.domain=t.runtimeConfiguration.domain,Zn.info("[RuntimeUA - init] Starting ");try{var o=t.runtimeCapabilities.getRuntimeCapabilities(),i=t.storages.runtime.get("runtime:URL"),s=t.storages.syncherManager.get("syncherManager:ObjectURLs"),a=t.storages.hypertyResources.get(),c=t.storages.runtime.get("p2pHandler:URL");Promise.all([i,o,s,a,c]).then(function(n){return t.runtimeURL=n[0]?n[0].runtimeURL:n[0],t.runtimeURL||(t.runtimeURL="runtime://"+t.domain+"/"+Object(ue.n)(),t.storages.runtime.set("runtime:URL",1,{runtimeURL:t.runtimeURL})),t.capabilities=n[1],Object.assign(He.runtimeCapabilities.constraints,n[1]),t._dataObjectsStorage=new gn(t.storages.syncherManager,n[2]||{},t.runtimeFactory,t),t._hypertyResources=n[3]||{},t.p2pHandlerURL=n[4]?n[4].p2pHandlerURL:n[4],t.p2pHandlerURL||(t.p2pHandlerURL=t.runtimeURL+"/p2phandler/"+Object(ue.n)(),Zn.info("[RuntimeUA - init] P2PHandlerURL: ",t.p2pHandlerURL),t.storages.runtime.set("p2pHandler:URL",1,{p2pHandlerURL:t.p2pHandlerURL})),t._loadComponents(e)}).then(function(e){return t._hypertyResourcesStorage=new kn(t.runtimeURL,t.messageBus,t.storages.hypertyResources,t._hypertyResources),t.p2p?(Zn.info("[RuntimeUA - init] load p2pHandler: ",e),t._loadP2PHandler()):(Zn.info("[RuntimeUA - init] P2P not supported"),"P2P Not Supported")}).then(function(e){Zn.info("[runtime ua - init] - status: ",e),n(!0)},function(e){Zn.error("ERROR: ",e),n(!0)})}catch(e){r(e)}})}},{key:"_updateRuntimeStatus",value:function(e){this.messageBus.postMessage({from:this.runtimeURL,to:this.runtimeURL+"/status",type:"update",body:e})}},{key:"_loadP2PHandler",value:function(){var e=this;return new Promise(function(t){var n=He.runtimeDescriptor.p2pHandlerStub,r={isHandlerStub:!0,runtimeURL:e.runtimeURL};Zn.log("[RuntimeUA loadP2PHandler] P2PStubHandler: ",n),e.loader.loadStub(n,r).then(function(n){var r=e.runtimeURL+"/ua",o={type:"subscribe",from:r,to:"domain://msg-node."+e.domain+"/sm",body:{subscribe:[n.url],source:e.runtimeURL}};e.messageBus.addListener(r,function(e){Zn.log("[runtime ua - listener] - receive msg: ",e)}),e.messageBus.postMessage(o,function(e){Zn.log("[runtime ua - postMessage] - reply: ",e)}),Zn.info("[runtime ua - p2p installation] - success: ",n),t(!0)}).catch(function(e){Zn.info("[runtime ua - p2p installation] - fail: ",e),t(!1)})})}},{key:"_loadComponents",value:function(e){var t=this;return new Promise(function(n,r){try{t.descriptorInstance=new cn(t.runtimeURL,t.runtimeCatalogue,t.runtimeConfiguration),t.loader=new nn(t.runtimeURL,t.runtimeConfiguration,t.descriptorInstance),t.identityModule=new Et(t.runtimeURL,t.runtimeCapabilities,t.storages.identity,t._dataObjectsStorage,Zt,t.runtimeCatalogue);var o=t.runtimeFactory.createAppSandbox();t.registry=new pt(t.runtimeURL,o,t.identityModule,t.runtimeCatalogue,t.runtimeCapabilities,t.storages.registry,t.p2pHandlerURL),t.registry.loader=t.loader,t.messageBus=new Wt(t.registry),t.subscriptionManager=new Fn(t.runtimeURL,t.messageBus,t.storages.subscriptions),t.addressAllocation=new qe(t.runtimeURL,t.messageBus,t.registry,t.subscriptionManager),t.policyEngine=new Lt.default(new $n(t.runtimeURL,t.identityModule,t.registry,t.storages.policy,t.runtimeCapabilities)),t.coreDiscovery=new yn(t.runtimeURL,t.messageBus,t.graphConnector,t.runtimeFactory,t.registry),t.identityHandler=new xt(t.identityModule),Zt.init(t.runtimeURL,t.runtimeCapabilities,t.storages.cryptoManager,t._dataObjectsStorage,t.registry,t.coreDiscovery,t.identityModule,t.runtimeFactory),t.handlers=new fn(t.policyEngine,t.identityHandler,Zt),t.messageBus.pipelineOut.handlers=[t.handlers.idmHandler,t.handlers.pepOutHandler],t.messageBus.pipelineIn.handlers=[t.handlers.pepInHandler],o.addListener("*",function(e){t.messageBus.postMessage(e)}),Zt.messageBus=t.messageBus,t.registry.messageBus=t.messageBus,t.policyEngine.messageBus=t.messageBus,t.identityModule.messageBus=t.messageBus,t.identityModule.registry=t.registry,t.identityModule.coreDiscovery=t.coreDiscovery,t.runtimeFactory.messageBus=t.messageBus,t.syncherManager=new Un(t.runtimeURL,t.messageBus,t.registry,t.runtimeCatalogue,t.storages.syncherManager,null,t._dataObjectsStorage,t.identityModule),t.loader.runtimeURL=t.runtimeURL,t.loader.messageBus=t.messageBus,t.loader.registry=t.registry,t.loader.runtimeCatalogue=t.runtimeCatalogue,t.loader.runtimeFactory=t.runtimeFactory;var i=[];i.push(t.subscriptionManager.init()),i.push(t.identityModule.init(e)),i.push(Zt.loadSessionKeys()),i.push(t.registry.loadRegistry()),i.push(t._dataObjectsStorage.loadRemote()),Promise.all(i).then(function(e){5===e.length?n(!0):r("[RuntimeUA._loadComponents] Error ] ",e)}).catch(function(e){throw Error(e)})}catch(e){r(e)}})}},{key:"loadHyperty",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;if(!e)throw new Error("Hyperty descriptor url parameter is needed");return this.loader.loadHyperty(e,t,n)}},{key:"loadStub",value:function(e){if(!e)throw new Error("ProtoStub descriptor url parameter is needed");return this.loader.loadStub(e)}},{key:"loadIdpProxy",value:function(e){if(Zn.log("ipdProxyCatalogueURL",e),!e)throw new Error("The IDP Proxy URL is a needed parameter, could be a DOMAIN or a URL");return this.loader.loadIdpProxy(e)}},{key:"close",value:function(e){console.log("Runtime core logout: ",e);var t=this;return!0===e&&this.identityHandler.reset(),Zn.info("Unregister all hyperties"),new Promise(function(e,n){t.registry.unregisterAllHyperties().then(function(t){Zn.info("All the hyperties are unregisted with Success:",t),e(!0)}).catch(function(e){Zn.error("Failed to unregister the hyperties",e),n(!1)})})}},{key:"reset",value:function(){var e=this;console.log("RuntimeUA.Runtime core reset: ");var t=[];return new Promise(function(n,r){e._dataObjectsStorage.deleteRemotes().then(function(){return n()}).then(function(){e.storages.identity.get(!1,!1,"identities").then(function(r){Object.keys(r).forEach(function(n){t.push(e.storages.identity.delete(n,!1,"identities"))}),t.push(e.storages.capabilities.delete("capabilities")),t.push(e.storages.cryptoManager.delete("userAsymmetricKey")),t.push(e.storages.hypertyResources.delete("hypertyResources")),t.push(e.storages.identity.delete("accessTokens")),t.push(e.storages.registry.delete("registry:DataObjectURLs")),t.push(e.storages.registry.delete("registry:HypertyURLs")),t.push(e.storages.runtime.delete("p2pHandler:URL")),t.push(e.storages.runtime.delete("runtime:URL")),t.push(e.storages.subscriptions.delete("subscriptions")),t.push(e.storages.syncherManager.delete("syncherManager:ObjectURLs")),t.push(e.storages.syncherManager.delete("remotes")),Promise.all(t).then(function(e){return Zn.info("[RuntimeUA.reset] reset with Success:",e),n(!0)}).catch(function(e){Zn.error("Failed to reset all DBs",e),n(!1)})})})})}}]),e}();window.components={};var tr={sourcePackageURL:"/sourcePackage",version:"0.20",description:"",language:"Javascript",cguid:"3bc366f2d0ba3d681e7a3899917c5d3de",type:"Runtimes",runtimeType:"browser",p2pHandlerStub:"",p2pRequesterStub:"",constraints:{browser:!0,mic:!0,camera:!0,sensor:!1,webrtc:!0,ortc:!0,http:!0,https:!0,ws:!0,wss:!0,coap:!1,datachannel:!1},objectName:"Runtime",configuration:{},messageSchemas:[],dataObjects:[],signature:"",accessControlPolicy:"somePolicy"},nr={install:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.domain,n=e.guid;return e.runtimeURL,e.development,new Promise(function(e,r){var o=new er(tr,ce,t);o.init(n).then(function(t){var n=o.identityModule._runtimeURL+"/identity-gui",r=o.identityModule._runtimeURL+"/idm",i=o.messageBus,s=o.identityModule,a=new fe(n,r,i);console.log("identitiesGUI: ",a),e({requireHyperty:function(e){return new Promise(function(t,n){o.loadHyperty(e,!0).then(function(e){console.log("[rethink.requireHyperty] loaded: ",e.name),t(e)}).catch(function(e){n(e)})})},requireProtostub:function(e){return new Promise(function(t,n){o.loadStub(e).then(function(e){var n=e.url||e.runtimeProtoStubURL,r=window.components[n],o={runtimeProtostubURL:n,status:e.status,instance:r.instance,name:r.name};t(o)}).catch(function(e){n(e)})})},authorise:function(e,t){return new Promise(function(n,r){a.authorise(e,t).then(function(e){e.hasOwnProperty("accessToken")?(console.log("[rethink.authorise] authorised: ",e),n(e)):(console.warn("[rethink.authorise] not authorised: ",e),r(e))})})},unauthorise:function(e,t){return new Promise(function(n,r){a.unauthorise(e,t).then(function(e){e?(console.log("[rethink.unauthorise] ",e),n(e)):(console.warn("[rethink.unauthorise] failed: ",e),r(e))})})},login:function(e){return new Promise(function(t,n){a.loginWithIDP(e).then(function(e){console.log("[rethink.login] loggedin: ",e),t(e)})})},listenShowAdmin:function(){return new Promise(function(e,t){s.listenShowAdmin(function(t,n,r,o){console.log("[rethink.listenShowAdmin]"),e("login"===t?{method:t}:{method:t,domain:r,resource:o,reauthorise:function(){return a.reauthorise(n,r,o)}})})})},reset:function(){return new Promise(function(e,t){o.reset().then(function(t){e(t)}).catch(function(e){t(e)})})},close:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return console.log("[rethink.close] logout: ",e),new Promise(function(t,n){o.close(e).then(function(n){e?a.logOut().then(function(e){console.log("[rethink.close] closed: ",e),t(e)}):(console.log("[rethink.close] closed: ",n),t(n))}).catch(function(e){console.log("[rethink.close] closed: ",e),t(e)})})}})})}).catch(function(e){console.error(e),reject(e)})}};n.d(t,"rethink",function(){return nr}),n.d(t,"IdentitiesGUI",function(){return fe}),n.d(t,"Request",function(){return S}),n.d(t,"RuntimeCapabilities",function(){return M}),n.d(t,"runtimeFactory",function(){return ce})}])});